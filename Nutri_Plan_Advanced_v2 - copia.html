<!DOCTYPE html>
<html lang="es">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.7.3/firebase-auth-compat.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.0/html-docx.min.js"></script>
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
 <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<title>Plan Dietético Personalizado - NutriPlan v2</title>

    <style>

	/* ===== ESTILOS PRINCIPALES DEL MODAL ===== */
/* Estilos generales del modal */
#editModal .modal-content {
    border-radius: 15px;
    overflow: hidden;
}

#editModal .modal-header {
    background: linear-gradient(135deg, #407b33 0%, #5e9a4f 100%);
    color: white;
    border: none;
}

#editModal .modal-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

#editModal .modal-body {
    background-color: #f9fafb;
}

#editModal .modal-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #e9ecef;
}

#editModal .save-config-btn {
    background: linear-gradient(to right, #7cb96c 0%, #b9f7a5 100%);
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

#editModal .save-config-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(124, 185, 108, 0.4);
}

/* Estilo para tooltips */
       .tooltip {
      --bs-tooltip-bg: #2c3e50;
      --bs-tooltip-color: #ffffff;
      --bs-tooltip-border-radius: 0.5rem;
      --bs-tooltip-padding-x: 1rem;
      --bs-tooltip-padding-y: 0.5rem;
      --bs-tooltip-font-size: 0.9rem;
      --bs-tooltip-opacity: 0.95;
      --bs-tooltip-arrow-width: 0.8rem;
      --bs-tooltip-arrow-height: 0.4rem;
    }

    .tooltip-inner {
      background-color: var(--bs-tooltip-bg);
      color: var(--bs-tooltip-color);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
      max-width: 450px;
      text-align: left;
      white-space: pre-wrap;
      line-height: 1.4;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .tooltip.show {
      opacity: var(--bs-tooltip-opacity);
      transform: translateY(-2px);
    }

    .tooltip .tooltip-arrow::before {
      border-color: transparent !important;
      border-bottom-color: var(--bs-tooltip-bg) !important;
    }

    .tooltip-inner strong {
      color: #ffd700;
      display: block;
      margin-bottom: 0.2rem;
    }

    /* Estilo para acordeones */
    .accordion-button {
      transition: background-color 0.3s ease;
    }

    .accordion-button:hover {
      background-color: rgba(94, 154, 79, 0.05);
    }

    #accordionCetogenicas .accordion-button {
      background-color: rgba(192, 57, 43, 0.05);
      border-left: 4px solid #c0392b;
    }

    #accordionCetogenicas .accordion-button i {
      color: #c0392b;
    }

    #accordionCiclado .accordion-button {
      background-color: rgba(52, 152, 219, 0.05);
      border-left: 4px solid #3498db;
    }

    #accordionCiclado .accordion-button i {
      color: #3498db;
    }

    #accordionTiming .accordion-button {
      background-color: rgba(243, 156, 18, 0.05);
      border-left: 4px solid #f39c12;
    }

    #accordionTiming .accordion-button i {
      color: #f39c12;
    }

    .accordion-button:not(.collapsed) {
      background-color: inherit;
    }
	.macro-config-header {
    position: relative;
    cursor: help;
}

.macro-config-header {
    position: relative;
    cursor: help;
    display: inline-block;
}

.macro-tooltip {
    position: absolute;
    top: 100%;
    left: 0;
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-width: 350px;
    font-size: 0.9rem;
    display: none;
    margin-top: 5px;
}

.macro-tooltip-content {
    color: #333;
}

.macro-tooltip-content .kcal-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: #6a11cb;
}

.macro-tooltip-content .method-badge {
    font-size: 0.85rem;
    padding: 3px 8px;
    border-radius: 20px;
    margin-left: 5px;
}

.macro-tooltip-content .macros-breakdown {
    margin-top: 10px;
}

.macro-tooltip-content .macros-breakdown strong {
    font-weight: 600;
    color: #495057;
}

.macro-tooltip-content .badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.8rem;
}

.macro-tooltip-content .result-box {
    background-color: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-top: 0;
    border-left: 5px solid #6a11cb;
}

.macro-tooltip-content h6 {
    font-weight: 600;
    margin-bottom: 10px;
    color: #212529;
}	
/* ===== SECCIONES PRINCIPALES DEL MODAL ===== */
/* Estilo base para secciones de configuración */
#editModal .phase-config-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
}

#editModal .phase-config-section h5 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

#editModal .phase-config-section h5 i {
    color: #5e9a4f;
}

/* ===== ESTRATEGIA BASE ===== */
#editModal .radio-group {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

#editModal .radio-option {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
}

#editModal .radio-option:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

#editModal .radio-option.selected {
    border-color: #5e9a4f;
    background-color: #b9f7a5;
}

#editModal .radio-option input {
    display: none;
}

#editModal .radio-option label {
    font-weight: 600;
    margin-bottom: 5px;
    display: block;
}

#editModal .radio-option p {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 0;
}

/* ===== ESTRATEGIAS ESPECÍFICAS - ACORDEONES ===== */
#editModal .accordion {
    margin-bottom: 1rem;
}

#editModal .accordion-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
}

#editModal .accordion-header {
    background-color: white;
    padding: 0;
    border-bottom: 1px solid #e9ecef;
}

#editModal .accordion-button {
    padding: 12px 15px;
    font-weight: 500;
    color: #2c3e50;
    background-color: white;
    border: none;
    box-shadow: none;
}

#editModal .accordion-button:not(.collapsed) {
    background-color: #f8f9fa;
    color: #5e9a4f;
    font-weight: 600;
}

#editModal .accordion-button::after {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%235e9a4f'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
}

#editModal .accordion-body {
    padding: 15px;
    background-color: #f8f9fa;
}

    /* Estilo para acordeones */
    .accordion-button {
      transition: background-color 0.3s ease;
    }

    .accordion-button:hover {
      background-color: rgba(94, 154, 79, 0.05);
    }

    #accordionCetogenicas .accordion-button {
      background-color: rgba(192, 57, 43, 0.05);
      border-left: 4px solid #c0392b;
    }

    #accordionCetogenicas .accordion-button i {
      color: #c0392b;
    }

    #accordionCiclado .accordion-button {
      background-color: rgba(52, 152, 219, 0.05);
      border-left: 4px solid #3498db;
    }

    #accordionCiclado .accordion-button i {
      color: #3498db;
    }

    #accordionTiming .accordion-button {
      background-color: rgba(243, 156, 18, 0.05);
      border-left: 4px solid #f39c12;
    }

    #accordionTiming .accordion-button i {
      color: #f39c12;
    }

    .accordion-button:not(.collapsed) {
      background-color: inherit;
    }
/* ===== ESTRATEGIAS ESPECÍFICAS - LISTA DE ESTRATEGIAS ===== */
/* Estilos base para opciones de estrategia */
#editModal .strategy-item {
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    background: white;
    border: 1px solid #e9ecef;
    transition: all 0.2s;
}

#editModal .strategy-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
}

#editModal .strategy-item h6 {
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

#editModal .strategy-description {
    font-size: 0.9rem;
    color: #6c757d;
    line-height: 1.5;
}

#editModal .strategy-features {
    list-style-type: none;
    padding-left: 0;
    margin-top: 10px;
}

#editModal .strategy-features li {
    padding: 3px 0;
    display: flex;
    align-items: flex-start;
}

#editModal .strategy-features li:before {
    content: "•";
    color: #5e9a4f;
    font-weight: bold;
    display: inline-block;
    width: 1em;
    margin-left: -1em;
}

/* ===== ESTRATEGIAS ESPECÍFICAS - CLASIFICACIÓN ===== */
/* Clasificación RECOMENDADA (Verde Suave Pastel) */
#editModal .strategy-recomendada {
    background-color: #e8f5e9 !important;
    border-color: #c8e6c9 !important;
    border-left: 4px solid #4caf50;
}

#editModal .badge-recomendada {
    background-color: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
}

/* Clasificación NEUTRAL (Gris Suave) */
#editModal .strategy-neutral {
    background-color: #f5f5f5 !important;
    border-color: #e0e0e0 !important;
    border-left: 4px solid #9e9e9e;
}

#editModal .badge-neutral {
    background-color: #f5f5f5;
    color: #424242;
    border: 1px solid #e0e0e0;
}

/* Clasificación CONTRAINDICADA (Rojo Claro Pastel) */
#editModal .strategy-contraindicada {
    background-color: #ffebee !important;
    border-color: #ffcdd2 !important;
    border-left: 4px solid #f44336;
}

#editModal .badge-contraindicada {
    background-color: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
}

/* Estilos para los badges de clasificación */
#editModal .strategy-badge {
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
}

/* Estilos para el icono de clasificación */
#editModal .strategy-item i[class*="fa-check-circle"] {
    color: #4caf50 !important;
}

#editModal .strategy-item i[class*="fa-circle"] {
    color: #9e9e9e !important;
}

#editModal .strategy-item i[class*="fa-times-circle"] {
    color: #f44336 !important;
}

/* ===== CONFIGURACIÓN DE MACROS ===== */
#editModal .macro-config {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

#editModal .macro-input {
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

#editModal .macro-input label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #495057;
}

#editModal .macro-input input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 8px;
    font-weight: 500;
    text-align: center;
}

#editModal .macro-input input:focus {
    border-color: #5e9a4f;
    box-shadow: 0 0 0 0.25rem rgba(94, 154, 79, 0.25);
}

#editModal .macro-values {
    margin-top: 8px;
    font-size: 0.85rem;
    color: #6c757d;
    font-weight: 500;
}

#editModal .macro-details {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
}

#editModal .macro-details h6 {
    margin-bottom: 10px;
    color: #495057;
}

/* ===== SECCIÓN DE DETALLES DE ESTRATEGIA ===== */
#editModal .strategy-details-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
}

#editModal .strategy-details-card h6 {
    margin-bottom: 8px;
    color: #407b33;
    font-weight: 500;
    display: flex;
    align-items: center;
}

#editModal .strategy-details-card p {
    font-size: 0.95rem;
    color: #6c757d;
    line-height: 1.5;
    margin-bottom: 0;
}
* Diseño responsivo para ESTRATEGIAS ESPECÍFICAS RECOMENDADAS */
.strategy-section-strategies {
    margin-top: 1.5rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e0e0e0;
}

.strategy-section-strategies > strong {
    display: block;
    margin-bottom: 1rem;
    color: #2e7d32;
    font-size: 1.1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e8f5e9;
}

.strategy-section-strategies .strategy-content {
    padding-left: 0.5rem;
}

.strategy-section-strategies ul {
    list-style-type: none;
    padding-left: 0;
    margin-bottom: 0;
}

.strategy-section-strategies ul li {
    position: relative;
    padding-left: 1.5rem;
    margin-bottom: 0.75rem;
    line-height: 1.5;
}

.strategy-section-strategies ul li:before {
    content: "•";
    color: #5e9a4f;
    font-weight: bold;
    position: absolute;
    left: 0;
    font-size: 1.2rem;
}
* Diseño responsivo para ADVERTENCIAS CIENTÍFICAS */
.strategy-section-warnings {
    margin-top: 1.5rem;
    background-color: #fff8e1;
    border-radius: 8px;
    padding: 1rem;
    border-left: 3px solid #ffc107;
}

.strategy-section-warnings > strong {
    display: block;
    margin-bottom: 1rem;
    color: #e65100;
    font-size: 1.1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #ffecb3;
}

.strategy-section-warnings .strategy-content {
    padding-left: 0.5rem;
}

.strategy-section-warnings ul {
    list-style-type: none;
    padding-left: 0;
    margin-bottom: 0;
}

.strategy-section-warnings ul li {
    position: relative;
    padding-left: 1.8rem;
    margin-bottom: 0.75rem;
    line-height: 1.5;
    color: #5d4037;
}

.strategy-section-warnings ul li:before {
    content: "⚠️";
    position: absolute;
    left: 0;
    font-size: 1.1rem;
}
/* Diseño responsivo para ESTRATEGIAS ESPECÍFICAS RECOMENDADAS */
.strategy-section-strategies {
    margin-top: 1.5rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e0e0e0;
}

.strategy-section-strategies > strong {
    display: block;
    margin-bottom: 1rem;
    color: #2e7d32;
    font-size: 1.1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e8f5e9;
}

.strategy-section-strategies .strategy-content {
    padding-left: 0.5rem;
}

.strategy-section-strategies ul {
    list-style-type: none;
    padding-left: 0;
    margin-bottom: 0;
}

.strategy-section-strategies ul li {
    position: relative;
    padding-left: 1.5rem;
    margin-bottom: 0.75rem;
    line-height: 1.5;
}

.strategy-section-strategies ul li:before {
    content: "•";
    color: #5e9a4f;
    font-weight: bold;
    position: absolute;
    left: 0;
    font-size: 1.2rem;
}


/* ===== SECCIÓN DE RECOMENDACIONES CLAVE ===== */
#editModal .recommendations-section {
    margin-top: 1.5rem;
}

#editModal .recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 10px;
}

#editModal .recommendation-card {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 12px 15px;
    border-left: 3px solid #5e9a4f;
    transition: all 0.2s ease;
}

#editModal .recommendation-card:hover {
    background-color: #e8f5e9;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

#editModal .recommendation-card h6 {
    color: #2e7d32;
    font-size: 1.05rem;
    margin-bottom: 6px;
}

#editModal .recommendation-card p {
    color: #495057;
    line-height: 1.5;
}

/* ===== SECCIÓN DE ESTRATEGIA ÓPTIMA ===== */
#editModal .optimal-strategy-section {
    margin-bottom: 1.5rem;
}

#editModal .optimal-strategy-section h6 {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

#editModal .optimal-strategy-section ul {
    list-style-type: none;
    padding-left: 0;
    margin: 10px 0;
}

#editModal .optimal-strategy-section ul li {
    padding: 5px 0 5px 20px;
    position: relative;
}

#editModal .optimal-strategy-section ul li:before {
    content: "•";
    position: absolute;
    left: 0;
    color: #5e9a4f;
    font-weight: bold;
}

/* ===== SECCIÓN DE ENTRENAMIENTO ===== */
#editModal .training-config {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

#editModal .days-selector {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    margin-top: 15px;
}

#editModal .day-option {
    background: white;
    border: 1px solid #ced4da;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

#editModal .day-option:hover {
    background-color: #e9ecef;
}

#editModal .day-option.selected {
    background-color: #5e9a4f;
    color: white;
    border-color: #5e9a4f;
}

#editModal .intensity-selector {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

#editModal .intensity-option {
    flex: 1;
    padding: 8px;
    text-align: center;
    border: 1px solid #ced4da;
    border-radius: 6px;
    cursor: pointer;
}

#editModal .intensity-option.selected {
    background-color: #5e9a4f;
    color: white;
    border-color: #5e9a4f;
}

#editModal .schedule-preview {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    border: 1px solid #e9ecef;
}

#editModal .schedule-preview h6 {
    margin-bottom: 10px;
    color: #495057;
}

#editModal .schedule-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
}

#editModal .schedule-day {
    padding: 8px;
    text-align: center;
    border-radius: 6px;
    font-size: 0.85rem;
}

#editModal .schedule-day.rest {
    background-color: #b9f7a5;
    color: #407b33;
}

#editModal .schedule-day.training {
    background-color: #407b33;
    color: white;
}

/* ===== CONFIGURACIÓN AVANZADA ===== */
#editModal .advanced-config {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-top: 20px;
}

#editModal .pause-config {
    margin-bottom: 20px;
}

#editModal .macro-config-pausa {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

/* ===== ESTILOS RESPONSIVOS ===== */
@media (max-width: 768px) {
    #editModal .radio-group {
        grid-template-columns: 1fr;
    }
    
    #editModal .macro-config,
    #editModal .macro-config-pausa {
        grid-template-columns: 1fr;
    }
    
    #editModal .days-selector {
        grid-template-columns: repeat(3, 1fr);
    }
    
    #editModal .schedule-days {
        grid-template-columns: repeat(3, 1fr);
    }
    
    #editModal .config-row {
        flex-direction: column;
    }
    
    #editModal .config-group {
        min-width: 100%;
    }
    
    #editModal .recommendations-grid {
        grid-template-columns: 1fr;
    }
}
	
 /* --- NutriPlan Advanced v2 - Hoja de Estilos Principal --- */
/* --- 1. Estilos Base y Globales --- */
{
    box-sizing: border-box;
}
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    margin: 0;
    padding: 0;
    background-color: #f8f9fa;
    color: #212529;
    line-height: 1.6;
    font-size: 16px;
    padding-bottom: 80px;
}
a {
    text-decoration: none;
    color: #4CAF50; /* Verde principal */
}
a:hover {
    text-decoration: underline;
}
h1, h2, h3, h4, h5, h6 {
    color: #388E3C; /* Verde secundario */
    margin-bottom: 20px;
    font-weight: 600;
}
h1 { font-size: 2.2em; text-align: center; margin-bottom: 30px; }
h2 { font-size: 1.8em; border-bottom: 2px solid #a5d6a7; padding-bottom: 8px; }
h3 { font-size: 1.5em; }
h4 { font-size: 1.2em; color: #1B5E20; margin-top: 25px; }
p { margin: 0 0 1rem 0; }
/* --- 2. Encabezado y Navegación --- */
header {
    background-color: #ffffff;
    padding: 15px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    border-bottom: 1px solid #dee2e6;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
}
.logo a {
    color: #4CAF50;
    text-decoration: none;
    font-size: 1.75em;
    font-weight: 600;
}
nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    align-items: center;
}
nav ul li {
    margin-left: 25px;
}
nav ul li a {
    text-decoration: none;
    color: #495057;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
}
nav ul li a:hover,
nav ul li a.active {
    background-color: #e9f5e9;
    color: #388e3c;
}
nav ul li a.active {
    background-color: #c8e6c9;
    color: #2e7d32;
    font-weight: 600;
}
/* --- 3. Contenido Principal --- */
main {
    padding: 30px 10px;
    max-width: 1500px;
    margin: 20px auto;
    padding-top: 100px; /* Ajustado para el encabezado fijo */
    padding-bottom: 40px;
    box-sizing: border-box;
	
}
h1, h2, h3, h4 { color: #388E3C; margin-bottom: 20px; font-weight: 600; }
    h1 { font-size: 2.2em; text-align: center; margin-bottom: 30px;}
    h2 { font-size: 1.8em; border-bottom: 2px solid #a5d6a7; padding-bottom: 8px;}
    h3 { font-size: 1.5em; }
    h4 { font-size: 1.2em; color: #1B5E20; margin-top: 25px; }
	
/* --- 4. Secciones y Tarjetas --- */
section, .intro-section {
    background-color: #ffffff;
    padding: 25px 30px;
    margin-bottom: 30px;
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
    border: 1px solid #e0e0e0;
    box-sizing: border-box;
	max-width: 1400px;
}
.intro-section {
    box-shadow: none;
    border: none;
    background-color: transparent;
    padding-top: 0;
    margin-bottom: 15px;
}
.plan-step {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: box-shadow 0.3s ease;
	max-width: 1400px
}
.plan-step:hover {
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.plan-step h2 {
    color: #388E3C;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
}
.plan-step h3 {
    color: #495057;
    margin-top: 20px;
    margin-bottom: 15px;
}
.plan-step p {
    color: #495057;
    margin-bottom: 15px;
}
.plan-step p em {
    color: #6c757d;
}
/* --- 5. Formularios y Controles --- */
form {
    margin-top: 15px;
}
label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #495057;
    font-size: 0.9rem;
}
.form-control, .form-select, select, input[type="number"], input[type="text"] {
    display: block;
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 0.9rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    appearance: none;
    border-radius: 0.375rem;
    transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    margin-bottom: 15px;
}
.form-control:focus, .form-select:focus, select:focus, input[type="number"]:focus, input[type="text"]:focus {
    color: #495057;
    background-color: #fff;
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
}
.form-check {
    display: block;
    min-height: 1.5rem;
    padding-left: 1.5em;
    margin-bottom: 0.125rem;
}
.form-check .form-check-input {
    float: left;
    margin-left: -1.5em;
}
.form-check-input {
    width: 1em;
    height: 1em;
    margin-top: 0.25em;
    vertical-align: top;
    background-color: #fff;
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    border: 1px solid rgba(0,0,0,.25);
    appearance: none;
    print-color-adjust: exact;
}
.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
.form-check-label {
    font-weight: 400;
    color: #495057;
    font-size: 0.9rem;
}
.strategy-checkboxes {
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}
		/* 1. Ganar especificidad duplicando la clase */
.target-icon-subtle.target-icon-subtle {
  display: inline-flex;
  align-items: center;
  font-size: 0.8rem;          /* 12px */
  color: #1b4a1b              /* Verde más oscuro */
  text-decoration: none;
  margin: 8px 0;
  font-weight: 500;
  gap: 4px;
  transition: color .25s ease, background-color .25s ease;
  padding: 4px 6px;
  border-radius: 3px;
  background-color: rgba(26, 94, 26, .06);
}

/* 2. Ocultar el texto por defecto */
.target-icon-subtle .text {
  display: none;
  margin-left: 4px;
}

/* 3. Hover: cambiar color y mostrar el texto */
.target-icon-subtle:hover,
.target-icon-subtle:focus {
              /* Verde aún más oscuro */
  background-color: rgba(26, 94, 26, .12);
}

.target-icon-subtle:hover .text,
.target-icon-subtle:focus .text {
  display: inline;
}
.tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
            color: #2b5235;
            margin-left: 5px;
            transition: color 0.3s;
        }
		.tooltip-icon {
            cursor: help;
            color: #3a0ca3;
            font-size: 16px;
            transition: color 0.3s ease;
        }

        .tooltip-container:hover .tooltip-icon {
            color: #ff6f61;
        }

        .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #2b5235;
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #3a0ca3 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
		
    
    /* Estilos específicos solo para el icono de información y exclamación */
    .bi-info-circle-fill.tooltip-icon, 
    .bi-exclamation-diamond-fill.tooltip-icon {
        cursor: help;
        color: #38a169; /* Verde principal */
        font-size: 18px;
        transition: all 0.3s ease;
    }
    
    .tooltip-container:hover .bi-info-circle-fill.tooltip-icon,
    .tooltip-container:hover .bi-exclamation-diamond-fill.tooltip-icon {
        color: #2f855a; /* Verde más oscuro al pasar el mouse */
        transform: scale(1.1);
    }
    
    /* Estilos para el tooltip específico del icono de información y exclamación */
    .tooltip-container .bi-info-circle-fill.tooltip-icon + .tooltip-text,
    .tooltip-container .bi-exclamation-diamond-fill.tooltip-icon + .tooltip-text {
        visibility: hidden;
        width: 280px;
        background-color: #225e3e; /* Fondo verde */
        color: white;
        text-align: center;
        border-radius: 8px;
        padding: 12px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s ease;
        font-size: 14px;
        line-height: 1.5;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }
    
    .tooltip-container .bi-info-circle-fill.tooltip-icon + .tooltip-text::after,
    .tooltip-container .bi-exclamation-diamond-fill.tooltip-icon + .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #38a169 transparent transparent transparent;
    }
    
    .tooltip-container:hover .bi-info-circle-fill.tooltip-icon + .tooltip-text,
    .tooltip-container:hover .bi-exclamation-diamond-fill.tooltip-icon + .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

/* --- 6. Botones --- */
button, .btn, input[type="submit"], input[type="button"] {
    display: inline-block;
    font-weight: 400;
    line-height: 1.5;
    color: #212529;
    text-align: center;
    text-decoration: none;
    vertical-align: middle;
    cursor: pointer;
    user-select: none;
    background-color: transparent;
    border: 1px solid transparent;
    padding: 0.375rem 0.75rem;
    font-size: 0.9rem;
    border-radius: 0.375rem;
    transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    margin-top: 10px;
}
/* --- Botones Primarios (Verde) --- */
.btn-primary, button[type="submit"], #calculate-macros-button, #calculate-goal-button, #estimate-time-button, #generate-meals-button, #generate-hyperprotein-button {
    color: #fff;
    background-color: #4CAF50; /* Verde principal */
    border-color: #4CAF50;    /* Verde principal */
}
.btn-primary:hover, button[type="submit"]:hover, #calculate-macros-button:hover, #calculate-goal-button:hover, #estimate-time-button:hover, #generate-meals-button:hover, #generate-hyperprotein-button:hover {
    background-color: #45a049; /* Verde más oscuro al pasar el ratón */
    border-color: #45a049;    /* Verde más oscuro al pasar el ratón */
    color: #fff;              /* Asegurar color blanco en hover */
}
/* --- Botones Grandes --- */
.btn-lg {
    padding: 0.5rem 1rem;
    font-size: 1.1rem;
    border-radius: 0.5rem;
}
/* --- Botones Pequeños --- */
.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8125rem;
    border-radius: 0.25rem;
}
/* --- Botones Outline Primarios (Verde) --- */
.btn-outline-primary {
    color: #4CAF50;       /* Verde para el texto */
    border-color: #4CAF50; /* Verde para el borde */
    background-color: transparent;
}
.btn-outline-primary:hover {
    color: #fff;          /* Texto blanco al pasar el ratón */
    background-color: #4CAF50; /* Fondo verde al pasar el ratón */
    border-color: #4CAF50;     /* Borde verde al pasar el ratón */
}




.tooltip-icon2 {
    position: relative;
    display: inline-block;
    margin-left: 5px;
    color: #3a0ca3;
    cursor: pointer;
    font-size: 16px;
    vertical-align: middle;
}

.tooltip-icon2 .tooltip {
    visibility: hidden;
    width: 250px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 5px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -125px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 12px;
}

.tooltip-icon2:hover .tooltip {
    visibility: visible;
    opacity: 1;
}

.tooltip-icon2:hover {
    color: #ff6f61; /* Efecto hover para el ícono */
}

.target-icon2 {
    margin-left: 10px;
    color: #3a0ca3;
    font-size: 20px;
}

.target-icon2:hover {
    color: #ff6f61; /* Efecto hover para el ícono del modal */
}
/* --- Botón Guardar PDF (Especial) --- */
#save-pdf-button {
    margin-top: 30px;
    background-color: #4CAF50; /* Verde principal */
    width: auto;
    padding: 12px 25px;
    display: block;
    margin-left: auto;
    margin-right: auto;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
}
#save-pdf-button:hover {
    background-color: #45a049; /* Verde más oscuro al pasar el ratón */
    color: white;
}
/* --- 7. Tarjetas y Contenedores --- */
.card {
    position: relative;
    display: flex;
    flex-direction: column;
    min-width: 0;
    word-wrap: break-word;
    background-color: #fff;
    background-clip: border-box;
    border: 1px solid rgba(0, 0, 0, 0.125);
    border-radius: 0.375rem; /* Bordes redondeados */
    margin-bottom: 1.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* Sombra ligera para profundidad */
}
.card-header {
    padding: 0.75rem 1.25rem;
    margin-bottom: 0;
    /* Color de fondo y borde actualizados para mejor contraste visual */
    background-color: #f8f9fa; /* Fondo gris muy claro */
    border-bottom: 1px solid rgba(0, 0, 0, 0.08); /* Borde inferior sutil */
    font-weight: 500; /* Negrita ligera para el encabezado */
    color: #495057; /* Color de texto gris oscuro */
    border-top-left-radius: calc(0.375rem - 1px); /* Bordes redondeados superiores */
    border-top-right-radius: calc(0.375rem - 1px);
}
.card-body {
    flex: 1 1 auto;
    padding: 1.25rem;
}
/* Asegurar margen consistente cuando se usa la clase mb-4 */
.card.mb-4 {
    margin-bottom: 1.5rem !important;
}
/* --- Sección 6: Ciclos Dietéticos - Estilos para step-4 y selects de fase --- */



/* 6. Estilo para el contenedor principal de la sección 6 */
/* Si quieres un estilo específico para la sección que contiene todo esto */
.card.mb-4 { /* Asumiendo que este es el contenedor de la sección 6 */
    margin-top: 30px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
}

.card.mb-4 .card-header {
    background-color: #e8f5e9; /* Fondo verde muy claro para el encabezado */
    border-bottom: 1px solid #c8e6c9;
    color: #1B5E20;
}

.card.mb-4 .card-header h5 {
    color: #1B5E20;
    margin-bottom: 0;
}
/* --- Sección 6: Ciclos Dietéticos - Estilos unificados para ambas columnas --- */
/* 2. Ocultar por defecto todos los selects y labels de fase */
#fasePerdida1, #labelFasePerdida1,
#faseGanancia1, #labelFaseGanancia1,
#enfoqueMantenimiento1, #labelEnfoqueMantenimiento1,
#faseMixto1, #labelFaseMixto1 {
    display: none;
    margin: 10px 0 10px 0;
    padding: 10px 15px;
    border: 2px solid #4CAF50;
    border-radius: 8px;
    background-color: #f1f8e9;
    font-size: 1rem;
    font-weight: normal;
    color: #2E7D32;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease-in-out;
    width: 100%;
    max-width: 500px;
}

/* 3. Asegurar que los labels tengan un estilo consistente */
#labelFasePerdida1, #labelFaseGanancia1,
#labelEnfoqueMantenimiento1, #labelFaseMixto1 {
    font-weight: 600;
    color: #1B5E20;
    background-color: transparent;
    border: none;
    box-shadow: none;
    padding: 0 0 5px 0;
    margin-top: 15px;
    margin-bottom: 8px;
}

/* 4. Estilos cuando los elementos están destinados a mostrarse */
#fasePerdida1:target, #faseGanancia1:target,
#enfoqueMantenimiento1:target, #faseMixto1:target,
#labelFasePerdida1:target, #labelFaseGanancia1:target,
#labelEnfoqueMantenimiento1:target, #labelFaseMixto1:target {
    display: block;
}

/* 5. Estilos para los selects */
#fasePerdida1, #faseGanancia1, #enfoqueMantenimiento1, #faseMixto1 {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='14' fill='%231B5E20' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    cursor: pointer;
}

#fasePerdida1:focus, #faseGanancia1:focus, #enfoqueMantenimiento1:focus, #faseMixto1:focus {
    border-color: #1B5E20;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(27, 94, 32, 0.25);
}

/* 6. Estilos para el card-body de selects y estrategias */
.card-body {
    padding: 20px;
    /*border: 0.5px solid #4CAF50; */
    border-radius: 10px;
    /* background-color: #f1f8e9; */
    margin-top: 0px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease-in-out;
}

.card-body .row {
    margin-top: 0;
}

#opcionesPerdida1, #opcionesGanancia1,
#opcionesMantenimiento1, #opcionesMixto1 {
    margin-top: 0;
    padding: 10px 15px;
    border: 0.5px solid #4CAF50; 
    border-radius: 8px;
    /* background-color: #f1f8e9; */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.strategy-checkboxes .form-check {
    margin-bottom: 8px;
}

.strategy-checkboxes .form-check-label {
    color: #2E7D32;
}

/* 7. Estilos unificados para columnas */
.col-md-6 {
    padding: 0 10px;
}

.col-md-6 .card-header {
    background-color: #e8f5e9;
    border-bottom: 0.2px solid #c8e6c9;
    padding: 0.5rem 1rem;
    margin: -2px -2px 0 -2px;
}

.col-md-6 .card-header h5 {
    margin: 0;
    font-size: 1.25rem;
    color: #1B5E20;
}

.col-md-6 .form-label {
    display: block;
    margin-bottom: 0.5rem;
    color: #2E7D32;
    font-weight: 600;
}

.col-md-6 .form-control {
    width: 100%;
    padding: 10px 15px;
    font-size: 1rem;
    line-height: 1.5;
    color: #2E7D32;
    background-color: #fff;
    border: 0.5px solid #4CAF50;
    border-radius: 10px;
    transition: all 0.3s ease-in-out;
}

.col-md-6 .form-control:focus {
    border-color: #1B5E20;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(27, 94, 32, 0.25);
}

.col-md-6 .list-unstyled li {
    margin-bottom: 0.2rem;
    color: #2E7D32;
}

.col-md-6 .list-unstyled strong {
    color: #1B5E20;
}
/* --- 8. Tablas --- */
/* Hacer que la tabla sea responsive envolviéndola en un contenedor */
.table-responsive {
    overflow-x: auto; /* Scroll horizontal si el contenido es ancho */
    -webkit-overflow-scrolling: touch; /* Mejor experiencia táctil en dispositivos móviles */
}
/* Estilo base de la tabla */
.table {
    width: 100%;
    margin-bottom: 1rem;
    color: #212529; /* Color de texto base */
    vertical-align: top;
    border-color: #dee2e6; /* Color de borde base */
    /* Eliminar border-collapse por defecto para permitir bordes de celda */
}
/* Celdas de la tabla */
.table th,
.table td {
    padding: 0.5rem; /* Padding interno */
    vertical-align: top; /* Alinear contenido al inicio */
    border-top: 1px solid #dee2e6; /* Borde superior sutil */
}
/* Encabezado de la tabla */
.table thead th {
    vertical-align: bottom;
    border-bottom: 2px solid #dee2e6; /* Borde inferior más grueso para encabezados */
    /* Colores actualizados para encabezados */
    background-color: #93c47d; /* Fondo gris claro para encabezados */
    color: #495057; /* Color de texto gris oscuro */
    text-align: center; /* Centrar texto del encabezado */
    font-weight: 600; /* Negrita para encabezados */
    white-space: nowrap; /* Evitar salto de línea en encabezados si es posible */
}
/* Efecto hover en filas del cuerpo */
.table tbody tr:hover {
    background-color: #f1f3f5; /* Fondo gris muy claro al pasar el ratón */
    transition: background-color 0.15s ease-in-out; /* Transición suave */
}
/* Tabla con filas rayadas */
.table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(0, 0, 0, 0.025); /* Rayas gris muy claro */
}
/* Tabla con bordes */
.table-bordered {
    border: 1px solid #dee2e6; /* Borde exterior */
}
.table-bordered th,
.table-bordered td {
    border: 1px solid #dee2e6; /* Borde para celdas */
}
.table-bordered thead th,
.table-bordered thead td {
    border-bottom-width: 2px; /* Borde inferior más grueso para encabezados */
}
/* --- Estilos Generales para las Tablas de Planificación --- */
.card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid rgba(0,0,0,.125);
    border-radius: 0.375rem;
}
.card.tabla-planificacion .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,.125);
    padding: 0.75rem 1.25rem;
}
.card.tabla-planificacion .card-body {
    padding: 0;
}
.table-responsive.tabla-planificacion-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 0;
    margin: 0;
}
.table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0;
    table-layout: auto;
    font-size: 0.875rem;
    border: 0;
}
.table.tabla-planificacion thead th {
    background-color: #e9ecef;
    color: #495057;
    font-weight: 600;
    text-align: center;
    vertical-align: middle;
    white-space: nowrap;
    padding: 0.5rem;
    border-bottom: 2px solid #dee2e6;
}
.table.tabla-planificacion tbody tr {
    transition: background-color 0.15s ease-in-out;
}
.table.tabla-planificacion tbody tr:hover {
    background-color: #f1f3f5;
}
.table.tabla-planificacion tbody td {
    padding: 0.4rem 0.5rem;
    vertical-align: top;
    border-top: 1px solid #dee2e6;
    word-break: break-word;
}
/* --- Estilos para Badges dentro de las tablas --- */
.badge {
    display: inline-block;
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
    margin: 0.1rem;
}
.bg-danger { background-color: #dc3545 !important; }
.bg-warning { background-color: #ffc107 !important; color: #000 !important; }
.bg-success { background-color: #198754 !important; }
.bg-info { background-color: #0dcaf0 !important; color: #000 !important; }
.bg-secondary { background-color: #6c757d !important; }
.bg-primary { background-color: #0d6efd !important; }
.bg-dark { background-color: #212529 !important; }

/* --- Estilos específicos para la Tabla General del Proceso --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion thead th {
    background-color: #d1ecf1;
    color: #0c5460;
    border-bottom-color: #bee5eb;
	border-radius: 8px;
}
/* --- Estilos específicos para la Tabla Específica (Planificación Temporal) --- */
#planificacionTemporal .table.tabla-planificacion thead th {
    background-color: #d4edda; /* Verde claro para distinguirla */
    color: #155724;
    /* border-bottom-color: #c3e6cb; */
}
#planificacionTemporal .macro-input {
    width: 60px;
    padding: 0.25rem 0.5rem;
    font-size: 0.8125rem;
    text-align: center;
}

/* --- Estilos Específicos para las Tablas de Planificación --- */

/* --- 1. Tabla General del Proceso --- */
#tablaGeneralProcesoContainer .card.tabla-planificacion .card-header {
    /* Opcional: Estilo del encabezado de la tarjeta */
    background-color: #f1f8e9; /* Fondo verde muy claro para la tarjeta */
    border-bottom: 1px solid #c8e6c9;
	border-radius:8px;
}
#tablaGeneralProcesoContainer .table.tabla-planificacion thead th {
    background-color: #E6F4EA; /* Verde pistacho claro */
    color: #2E7D32;            /* Verde oscuro para el texto */
    border-bottom-color: #C8E6C9; /* Verde más oscuro para el borde inferior */
	border-radius:8px;
}


/* --- 3. Tabla Detallada de Fase (Detalles Semanales) --- */

/* --- Contenedor principal de la tarjeta --- */
#tablaDetalladaFaseContainer .card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid #d4edda; /* Borde verde claro */
    border-radius: 8px;
    overflow: hidden; /* Para que los bordes redondeados se apliquen correctamente a los hijos */
}

/* --- Encabezado de la tarjeta --- */
#tablaDetalladaFaseContainer .card-header {
    background-color: #e6f4ea; /* Fondo verde pistacho claro */
    border-bottom: 1px solid #c8e6c9; /* Borde inferior verde más oscuro */
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #2e7d32; /* Texto verde oscuro */
}

/* --- Cuerpo de la tarjeta --- */
#tablaDetalladaFaseContainer .card-body {
    padding: 0; /* Eliminar padding para que la tabla llegue a los bordes */
}

/* --- Contenedor responsive de la tabla --- */
#tablaDetalladaFaseContainer .table-responsive.tabla-planificacion-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 0; /* Eliminar borde por defecto del wrapper */
    margin: 0; /* Eliminar margen por defecto */
}

/* --- Estilo base de la tabla --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0; /* Eliminar margen inferior por defecto */
    table-layout: auto; /* Permitir que las columnas se ajusten */
    font-size: 0.875rem; /* Tamaño de fuente ligeramente más pequeño */
    border: 0; /* La tabla en sí no necesita borde si está dentro del card-body */
    border-collapse: collapse; /* Asegurar colapso de bordes */
}

/* --- Encabezado de la tabla --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion thead th {
    background-color: #E6F4EA; /* Fondo verde pistacho claro */
    color: #2E7D32;            /* Letras verdes oscuras */
    border-bottom: 2px solid #C8E6C9; /* Borde inferior verde más oscuro */
    padding: 0.75rem;          /* Espaciado interno */
    text-align: center;        /* Texto centrado */
    font-weight: 600;          /* Negrita para encabezados */
    white-space: nowrap;       /* Evitar salto de línea en encabezados si es posible */
    vertical-align: middle;    /* Alineación vertical al centro */
}

/* --- Cuerpo de la tabla --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion tbody td {
    padding: 0.6rem 0.75rem;    /* Espaciado interno reducido */
    vertical-align: top;       /* Alinear contenido al inicio */
    border-top: 1px solid #dee2e6; /* Borde superior sutil */
    word-break: break-word;    /* Romper palabras largas si es necesario */
}

/* --- Filas pares (rayas) --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion tbody tr:nth-child(even) {
    background-color: #f1f8e9; /* Fondo verde muy claro para filas pares */
}

/* --- Efecto hover en filas --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion tbody tr:hover {
    background-color: #e6f4ea; /* Fondo verde pistacho claro al pasar el ratón */
    transition: background-color 0.15s ease-in-out; /* Transición suave */
}

/* --- Notas pequeñas dentro de las celdas --- */
#tablaDetalladaFaseContainer .table.tabla-planificacion .small-note {
    font-size: 0.75rem; /* Fuente aún más pequeña para notas */
    color: #6c757d; /* Gris para notas */
    font-style: italic;
    margin: 0; /* Eliminar márgenes por defecto de párrafos */
}

/* --- Asegurar que los selects y inputs dentro de esta tabla se vean bien --- */
/* Seleccionar por ID de la tabla para mayor especificidad */
#tablaDetalladaInteractiva .form-select,
#tablaDetalladaInteractiva .form-control {
    font-size: 0.8125rem;
    padding: 0.25rem 0.5rem;
    height: auto; /* Permitir que se ajusten en altura */
    width: 100%; /* Ocupar todo el ancho de la celda */
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
}

#tablaDetalladaInteractiva .form-control-sm {
    min-width: 80px; /* Ancho mínimo para inputs de texto */
}

/* --- Media Queries para Responsividad (Opcional pero recomendado) --- */
@media (max-width: 767.98px) {
    #tablaDetalladaFaseContainer .table.tabla-planificacion {
        font-size: 0.75rem; /* Reducir aún más el tamaño de fuente en móviles */
    }
    #tablaDetalladaFaseContainer .table.tabla-planificacion thead th,
    #tablaDetalladaFaseContainer .table.tabla-planificacion tbody td {
        padding: 0.4rem 0.5rem; /* Reducir padding en móviles */
    }
    #tablaDetalladaFaseContainer .form-select,
    #tablaDetalladaFaseContainer .form-control {
        font-size: 0.75rem;
        padding: 0.2rem 0.4rem;
    }
}

/* --- 1. Tabla General del Proceso --- */

/* --- Contenedores de la tarjeta --- */
#tablaGeneralProcesoContainer .card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid #d4edda; /* Borde verde claro */
    border-radius: 8px;
}

/* --- Encabezado de la tarjeta --- */
#tablaGeneralProcesoContainer .card-header {
    background-color: #e8f5e9; /* Fondo verde claro para la tarjeta */
    border-bottom: 1px solid #c8e6c9; /* Borde inferior verde más oscuro */
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #2e7d32; /* Texto verde oscuro */
	border-radius:8px;
}

/* --- Cuerpo de la tarjeta --- */
#tablaGeneralProcesoContainer .card-body {
    padding: 0; /* Eliminar padding para que la tabla llegue a los bordes */
	border-radius:8px;
}

/* --- Contenedores responsive de la tabla --- */
#tablaGeneralProcesoContainer .table-responsive.tabla-planificacion-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 0;
    margin: 0;
    /* Ajustar la barra de desplazamiento */
    scrollbar-width: thin; /* Para Firefox */
    scrollbar-color: #c8e6c9 #e8f5e9; /* Color del thumb y track en Firefox */
}
/* Para Chrome, Edge y Safari */
#tablaGeneralProcesoContainer .table-responsive.tabla-planificacion-wrapper::-webkit-scrollbar {
    width: 8px; /* Ancho de la barra */
}
#tablaGeneralProcesoContainer .table-responsive.tabla-planificacion-wrapper::-webkit-scrollbar-track {
    background: #e8f5e9; /* Fondo del track */
}
#tablaGeneralProcesoContainer .table-responsive.tabla-planificacion-wrapper::-webkit-scrollbar-thumb {
    background-color: #c8e6c9; /* Color del thumb */
    border-radius: 4px; /* Bordes redondeados */
}
#tablaGeneralProcesoContainer .table-responsive.tabla-planificacion-wrapper::-webkit-scrollbar-thumb:hover {
    background-color: #9ccc65; /* Color del thumb al pasar el ratón */
}

/* --- Estilo base de la tabla --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0;
    border-collapse: collapse;
    font-size: 0.9rem;
    color: #212529;
}

/* --- Encabezado de la tabla --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion thead th {
    background-color: #E6F4EA; /* Fondo verde pistacho claro */
    color: #2E7D32;            /* Letras verdes oscuras */
    border-bottom: 2px solid #C8E6C9; /* Borde inferior más grueso */
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
    vertical-align: middle;
}

/* --- Cuerpo de la tabla --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion tbody td {
    padding: 0.75rem;
    vertical-align: top;
    border-top: 1px solid #dee2e6;
    background-color: #f1f8e9; /* Fondo verde muy claro para todas las celdas del cuerpo */
}

/* --- Filas pares (rayas) --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion tbody tr:nth-child(even) {
    background-color: #f1f8e9; /* El mismo fondo que las celdas para evitar rayas */
}

/* --- Efecto hover en filas --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion tbody tr:hover {
    background-color: #e6f4ea; /* Fondo verde pistacho claro al pasar el ratón */
    transition: background-color 0.15s ease-in-out;
}

/* --- Notas pequeñas dentro de las celdas --- */
#tablaGeneralProcesoContainer .table.tabla-planificacion .small-note {
    font-size: 0.75rem;
    color: #6c757d;
    font-style: italic;
    margin: 0;
}
/* CSS especifico para la tabla con ID tablaGeneralProceso */
#tablaGeneralProceso .accordion-header {
    border-radius: 10px;
    overflow: hidden; /* Asegura que el contenido se ajuste dentro de los bordes redondeados */
}

#tablaGeneralProceso .accordion-header table thead th {
    text-align: center; /* Alinea horizontalmente el texto */
    vertical-align: middle;
}

#tablaGeneralProceso .accordion-phase td {
    vertical-align: middle;
}

#tablaGeneralProceso .accordion-content {
    border-radius: 10px;
    overflow: hidden;
}
 /* --- Plan Steps & Results --- */
    #plan-container { display: grid; grid-template-columns: 1fr; gap: 25px; }
    .plan-step { border: 1px solid #e0e0e0; padding: 20px; border-radius: 6px; background-color: #fdfdfd; }
    .plan-step p { color: #495057; margin-bottom: 15px; }

    /* Results divs styling */
    #calorie-result, #weight-goal-result, #energy-balance-result, #macro-result, #meal-result, #time-estimation-result, #step-5-results { /* Updated ID */
        margin-top: 20px; padding: 18px; background-color: #e9f5e9; border: 1px solid #c8e6c9; border-radius: 5px; line-height: 1.7; color: #1B5E20;
        min-height: 30px;
    }
    #calorie-result p, #weight-goal-result p, #time-estimation-result p { margin-bottom: 10px; }
    #calorie-result strong, #weight-goal-result strong, #time-estimation-result strong { color: #388E3C; }

    #macro-result ul, #meal-result ul { padding-left: 25px; margin-top: 10px; }
    #macro-result li, #meal-result li { margin-bottom: 10px; color: #333; }
    #macro-result strong, #meal-result strong { color: #388E3C; }
    #meal-result h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #c8e6c9; padding-bottom: 10px; }
    #meal-result .plan-step { background-color: #f5fbf5 !important; border: 1px solid #d4eed5; }
    #meal-result h4 { margin-bottom: 10px; }
	
	
/* --- 9. Gráficos --- */
.chart-container, #chart-container, #weight-chart-container, #time-estimation-chart-container, #macroChart, #weightEvolutionChart, #timeEstimationChart {
    position: relative;
    height: 300px;
    width: 100%;
    margin: 20px 0;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    display: none;
    box-sizing: border-box;
}
.chart-container canvas, #chart-container canvas, #weight-chart-container canvas, #time-estimation-chart-container canvas, #macroChart, #weightEvolutionChart, #timeEstimationChart {
    display: block;
    width: 95% !important;
    height: 95% !important;
    margin: auto;
}
/* === 📈 ESTILO ESPECÍFICO PARA EL GRÁFICO DE ESTIMACIÓN DE TIEMPO === */
#timeEstimationChart-container {
    position: relative;
    width: 100%;
    height: 400px; /* Más alto para mejor visualización de ambas líneas */
    margin: 25px 0;
    background-color: #ffffff;
    border: 1px solid #a5d6a7;
    border-radius: 12px;
    box-shadow: 
        0 4px 12px rgba(0, 0, 0, 0.12),
        0 1px 3px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.4); /* Brillo interno */
    overflow: hidden;
    transition: box-shadow 0.3s ease, transform 0.2s ease;
}

/* Efecto hover: levantar el gráfico al pasar el ratón */
#timeEstimationChart-container:hover {
    box-shadow: 
        0 8px 20px rgba(0, 0, 0, 0.18),
        0 2px 6px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
}

/* Canvas interno */
#timeEstimationChart-container canvas {
    display: block;
    width: 98% !important;
    height: 98% !important;
    margin: 1% auto;
    border-radius: 10px; /* Asegura que el canvas no toque el borde */
}

/* Fuente de etiquetas y títulos (mejora legibilidad) */
#timeEstimationChart-container .chartjs-tooltip {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    border-radius: 6px;
    opacity: 0.95;
}

/* Fondo del canvas (opcional: gradiente suave) */
#timeEstimationChart-container canvas {
    background: linear-gradient(to bottom, #f8fdf9 0%, #ffffff 100%) !important;
}

/* === 🔦 FORZAR VISIBILIDAD DEL CANVAS === */
#timeEstimationChart {
    outline: 2px solid #FFD54F !important; /* Borde amarillo para ver si existe */
    filter: none !important;
    opacity: 1 !important;
    visibility: visible !important;
}

#timeEstimationChart-container canvas {
    border: 1px solid transparent; /* Solo para debugging */
    image-rendering: -webkit-optimize-contrast;
    transform: translateZ(0); /* Fuerza aceleración por hardware */
}
    
	/* Styling for all tables: hyperprotein-cycle-table, tablaPlanificacionBody, and table inside tablaDetalladaFaseContainer/accordionMeses */
#hyperprotein-cycle-table-container, 
#tablaPlanificacionBody-container, 
#tablaDetalladaFaseContainer {
    margin-top: 20px;
    overflow-x: auto; /* Allow horizontal scroll on small screens */
}

#hyperprotein-cycle-table, 
#tablaPlanificacionBody, 
#tablaDetalladaFaseContainer table, 
#accordionMeses table {
    width: 90%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.9em;
    min-width: 600px; /* Minimum width before scroll appears */
}

#hyperprotein-cycle-table th, 
#hyperprotein-cycle-table td,
#tablaPlanificacionBody th, 
#tablaPlanificacionBody td,
#tablaDetalladaFaseContainer table th, 
#tablaDetalladaFaseContainer table td,
#accordionMeses table th, 
#accordionMeses table td {
    border: 1px solid #c8e6c9;
    padding: 8px 10px;
    text-align: center;
    vertical-align: middle;
}

#hyperprotein-cycle-table th, 
#tablaPlanificacionBody th, 
#tablaDetalladaFaseContainer table th, 
#accordionMeses table th {
    background-color: #dcedc8;
    color: #1B5E20;
    font-weight: 600;
    white-space: nowrap; /* Prevent header text wrapping */
}

#hyperprotein-cycle-table tr:nth-child(even),
#tablaPlanificacionBody tr:nth-child(even),
#tablaDetalladaFaseContainer table tr:nth-child(even),
#accordionMeses table tr:nth-child(even) {
    background-color: #f1f8e9;
}

#hyperprotein-cycle-table td, 
#tablaPlanificacionBody td, 
#tablaDetalladaFaseContainer table td, 
#accordionMeses table td {
    color: #333;
}

#hyperprotein-cycle-table td:nth-child(2), /* Fase */
#hyperprotein-cycle-table td:nth-child(7), /* Notas */
#tablaPlanificacionBody td:nth-child(2), /* Fase */
#tablaPlanificacionBody td:nth-child(7), /* Notas */
#tablaDetalladaFaseContainer table td:nth-child(2), /* Fase */
#tablaDetalladaFaseContainer table td:nth-child(7), /* Notas */
#accordionMeses table td:nth-child(2), /* Fase */
#accordionMeses table td:nth-child(7) { /* Notas */
    text-align: left;
}

#hyperprotein-cycle-table .phase-hyperprotein,
#tablaPlanificacionBody .phase-hyperprotein,
#tablaDetalladaFaseContainer table .phase-hyperprotein,
#accordionMeses table .phase-hyperprotein {
    color: #0275d8; /* Blue for hyperprotein */
}

#hyperprotein-cycle-table .phase-break,
#tablaPlanificacionBody .phase-break,
#tablaDetalladaFaseContainer table .phase-break,
#accordionMeses table .phase-break {
    background-color: #fff9c4; /* Light yellow for break */
    color: #5f4300; /* Dark yellow text */
}

#hyperprotein-cycle-table th:nth-child(6),
#hyperprotein-cycle-table td:nth-child(6),
#tablaPlanificacionBody th:nth-child(6),
#tablaPlanificacionBody td:nth-child(6),
#tablaDetalladaFaseContainer table th:nth-child(6),
#tablaDetalladaFaseContainer table td:nth-child(6),
#accordionMeses table th:nth-child(6),
#accordionMeses table td:nth-child(6) {
    width: 200px;
    min-width: 200px;
    white-space: pre-line;
    vertical-align: top;
    line-height: 1.5;
}

/* Ensure accordionMeses integrates well with the table */
#accordionMeses .accordion-item {
    border: 1px solid #c8e6c9; /* Match table border color */
    margin-bottom: 10px;
    border-radius: 4px;
}

#accordionMeses .accordion-header {
    background-color: #dcedc8; /* Match table header background */
    color: #1B5E20; /* Match table header text */
    font-weight: 600;
}

#accordionMeses .accordion-button {
    padding: 8px 10px;
    font-size: 0.9em;
    color: #1B5E20;
    background-color: #dcedc8;
}

#accordionMeses .accordion-button:not(.collapsed) {
    background-color: #c8e6c9; /* Slightly darker when expanded */
    color: #1B5E20;
}

#accordionMeses .accordion-body {
    padding: 10px;
    background-color: #f1f8e9; /* Match table even-row background */
}
 /* Chart Containers */
    #chart-container, #weight-chart-container, #time-estimation-chart-container {
        margin-top: 20px;
        padding: 0;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        width: 95%;
        height: 350px;
        position: center;
        display: none; /* Initially hidden */
        box-sizing: border-box;
    }
    #chart-container canvas, #weight-chart-container canvas, #time-estimation-chart-container canvas {
        display: block;
        width: 95% !important;
        height: 100% !important;
    }

    /* Percentage inputs section styling */
   /* Macro percentage inputs section styling - Actualizado */
#macro-percentage-inputs {
    margin: 1rem 0;
    padding: 1.5rem;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    background: linear-gradient(135deg, #f5fbf5 0%, #eaf5ea 100%);
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    font-family: inherit;
}

#macro-percentage-inputs > label {
    display: block;
    font-weight: 600;
    font-size: 1.1rem;
    color: #495057;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #388E3C;
}

#macro-percentage-inputs > label:first-of-type {
    color: #388E3C !important;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 0.5rem 0.75rem;
    background-color: rgba(56, 142, 60, 0.1);
    border-radius: 0.375rem;
    margin-bottom: 1rem;
    display: block;
    border-left: 3px solid #388E3C;
}

#macro-percentage-inputs div {
    margin-bottom: 1rem;
}

#macro-percentage-inputs div label {
    display: block;
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

#macro-percentage-inputs input[type="number"] {
    display: block;
    width: 100%;
    padding: 0.375rem 0.75rem;
    font-size: 0.9rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    margin-bottom: 0.5rem;
}

#macro-percentage-inputs input[type="number"]:focus {
    color: #495057;
    background-color: #fff;
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

#macro-percentage-inputs input[readonly] {
    background-color: #e9ecef;
    cursor: not-allowed;
    color: #6c757d;
    font-weight: 400;
}

#macro-percentage-inputs .input-group {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
}

#macro-percentage-inputs .input-item {
    flex: 1;
    min-width: 200px;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.375rem;
    border: 1px solid #e9ecef;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

#macro-percentage-inputs .macro-bars {
    display: flex;
    height: 1.5rem;
    margin: 1rem 0;
    border-radius: 0.375rem;
    overflow: hidden;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

#macro-percentage-inputs .protein-bar {
    background: linear-gradient(90deg, #a8e6cf 0%, #93e4c1 100%);
}

#macro-percentage-inputs .carbs-bar {
    background: linear-gradient(90deg, #ffd3b6 0%, #ffc4a3 100%);
}

#macro-percentage-inputs .fat-bar {
    background: linear-gradient(90deg, #355e3b 0%, #2a4b30 100%);
}

#macro-percentage-inputs .macro-legend {
    display: flex;
    justify-content: space-between;
    margin: 1rem 0;
}

#macro-percentage-inputs .legend-item {
    display: flex;
    align-items: center;
    font-size: 0.9rem;
    font-weight: 400;
}

#macro-percentage-inputs .legend-color {
    width: 1rem;
    height: 1rem;
    border-radius: 0.25rem;
    margin-right: 0.5rem;
}

#macro-percentage-inputs .protein-color {
    background: #93e4c1;
}

#macro-percentage-inputs .carbs-color {
    background: #ffc4a3;
}

#macro-percentage-inputs .fat-color {
    background: #2a4b30;
}

#macro-percentage-inputs #macro-percentage-total {
    text-align: center;
    font-size: 1rem;
    font-weight: 600;
    padding: 0.75rem;
    margin-top: 1rem;
    background-color: #e2f0e0;
    border-radius: 0.375rem;
    border-left: 3px solid #2a9149;
    color: #2a9149;
}

#macro-percentage-inputs .percentage-info {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
    font-style: italic;
}

#macro-percentage-inputs .goal-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.8rem;
    font-weight: 500;
    margin-left: 0.5rem;
}

#macro-percentage-inputs .goal-loss {
    background-color: #93e4c1;
    color: #212529;
}

#macro-percentage-inputs .goal-gain {
    background-color: #ffc4a3;
    color: #212529;
}

/* Estilos para el gráfico */
#macro-percentage-inputs #chart-container {
    margin-top: 1.5rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    height: 300px;
    position: relative;
}

#macro-percentage-inputs #chart-container::before {
    content: "Distribución de Macronutrientes";
    display: block;
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.75rem;
    text-align: center;
    font-size: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    #macro-percentage-inputs .input-group {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    #macro-percentage-inputs .input-item {
        min-width: 100%;
    }
    
    #macro-percentage-inputs .macro-legend {
        flex-direction: column;
        gap: 0.5rem;
    }
}

        /* Responsive */
        @media (max-width: 768px) {
            #macro-percentage-inputs .input-group {
                flex-direction: column;
                gap: 15px;
            }
            
            #macro-percentage-inputs .input-item {
                min-width: 100%;
            }
            
            #macro-percentage-inputs .macro-legend {
                flex-direction: column;
                gap: 10px;
            }
        }
		.macro-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-item {
            flex: 1;
            min-width: 200px;
        }
        
        .input-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .input-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .input-item input:focus {
            border-color: #4CAF50;
            outline: none;
        }
        
        .macro-visualization {
            margin: 30px 0;
        }
        
        .macro-bars {
            display: flex;
            height: 40px;
            margin: 20px 0;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .protein-bar {
            background: linear-gradient(90deg, #a8e6cf 0%, #93e4c1 100%);
            transition: width 0.5s ease;
        }
        
        .carbs-bar {
            background: linear-gradient(90deg, #ffd3b6 0%, #ffc4a3 100%);
            transition: width 0.5s ease;
        }
        
        .fat-bar {
            background: linear-gradient(90deg, #355e3b 0%, #2a4b30 100%);
            transition: width 0.5s ease;
        }
        
        .macro-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .macro-label {
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 14px;
            color: white;
            text-align: center;
            min-width: 100px;
        }
        
        .protein-label {
            background-color: #93e4c1;
            color: #333;
        }
        
        .carbs-label {
            background-color: #ffc4a3;
            color: #333;
        }
        
        .fat-label {
            background-color: #2a4b30;
        }
        
        .total-display {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 15px;
            margin-top: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .good-total {
            color: #4CAF50;
        }
        
        .bad-total {
            color: #F44336;
        }
		/* --- Estilos para Tablas Detalladas dentro de Acordeones --- */
/* --- Estilos Unificados para Tablas Detalladas dentro de Acordeones --- */
/* Incluye: Estilo visual, centrado, hover, responsividad, scroll */

/* --- Contenedor de la tabla dentro del acordeón --- */
.accordion .accordion-body .table-responsive.tabla-planificacion-wrapper {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 1rem;
    /* Asegurar comportamiento suave en móviles */
    -webkit-overflow-scrolling: touch;
    /* Resetear max-height que pueda interferir desde otros estilos */
    max-height: none;
    overflow-x: auto; /* Permite scroll horizontal si es necesario */
}

/* --- Tabla en sí --- */
.accordion .accordion-body .table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0;
    border-collapse: separate; /* Necesario para border-radius en el contenedor */
    border-spacing: 0;
    font-size: 0.85rem;
    color: #212529;
    background-color: white;
    /* Asegurar table-layout fixed para control de columnas */
    table-layout: fixed;
}


/* --- Encabezado de la Tabla --- */
.accordion .accordion-body .table.tabla-planificacion thead th {
    background-color: #E6F4EA; /* Fondo verde pistacho claro */
    color: #388E3C; /* Texto verde especificado */
    /* Sin bordes laterales, solo inferior */
    border: none;
    border-bottom: 2px solid #C8E6C9;
    padding: 0.75rem 0.5rem;
    /* Alineación por defecto: centrada */
    text-align: center;
    font-weight: 600;
    /* Centrado vertical */
    vertical-align: middle;
    height: 45px;
    box-sizing: border-box;
	border-radius= 10px;
    white-space: nowrap;
    /* Evitar selección de texto */
    user-select: none;
}

/* Alinear a la izquierda columnas específicas en el encabezado */
.accordion .accordion-body .table.tabla-planificacion thead th:first-child, /* Día */
.accordion .accordion-body .table.tabla-planificacion thead th:nth-child(7), /* Peso Estimado */
.accordion .accordion-body .table.tabla-planificacion thead th:last-child /* Notas */ {
    text-align: left;
}


/* --- Cuerpo de la Tabla --- */
.accordion .accordion-body .table.tabla-planificacion tbody td {
    padding: 0.75rem 0.5rem;
    /* Centrado vertical */
    vertical-align: middle;
    /* Sin bordes laterales, solo inferior */
    border: none;
	border-radius= 8px;
    border-bottom: 1px solid #e0e0e0;
    /* Alineación por defecto: centrada */
    text-align: center;
    /* Altura fija para consistencia */
    height: 55px;
    box-sizing: border-box;
    white-space: normal;
    line-height: 1.3;
    /* Manejo de desbordamiento */
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Última fila sin borde inferior */
.accordion .accordion-body .table.tabla-planificacion tbody tr:last-child td {
    border-bottom: none;
}

/* Alinear a la izquierda columnas específicas en las celdas */
.accordion .accordion-body .table.tabla-planificacion tbody td:first-child, /* Día */
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(7), /* Peso Estimado */
.accordion .accordion-body .table.tabla-planificacion tbody td:last-child /* Notas */ {
    text-align: left;
}

/* Alinear a la derecha la columna de Kcal/dia */
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(3) {
    text-align: right;
}


/* --- Filas Alternadas y Efecto Hover --- */
/* Fila par */
.accordion .accordion-body .table.tabla-planificacion tbody tr:nth-child(even) {
    background-color: #f5f5f5;
}

/* Filas impar */
.accordion .accordion-body .table.tabla-planificacion tbody tr:nth-child(odd) {
    background-color: #ffffff;
}

/* Efecto Hover - Aplicado a todas las filas */
.accordion .accordion-body .table.tabla-planificacion tbody tr:hover {
    /* Fondo verde claro y suave al hacer hover */
    background-color: #e8f5e8 !important;
    /* Transición suave para el efecto */
    transition: background-color 0.2s ease-in-out;
    /* Cambiar cursor para indicar interactividad */
    cursor: pointer;
}


/* --- Contenido Centrado en Celdas .text-center --- */
/* Este bloque asegura el centrado horizontal y vertical óptimo */
.accordion .accordion-body .table.tabla-planificacion tbody td.text-center {
    text-align: center !important;
    /* Clave para centrado vertical */
    vertical-align: middle !important;
    padding: 0.5rem !important;
    box-sizing: border-box !important;
    margin: 0 !important;
    /* Reafirmar display por si acaso */
    display: table-cell !important;	
}

/* Estilos para elementos hijos dentro de .text-center */
.accordion .accordion-body .table.tabla-planificacion tbody td.text-center > * {
    display: table-cell;
    margin: 0 auto;
}

.accordion .accordion-body .table.tabla-planificacion tbody td.text-center strong,
.accordion .accordion-body .table.tabla-planificacion tbody td.text-center small {
    display: table-cell;
    margin: 0;
    padding: 0;
    line-height: 1.2; /* Opcional para control fino */
}

.accordion .accordion-body .table.tabla-planificacion tbody td.text-center strong {
    font-weight: 600;
}

.accordion .accordion-body .table.tabla-planificacion tbody td.text-center small {
    font-size: 0.8em;
    color: #6c757d;
}


/* --- Elementos Específicos dentro de las Celdas --- */
/* Selects de Actividad */
.accordion .accordion-body .form-select.form-select-sm {
    height: 32px !important;
    padding: 0.25rem 0.5rem !important;
    font-size: 0.8rem !important;
    text-align: center !important;
    border: 1px solid #ccc !important;
    border-radius: 4px !important;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05) !important;
    width: 100% !important;
    box-sizing: border-box !important;
    /* Resetear apariencia para consistencia cross-browser */
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.5rem center;
    background-size: 16px;
}

/* Inputs de Estrategias */
.accordion .accordion-body .form-control.form-control-sm {
    height: 32px !important;
    padding: 0.25rem 0.5rem !important;
    font-size: 0.8rem !important;
    border: 1px solid #ccc !important;
    border-radius: 4px !important;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05) !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

/* Texto pequeño (Notas y texto de ayuda) */
.accordion .accordion-body .small,
.accordion .accordion-body .form-text.text-muted {
    font-size: 0.75rem !important;
    line-height: 1.2 !important;
    display: table-cell;
 /* Asegurar comportamiento de bloque */
}

.accordion .accordion-body .form-text.text-muted {
    color: #6c757d !important;
    margin-top: 0.25rem !important;
}


/* --- Ajustes de Ancho de Columnas Específicas --- */
/* Basado en la estructura: Día(1), Actividad(2), Kcal/dia(3), % Pt(4), % CH(5), % GR(6), Peso Estimado(7), Estrategias(8), Notas(9) */

/* Columna 1: Día */
.accordion .accordion-body .table.tabla-planificacion thead th:nth-child(1),
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(1) {
    width: 100px !important;
    min-width: 90px !important;
    text-align: left !important;
}

/* Columna 2: Actividad */
.accordion .accordion-body .table.tabla-planificacion thead th:nth-child(2),
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(2) {
    width: 180px !important;
    min-width: 160px !important;
    text-align: left !important;
}

/* Columna 3: Kcal/dia */
.accordion .accordion-body .table.tabla-planificacion thead th:nth-child(3),
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(3) {
    width: 90px !important;
    min-width: 80px !important;
    text-align: right !important; /* Alinear a la derecha */
}

/* Columnas 4 y 5: % Pt y % CH */
.accordion .accordion-body .table.tabla-planificacion thead th:nth-child(4),
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(4),
.accordion .accordion-body .table.tabla-planificacion thead th:nth-child(5),
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(5) {
    width: 100px !important;
    min-width: 90px !important;
    text-align: center !important;
}

/* Columna 6: % GR (g/día) - Más estrecha */
.accordion .accordion-body .table.tabla-planificacion thead th:nth-child(6),
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(6) {
    width: 90px !important;
    min-width: 80px !important;
    max-width: 110px !important;
    text-align: center !important;
}

/* Columna 7: Peso Estimado (kg) - Más estrecha */
.accordion .accordion-body .table.tabla-planificacion thead th:nth-child(7),
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(7) {
    width: 100px !important;
    min-width: 90px !important;
    max-width: 120px !important;
    text-align: center !important;
}

/* Columna 8: Estrategias - Más ancha */
.accordion .accordion-body .table.tabla-planificacion thead th:nth-child(8),
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(8) {
    width: 180px !important;
    min-width: 200px !important;
    text-align: left !important;
    white-space: normal !important;
}

/* Columna 9: Notas - Un poco más ancha */
.accordion .accordion-body .table.tabla-planificacion thead th:nth-child(9),
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(9) {
    width: 180px !important;
    min-width: 180px !important;
    text-align: left !important;
    white-space: normal !important;
    /* Eliminar cualquier borde o padding que pueda crear una apariencia de separación */
    border: none !important;
    padding: 0.75rem 0.5rem !important; /* Usa el padding de la tabla */
    background-color: transparent !important;
    /* Asegurar que no haya box-shadow o border-bottom */
    box-shadow: none !important;
    border-bottom: none !important;
}

/* Texto pequeño (Notas y texto de ayuda) */
.accordion .accordion-body .small,
.accordion .accordion-body .form-text.text-muted {
    font-size: 0.75rem !important;
    line-height: 1.2 !important;
        display: table-cell;/* Asegurar comportamiento de bloque */

    margin: 0 !important; /* Eliminar margen */
    padding: 0 !important; /* Eliminar padding */
    overflow: hidden; /* Evita desbordamiento */
    text-overflow: ellipsis; /* Muestra puntos suspensivos si es necesario */
}


/* --- Añadir Scroll Vertical a los Acordeones con Tablas --- */
/* Apuntar al contenedor .accordion-body que contiene la tabla */
.accordion .accordion-collapse.collapse .accordion-body {
    /* Altura máxima para permitir scroll si el contenido es largo */
    /* Ajusta este valor según la cantidad de filas esperadas */
    max-height: 600px;
    overflow-y: auto; /* Muestra la barra de scroll vertical cuando sea necesario */
    padding: 0.5rem; /* Espaciado interno */
}

/* Opcional: Estiliza la barra de scroll para navegadores Webkit (Chrome, Safari, Edge) */
.accordion .accordion-collapse.collapse .accordion-body::-webkit-scrollbar {
    width: 8px;
}

.accordion .accordion-collapse.collapse .accordion-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.accordion .accordion-collapse.collapse .accordion-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.accordion .accordion-collapse.collapse .accordion-body::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Asegurar que la tabla en sí no tenga márgenes que puedan afectar el cálculo de altura */
.accordion .accordion-collapse.collapse .accordion-body .table.tabla-planificacion {
    margin-bottom: 0;
}

/* --- Corrección de Espaciado y Flujo para Contenido de Celdas en Tablas de Acordeones --- */

/* --- Asegurar estilos base sólidos para todas las celdas del tbody --- */
.accordion .accordion-body .table.tabla-planificacion tbody td {
    /* Reafirmar estilos base importantes */
    height: 55px !important;
    box-sizing: border-box !important;
    padding: 0.75rem 0.5rem !important;
    vertical-align: middle !important;
    border: none !important;
    /* border-bottom: 1px solid #e0e0e0 !important; */
    
    /* Asegurar que el contenido se comporte bien dentro del tamaño fijo */
    position: relative; /* Establecer contexto de posicionamiento */
    overflow: hidden;   /* Ocultar cualquier desbordamiento */
    text-overflow: ellipsis; /* Mostrar puntos suspensivos si es necesario */
    white-space: normal; /* Permitir wrap de texto */
    line-height: 1.3 !important;
}

/* --- Estilos específicos para celdas que contienen texto simple (como la columna "Notas") --- */
.accordion .accordion-body .table.tabla-planificacion tbody td.small {
    /* Hereda todos los estilos base de tbody td */
    /* Asegurar que el texto se comporte como un bloque dentro de la celda */
        display: table-cell; /* O 'table-cell' si se necesita alineación vertical más precisa */

    width: 100%;
    height: 100%; /* Ocupar toda la altura de la celda padre */
    margin: 0; /* Resetear margen */
    padding: 0; /* Resetear padding (el padding lo maneja el <td> padre) */
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.3; /* Consistencia */
}

/* --- Estilos para texto de ayuda (.form-text.text-muted) en celdas con inputs --- */
.accordion .accordion-body .table.tabla-planificacion tbody td .form-text.text-muted {
    /* Estilos base para el texto de ayuda */
        display: table-cell;
 /* Hacer que ocupe toda la línea */
    width: 100%; /* Ocupar todo el ancho de la celda */
    font-size: 0.75rem !important;
    line-height: 1.2 !important;
    color: #6c757d !important;
    margin: 0 !important; /* Resetear margen para evitar empuje */
    /* Padding vertical pequeño para separación visual del input */
    padding: 0.25rem 0 0 0 !important; 
    box-sizing: border-box;
    /* Asegurar que no se desborde */
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: normal;
}

/* --- Ajustes específicos para celdas de la columna "Estrategias" --- */
/* Estas celdas contienen input + .form-text.text-muted */
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(8) {
    /* Alinear contenido a la izquierda */
    text-align: left !important;
    /* Asegurar altura suficiente o manejo de contenido */
    height: auto !important; /* Permitir que se adapte si el contenido es mayor */
    white-space: normal !important;
    /* O manejar el desbordamiento */
    /* overflow: visible; */ /* Si se quiere mostrar todo el contenido */
}

/* --- Ajustes específicos para celdas de la columna "Notas" --- */
.accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(9) {
    /* Alinear contenido a la izquierda */
    text-align: left !important;
    /* Asegurar que el texto se comporte bien */
    white-space: normal !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

/* --- Asegurar que los inputs dentro de las celdas no causen problemas --- */
.accordion .accordion-body .table.tabla-planificacion tbody td .form-control.form-control-sm {
    /* Reafirmar estilos de input */
    width: 100% !important;
    box-sizing: border-box !important;
    margin: 0 !important; /* Resetear margen */
    /* Asegurar que el input no sea más alto que el espacio disponible */
    /* Si la celda es de 55px y el texto de ayuda ~20px, input ~32px */
    height: 32px !important; 
}
/* --- Responsive --- */
@media (max-width: 768px) {
    /* Reducir tamaño de fuente general */
    .accordion .accordion-body .table.tabla-planificacion {
        font-size: 0.7rem;
    }

    /* Ajustar padding y altura de celdas */
    .accordion .accordion-body .table.tabla-planificacion thead th,
    .accordion .accordion-body .table.tabla-planificacion tbody td {
        padding: 0.4rem 0.25rem;
        height: 40px;
    }

    .accordion .accordion-body .table.tabla-planificacion thead th {
        height: 40px;
    }

    /* Ajustar tamaño de elementos de formulario */
    .accordion .accordion-body .form-select.form-select-sm,
    .accordion .accordion-body .form-control.form-control-sm {
        height: 28px !important;
        font-size: 0.7rem !important;
        padding: 0.15rem 0.3rem !important;
    }

    /* Ajustar texto pequeño */
    .accordion .accordion-body .small,
    .accordion .accordion-body .form-text.text-muted {
        font-size: 0.65rem !important;
    }

    /* Ajustar anchos de columnas críticas para móviles */
    .accordion .accordion-body .table.tabla-planificacion thead th:nth-child(1),
    .accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(1) { /* Día */
        width: 80px !important;
        min-width: 70px !important;
    }

    .accordion .accordion-body .table.tabla-planificacion thead th:nth-child(2),
    .accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(2) { /* Actividad */
        width: 140px !important;
        min-width: 120px !important;
    }

    .accordion .accordion-body .table.tabla-planificacion thead th:nth-child(8),
    .accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(8) { /* Estrategias */
        min-width: 150px !important;
        /* En móvil, permitir wrap si es necesario */
        white-space: normal !important;
    }

    .accordion .accordion-body .table.tabla-planificacion thead th:nth-child(9),
    .accordion .accordion-body .table.tabla-planificacion tbody td:nth-child(9) { /* Notas */
        min-width: 140px !important;
    }

    /* Asegurar que el scroll horizontal funcione si table-layout fixed hace que algo se corte */
    .accordion .accordion-body .table-responsive.tabla-planificacion-wrapper {
        overflow-x: auto;
    }
}
/* --- 10. Mensajes --- */
.info-message {
    padding: 12px 20px;
    margin: 15px 0;
    border-radius: 4px;
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}
.alert {
    position: relative;
    padding: 1rem 1rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
    border-radius: 0.375rem;
}
.alert-info {
    color: #055160;
    background-color: #cff4fc;
    border-color: #b6effb;
}
.alert-danger {
    color: #842029;
    background-color: #f8d7da;
    border-color: #f5c2c7;
}
.error-message, #errorMessage {
    display: none;
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c2c7;
    padding: 10px;
    border-radius: 4px;
    margin: 10px 0;
}
/* --- 11. Elementos Específicos --- */
.percentage-bar-container {
    width: 100%;
    height: 20px;
    background-color: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0;
}
.percentage-fill {
    height: 100%;
    border-radius: 4px;
}
.fat-fill { background-color: #4CAF50; }
.protein-fill { background-color: #2196F3; }
.carb-fill { background-color: #FF9800; }
.fase-container {
    background-color: #e8f5e9;
    border-left: 4px solid #4CAF50;
    padding: 15px;
    margin: 20px 0;
    border-radius: 0 8px 8px 0;
}
.fase-container h4 {
    color: #2E7D32;
    margin-top: 0;
}
/* Labels de los selects de fase */
#labelFasePerdida1, #labelFaseGanancia1, #labelEnfoqueMantenimiento1, #labelFaseMixto1 {
    display: none;
    font-weight: bold;
    color: #2E7D32;
    margin: 15px 0 5px 0;
    font-size: 16px;
}
/* --- 12. Sección de Resultados --- */
#resultados .row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -15px;
}
#resultados .col-md-6 {
    flex: 0 0 50%;
    max-width: 50%;
    padding: 0 15px;
}
#resultados canvas {
    width: 100% !important;
    height: auto !important;
}
/* --- 13. Sección de Ciclos Diéteticos --- */
.notes-section {
    background-color: #fff3e0;
    border-left: 4px solid #ff9800;
    padding: 15px;
    margin: 15px 0;
    border-radius: 0 8px 8px 0;
}
.notes-section h4 {
    color: #ef6c00;
    margin-top: 0;
}
.notes-section ul {
    padding-left: 20px;
}
.notes-section li {
    margin: 8px 0;
    line-height: 1.5;
}




/* --- 14. Media Queries para Responsividad --- */
@media (max-width: 992px) {
    main {
        padding: 0 10px;
        margin: 10px auto;
        padding-top: 80px;
    }
    .plan-step {
        padding: 20px 15px;
    }
    header {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
    }
    nav ul {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
    }
    nav ul li {
        margin: 5px 10px;
    }
    nav ul li a {
        padding: 6px 10px;
        font-size: 0.9rem;
    }
    .logo a {
        font-size: 1.3rem;
    }
    #resultados .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}
@media (max-width: 768px) {
    body {
        font-size: 0.85rem;
    }
    h1 {
        font-size: 1.5rem;
    }
    h2 {
        font-size: 1.3rem;
    }
    .plan-step {
        padding: 15px 10px;
    }
    .card-body {
        padding: 1rem;
    }
    .table th,
    .table td {
        padding: 0.4rem 0.5rem;
        font-size: 0.8rem;
    }
    #save-pdf-button {
        padding: 10px 20px;
        font-size: 0.9rem;
    }
    button, .btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.85rem;
    }
    .btn-sm {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
    }
    .strategy-checkboxes {
        max-height: 250px;
    }
    .chart-container, #chart-container, #weight-chart-container, #time-estimation-chart-container, #macroChart, #weightEvolutionChart, #timeEstimationChart {
        height: 300px;
    }
    footer {
        padding: 15px;
        font-size: 0.8rem;
    }
    .btn-lg {
        padding: 0.4rem 0.8rem;
        font-size: 1rem;
    }
    .table.tabla-planificacion {
        font-size: 0.75rem;
    }
    .table.tabla-planificacion thead th,
    .table.tabla-planificacion tbody td {
        padding: 0.3rem 0.4rem;
    }
    .badge {
        font-size: 0.65em;
        padding: 0.25em 0.5em;
    }
}
@media (max-width: 576px) {
    header {
        flex-direction: column;
        align-items: flex-start;
    }
    nav ul {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
    }
    nav ul li {
        margin: 5px 0;
        width: 100%;
    }
    nav ul li a {
        display: block;
        padding: 10px;
        border-radius: 0;
        border-bottom: 1px solid #e0e0e0;
    }
    main {
        padding-top: 70px;
    }
    .percentage-bar-container {
        height: 15px;
    }
    #macro-percentage-total, #meal-percentage-total {
        font-size: 0.8rem;
    }
}
/* --- 15. Correcciones y Mejoras Visuales --- */
#macro-percentage-total.valid, #meal-percentage-total.valid {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
#macro-percentage-total.invalid, #meal-percentage-total.invalid {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c2c7;
}
/* Asegurar que los inputs de número tengan un ancho razonable */
.input-macro-manual {
    width: 100px;
}
/* Estilos para el botón de cerrar si no usas Bootstrap */
/*.btn-close::before {
    content: '×';
    color: black;
}*/
/* FIX: Estilos añadidos para mejorar la UI */
#recipeTable input.edit-grams {
    text-align: right;
    width: 80px;
}
#weeklyPlanTable ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
}
#weeklyPlanTable li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 4px;
}
#weeklyPlanTable li button {
    padding: 2px 6px;
    font-size: 0.8em;
}
/* Loading spinner */
.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #4CAF50;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
    display: none;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
/* Animación de fade in */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
/* Cuando se muestran los selects */
#fasePerdida1[style*="block"],
#faseGanancia1[style*="block"],
#enfoqueMantenimiento1[style*="block"],
#faseMixto1[style*="block"] {
    display: block !important;
    animation: fadeIn 0.3s ease-in;
}
#labelFasePerdida1[style*="block"],
#labelFaseGanancia1[style*="block"],
#labelEnfoqueMantenimiento1[style*="block"],
#labelFaseMixto1[style*="block"] {
    display: block !important;
    animation: fadeIn 0.3s ease-in;
}

/* --- 16. Sección de Ciclos y Breaks (Automática) --- */
#step-5-results, #hyperprotein-cycle-table-container {
    margin-top: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 5px;
}
#hyperprotein-cycle-table {
    width: 100%;
    margin-top: 15px;
    border-collapse: collapse;
}
#hyperprotein-cycle-table th,
#hyperprotein-cycle-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
#hyperprotein-cycle-table th {
    background-color: #e9ecef;
    font-weight: bold;
    text-align: center;
}
#hyperprotein-cycle-table tr:nth-child(even) {
    background-color: #f2f2f2;
}
#hyperprotein-cycle-table tr:hover {
    background-color: #ddd;
}
/* --- 17. Pie de Página --- */
footer {
    text-align: center;
    padding: 20px;
    background-color: #f1f3f5;
    color: #6c757d;
    border-top: 1px solid #e0e0e0;
    margin-top: 40px;
    font-size: 0.9rem;
}
/* --- Forzar color verde unificado para todos los encabezados --- */
h1, h2, h3, h4 {
    color: #388E3C !important; /* El !important fuerza la aplicación */
}
.plan-step h2,
.plan-step h3,
.plan-step h4 {
    color: #388E3C;
    /* Asegúrate de que estos no tengan !important en sus otras propiedades
       que quieras mantener, como margin o font-weight */
}

/* --- 1. Tabla General del Proceso --- */
#tablaGeneralProcesoContainer .card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid #d4edda; /* Borde verde claro */
    border-radius: 8px;
}

#tablaGeneralProcesoContainer .card-header {
    background-color: #e6f4ea; /* Verde pistacho claro */
    border-bottom: 1px solid #c8e6c9; /* Borde inferior verde más oscuro */
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #2e7d32; /* Texto verde oscuro */
}

#tablaGeneralProcesoContainer .table.tabla-planificacion {
    width: 100%;
    margin-bottom: 0;
    border-collapse: collapse;
    font-size: 0.9rem;
    color: #212529;
}

#tablaGeneralProcesoContainer .table.tabla-planificacion thead th {
    background-color: #e6f4ea; /* Fondo verde pistacho claro */
    color: #2e7d32; /* Texto verde oscuro */
    border-bottom: 2px solid #c8e6c9; /* Borde inferior más grueso */
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
	border-radius: 10px;
}

#tablaGeneralProcesoContainer .table.tabla-planificacion tbody tr:nth-child(even) {
    background-color: #f1f8e9; /* Fondo verde muy claro para filas pares */
}

#tablaGeneralProcesoContainer .table.tabla-planificacion tbody tr:hover {
    background-color: #e6f4ea; /* Fondo verde pistacho claro al pasar el ratón */
}

#tablaGeneralProcesoContainer .table.tabla-planificacion td {
    padding: 0.75rem;
    vertical-align: middle;
    border-top: 1px solid #dee2e6;
}

/* --- 2. Tabla Específica (Planificación Temporal) --- */

/* --- 2. Tabla Específica (Planificación Temporal) - Estilo Unificado --- */

#planificacionTemporal.card {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 0.1px solid #4CAF50;
    border-radius: 10px;
    background-color: #f1f8e9;
}

#planificacionTemporal .card-header {
    background-color: #F8F9FA; /* Fondo gris claro */
    color: #388E3C; /* Verde especificado */
    border-bottom: 1px solid #c8e6c9;
    padding: 1rem 1.25rem;
    font-weight: 600;
    text-align: left;
    border-radius: 10px 10px 0 0; /* Border radius solo en la parte superior */
}

#planificacionTemporal .card-body {
    padding: 1rem;
}

#planificacionTemporal .table-responsive {
    overflow-x: auto;
    border-radius: 0 0 10px 10px;
}

/* Tabla principal */
#planificacionTemporal .table {
    width: 100%;
    margin-bottom: 0;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.875rem;
    color: #212529;
    table-layout: fixed;
    background-color: white;
    border-radius: 10px;
    overflow: hidden;
}

/* Encabezado de tabla */
#planificacionTemporal .table thead tr {
    background-color: #E6F4EA !important;
}

#planificacionTemporal .table thead th {
    background-color: #E6F4EA !important;
    color: #388E3C !important;
    border: none !important;
    padding: 0.75rem 0.5rem !important;
    text-align: left !important;
    font-weight: 600 !important;
    vertical-align: middle !important;
    height: 50px !important;
    box-sizing: border-box !important;
    white-space: nowrap !important;
}

/* Sin bordes entre celdas */
#planificacionTemporal .table td {
    border: none !important;
    border-bottom: 1px solid #e0e0e0 !important;
}

#planificacionTemporal .table tr:last-child td {
    border-bottom: none !important;
}

/* Filas alternadas con colores distintos */
#planificacionTemporal .table tbody tr:nth-child(even) {
    background-color: #f5f5f5 !important; /* Gris claro */
}

#planificacionTemporal .table tbody tr:nth-child(odd) {
    background-color: #ffffff !important; /* Blanco */
}

#planificacionTemporal .table tbody tr:hover {
    background-color: #e8f5e8 !important; /* Verde claro al hacer hover */
    cursor: pointer;
}

/* Celdas comunes */
#planificacionTemporal .table tbody td {
    padding: 0.75rem 0.5rem !important;
    vertical-align: middle !important;
    text-align: center !important;
    height: 65px !important;
    box-sizing: border-box !important;
    white-space: normal !important;
    line-height: 1.4 !important;
}

/* Primera y última columna más anchas */
#planificacionTemporal .table tbody td:first-child,
#planificacionTemporal .table thead th:first-child {
    width: 120px !important;
}

#planificacionTemporal .table tbody td:last-child,
#planificacionTemporal .table thead th:last-child {
    width: 200px !important;
    text-align: left !important;
}

/* Ajustes específicos por columna */
#planificacionTemporal .table tbody td:first-child {
    font-weight: 600 !important;
    color: #388E3C !important;
    text-align: left !important;
}
/* Ajustar primera columna (Semana) más ancha */
#planificacionTemporal .table tbody td:first-child,
#planificacionTemporal .table thead th:first-child {
    width: 80px !important;
    min-width: 120px !important;
}

/* Ajustar segunda columna (Fase) menos ancha */
#planificacionTemporal .table tbody td:nth-child(2),
#planificacionTemporal .table thead th:nth-child(2) {
    width: 120px !important;
    min-width: 100px !important;
    max-width: 140px !important;
}

/* Ajustar tercera columna (Estrategias) al contenido */
#planificacionTemporal .table tbody td:nth-child(3),
#planificacionTemporal .table thead th:nth-child(3) {
    width: fit-content !important;
    min-width: 80px !important;
    max-width: 150px !important;
}
/* Inputs y selects estilizados */
#planificacionTemporal .form-control {
    height: 36px !important;
    padding: 0.25rem 0.5rem !important;
    font-size: 0.875rem !important;
    text-align: center !important;
    border: 1px solid #ccc !important;
    border-radius: 4px !important;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1) !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

#planificacionTemporal .macro-input {
    max-width: 80px !important;
    margin: 0 auto !important;
    display: block !important;
}

#planificacionTemporal select.form-control {
    height: 36px !important;
    padding: 0.25rem 0.5rem !important;
}

/* Badges con estilo moderno */
#planificacionTemporal .badge {
    font-size: 0.75rem !important;
    padding: 0.25em 0.5em !important;
    margin: 0.25em !important;
    border-radius: 4px !important;
    font-weight: normal !important;
    display: inline-block !important;
}

#planificacionTemporal .badge.bg-danger {
    background-color: #dc3545 !important;
    color: white !important;
}

#planificacionTemporal .badge.bg-secondary {
    background-color: #6c757d !important;
    color: white !important;
}

/* Estrategias con iconos */
#planificacionTemporal .strategy-note {
    text-align: left !important;
    white-space: normal !important;
    line-height: 1.4 !important;
    font-size: 0.8rem !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* Mensajes de error */
#planificacionTemporal .alert {
    margin: 5px 0 0 0 !important;
    padding: 0.5rem !important;
    font-size: 0.75rem !important;
    text-align: center !important;
}

/* Responsive */
@media (max-width: 768px) {
    #planificacionTemporal .table {
        font-size: 0.75rem !important;
    }
    
    #planificacionTemporal .table thead th,
    #planificacionTemporal .table tbody td {
        padding: 0.4rem  !important;
        height: 45px !important;
    }
   
   
   
    #planificacionTemporal .table tbody td:first-child,
    #planificacionTemporal .table thead th:first-child {
        width: 100px !important;
    }
    
    #planificacionTemporal .table tbody td:last-child,
    #planificacionTemporal .table thead th:last-child {
        width: 150px !important;
    }
    
    #planificacionTemporal .form-control {
        height: 32px !important;
        font-size: 0.75rem !important;
        padding: 0.15rem 0.3rem !important;
    }
    
    #planificacionTemporal .macro-input {
        max-width: 60px !important;
        height: 32px !important;
        font-size: 0.75rem !important;
    }
    
    #planificacionTemporal .badge {
        font-size: 0.65rem !important;
        padding: 0.2em 0.3em !important;
        margin: 0.1em !important;
    }
}

/* --- 3. Tabla Detallada de Fase --- */
/* Styling for all table containers: hyperprotein-cycle-table, tablaPlanificacionBody, and tablaDetalladaFaseContainer */
#hyperprotein-cycle-table-container,
#tablaPlanificacionBody-container,
#tablaDetalladaFaseContainer {
    margin-top: 20px;
    overflow-x: auto; /* Allow horizontal scroll on small screens */
}

/* Styling for card in tablaDetalladaFaseContainer */
#tablaDetalladaFaseContainer .card.tabla-planificacion {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    border: 1px solid #c8e6c9; /* Match table border color */
    border-radius: 10px;
    background-color: #fff; /* White background to match table container */
}

#tablaDetalladaFaseContainer .card-header {
    background-color: #dcedc8; /* Match table header background */
    border-bottom: 0.4px solid #c8e6c9; /* Match table border */
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #1B5E20; /* Match table header text */
}

/* Styling for all tables */
#hyperprotein-cycle-table,
#tablaPlanificacionBody,

#accordionMeses table {
    width: 90%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.9em;
    min-width: 600px; /* Minimum width before scroll appears */
	white-space: nowrap !important;
}

#hyperprotein-cycle-table th,
#hyperprotein-cycle-table td,
#tablaPlanificacionBody th,
#tablaPlanificacionBody td,


#hyperprotein-cycle-table th,
#tablaPlanificacionBody th,
#tablaDetalladaFaseContainer .table.tabla-planificacion th,


#hyperprotein-cycle-table tr:nth-child(even),
#tablaPlanificacionBody tr:nth-child(even),
#tablaDetalladaFaseContainer .table.tabla-planificacion tr:nth-child(even),
#accordionMeses table tr:nth-child(even) {
    background-color: #f1f8e9; /* Light green for even rows */
}

#hyperprotein-cycle-table tr:hover,
#tablaPlanificacionBody tr:hover,


#hyperprotein-cycle-table td,
#tablaPlanificacionBody td,

#hyperprotein-cycle-table td:nth-child(2), /* Fase */
#hyperprotein-cycle-table td:nth-child(7), /* Notas */
#tablaPlanificacionBody td:nth-child(2), /* Fase */
#tablaPlanificacionBody td:nth-child(7), /* Notas */


#hyperprotein-cycle-table .phase-hyperprotein,
#tablaPlanificacionBody .phase-hyperprotein,


#hyperprotein-cycle-table .phase-break,
#tablaPlanificacionBody .phase-break,


#hyperprotein-cycle-table th:nth-child(6),
#hyperprotein-cycle-table td:nth-child(6),
#tablaPlanificacionBody th:nth-child(6),
#tablaPlanificacionBody td:nth-child(6),

/* Accordion styles for accordionMeses */
#accordionMeses .accordion-item {
    border: 1px solid #c8e6c9; /* Match table border */
    margin-bottom: 10px;
    border-radius: 10px;
}

#accordionMeses .accordion-header {
    background-color: #dcedc8; /* Match table header background */
    color: #1B5E20; /* Match table header text */
    font-weight: 600;
	    border-radius: 10px;
}

#accordionMeses .accordion-button {
    padding: 8px 10px;
    font-size: 0.9em;
    color: #1B5E20;
    background-color: #dcedc8;
}

#accordionMeses .accordion-button:not(.collapsed) {
    background-color: #c8e6c9; /* Slightly darker when expanded */
    color: #1B5E20;
}

#accordionMeses .accordion-body {
    padding: 10px;
    background-color: #f1f8e9; /* Match table even-row background */
}


.accordion-button {
    background-color: #e8f5e9;
    color: #2e7d32;
}
.accordion-button:not(.collapsed) {
    background-color: #c8e6c9;
    color: #1b5e20;
}
.tabla-planificacion-wrapper {
    max-height: 400px;
    overflow-y: auto;
}
.tabla-planificacion th, .tabla-planificacion td {
    font-size: 0.9rem;
    vertical-align: middle;
}
.form-select-sm {
    font-size: 0.85rem;
}
.error-message {
    color: #dc3545;
    font-weight: bold;
}



/* --- 4. Tabla de Ciclos Hiperproteicos (Manual) --- */

/* Contenedores - Centrados */
#hyperprotein-cycle-table-container,
#detailed-cycle-table-container {
    margin: 20px auto; /* Centra el contenedor */
    overflow-x: auto;
    text-align: center; /* Centra contenido inline-block */
}

/* Tablas - Centradas con bordes redondeados */
#hyperprotein-cycle-table,
#detailed-cycle-table {
    width: 90%;
    max-width: 1200px; /* Límite máximo de ancho */
    border-collapse: separate; /* Necesario para border-radius */
    border-spacing: 0; /* Elimina espacios entre celdas */
    margin: 10px auto; /* Centra la tabla */
    font-size: 0.9em;
    min-width: 600px;
    table-layout: auto;
    border-radius: 12px; /* Bordes redondeados de toda la tabla */
    overflow: hidden; /* Para que los bordes redondeados se apliquen correctamente */
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Sombra suave opcional */
}

/* Encabezados con bordes redondeados */
#hyperprotein-cycle-table thead th:first-child,
#detailed-cycle-table thead th:first-child {
    border-top-left-radius: 12px; /* Redondea esquina superior izquierda */
}

#hyperprotein-cycle-table thead th:last-child,
#detailed-cycle-table thead th:last-child {
    border-top-right-radius: 12px; /* Redondea esquina superior derecha */
}

/* Celdas con bordes y transiciones */
#hyperprotein-cycle-table th, #hyperprotein-cycle-table td,
#detailed-cycle-table th, #detailed-cycle-table td {
    border: 1px solid #c8e6c9;
    border-width: 0 1px 1px 0; /* Solo bordes internos */
    padding: 12px 10px;
    text-align: center;
    vertical-align: middle;
    transition: background-color 0.2s ease-in-out;
}

/* Elimina bordes derechos de la última columna */
#hyperprotein-cycle-table th:last-child,
#hyperprotein-cycle-table td:last-child,
#detailed-cycle-table th:last-child,
#detailed-cycle-table td:last-child {
    border-right: none;
}

/* Elimina bordes inferiores de la última fila */
#hyperprotein-cycle-table tbody tr:last-child td,
#detailed-cycle-table tbody tr:last-child td {
    border-bottom: none;
}

/* Encabezados */
#hyperprotein-cycle-table th,
#detailed-cycle-table th {
    background-color: #dcedc8;
    color: #1B5E20;
    font-weight: 600;
    white-space: nowrap;
    position: sticky; /* Opcional: fijar encabezados al hacer scroll */
}

/* Filas pares */
#hyperprotein-cycle-table tr:nth-child(even),
#detailed-cycle-table tr:nth-child(even) {
    background-color: #f1f8e9;
}

/* Hover en filas */
#hyperprotein-cycle-table tbody tr:hover,
#detailed-cycle-table tbody tr:hover {
    background-color: #e8f5e9 !important;
    cursor: pointer;
}

/* Color de texto en celdas */
#hyperprotein-cycle-table td,
#detailed-cycle-table td {
    color: #333;
}

/* Alineación izquierda para Fase y Notas */
#hyperprotein-cycle-table td:nth-child(2), /* Fase */
#hyperprotein-cycle-table td:nth-child(7), /* Notas */
#detailed-cycle-table td:nth-child(2),      /* Fase */
#detailed-cycle-table td:nth-child(7) {     /* Notas */
    text-align: left;
}

/* Estilos específicos por fase */
#hyperprotein-cycle-table .phase-hyperprotein,
#detailed-cycle-table .phase-hyperprotein {
    color: #0275d8; /* Azul para fase hiperproteica */
}

#hyperprotein-cycle-table .phase-break,
#detailed-cycle-table .phase-break {
    background-color: #fff9c4; /* Amarillo claro para descanso */
    color: #5f4300;
}

/* Columna de Notas más ancha */
#hyperprotein-cycle-table th:nth-child(6),
#hyperprotein-cycle-table td:nth-child(6),
#detailed-cycle-table th:nth-child(6),
#detailed-cycle-table td:nth-child(6) {
    width: 200px;
    min-width: 200px;
    white-space: pre-line;
    vertical-align: top;
    line-height: 1.5;
}
/* --- 2. Tabla Específica (Planificación Temporal) --- */

.text-with-icon {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .text-with-icon p {
            margin-bottom: 0;
            margin-right: 8px;
        }
        .target-icon {
            color: #e63946;
            font-size: 1.4rem;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        .target-icon:hover {
            color: #d00000;
            transform: scale(1.2);
        }
        .info-box {
            background-color: #e8f5e9;
            border-left: 4px solid #49bd3e;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 15px;
            font-size: 16px;
        }
        .info-box a {
            color: #305df0;
            text-decoration: none;
        }
        .info-box a:hover {
            text-decoration: underline;
        }
        .form-label {
            font-weight: 600;
            color: #097a18;
            margin-top: 10px;
        }
        .form-select, .form-control {
            border-radius: 8px;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            transition: all 0.3s;
        }
        .form-select:focus, .form-control:focus {
            border-color: #4fe357;
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }
        .modal-content {
            border-radius: 12px;
            border: none;
        }
        .modal-header {
            background-color: #156108;
            color: #ffffff;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .btn-close {
            filter: invert(1);
        }
        .modal-body {
            padding: 20px;
        }
        .modal-body p {
            margin-bottom: 15px;
        }
		.modal-xl {
    max-width: 1100px; /* Adjust to a wider width if needed */
}
.modal-body {
    padding: 20px;
    overflow-x: auto; /* Ensures horizontal scrolling if table exceeds width */
}
.table {
    width: 100%; /* Ensures table takes full available width */
    min-width: 1200px; /* Minimum width to prevent collapse */
}
#recommendationResultDiv {
    background-color: #d8f3dc; /* Verde pastel suave (similar a "mint cream" con tono verde) */
    border-radius: 16px;       /* Bordes suavemente redondeados */
    padding: 20px 25px;        /* Espaciado interno */
    border: 1px solid #c7e9c0; /* Borde ligeramente más oscuro para definición */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Sombra sutil */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #2d6a4f;            /* Texto en verde oscuro para contraste */
    line-height: 1.6;
    margin-top: 20px;
    max-width: 100%;
    overflow: hidden;
}

#recommendationResultDiv h3 {
    color: #1b4332;            /* Verde más oscuro para títulos */
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.4em;
    font-weight: 600;
}

#recommendationResultDiv ul {
    margin: 10px 0;
    padding-left: 20px;
}

#recommendationResultDiv li {
    margin-bottom: 6px;
}

#recommendationResultDiv strong {
    color: #1b4332;
	
	
	
	.target-icon {
            display: inline-block;
            padding: 8px 16px;
            background-color: #388E3C;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            margin: 10px 0;
            font-weight: 300;
            transition: background-color 0.3s;
        }
        .target-icon:hover {
            background-color: #2E7D32;
            color: white;
        }
        #chart-container {
            height: 400px;
            margin-top: 20px;
        }
        .modal-dialog {
            max-width: 700px;
        }




/* Ajustes menores para el modal modificar fila en Tabla Detallada, si es necesario */
#editarFilaModal .modal-content {
  border-radius: 0.5rem;
}

#editarFilaModal .modal-header {
  background-color: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
}

#editarFilaModal .modal-footer {
  background-color: #f8f9fa;
  border-top: 1px solid #e9ecef;
}

#modalMensajeSumaMacros {
    font-size: 0.8rem;
    text-align: right;
}


/* --- Estilos Personalizados para el Modal de Edición Fila Tabla Detallada Mejorado --- */
/* --- Estilos Personalizados para el Modal de Edición Mejorado --- */

/* --- Estilos Personalizados para el Modal de Edición Mejorado --- */

/* --- 1. Estilos Generales del Modal --- */
#editarFilaModal .modal-content {
    border-radius: 0.75rem; /* Bordes ligeramente más redondeados */
    overflow: hidden; /* Evita que el contenido se salga de las esquinas redondeadas */
    border: 1px solid #d1d1d1; /* Borde sutil alrededor del modal */
}

#editarFilaModal .modal-header {
    background-color: #28a745; /* Verde Bootstrap success */
    color: white;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2); /* Línea sutil debajo del header */
}

#editarFilaModal .modal-title {
    font-weight: 500; /* Negrita ligera para el título */
    font-size: 1.1rem; /* Tamaño de fuente ligeramente más grande */
}

#editarFilaModal .modal-body {
    padding: 1.25rem; /* Espacio interno consistente */
	background-color: #f8f9fa; /* Fondo gris muy claro para todo el body */
}

#editarFilaModal .modal-footer {
    background-color: #e9ecef; /* Fondo gris claro */
    border-top: 1px solid #dee2e6; /* Línea sutil encima del footer */
    padding: 0.75rem 1.25rem; /* Alinear padding con el body */
}

/* --- 2. Secciones Principales del Cuerpo --- */
#editarFilaModal .modal-body > div.seccion-modal {
    background-color: #ffffff; /* Fondo blanco para cada sección */
    border: 1px solid #e9ecef; /* Borde sutil alrededor de cada sección */
    border-radius: 0.5rem; /* Bordes redondeados para cada sección */
    padding: 1rem; /* Espacio interno para cada sección */
    margin-bottom: 1.25rem; /* Espacio entre secciones */
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05); /* Sombra muy ligera */
}

#editarFilaModal .modal-body > div.seccion-modal:last-child {
    margin-bottom: 0; /* Eliminar margen del último elemento */
}

/* --- 3. Títulos de Sección --- */
#editarFilaModal .seccion-modal h6 {
    /* Estilo para los títulos de las secciones como "📋 Contexto del Plan", "🧠 Posibles Estrategias", etc. */
    margin-top: 0; /* Eliminar margen superior por defecto */
    margin-bottom: 0.75rem; /* Espacio debajo del título */
    padding-bottom: 0.25rem; /* Pequeño espacio interno debajo */
    border-bottom: 1px solid #e9ecef; /* Línea sutil debajo del título */
    color: #28a745; /* Verde Bootstrap success */
    font-weight: 600; /* Negrita media */
	font-size: 0.95rem; /* Tamaño de fuente del título */
}

/* --- 4. Información de Contexto (Fase, Objetivo, Duración) --- */
#editarFilaModal #modalInfoFase,
#editarFilaModal #modalInfoObjetivo,
#editarFilaModal #modalInfoDuracion {
    font-weight: 500; /* Hacer el texto un poco más prominente */
    color: #495057; /* Color de texto secundario de Bootstrap */
}

/* --- 5. Estrategias Base y Recomendadas --- */
#editarFilaModal #modalEstrategiasBase,
#editarFilaModal #modalEstrategiasRecomendadas {
    font-weight: 500;
    color: #007bff; /* Color azul para destacar */
	font-size: 0.875rem; /* Tamaño de fuente ligeramente más pequeño */
}

/* --- 6. Contenedor de Checkboxes de Estrategias --- */
#editarFilaModal #modalCheckboxesEstrategias {
    /* Estilo base para el contenedor de checkboxes */
    padding: 0.5rem;
    border: 1px dashed #ced4da; /* Borde punteado sutil */
    border-radius: 0.375rem; /* Bordes redondeados */
    background-color: #f8f9fa; /* Fondo gris muy claro */
    min-height: 50px; /* Altura mínima para evitar saltos bruscos */
}

/* --- 7. Checkboxes Individuales --- */
#editarFilaModal #modalCheckboxesEstrategias .form-check {
    /* Espacio entre checkboxes */
    margin-bottom: 0.5rem;
}

#editarFilaModal #modalCheckboxesEstrategias .form-check:last-child {
    /* Eliminar margen del último checkbox */
    margin-bottom: 0;
}

#editarFilaModal #modalCheckboxesEstrategias .form-check-input {
    /* Asegurar tamaño consistente */
    width: 1.2em;
    height: 1.2em;
    margin-top: 0.15em; /* Alinear verticalmente mejor con el label */
}

#editarFilaModal #modalCheckboxesEstrategias .form-check-label {
    /* Asegurar buena legibilidad */
    margin-left: 0.5rem; /* Espacio entre input y label */
    vertical-align: top; /* Alinear con la parte superior del input */
    cursor: pointer; /* Cambiar cursor para indicar interactividad */
	font-size: 0.875rem; /* Tamaño de fuente consistente */
	color: #333; /* Color de texto oscuro para mejor contraste */
}

/* --- 8. Configuración de Macros por Estrategia --- */

/* Contenedor de todas las filas de configuración */
#editarFilaModal #modalConfiguracionMacrosPorEstrategia {
    /* Espacio arriba del contenedor */
    margin-top: 0.5rem;
    /* Asegurar espacio para posibles mensajes de error o información */
    min-height: 60px;
}

/* Estilo base para cada fila de estrategia (la que se genera dinámicamente) */
#editarFilaModal .fila-configuracion-estrategia {
    background-color: #ffffff; /* Fondo blanco */
    border: 1px solid #e9ecef; /* Borde sutil */
    border-radius: 0.5rem; /* Bordes redondeados */
    padding: 1rem; /* Espacio interno */
    margin-bottom: 1rem; /* Espacio entre filas */
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* Sombra ligera */
    transition: box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out; /* Transiciones suaves */
	position: relative; /* Para posicionar el botón de cierre */
}

/* Efecto hover para las filas de configuración */
#editarFilaModal .fila-configuracion-estrategia:hover {
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1); /* Sombra más pronunciada al pasar el mouse */
    border-color: #adb5bd; /* Cambiar color del borde al pasar el mouse */
}

/* Cabecera de la fila de configuración (nombre de estrategia + botón cerrar) */
#editarFilaModal .fila-configuracion-estrategia .cabecera-fila-estrategia {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

/* Nombre de la estrategia en la cabecera */
#editarFilaModal .fila-configuracion-estrategia .nombre-estrategia {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 500;
    color: #007bff; /* Azul para destacar */
}

/* Botón de cierre (X) en la cabecera */
#editarFilaModal .fila-configuracion-estrategia .boton-cerrar-fila-estrategia {
    background: none;
    border: none;
    font-size: 1.25rem;
    line-height: 1;
    color: #6c757d;
    opacity: 0.7;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: color 0.15s ease-in-out, opacity 0.15s ease-in-out, background-color 0.15s ease-in-out;
	position: absolute;
	top: 0.5rem;
	right: 0.5rem;
}

#editarFilaModal .fila-configuracion-estrategia .boton-cerrar-fila-estrategia:hover {
    color: #000;
    opacity: 1;
    background-color: #e9ecef;
}

/* Grupo de inputs de macros */
#editarFilaModal .fila-configuracion-estrategia .grupo-macros-estrategia {
    margin-bottom: 1rem;
}

/* Etiquetas de inputs de macros */
#editarFilaModal .fila-configuracion-estrategia .grupo-macros-estrategia .form-label {
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
    color: #495057;
    font-weight: 500;
}

/* Inputs de porcentaje de macros */
#editarFilaModal .fila-configuracion-estrategia .grupo-macros-estrategia .form-control {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    height: calc(1.5em + 0.5rem + 2px);
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
	width: 100%; /* Asegurar ancho completo */
	box-sizing: border-box; /* Incluir padding en el tamaño */
}

#editarFilaModal .fila-configuracion-estrategia .grupo-macros-estrategia .form-control:focus {
    border-color: #80bdff;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 253, 0.25);
}

/* Texto de suma de macros */
#editarFilaModal .fila-configuracion-estrategia .texto-suma-macros-estrategia {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
    text-align: right;
    margin-top: 0.25rem;
}

/* Estado de error en la suma de macros */
#editarFilaModal .fila-configuracion-estrategia .texto-suma-macros-estrategia.error {
    color: #dc3545; /* Rojo para error */
}

/* Estado de éxito en la suma de macros */
#editarFilaModal .fila-configuracion-estrategia .texto-suma-macros-estrategia.ok {
    color: #28a745; /* Verde para éxito */
}

/* Sección de "Aplicar también a:" */
#editarFilaModal .fila-configuracion-estrategia .seccion-aplicar-a-estrategia {
    padding-top: 0.75rem;
    border-top: 1px solid #e9ecef;
}

#editarFilaModal .fila-configuracion-estrategia .seccion-aplicar-a-estrategia .form-label {
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    color: #495057;
    font-weight: 500;
}

/* Checkboxes de días para aplicar */
#editarFilaModal .fila-configuracion-estrategia .seccion-aplicar-a-estrategia .form-check-inline {
    margin-right: 1rem; /* Espacio entre checkboxes inline */
    margin-bottom: 0.25rem; /* Pequeño espacio abajo para wrap */
}

#editarFilaModal .fila-configuracion-estrategia .seccion-aplicar-a-estrategia .form-check-input {
    width: 1.1em;
    height: 1.1em;
    margin-top: 0.15em;
}

#editarFilaModal .fila-configuracion-estrategia .seccion-aplicar-a-estrategia .form-check-label {
    margin-left: 0.375rem;
    vertical-align: top;
    font-size: 0.875rem;
    cursor: pointer; /* Cambiar cursor para indicar interactividad */
	color: #333; /* Color de texto oscuro para mejor contraste */
}

/* Mensaje de "Sin Estrategias Seleccionadas" */
#editarFilaModal #modalMensajeSinEstrategias {
    padding: 2rem 1rem; /* Más espacio vertical */
    text-align: center;
    color: #6c757d; /* Color de texto muted */
    font-style: italic;
    background-color: #f8f9fa; /* Fondo muy claro */
    border: 1px dashed #e9ecef; /* Borde punteado sutil */
    border-radius: 0.375rem; /* Bordes redondeados */
    margin-top: 0.5rem;
    display: block; /* Asegurar que se muestre como bloque */
	font-size: 0.9rem; /* Tamaño de fuente legible */
}

/* --- 9. Sección de Recordatorio de Evolución --- */
/* Los estilos básicos para listas anidadas y texto ya están cubiertos por Bootstrap */
/* Podemos añadir algunos refinamientos */

#editarFilaModal .seccion-recordatorio-evolucion ul {
    /* Asegurar espacio consistente para listas anidadas */
    margin-bottom: 0.5rem;
	padding-left: 1.2rem; /* Sangría para listas */
}

#editarFilaModal .seccion-recordatorio-evolucion ul ul {
    /* Reducir margen de listas anidadas */
    margin-bottom: 0.25rem;
	padding-left: 1rem; /* Sangría menor para sublistas */
}

#editarFilaModal .seccion-recordatorio-evolucion li {
    margin-bottom: 0.25rem; /* Espacio entre items de lista */
}

#editarFilaModal .mensaje-proxima-reevaluacion {
    /* Basado en el <p class="mt-2 mb-1 text-center bg-warning-subtle p-2 rounded"> del ejemplo */
    margin-top: 1rem;
    margin-bottom: 0.25rem;
    text-align: center;
    padding: 0.5rem;
    border-radius: 0.375rem;
    background-color: #fff3cd; /* Amarillo suave de Bootstrap */
    border: 1px solid #ffeaa7; /* Borde amarillo más oscuro */
    color: #856404; /* Texto amarillo oscuro */
    font-weight: 500;
	font-size: 0.85rem; /* Tamaño de fuente consistente */
}

/* --- 10. Botones del Footer --- */
#editarFilaModal .modal-footer .btn {
    /* Asegurar que los botones tengan un estilo consistente */
    font-weight: 500; /* Negrita ligera */
    padding: 0.375rem 0.75rem; /* Padding consistente */
    border-radius: 0.375rem; /* Bordes redondeados */
    transition: all 0.15s ease-in-out; /* Transición suave */
	font-size: 0.875rem; /* Tamaño de fuente legible */
}

/* --- 11. Ajustes de Responsividad --- */
@media (max-width: 767.98px) {
    /* Reducir tamaño de fuente general del modal en móviles */
    #editarFilaModal .modal-content {
        font-size: 0.875rem;
    }

    /* Ajustar padding del cuerpo del modal */
    #editarFilaModal .modal-body {
        padding: 1rem;
    }

    /* Ajustar padding del footer del modal */
    #editarFilaModal .modal-footer {
        padding: 0.5rem 1rem;
    }

    /* Ajustar padding de las filas de configuración de estrategias */
    #editarFilaModal .fila-configuracion-estrategia {
        padding: 0.75rem;
    }

    /* Ajustar padding de la cabecera de las filas de configuración */
    #editarFilaModal .fila-configuracion-estrategia .cabecera-fila-estrategia {
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
    }

    /* Ajustar tamaño de fuente del nombre de la estrategia */
    #editarFilaModal .fila-configuracion-estrategia .nombre-estrategia {
        font-size: 1rem;
    }

    /* Ajustar inputs de macros para móviles */
    #editarFilaModal .fila-configuracion-estrategia .grupo-macros-estrategia .form-control {
        font-size: 0.8rem;
        padding: 0.2rem 0.4rem;
        height: calc(1.5em + 0.4rem + 2px);
    }

    /* Ajustar texto de suma de macros */
    #editarFilaModal .fila-configuracion-estrategia .texto-suma-macros-estrategia {
        font-size: 0.8rem;
    }

    /* Ajustar sección de "Aplicar también a:" para móviles */
    #editarFilaModal .fila-configuracion-estrategia .seccion-aplicar-a-estrategia .form-check-inline {
        display: block; /* Apilar los checkboxes en móviles */
        margin-right: 0;
        margin-bottom: 0.25rem;
    }

    #editarFilaModal .fila-configuracion-estrategia .seccion-aplicar-a-estrategia .form-check-inline:last-child {
        margin-bottom: 0;
    }

    /* Ajustar tamaño de fuente de las etiquetas de checkboxes */
    #editarFilaModal .fila-configuracion-estrategia .seccion-aplicar-a-estrategia .form-check-label {
        font-size: 0.8rem;
    }
	
	/* Ajustar títulos de sección */
	#editarFilaModal .seccion-modal h6 {
		font-size: 0.9rem;
	}
	
	/* Ajustar mensaje de próxima reevaluación */
	#editarFilaModal .mensaje-proxima-reevaluacion {
		font-size: 0.8rem;
		padding: 0.4rem;
	}
}

/* --- 12. Estados Visuales para Inputs/Sumas (Opcional) --- */
/* Puedes usar estas clases dinámicamente con JS si lo deseas */
#editarFilaModal .is-valid {
    border-color: #28a745 !important; /* Verde para válido */
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
}

#editarFilaModal .is-invalid {
    border-color: #dc3545 !important; /* Rojo para inválido */
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

#editarFilaModal .text-success {
    color: #28a745 !important; /* Verde para texto válido */
}

#editarFilaModal .text-danger {
    color: #dc3545 !important; /* Rojo para texto inválido */
}
/* ==========================================================================
   MODAL: CALCULADORA NO LINEAL - ESTRUCTURA BASE
   ========================================================================== */

#modalCalculadoraNoLineal .modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(86, 138, 61, 0.2);
    overflow: hidden;
}

#modalCalculadoraNoLineal .modal-header {
    background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%);
    color: white;
    border: none;
    padding: 1.25rem;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(60, 145, 65, 0.3);
}

/* Efecto glossy en cabecera del modal */
#modalCalculadoraNoLineal .modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: glossyEffect 3s infinite;
}

@keyframes glossyEffect {
    0% { left: -100%; }
    100% { left: 100%; }
}

#modalCalculadoraNoLineal .modal-title {
    font-weight: 600;
    font-size: 1.25rem;
    color: white;
}

#modalCalculadoraNoLineal .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
}

#modalCalculadoraNoLineal .modal-body {
    padding: 1.5rem;
}

#modalCalculadoraNoLineal .modal-footer {
    background-color: #f8f9fa;
    border: none;
    padding: 1rem 1.5rem;
}


/* ==========================================================================
   CARDS - DISEÑO MEJORADO
   ========================================================================== */

#modalCalculadoraNoLineal .card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    transition: box-shadow 0.3s ease;
    margin-bottom: 1rem;
}

#modalCalculadoraNoLineal .card:hover {
    box-shadow: 0 4px 20px rgba(86, 138, 61, 0.15);
}

#modalCalculadoraNoLineal .card-body {
    padding: 1.25rem;
}

#modalCalculadoraNoLineal .form-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-left: 4px solid #568a3d;
}

#modalCalculadoraNoLineal .summary-card {
    background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
    border-left: 4px solid #568a3d;
}


/* ==========================================================================
   TABLA - ESTILOS BASE
   ========================================================================== */

#modalCalculadoraNoLineal .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-bottom: 0;
    font-size: 0.9rem;
}

#tabla-progreso-container-modal .tabla-contenedor {
    height: 400px;
    overflow-y: auto;
    position: relative;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin: 15px 0;
    background: white;
    box-shadow: 0 2px 10px rgba(86, 138, 61, 0.15);
}

/* Scrollbar personalizado */
#tabla-progreso-container-modal .tabla-contenedor::-webkit-scrollbar {
    width: 8px;
}
#tabla-progreso-container-modal .tabla-contenedor::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}
#tabla-progreso-container-modal .tabla-contenedor::-webkit-scrollbar-thumb {
    background: #568a3d;
    border-radius: 4px;
}
#tabla-progreso-container-modal .tabla-contenedor::-webkit-scrollbar-thumb:hover {
    background: #4a7a36;
}


/* ==========================================================================
   TABLA - HEADER FIJO CON EFECTO GLOSSY
   ========================================================================== */

#tabla-progreso-container-modal .tabla-contenedor thead tr {
    position: sticky;
    top: 0;
    z-index: 100;
}

#tabla-progreso-container-modal .tabla-contenedor thead th {
    background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%);
    color: white;
    padding: 12px 8px;
    font-weight: 600;
    text-align: center;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
    font-size: 0.85rem;
    white-space: nowrap;
    z-index: 101;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    border-radius: 8px 8px 0 0;
    position: relative;
    overflow: hidden;
}

/* Efecto glossy en th */
#tabla-progreso-container-modal .tabla-contenedor thead th::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.5s;
}
#tabla-progreso-container-modal .tabla-contenedor thead th:hover::before {
    left: 100%;
}


/* ==========================================================================
   TABLA - CUERPO Y FILAS
   ========================================================================== */

#tabla-progreso-container-modal .tabla-contenedor tbody td {
    padding: 10px 8px;
    border-bottom: 1px solid #e9ecef;
    vertical-align: middle;
    text-align: center;
    font-size: 0.85rem;
    color: #333;
    background-color: white;
    transition: all 0.2s ease;
}

#tabla-progreso-container-modal .tabla-contenedor tbody tr:last-child td {
    border-bottom: none;
}

#tabla-progreso-container-modal .tabla-contenedor tbody tr:nth-of-type(even) td {
    background-color: #f8f9fa;
}

/* Hover en fila completa */
#tabla-progreso-container-modal .tabla-contenedor tbody tr {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
}

#tabla-progreso-container-modal .tabla-contenedor tbody tr:hover {
    background: linear-gradient(90deg, #e8f5e9 0%, #d4edda 100%);
    transform: scale(1.02);
    box-shadow: 0 4px 15px rgba(60, 145, 65, 0.2);
    z-index: 10;
    position: relative;
    border-left: 3px solid #3c9141;
    border-right: 3px solid #3c9141;
}

#tabla-progreso-container-modal .tabla-contenedor tbody tr:hover td {
    background: transparent;
    color: #1b5e20;
    font-weight: 500;
}


/* ==========================================================================
   ESTILOS DE ESTADO: CAMBIOS POSITIVOS Y NEGATIVOS
   ========================================================================== */

#tabla-progreso-container-modal .positive-change {
    color: #2e7d32;
    font-weight: 600;
    background-color: rgba(46, 125, 50, 0.1);
    padding: 2px 4px;
    border-radius: 3px;
}

#tabla-progreso-container-modal .negative-change {
    color: #d32f2f;
    font-weight: 600;
    background-color: rgba(211, 47, 47, 0.1);
    padding: 2px 4px;
    border-radius: 3px;
}


/* ==========================================================================
   FORMULARIOS - INPUTS, LABELS, CHECKBOXES
   ========================================================================== */

#modalCalculadoraNoLineal .form-label {
    font-weight: 600;
    color: #2e7d32;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

#modalCalculadoraNoLineal .form-label:hover {
    color: #3c9141;
    transform: translateX(2px);
}

#modalCalculadoraNoLineal .form-control,
#modalCalculadoraNoLineal .form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem;
    background: #fff;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

#modalCalculadoraNoLineal .form-control:focus,
#modalCalculadoraNoLineal .form-select:focus {
    border-color: #3c9141;
    box-shadow: 0 0 0 3px rgba(60, 145, 65, 0.2);
    outline: 0;
    transform: translateY(-2px);
    background: #fff;
}

#modalCalculadoraNoLineal .form-control:hover,
#modalCalculadoraNoLineal .form-select:hover {
    border-color: #81c784;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

#modalCalculadoraNoLineal .form-check-input {
    width: 1.2em;
    height: 1.2em;
    border: 2px solid #ced4da;
    cursor: pointer;
    transition: all 0.3s ease;
}

#modalCalculadoraNoLineal .form-check-input:checked {
    background-color: #3c9141;
    border-color: #3c9141;
    box-shadow: 0 2px 4px rgba(60, 145, 65, 0.3);
}

#modalCalculadoraNoLineal .form-check-input:hover {
    border-color: #3c9141;
    transform: scale(1.1);
}

#modalCalculadoraNoLineal .form-check-input:focus {
    box-shadow: 0 0 0 3px rgba(60, 145, 65, 0.25);
    outline: 0;
}


/* ==========================================================================
   ALERTAS
   ========================================================================== */

#modalCalculadoraNoLineal .alert-info {
    background: linear-gradient(135deg, #e8f5e9 0%, #d4edda 100%);
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    color: #155724;
}


/* ==========================================================================
   BOTONES
   ========================================================================== */

#modalCalculadoraNoLineal .btn {
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    position: relative;
    overflow: hidden;
}

#modalCalculadoraNoLineal .btn-primary {
    background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%);
    box-shadow: 0 4px 15px rgba(60, 145, 65, 0.3);
}

#modalCalculadoraNoLineal .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(60, 145, 65, 0.4);
}

#modalCalculadoraNoLineal .btn-primary:active {
    transform: translateY(0);
    box-shadow: 0 2px 10px rgba(60, 145, 65, 0.3);
}

#modalCalculadoraNoLineal .btn-outline-primary {
    border-color: #568a3d;
    color: #568a3d;
}

#modalCalculadoraNoLineal .btn-outline-primary:hover {
    background: #568a3d;
    color: white;
}

#modalCalculadoraNoLineal .btn-secondary {
    background: #6c757d;
    border: none;
}


/* ==========================================================================
   RESPONSIVE - ADAPTACIÓN MÓVIL
   ========================================================================== */

@media (max-width: 768px) {
    #modalCalculadoraNoLineal .modal-dialog {
        margin: 10px;
        max-width: calc(100% - 20px);
    }

    #modalCalculadoraNoLineal .modal-body {
        padding: 1rem;
    }

    #tabla-progreso-container-modal .tabla-contenedor {
        height: 350px;
        font-size: 0.8rem;
    }

    #tabla-progreso-container-modal .tabla-contenedor thead th {
        padding: 8px 4px;
        font-size: 0.75rem;
    }

    #tabla-progreso-container-modal .tabla-contenedor tbody td {
        padding: 6px 4px;
        font-size: 0.75rem;
    }

    #modalCalculadoraNoLineal .form-control,
    #modalCalculadoraNoLineal .form-select {
        padding: 0.6rem;
        font-size: 0.9rem;
    }

    #modalCalculadoraNoLineal .form-label {
        font-size: 0.9rem;
    }

    #modalCalculadoraNoLineal .btn {
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
    }
}

@media (max-width: 576px) {
    #tabla-progreso-container-modal .tabla-contenedor {
        height: 300px;
        font-size: 0.7rem;
    }

    #tabla-progreso-container-modal .tabla-contenedor thead th {
        font-size: 0.7rem;
        padding: 6px 2px;
    }

    #tabla-progreso-container-modal .tabla-contenedor tbody td {
        font-size: 0.7rem;
        padding: 4px 2px;
    }

    #modalCalculadoraNoLineal .form-control,
    #modalCalculadoraNoLineal .form-select {
        padding: 0.5rem;
        font-size: 0.85rem;
    }
}


</style>    
           


</style>

</head>

<body>
    <header>
        <div class="logo">
	  <a href="#" id="logo">NutriPlan_v2</a>
	</div>
	    <div class="dropdown" id="dropdown">
	        <a href="#" onclick="logout()">Cerrar Sesión</a>
	    </div>
        <nav>
            <ul>
                <li><a href="https://fermagil.github.io/Nutri_Plan_v2/Inicio_NutriPlan_v2.html">Inicio</a></li>
				<li><a href="https://fermagil.github.io/Nutri_Plan_v2/Valoracion_Antropometrica_1.html">Valoración Antropometrica</a></li>
                <li><a href="#" class="active">Planificación Avanzada</a></li>
                <li><a href="https://fermagil.github.io/Nutri_Plan_v2/Calculadora_keto_recetas.html">Calculadora</a></li>
            </ul>
        </nav>
    </header>
	
    <main>
				<section>
					<h1>Crea tu Plan Dietético Personalizado</h1>
					<p style="text-align: center; max-width: 700px; margin: 0 auto 30px auto; color: #495057;">
						Sigue estos pasos guiados para obtener una estimación de tus necesidades nutricionales y generar un plan de comidas orientativo.
						Antes de utilizar los datos obtenidos con esta herramienta, consulta con su Dietista-Nutricionista.
					</p>
			</section>
	    <section>
    <div class="plan-step" id="step-1">
    <h2>1. Calcula tus Necesidades y Balance Energético</h2>
    <p>Introduce tus datos básicos para estimar tu Gasto Energético Total (GET) y, si lo deseas, tu ingesta actual para ver tu balance energético.</p>
    <form id="calorie-form" class="row">
        <div class="col-md-6">
            <label for="age">Edad (años):</label>
            <input type="number" id="age" name="age" required min="1" max="120">

            <label for="gender">Género Biológico:</label>
            <select id="gender" name="gender">
                <option value="male">Masculino</option>
                <option value="female">Femenino</option>
            </select>

            <label for="weight">Peso Actual (kg):</label>
            <input type="number" id="weight" name="weight" required min="1" step="0.1">

            <label for="height">Altura (m):</label>
            <input type="number" id="height" name="height" step="0.01" required min="0.5" max="3" placeholder="Ej: 1.75">

            <label for="activity">Nivel de Actividad Física Semanal:</label>
            <select id="activity" name="activity">
                <option value="sedentary">Sedentario</option>
                <option value="light">Ligero (1-3 días/sem)</option>
                <option value="moderate">Moderado (3-5 días/sem)</option>
                <option value="active">Activo (6-7 días/sem)</option>
                <option value="very_active">Muy Activo (Intenso/Diario)</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="estimated-intake">Tu Ingesta Calórica Estimada Actual (kcal/día, opcional):</label>
            <input type="number" id="estimated-intake" name="estimated-intake" min="0" step="1" placeholder="Si la conoces, ej: 2100">

            <label for="condition">Condición Corporal:</label>
            <select id="condition" name="condition">
                <option value="auto">Automático (basado en IMC)</option>
                <option value="obese">Obeso</option>
                <option value="overweight">Sobrepeso</option>
                <option value="normal">Normopeso</option>
                <option value="underweight">Infrapeso</option>
                <option value="athlete">Atleta</option>
            </select>

            <label for="formula">
                Fórmula de Cálculo: 
                <span class="tooltip-container">
                    <i class="bi bi-info-circle-fill tooltip-icon"></i>
                    <span class="tooltip-text">Elige una fórmula para estimar tu metabolismo basal o usa 'Automático' para la mejor opción</span>
                </span>
            </label>
            <select id="formula" name="formula">
                <option value="auto" selected title="El sistema elige la mejor fórmula según tu edad y peso">Automático (recomendado para cualquier persona)</option>
                <option value="harris-benedict" title="Fórmula clásica para adultos con peso normal o bajo">Harris-Benedict (adultos 18+, peso normal o bajo, cualquier actividad)</option>
                <option value="oms" title="Fórmula para adultos, ideal para mayores o poca actividad">OMS/FAO/ONU (adultos 18+, especialmente 30–60+, actividad baja a moderada)</option>
                <option value="mifflin" title="Fórmula precisa para sobrepeso, obesidad o atletas">Mifflin-St Jeor (adultos 18+, sobrepeso, obesidad o atletas, cualquier actividad)</option>
                <option value="oms-adolescent" title="Fórmula para adolescentes con actividad moderada o alta">OMS Adolescentes (10–18 años, actividad moderada a alta)</option>
            </select>

            <label>
                <input type="checkbox" id="buffer" name="buffer"> Aplicar 10% margen adicional (para TEF o variabilidad)
                <span class="tooltip-container">
                    <i class="bi bi-exclamation-diamond-fill tooltip-icon"></i>
                    <span class="tooltip-text">Se recomienda un margen adicional del 10% para TEF y variabilidad (e.g., metabolismo basal, actividad física). Usa 10% si el MB es bajo/incierto o la actividad varía; 7-8% si la actividad es moderada/alta y los datos son precisos. Evalúa tu rutina y estado metabólico para ajustar.</span>
                </span>
            </label>

            <div class="text-center mt-4">
				<button type="submit" form="calorie-form">Calcular GET y Balance</button>
			</div>
        </div>
    </form>
    <div id="errorMeals" class="error-message" style="display:none;"></div>
    <div id="errorMacros" class="error-message" style="display:none;"></div>
    <div id="calorie-result" style="display:none;"></div>
    <div id="energy-balance-result" style="display:none;"></div>
    <div id="recommendationResultDiv" style="display:none;"></div>
</div>
</section>
        <section>
    <div class="plan-step" id="step-2">
        <h2>2. Establece tu Objetivo de Peso y Composición Corporal</h2>

        <!-- Texto con icono integrado en línea -->
        <div class="mb-3">
            <h5 class="form-label">Objetivo General Mejora Composición Corporal</h5>
            <select id="objetivoGeneral" class="form-select">
                <option value="salud">Salud</option>
                <option value="estetico">Estético</option>
                <option value="rendimiento">Rendimiento (Deportivo)</option>
            </select>
        </div>

        <div class="text-with-icon">
            <p>Define tu objetivo de composición corporal (% GR). Puedes estimar tu % GR actual con básculas de bioimpedancia o calculadoras online.</p>
            <a href="#" data-bs-toggle="modal" data-bs-target="#evidenciaModal" class="target-icon">🎯</a>
        </div>

        <div class="info-box">
            <p><em>Si no conoces tu % de GR y/o tu % MLG actual, ve a la sección <a href="https://fermagil.github.io/Nutri_Plan_v2/Valoracion_Antropometrica_1.html" target="_blank" rel="noopener noreferrer">Valoración Antropométrica</a> de NutriPlan_v2. Si aún no estás listo para usarla, puedes usar una <a href="https://www.calculator.net/body-fat-calculator.html" target="_blank" rel="noopener noreferrer">calculadora online</a> (en inglés) o buscar alternativas en español.</em></p>
        </div>

								
									<h3>Objetivo Nutricional</h3>
										<div class="info-notice" style="display: none; background-color: #e8f5e9; padding: 15px; border-left: 4px solid #2e7d32; border-radius: 4px; font-style: italic;">
											<p>ℹ️ <strong>Información importante:</strong></p>
											<p>Los valores asignados en los campos son <strong>estimaciones orientativas</strong> basadas en tu perfil. Pueden servir como punto de partida, pero <strong>no sustituyen una evaluación precisa</strong>.</p>
											<p>Para una valoración más exacta, te recomendamos utilizar la herramienta <strong>Valoración Antropométrica de NutriPlan_v2</strong>, que permite introducir medidas reales (pliegues, perímetros) para calcular tu %grasa y masa magra con mayor precisión.</p>
											<p><em>Puedes modificar estos valores en cualquier momento según tus objetivos o tras una evaluación profesional.</em></p>
										</div>

				                        <label for="objetivo" class="form-label">Selecciona tu objetivo:</label>
				                         <select id="objetivo" class="form-control" aria-label="Objetivo nutricional" required>
											<option value="sel">Selecciona segun Objetivo</option> 
				                            <option value="perdida1">1. Pérdida de Peso</option>
				                            <option value="ganancia1">2. Ganancia de Peso</option>
				                            <option value="mantenimiento1">3. Mantenimiento</option>
				                            <option value="mixto1">4. Mixto/Combinado</option>
				                        </select>
										
								
							
						<!-- Modal for Evidence Table with Increased Width -->
						<div class="modal fade" id="evidenciaModal" tabindex="-1" aria-labelledby="evidenciaModalLabel" aria-hidden="true">
							<div class="modal-dialog modal-xl">
								<div class="modal-content">
									<div class="modal-header" style="background-color: #2a6621;">
										<h5 class="modal-title" id="evidenciaModalLabel" style="color: #ffffff;">Evidencia Científica de los Rangos</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>
									<div class="modal-body">
										<div class="table-responsive">
											<table class="table table-striped">
												<thead>
													<tr>
														<th>Objetivo</th>
														<th>Categoría de AF</th>
														<th>Rango (% GR, % MLG)</th>
														<th>Justificación Científica</th>
														<th>Referencias</th>
													</tr>
												</thead>
												<tbody>
													<tr>
														<td>Salud</td>
														<td>♂️ Sedentarios</td>
														<td>15-25% GR, 75-85% MLG</td>
														<td>Según ACSM, el rango saludable para ♂️ sedentarios es 18-24% GR, con 15-25% aceptable según edad.</td>
														<td><a href="https://www.nejm.org/doi/full/10.1056/NEJMoa1503824" target="_blank">NEJM (2016)</a></td>
													</tr>
													<tr>
														<td>Salud</td>
														<td>♀️ Sedentarias</td>
														<td>20-30% GR, 70-80% MLG</td>
														<td>♀️ tienen mayor GR esencial; ACSM sugiere 25-31%, con 20-30% como subconjunto saludable.</td>
														<td><a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(18)31310-2/fulltext" target="_blank">Lancet (2018)</a></td>
													</tr>
													<tr>
														<td>Salud</td>
														<td>♂️ con AF Leve</td>
														<td>10-18% GR, 82-90% MLG</td>
														<td>Individuos activos muestran menor GR por mayor gasto energético; 10-18% es óptimo con AF leve.</td>
														<td><a href="https://www.nature.com/articles/s41591-019-0565-1" target="_blank">Nature Medicine (2019)</a></td>
													</tr>
													<tr>
														<td>Salud</td>
														<td>♀️ con AF Leve</td>
														<td>18-25% GR, 75-82% MLG</td>
														<td>Alineado con rangos atléticos saludables, preservando GR esencial y mayor MLG.</td>
														<td><a href="https://jamanetwork.com/journals/jama/article-abstract/2768357" target="_blank">JAMA (2020)</a></td>
													</tr>
													<tr>
														<td>Salud</td>
														<td>♂️ con AF Moderada</td>
														<td>8-15% GR, 85-92% MLG</td>
														<td>Rango común en ♂️ moderadamente activos, respaldado por evaluaciones de fitness.</td>
														<td><a href="https://www.nejm.org/doi/full/10.1056/NEJMoa2034577" target="_blank">NEJM (2021)</a></td>
													</tr>
													<tr>
														<td>Salud</td>
														<td>♀️ con AF Moderada</td>
														<td>15-22% GR, 78-85% MLG</td>
														<td>Refleja un balance de GR esencial y MLG en ♀️ moderadamente activas.</td>
														<td><a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(19)32531-2/fulltext" target="_blank">Lancet (2019)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♂️ Sedentarios</td>
														<td>12-20% GR, 80-88% MLG</td>
														<td>Rango estéticamente agradable donde comienza a definirse la musculatura sin extrema delgadez.</td>
														<td><a href="https://www.nature.com/articles/s41591-018-0278-4" target="_blank">Nature Medicine (2018)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♀️ Sedentarias</td>
														<td>20-28% GR, 72-80% MLG</td>
														<td>♀️ buscan 20-28% GR para balancear curvas con aspecto tonificado.</td>
														<td><a href="https://jamanetwork.com/journals/jama/article-abstract/2763084" target="_blank">JAMA (2019)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♂️ con AF Leve</td>
														<td>10-15% GR, 85-90% MLG</td>
														<td>AF leve reduce GR a 10-15%, mejorando visibilidad muscular.</td>
														<td><a href="https://www.nature.com/articles/s41591-020-01189-4" target="_blank">Nature Medicine (2020)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♀️ con AF Leve</td>
														<td>18-24% GR, 76-82% MLG</td>
														<td>Refleja un aspecto estético más delgado con AF leve.</td>
														<td><a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(20)30185-9/fulltext" target="_blank">Lancet (2020)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♂️ con AF Moderada-Intensa</td>
														<td>8-12% GR, 88-92% MLG</td>
														<td>Competidores de fisicoculturismo apuntan a 8-12% GR para definición.</td>
														<td><a href="https://www.nejm.org/doi/full/10.1056/NEJMoa2109730" target="_blank">NEJM (2021)</a></td>
													</tr>
													<tr>
														<td>Estético</td>
														<td>♀️ con AF Moderada-Intensa</td>
														<td>15-20% GR, 80-85% MLG</td>
														<td>Competidoras femeninas mantienen 15-20% GR para look esculpido.</td>
														<td><a href="https://www.nature.com/articles/s41591-021-01467-4" target="_blank">Nature Medicine (2021)</a></td>
													</tr>
													<tr>
														<td>Rendimiento (Deportivo)</td>
														<td>♂️ con AF Moderada-Intensa</td>
														<td>10-18% GR, 82-90% MLG</td>
														<td>Atletas generales equilibran potencia y resistencia en este rango.</td>
														<td><a href="https://jamanetwork.com/journals/jama/article-abstract/2776377" target="_blank">JAMA (2021)</a></td>
													</tr>
													<tr>
														<td>Rendimiento (Deportivo)</td>
														<td>♀️ con AF Moderada-Intensa</td>
														<td>18-25% GR, 75-82% MLG</td>
														<td>Refleja necesidades de rendimiento y salud en ♀️ atletas.</td>
														<td><a href="https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(21)00753-5/fulltext" target="_blank">Lancet (2021)</a></td>
													</tr>
													<tr>
														<td>Rendimiento (Deportivo)</td>
														<td>♂️ Atletas de Fuerza</td>
														<td>8-15% GR, 85-92% MLG</td>
														<td>Atletas de fuerza optimizan relación potencia-peso con 8-15% GR.</td>
														<td><a href="https://www.nejm.org/doi/full/10.1056/NEJMoa2115133" target="_blank">NEJM (2022)</a></td>
													</tr>
													<tr>
														<td>Rendimiento (Deportivo)</td>
														<td>♀️ Atletas de Fuerza</td>
														<td>15-22% GR, 78-85% MLG</td>
														<td>♀️ atletas de fuerza balancean fuerza con GR esencial (15-22%)</td>
														<td><a href="https://www.nature.com/articles/s41591-022-01845-6" target="_blank">Nature Medicine (2022)</a></td>
													</tr>
												</tbody>
											</table>
										</div>
									</div>
									<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
										</div>
								</div>
							</div>
						</div>

						<form id="weight-goal-form">
							<label for="current-fat-percentage">Grasa Corporal Actual (%):</label>
							<input type="number" id="current-fat-percentage" name="current-fat-percentage" step="0.1" min="3" max="60" required placeholder="Ej: 25">

							<label for="target-fat-percentage">Grasa Corporal Objetivo (%):</label>
							<input type="number" id="target-fat-percentage" name="target-fat-percentage" step="0.1" min="3" max="60" required placeholder="Ej: 15">
							
							<label for="target-muscle-percentage">Masa Muscular (%)</label>
							<input type="number" id="target-muscle-percentage" name="target-muscle-percentage" step="0.1" min="20" max="95"  placeholder="Ej: 70">

							<label for="desired-lean-mass-gain">Masa Muscular Objetivo Kg (	opcional):</label>
							<input type="number" id="desired-lean-mass-gain" name="desired-lean-mass-gain" step="0.1" min="0" placeholder="Ej: 2 (Dejar en blanco o 0 si no buscas ganar músculo)">

							<label for="is-athlete">¿Te consideras deportista/atleta?</label>
							<select id="is-athlete" name="is-athlete">
								<option value="no">No</option>
								<option value="yes">Sí</option>
							</select>

							<button type="submit" id="calculate-goal-button">Calcular Objetivo y Recomendaciones</button>
						</form>

						<div id="weight-goal-result" style="display:none;">
							<p class="info-message">Completa el Paso 1 para habilitar este cálculo.</p>
							
						</div>
					</div>
				</section>

			<section>
				
				<div class="plan-step" id="step-6"> <h2>3. Estimación de Tiempo (Manual y Opcional)</h2>
                    <p>Estima cuánto tiempo podría llevarte alcanzar un cambio de peso específico basándote en un déficit o superávit calórico semanal <strong>que tú definas</strong>. Este cálculo es independiente de la tabla automática del Paso 5 y se usa para la tabla manual del Paso 7.</p>
                    <form id="time-estimation-form">
                        <label for="weight-change-goal">Cambio de Peso Total Deseado (kg):</label>
                        <input type="number" id="weight-change-goal" name="weight-change-goal" step="0.1" required placeholder="Ej: -10 para perder, 5 para ganar">

                        <label for="weekly-calorie-diff">Diferencia Calórica Semanal Estimada (kcal):</label>
                        <input type="number" id="weekly-calorie-diff" name="weekly-calorie-diff" step="100" required placeholder="Ej: -3500 para perder 0.5kg/sem, 2000 para ganar">
                        

                      <button type="submit" id="estimate-time-button" >Estimar Tiempo</button>
						<a href="#"
							   data-bs-toggle="modal"
							   data-bs-target="#modalCalculadoraNoLineal"
							   class="target-icon-subtle"
							   style="display: none; align-items: center; gap: 5px; text-decoration: none; color: #28a745;">
								<i class="bi bi-clipboard2-data-fill" style="font-size: 1.2em; color: #28a745; transition: color 0.3s ease;"></i>
								<span class="text">Ver gráfico</span>
							</a>
					
					  <p></p>
					  
					   <div><small><strong>Nota:</strong> Se estima que 7700 kcal equivalen a 1 kg de grasa corporal. Para perdida gradual y sostenible no se aconseja perdidas de mas de 0.5kg/sem (3500kcal/sem). Para ganacia no se aconseja ganacias de mas de 0.3kg/sem (2000Kcal/sem) </small></div>
                      
                    </form>
					
					<div id="time-estimation-result" style="display:none;">
                         <p class="info-message">Completa los pasos 1 y 2 para habilitar esta estimación.</p>
                    </div>
					
                    <div id="time-estimation-chart-container">
						<canvas id="timeEstimationChart"></canvas>
					</div>
					
                </div>
				
					
			</section>
				
				
			<section>
                <div class="plan-step" id="step-3">
                    <h2>4. Calcula tus Macronutrientes</h2>

					<p>
						Una vez definido tu <strong>objetivo calórico diario</strong> (basado en tu Gasto Energético Total - GET y tu meta de pérdida, mantenimiento o ganancia de peso), 
						es momento de distribuir esas calorías entre los tres macronutrientes esenciales: 
						<strong>proteínas, carbohidratos y grasas</strong>.
					</p>

					<p>
						<strong style="color: #468A45;">Para pérdida de peso:</strong> 
						Se recomienda un déficit moderado del <strong>10–20%</strong> respecto a tu GET, 
						lo que permite una pérdida gradual, sostenible y con buena preservación de masa muscular. 
						<em>Nuestro cálculo automático se basa en un déficit del 10%, ideal para comenzar sin impactos metabólicos extremos.</em>
					</p>

					<p>
						<strong style="color: #468A45;">Para ganancia de peso:</strong> 
						Un superávit del <strong>5–15%</strong> sobre tu GET favorece la hipertrofia muscular con un control adecuado del aumento de grasa. 
						<em>El cálculo automático utiliza un superávit del 5%, óptimo para una ganancia muscular progresiva y de calidad.</em>
					</p>

					<p>
						<strong style="color: #468A45;">Tu ingesta diaria puede ajustarse dinámicamente</strong> según:
						<ul>
							<li>Tu nivel de Actividad Física (AF) y tipo de entrenamiento</li>
							<li>El <strong>ciclo nutricional</strong> en el que te encuentres (carga, mantenimiento, descarga)</li>
							<li>La <strong>estrategia específica</strong> adaptada a tu objetivo:</li>
						</ul>
					</p>

					<!-- Tabla de estrategias por objetivo -->
					<!-- Tabla de rangos y estrategias por objetivo -->
					<!-- Botón que abre el modal -->
						<div style="margin: 16px 0; font-size: 0.95em; line-height: 1.6;">
							<strong style="color: #468A45;">
								Según tu objetivo, se recomiendan los siguientes rangos y estrategias nutricionales:
							</strong>
							<button type="button" 
									class="btn p-0 ms-1" 
									data-bs-toggle="modal" 
									data-bs-target="#nutricionModal">
								<span style="color: #FF6D00; font-size: 1.3em; vertical-align: middle;">🎯</span>
							</button>
						</div>

						<!-- Modal -->
						<!-- Modal con ancho reducido en 10% -->
							<div class="modal fade" id="nutricionModal" tabindex="-1" aria-labelledby="nutricionModalLabel" aria-hidden="true">
								<div class="modal-dialog modal-xl" style="max-width: 70%; width: 45%;">
									<div class="modal-content" style="border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);">
										
										<!-- Encabezado con texto blanco garantizado -->
										<div class="modal-header" style="background: #108215;">
											<h5 class="modal-title" style="color: white !important; font-weight: 600;">
												<strong>🎯 Rangos y Estrategias Nutricionales por Objetivo</strong>
											</h5>
											<button type="button"
													class="text-white bg-transparent border-0 fs-4"
													data-bs-dismiss="modal"
													aria-label="Cerrar"
													style="font-weight: bold; outline: none; box-shadow: none;">
												×
											</button>
										</div>

										<!-- Cuerpo con scroll y tabla -->
										<div class="modal-body p-0" style="max-height: 70vh; overflow: hidden;">
											<div style="overflow-x: auto; max-height: 60vh;">
												<table style="
													width: 100%; 
													border-collapse: collapse; 
													font-size: 0.95em;
													background: #f9f9f9;
													min-width: 750px;
													box-shadow: 0 1px 3px rgba(0,0,0,0.1);
												">
													<thead style="position: sticky; top: 0; z-index: 1;">
														<tr style="background: #108215; color: white;">
															<th style="padding: 14px; text-align: left; font-weight: 600; min-width: 160px;">Objetivo</th>
															<th style="padding: 14px; text-align: left; font-weight: 600; min-width: 230px;">Rangos Recomendados</th>
															<th style="padding: 14px; text-align: left; font-weight: 600; min-width: 280px;">Estrategia Nutricional</th>
														</tr>
													</thead>
													<tbody>
														<!-- PÉRDIDA DE PESO (2 filas) -->
														<tr>
															<td rowspan="2" style="padding: 16px; background: #F1F8E9; font-weight: 700; color: #2E7D32; vertical-align: top;">
																<strong>Pérdida de peso</strong>
															</td>
															<td style="padding: 14px; background: #F1F8E9; border-bottom: 1px dashed #108215; vertical-align: top;">
																<strong>Cetogénica inicial:</strong><br>
																<strong>GR: 65–75%</strong><br>
																<strong>PT: 20–25%</strong> (1.8–2.6 g/kg)<br>
																<strong>HC: 5–10%</strong> (<50 g/día)
															</td>
															<td style="padding: 14px; background: #F1F8E9; border-bottom: 1px dashed #108215; vertical-align: top;">
																<strong>🎯 Enfoque:</strong> Cetosis inicial + hiperproteica<br>
																<strong>• Clave:</strong> Preservar masa muscular<br>
																<strong>• Estrategias:</strong> TKD, ciclos proteicos, ayuno
															</td>
														</tr>
														<tr style="background: #F1F8E9;">
															<td style="padding: 14px; border-bottom: 1px dashed #108215; vertical-align: top;">
																<strong>Transición:</strong><br>
																<strong>GR: 40–50%</strong><br>
																<strong>PT: 25–30%</strong><br>
																<strong>HC: 20–25%</strong> (100–150 g/día)
															</td>
															<td style="padding: 14px; border-bottom: 1px dashed #108215; vertical-align: top;">
																<strong>🎯 Enfoque:</strong> Recarga metabólica<br>
																<strong>• Clave:</strong> Sensibilidad a insulina<br>
																<strong>• Estrategias:</strong> Ciclado de carbohidratos
															</td>
														</tr>

														<!-- GANANCIA DE PESO -->
														<tr>
															<td style="padding: 16px; font-weight: 600; color: #2E7D32; background: #F9F9F9; vertical-align: top;">
																<strong>Ganancia de peso</strong>
															</td>
															<td style="padding: 14px; background: #FFFFFF; vertical-align: top;">
																<strong>GR: 25–35%</strong><br>
																<strong>PT: 25–30%</strong> (1.6–2.2 g/kg)<br>
																<strong>HC: 40–50%</strong> (300–500 g/día)
															</td>
															<td style="padding: 14px; background: #FFFFFF; vertical-align: top;">
																<strong>💪 Enfoque:</strong> Superávit controlado<br>
																<strong>• Clave:</strong> Síntesis proteica post-entreno<br>
																<strong>• Estrategias:</strong> CKD, timing nutricional
															</td>
														</tr>

														<!-- MANTENIMIENTO -->
														<tr>
															<td style="padding: 16px; font-weight: 600; color: #2E7D32; background: #F1F8E9; vertical-align: top;">
																<strong>Mantenimiento</strong>
															</td>
															<td style="padding: 14px; background: #F1F8E9; vertical-align: top;">
																<strong>GR: 30–35%</strong><br>
																<strong>PT: 20–25%</strong> (1.6–2.0 g/kg)<br>
																<strong>HC: 35–45%</strong> (200–300 g/día)
															</td>
															<td style="padding: 14px; background: #F1F8E9; vertical-align: top;">
																<strong>⚖️ Enfoque:</strong> Equilibrio flexible<br>
																<strong>• Clave:</strong> Adherencia a largo plazo<br>
																<strong>• Estrategias:</strong> Flexibilidad selectiva
															</td>
														</tr>

														<!-- MIXTO/COMBINADO -->
														<tr>
															<td style="padding: 16px; font-weight: 600; color: #2E7D32; vertical-align: top;">
																<strong>Plan mixto/combinado</strong>
															</td>
															<td style="padding: 14px; background: #F9F9F9; vertical-align: top;">
																• <strong>Volumen:</strong> HC 40–50%, PT 25–30%<br>
																• <strong>Definición:</strong> HC 10–25%, PT 25–35%<br>
																• <strong>Mant.:</strong> HC 30–40%, PT 20–25%
															</td>
															<td style="padding: 14px; vertical-align: top;">
																<strong>🔄 Enfoque:</strong> Periodización nutricional<br>
																<strong>• Estrategias:</strong> CKD avanzado, fases carga-descarga
															</td>
														</tr>
													</tbody>
												</table>
											</div>

											<!-- Nota al final -->
											<div class="p-3 bg-light" style="font-size: 0.95em; color: #555; border-top: 1px solid #eee;">
												<p class="mb-0">
													<strong>💡 Nota:</strong> Estas fases evolucionan con tu progreso. Ej: 
													<strong>Inducción Cetogénica → Ciclado Metabólico → Mantenimiento</strong> 
													para evitar el efecto rebote.
												</p>
											</div>
										</div>

										<!-- Footer -->
										<div class="modal-footer" style="background: #f8f9fa;">
											<button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">Cerrar</button>
										</div>
									</div>
								</div>
							</div>

						<!-- Recuadro de recordatorio -->
						<div style="
							background-color: #FFF3E0; 
							border: 1px solid #FFCC80;
							border-radius: 8px;
							padding: 14px 16px;
							margin: 16px 0;
							font-size: 0.95em;
							line-height: 1.6;
						">
							<em>
								<strong style="color: #468A45;">💡 Recuerda:</strong> 
								las calorías definen la dirección, pero los macronutrientes determinan la <strong>calidad</strong> del cambio.
							</em>
							<br>
							<em style="display: block; margin-top: 6px;">
								Tu plan se adapta a ti. La nutrición inteligente combina ciencia, flexibilidad y sostenibilidad.
							</em>
						</div>



                     <form id="macro-form">
                        
                            <div id="macro-percentage-inputs">
								<label>Ajuste Final de Kcal segun Objetivo:</label>
								<div class="input-group">
									<div class="input-item">
										<label for="get-calories">GET calculado (kcal):</label>
										<input type="number" id="get-calories" name="goal-calories" required min="500" placeholder="Kcal calculadas" readonly>
										<p class="percentage-info">Gasto Energético Total calculado</p>
									</div>
									
									<div class="input-item">
										<label for="goal-calories">Kcalorías/dia segun Objetivo
											
										</label>
										<input type="number" id="goal-calories" name="goal-calories" required min="500" placeholder="Kcal/dia" readonly>
										<p class="percentage-info">Ajuste según tu objetivo( 15% Perdida / 10% Ganancia)</p>
									</div>
									
									<div class="input-item">
										<label for="goal-caloriespc">% Perdida/Ganancia (kcal):</label>
										<input type="number" id="goal-caloriespc" name="goal-caloriespc" required min="1" placeholder="Introduce el % deseado">
										<p class="percentage-info">Ej: 10 para 10% de déficit o superávit</p>
									</div>
								</div>
								
								<h3>Distribución de Macronutrientes (% del total calórico):<h3>
								
								<div class="macro-visualization">
									<div class="macro-bars">
										<div class="protein-bar" style="width: 30%;"></div>
										<div class="carbs-bar" style="width: 40%;"></div>
										<div class="fat-bar" style="width: 30%;"></div>
									</div>
									
									<div class="macro-labels">
										<div class="macro-label protein-label">Proteína: 30%</div>
										<div class="macro-label carbs-label">Carbohidratos: 40%</div>
										<div class="macro-label fat-label">Grasas: 30%</div>
									</div>
								</div>
								
								<div class="total-display" id="macro-percentage-total">Total: 100%</div>
								
								
								
								<div class="input-group">
									<div class="input-item">
										<label for="protein-percentage">Proteína (%):</label>
										<input type="number" id="protein-percentage" name="protein-percentage" value="30" min="10" max="50" step="1">
										<p class="percentage-info">Recomendado: 25-35%</p>
									</div>
									
									<div class="input-item">
										<label for="carb-percentage">Carbohidratos (%):</label>
										<input type="number" id="carb-percentage" name="carb-percentage" value="40" min="1" max="80" step="1">
										<p class="percentage-info">Recomendado: 35-50%</p>
									</div>
									
									<div class="input-item">
										<label for="fat-percentage">Grasas (%):</label>
										<input type="number" id="fat-percentage" name="fat-percentage" value="30" min="10" max="90" step="1">
										<p class="percentage-info">Recomendado: 20-35%</p>
									</div>
								</div>
								
								
								

								<div id="chart-container">
									<canvas id="macroChart"></canvas>
								</div>
								
							</div>
							
                        <button type="submit" id="calculate-macros-button" >Calcular Gramos de Macronutrientes</button>
						<a href="#"
						   data-bs-toggle="modal"
						   data-bs-target="#macroChartModal"
						   class="target-icon-subtle"
						   style="display: none;">
						  <span class="icon">🎯</span>
						  <span class="text">Ver gráfico</span>
						</a>
    
                    </form>
                    <div id="macro-result" style="display:none;">
                        <p class="info-message">Completa los Pasos 2 y 3 para habilitar este cálculo.</p>
                    </div>
                    
                </div>
			</section>
			<section>
                <div class="plan-step" id="step-4">
                     <h2>5. Genera tu Plan de Comidas Orientativo</h2>
                     <p>Distribuye tus macronutrientes calculados en diferentes comidas a lo largo del día.</p>
                     <form id="meal-form">
                         <div id="meal-percentage-inputs">
                             <label>Distribución de Calorías por Comida (% del total diario):</label>
                             <div><label for="breakfast-perc">Desayuno:</label><input type="number" id="breakfast-perc" value="25" min="0" max="100" step="1"></div>
                             <div><label for="snack1-perc">Media Mañana:</label><input type="number" id="snack1-perc" value="10" min="0" max="100" step="1"></div>
                             <div><label for="lunch-perc">Almuerzo:</label><input type="number" id="lunch-perc" value="30" min="0" max="100" step="1"></div>
                             <div><label for="snack2-perc">Merienda:</label><input type="number" id="snack2-perc" value="10" min="0" max="100" step="1"></div>
                             <div><label for="dinner-perc">Cena:</label><input type="number" id="dinner-perc" value="25" min="0" max="100" step="1"></div>
                             <p id="meal-percentage-total"></p>
                         </div>
                         <button type="submit" id="generate-meals-button" >Generar Distribución por Comida</button>
                     </form>
                     <div id="meal-result" style="display:none;">
                         <p class="info-message">Completa el Paso 4 para habilitar este cálculo.</p>
                     </div>
                </div>
			</section>
                




			
		<section>
			<div class="plan-step" id="step-4">
					<h2>6.Planificación Diétetica</h2>
					<p>La sección "Ciclos Dietéticos" te permite personalizar tu plan nutricional definiendo fases específicas (como Inducción Cetogénica, Volumen Muscular, Mantenimiento) y seleccionando estrategias dietéticas avanzadas (como Carb Cycling, Refeed, Ayuno Intermitente). Su propósito es adaptar tu ingesta a diferentes objetivos en distintos períodos, optimizando resultados como la pérdida de grasa, la ganancia muscular o el mantenimiento del peso, mientras se mejora la adherencia y se pueden sortear mesetas. Esta personalización se refleja en las tablas de planificación temporal detalladas que se generan posteriormente.</p>
				</div>
				<div class="text-center mb-4">
					<button onclick="abrirModalMacros();" class="btn btn-primary btn-lg" aria-label="Ajustar y calcular macronutrientes" id="botonCalcular">
						🧮 Calcular Planificación
					</button>
				</div>
								<div class="card-body">
								<!-- Selects de Fase (inicialmente ocultos) -->
					                <label for="fasePerdida1" class="form-label" id="labelFasePerdida1" style="display:none;">Fase del Ciclo (Pérdida de Peso):</label>
					                <select id="fasePerdida1" class="form-control" aria-label="Fase de pérdida de peso">
										<option value="sel1">Selecciona Fase</option> 
					                    <option value="induccion_cetogenica1">Inducción Cetogénica</option>
					                    <option value="ciclado_metabolico1">Ciclado Metabólico</option>
					                    <option value="transicion_mantenimiento1">Transición a Mantenimiento</option>
					                </select>
									 <label for="faseGanancia1" class="form-label" id="labelFaseGanancia1" style="display:none;">Fase del Ciclo (Ganancia de Peso):</label>
					                <select id="faseGanancia1" class="form-control" aria-label="Fase de ganancia de peso">
										<option value="sel2">Selecciona Fase</option> 
					                    <option value="volumen1">Volumen Muscular</option>
					                    <option value="masa1">Enfocado en Masa Muscular</option>
					                </select>
					
					                <label for="enfoqueMantenimiento1" class="form-label" id="labelEnfoqueMantenimiento1" style="display:none;">Enfoque (Mantenimiento):</label>
					                <select id="enfoqueMantenimiento1" class="form-control" aria-label="Enfoque de mantenimiento">
										<option value="sel3">Selecciona Fase</option> 
					                    <option value="equilibrio1">Equilibrio Flexible</option>
					                    <option value="social1">Adherencia Social</option>
					                </select>
					
					                <label for="faseMixto1" class="form-label" id="labelFaseMixto1" style="display:none;">Fase del Ciclo (Mixto/Combinado):</label>
					                <select id="faseMixto1" class="form-control" aria-label="Fase de plan mixto">
										<option value="sel4">Selecciona Fase</option> 
					                    <option value="volumen1">Volumen</option>
					                    <option value="definicion1">Definición</option>
					                    <option value="mantenimiento1">Mantenimiento</option>
					                </select>
								</div>
								
					<!-- Nuevo card-body para Estrategias + Planificación -->			
				<div class="card-body">
				  <div class="row align-items-start">
					<!-- Columna izquierda: Estrategias Especiales -->
					<div class="col-md-6">
					  <div id="opcionesPerdida1" class="mt-3">
						<div class="row">
						  <div class="col-md-12">
						  <div class="card-header">
							<h5>Estrategias Especiales:</h5>
							</div>
							<div class="strategy-checkboxes" id="opcionesPerdida1">
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_ninguna" value="ninguna" checked>
								<label class="form-check-label" for="estrategia_ninguna">Cetosis estricta (<50g HC/día)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_tkd" value="tkd">
								<label class="form-check-label" for="estrategia_tkd">TKD (25-50g HC pre/post entreno)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_ckd" value="ckd">
								<label class="form-check-label" for="estrategia_ckd">CKD (2 días carb-loading 150-500g HC)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_if_16_8" value="if_16_8">
								<label class="form-check-label" for="estrategia_if_16_8">IF 16:8 (Ventana de alimentación 8 horas)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_refeed" value="refeed">
								<label class="form-check-label" for="estrategia_refeed">Refeed (1-2 días/semana HC alto)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_hiperproteica" value="hiperproteica">
								<label class="form-check-label" for="estrategia_hiperproteica">Hiperproteica (1.8-2.5 g/kg peso proteína)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_carb_cycling" value="carb_cycling">
								<label class="form-check-label" for="estrategia_carb_cycling">Carb Cycling (Días altos/bajos HC)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_protein_cycling" value="protein_cycling">
								<label class="form-check-label" for="estrategia_protein_cycling">Protein Cycling (4 semanas altas + 1 baja proteína)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_timing" value="timing">
								<label class="form-check-label" for="estrategia_timing">Timing Nutricional (HC post-entreno)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_flexible_dieting" value="flexible_dieting">
								<label class="form-check-label" for="estrategia_flexible_dieting">Flexible Dieting (80/20 regla)</label>
							  </div>
							</div>
						  </div>
						</div>
					  </div>
					  <div id="opcionesGanancia1" class="mt-3" style="display:none;">
						<div class="row">
						  <div class="col-md-12">
						  <div class="card-header">
							<h5>Estrategias Especiales:</h5>
							</div>
							<div class="strategy-checkboxes" id="opcionesGanancia1">
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_ganancia_ninguna" value="ninguna" checked>
								<label class="form-check-label" for="estrategia_ganancia_ninguna">Ninguna (Balance HC/proteína)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_ganancia_carb_cycling" value="carb_cycling">
								<label class="form-check-label" for="estrategia_ganancia_carb_cycling">Carb Cycling (Días altos/moderados HC)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_ganancia_refeed" value="refeed">
								<label class="form-check-label" for="estrategia_ganancia_refeed">Refeed (Días altos HC semanales)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_ganancia_timing" value="timing">
								<label class="form-check-label" for="estrategia_ganancia_timing">Timing Nutricional (HC post-entreno)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_ganancia_flexible_dieting" value="flexible_dieting">
								<label class="form-check-label" for="estrategia_ganancia_flexible_dieting">Flexible Dieting (80/20 regla)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_ganancia_ckd" value="ckd_ganancia">
								<label class="form-check-label" for="estrategia_ganancia_ckd">CKD: 5+2 approach para optimizar glucógeno</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_ganancia_timing_nutricional" value="timing_nutricional_ganancia">
								<label class="form-check-label" for="estrategia_ganancia_timing_nutricional">Timing nutricional: Proteína post-entreno</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_ganancia_carb_loading" value="carb_loading_ganancia">
								<label class="form-check-label" for="estrategia_ganancia_carb_loading">Carb-loading: Días previos a entrenos intensos</label>
							  </div>
							</div>
						  </div>
						</div>
					  </div>
					  <div id="opcionesMantenimiento1" class="mt-3" style="display:none;">
						<div class="row">
						  <div class="col-md-12">
						  <div class="card-header">
							<h5>Estrategias Especiales:</h5>
							</div>
							<div class="strategy-checkboxes" id="opcionesMantenimiento1">
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_mantenimiento_ninguna" value="ninguna" checked>
								<label class="form-check-label" for="estrategia_mantenimiento_ninguna">Ninguna (Equilibrio nutricional)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_mantenimiento_flexible_dieting" value="flexible_dieting">
								<label class="form-check-label" for="estrategia_mantenimiento_flexible_dieting">Flexible Dieting (80/20 regla)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_mantenimiento_if_16_8" value="if_16_8">
								<label class="form-check-label" for="estrategia_mantenimiento_if_16_8">IF 16:8 (Ventana de alimentación 8 horas)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_mantenimiento_refeed" value="refeed">
								<label class="form-check-label" for="estrategia_mantenimiento_refeed">Refeed (Días altos HC)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_mantenimiento_carb_cycling" value="carb_cycling">
								<label class="form-check-label" for="estrategia_mantenimiento_carb_cycling">Carb Cycling (Días altos/bajos HC)</label>
							  </div>
							</div>
						  </div>
						</div>
					  </div>
					  <div id="opcionesMixto1" class="mt-3" style="display:none;">
						<div class="row">
						  <div class="col-md-12">
							<div class="card-header">
							<h5>Estrategias Especiales:</h5>
							</div>
							<div class="strategy-checkboxes" id="opcionesMixto1">
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_mixto_ninguna" value="ninguna" checked>
								<label class="form-check-label" for="estrategia_mixto_ninguna">Ninguna (Balance nutricional)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_mixto_carb_cycling" value="carb_cycling">
								<label class="form-check-label" for="estrategia_mixto_carb_cycling">Carb Cycling (Días altos/bajos HC)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_mixto_refeed" value="refeed">
								<label class="form-check-label" for="estrategia_mixto_refeed">Refeed (Días altos HC)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_mixto_flexible_dieting" value="flexible_dieting">
								<label class="form-check-label" for="estrategia_mixto_flexible_dieting">Flexible Dieting (80/20 regla)</label>
							  </div>
							  <div class="form-check">
								<input class="form-check-input" type="checkbox" id="estrategia_mixto_timing" value="timing">
								<label class="form-check-label" for="estrategia_mixto_timing">Timing Nutricional (HC post-entreno)</label>
							  </div>
							</div>
						  </div>
						</div>
					  </div>
					<div class="text-center mb-6">
						<br style="height: 30px; display: block; content: '';">
						<button onclick="abrirModalMacros();" class="btn btn-primary btn-lg" aria-label="Ajustar y calcular macronutrientes" style="display: none;" id="calcularPlanificacionBtn">
							🧮 Calcular Planificación
						</button>
					</div
						
			</div>
					
					<!-- Columna derecha: Planificación Temporal -->
					<div class="col-md-6" id="planificacion-temporal" style="display:none;">
					  <div class="card mb-3">
						<div class="card-header">
						  <h5>Planificación Temporal</h5>
						</div>
						<div class="card-body">
						  <label for="periodoPlanificacion" class="form-label">Período de Planificación:</label>
						  <select id="periodoPlanificacion" class="form-control" aria-label="Período de planificación">
							<option value="semanal">Semanal (4 semanas)</option>
							<option value="mensual">Mensual (12 semanas)</option>
						  </select>
						</div>
					  </div>
					  <<div id="resultados" class="card" style="display:none;">
						<div class="card-header">
						  <h5>📊 Resultados de tu Plan Nutricional</h5>
						</div>
						<div class="card-body">
						  
						  <ul class="list-unstyled">
							<li><strong>GET:</strong> <span id="gastoEnergetico"></span> kcal/día</li>
							<li><strong>Kcal/día Objetivo:</strong> <span id="calorias"></span> kcal</li>
							<li><strong>PT:</strong> <span id="proteinas"></span>g (<span id="proteinasPct"></span>%)</li>
							<li><strong>CH:</strong> <span id="carbohidratos"></span>g (<span id="carbohidratosPct"></span>%)</li>
							<li><strong>GR:</strong> <span id="grasas"></span>g (<span id="grasasPct"></span>%)</li>
						  </ul>
						</div>
					  </div>
					</div>
					
				 
				
						<!---<div id="resultados" class="card" style="display:none;"> --->
				  
					  <div class="col-md-6" style='display:none';>
								<canvas id="chartMacros" width="300" height="300" aria-label="Gráfico de distribución de macronutrientes"></canvas>
					  </div>
					  </div
			
					<div class="mt-3" style='display:none'>
						<h6>📋 Recomendaciones Específicas</h6>
						<div id="recomendaciones" class="alert alert-info"></div>
					</div>
				</div>
				
			</section>
			
			<section>			
			<!-- Resultados y Planificación Temporal (HTML existente) -->
			<div class="card">
			<div class="mt-3" >
			<div class="card-header d-flex justify-content-between align-items-start">
				<!-- Texto (título + subtítulo) a la izquierda -->
				<div class="d-flex flex-column">
					<h2 class="mb-0">
						<i class="fas fa-list-alt icono-fase"></i> Planificación General del Proceso
					</h2>
					<p class="mb-0 mt-1">
						<small>Basada en tu objetivo y el tiempo estimado del Paso 3.</small>
					</p>
				</div>

				<!-- Botón a la derecha -->
				<button class="btn btn-sm btn-outline-secondary" id="btnColapsarTodo" >
					<i class="fas fa-bars"></i> Colapsar Todo
				</button>
			</div>
			
			
			
			
		<div class="card-body">
			<!-- Sección para la Tabla General del Proceso -->
			<div id="tablaGeneralProcesoContainer" class="card mb-4">
				
				
				
			</div>

			<!-- Sección para la Tabla Específica (Planificación Temporal Original) -->
			<div id="planificacionTemporal" class="card" style="display:none;">
				<div class="card-header">
					<h2>📅 Planificación Temporal Específica</h2> <!-- Título modificado para diferenciar -->
					<p class="mb-0"><small>Basada en el período seleccionado (semanal/mensual).</small></p> <!-- Subtítulo añadido -->
				<</div> 
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-striped table-bordered" aria-label="Tabla de planificación nutricional">
							<thead class="table-dark"> <!-- Añadido estilo de encabezado oscuro -->
								<tr>
									<th scope="col">Semana</th>
									<th scope="col">Fase</th>
									<th scope="col">Strategy</th>
									<th scope="col">Kcal</th>
									<th scope="col">PT (%)</th>
									<th scope="col">CH (%)</th>
									<th scope="col">GR (%)</th>
									<th scope="col">PT (g)</th>
									<th scope="col">CH (g)</th>
									<th scope="col">GR (g)</th>
									<th scope="col">AF/sem</th>
									<th scope="col">Notas</th>
								</tr>
							</thead>
							<tbody id="tablaPlanificacionBody"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Contenedor para la Tabla Detallada de Fase Seleccionada -->
			<div id="tablaDetalladaFaseContainer" class="mt-4 card" style="display:none;"> <!-- Añadido estilo de tarjeta y oculto por defecto -->
				<div class="card-header">
					<h5>🔍 Detalles de la Fase Seleccionada</h5> <!-- Título del contenedor -->
					<p class="mb-0"><small>Desglose semanal detallado basado en la fase general.</small></p> <!-- Subtítulo -->
					<p class="info-message">Selecciona una fase en la "Planificación General del Proceso" para ver su desglose semanal detallado.</p>
				</div>
				<div class="card-body">
					<!-- El contenido de la tabla detallada se generará aquí -->
					
				</div>
			</div>
		</div>
	</section>
		
			<section>
                <h2>7. Tabla de Ciclos y Breaks (Automática)</h2>
                    <p>Esta tabla muestra una estructura detallada y orientativa de ciclos de carga-descarga proteica, incluyendo fases de déficit o superávit y descansos (breaks) a mantenimiento. Los valores se basan en los cálculos automáticos de los Pasos 1, 2 y 3.</p>
                    <div id="step-5-results"> <div id="detailed-cycle-table-container"></div>   
                    </div>
			</section>	
			
		    <section>
					<h2>8. Tabla de Ciclos Hiperproteicos (Manual)</h2>
                    <p>Esta tabla organiza ciclos hiperproteicos (Consumo alto, entre 30-40%) y breaks (Consumo moderado, entre 15-25%), cuya duración se basa en la estimación temporal manual del Paso 6. La cantidad de proteína objetivo para cada fase se calcula aplicando porcentajes específicos sobre las Kcal/día asignadas (un porcentaje más alto para la fase hiperproteica (35%) y uno más bajo para la fase de break(20%)).".</p>
					<p>la velocidad de perdida indicada en kg/semana está basada en el ajuste constante de deficit calorico semanal, señalado en el paso 6. Para la fase hiperproteica se mantiene ese ritmo de perdida semanal y se reduduce a la mitad en la fase de Descanso. El progreso real puede variar.</p>
                    <div id="hyperprotein-cycle-table-container">
                        
                        <table id="hyperprotein-cycle-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Ciclo</th>
                                    <th>Fase</th>
                                    <th>Semanas</th>
                                    <th>Peso (kg) <br>(Inicio → Fin)</th>
									<th>Kcal/día/AF</th>
                                    <th>Proteínas (g/kg)</th>
                                    <th>Notas</th>
                                </tr>
                            </thead>
                            <tbody id="hyperprotein-cycle-table-body">
                                </tbody>
                        </table>
                        <div id="hyperprotein-note-container"></div> </div>
						
						<div class="text-center mb-4">
                     <button id="generate-hyperprotein-button" onclick="generateHyperproteinCycles()" style="margin-top: 15px;" >
                        Generar Tabla de Ciclos Hiperproteicos (Manual)
                    </button>
					</div>
						
						<div><button id="save-pdf-button" style="margin-top: 30px; background-color: #0275d8; width: auto; padding: 12px 25px; display: block; margin-left: auto; margin-right: auto;" >Guardar Plan como PDF</button></div>
					
					
				</div>
								
					
					
				
		</section>

						<!-- SECCION MODALS-->		
						<!-- Modal para ajuste manual de macros -->
						<div class="modal fade" id="modalMacros" tabindex="-1" aria-labelledby="modalMacrosLabel" aria-hidden="true">
							<div class="modal-dialog modal-lg">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="modalMacrosLabel">Ajuste de Macronutrientes</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>
									<div class="modal-body">
										<p><strong>Objetivo:</strong> <span id="modal-objetivo">No seleccionado</span></p>
										<p><strong>Fase:</strong> <span id="modal-fase">No seleccionada</span></p>

										<div id="modal-warning" class="alert alert-warning" style="display:none;">
											Por favor, selecciona primero un objetivo y una fase.
										</div>

										<div id="modal-content" style="display:none;">
											<p>Arrastra los controles para ajustar los porcentajes. Recomendamos valores cercanos al rango óptimo para tu fase.</p>

											<div class="mb-3">
												<label for="proteinasRange">Proteínas <span id="proteinasValue">25</span>%</label>
												<input type="range" class="form-range" id="proteinasRange" min="10" max="50" value="25">
												<small>Rango recomendado: <span id="proteinasRango">20-30%</span></small>
											</div>

											<div class="mb-3">
												<label for="carbohidratosRange">Carbohidratos <span id="carbohidratosValue">40</span>%</label>
												<input type="range" class="form-range" id="carbohidratosRange" min="5" max="70" value="40">
												<small>Rango recomendado: <span id="carbohidratosRango">10-50%</span></small>
											</div>

											<div class="mb-3">
												<label for="grasasRange">Grasas <span id="grasasValue">35</span>%</label>
												<input type="range" class="form-range" id="grasasRange" min="15" max="100" value="35">
												<small>Rango recomendado: <span id="grasasRango">25-70%</span></small>
											</div>

											<div class="alert alert-info">
												<strong>Consejo:</strong> <span id="modal-consejo">Selecciona una fase para ver recomendaciones.</span>
											</div>
										</div>
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
										<button type="button" class="btn btn-primary" id="guardarMacros">Guardar y Calcular</button>
									</div>
								</div>
							</div>
						</div>
						<!-- Modal para Incompatibilidad de Estrategias -->
							<div id="modalIncompatibilidad" class="modal" tabindex="-1" role="dialog" style="display: none;">
							  <div class="modal-dialog modal-lg" role="document"> <!-- modal-lg para más espacio -->
								<div class="modal-content">
								  <div class="modal-header">
									<h5 class="modal-title">⚠️ Estrategias Incompatibles Seleccionadas</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar" onclick="cerrarModal('modalIncompatibilidad')"></button>
								  </div>
								  <div class="modal-body">
									<p id="mensajeIncompatibilidad">
									  <!-- El mensaje se llenará dinámicamente -->
									</p>
									<hr>
									<h6>Guía de Compatibilidad Sugerida:</h6>
									<div id="guiaCompatibilidad">
										<!-- La guía se llenará dinámicamente -->
									</div>
									<hr>
									<p><strong>¿Quieres definir manualmente los macronutrientes para tus estrategias?</strong></p>
									<p>Puedes hacerlo pulsando el botón de abajo. Esto te permitirá personalizar los valores incluso si las estrategias iniciales son incompatibles según nuestra lógica automática.</p>
								  </div>
								  <div class="modal-footer">
									<button type="button" class="btn btn-secondary" onclick="cerrarModal('modalIncompatibilidad')">Aceptar y Corregir</button>
									<button type="button" class="btn btn-primary" onclick="abrirModalConfiguracionManual()">Configurar Macros Manualmente</button>
									<!-- Botón oculto por ahora, se puede activar si se implementa "Forzar Combinación"
									<button type="button" class="btn btn-warning" style="display:none;">Forzar Combinación (Avanzado)</button>
									-->
								  </div>
								</div>
							  </div>
							</div>

							<!-- Modal para Configuración Manual de Macronutrientes -->
							<div id="modalConfiguracionManual" class="modal" tabindex="-1" role="dialog" style="display: none;">
							  <div class="modal-dialog modal-xl" role="document"> <!-- modal-xl para mucho contenido -->
								<div class="modal-content">
								  <div class="modal-header">
									<h5 class="modal-title">⚙️ Configuración Manual de Macronutrientes por Fase</h5>
									<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar" onclick="cerrarModal('modalConfiguracionManual')"></button>
								  </div>
								  <div class="modal-body">
									<p>Define los porcentajes de macronutrientes para tus estrategias seleccionadas. <strong>La suma debe ser 100% para cada estrategia.</strong></p>
									<form id="formConfiguracionManual">
										<div id="contenedorEntradasManuales">
											<!-- Los bloques de entrada se generarán aquí dinámicamente -->
											<!-- Ejemplo de bloque (se generará por JS):
											<div class="bloque-estrategia-manual mb-3 p-3 border rounded" data-estrategia="nombre_estrategia">
												<h6>Estrategia: <span class="nombre-estrategia">nombre_estrategia</span></h6>
												<div class="row">
													<div class="col-md-4">
														<label for="manual_proteina_nombre_estrategia" class="form-label">Proteína (%)</label>
														<input type="number" class="form-control input-macro-manual" id="manual_proteina_nombre_estrategia" name="manual_proteina_nombre_estrategia" min="0" max="100" value="25" required>
													</div>
													<div class="col-md-4">
														<label for="manual_carbohidratos_nombre_estrategia" class="form-label">Carbohidratos (%)</label>
														<input type="number" class="form-control input-macro-manual" id="manual_carbohidratos_nombre_estrategia" name="manual_carbohidratos_nombre_estrategia" min="0" max="100" value="40" required>
													</div>
													<div class="col-md-4">
														<label for="manual_grasas_nombre_estrategia" class="form-label">Grasas (%)</label>
														<input type="number" class="form-control input-macro-manual" id="manual_grasas_nombre_estrategia" name="manual_grasas_nombre_estrategia" min="0" max="100" value="35" required>
													</div>
												</div>
												<div class="total-macro-manual mt-2">
													<strong>Total: <span class="valor-total">100</span>%</strong>
													<span class="estado-total text-success" style="display:none;">✓ Correcto</span>
													<span class="estado-total text-danger" style="display:none;">✗ Debe ser 100%</span>
												</div>
											</div>
										
										</div>
									</form>
									<div id="errorConfiguracionManual" class="alert alert-danger mt-3" style="display: none;">
										<!-- Mensajes de error específicos se mostrarán aquí -->
									</div>
										<div id="opcionesRecomposicion" class="mb-3">
											<label class="form-label"><strong>Días de entrenamiento:</strong></label><br>
											<input type="checkbox" id="training-day-Lunes" value="Lunes" checked> Lunes
											<input type="checkbox" id="training-day-Martes" value="Martes"> Martes
											<input type="checkbox" id="training-day-Miércoles" value="Miércoles" checked> Miércoles
											<input type="checkbox" id="training-day-Jueves" value="Jueves"> Jueves
											<input type="checkbox" id="training-day-Viernes" value="Viernes" checked> Viernes
											<input type="checkbox" id="training-day-Sábado" value="Sábado"> Sábado
											<input type="checkbox" id="training-day-Domingo" value="Domingo"> Domingo
										</div>
								  </div>
								  <div class="modal-footer">
									<button type="button" class="btn btn-secondary" onclick="cerrarModal('modalConfiguracionManual')">Cancelar</button>
									<button type="button" class="btn btn-success" onclick="aplicarConfiguracionManual()">Aplicar y Calcular</button>
								  </div>
								</div>
							  </div>
							</div>

							<div class="modal fade" id="macroChartModal" tabindex="-1" aria-labelledby="macroChartModalLabel" aria-hidden="true">
								<div class="modal-dialog modal-lg">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title" id="macroChartModalLabel">Distribución de Macronutrientes</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">
											<div id="modal-chart-container" style="height: 400px;">
												<canvas id="macroChartModalCanvas"></canvas>
											</div>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
										</div>
									</div>
								</div>
							</div>
							
							<!-- Modal con estilo verde -->
							
	<!-- Modal de la Calculadora No Lineal -->
	<div class="modal fade" id="modalCalculadoraNoLineal" tabindex="-1" aria-labelledby="modalCalculadoraNoLinealLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl">
			<div class="modal-content">
				<!-- Header del modal -->
				<div class="modal-header" style="background: linear-gradient(135deg, #3a0ca3 0%, #4361ee 100%); color: white;">
					<h5 class="modal-title" id="modalCalculadoraNoLinealLabel">📊 Calculadora No Lineal de Progreso Corporal</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				
				<!-- Body del modal -->
				<div class="modal-body">
					<p class="text-center mb-3 opacity-75">Modelo MEPNL v2.1 - Cálculo realista de tiempo y progreso</p>
					
					<!-- Formulario de entrada -->
					<div class="card form-card mb-4">
						<div class="card-body">
							<h5 class="mb-3">⚙️ Parámetros de Entrada</h5>
							<div class="row">
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">Objetivo de peso (kg)</label>
										<input type="number" class="form-control" id="weightGoalModal" value="-5" step="0.1">
										<div class="form-text">Negativo para pérdida, positivo para ganancia</div>
									</div>
									<div class="mb-3">
										<label class="form-label">Déficit/Superávit semanal (kcal)</label>
										<input type="number" class="form-control" id="weeklyCalorieDiffModal" value="-3500">
									</div>
									<div class="mb-3">
										<label class="form-label">Peso actual (kg)</label>
										<input type="number" class="form-control" id="currentWeightModal" value="70" step="0.1">
									</div>
								</div>
								<div class="col-md-6">
									<div class="mb-3">
										<label class="form-label">Género</label>
										<select class="form-select" id="userGenderModal">
											<option value="male">Hombre</option>
											<option value="female" selected>Mujer</option>
										</select>
									</div>
									<div class="mb-3">
										<label class="form-label">Edad</label>
										<input type="number" class="form-control" id="userAgeModal" value="35">
									</div>
									<div class="mb-3">
										<label class="form-label">% Grasa corporal</label>
										<input type="number" class="form-control" id="currentFatPercModal" value="28" step="0.1">
									</div>
									<div class="mb-3">
										<label class="form-label">Nivel de actividad</label>
										<select class="form-select" id="activityLevelModal">
											<option value="sedentario">Sedentario</option>
											<option value="leve" selected>Leve</option>
											<option value="moderate">Moderado</option>
											<option value="active">Activo</option>
											<option value="very-active">Muy activo</option>
										</select>
									</div>
									<div class="form-check mb-3">
										<input class="form-check-input" type="checkbox" id="isAthleteModal">
										<label class="form-check-label">¿Eres deportista/atleta?</label>
									</div>
								</div>
							</div>
							<div class="text-center">
								<button onclick="guardarYCalcularModal(event)">Calcular progreso</button>
							</div>
						</div>
					</div>

					

					
				
					<!-- Footer del modal -->
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
						
					</div>
				</div>
			</div>
		</div>
		
		<!-- Modal para mostrar la tabla de progreso -->
<div class="modal fade" id="modalTablaProgreso" tabindex="-1" aria-labelledby="modalTablaProgresoLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      
      <!-- Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, #568a3d 0%, #3c9141 100%); color: white;">
        <h5 class="modal-title" id="modalTablaProgresoLabel">📈 Progreso Semanal Detallado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        
         <h3 class="text-center" style="font-family: 'Roboto', sans-serif;">
			<strong>Evolución estimada semana a semana basada en el modelo MEPNL v2.1</strong>
		</h3>

        <!-- Contenedor de Resultados -->
        <div class="border rounded p-4 mb-4 bg-light" style="font-size: 0.95rem;">
          <h3 class="text-success mb-3"><i class="bi bi-clipboard2-check"></i> Resultados del Análisis</h3>

          <div class="row g-3">
            <div class="col-12">
              <h4 class="text-secondary">📌 Resumen del Plan</h4>
              <p id="resumen-plan-modal" class="mb-0 text-dark"></p>
            </div>

            <div class="col-12">
              <h4 class="text-secondary">⚡ Velocidad de Cambio</h4>
              <p id="resumen-velocidad-modal" class="mb-0 text-dark"></p>
            </div>
          </div>
        </div>
        <!-- Fin del contenedor de Resultados -->

        <!-- Contenedor de la tabla -->
        <div id="tabla-progreso-container-modal">
          <div class="alert alert-info text-center">
            <p>Calculando progreso... este contenedor se llenará automáticamente.</p>
          </div>
        </div>

      </div> <!-- Fin del modal-body -->

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" onclick="exportarTablaProgreso()">
          Exportar Tabla
        </button>
      </div>

    </div> <!-- Fin del modal-content -->
  </div> <!-- Fin del modal-dialog -->
</div> <!-- Fin del modal -->
		
		
		
		
    </main>
<!-- Coloca este div en tu archivo HTML -->

    <footer>
        <p>&copy; 2024 NutriPlan - Herramienta de planificación dietética orientativa. Consulta siempre a un profesional.</p>
    </footer>
	
	
 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Global variables ---
        // Basic user data
        let userAge = null;
        let userGender = 'male';
        let userHeightCm = null;
        let userActivityLevel = 'sedentary';
        let currentWeightKg = null;

        // Calculated values from Step 1 & 2
        let calculatedBMR = null;
        let calculatedTDEE = null; // Total Daily Energy Expenditure (GET) from Step 1 
        let targetWeightKgGlobal = null;
        let goalTypeGlobal = 'maintenance'; // 'loss', 'gain', 'maintenance'
        let estimatedWeeksGlobal = 0; // Automatically estimated weeks from Step 2 (for Step 5 table)
        let targetWeeklyRateKgGlobal = 0; // Automatically estimated weekly rate from Step 2 (for Step 5 table)

        // Calculated values from Step 3
        let calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 };

        // Calculated values from Step 6 (Manual Estimation)
        let estimatedWeeksManualGlobal = null; // Weeks from manual estimation
        let weightChangeGoalManualGlobal = null; // Weight change goal from manual estimation
        let weeklyCalorieDiffManualGlobal = null; // Weekly calorie diff from manual estimation

        // Chart instances
        let macroChartInstance = null;
        let weightEvolutionChartInstance = null; // For Step 2 chart
        let timeEstimationChartInstance = null; // For Step 6 chart

        // Activity multipliers (defined globally for reuse)
        //const activityMultipliers = { sedentary: 1.2, light: 1.56, moderate: 1.78, active: 2.1, very_active: 2.3 };
		//const activityMultipliers = userGender === 'male' ? [1.2, 1.56, 1.78, 2.1, 2.3] : [1.2, 1.55, 1.64, 1.82, 2];
		// Define multiplicadores por género usando valores numéricos
			const maleActivityMultipliers = {
			    '1.2': 1.2,    // sedentary
			    '1.375': 1.56, // light
			    '1.55': 1.78,  // moderate
			    '1.725': 2.1,  // active
			    '1.9': 2.3     // very_active
			};
			
			const femaleActivityMultipliers = {
			    '1.2': 1.2,    // sedentary
			    '1.375': 1.55, // light
			    '1.55': 1.64,  // moderate
			    '1.725': 1.82, // active
			    '1.9': 2.0     // very_active
			};
			
			// Selecciona el objeto según el género
			const activityMultipliers = userGender === 'male' ? maleActivityMultipliers : femaleActivityMultipliers;
        // --- Wait for the DOM to be fully loaded ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Element References ---
            // Forms
            const calorieForm = document.getElementById('calorie-form');
            const weightGoalForm = document.getElementById('weight-goal-form');
            const macroForm = document.getElementById('macro-form');
            const mealForm = document.getElementById('meal-form');
            const timeEstimationForm = document.getElementById('time-estimation-form');
            // Buttons
            const calculateGoalButton = document.getElementById('calculate-goal-button');
            const calculateMacrosButton = document.getElementById('calculate-macros-button');
            const generateMealsButton = document.getElementById('generate-meals-button');
            const estimateTimeButton = document.getElementById('estimate-time-button');
            const generateHyperproteinButton = document.getElementById('generate-hyperprotein-button'); // Reference to the button
            const savePdfButton = document.getElementById('save-pdf-button');
            // Percentage Inputs (for live update listeners)
            const macroPercentageInputs = document.querySelectorAll('#macro-percentage-inputs input[type="number"]');
            const mealPercentageInputs = document.querySelectorAll('#meal-percentage-inputs input[type="number"]');
            // Result Divs
            const calorieResultDiv = document.getElementById('calorie-result');
            const energyBalanceResultDiv = document.getElementById('energy-balance-result');
            const weightGoalResultDiv = document.getElementById('weight-goal-result');
            const weightChartContainer = document.getElementById('weight-chart-container');
            const macroResultDiv = document.getElementById('macro-result');
            const chartContainer = document.getElementById('chart-container'); // For macro chart
            const mealResultDiv = document.getElementById('meal-result');
            const timeEstimationResultDiv = document.getElementById('time-estimation-result');
            const timeChartContainer = document.getElementById('time-estimation-chart-container'); // For manual estimation chart
            const step5TableContainer = document.getElementById('detailed-cycle-table-container'); // Auto table container (Step 5)
            // Step 7 Elements
            const hyperproteinTableContainer = document.getElementById('hyperprotein-cycle-table-container');
            const hyperproteinTable = document.getElementById('hyperprotein-cycle-table');
            const hyperproteinTableBody = document.getElementById('hyperprotein-cycle-table-body');
            const hyperproteinInfoMessage = document.getElementById('hyperprotein-info-message');
            const hyperproteinNoteContainer = document.getElementById('hyperprotein-note-container');
            // Percentage Total Displays
            const macroPercentageTotalDiv = document.getElementById('macro-percentage-total');
            const mealPercentageTotalDiv = document.getElementById('meal-percentage-total');
            // Input Fields to Update
            const goalCaloriesInput = document.getElementById('goal-calories');
            const proteinPercentageInput = document.getElementById('protein-percentage');
            const carbPercentageInput = document.getElementById('carb-percentage');
            const fatPercentageInput = document.getElementById('fat-percentage');
			const targetMusclePercInput = document.getElementById('target-muscle-percentage');
			const targetMusclePerc = parseFloat(targetMusclePercInput.value);

            // --- Utility Functions ---
            /**
             * Displays an error message in a specified container.
             * @param {HTMLElement} container - The DOM element to display the message in.
             * @param {string} message - The error message text.
             */
            function displayError(container, message) {
                if (container) {
                    container.innerHTML = `<p class="error-message">${message}</p>`;
                } else {
                    console.error("Error container not found for message:", message);
                }
            }

            /**
             * Displays an informational message in a specified container.
             * @param {HTMLElement} container - The DOM element to display the message in.
             * @param {string} message - The info message text.
             */
            function displayInfo(container, message) {
                if (container) {
                    container.innerHTML = `<p class="info-message">${message}</p>`;
                } else {
                     console.error("Info container not found for message:", message);
                }
            }

            /**
             * Clears the content of a specified container.
             * @param {HTMLElement} container - The DOM element to clear.
             */
            function clearContainer(container) {
                if (container) {
                    container.innerHTML = '';
                }
            }

            /**
             * Updates the enabled/disabled state of buttons based on completed steps.
             */
            function updateButtonStates() {
                const step1Done = calculatedTDEE !== null && currentWeightKg !== null;
                const step2Done = step1Done && targetWeightKgGlobal !== null;
                const step3Done = step2Done && calculatedMacros.goalCalories > 0;
                const step6Done = step1Done && estimatedWeeksManualGlobal !== null && estimatedWeeksManualGlobal > 0; // Step 6 (Manual Estimation) is done

                // Enable/disable step buttons
                if (calculateGoalButton) calculateGoalButton.disabled = !step1Done;
                if (calculateMacrosButton) calculateMacrosButton.disabled = !step2Done;
                if (generateMealsButton) generateMealsButton.disabled = !step3Done;
                if (estimateTimeButton) estimateTimeButton.disabled = !step1Done; // Step 6 only needs Step 1
                if (generateHyperproteinButton) generateHyperproteinButton.disabled = !step6Done; // Step 7 needs Step 6

                // Enable/disable PDF button if at least Step 1 is done
                if (savePdfButton) savePdfButton.disabled = !step1Done;
            }

            // --- Step 1: Calculate TDEE and Energy Balance ---
            // --- Step 1: Calculate TDEE and Energy Balance ---


			function estimateBodyFat(bmi, userAge, userGender) {
			let estimatedBodyFat;
			if (userGender === 'male') {
				estimatedBodyFat = (1.20 * bmi) + (0.23 * userAge) - 16.2;
			} else {
				estimatedBodyFat = (1.20 * bmi) + (0.23 * userAge) - 5.4;
			}
			return userGender === 'male'
				? Math.max(6, Math.min(40, estimatedBodyFat))
				: Math.max(16, Math.min(50, estimatedBodyFat));
		}

// --- Main calculation function ---
function calculateCalories() {
    // Clear previous results
    clearContainer(calorieResultDiv);
    clearContainer(energyBalanceResultDiv);
    clearContainer(recommendationResultDiv);

    // Get values from form with safe fallbacks
    userAge = parseInt(calorieForm.elements['age']?.value) || NaN;
    userGender = calorieForm.elements['gender']?.value || '';
    currentWeightKg = parseFloat(calorieForm.elements['weight']?.value) || NaN;
    const heightM = parseFloat(calorieForm.elements['height']?.value) || NaN;
    userActivityLevel = parseFloat(calorieForm.elements['activity']?.value) || 0;
    const estimatedIntake = parseInt(calorieForm.elements['estimated-intake']?.value) || null;
    const userCondition = calorieForm.elements['condition']?.value || 'auto';
    const formulaChoice = calorieForm.elements['formula']?.value || 'auto';
    const applyBuffer = calorieForm.elements['buffer']?.checked || false;

    // Basic validation
    if (isNaN(userAge) || isNaN(currentWeightKg) || isNaN(heightM) || userAge <= 0 || currentWeightKg <= 0 || heightM <= 0) {
        displayError(calorieResultDiv, 'Por favor, introduce valores válidos para edad, peso y altura.');
        calculatedTDEE = null;
        calculatedBMR = null;
        resetStep2onwards();
        updateButtonStates();
        return;
    }

    // Validate activity level
    const activityMultiplier = activityMultipliers[userActivityLevel];
    if (activityMultiplier === undefined) {
        displayError(calorieResultDiv, 'Nivel de actividad no válido.');
        calculatedTDEE = null;
        calculatedBMR = null;
        resetStep2onwards();
        updateButtonStates();
        return;
    }

    userHeightCm = heightM * 100; // Store height in cm

    // Calculate BMI for auto-detection of condition
    const bmi = currentWeightKg / (heightM * heightM);
    let condition = userCondition;
    if (condition === 'auto') {
        if (bmi >= 30) {
            condition = 'obese';
        } else if (bmi >= 25) {
            condition = 'overweight';
        } else if (bmi >= 18.5) {
            condition = 'normal';
        } else {
            condition = 'underweight';
        }
    }

    // Select formula based on condition and formulaChoice
    let selectedFormula = formulaChoice;
    if (formulaChoice === 'auto') {
        if (userAge >= 10 && userAge <= 18) {
            selectedFormula = 'oms-adolescent';
        } else if (condition === 'obese' || condition === 'overweight') {
            selectedFormula = 'mifflin';
        } else if (condition === 'athlete') {
            selectedFormula = 'mifflin';
        } else {
            selectedFormula = 'harris-benedict';
        }
    }

    // Adjust weight for obese/overweight
    let adjustedWeightKg = currentWeightKg;
    if (condition === 'obese' || condition === 'overweight') {
        const idealWeight = 22.5 * (heightM * heightM);
        adjustedWeightKg = ((currentWeightKg - idealWeight) * 0.25) + idealWeight;
    }

    // Calculate BMR
    if (selectedFormula === 'harris-benedict') {
        if (userGender === 'male') {
            calculatedBMR = 88.362 + (13.397 * adjustedWeightKg) + (4.799 * userHeightCm) - (5.677 * userAge);
        } else if (userGender === 'female') {
            calculatedBMR = 447.593 + (9.247 * adjustedWeightKg) + (3.098 * userHeightCm) - (4.330 * userAge);
        } else {
            displayError(calorieResultDiv, 'Género no válido.');
            calculatedTDEE = null;
            calculatedBMR = null;
            resetStep2onwards();
            updateButtonStates();
            return;
        }
    } else if (selectedFormula === 'oms') {
        if (userGender === 'male') {
            if (userAge >= 18 && userAge <= 30) {
                calculatedBMR = (15.3 * adjustedWeightKg) + 679;
            } else if (userAge > 30 && userAge <= 60) {
                calculatedBMR = (11.6 * adjustedWeightKg) + 879;
            } else if (userAge > 60) {
                calculatedBMR = (13.5 * adjustedWeightKg) + 487;
            }
        } else if (userGender === 'female') {
            if (userAge >= 18 && userAge <= 30) {
                calculatedBMR = (14.7 * adjustedWeightKg) + 496;
            } else if (userAge > 30 && userAge <= 60) {
                calculatedBMR = (8.7 * adjustedWeightKg) + 829;
            } else if (userAge > 60) {
                calculatedBMR = (10.5 * adjustedWeightKg) + 596;
            }
        } else {
            displayError(calorieResultDiv, 'Género no válido.');
            calculatedTDEE = null;
            calculatedBMR = null;
            resetStep2onwards();
            updateButtonStates();
            return;
        }
    } else if (selectedFormula === 'oms-adolescent' && userAge >= 10 && userAge <= 18) {
        if (userGender === 'male') {
            calculatedBMR = (17.5 * adjustedWeightKg) + 651;
        } else if (userGender === 'female') {
            calculatedBMR = (12.2 * adjustedWeightKg) + 746;
        } else {
            displayError(calorieResultDiv, 'Género no válido.');
            calculatedTDEE = null;
            calculatedBMR = null;
            resetStep2onwards();
            updateButtonStates();
            return;
        }
    } else if (selectedFormula === 'mifflin') {
        if (userGender === 'male') {
            calculatedBMR = (10 * adjustedWeightKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else if (userGender === 'female') {
            calculatedBMR = (10 * adjustedWeightKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        } else {
            displayError(calorieResultDiv, 'Género no válido.');
            calculatedTDEE = null;
            calculatedBMR = null;
            resetStep2onwards();
            updateButtonStates();
            return;
        }
    } else {
        displayError(calorieResultDiv, 'Fórmula no válida o no aplicable para la edad/condición.');
        calculatedTDEE = null;
        calculatedBMR = null;
        resetStep2onwards();
        updateButtonStates();
        return;
    }

    // Calculate TDEE
    calculatedTDEE = Math.round(calculatedBMR * activityMultiplier);
	window.calculatedTDEE = calculatedTDEE
    // Apply 10% buffer if selected
    if (applyBuffer) {
        calculatedTDEE *= 1.1;
    }

    // Adjust TDEE for underweight or athletes
    if (condition === 'underweight') {
        calculatedTDEE *= 1.15;
    } else if (condition === 'athlete') {
        calculatedTDEE *= 1.1;
    }

    // Round results
    calculatedBMR = Math.round(calculatedBMR).toFixed(0);
    window.calculatedTDEE = Math.round(calculatedTDEE).toFixed(0);
	
    // Display TDEE results
    calorieResultDiv.innerHTML = `
        <h3>Resultados del Gasto Energético:</h3>
        <p>Tu Tasa Metabólica Basal (TMB) estimada es: <strong>${calculatedBMR} kcal/día</strong>.</p>
        <p>Tu Gasto Energético Total (GET/TDEE) estimado es: <strong>${calculatedTDEE} kcal/día</strong>.</p>
        <p>Este es el número aproximado de calorías que tu cuerpo quema diariamente${applyBuffer ? ', incluyendo un margen del 10%.' : '.'}</p>
        <p>Fórmula utilizada: <strong>${selectedFormula === 'harris-benedict' ? 'Harris-Benedict' : selectedFormula === 'oms' ? 'OMS/FAO/ONU' : selectedFormula === 'oms-adolescent' ? 'OMS/FAO/ONU (Adolescentes)' : 'Mifflin-St Jeor'}</strong>.</p>
        <p>Condición detectada: <strong>${condition === 'obese' ? 'Obesidad' : condition === 'overweight' ? 'Sobrepeso' : condition === 'normal' ? 'Normopeso' : condition === 'underweight' ? 'Infrapeso' : 'Atleta'}</strong>.</p>`;

    // Display Energy Balance
    let actualIntake = estimatedIntake;
    let intakeSource = 'tu ingesta proporcionada';
    if (!estimatedIntake || estimatedIntake <= 0) {
        let intakeMultiplier;
        if (userActivityLevel === 1.2) {
            intakeMultiplier = 0.90;
        } else if (userActivityLevel === 1.375) {
            intakeMultiplier = 0.95;
        } else if (userActivityLevel === 1.55) {
            intakeMultiplier = 1.00;
        } else if (userActivityLevel === 1.725) {
            intakeMultiplier = 1.05;
        } else if (userActivityLevel === 1.9) {
            intakeMultiplier = 1.10;
        } else {
            intakeMultiplier = 1.00;
        }
        actualIntake = calculatedTDEE * intakeMultiplier;
        intakeSource = 'tu ingesta estimada automáticamente (basada en tus características)';
    }

    



    const balance = actualIntake - calculatedTDEE;
    let balanceInterpretation = '';
    if (balance > 100) {
        balanceInterpretation = `Estás en un <strong>superávit calórico</strong> de aproximadamente <strong>${balance.toFixed(0)} kcal/día</strong>. Esto generalmente conduce a una ganancia de peso.`;
    } else if (balance < -100) {
        balanceInterpretation = `Estás en un <strong>déficit calórico</strong> de aproximadamente <strong>${Math.abs(balance).toFixed(0)} kcal/día</strong>. Esto generalmente conduce a una pérdida de peso.`;
    } else {
        balanceInterpretation = `Estás cerca de tu <strong>mantenimiento calórico</strong> (balance de <strong>${balance.toFixed(0)} kcal/día</strong>). Tu peso debería mantenerse relativamente estable.`;
    }

    energyBalanceResultDiv.innerHTML = `
        <h3>Balance Energético Estimado:</h3>
        <p>Basado en ${intakeSource} <strong>(${actualIntake.toFixed(0)} kcal)</strong> comparada con tu GET <strong>(${calculatedTDEE} kcal)</strong></p>
        <p>${balanceInterpretation}</p>`;

    // Estimate body fat and lean mass
    const estimatedBodyFat = estimateBodyFat(bmi, userAge, userGender);
    const leanMassKg = currentWeightKg * (1 - estimatedBodyFat / 100);

    // Detect if active
    const isActive = ['active', 'very_active'].includes(userActivityLevel);

    // Classify body fat
    let bodyFatCategory = '';
    let recommendationTitle = '';
    let finalObjective = 'perdida1';
    if (userGender === 'male') {
        if (estimatedBodyFat < 10) {
            bodyFatCategory = isActive ? 'Excelente (nivel atleta)' : 'Muy bajo';
        } else if (estimatedBodyFat <= 20) {
            bodyFatCategory = 'Saludable';
        } else if (estimatedBodyFat <= 25) {
            bodyFatCategory = 'Sobrepeso leve';
        } else {
            bodyFatCategory = 'Obesidad';
        }
    } else {
        if (estimatedBodyFat < 18) {
            bodyFatCategory = isActive ? 'Excelente (nivel atleta)' : 'Muy bajo';
        } else if (estimatedBodyFat <= 28) {
            bodyFatCategory = 'Saludable';
        } else if (estimatedBodyFat <= 33) {
            bodyFatCategory = 'Sobrepeso leve';
        } else {
            bodyFatCategory = 'Obesidad';
        }
    }

    // Recommendations
    let recommendation = '';
    if (estimatedBodyFat > (userGender === 'male' ? 20 : 28) || bmi >= 25) {
        recommendationTitle = '🎯 Objetivo Recomendado: Pérdida de Grasa (Definición)';
        const fatTarget = isActive ? (userGender === 'male' ? '6–13%' : '14–20%') : (userGender === 'male' ? '15–25%' : '20–30%');
        const proteinRange = isActive ? '1.8–2.4' : '1.6–2.2';
        const trainingFreq = isActive ? '3–5 veces/semana' : '2–3 veces/semana';
        const deficit = isActive ? '300–500' : '300–500';
        const cardio = isActive ? 'cardio de alta intensidad ocasional (HIIT) o moderado 2–3 veces/semana' : 'caminar rápido, bicicleta 2–3 veces/semana';
        recommendation = `
            <p><strong>Análisis de composición corporal:</strong></p>
            <p>• Tu IMC es <strong>${bmi.toFixed(1)}</strong> (${bmi < 18.5 ? 'bajo peso' : bmi < 25 ? 'normal' : bmi < 30 ? 'sobrepeso' : 'obesidad'})</p>
            <p>• Tu porcentaje de grasa corporal estimado es <strong>${estimatedBodyFat.toFixed(1)}%</strong> (${bodyFatCategory})</p>
            <p>• Tu masa magra es aproximadamente <strong>${leanMassKg.toFixed(1)} kg</strong></p>
            <p><strong>Objetivo: Reducir %grasa hasta ${fatTarget} mientras preservas masa muscular.</strong></p>
            <p><strong>Estrategia personalizada ${isActive ? '(Deportista/AF intensa)' : '(AF leve o moderada)'}:</strong></p>
            <ul>
                <li>Mantén un <strong>déficit calórico de ${deficit} kcal/día</strong>.</li>
                <li>Ingiere <strong>${proteinRange} g de proteína por kg</strong> (~${Math.round(1.8 * currentWeightKg)}–${Math.round(2.4 * currentWeightKg)} g/día).</li>
                <li>Entrena con <strong>fuerza ${trainingFreq}</strong> (enfócate en progresión).</li>
                <li>Incluye <strong>${cardio}</strong>.</li>
            </ul>
            <p><strong>💡 Tip:</strong> Pierde entre 0.3–0.6 kg por semana. Si eres activo, prioriza recuperación y sueño para mantener rendimiento.</p>`;
        finalObjective = 'perdida1';
    } else if (estimatedBodyFat <= (userGender === 'male' ? 15 : 23) && bmi < 22) {
        recommendationTitle = '🎯 Objetivo Recomendado: Ganancia de Masa Muscular';
        const leanTarget = isActive ? (userGender === 'male' ? '85–92%' : '78–85%') : (userGender === 'male' ? '80–90%' : '72–82%');
        const proteinRange = isActive ? '1.8–2.4' : '1.6–2.2';
        const surplus = isActive ? '+300–500 kcal/día' : '+250–300 kcal/día';
        const trainingFreq = isActive ? '4–5 veces/semana (dividido por grupos musculares)' : '3–4 veces/semana (full body o split)';
        const tip = isActive ? 'Gana 0.5–1% de tu peso corporal por mes para máximo rendimiento.' : 'Gana 0.25–0.5 kg por semana para evitar exceso de grasa.';
        recommendation = `
            <p><strong>Análisis de composición corporal:</strong></p>
            <p>• Tu IMC es <strong>${bmi.toFixed(1)}</strong> (${bmi < 18.5 ? 'bajo peso' : 'normal'})</p>
            <p>• Tu porcentaje de grasa corporal estimado es <strong>${estimatedBodyFat.toFixed(1)}%</strong> (${bodyFatCategory})</p>
            <p>• Tu masa magra es aproximadamente <strong>${leanMassKg.toFixed(1)} kg</strong></p>
            <p><strong>Objetivo: Aumentar masa magra hasta alcanzar ${leanTarget}% de tu peso.</strong></p>
            <p><strong>Estrategia personalizada ${isActive ? '(Deportista/AF intensa)' : '(AF leve o moderada)'}:</strong></p>
            <ul>
                <li>Crea un <strong>superávit de ${surplus}</strong>.</li>
                <li>Consume <strong>${proteinRange} g de proteína por kg</strong> (~${Math.round(1.8 * currentWeightKg)}–${Math.round(2.4 * currentWeightKg)} g/día).</li>
                <li>Entrena con <strong>resistencia ${trainingFreq}</strong>.</li>
                <li>Descansa <strong>7–9 horas/noche</strong> y gestiona el estrés.</li>
            </ul>
            <p><strong>💡 Tip:</strong> ${tip}</p>`;
        finalObjective = 'ganancia1';
    } else {
        recommendationTitle = '🎯 Objetivo Recomendado: Mantenimiento con Recomposición Corporal';
        const targetRange = isActive ? (userGender === 'male' ? '8–15%' : '15–22%') : (userGender === 'male' ? '12–20%' : '20–28%');
        const proteinIntake = isActive ? '2.0–2.4 g/kg' : '1.8–2.2 g/kg';
        const trainingFreq = isActive ? '4–5 veces/semana (split o push/pull/legs)' : '3 veces/semana (full body)';
        const tip = isActive ? 'Espera cambios lentos. Monitorea fuerza y medidas semanales.' : 'Ideal para principiantes o quienes retoman entrenamiento.';
        recommendation = `
            <p><strong>Análisis de composición corporal:</strong></p>
            <p>• Tu IMC es <strong>${bmi.toFixed(1)}</strong> (normal)</p>
            <p>• Tu porcentaje de grasa corporal estimado es <strong>${estimatedBodyFat.toFixed(1)}%</strong> (${bodyFatCategory})</p>
            <p>• Tu masa magra es aproximadamente <strong>${leanMassKg.toFixed(1)} kg</strong></p>
            <p><strong>Objetivo: Perder grasa y ganar músculo simultáneamente. Mantén peso y mejora tu composición hasta alcanzar ~${targetRange}% grasa.</strong></p>
            <p><strong>Estrategia personalizada ${isActive ? '(Deportista/AF intensa)' : '(AF leve o moderada)'}:</strong></p>
            <ul>
                <li>Mantén ingesta en <strong>equilibrio (~${calculatedTDEE} kcal/día)</strong>.</li>
                <li>Ingiere <strong>${proteinIntake}</strong> de proteína.</li>
                <li>Entrena con <strong>fuerza ${trainingFreq}</strong>.</li>
                <li>Evita déficits grandes para no perder rendimiento.</li>
            </ul>
            <p><strong>💡 Tip:</strong> ${tip} Usa progresión de carga y alimentación consistente.</p>`;
        finalObjective = 'mantenimiento1';
    }

    // Display recommendation
    if (recommendationResultDiv) {
        recommendationResultDiv.innerHTML = `<h3>${recommendationTitle}</h3>${recommendation}`;
    }

    // Autofill goal form
    if (weightGoalForm) {
        const currentFatInput = document.getElementById('current-fat-percentage');
        const targetFatInput = document.getElementById('target-fat-percentage');
        const targetMuscleInput = document.getElementById('target-muscle-percentage');
        const leanMassGainInput = document.getElementById('desired-lean-mass-gain');

        if (finalObjective === 'perdida1') {
            if (currentFatInput && !currentFatInput.value) {
                currentFatInput.value = estimatedBodyFat.toFixed(0);
            }
            if (targetFatInput && !targetFatInput.value) {
                const defaultTargetFat = userGender === 'male' ? (isActive ? 12 : 18) : (isActive ? 18 : 22);
                targetFatInput.value = defaultTargetFat.toFixed(0);
            }
            if (targetMuscleInput && !targetMuscleInput.value) {
                let defaultMusclePercent = userGender === 'male' ? (isActive ? 42 : 38) : (isActive ? 35 : 30);
                targetMuscleInput.value = defaultMusclePercent.toFixed(0);
            }
        } else if (finalObjective === 'ganancia1') {
            if (targetMuscleInput && !targetMuscleInput.value) {
                const defaultMusclePercent = userGender === 'male' ? (isActive ? 42 : 36) : (isActive ? 35 : 30);
                targetMuscleInput.value = defaultMusclePercent.toFixed(0);
            }
            if (leanMassGainInput && !leanMassGainInput.value) {
                const suggestedGain = isActive ? 3.0 : 2.0;
                leanMassGainInput.value = suggestedGain.toFixed(0);
            }
        }
    }

    // Adjust goal select
    const objetivoSelect = document.getElementById('objetivo');
    if (objetivoSelect && !objetivoSelect.dataset.manual) {
        objetivoSelect.value = finalObjective;
        objetivoSelect.dispatchEvent(new Event('change'));
    }

	
        const resultElements = [
        'calorie-result',
        'energy-balance-result',
        'recommendationResultDiv'
    ];
    
    resultElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = 'block';
            element.style.opacity = '0';
            setTimeout(() => {
                element.style.transition = 'opacity 0.4s ease';
                element.style.opacity = '1';
            }, 100);
        }
    });
    
	
	
    // Show info notice
    const infoNotice = document.querySelector('.info-notice');
    if (infoNotice) {
        infoNotice.style.display = 'block';
        infoNotice.style.opacity = '0';
        setTimeout(() => {
            infoNotice.style.transition = 'opacity 0.4s ease';
            infoNotice.style.opacity = '1';
        }, 100);
    }
	
	
	
    // Reset subsequent steps and update UI
    resetStep2onwards();
    updateButtonStates();
    if (calculateGoalButton) {
        calculateGoalButton.disabled = false;
    }
    console.log('calculateGoalButton.disabled:', calculateGoalButton?.disabled);
}
			// Agrega estas funciones en tu código (fuera de otras funciones)



            // --- Step 2: Calculate Weight Goal and Recommendations ---
				function calculateWeightGoal() {
					let targetMusclePercValid = true;
					const objetivoSelect = document.getElementById('objetivo');
					
					// Suponiendo que tienes estas variables:
					const activityLevel = document.getElementById('nivel-actividad')?.value || 'sedentario';
					// userAge, currentLeanMassPerc, currentFatPerc, userGender ya los tienes

					
								// --- Validación del % de masa muscular objetivo ---
					if (objetivoSelect.value === 'ganancia1') {
						const targetMusclePercInput = weightGoalForm.elements['target-muscle-percentage'];
						const targetMusclePerc = parseFloat(targetMusclePercInput.value);

						// Validar rango REALISTA para masa muscular (NO masa magra)
						if (isNaN(targetMusclePerc) || targetMusclePerc < 28 || targetMusclePerc > 45) {
							console.error('Por favor, introduce un valor válido para el porcentaje de masa muscular objetivo (28–45%).');
							alert('⚠️ Para ganar músculo, el porcentaje de masa muscular objetivo debe estar entre 28% y 45% (valores realistas).');
							targetMusclePercValid = false;
						}
					}

					clearContainer(weightGoalResultDiv);
					if (weightChartContainer) weightChartContainer.style.display = 'none';

					if (weightEvolutionChartInstance) {
						weightEvolutionChartInstance.destroy();
						weightEvolutionChartInstance = null;
					}

					// Check prerequisite
					if (!currentWeightKg || !calculatedTDEE) {
						displayError(weightGoalResultDiv, 'Error: Completa el Paso 1 antes de calcular el objetivo de peso.');
						updateButtonStates();
						return;
					}

					// Get values from form
					const currentFatPerc = parseFloat(weightGoalForm.elements['current-fat-percentage'].value);
					const targetFatPerc = parseFloat(weightGoalForm.elements['target-fat-percentage'].value);
					const targetMusclePerc = parseFloat(weightGoalForm.elements['target-muscle-percentage'].value) || 0;
					const desiredLeanGainKg = parseFloat(weightGoalForm.elements['desired-lean-mass-gain'].value) || 0;
					const isAthlete = weightGoalForm.elements['is-athlete'].value === 'yes';
					const currentFatMassKg = currentWeightKg * (currentFatPerc / 100);
					const currentLeanMassKg = currentWeightKg - currentFatMassKg;
					const currentLeanMassPerc = (currentLeanMassKg / currentWeightKg) * 100;
					const targetLeanMassKg = currentLeanMassKg + desiredLeanGainKg;
					const isBeginner = isLikelyBeginner(userAge, activityLevel, currentLeanMassPerc, currentFatPerc, userGender);
					// Validate fat percentages
					if (isNaN(currentFatPerc) || isNaN(targetFatPerc) ||
						currentFatPerc <= 0 || currentFatPerc >= 100 ||
						targetFatPerc <= 0 || targetFatPerc >= 100) {
						displayError(weightGoalResultDiv, 'Por favor, introduce porcentajes de grasa válidos (entre 0.1% y 99.9%).');
						targetWeightKgGlobal = null;
						resetStep3onwards();
						updateButtonStates();
						return;
					}
					// === Estimar si el usuario es "principiante" para recomposición ===
					function isLikelyBeginner(userAge, activityLevel, currentLeanMassPerc, currentFatPerc, userGender) {
						// 1. Nivel de actividad baja o leve → probablemente no entrena con fuerza
						const isLowActivity = ['sedentario', 'leve'].includes(activityLevel.toLowerCase());

						// 2. Masa magra baja para su género
						const leanLowForGender = (userGender === 'male' && currentLeanMassPerc < 70) ||
												 (userGender === 'female' && currentLeanMassPerc < 65);

						// 3. Alta grasa corporal (más de 25% hombre / 32% mujer)
						const isHighFat = (userGender === 'male' && currentFatPerc > 25) ||
										  (userGender === 'female' && currentFatPerc > 32);

						// 4. Edad: si es joven (<50), más fácil adaptarse
						const isYounger = userAge < 50;

						// Criterio: si tiene baja actividad + baja masa magra + alta grasa → muy probable que sea principiante
						return isLowActivity && leanLowForGender && isHighFat && isYounger;
					}
					// --- Calculations ---
					
					targetWeightKgGlobal = targetLeanMassKg / (1 - (targetFatPerc / 100));

					if (targetWeightKgGlobal <= 0 || !isFinite(targetWeightKgGlobal) || targetWeightKgGlobal > 500) {
						displayError(weightGoalResultDiv, 'No se pudo calcular un peso objetivo válido. Revisa los datos.');
						targetWeightKgGlobal = null;
						resetStep3onwards();
						updateButtonStates();
						return;
					}

					const targetFatMassKg = targetWeightKgGlobal * (targetFatPerc / 100);
					const fatMassToLoseGainKg = currentFatMassKg - targetFatMassKg;
					const totalWeightChangeKg = targetWeightKgGlobal - currentWeightKg;
					
					// --- Determine Goal Type ---
					goalTypeGlobal = 'maintenance';
					if (totalWeightChangeKg < -0.1) {
						goalTypeGlobal = 'perdida1';
					} else if (totalWeightChangeKg > 0.1) {
						goalTypeGlobal = 'ganancia1';
					}

					// --- Weekly Rate & Duration ---
					estimatedWeeksGlobal = 0;
					targetWeeklyRateKgGlobal = 0;
					let targetWeeklyRatePerc = 0;

					if (goalTypeGlobal === 'perdida1') {
						targetWeeklyRatePerc = 0.004;
						targetWeeklyRateKgGlobal = Math.max(currentWeightKg * targetWeeklyRatePerc, 0.2);
						targetWeeklyRateKgGlobal = Math.min(targetWeeklyRateKgGlobal, currentWeightKg * 0.01, 1.2);
						estimatedWeeksGlobal = Math.abs(totalWeightChangeKg) / targetWeeklyRateKgGlobal;
					} else if (goalTypeGlobal === 'ganancia1') {
						targetWeeklyRatePerc = 0.003;
						targetWeeklyRateKgGlobal = Math.max(currentWeightKg * targetWeeklyRatePerc, 0.1);
						targetWeeklyRateKgGlobal = Math.min(targetWeeklyRateKgGlobal, currentWeightKg * 0.005, 0.6);
						estimatedWeeksGlobal = totalWeightChangeKg / targetWeeklyRateKgGlobal;
					}

					estimatedWeeksGlobal = Math.max(0, Math.round(estimatedWeeksGlobal));

					// === 🔍 PROYECCIÓN DE GANANCIA MUSCULAR (solo si es ganancia1 y se ingresó % músculo) ===
					let muscleProjectionHTML = '';
					if (goalTypeGlobal === 'ganancia1' && targetMusclePerc > 0) {
						const currentMuscleKg = currentLeanMassKg * 0.75; // Aprox: músculo es ~70-80% de masa magra
						const targetMuscleKg = targetWeightKgGlobal * (targetMusclePerc / 100);
						const netMuscleGainKg = Math.max(0, targetMuscleKg - currentMuscleKg);

						// Velocidad realista de ganancia muscular
						let monthlyGain = userAge < 35 ? 1.0 : (userAge < 50 ? 0.6 : 0.3);
						const monthsToGain = netMuscleGainKg > 0 ? netMuscleGainKg / monthlyGain : 0;

						muscleProjectionHTML = `
						<div class="notes-section">
							<h4>🎯 Proyección Realista de Ganancia Muscular</h4>
							<p><strong>Masa muscular actual estimada:</strong> ${currentMuscleKg.toFixed(1)} kg (~75% de tu masa magra)</p>
							<p><strong>Masa muscular objetivo:</strong> ${targetMuscleKg.toFixed(1)} kg (${targetMusclePerc}% del peso corporal)</p>
							<p><strong>Ganancia neta estimada:</strong> <strong>${netMuscleGainKg.toFixed(1)} kg</strong></p>
							<p><strong>Tiempo estimado (ganancia natural):</strong> ~${monthsToGain.toFixed(1)} meses</p>
							<p><em>Nota: La ganancia muscular realista es de 0.3–1.2 kg/mes, más rápida en principiantes. El resto del peso ganado será grasa y agua.</em></p>
						</div>`;
					}

					// === 📊 EVALUACIÓN DE MASA MUSCULAR (mejorada) ===
					
					let muscleAssessmentHTML = `<div class="notes-section"><h4>Evaluación de Composición Corporal</h4>`;
					muscleAssessmentHTML += `<p><strong>Masa magra actual:</strong> ${currentLeanMassKg.toFixed(1)} kg (${currentLeanMassPerc.toFixed(1)}%)</p>`;
					muscleAssessmentHTML += `<p><em>⚠️ Nota: La masa magra incluye músculo, huesos, órganos y agua. No es igual a masa muscular.</em></p>`;

					const ranges = {
						male: { nonAthlete: [70, 85], athlete: [75, 90] },
						female: { nonAthlete: [60, 75], athlete: [65, 80] }
					};
					const relevantRange = isAthlete ? ranges[userGender].athlete : ranges[userGender].nonAthlete;

					if (currentLeanMassPerc < relevantRange[0]) {
						muscleAssessmentHTML += `<p>Estás por debajo del rango típico (${relevantRange[0]}–${relevantRange[1]}%). <strong>Enfócate en ganar masa muscular con entrenamiento de fuerza y superávit calórico moderado</strong>.</p>`;
					} else if (currentLeanMassPerc > relevantRange[1]) {
						muscleAssessmentHTML += `<p>¡Tienes una masa magra excelente! Por encima del rango general. Ideal para definición o mantenimiento.</p>`;
					} else {
						muscleAssessmentHTML += `<p>Estás dentro del rango saludable de masa magra para tu perfil.</p>`;
					}
					muscleAssessmentHTML += `</div>`;

					// === 🧾 RESULTADOS ===
					let resultsHTML = `<h3>Resultados del Objetivo de Composición Corporal:</h3>`;
					resultsHTML += `<p><strong>Peso Actual:</strong> ${currentWeightKg.toFixed(2)} kg</p>`;
					resultsHTML += `<p><strong>Grasa Actual:</strong> ${currentFatMassKg.toFixed(2)} kg (${currentFatPerc}%)</p>`;
					resultsHTML += `<p><strong>Masa Magra Actual:</strong> ${currentLeanMassKg.toFixed(1)} kg (${currentLeanMassPerc.toFixed(1)}%)</p>`;
					resultsHTML += `<hr style="border: 0; border-top: 1px dashed #a5d6a7; margin: 15px 0;">`;
					resultsHTML += `<p><strong>Peso Objetivo:</strong> ${targetWeightKgGlobal.toFixed(2)} kg</p>`;
					resultsHTML += `<p><strong>Grasa Objetivo:</strong> ${targetFatMassKg.toFixed(2)} kg (${targetFatPerc}%)</p>`;
					resultsHTML += `<p><strong>Masa Magra Objetivo:</strong> ${targetLeanMassKg.toFixed(1)} kg</p>`;
					resultsHTML += `<p><strong>Ganancia Magra Deseada:</strong> ${desiredLeanGainKg.toFixed(1)} kg</p>`;

					if (fatMassToLoseGainKg > 0) {
						resultsHTML += `<p><strong>Grasa a Perder:</strong> ${fatMassToLoseGainKg.toFixed(2)} kg</p>`;
					} else if (fatMassToLoseGainKg < 0) {
						resultsHTML += `<p><strong>Grasa a Ganar:</strong> ${Math.abs(fatMassToLoseGainKg).toFixed(2)} kg</p>`;
					}

					resultsHTML += `<p><strong>Cambio Total de Peso:</strong> ${totalWeightChangeKg.toFixed(2)} kg</p>`;
					resultsHTML += `<p><strong>Ritmo Semanal Objetivo:</strong> ~${targetWeeklyRateKgGlobal.toFixed(2)} kg/semana</p>`;
					if (estimatedWeeksGlobal > 0) {
						resultsHTML += `<p><strong>Duración Estimada:</strong> ~${estimatedWeeksGlobal} semanas (${(estimatedWeeksGlobal / 4.3).toFixed(1)} meses)</p>`;
					}

					// === 🔎 AÑADIR PROYECCIÓN Y EVALUACIÓN ===
					resultsHTML += muscleAssessmentHTML;
					if (muscleProjectionHTML) resultsHTML += muscleProjectionHTML;
					
					// === 🔎 DETERMINAR FASE RECOMENDADA (sin necesidad de hasTrainedBefore) ===
						// --- Determinar fase(objetivo) recomendada ---
						const userWantsGain = objetivoSelect.value === 'ganancia1';
						const userWantsLoss = objetivoSelect.value === 'perdida1';
						//const isAthlete = document.getElementById('is-athlete')?.value === 'yes';
						
						//	const activityLevel = document.getElementById('nivel-actividad')?.value?.toLowerCase();

						const isModerateActivity = ['moderate', 'active', 'very-active'].includes(activityLevel);

						// === Definir umbrales y condiciones clave ===
						const fatThresholdForGain = userGender === 'male' ? 25 : 32;
						const fatThresholdForUrgentLoss = userGender === 'male' ? 30 : 38;
						const isVeryHighFat = currentFatPerc >= fatThresholdForUrgentLoss;

						const isHighFat = (userGender === 'male' && currentFatPerc > 25) ||
										  (userGender === 'female' && currentFatPerc > 32);

						const isLowLean = (userGender === 'male' && currentLeanMassPerc < 70) ||
										  (userGender === 'female' && currentLeanMassPerc < 65);

						const isBeginnerLike = (userGender === 'male' && currentLeanMassPerc < 70) ||
											   (userGender === 'female' && currentLeanMassPerc < 65);

						// Variables de salida
						let recommendedPhase = '';
						let phaseExplanation = '';
						let isMixedPhase = false;

						// === 🔥 MÁXIMA PRIORIDAD: PÉRDIDA DE PESO (GRASA) ===
						if (
							userWantsLoss || 
							(isVeryHighFat && (isBeginnerLike || !isModerateActivity))
						) {
							recommendedPhase = 'Pérdida de Grasa (prioridad máxima)';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Tu situación requiere una <strong>prioridad en la pérdida de grasa corporal</strong>.</p>
								${isVeryHighFat 
									? `<p>Con un <strong>${currentFatPerc}% de grasa corporal</strong> (por encima del 30% en hombres / 38% en mujeres), 
									   estás en un rango de riesgo metabólico. Reducir grasa mejora salud, movilidad y respuesta a entrenamiento.</p>`
									: `<p>Has seleccionado la pérdida de peso como tu objetivo principal. Este es el momento de enfocarte en reducir grasa corporal.</p>`
								}
								<p>Un <strong>déficit calórico moderado</strong> (~15–25% bajo tu gasto) + <strong>alta proteína (2.2–2.6 g/kg)</strong> + 
								<strong>entrenamiento de fuerza 3–4 veces/semana</strong> será clave para perder grasa sin perder músculo.</p>
								<p><em>💡 Aunque tu masa magra no sea baja, perder grasa ahora te permitirá ganar músculo después con mejor eficiencia.</em></p>
							`;
							isMixedPhase = false;
						}
						// 1. PRIORIDAD: Ganancia muscular para deportistas o con objetivo de ganancia (si grasa es baja)
						else if (
							(userWantsGain || isAthlete) &&
							currentFatPerc < fatThresholdForGain &&
							(isModerateActivity || isAthlete)
						) {
							recommendedPhase = 'Ganancia de Masa Muscular';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Tu perfil es ideal para una <strong>ganancia muscular controlada</strong>.</p>
								<p>Con un porcentaje de grasa corporal del <strong>${currentFatPerc}%</strong> (< 25% en hombres / 32% en mujeres), 
								puedes ganar músculo sin riesgo de acumular exceso de grasa.</p>
								<p>Un <strong>superávit calórico moderado</strong> (+10–15% sobre tu gasto) combinado con <strong>entrenamiento de fuerza progresivo</strong> maximizará tu hipertrofia.</p>
							`;
							isMixedPhase = false;
						}
						// 2. Recomposición: quiere ganar masa y perder grasa
						else if (desiredLeanGainKg > 0 && fatMassToLoseGainKg > 0) {
							recommendedPhase = 'Fase Mixta (Recomposición Corporal)';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Estás en una <strong>fase de recomposición corporal</strong>: perder grasa y ganar músculo al mismo tiempo.</p>
								<p>Aunque tu masa magra actual (${currentLeanMassPerc.toFixed(1)}%) está dentro del rango, tu objetivo es aumentarla a <strong>${targetLeanMassKg.toFixed(1)} kg</strong>, 
								mientras reduces la grasa del <strong>${currentFatPerc}%</strong> al <strong>${targetFatPerc}%</strong>.</p>
								<p>Este enfoque es ideal para mejorar tu físico sin grandes cambios de peso.</p>
							`;
							isMixedPhase = true;
						}
						// 3. Pérdida de grasa (tiene grasa alta pero buena masa magra)
						else if (isHighFat && !isLowLean) {
							recommendedPhase = 'Pérdida de Grasa (con preservación muscular)';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Enfócate en <strong>perder grasa</strong>, pero <strong>protegiendo tu músculo</strong>.</p>
								<p>Tienes una buena base muscular. Un déficit calórico moderado + alta proteína + entrenamiento de fuerza te ayudarán a definirte sin perder masa magra.</p>
							`;
						}
						// 4. Ganancia muscular (baja masa magra, grasa no alta)
						else if (!isHighFat && isLowLean) {
							recommendedPhase = 'Ganancia de Masa Muscular';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Tu prioridad es <strong>ganar músculo</strong>.</p>
								<p>Aunque tu peso no sea alto, tienes poca masa magra. Un superávit calórico moderado + entrenamiento de fuerza progresivo son clave para construir masa muscular.</p>
							`;
						}
						// 5. Mantenimiento
						else {
							recommendedPhase = 'Mantenimiento o Afinamiento';
							phaseExplanation = `
								<p><strong>🎯 Recomendación principal:</strong> Estás cerca de tu objetivo. Puedes mantener tu peso o hacer ajustes finos.</p>
								<p>Perfecto para consolidar hábitos, mejorar la calidad de vida o afinar tu definición sin cambios drásticos.</p>
							`;
						}
					// === 💡 RECOMENDACIONES PERSONALIZADAS ===
					resultsHTML += `<div class="notes-section"><h4>💡 Recomendaciones Clave</h4><ul>`;
					
					if (goalTypeGlobal === 'perdida1') {
						const deficit = Math.min(600, Math.max(400, targetWeeklyRateKgGlobal * 7700 / 7));
						resultsHTML += `<li><strong>Déficit calórico:</strong> ~${deficit.toFixed(0)} kcal/día</li>`;
						resultsHTML += `<li><strong>Proteína:</strong> 1.8–2.4 g/kg para preservar músculo</li>`;
						resultsHTML += `<li><strong>Entrenamiento:</strong> Fuerza 3–4 veces/semana + cardio moderado</li>`;
					} else if (goalTypeGlobal === 'ganancia1') {
						const surplus = Math.min(500, Math.max(250, targetWeeklyRateKgGlobal * 7700 / 7));
						resultsHTML += `<li><strong>Superávit calórico:</strong> ~${surplus.toFixed(0)} kcal/día</li>`;
						resultsHTML += `<li><strong>Proteína:</strong> 1.6–2.2 g/kg de peso corporal</li>`;
						resultsHTML += `<li><strong>Entrenamiento:</strong> Hipertrofia 4–5 veces/semana, progresión de carga</li>`;
						resultsHTML += `<li><strong>Realismo:</strong> Ganas músculo lentamente. El resto será grasa. Evita el “bulking” extremo.</li>`;
					} else {
						resultsHTML += `<li><strong>Mantenimiento calórico:</strong> Igual a tu GET</li>`;
						resultsHTML += `<li><strong>Proteína:</strong> 1.2–1.8 g/kg</li>`;
					}

					resultsHTML += `<li><strong>Monitorización:</strong> Pésate semanalmente y ajusta según progreso</li>`;
					resultsHTML += `</ul></div>`;
					// === 📌 FASE RECOMENDADA ===
					resultsHTML += `
					<div class="notes-section" style="border-left: 4px solid #ff9800; background: #fff3e0;">
						<h4>📌 Fase Recomendada: ${recommendedPhase}</h4>
						${phaseExplanation}
						${isMixedPhase ? `
						<p><strong>¿Cómo funciona?</strong></p>
						<ul>
							<li><strong>Alimentación:</strong> Calorías cercanas al mantenimiento o déficit leve (100–300 kcal)</li>
							<li><strong>Proteína:</strong> Alta (2.2–2.6 g/kg de peso corporal)</li>
							<li><strong>Entrenamiento:</strong> Fuerza progresiva 4–5 veces/semana</li>
							<li><strong>Progreso:</strong> Pérdida lenta de grasa (0.2–0.4 kg/semana) + ganancia muscular gradual</li>
						</ul>
						<p><em>💡 Nota: Puede que tu peso no baje rápido, pero tu físico cambiará: más definido y tonificado.</em></p>
						` : ''}
					</div>`;
					
					// === 🥗 ESTRATEGIAS DIETÉTICAS RECOMENDADAS POR FASE ===
					let dietStrategiesHTML = `<div class="notes-section"><h4>🥗 Estrategias Dietéticas Recomendadas</h4>`;

					// Definir estrategias por fase
					if (recommendedPhase.includes('Fase Mixta')) {
						dietStrategiesHTML += `
							<p><strong>Para tu perfil (alta grasa + baja masa magra), estas estrategias maximizan la recomposición:</strong></p>
							<ul>
								<li><strong>Hiperproteica (2.2–2.6 g/kg):</strong> Prioriza la construcción muscular. Ej: ${Math.round(currentWeightKg * 2.4)} g de proteína/día.</li>
								<li><strong>Carb Cycling (días altos/bajos HC):</strong> Más carbohidratos en días de entreno, menos en reposo. Mantiene energía sin acumular grasa.</li>
								<li><strong>TKD (25–50g HC pre/post entreno):</strong> Ideal si entrenas en déficit. Mejora rendimiento sin salir de cetosis metabólica.</li>
								<li><strong>Timing nutricional:</strong> Consume proteína (0.4 g/kg) y HC tras el entreno para maximizar recuperación.</li>
								<li><strong>Flexible Dieting (80/20):</strong> Enfócate en objetivos calóricos y de macros. Permite sostenibilidad a largo plazo.</li>
								<li><strong>Refeed semanal (1 día HC alto):</strong> Ayuda a regular hormonas del hambre y mantener el metabolismo.</li>
								<li><strong>🟡 Cetogénica (cetosis estricta, <50g HC/día):</strong> Puede acelerar la pérdida inicial de grasa y reducir apetito, pero <strong>solo recomendada si:</strong>
										<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
											<li>No realizas entrenamientos de alta intensidad o fuerza frecuentes</li>
											<li>Eres sedentario o tu nivel de actividad es leve</li>
											<li>Tienes buena tolerancia metabólica a las grasas</li>
										</ul>
										<em>⚠️ No recomendada para deportistas: puede reducir rendimiento, volumen de entrenamiento y retención muscular.</em>
								</li>
									<li><strong>🟡 Protein Cycling (4 semanas altas + 1 semana baja proteína):</strong> Enfoque experimental. Algunos teorizan que "resetea" la síntesis proteica, pero <strong>la evidencia es débil</strong>.
										<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
											<li>Puede usarse en fases largas de pérdida para variar estímulos</li>
											<li>No interrumpir en semanas clave de progreso</li>
										</ul>
										<em>💡 Si lo usas: semana baja = 1.2–1.4 g/kg, luego vuelve a 2.4+ g/kg.</em>
									</li>
								</ul>
							<p><em>Evita cetosis estricta o ayunos prolongados si afectan tu rendimiento.</em></p>
						`;
					} else if (recommendedPhase.includes('Pérdida de Grasa')) {
						dietStrategiesHTML += `
							<p><strong>Objetivo: perder grasa preservando músculo. Estrategias efectivas:</strong></p>
							<ul>
								<li><strong>✅ Hiperproteica (2.2–2.6 g/kg):</strong> Esencial para proteger masa muscular. Ej: ${Math.round(currentWeightKg * 2.4)} g de proteína/día.</li>
								<li><strong>✅ Flexible Dieting (80/20):</strong> Mayor adherencia. No necesitas alimentos "perfectos", solo equilibrio calórico y de macros.</li>
								<li><strong>✅ IF 16:8:</strong> Puede ayudar a controlar el apetito y simplificar la alimentación, especialmente si no tienes hambre por la mañana.</li>e pérdida.</li>
								<li><strong>🟡 Cetogénica (cetosis estricta, <50g HC/día):</strong> Puede acelerar la pérdida inicial de grasa y reducir apetito, pero <strong>solo recomendada si:</strong>
									<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
										<li>No realizas entrenamientos de alta intensidad o fuerza frecuentes</li>
								<li><strong>✅ Refeed (1 día/semana HC alto):</strong> Útil en déficits prolongados (>8 semanas). Ayuda a regular leptina, mejorar energía y mantener el metabolismo.</li>
								<li><strong>✅ TKD (25–50g HC pre/post entreno):</strong> Ideal si entrenas intenso y sigues bajo en carbohidratos. Mantiene rendimiento sin salir del objetivo d
										<li>Eres sedentario o tu nivel de actividad es leve</li>
										<li>Tienes buena tolerancia metabólica a las grasas</li>
									</ul>
									<em>⚠️ No recomendada para deportistas: puede reducir rendimiento, volumen de entrenamiento y retención muscular.</em>
								</li>
								<li><strong>🟡 Protein Cycling (4 semanas altas + 1 semana baja proteína):</strong> Enfoque experimental. Algunos teorizan que "resetea" la síntesis proteica, pero <strong>la evidencia es débil</strong>.
									<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
										<li>Puede usarse en fases largas de pérdida para variar estímulos</li>
										<li>No interrumpir en semanas clave de progreso</li>
									</ul>
									<em>💡 Si lo usas: semana baja = 1.2–1.4 g/kg, luego vuelve a 2.4+ g/kg.</em>
								</li>
							</ul>
							<p><em>🔑 Clave: el déficit calórico es lo más importante. Las estrategias ayudan, pero no sustituyen el balance energético.</em></p>
						`;
				
					} else if (recommendedPhase.includes('Ganancia de Masa Muscular')) {
						dietStrategiesHTML += `
							<p><strong>Objetivo: ganar músculo con mínimo aumento de grasa. Estrategias clave:</strong></p>
							<ul>
								<li><strong>✅ Hiperproteica (1.8–2.2 g/kg):</strong> Base para la hipertrofia. Ej: ${Math.round(currentWeightKg * 2.0)} g/día.</li>
								<li><strong>✅ Carb Cycling:</strong> Días de entreno: HC altos (4–6 g/kg); reposo: moderados/bajos.</li>
								<li><strong>✅ CKD o 5+2 HC:</strong> 5 días moderados, 2 días altos (150–500g). Ideal para deportistas.</li>
								<li><strong>✅ Timing nutricional:</strong> HC + proteína post-entreno para máxima síntesis muscular.</li>
								<li><strong>✅ Carb-loading (pre-entrenos intensos):</strong> Aumenta rendimiento en sesiones clave.</li>
								<li><strong>✅ Flexible Dieting:</strong> Para mantener adherencia sin obsesionarse con "alimentos limpios".</li>
							</ul>
							<p><em>❌ Evita cetosis estricta: limita rendimiento y adaptaciones musculares.</em></p>
						`;
					} else {
						// Mantenimiento o afinamiento
						dietStrategiesHTML += `
							<p><strong>Objetivo: mantener tu composición corporal con hábitos sostenibles:</strong></p>
							<ul>
								<li><strong>✅ Flexible Dieting (80/20):</strong> Enfoque más realista y duradero. Prioriza disfrute y equilibrio.</li>
								<li><strong>✅ Hiperproteica (1.6–2.0 g/kg):</strong> Ayuda a mantener masa muscular. Ej: ${Math.round(currentWeightKg * 1.8)} g/día.</li>
								<li><strong>✅ IF 16:8 o Carb Cycling:</strong> Si encajan con tu rutina. No obligatorios, pero útiles para auto-regulación.</li>
								<li><strong>✅ Timing proteico:</strong> Distribuye proteína en 3–5 comidas (0.4 g/kg por comida).</li>
							</ul>
							<p><em>En mantenimiento, la sostenibilidad es más importante que la estrategia específica.</em></p>
						`;
					}

					dietStrategiesHTML += `</div>`;
					
					
					

					// Añadir al resultado final
					resultsHTML += dietStrategiesHTML;
					
					
					// === ⚠️ VALIDACIÓN DE OBJETIVOS IRREALISTAS (versión corregida) ===
					function showUnrealisticGoalWarning(message) {
						alert("⚠️ Advertencia: Objetivo poco realista\n\n" + message);
					}

					// --- 1. Detectar ganancia muscular excesiva ---
					if (goalTypeGlobal === 'ganancia1') {
						const leanGainKg = targetLeanMassKg - currentLeanMassKg;
						const weeks = estimatedWeeksGlobal || 16;
						const leanGainPerWeek = leanGainKg / weeks;

						// Estimar si es principiante (sin hasTrainedBefore)
						const isBeginner = (function() {
							const lowLean = (userGender === 'male' && currentLeanMassPerc < 70) ||
											(userGender === 'female' && currentLeanMassPerc < 65);
							const highFat = (userGender === 'male' && currentFatPerc > 25) ||
											(userGender === 'female' && currentFatPerc > 32);
							const isYoung = userAge < 50;
							const activityLevel = document.getElementById('nivel-actividad')?.value?.toLowerCase();
							const isLowActivity = ['sedentario', 'leve'].includes(activityLevel);
							return (lowLean || highFat) && isLowActivity && isYoung;
						})();

						// Ganancia máxima realista por semana (en kg)
						const maxGainPerWeek = isBeginner 
							? 0.8  // Principiante: mayor hipertrofia inicial
							: 0.5; // Intermedio/avanzado

						if (leanGainPerWeek > maxGainPerWeek * 1.5) {
							const realisticMaxGain = (maxGainPerWeek * weeks).toFixed(1);
							const timeNeeded = (leanGainKg / maxGainPerWeek).toFixed(1);
							
							showUnrealisticGoalWarning(
								`Estás buscando ganar ${leanGainKg.toFixed(1)} kg de masa magra en ${weeks} semanas.\n\n` +
								`La ganancia muscular realista es de ${maxGainPerWeek.toFixed(2)} kg/semana.\n\n` +
								`Máximo esperado en este tiempo: ~${realisticMaxGain} kg.\n\n` +
								`Para lograr ${leanGainKg.toFixed(1)} kg, necesitarías ~${timeNeeded} semanas (${(timeNeeded/4.3).toFixed(1)} meses) como mínimo.\n\n` +
								`Recuerda: no todo el peso ganado será músculo. Parte será grasa y agua.`
							);
						}
					}

					// --- 2. Pérdida de grasa demasiado rápida ---
					if (goalTypeGlobal === 'perdida1') {
						const fatToLoseKg = currentFatMassKg - targetFatMassKg;
						const weeks = estimatedWeeksGlobal || 16;
						const fatLossPerWeek = fatToLoseKg / weeks;

						const maxSafeLossPerWeek = currentWeightKg * 0.01; // 1% del peso corporal

						if (fatLossPerWeek > 1.0 || fatLossPerWeek > maxSafeLossPerWeek) {
							const maxPossible = (maxSafeLossPerWeek * weeks).toFixed(1);
							
							showUnrealisticGoalWarning(
								`Estás buscando perder ${fatToLoseKg.toFixed(1)} kg de grasa en ${weeks} semanas.\n\n` +
								`Una pérdida segura es de 0.5–1.0 kg/semana (máximo ~${maxSafeLossPerWeek.toFixed(1)} kg/semana).\n\n` +
								`Pérdidas más rápidas pueden causar pérdida muscular, bajos niveles de energía y rebote.\n\n` +
								`Te recomendamos no superar ${maxPossible} kg en este periodo para un proceso saludable.`
							);
						}
					}

					// --- 3. Recomposición imposible ---
					if (desiredLeanGainKg > 3 && fatMassToLoseGainKg > 3 && estimatedWeeksGlobal < 20) {
						showUnrealisticGoalWarning(
							`Tu objetivo combina una gran ganancia muscular (${desiredLeanGainKg.toFixed(1)} kg) ` +
							`con una pérdida significativa de grasa (${fatMassToLoseGainKg.toFixed(1)} kg) en solo ~${estimatedWeeksGlobal} semanas.\n\n` +
							`Esto es extremadamente difícil de lograr, incluso para principiantes.\n\n` +
							`Recomendamos enfocarte primero en una fase clara:\n` +
							`- Si tienes grasa >25%: pérdida de grasa\n` +
							`- Si tienes grasa <25%: ganancia muscular controlada\n\n` +
							`La recomposición corporal es lenta y solo viable en casos específicos.`
						);
					}

					// --- 4. Cambio de peso demasiado rápido ---
					const totalWeightChangePerWeek = Math.abs(totalWeightChangeKg) / (estimatedWeeksGlobal || 1);
					if (totalWeightChangePerWeek > 1.2) {
						showUnrealisticGoalWarning(
							`Tu objetivo implica un cambio de peso de ${totalWeightChangePerWeek.toFixed(2)} kg/semana.\n\n` +
							`Cambios mayores a 1.2 kg/semana no son sostenibles ni saludables.\n\n` +
							`Pueden causar pérdida muscular, problemas metabólicos o rebote.\n\n` +
							`Recomendamos un ritmo de 0.3–1.0 kg/semana para mejores resultados a largo plazo.`
						);
					}
					// === 🔁 ACTUALIZAR SELECT DE OBJETIVO SEGÚN FASE RECOMENDADA ===
						// === 🔁 FORZAR SELECT A OBJETIVO RECOMENDADO + MENSAJE EDUCATIVO ===
								//const objetivoSelect = document.getElementById('objetivo');
								const objectiveFeedbackContainer = document.getElementById('objective-feedback') || (() => {
									// Si no existe, crear contenedor bajo el select
									const container = document.createElement('div');
									container.id = 'objective-feedback';
									container.style.margin = '8px 0';
									container.style.fontSize = '0.9em';
									objetivoSelect.parentNode.insertBefore(container, objetivoSelect.nextSibling);
									return container;
								})();

								if (objetivoSelect && recommendedPhase) {
									let valueToSelect = 'sel';
									let displayName = 'Selecciona segun Objetivo';
									let explanation = '';

									if (recommendedPhase.includes('Pérdida') || recommendedPhase.includes('prioridad máxima')) {
										valueToSelect = 'perdida1';
										displayName = 'Pérdida de Peso';
										explanation = 'Te recomendamos perder grasa porque tienes un porcentaje elevado. Este enfoque mejora tu salud y prepara tu cuerpo para ganar músculo después.';
									} 
									else if (recommendedPhase.includes('Ganancia')) {
										valueToSelect = 'ganancia1';
										displayName = 'Ganancia de Peso';
										explanation = 'Tu nivel de grasa es adecuado para ganar músculo. Un superávit calórico moderado te ayudará a construir masa muscular eficientemente.';
									} 
									else if (recommendedPhase.includes('Mantenimiento')) {
										valueToSelect = 'mantenimiento1';
										displayName = 'Mantenimiento';
										explanation = 'Estás cerca de tu objetivo. Mantener tu peso actual te permite consolidar hábitos y prepararte para futuros cambios.';
									} 
									else if (recommendedPhase.includes('Mixta') || recommendedPhase.includes('Recomposición') || recommendedPhase.includes('Combinada')) {
										valueToSelect = 'mixto1';
										displayName = 'Mixto/Combinado';
										explanation = 'Puedes mejorar tu composición corporal perdiendo grasa y ganando músculo al mismo tiempo. Ideal si eres principiante o tienes grasa alta + poca masa muscular.';
									}

									// --- 1. Forzar el valor del select ---
									objetivoSelect.value = valueToSelect;
									objetivoSelect.dispatchEvent(new Event('change')); // Actualiza el resto de la interfaz

									// --- 2. Mostrar mensaje educativo ---
									objectiveFeedbackContainer.innerHTML = `
										<div style="
											background-color: #e3f2fd; 
											border: 1px solid #bbdefb; 
											border-radius: 6px; 
											padding: 12px; 
											font-size: 0.95em; 
											color: #1565c0; 
											line-height: 1.5;
										">
											<strong>🎯 Objetivo recomendado: ${displayName}</strong>
											<p style="margin: 8px 0; opacity: 0.9;">
												${explanation}
											</p>
											<small style="color: #555;">
												Puedes cambiarlo manualmente si lo deseas, pero esta opción es la más adecuada para tu perfil actual.
											</small>
										</div>
									`;
								}
					// === MOSTRAR RESULTADOS ===
					const weightGoalResult = document.getElementById('weight-goal-result');
					if (weightGoalResult) {
						weightGoalResult.style.display = 'block';
						weightGoalResult.style.opacity = '0';
						setTimeout(() => {
							weightGoalResult.style.transition = 'opacity 0.4s ease';
							weightGoalResult.style.opacity = '1';
						}, 100);
					}
					weightGoalResultDiv.innerHTML = resultsHTML;

					// Show chart if applicable
					if (goalTypeGlobal !== 'maintenance' && estimatedWeeksGlobal > 1 && weightChartContainer) {
						generateWeightEvolutionChart(currentWeightKg, targetWeightKgGlobal, estimatedWeeksGlobal);
						weightChartContainer.style.display = 'block';
					}
					// Mostrar weight-goal-result con animación
					

					
					// === 🌫️ MOSTRAR MODAL CON FADE IN/OUT + INFO NUTRICIONAL ===
					setTimeout(() => {
						const objetivoSelect = document.getElementById('objetivo');
						const selectedObjective = objetivoSelect?.value;

						if (!selectedObjective || selectedObjective === 'sel') return;

						// === 🔍 CONFIGURACIÓN DE FASES + INFO EDUCATIVA ===
						const faseConfig = {
							perdida1: {
								title: "Elige tu Fase (Pérdida de Peso)",
								options: [
									{
										value: "induccion_cetogenica1",
										label: "Inducción Cetogénica",
										info: `
											<strong>Muy baja en carbohidratos / Cetogénica (VLCKD)</strong><br>
											<strong>CH diarios:</strong> <50 g/día (20–30 g típico)<br>
											<strong>% Energía:</strong> 5–10% de HC<br>
											<strong>Características:</strong> Alta en grasas (70-80%), moderada en proteínas. Induce cetosis. Elimina cereales, azúcares, frutas, legumbres.<br>
											<strong>Relación grasa:(proteína+HC):</strong> 2:1 a 4:1<br>
											<strong>Cuándo usarla:</strong> Obesidad con síndrome metabólico, diabetes tipo 2, hígado graso. <em>Debe ser supervisada.</em>
										`
									},
									{
										value: "ciclado_metabolico1",
										label: "Ciclado Metabólico",
										info: `
											<strong>Ciclado de carbohidratos (Carb Cycling)</strong><br>
											<strong>Estrategia:</strong> Días de HC bajos (30–100g) en reposo, días altos (200–400g) en entrenos.<br>
											<strong>Características:</strong> Combina beneficios de cetosis y recarga de glucógeno. Mantiene rendimiento y flexibilidad metabólica.<br>
											<strong>Cuándo usarlo:</strong> Pérdida de grasa con preservación muscular, deportistas en déficit, personas con alta adherencia.
										`
									},
									{
										value: "transicion_mantenimiento1",
										label: "Transición a Mantenimiento",
										info: `
											<strong>Moderada en carbohidratos</strong><br>
											<strong>CH diarios:</strong> 100–150 g/día<br>
											<strong>% Energía:</strong> 26–45% de HC<br>
											<strong>Características:</strong> Flexible, incluye cereales integrales, frutas, legumbres. Déficit calórico leve.<br>
											<strong>Cuándo usarla:</strong> Fin de una fase de pérdida, para evitar el efecto rebote y estabilizar el metabolismo.
										`
									}
								],
								targetSelectId: "fasePerdida1",
								labelId: "labelFasePerdida1"
							},
							ganancia1: {
								title: "Elige tu Fase (Ganancia de Peso)",
								options: [
									{
										value: "volumen1",
										label: "Volumen Muscular",
										info: `
											<strong>Volumen Muscular</strong><br>
											<strong>Grasas:</strong> 25–35%<br>
											<strong>Proteínas:</strong> 25–30% (1.6–2.2 g/kg)<br>
											<strong>HC:</strong> 40–50% (300–500g/día)<br>
											<strong>Objetivo:</strong> Superávit moderado para hipertrofia con control de grasa.
										`
									},
									{
										value: "masa1",
										label: "Enfocado en Masa Muscular",
										info: `
											<strong>Enfocado en Masa Muscular</strong><br>
											<strong>Énfasis:</strong> HC complejos (arroz, avena, patata) y proteína post-entreno.<br>
											<strong>Superávit:</strong> 10–15% sobre el gasto.<br>
											<strong>Objetivo:</strong> Maximizar ganancia muscular, incluso con algo de grasa.
										`
									}
								],
								targetSelectId: "faseGanancia1",
								labelId: "labelFaseGanancia1"
							},
							mantenimiento1: {
								title: "Elige tu Enfoque (Mantenimiento)",
								options: [
									{
										value: "equilibrio1",
										label: "Equilibrio Flexible",
										info: `
											<strong>Equilibrio Flexible</strong><br>
											<strong>Grasas:</strong> 30–35%<br>
											<strong>Proteínas:</strong> 20–25% (1.6–2.0 g/kg)<br>
											<strong>HC:</strong> 35–45% (200–300g/día)<br>
											<strong>Objetivo:</strong> Sostenibilidad a largo plazo, sin déficit ni superávit.
										`
									},
									{
										value: "social1",
										label: "Adherencia Social",
										info: `
											<strong>Adherencia Social</strong><br>
											<strong>Flexibilidad:</strong> Mayor tolerancia a HC en comidas sociales.<br>
											<strong>Proteína:</strong> Moderada, distribuida.<br>
											<strong>Objetivo:</strong> Mantener hábitos sin rigidez, ideal para vida activa.
										`
									}
								],
								targetSelectId: "enfoqueMantenimiento1",
								labelId: "labelEnfoqueMantenimiento1"
							},
							mixto1: {
								title: "Elige tu Fase (Mixto/Combinado)",
								options: [
									{
										value: "volumen1",
										label: "Volumen",
										info: `
											<strong>Periodización: Volumen</strong><br>
											<strong>HC:</strong> 40–50%<br>
											<strong>Proteína:</strong> 25–30%<br>
											<strong>Objetivo:</strong> Ganancia muscular con déficit leve o mantenimiento.
										`
									},
									{
										value: "definicion1",
										label: "Definición",
										info: `
											<strong>Periodización: Definición</strong><br>
											<strong>HC:</strong> 10–25%<br>
											<strong>Proteína:</strong> 25–35%<br>
											<strong>Objetivo:</strong> Pérdida de grasa con preservación muscular.
										`
									},
									{
										value: "mantenimiento1",
										label: "Mantenimiento",
										info: `
											<strong>Periodización: Mantenimiento</strong><br>
											<strong>HC:</strong> 30–40%<br>
											<strong>Proteína:</strong> 20–25%<br>
											<strong>Objetivo:</strong> Estabilizar composición, recuperar hormonas, prevenir rebote.
										`
									}
								],
								targetSelectId: "faseMixto1",
								labelId: "labelFaseMixto1"
							}
						};

						const config = faseConfig[selectedObjective];
						if (!config) return;

						// === 🧱 CREAR MODAL CON INFO ===
						const modal = document.createElement('div');
						modal.id = 'phase-selection-modal';
						modal.style.cssText = `
							position: fixed; top: 0; left: 0; width: 100%; height: 100%;
							background: rgba(0, 0, 0, 0); display: flex; justify-content: center;
							align-items: center; z-index: 2000; font-family: Arial, sans-serif;
							transition: background 0.4s ease;
						`;

						modal.innerHTML = `
							<div class="modal-content" style="
								opacity: 0; transform: scale(0.9);
								transition: opacity 0.3s ease, transform 0.3s ease;
								background: white; border-radius: 12px; width: 90%; max-width: 600px;
								padding: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.2);
								max-height: 90vh; overflow-y: auto;
							">
								<h3 style="margin: 0 0 16px; color: #1976d2;">${config.title}</h3>
								<p style="color: #555; font-size: 0.95em; margin-bottom: 16px;">
									Selecciona la fase que mejor se adapte a tu estilo de vida y objetivos. 
									<strong>Desplaza para ver detalles de cada opción.</strong>
								</p>
								<ul style="list-style: none; padding: 0; margin: 16px 0;">
									${config.options.map(opt => `
										<li style="margin: 12px 0;">
											<label style="
												display: block; cursor: pointer; padding: 12px; border: 1px solid #ddd;
												border-radius: 8px; background: #f9f9f9; transition: background 0.2s;
											" onmouseover="this.style.background='#f0f4f8'" onmouseout="this.style.background='#f9f9f9'">
												<div style="display: flex; align-items: center; margin-bottom: 6px;">
													<input type="radio" name="phaseOption" value="${opt.value}" style="margin-right: 10px;">
													<strong style="font-size: 1.05em; color: #228720;">${opt.label}</strong>
												</div>
												<div style="font-size: 0.9em; color: #444; line-height: 1.5; padding-left: 28px;">
													${opt.info}
												</div>
											</label>
										</li>
									`).join('')}
								</ul>
								<div style="text-align: right; margin-top: 16px;">
									<button id="cancelModal" style="
										background: #e0e0e0; color: #333; border: none; padding: 8px 16px;
										border-radius: 4px; cursor: pointer; margin-right: 8px; font-size: 0.95em;
									">Cancelar</button>
									<button id="confirmPhase" style="
										background: #205e22; color: white; border: none; padding: 8px 16px;
										border-radius: 4px; cursor: pointer; font-size: 0.95em;
									">Seleccionar</button>
								</div>
							</div>
						`;

						document.body.appendChild(modal);

						// ✅ FADE IN
						setTimeout(() => {
							modal.style.background = 'rgba(0, 0, 0, 0.7)';
							modal.querySelector('.modal-content').style.opacity = '1';
							modal.querySelector('.modal-content').style.transform = 'scale(1)';
						}, 100);

						// ✅ FADE OUT + limpieza
						function closeModal() {
							modal.style.background = 'rgba(0, 0, 0, 0)';
							const content = modal.querySelector('.modal-content');
							content.style.opacity = '0';
							content.style.transform = 'scale(0.9)';
							setTimeout(() => modal.remove(), 300);
						}

						// Acciones
						const confirmBtn = modal.querySelector('#confirmPhase');
						const cancelBtn = modal.querySelector('#cancelModal');

						confirmBtn.onclick = function () {
							const selected = modal.querySelector('input[name="phaseOption"]:checked');
							if (!selected) {
								alert('⚠️ Por favor, selecciona una fase.');
								return;
							}
							const selectedValue = selected.value; // Ej: 'induccion_cetogenica1'
							const targetSelect = document.getElementById(config.targetSelectId);
							const targetLabel = document.getElementById(config.labelId);
							
							// === 1. Establecer el valor en el <select> correspondiente ===
							if (targetSelect) {
								targetSelect.value = selected.value;
								targetSelect.dispatchEvent(new Event('change'));
							}
							 // === 2. Mostrar el <label> si estaba oculto ===
							if (targetLabel) {
								targetLabel.style.display = 'block';
							}
							// === 3. Establecer goalTypeGlobal según el objetivo actual ===
							// selectedObjective ya está definido fuera (es el valor de 'objetivo')
							const selectedObjective = objetivoSelect.value;

							if (['perdida1', 'ganancia1', 'mantenimiento1', 'mixto1'].includes(selectedObjective)) {
								window.goalTypeGlobal = selectedObjective; // Aseguramos que sea global
							} else {
								window.goalTypeGlobal = 'maintenance'; // valor por defecto
							}
							//
							// === 4. Establecer TDEE s ===
								document.getElementById('get-calories').value = window.calculatedTDEE;
								if (goalTypeGlobal === 'perdida1') document.getElementById('goal-calories').value = Math.round(calculatedTDEE * 0.85);
								if (goalTypeGlobal === 'ganancia1') document.getElementById('goal-calories').value = Math.round(calculatedTDEE * 1.1);
								if (goalTypeGlobal === 'mantenimiento1') document.getElementById('goal-calories').value = Math.round(calculatedTDEE);
								if (goalTypeGlobal === 'mixto') document.getElementById('goal-calories').value = Math.round(calculatedTDEE * 0.95);
						
							
							// === 5. Establecer valores paso 3 = Estimación de Tiempo s ===	
							document.getElementById('weight-change-goal').value = Math.abs(totalWeightChangeKg).toFixed(0);
								document.getElementById('weekly-calorie-diff').value = Math.abs(targetWeeklyRateKgGlobal).toFixed(0);
							const map = {
							  perdida1: 'perdida',
							  ganancia1: 'ganancia',
							  mantenimiento1: 'mantenimiento',
							  mixto1: 'mixto'            // <-- añade esta línea si "mixto" también puede venir del <select>
							};

							const ob = map[document.getElementById('objetivo').value] || '';

							let weeklyDiff;
							switch (ob) {
							  case 'perdida':
								weeklyDiff = -3500;
								document.getElementById('weight-change-goal').value = (-Math.abs(totalWeightChangeKg)).toFixed(0);
								break;
							  case 'ganancia':
								weeklyDiff = 2000;
								document.getElementById('weight-change-goal').value = Math.abs(totalWeightChangeKg).toFixed(0);
								break;
							  case 'mantenimiento':
								weeklyDiff = 0;
								document.getElementById('weight-change-goal').value = 0
								break;
							  case 'mixto':
								weeklyDiff = 1000;
								document.getElementById('weight-change-goal').value = (-Math.abs(totalWeightChangeKg)).toFixed(0);
								break;
							  default:
								weeklyDiff = 0;          // valor por defecto si no coincide
							}


							document.getElementById('weekly-calorie-diff').value = weeklyDiff;								
							// Mostrar planificación temporal con animación
							const planificacionTemporal = document.getElementById('planificacion-temporal');
							if (planificacionTemporal) {
								planificacionTemporal.style.display = 'block';
								planificacionTemporal.style.opacity = '0';
								setTimeout(() => {
									planificacionTemporal.style.transition = 'opacity 0.4s ease';
									planificacionTemporal.style.opacity = '1';
								}, 100);
							}	
								
							// ✅ Opcional: depuración
								console.log("✅ Fase guardada:", selectedValue);
								console.log("✅ Objetivo (goalTypeGlobal):", window.goalTypeGlobal);

							closeModal();
						};

						cancelBtn.onclick = closeModal;
						modal.onclick = (e) => {
							if (e.target === modal) closeModal();
						};

					}, 500);					
					resetStep3onwards();
				}
										// Set goal calories in Step 3
					//if (calculatedTDEE && goalCaloriesInput) {
						//let suggestedGoalCalories = calculatedTDEE;
						//if (goalTypeGlobal === 'perdida1') suggestedGoalCalories *= 0.90;
						//else if window.goalTypeGlobal === 'ganancia1') suggestedGoalCalories *= 1.10;
						//goalCaloriesInput.value = Math.round(suggestedGoalCalories);
					//}

					// Update macros
					if (proteinPercentageInput && carbPercentageInput && fatPercentageInput) {
						setTimeout(() => actualizarMacrosPorFase(), 100);
					}
					
					
// <-- Esta llave cierra correctamente la función calculateWeightGoal

            // --- Helper Function to Generate Weight Evolution Chart (Step 2) ---
            // NOTA: Esta función debe definirse FUERA de calculateWeightGoal
            function generateWeightEvolutionChart(startWeight, endWeight, weeks) {
                if (!weightChartContainer) return; // Exit if container not found
                weightChartContainer.innerHTML = '<canvas id="weightEvolutionChart"></canvas>'; // Ensure canvas exists
                const ctx = document.getElementById('weightEvolutionChart')?.getContext('2d');
                if (!ctx) {
                     console.error("Failed to get canvas context for weightEvolutionChart");
                     return;
                }
                // Destroy previous instance if exists
                if (weightEvolutionChartInstance) { weightEvolutionChartInstance.destroy(); }
                const labels = Array.from({ length: weeks + 1 }, (_, i) => `Sem ${i}`);
                const weightData = Array.from({ length: weeks + 1 }, (_, i) => {
                    // Linear interpolation between start and end weight
                    return startWeight + (endWeight - startWeight) * (i / weeks);
                });
                weightEvolutionChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Peso Estimado (kg) - Auto',
                             weightData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.1 }]
                        },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: `Evolución Estimada del Peso (${weeks} Semanas - Auto)` },
                            tooltip: { callbacks: { label: function(context) { return `Semana ${context.dataIndex}: ${context.parsed.y.toFixed(2)} kg`; } } }
                            },
                        scales: {
                            y: { title: { display: true, text: 'Peso (kg)' }, ticks: { callback: function(value) { return value.toFixed(1); } } },
                            x: { title: { display: true, text: 'Semanas' } }
                            }
                        }
                });
            }

            // --- Helper Function to Generate Monitoring Info HTML ---
            // NOTA: Esta función también debe definirse FUERA de calculateWeightGoal
            function generateMonitoringHTML() {
                // Static content, can be adjusted if needed
                let monitoringHTML = `<div class="monitoring-section"><h4>Monitorización y Ajustes Sugeridos</h4><h5>Análisis de Sangre</h5><ul><li><strong>Frecuencia:</strong> Cada 12-16 semanas (aproximadamente cada 2-3 ciclos).</li><li><strong>Parámetros a evaluar:</strong><ul><li>Función renal: Creatinina y TFG.</li><li>Función hepática: ALT, AST, bilirrubina.</li><li>Colesterol: Total, LDL, HDL, triglicéridos.</li></ul></li><li><strong>Momentos clave sugeridos (ejemplo para ~55 semanas):</strong><ul><li>Inicio (semana 0).</li><li>Mitad del plan (~semana 28).</li><li>Final (~semana 55).</li></ul><em>Ajusta estos momentos a la duración real de tu plan.</em></li></ul><h5>Reevaluación de Composición Corporal</h5><ul><li><strong>Frecuencia:</strong> Cada 8-12 semanas, idealmente al final de cada ciclo completo.</li><li><strong>Momentos sugeridos (ejemplo para ~55 semanas con ciclos de 7 sem):</strong><ul><li>Semana 7 (final Ciclo 1).</li><li>Semana 21 (final Ciclo 3).</li><li>Semana 35 (final Ciclo 5).</li><li>Semana 49 (final Ciclo 7).</li></ul><em>Ajusta estos momentos a la duración real de tu plan y tus ciclos.</em></li><li><strong>Método:</strong> Bioimpedancia o DEXA.</li><li><strong>Ajustes:</strong> Recalcular GET y ajustar calorías/macros según nuevo peso/composición.</li></ul></div>`;
                return monitoringHTML;
            }

            // --- Funciones de apoyo para macros ---

// Función para ajustar y mostrar el total de porcentajes de macros
function adjustMacroPercentages() {
    const macroPercentageTotalDiv = document.getElementById('macro-percentage-total');
    const proteinPercentageInput = document.getElementById('protein-percentage');
    const carbPercentageInput = document.getElementById('carb-percentage'); 
    const fatPercentageInput = document.getElementById('fat-percentage');
    
    if (!macroPercentageTotalDiv || !proteinPercentageInput || !carbPercentageInput || !fatPercentageInput) {
        return;
    }
    
    const p = parseInt(proteinPercentageInput.value) || 0;
    const c = parseInt(carbPercentageInput.value) || 0;
    const f = parseInt(fatPercentageInput.value) || 0;
    const total = p + c + f;
    
    macroPercentageTotalDiv.textContent = `Total: ${total}%`;
    
    if (total === 100) {
        macroPercentageTotalDiv.style.color = '#388E3C';
        macroPercentageTotalDiv.innerHTML = 'Total: ' + total + '% ✓';
    } else {
        macroPercentageTotalDiv.style.color = '#c62828';
        macroPercentageTotalDiv.innerHTML = 'Total: ' + total + '% ✗';
    }
}

// Event listeners para actualización en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    const proteinInput = document.getElementById('protein-percentage');
    const carbInput = document.getElementById('carb-percentage');
    const fatInput = document.getElementById('fat-percentage');
    
    if (proteinInput) proteinInput.addEventListener('input', adjustMacroPercentages);
    if (carbInput) carbInput.addEventListener('input', adjustMacroPercentages);
    if (fatInput) fatInput.addEventListener('input', adjustMacroPercentages);
    
    adjustMacroPercentages();
});		
            // --- Step 4: Calculate Macronutrients ---

// Variables globales
let macroChartInstance = null;
let modalChartInstance = null;

// Configurar event listeners cuando el DOM esté cargado
	document.addEventListener('DOMContentLoaded', function() {
		// Configurar el modal para reiniciar el chart cuando se cierre
		const macroChartModal = document.getElementById('macroChartModal');
		if (macroChartModal) {
			macroChartModal.addEventListener('hidden.bs.modal', function() {
				if (modalChartInstance) {
					modalChartInstance.destroy();
					modalChartInstance = null;
				}
			});
		}
	});

function calculateMacros() {
    clearContainer(macroResultDiv);
    if(chartContainer) chartContainer.style.display = 'none'; // Hide macro chart
    clearContainer(step5TableContainer); // Clear previous auto table (Step 5)
    displayInfo(step5TableContainer, '<em>Calculando tabla de ciclos automática...</em>'); // Show loading message for auto table

    if (macroChartInstance) { 
        macroChartInstance.destroy(); 
        macroChartInstance = null; 
    }

    // Check prerequisites
    if (!calculatedTDEE || !targetWeightKgGlobal) {
        displayError(macroResultDiv, 'Error: Completa los Pasos 1 y 2 antes de calcular macronutrientes.');
        displayError(step5TableContainer, '<em>Error: Completa los Pasos 1 y 2 para generar la tabla de ciclos automática.</em>');
        updateButtonStates();
        return;
    }

    // Get values from form (using the potentially pre-filled values)
    const goalCalories = parseInt(goalCaloriesInput.value);
    const proteinPerc = parseInt(proteinPercentageInput.value);
    const carbPerc = parseInt(carbPercentageInput.value);
    const fatPerc = parseInt(fatPercentageInput.value);

    // Validate inputs
    if (isNaN(goalCalories) || goalCalories <= 0) {
        displayError(macroResultDiv, 'Por favor, introduce un objetivo calórico válido.');
        displayError(step5TableContainer, '<em>Error: Necesitas un objetivo calórico válido para generar la tabla de ciclos automática.</em>');
        calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 }; // Reset macros
        resetStep4onwards(); // Reset subsequent steps
        resetStep5Table(); // Reset Step 5 table
        updateButtonStates();
        return;
    }
    if (isNaN(proteinPerc) || isNaN(carbPerc) || isNaN(fatPerc) || proteinPerc < 0 || carbPerc < 0 || fatPerc < 0) {
        displayError(macroResultDiv, 'Por favor, introduce porcentajes válidos para los macronutrientes.');
        displayError(step5TableContainer, '<em>Error: Necesitas porcentajes de macros válidos para generar la tabla de ciclos automática.</em>');
        calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 }; // Reset macros
        resetStep4onwards(); // Reset subsequent steps
        resetStep5Table(); // Reset Step 5 table
        updateButtonStates();
        return;
    }

    const totalPercentage = proteinPerc + carbPerc + fatPerc;
    adjustMacroPercentages(); // Update total display

    if (totalPercentage !== 100) {
        displayError(macroResultDiv, `La suma de los porcentajes debe ser 100%. Actualmente es ${totalPercentage}%.`);
        displayError(step5TableContainer, '<em>Error: La suma de porcentajes de macros debe ser 100% para generar la tabla de ciclos automática.</em>');
        calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 }; // Reset macros
        resetStep4onwards(); // Reset subsequent steps
        resetStep5Table(); // Reset Step 5 table
        updateButtonStates();
        return;
    }

    // Calculate grams
    const proteinGrams = (goalCalories * (proteinPerc / 100)) / 4;
    const carbGrams = (goalCalories * (carbPerc / 100)) / 4;
    const fatGrams = (goalCalories * (fatPerc / 100)) / 9;

    // Store calculated macros globally
    calculatedMacros = { proteinGrams, carbGrams, fatGrams, goalCalories };

	let ob = document.getElementById('objetivo').value;

		if (ob === 'perdida1') {
		  ob = 'perdida';
		} else if (ob === 'ganancia1') {
		  ob = 'ganancia';
		} else if (ob === 'mantenimiento1') {
		  ob = 'mantenimiento';
		} else if (ob === 'mixto1') {
		  ob = 'mixto';
		}



    // Display macro results (MANTÉN TU CÓDIGO ORIGINAL)
    macroResultDiv.innerHTML = `<h3>Distribución de Macronutrientes:</h3><p>Para un objetivo de <strong>${window.goalTypeGlobal}</strong> <strong>${goalCalories} kcal/día</strong></p><ul><li><strong>Proteínas:</strong> ${proteinGrams.toFixed(1)} g (${proteinPerc}%)</li><li><strong>Carbohidratos:</strong> ${carbGrams.toFixed(1)} g (${carbPerc}%)</li><li><strong>Grasas:</strong> ${fatGrams.toFixed(1)} g (${fatPerc}%)</li></ul>`;
	  
	  // Mostrar macro-result con animación
		const macroResult = document.getElementById('macro-result');
		if (macroResult) {
			macroResult.style.display = 'block';
			macroResult.style.opacity = '0';
			setTimeout(() => {
				macroResult.style.transition = 'opacity 0.4s ease';
				macroResult.style.opacity = '1';
			}, 100);
		}


    // Preparar el gráfico para mostrarse en el modal
    prepareMacroChart(proteinGrams, carbGrams, fatGrams, goalCalories, proteinPerc, carbPerc, fatPerc);

    // --- Generate Detailed Cycle Table (Step 5 - Auto) ---
    if (goalTypeGlobal !== 'maintenance' && estimatedWeeksGlobal > 0 && currentWeightKg && targetWeightKgGlobal && calculatedTDEE) {
        generateDetailedCycleTable(estimatedWeeksGlobal, currentWeightKg, targetWeightKgGlobal, calculatedTDEE, calculatedMacros.goalCalories, calculatedMacros, goalTypeGlobal, targetWeeklyRateKgGlobal);
    } else if (goalTypeGlobal === 'maintenance') {
        displayInfo(step5TableContainer, '<em>No se requiere tabla de ciclos automática para un objetivo de mantenimiento.</em>');
    } else {
        displayError(step5TableContainer, '<em>Faltan datos de Pasos 1 o 2 para generar la tabla de ciclos automática.</em>');
        console.error("Missing data for detailed (auto) cycle table generation:", { estimatedWeeksGlobal, currentWeightKg, targetWeightKgGlobal, calculatedTDEE, goalTypeGlobal });
    }

    // Reset subsequent steps as Step 3 results changed
    resetStep4onwards();
    updateButtonStates(); // Enable next step button
}

// Función para preparar el gráfico en el modal
function prepareMacroChart(proteinGrams, carbGrams, fatGrams, goalCalories, proteinPerc, carbPerc, fatPerc) {
    // Destruir instancias previas si existen
    if (modalChartInstance) {
        modalChartInstance.destroy();
    }
    
    // Obtener el canvas del modal
    const modalCanvas = document.getElementById('macroChartModalCanvas');
    if (!modalCanvas) {
        console.error("No se encontró el canvas del modal");
        return;
    }
    
    // Crear el gráfico en el modal
    const modalCtx = modalCanvas.getContext('2d');
    modalChartInstance = new Chart(modalCtx, {
        type: 'doughnut',
        data: {
            labels: ['Proteínas (g)', 'Carbohidratos (g)', 'Grasas (g)'],
            datasets: [{
                label: 'Gramos por Macronutriente',
                data: [proteinGrams.toFixed(1), carbGrams.toFixed(1), fatGrams.toFixed(1)],
                backgroundColor: [
                    'rgba(46, 125, 50, 0.7)',
                    'rgba(52, 199, 89, 0.7)', 
                    'rgba(32, 201, 151, 0.7)'
                ],
                borderColor: [
                    'rgba(46, 125, 50, 1)',
                    'rgba(52, 199, 89, 1)',
                    'rgba(32, 201, 151, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                title: {
                    display: true,
                    text: `Distribución de Macronutrientes (${goalCalories} kcal)`
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += context.parsed + ' g';
                                const dataIndex = context.dataIndex;
                                const percentages = [proteinPerc, carbPerc, fatPerc];
                                if (dataIndex < percentages.length) {
                                    label += ` (${percentages[dataIndex]}%)`;
                                }
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
    
    // Mostrar el enlace para abrir el modal (si existe)
    const targetIcon = document.querySelector('.target-icon');
    if (targetIcon) {
        targetIcon.style.display = 'inline-block';
    }
		
	  document.querySelector('[data-bs-target="#macroChartModal"]')
	  .style.display = 'inline-flex';
}

            // --- Step 5: Generate Meal Plan ---
            function generateMealPlan() {
                clearContainer(mealResultDiv);

                // Check prerequisite
                if (calculatedMacros.goalCalories === 0) {
                    displayError(mealResultDiv, 'Por favor, calcula primero tus macronutrientes en el Paso 3.');
                    updateButtonStates();
                    return;
                }

                // Get percentages from form
                const mealPercentages = {
                    breakfast: parseInt(mealForm.elements['breakfast-perc'].value) || 0,
                    snack1: parseInt(mealForm.elements['snack1-perc'].value) || 0,
                    lunch: parseInt(mealForm.elements['lunch-perc'].value) || 0,
                    snack2: parseInt(mealForm.elements['snack2-perc'].value) || 0,
                    dinner: parseInt(mealForm.elements['dinner-perc'].value) || 0
                };
                const totalMealPerc = Object.values(mealPercentages).reduce((sum, perc) => sum + perc, 0);

                adjustMealPercentages(); // Update total display

                if (totalMealPerc !== 100) {
                    displayError(mealResultDiv, `La suma de los porcentajes de comida debe ser 100%. Actualmente es ${totalMealPerc}%.`);
                    return;
                }

                const { proteinGrams, carbGrams, fatGrams, goalCalories } = calculatedMacros;
                let mealPlanHTML = `<h3>Distribución Orientativa por Comida:</h3><p>Basado en ${goalCalories} kcal, ${proteinGrams.toFixed(1)}g Proteína, ${carbGrams.toFixed(1)}g Carbs, ${fatGrams.toFixed(1)}g Grasa.</p>`;

                // Calculate and display macros per meal
                for (const [mealName, percentage] of Object.entries(mealPercentages)) {
                    if (percentage > 0) {
                        const mealCalories = goalCalories * (percentage / 100);
                        const mealProtein = proteinGrams * (percentage / 100);
                        const mealCarbs = carbGrams * (percentage / 100);
                        const mealFat = fatGrams * (percentage / 100);
                        const displayName = mealName.charAt(0).toUpperCase() + mealName.slice(1).replace('snack1', 'Media Mañana').replace('snack2', 'Merienda');

                        mealPlanHTML += `
                            <div class="plan-step" style="margin-bottom: 15px; padding: 15px; background-color: #f5fbf5 !important; border: 1px solid #d4eed5;">
                                <h4>${displayName} (${percentage}%)</h4>
                                <ul>
                                    <li><strong>Calorías:</strong> ~${mealCalories.toFixed(0)} kcal</li>
                                    <li><strong>Proteínas:</strong> ~${mealProtein.toFixed(1)} g</li>
                                    <li><strong>Carbohidratos:</strong> ~${mealCarbs.toFixed(1)} g</li>
                                    <li><strong>Grasas:</strong> ~${mealFat.toFixed(1)} g</li>
                                </ul>
                            </div>`;
                    }
                } 
				
				// Mostrar meal-result con animación
				const mealResult = document.getElementById('meal-result');
				if (mealResult) {
					mealResult.style.display = 'block';
					mealResult.style.opacity = '0';
					setTimeout(() => {
						mealResult.style.transition = 'opacity 0.4s ease';
						mealResult.style.opacity = '1';
					}, 100);
				}
                mealPlanHTML += `<p style="margin-top: 15px; font-style: italic;">Nota: Esta es una distribución matemática. Los alimentos específicos determinarán los macros exactos de cada comida. Consulta a un profesional para crear un plan de comidas detallado.</p>`;
                mealResultDiv.innerHTML = mealPlanHTML;
                updateButtonStates(); // No state changes expected here, but good practice
            }

            // Helper function to adjust and display meal percentages total
            function adjustMealPercentages() {
                 if (!mealPercentageTotalDiv) return;
                 const percentages = [
                    parseInt(mealForm.elements['breakfast-perc'].value) || 0,
                    parseInt(mealForm.elements['snack1-perc'].value) || 0,
                    parseInt(mealForm.elements['lunch-perc'].value) || 0,
                    parseInt(mealForm.elements['snack2-perc'].value) || 0,
                    parseInt(mealForm.elements['dinner-perc'].value) || 0
                 ];
                 const total = percentages.reduce((sum, perc) => sum + perc, 0);
                 mealPercentageTotalDiv.textContent = `Total: ${total}%`;
                 mealPercentageTotalDiv.style.color = total === 100 ? '#388E3C' : '#c62828';
            }


            // --- Step 7 Helper Function to Generate Detailed Cycle Table (Auto) ---
            function generateDetailedCycleTable(totalWeeks, startWeight, endWeight, initialTDEE, phaseCalories, phaseMacros, goalType, weeklyRateKg) {
			const step6TableContainer = document.getElementById('detailed-cycle-table-container');
			clearContainer(step6TableContainer);

			if (goalType === 'maintenance' || totalWeeks <= 0) {
				displayInfo(step6TableContainer, '<em>No se requiere tabla de ciclos para un objetivo de mantenimiento o duración cero.</em>');
				return;
			}
			if (!initialTDEE || !phaseCalories || !phaseMacros || !phaseMacros.proteinGrams || weeklyRateKg === undefined || !userAge || !userHeightCm) {
				displayError(step6TableContainer, '<em>Faltan datos necesarios (TDEE, Calorías/Macros Objetivo, Ritmo Semanal, Datos Usuario) para generar la tabla de ciclos. Asegúrate de completar los pasos 1, 2 y 3.</em>');
				console.error("Missing data for detailed table:", {initialTDEE, phaseCalories, phaseMacros, weeklyRateKg, userAge, userHeightCm});
				return;
			}

			const phaseWeeksPerCycle = 6;
			const breakWeeksPerCycle = 1;
			const cycleDuration = phaseWeeksPerCycle + breakWeeksPerCycle;
			const numFullCycles = Math.floor(totalWeeks / cycleDuration);
			const remainingPhaseWeeks = totalWeeks % cycleDuration;

			const activityMultipliers = userGender === 'male' ? [1.2, 1.56, 1.78, 2.1, 2.3] : [1.2, 1.55, 1.64, 1.82, 2];

			const macroForm = document.getElementById('macro-form');
			const proteinPerc = parseInt(macroForm.elements['protein-percentage'].value);
			const carbPerc = parseInt(macroForm.elements['carb-percentage'].value);
			const fatPerc = parseInt(macroForm.elements['fat-percentage'].value);

			let tableHTML = `
				<table id="detailed-cycle-table">
					<thead>
						<tr>
							<th>Ciclo</th>
							<th>Fase</th>
							<th>Semnanas</th>
							<th>Peso(kg) <br>(Inicio→Fin)</th>
							<th>Calorias/día/AF</th>
							<th>Proteína(g)</th>
							<th>Carbs(g)</th>
							<th>Grasas(g)</th>
						</tr>
					</thead>
					<tbody>`;

			let currentWeek = 0;
			let currentCycleWeight = startWeight;
			const phaseLabel = goalType === 'loss' ? 'Déficit' : 'Superávit';
			const phaseClass = goalType === 'loss' ? 'phase-deficit' : 'phase-surplus';
			const weeklyWeightChange = goalType === 'loss' ? -Math.abs(weeklyRateKg) : Math.abs(weeklyRateKg);

			for (let i = 1; i <= numFullCycles; i++) {
				let weightAtEndOfPhase = currentCycleWeight + (phaseWeeksPerCycle * weeklyWeightChange);
				weightAtEndOfPhase = (goalType === 'loss') ? Math.max(weightAtEndOfPhase, endWeight) : Math.min(weightAtEndOfPhase, endWeight);

				let bmr;
				if (userGender === 'male') {
					bmr = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
				} else {
					bmr = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
				}

				const tdeeAF = activityMultipliers.map(multiplier => bmr * multiplier * 1.1);
				const caloriesAF = tdeeAF.map(tdee => {
					if (goalType === 'loss') return Math.round(tdee * 0.90);
					else if (goalType === 'gain') return Math.round(tdee * 1.1);
					else return Math.round(tdee);
				});

				const macrosAF = caloriesAF.map(cal => {
					const proteinGrams = (cal * (proteinPerc / 100)) / 4;
					const carbGrams = (cal * (carbPerc / 100)) / 4;
					const fatGrams = (cal * (fatPerc / 100)) / 9;
					return { proteinGrams, carbGrams, fatGrams };
				});

				// Formatear calorías y macros como lista vertical
				const caloriesStr = caloriesAF.map((cal, index) => `${index}: ${cal} kcal`).join('<br>');
				const proteinStr = macrosAF.map((macro, index) => `${index}: ${macro.proteinGrams.toFixed(0)} g`).join('<br>');
				const carbsStr = macrosAF.map((macro, index) => `${index}: ${macro.carbGrams.toFixed(0)} g`).join('<br>');
				const fatsStr = macrosAF.map((macro, index) => `${index}: ${macro.fatGrams.toFixed(0)} g`).join('<br>');

				tableHTML += `<tr class="${phaseClass}">
					<td>${i}</td>
					<td>${phaseLabel}</td>
					<td>${phaseWeeksPerCycle}</td>
					<td>${currentCycleWeight.toFixed(1)} → ${weightAtEndOfPhase.toFixed(1)}</td>
					<td>${caloriesStr}</td>
					<td>${proteinStr}</td>
					<td>${carbsStr}</td>
					<td>${fatsStr}</td>
				</tr>`;

				currentCycleWeight = weightAtEndOfPhase;
				currentWeek += phaseWeeksPerCycle;

				if ((goalType === 'loss' && currentCycleWeight <= endWeight) || (goalType === 'gain' && currentCycleWeight >= endWeight)) break;

				let breakBMR;
				if (userGender === 'male') {
					breakBMR = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
				} else {
					breakBMR = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
				}

				const breakTDEEAF = activityMultipliers.map(multiplier => breakBMR * multiplier * 1.1);
				//const breakCaloriesAF = breakTDEEAF.map(tdee => Math.round(tdee));
				const breakCaloriesAF = breakTDEEAF.map(tdee => {
					if (goalType === 'loss') return Math.round(tdee * 0.95);
					else if (goalType === 'gain') return Math.round(tdee * 1.1);
					else return Math.round(tdee);
				});
				const breakMacrosAF = breakCaloriesAF.map(cal => {
					const proteinGrams = (cal * (proteinPerc / 100)) / 4;
					const carbGrams = (cal * (carbPerc / 100)) / 4;
					const fatGrams = (cal * (fatPerc / 100)) / 9;
					return { proteinGrams, carbGrams, fatGrams };
				});

				// Formatear calorías y macros de break como lista vertical
				const breakCaloriesStr = breakCaloriesAF.map((cal, index) => `${index}: ${cal} kcal`).join('<br>');
				const breakProteinStr = breakMacrosAF.map((macro, index) => `${index}: ${macro.proteinGrams.toFixed(0)} g`).join('<br>');
				const breakCarbsStr = breakMacrosAF.map((macro, index) => `${index}: ${macro.carbGrams.toFixed(0)} g`).join('<br>');
				const breakFatsStr = breakMacrosAF.map((macro, index) => `${index}: ${macro.fatGrams.toFixed(0)} g`).join('<br>');

				tableHTML += `<tr class="phase-break">
					<td>${i}</td>
					<td>Break (Mantenimiento)</td>
					<td>${breakWeeksPerCycle}</td>
					<td>~ ${currentCycleWeight.toFixed(1)}</td>
					<td>${breakCaloriesStr}</td>
					<td>${breakProteinStr}</td>
					<td>${breakCarbsStr}</td>
					<td>${breakFatsStr}</td>
				</tr>`;

				currentWeek += breakWeeksPerCycle;

				if ((goalType === 'loss' && currentCycleWeight <= endWeight) || (goalType === 'gain' && currentCycleWeight >= endWeight)) break;
			}

			if (remainingPhaseWeeks > 0 && ((goalType === 'loss' && currentCycleWeight > endWeight) || (goalType === 'gain' && currentCycleWeight < endWeight))) {
				let weightAtEndFinal = currentCycleWeight + (remainingPhaseWeeks * weeklyWeightChange);
				weightAtEndFinal = (goalType === 'loss') ? Math.max(weightAtEndFinal, endWeight) : Math.min(weightAtEndFinal, endWeight);

				let bmrFinal;
				if (userGender === 'male') {
					bmrFinal = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
				} else {
					bmrFinal = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
				}

				const tdeeAFFinal = activityMultipliers.map(multiplier => bmrFinal * multiplier* 1.1);
				const caloriesAFFinal = tdeeAFFinal.map(tdee => {
					if (goalType === 'loss') return Math.round(tdee * 0.90);
					else if (goalType === 'gain') return Math.round(tdee * 1.1);
					else return Math.round(tdee);
				});

				const macrosAFFinal = caloriesAFFinal.map(cal => {
					const proteinGrams = (cal * (proteinPerc / 100)) / 4;
					const carbGrams = (cal * (carbPerc / 100)) / 4;
					const fatGrams = (cal * (fatPerc / 100)) / 9;
					return { proteinGrams, carbGrams, fatGrams };
				});

				// Formatear calorías y macros finales como lista vertical
				const caloriesStrFinal = caloriesAFFinal.map((cal, index) => `${index}: ${cal} kcal`).join('<br>');
				const proteinStrFinal = macrosAFFinal.map((macro, index) => `${index}: ${macro.proteinGrams.toFixed(0)} g`).join('<br>');
				const carbsStrFinal = macrosAFFinal.map((macro, index) => `${index}: ${macro.carbGrams.toFixed(0)} g`).join('<br>');
				const fatsStrFinal = macrosAFFinal.map((macro, index) => `${index}: ${macro.fatGrams.toFixed(0)} g`).join('<br>');

				tableHTML += `<tr class="${phaseClass}">
					<td>${numFullCycles + 1}</td>
					<td>${phaseLabel} (Final)</td>
					<td>${remainingPhaseWeeks}</td>
					<td>${currentCycleWeight.toFixed(1)} → ${weightAtEndFinal.toFixed(1)}</td>
					<td>${caloriesStrFinal}</td>
					<td>${proteinStrFinal}</td>
					<td>${carbsStrFinal}</td>
					<td>${fatsStrFinal}</td>
				</tr>`;
			}

			tableHTML += `</tbody></table>`;
			tableHTML += `<p style="font-size: 0.9em; font-style: italic; margin-top: 10px;">Nota: Esta tabla es una simulación basada en los cálculos automáticos de los Pasos 1-3. Las calorías y macros se ajustan según el nivel de actividad física (AF: 0=Sedentario, 1=Leve, 2=Moderado, 3=Intenso). El progreso real puede variar. Ajusta según sea necesario y consulta a un profesional.</p>`;

			step6TableContainer.innerHTML = tableHTML;
		}

		document.addEventListener('DOMContentLoaded', function() {
		calculateGoalButton.addEventListener('click', function(event) {
			event.preventDefault(); // Prevent form submission
			calculateWeightGoal();
		});
	});
           
/////////////////// --- Step 3: Estimate Time (Manual Calculation) ---////////////////////////////////////
function estimateTimeManually() {
    clearContainer(timeEstimationResultDiv);
    if (timeChartContainer) timeChartContainer.style.display = 'none';
    resetStep7();

    if (timeEstimationChartInstance) {
        timeEstimationChartInstance.destroy();
        timeEstimationChartInstance = null;
    }

    // Reset global variables
    estimatedWeeksManualGlobal = null;
    weightChangeGoalManualGlobal = null;
    weeklyCalorieDiffManualGlobal = null;

    // Check prerequisite
    if (!currentWeightKg) {
        displayError(timeEstimationResultDiv, 'Error: Completa el Paso 1 antes de realizar esta estimación.');
        updateButtonStates();
        return;
    }

    // Get values from form
    const weightChangeGoal = parseFloat(timeEstimationForm.elements['weight-change-goal'].value);
    const weeklyCalorieDiff = parseInt(timeEstimationForm.elements['weekly-calorie-diff'].value);

    console.log("Paso 3:Estimacion Temporal Inputs - weightChangeGoal:", weightChangeGoal, "weeklyCalorieDiff:", weeklyCalorieDiff, "currentWeightKg:", currentWeightKg);

    // Validate inputs
    if (isNaN(weightChangeGoal)) {
        displayError(timeEstimationResultDiv, 'Por favor, introduce un cambio de peso deseado válido.');
        updateButtonStates();
        return;
    }
    if (isNaN(weeklyCalorieDiff) || weeklyCalorieDiff === 0) {
        displayError(timeEstimationResultDiv, 'Por favor, introduce una diferencia calórica semanal válida y distinta de cero.');
        updateButtonStates();
        return;
    }
    if ((weightChangeGoal > 0 && weeklyCalorieDiff < 0) || (weightChangeGoal < 0 && weeklyCalorieDiff > 0)) {
        displayError(timeEstimationResultDiv, 'El signo del cambio de peso debe coincidir con el signo de la diferencia calórica.');
        updateButtonStates();
        return;
    }
	// Asegúrate de que el código se ejecute después de que el DOM esté cargado
		document.addEventListener('DOMContentLoaded', function() {
			// Configurar el modal para reiniciar el chart cuando se cierre
			const modalCalculadoraNoLineal = document.getElementById('modalCalculadoraNoLineal');
			
			if (modalCalculadoraNoLineal) {
				// Usar el evento correcto de Bootstrap
				modalCalculadoraNoLineal.addEventListener('hidden.bs.modal', function() {
					console.log('Modal cerrado'); // Para debugging
					
					// Verificar si la instancia existe antes de destruirla
					if (typeof modalChartInstance !== 'undefined' && modalChartInstance !== null) {
						console.log('Destruyendo chart'); // Para debugging
						modalChartInstance.destroy();
						modalChartInstance = null;
					}
				});
			} else {
				console.log('Modal no encontrado'); // Para debugging
			}
		});
    // === 🔢 CÁLCULO LINEAL (teórico) ===
    const kcalPerKg = 7700;
    const totalKcalChangeNeeded = Math.abs(weightChangeGoal) * kcalPerKg;
    const dailyAdjustmentAbs = Math.abs(weeklyCalorieDiff) / 7;
    let estimatedWeeksLinear = 0;

    if (dailyAdjustmentAbs > 0) {
        const daysNeeded = totalKcalChangeNeeded / dailyAdjustmentAbs;
        estimatedWeeksLinear = Math.ceil(daysNeeded / 7);
    }

    if (weightChangeGoal === 0) {
        estimatedWeeksLinear = 0;
    }
	const currentFatPerc = parseFloat(weightGoalForm.elements['current-fat-percentage'].value);
	const isAthlete = weightGoalForm.elements['is-athlete'].value === 'yes';
	console.log("currentFatPerc:", currentFatPerc);
	console.log("Tipo:", typeof currentFatPerc);
	console.log("¿Es NaN?", isNaN(currentFatPerc));
	
    // === 🔬 CÁLCULO NO LINEAL (realista) - MEPNL v2.1 ===
	
		function calcularTiempoNoLineal(weightChangeGoal, weeklyCalorieDiff, currentWeightKg, userData) {
			const { userGender, userAge, currentFatPerc, isAthlete, activityLevel } = userData;
			const esHombre = userGender === 'male';
			const esPerdida = weightChangeGoal < 0;
			const metaAbs = Math.abs(weightChangeGoal);
			const kcalPerKg = 7700;

			// --- 1. Estimar TDEE y NEAT (simplificado) ---
			const AF_FACTORS = {
				'sedentario': 1.2,
				'leve': 1.4,
				'moderate': 1.6,
				'active': 1.75,
				'very-active': 1.9
			};
			const afFactor = AF_FACTORS[activityLevel] || 1.4;

			// BMR (Mifflin-St Jeor - asumiendo altura promedio si no está disponible)
			const alturaEstimada = esHombre ? 175 : 162; // cm
			const bmr = esHombre 
				? (10 * currentWeightKg) + (6.25 * alturaEstimada) - (5 * userAge) + 5
				: (10 * currentWeightKg) + (6.25 * alturaEstimada) - (5 * userAge) - 161;

			const neatExtra = isAthlete ? 500 : (afFactor >= 1.6 ? 300 : 150);
			const tdee = bmr * afFactor + neatExtra;
			const weeklyEnergyExpenditure = tdee * 7;

			// --- 2. Ajustes personalizados ---
			const esDeportista = isAthlete;
			const porcentajeGrasa = currentFatPerc;

			// Factor de adherencia (puedes hacerlo configurable)
			const adherencia = 0.8;

			// Factor de corrección por tipo de tejido
			const fc = esPerdida 
				? 1.0 
				: (goalTypeGlobal === 'ganancia1' ? 1.25 : 0.85); // 1.25 para ganancia muscular, 0.85 para mixto

			// Caloría efectiva semanal (ajustada por adherencia)
			const weeklyCalorieDiffEffective = adherencia * weeklyCalorieDiff;

			// Tasa inicial (kg/semana)
			const r0 = Math.abs(weeklyCalorieDiffEffective) / (kcalPerKg * fc);

			// --- 3. Parámetros personalizados por usuario ---
			let k, alpha, beta;

			if (esPerdida) {
				// Pérdida: adaptación metabólica
				// === Pérdida ===
				// Para personas con >25% grasa (respuesta más estable)
				alpha = Math.max(0.5, 0.4 * (1 - 0.01 * porcentajeGrasa)); // → ~0.5 para 28%
				k = 0.02; // Ralentización más lenta
			} else {
				// Ganancia: progresión decreciente
				beta = Math.max(0.3, 0.4 * (1 - 0.004 * userAge + (esDeportista ? 0.1 : 0)));
				k = 0.06 * (1 + (userData.isAdvanced ? 0.4 : 0) - (esDeportista ? 0.2 : 0));
			}

			// --- 4. Simular semana a semana ---
			const semanas = [];
			let pesoAcumulado = 0;
			let semana = 0;
			let currentTDEE = tdee; // Para simular adaptación del TDEE
			const factorAdaptacion = calcularFactorAdaptacion(
				userAge, 
				userGender, 
				activityLevel, 
				isAthlete
			);
			while (pesoAcumulado < metaAbs && semana < 100) {
				semana++;

				// Ajuste del TDEE por pérdida de peso (adaptación metabólica)
				if (esPerdida && semana > 4) {
					const pesoPerdidoHastaAhora = (pesoAcumulado / metaAbs) * Math.abs(weightChangeGoal);
					currentTDEE = tdee * (1 - factorAdaptacion * (pesoPerdidoHastaAhora / currentWeightKg));
				}

				// Tasa semanal con decaimiento
				let factorProgresion;
				if (esPerdida) {
					factorProgresion = Math.max(alpha, 1 - k * (semana - 1));
				} else {
					factorProgresion = Math.max(beta || 0.4, 1 - k * (semana - 1));
				}

				let tasaSemanal = r0 * factorProgresion;

				// Ajuste adicional para deportistas en ganancia
				if (!esPerdida && esDeportista) {
					tasaSemanal *= 1.15;
				}

				pesoAcumulado += tasaSemanal;
				semanas.push({
					numero: semana,
					pesoAcumulado: parseFloat(pesoAcumulado.toFixed(2)),
					tasa: parseFloat(tasaSemanal.toFixed(2)),
					tdee: parseFloat(currentTDEE.toFixed(0))
				});
			}

			return {
				semanas,
				totalSemanas: semana,
				metaAlcanzada: pesoAcumulado >= metaAbs,
				tasaInicial: r0,
				finalTDEE: currentTDEE
			};
		}

			// === ✅ DATOS DEL USUARIO (userData) ===
			const userData = {
				userGender,
				userAge,
				currentFatPerc,
				isAthlete: document.getElementById('is-athlete')?.value === 'yes',
				activityLevel: document.getElementById('nivel-actividad')?.value?.toLowerCase(),
				isAdvanced: document.getElementById('is-athlete')?.value === 'yes' // ejemplo simple
			};

			// === 🔗 LLAMADA A LA FUNCIÓN NO LINEAL ===
			const noLineal = calcularTiempoNoLineal(weightChangeGoal, weeklyCalorieDiff, currentWeightKg, userData);
			const estimatedWeeksRealistic = noLineal.totalSemanas;
			window.semanasEstimadasGlobal= estimatedWeeksRealistic
			
			

			// Crear tabla con datos semanales
			const tableData = noLineal.semanas.map(semana => ({
				Semana: semana.numero,
				"Peso Acumulado (kg)": semana.pesoAcumulado,
				"Tasa Semanal (kg)": semana.tasa,
				"TDEE Estimado (kcal/día)": semana.tdee,
			}));
			
			// === 📊 DEBUG: Mostrar evolución semanal en consola ===
			console.log("%c📊 MEPNL v2.1 - Evolución No Lineal", "font-weight: bold; color: #1976d2; font-size: 16px;");
			console.log("🎯 Objetivo:", weightChangeGoal > 0 ? "Ganancia" : "Pérdida", Math.abs(weightChangeGoal), "kg");
			console.log("👤 Usuario:", userGender, "| Edad:", userAge, "| % Grasa:", currentFatPerc, "| Deportista:", isAthlete ? "Sí" : "No");
			console.log("⚡ Diferencia calórica semanal:", weeklyCalorieDiff, "kcal");
			console.log("📅 Semanas estimadas (realista):", estimatedWeeksRealistic);
			console.log("📉 Tasa inicial estimada:", noLineal.tasaInicial.toFixed(3), "kg/semana");
			console.table(tableData);

			// === 📈 Estadísticas finales ===
			console.log("%c📈 Resultados Finales", "font-weight: bold; color: #d84315; font-size: 14px;");
			console.log("✅ Meta alcanzada:", noLineal.metaAlcanzada ? "Sí" : "No");
			console.log("⏱️  Duración:", estimatedWeeksRealistic, "semanas (~" + (estimatedWeeksRealistic / 4.3).toFixed(1) + " meses)");
			console.log("💡 Consejo: Usa esta tabla para ajustar parámetros como 'k', 'alpha', 'beta' o 'adherencia' si el modelo no coincide con casos reales.");

			// === ✅ Almacenar resultados globales con el valor realista como principal ===
			if (isFinite(estimatedWeeksLinear)) {
				estimatedWeeksManualGlobal = estimatedWeeksRealistic;
				weightChangeGoalManualGlobal = weightChangeGoal;
				weeklyCalorieDiffManualGlobal = weeklyCalorieDiff;
			} else {
				estimatedWeeksManualGlobal = null;
				weightChangeGoalManualGlobal = null;
				weeklyCalorieDiffManualGlobal = null;
			}
			

    // === 📊 GENERAR RESULTADOS EDUCATIVOS ===
    let resultHTML = `<h3>Estimación de Tiempo (Manual):</h3>`;
    resultHTML += `<p>Para un cambio de peso de <strong>${weightChangeGoal} kg</strong> con una diferencia calórica semanal de <strong>${weeklyCalorieDiff} kcal</strong>:</p>`;

    if (isFinite(estimatedWeeksLinear) && estimatedWeeksLinear > 0) {
        const esPerdida = weightChangeGoal < 0;
        const rateLinear = Math.abs(weightChangeGoal) / estimatedWeeksLinear;

        // --- Estimación Lineal (teórica) ---
        resultHTML += `
            <div style="margin: 15px 0; padding: 12px; border: 1px solid #bbdefb; border-radius: 6px; background: #e3f2fd;">
                <strong>📊 Estimación Lineal (teórica):</strong>
                <p>Tiempo estimado: <strong>${estimatedWeeksLinear} semanas</strong> (~${(estimatedWeeksLinear / 4.3).toFixed(1)} meses)</p>
                <p><small>Esta estimación asume una pérdida o ganancia <strong>constante de ~${rateLinear.toFixed(2)} kg/semana</strong>, como si tu cuerpo respondiera igual cada semana.</small></p>
                <p><em> Es un cálculo matemático simple, pero <strong>no refleja cómo funciona tu fisiología en la realidad</strong>.</em></p>
            </div>
        `;

				// --- Estimación No Lineal (realista) - CON FEEDBACK AVANZADO ---
					resultHTML += `
						<div style="margin: 15px 0; padding: 12px; border: 1px solid #ffcc80; border-radius: 6px; background: #fff3e0;">
							<strong>🧠 Estimación No Lineal (realista):</strong>
							<p>Tiempo estimado: <strong>${estimatedWeeksRealistic} semanas</strong> (~${(estimatedWeeksRealistic / 4.3).toFixed(1)} meses)</p>
					`;
					
					Math.round((Math.abs(weightChangeGoal) / currentWeightKg	) * 100).toFixed(0);
					const difwk = document.getElementById('weekly-calorie-diff').value
					const PerdidaGanacia= Math.round(Math.abs(difwk) / (window.calculatedTDEE * 7) * 100).toFixed(0);
						document.getElementById('goal-caloriespc').value = PerdidaGanacia
					//kcal/dia=	
						 
					// === 🔍 Variables para personalización ===
					//const esPerdida = weightChangeGoal < 0;
					const porcentajeGrasa = currentFatPerc;
					const edad = userAge;
					const esHombre = userGender === 'male';
					const esDeportista = document.getElementById('is-athlete')?.value === 'yes';
					const nivelActividad = document.getElementById('nivel-actividad')?.value?.toLowerCase();
					const esSedentario = !esDeportista && ['sedentario', 'leve'].includes(nivelActividad);
					const ritmoPromedio = Math.abs(weightChangeGoal) / estimatedWeeksRealistic;

					if (esPerdida) {
						// --- 🔽 PÉRDIDA DE PESO: Feedback hiperpersonalizado ---
						resultHTML += `<p><small>Esta estimación considera cómo <strong>tu cuerpo responde al déficit calórico</strong>, basado en tu perfil único:</small></p>
						<ul style="font-size: 0.95em; margin: 10px 0; padding-left: 20px;">`;

						// 1. SEXO: Diferencias fisiológicas clave
						if (esHombre) {
							resultHTML += `
								<li><strong>Perfil masculino:</strong> 
									Tienes mayor masa magra y testosterona, lo que favorece una pérdida más eficiente al inicio.
									<em> Pero también mayor tendencia a acumular grasa visceral, que se pierde rápido al principio.</em>
								</li>`;
						} else {
							resultHTML += `
								<li><strong>Perfil femenino:</strong> 
									Tu cuerpo prioriza la conservación energética, especialmente con grasa baja. 
									Las hormonas como el estrógeno ralentizan la pérdida por debajo del 25%.
									<em> Es normal que el progreso se detenga en ciertos puntos del ciclo menstrual.</em>
								</li>`;
						}

						// 2. NIVEL DE ACTIVIDAD: Sedentario vs Deportista
						if (esDeportista) {
							resultHTML += `
								<li><strong>Deportista activo:</strong> 
									Tu NEAT y gasto energético son altos, lo que acelera la pérdida al inicio.
									<em> Pero con el tiempo, tu cuerpo se adapta más rápido (efecto de entrenamiento).</em>
								</li>`;
						} else if (esSedentario) {
							resultHTML += `
								<li><strong>Sedentario o baja actividad:</strong> 
									Tu cuerpo tiene menos gasto energético y se adapta más rápido al déficit.
									<em> Pequeñas mejoras en movimiento diario (caminar, moverte) pueden acelerar tu progreso.</em>
								</li>`;
						}

						// 3. % GRASA: Nivel de dificultad
						if (porcentajeGrasa < 18 && esHombre) {
							resultHTML += `
								<li><strong>Definición extrema (<18% H):</strong> 
									Cada % de grasa por debajo del 15% es extremadamente difícil de perder.
									<em> El cuerpo activa mecanismos de supervivencia: baja testosterona, caída del T3.</em>
								</li>`;
						} else if (porcentajeGrasa < 25 && !esHombre) {
							resultHTML += `
								<li><strong>Definición femenina (<25% M):</strong> 
									El cuerpo defiende el tejido adiposo por razones hormonales y reproductivas.
									<em> La pérdida se vuelve muy lenta: ~0.1–0.2 kg/semana es normal.</em>
								</li>`;
						} else if (porcentajeGrasa >= 30) {
							resultHTML += `
								<li><strong>Alta grasa corporal (>30%):</strong> 
									Perderás rápido al inicio (agua, glucógeno, grasa visceral), pero el ritmo se ralentizará.
									<em> Es normal que después de perder 10–15%, el progreso parezca "estancado".</em>
								</li>`;
						}

						// 4. EDAD
						if (edad >= 45) {
							resultHTML += `
								<li><strong>Edad (${edad} años):</strong> 
									El metabolismo basal disminuye ~2–3% por década. La pérdida se vuelve más lenta.
									<em> Necesitas más proteína y entrenamiento de fuerza para preservar músculo.</em>
								</li>`;
						}

						// 5. ADAPTACIÓN METABÓLICA (siempre aplicable)
						resultHTML += `
							<li><strong>Adaptación metabólica:</strong> 
								Tu cuerpo gasta menos energía con el tiempo. Incluso si comes igual, quemas menos.
								<em> Es un mecanismo de supervivencia: el cuerpo se defiende contra la pérdida de peso.</em>
							</li>`;

						resultHTML += `</ul>`;

						// === Conclusión personalizada para pérdida ===
						if (porcentajeGrasa < 20) {
							resultHTML += `<p><em>📌 Aunque empieces perdiendo ~0.5 kg/semana, al final perderás ~${ritmoPromedio.toFixed(2)} kg/semana. Es normal y esperado.</em></p>`;
						} else {
							resultHTML += `<p><em>📌 Al principio perderás rápido, pero el progreso se ralentizará. Este ritmo es sostenible y saludable.</em></p>`;
						}

					} else {
						// --- 🔼 GANANCIA DE PESO: Feedback hiperpersonalizado ---
						resultHTML += `<p><small>Esta estimación considera cómo <strong>tu cuerpo responde al superávit calórico</strong>, basado en tu perfil:</small></p>
						<ul style="font-size: 0.95em; margin: 10px 0; padding-left: 20px;">`;

						// 1. SEXO
						if (esHombre) {
							resultHTML += `
								<li><strong>Perfil masculino:</strong> 
									Tienes mayor capacidad anabólica (testosterona, masa magra), lo que favorece la ganancia muscular.
									<em> Pero también mayor tendencia a acumular grasa si el superávit es alto o descontrolado.</em>
								</li>`;
						} else {
							resultHTML += `
								<li><strong>Perfil femenino:</strong> 
									Tu cuerpo prioriza el almacenamiento energético (grasa) por razones hormonales.
									<em> Ganarás menos músculo y más grasa que un hombre con el mismo superávit.</em>
								</li>`;
						}

						// 2. NIVEL DE ACTIVIDAD
						if (esDeportista) {
							resultHTML += `
								<li><strong>Deportista activo:</strong> 
									Tu músculo está "entrenado" para responder al superávit, pero ya no estás en fase de novato.
									<em> La hipertrofia se vuelve más lenta: ~0.1–0.3 kg músculo/mes es realista.</em>
								</li>`;
						} else if (esSedentario) {
							resultHTML += `
								<li><strong>Sedentario o principiante:</strong> 
									Si es tu primera vez entrenando, tendrás un "efecto novato" fuerte al inicio.
									<em> Ganarás rápido (agua, glucógeno), pero después el progreso se ralentizará mucho.</em>
								</li>`;
						}

						// 3. % GRASA
						if (porcentajeGrasa > 25) {
							resultHTML += `
								<li><strong>Grasa moderada/alta (>25%):</strong> 
									Tu cuerpo almacena más calorías como grasa que como músculo.
									<em> Un superávit que en un magro da músculo, en ti dará más grasa.</em>
								</li>`;
						} else if (porcentajeGrasa <= 18) {
							resultHTML += `
								<li><strong>Baja grasa corporal (<18%):</strong> 
									Estás en un rango ideal para ganancia muscular controlada.
									<em> Puedes aprovechar el superávit para hipertrofia sin acumular mucha grasa.</em>
								</li>`;
						}

						// 4. EDAD
						if (edad >= 45) {
							resultHTML += `
								<li><strong>Edad (${edad} años):</strong> 
									La anabolización muscular disminuye (anarcabolia sarcopénica).
									<em> Necesitas más proteína (1.8–2.4 g/kg) y estimulación para ganar músculo.</em>
								</li>`;
						}

						// 5. ALMACENAMIENTO GRASO
						resultHTML += `
							<li><strong>Mayor almacenamiento graso:</strong> 
								Con el tiempo, más calorías del superávit se almacenan como grasa, no como músculo.
								<em> Solo ~20–30% del peso ganado será músculo puro en fases avanzadas.</em>
							</li>`;

						resultHTML += `</ul>`;

						// === Conclusión personalizada para ganancia ===
						if (esDeportista && edad <= 35) {
							resultHTML += `<p><em>📌 No puedes ganar 0.5 kg de músculo por semana durante meses. La realidad es: rápido al inicio, muy lento después. Este ritmo es óptimo para minimizar grasa.</em></p>`;
						} else {
							resultHTML += `<p><em>📌 El progreso será más lento de lo esperado, pero sostenible. La clave es la constancia, no la velocidad.</em></p>`;
						}
					}

					resultHTML += `</div>`;

					// --- Conclusión educativa ---
					resultHTML += `
						<p style="font-style: italic; color: #555; font-size: 0.95em;">
							<strong>💡 Conclusión:</strong> 
							La composición corporal <strong>no cambia de forma lineal</strong>. 
							Esta estimación realista se usará para generar tu tabla de ciclos (Paso 7).
						</p>
					`;
    } else if (weightChangeGoal === 0) {
        resultHTML += `<p>El cambio de peso deseado es 0 kg (mantenimiento). No se requiere estimación de tiempo.</p>`;
    } else {
        resultHTML += `<p>No se pudo calcular el tiempo estimado con los valores proporcionados.</p>`;
    }

    timeEstimationResultDiv.innerHTML = resultHTML;

    // === 📈 GENERAR GRÁFICO (Linear + Non-Linear) ===
    if (isFinite(estimatedWeeksLinear) && estimatedWeeksLinear > 0 && weightChangeGoal !== 0 && timeChartContainer) {
        const startWeight = currentWeightKg;
        const endWeight = startWeight + weightChangeGoal;
        const maxWeeksToShow = 104;
        const actualWeeks = Math.min(Math.max(estimatedWeeksLinear, estimatedWeeksRealistic), maxWeeksToShow);

        // --- Generar datos para el gráfico (lineal + no lineal) ---
			const chartLabels = [];
			const linearData = [];
			const nonlinearData = [];

			let lastNonlinearWeight = startWeight; // Inicia en el peso actual

			for (let w = 0; w <= actualWeeks; w++) {
				// Etiquetas (menos frecuentes si hay muchas semanas)
				let showLabel = false;
				if (actualWeeks <= 20) showLabel = true;
				else if (actualWeeks <= 52) showLabel = (w % 2 === 0);
				else showLabel = (w % 4 === 0);
				chartLabels.push(showLabel ? `Sem ${w}` : '');

				// === Línea Lineal (teórica) ===
				const progressLinear = w / estimatedWeeksLinear;
				const projectedWeightLinear = startWeight + (weightChangeGoal * Math.min(progressLinear, 1));
				const clampedWeightLinear = (weightChangeGoal < 0)
					? Math.max(projectedWeightLinear, endWeight)
					: Math.min(projectedWeightLinear, endWeight);
				linearData.push(parseFloat(clampedWeightLinear.toFixed(1)));

				// === Línea No Lineal (realista) ===
				const weekData = noLineal.semanas.find(s => s.numero === w);
				
				if (weekData) {
					// Si hay dato para esta semana
					const weightNonlinear = startWeight + (weightChangeGoal < 0 
						? -weekData.pesoAcumulado 
						: weekData.pesoAcumulado);
					lastNonlinearWeight = weightNonlinear; // Guárdalo como número, sin toFixed
				}
				// Si no hay dato (antes de empezar o después), mantener el último valor
				// (esto evita saltos o undefined)
				nonlinearData.push(lastNonlinearWeight);
			}

			// === Asegurar que ambas líneas terminen en el peso objetivo ===
			
				if (estimatedWeeksLinear <= maxWeeksToShow) {
					linearData[actualWeeks] = Math.round(endWeight * 10) / 10;
				}
				if (estimatedWeeksRealistic <= maxWeeksToShow) {
					nonlinearData[actualWeeks] = Math.round(endWeight * 10) / 10;
				}
				
				
			
			
						window.nonlinearProgressData = {
						totalSemanas: actualWeeks + 1,
						nonlinearDataLength: nonlinearData.length,
						nonlinearData: [...nonlinearData], // Copia del array (por seguridad)
						hasUndefined: nonlinearData.some(v => v === undefined || v === null),
						startWeight,
						endWeight,
						timestamp: new Date(), // Opcional: marca de tiempo
					};

						// === 🌐 ALMACENAR TODOS LOS DATOS EN UN OBJETO GLOBAL DETALLADO ===
						window.nonlinearProgressData_1 = {
							// --- 🔖 Metadatos ---
							modelo: "MEPNL v2.1 - Evolución No Lineal",
							version: "2.1",
							timestamp: new Date().toISOString(),
							descripcion: "Datos generados por el modelo no lineal de progreso físico basado en adaptación metabólica.",

							// --- 🎯 Objetivo de cambio de peso ---
							objetivo: {
								tipo: weightChangeGoal > 0 ? "Ganancia" : "Pérdida",
								metaKg: Math.abs(weightChangeGoal),
								pesoInicial: startWeight,
								pesoFinal: endWeight,
							},

							// --- 👤 Información del usuario ---
							usuario: {
								genero: userGender,
								edad: userAge,
								grasaCorporalInicial: currentFatPerc,
								deportista: isAthlete,
								nivelActividad: userActivityLevel, // si lo tienes
								pesoInicial: startWeight,
							},

							// --- 🔧 Parámetros del modelo ---
							parametros: {
								k: noLineal.k?.toFixed(6), // sensibilidad metabólica
								alpha: noLineal.alpha?.toFixed(6), // factor de adaptación positiva
								beta: noLineal.beta?.toFixed(6), // factor de adaptación negativa
								adherencia: noLineal.adherencia, // % de cumplimiento asumido
								tasaInicialKgPorSemana: parseFloat(noLineal.tasaInicial.toFixed(4)),
							},

							// --- 🔥 Variables energéticas ---
							energia: {
								deficitSuperavitSemanalKcal: weeklyCalorieDiff,
								deficitSuperavitDiarioPromedio: Math.round(weeklyCalorieDiff / 7),
								tdeeInicial: Math.round(noLineal.semanas[0]?.tdee), // TDEE semana 1
								tdeeFinal: Math.round(noLineal.semanas[noLineal.semanas.length - 1]?.tdee), // última semana
								tdeeCambioPercent: noLineal.semanas.length > 1 ?
									(((noLineal.semanas[noLineal.semanas.length - 1]?.tdee - noLineal.semanas[0]?.tdee) / noLineal.semanas[0]?.tdee) * 100).toFixed(2) :
									"0.00",
							},

							// --- 📅 Estimaciones temporales ---
							tiempo: {
								semanasEstimadas: estimatedWeeksRealistic,
								mesesEstimados: (estimatedWeeksRealistic / 4.3).toFixed(1),
								fechaEstimadaFinalizacion: new Date(Date.now() + estimatedWeeksRealistic * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
								metaAlcanzada: noLineal.metaAlcanzada,
							},

							// --- 📊 Evolución semanal (tabla) ---
							evolucionSemanal: tableData, // ya formateado como array de objetos

							// --- 📈 Métricas avanzadas ---
							metricas: {
								totalSemanasCalculadas: tableData.length,
								tasaPromedioKgPorSemana: parseFloat(
									(Math.abs(endWeight - startWeight) / tableData.length).toFixed(4)
								),
								cambioTotalPeso: parseFloat((endWeight - startWeight).toFixed(3)),
								//adaptacionMetabolicaPercent: parseFloat(window.nonlinearProgressData_1.energia.tdeeCambioPercent),
								eficienciaModelo: noLineal.metaAlcanzada
									? "Alta (meta alcanzada)"
									: "Media/Baja (ajustar parámetros)",
							},

							// --- 💡 Notas y recomendaciones ---
							notas: [
								"El modelo simula adaptación metabólica progresiva.",
								"La adherencia del usuario impacta fuertemente en la convergencia.",
								"Tasas iniciales altas pueden decaer rápidamente por compensación fisiológica.",
								"Revisar parámetros 'k', 'alpha', 'beta' si los resultados no coinciden con casos reales."
							],
						};

						// === 📣 Mostrar en consola con formato ===

						console.log("%c📊 MEPNL v2.1 - Evolución No Lineal", "font-weight: bold; color: #1976d2; font-size: 16px;");
						console.log("🎯 Objetivo:", window.nonlinearProgressData_1.objetivo.tipo, window.nonlinearProgressData_1.objetivo.metaKg, "kg");
						console.log("👤 Usuario:", window.nonlinearProgressData_1.usuario.genero, "| Edad:", window.nonlinearProgressData_1.usuario.edad, "| % Grasa:", window.nonlinearProgressData_1.usuario.grasaCorporalInicial, "| Deportista:", window.nonlinearProgressData_1.usuario.deportista ? "Sí" : "No");
						console.log("⚡ Diferencia calórica semanal:", window.nonlinearProgressData_1.energia.deficitSuperavitSemanalKcal, "kcal");
						console.log("📅 Semanas estimadas (realista):", window.nonlinearProgressData_1.tiempo.semanasEstimadas);
						console.log("📉 Tasa inicial estimada:", window.nonlinearProgressData_1.parametros.tasaInicialKgPorSemana, "kg/semana");

						// Tabla detallada
						console.table(window.nonlinearProgressData_1.evolucionSemanal);

						// Resultados finales
						console.log("%c📈 Resultados Finales", "font-weight: bold; color: #d84315; font-size: 14px;");
						console.log("✅ Meta alcanzada:", window.nonlinearProgressData_1.tiempo.metaAlcanzada ? "Sí" : "No");
						console.log("⏱️  Duración:", window.nonlinearProgressData_1.tiempo.semanasEstimadas, "semanas (~" + window.nonlinearProgressData_1.tiempo.mesesEstimados + " meses)");
						console.log("⚖️  Peso inicial:", window.nonlinearProgressData_1.objetivo.pesoInicial, "kg → Peso final:", window.nonlinearProgressData_1.objetivo.pesoFinal, "kg");
						console.log("💡 TDEE inicial:", window.nonlinearProgressData_1.energia.tdeeInicial, "kcal/día → final:", window.nonlinearProgressData_1.energia.tdeeFinal, "kcal/día (" + window.nonlinearProgressData_1.energia.tdeeCambioPercent + "%)");
						console.log("📊 Tasa promedio:", window.nonlinearProgressData_1.metricas.tasaPromedioKgPorSemana, "kg/semana");



        timeChartContainer.innerHTML = '<canvas id="timeEstimationChart"></canvas>';
        const ctx = document.getElementById('timeEstimationChart')?.getContext('2d');
        if (!ctx) {
            console.error("Failed to get canvas context for timeEstimationChart");
            displayError(timeEstimationResultDiv, "Error: No se pudo renderizar el gráfico.");
            updateButtonStates();
            return;
        }

        try {
            timeEstimationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                   datasets: [
						{
							label: 'Proyección Lineal (Teórica)',
							 data:linearData,
							borderColor: '#2E7D32', // Verde oscuro
							backgroundColor: 'rgba(46, 125, 50, 0.2)',
							fill: false,
							tension: 0.1,
							borderWidth: 3,        // Línea más gruesa
							pointRadius: 2,        // Puntos más grandes
							pointHoverRadius: 4,
							//pointBackgroundColor: '#2E7D32'
						},
						{
							label: 'Proyección No Lineal (Realista)',
							 data:nonlinearData,
							borderColor: '#F57C00',
							backgroundColor: 'rgba(245, 124, 0, 0.1)',
							fill: false,
							tension: 0.1,
							borderWidth: 3,        // ¡Más gruesa que la otra!
							borderDash: [5, 5],    // Línea punteada para diferenciar
							pointRadius: 2,
							pointHoverRadius: 4,
							//pointBackgroundColor: '#D84315'
						}
					]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top', labels: { usePointStyle: true } },
                        title: {
                            display: true,
                            text: `Comparación: Proyección Lineal vs. Realista (${startWeight.toFixed(1)} kg → ${endWeight.toFixed(1)} kg)`,
                            font: { size: 16 },
                            color: '#1B5E20'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const dataIndex = tooltipItems[0].dataIndex;
                                    let weekNum = '?';
                                    for (let i = dataIndex; i >= 0; i--) {
                                        const label = chartLabels[i];
                                        if (label && label.startsWith('Sem ')) {
                                            weekNum = label.substring(4);
                                            break;
                                        }
                                    }
                                    return `Semana ${weekNum}`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} kg`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Peso (kg)', color: '#1B5E20' },
                            ticks: { color: '#1B5E20', callback: value => value.toFixed(1) },
                            min: Math.min(startWeight, endWeight) - 2,
                            max: Math.max(startWeight, endWeight) + 2
                        },
                        x: {
                            title: { display: true, text: 'Semanas', color: '#1B5E20' },
                            ticks: { color: '#1B5E20', maxRotation: 0, minRotation: 0 }
                        }
                    }
                }
            });
			
			
			// Mostrar time-estimation-result con animación
			const timeEstimationResult = document.getElementById('time-estimation-result');
			if (timeEstimationResult) {
				timeEstimationResult.style.display = 'block';
				timeEstimationResult.style.opacity = '0';
				setTimeout(() => {
					timeEstimationResult.style.transition = 'opacity 0.4s ease';
					timeEstimationResult.style.opacity = '1';
				}, 100);
			}
            timeChartContainer.style.display = 'block';
            console.log("Step 6 Chart rendered with linear and non-linear projections");
        } catch (error) {
            console.error("Error rendering Step 6 chart:", error);
            displayError(timeEstimationResultDiv, "Error al renderizar el gráfico de estimación.");
        }
    } else {
        if (timeChartContainer) timeChartContainer.style.display = 'none';
    }
	
    updateButtonStates();
	// Mostrar el icono del gráfico después de la estimación
    const chartIconLink = document.querySelector('a[data-bs-target="#modalCalculadoraNoLineal"]');
    if (chartIconLink) {
        chartIconLink.style.display = 'inline-flex'; // o 'inline-block' según tu diseño
    }
}

function calcularFactorAdaptacion(edad, sexo, nivelActividad, esDeportista) {
    let factorBase = 0.15; // Factor por defecto
    
    // === POR EDAD ===
    if (edad >= 65) {
        factorBase += 0.10; // +67% más adaptación
    } else if (edad >= 55) {
        factorBase += 0.08; // +53% más adaptación
    } else if (edad >= 45) {
        factorBase += 0.05; // +33% más adaptación
    } else if (edad >= 35) {
        factorBase += 0.03; // +20% más adaptación
    }
    // < 35 años: factor base
    
    // === POR SEXO ===
    if (sexo === 'female') {
        factorBase += 0.05; // +33% más adaptación (mayor defensa energética)
    }
    
    // === POR NIVEL DE ACTIVIDAD ===
    const factoresActividad = {
        'sedentario': 0.08,   // +53% adaptación
        'leve': 0.05,         // +33% adaptación
        'moderate': 0.03,     // +20% adaptación
        'active': 0.01,       // +7% adaptación
        'very-active': 0.00   // Base (menos adaptación)
    };
    
    factorBase += factoresActividad[nivelActividad] || 0.05;
    
    // === POR SER DEPORTISTA ===
    if (esDeportista) {
        factorBase -= 0.03; // -20% menos adaptación (mejor metabolismo)
    }
    
    // === LÍMITES ===
    return Math.max(0.10, Math.min(0.40, factorBase)); // Entre 0.10 y 0.40
}
          




		  // --- Step 7: Generate Hyperprotein Cycle Table (Manual) ---
            // Function definition moved outside DOMContentLoaded for onclick

            // --- PDF Generation ---
            function guardarComoPDF() {
                if (!calculatedTDEE) {
                    alert("Por favor, completa al menos el Paso 1 (Cálculo de Necesidades) antes de generar el PDF.");
                    return;
                }

                const mainElement = document.querySelector('main');
                const headerElement = document.querySelector('header');
                const footerElement = document.querySelector('footer');
                const allButtons = document.querySelectorAll('button'); // Select all buttons

                // Store original display styles
                const originalDisplays = new Map();
                const elementsToHide = [headerElement, footerElement, ...allButtons];
                elementsToHide.forEach(el => {
                    if (el) {
                        originalDisplays.set(el, el.style.display);
                        el.style.display = 'none';
                    }
                });


                // Temporarily make chart containers visible if they have content
                const chartContainers = document.querySelectorAll('#chart-container, #weight-chart-container, #time-estimation-chart-container');
                chartContainers.forEach(container => {
                    if (container) {
                        originalDisplays.set(container, container.style.display);
                        // Only make visible if it actually contains a chart canvas
                        if (container.querySelector('canvas') && container.style.display === 'none') {
                            container.style.display = 'block';
                        }
                    }
                });

                // Make tables visible if they have content
                const tableContainers = document.querySelectorAll('#detailed-cycle-table-container, #hyperprotein-cycle-table-container');
                 tableContainers.forEach(container => {
                     if (container) {
                         const table = container.querySelector('table');
                         // Check if table exists and is not already visible but has rows
                         if (table) {
                             originalDisplays.set(table, table.style.display);
                             if (table.style.display === 'none' && table.querySelector('tbody tr')) {
                                 table.style.display = 'table'; // Make visible for PDF
                             }
                         }
                     }
                 });


                const opt = {
                    margin: [15, 10, 15, 10], // top, left, bottom, left margins in mm
                    filename: 'NutriPlan_Plan_Dietetico_Personalizado.pdf',
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        // Try to capture full width/height
                        windowWidth: mainElement.scrollWidth,
                        windowHeight: mainElement.scrollHeight
                        },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.plan-step' } // Try to avoid breaking inside steps
                };

                console.log("Generating PDF...");
                html2pdf().from(mainElement).set(opt).save().then(() => {
                    console.log("PDF generated successfully.");
                    // Restore original display styles
                    originalDisplays.forEach((display, element) => {
                        if (element) {
                            element.style.display = display;
                        }
                    });
                }).catch(err => {
                    console.error("Error generating PDF:", err);
                    alert("Hubo un error al generar el PDF. Revisa la consola del navegador (F12) para más detalles.");
                    // Restore original display styles even on error
                     originalDisplays.forEach((display, element) => {
                        if (element) {
                            element.style.display = display;
                        }
                    });
                });
            }

            // --- Reset Functions ---
            /** Resets Step 2 results and dependent steps */
            function resetStep2onwards() {
                clearContainer(weightGoalResultDiv);
                displayInfo(weightGoalResultDiv, 'Completa el Paso 1 para habilitar este cálculo.');
                if(weightChartContainer) weightChartContainer.style.display = 'none';
                if (weightEvolutionChartInstance) { weightEvolutionChartInstance.destroy(); weightEvolutionChartInstance = null; }
                targetWeightKgGlobal = null;
                goalTypeGlobal = 'maintenance';
                estimatedWeeksGlobal = 0;
                targetWeeklyRateKgGlobal = 0;
                if (goalCaloriesInput) goalCaloriesInput.value = ''; // Clear goal calories input
                // Reset macro percentages to default initial values
                if (proteinPercentageInput) proteinPercentageInput.value = 30;
                if (carbPercentageInput) carbPercentageInput.value = 40;
                if (fatPercentageInput) fatPercentageInput.value = 30;
                adjustMacroPercentages(); // Update total display
                resetStep3onwards(); // Also reset subsequent steps
            }

            /** Resets Step 3 results and dependent steps */
            function resetStep3onwards() {
                clearContainer(macroResultDiv);
                displayInfo(macroResultDiv, 'Completa los Pasos 1 y 2 para habilitar este cálculo.');
                if(chartContainer) chartContainer.style.display = 'none'; // Hide macro chart
                if (macroChartInstance) { macroChartInstance.destroy(); macroChartInstance = null; }
                calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 };
                resetStep4onwards(); // Also reset subsequent steps
                resetStep5Table(); // Reset Step 5 table
            }

            /** Resets Step 4 results */
            function resetStep4onwards() {
                clearContainer(mealResultDiv);
                displayInfo(mealResultDiv, 'Completa el Paso 3 para habilitar este cálculo.');
            }

             /** Resets Step 5 (Auto Table) results */
            function resetStep5Table() {
                clearContainer(step5TableContainer);
                displayInfo(step5TableContainer, '<em>Completa los Pasos 1, 2 y 3 para generar esta tabla automática.</em>');
            }

            /** Resets Step 6 (Manual Estimation) results */
            function resetStep6() {
                clearContainer(timeEstimationResultDiv);
                displayInfo(timeEstimationResultDiv, 'Completa el Paso 1 para habilitar esta estimación.');
                if(timeChartContainer) timeChartContainer.style.display = 'none';
                if (timeEstimationChartInstance) { timeEstimationChartInstance.destroy(); timeEstimationChartInstance = null; }
                // Reset related globals
                estimatedWeeksManualGlobal = null;
                weightChangeGoalManualGlobal = null;
                weeklyCalorieDiffManualGlobal = null;
                resetStep7(); // Reset manual table as well
                updateButtonStates(); // Update button states after reset
            }

            /** Resets Step 7 (Manual Table) results */
            function resetStep7() {
                if (hyperproteinTableBody) hyperproteinTableBody.innerHTML = '';
                if (hyperproteinTable) hyperproteinTable.style.display = 'none';
                if (hyperproteinInfoMessage) hyperproteinInfoMessage.style.display = 'block';
                if (hyperproteinInfoMessage) hyperproteinInfoMessage.innerHTML = '<em>Completa el Paso 6 para generar esta tabla.</em>';
                if (hyperproteinNoteContainer) hyperproteinNoteContainer.innerHTML = ''; // Clear the note
                // Button state is handled by updateButtonStates called in resetStep6
            }


            // --- Event Listeners Setup ---
            if (calorieForm) {
                calorieForm.addEventListener('submit', (event) => {
                    event.preventDefault(); // Prevent default form submission
                    calculateCalories();
                });
            }
             if (weightGoalForm) {
                weightGoalForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    calculateWeightGoal();
                });
            }
             if (macroForm) {
                macroForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    calculateMacros();
					//calcularMacros(); 
                });
            }
            if (mealForm) {
                 mealForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    generateMealPlan();
                });
            }
             if (timeEstimationForm) {
                 timeEstimationForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    estimateTimeManually();
                });
            }
             if (savePdfButton) {
                 savePdfButton.addEventListener('click', guardarComoPDF);
             }
			event.preventDefault();
			
			calcularMacros(); 
             // Listeners for live percentage updates
             if(proteinPercentageInput && carbPercentageInput && fatPercentageInput) { // Check if elements exist before adding listeners
                 proteinPercentageInput.addEventListener('input', adjustMacroPercentages);
                 carbPercentageInput.addEventListener('input', adjustMacroPercentages);
                 fatPercentageInput.addEventListener('input', adjustMacroPercentages);
             }
             if(mealPercentageInputs) {
                 mealPercentageInputs.forEach(input => {
                     input.addEventListener('input', adjustMealPercentages);
                 });
             }


            // --- Initial Setup Calls ---
            adjustMacroPercentages(); // Initial calculation for macro total
            adjustMealPercentages();  // Initial calculation for meal total
            updateButtonStates();     // Set initial button disabled states

        }); 
		
		// End of DOMContentLoaded listener


        // --- Step 7: Generate Hyperprotein Cycle Table (Manual) ---
        // Needs to be globally accessible for the onclick attribute
        /**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Requires global variables from Step 1 (user data) and Step 6 (manual estimation).
 */
/**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Shows Kcal/day and protein intake for all activity levels (0: Sedentary, 1: Light, 2: Moderate, 3: Active, 4: Very Active).
 */
/**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Shows Kcal/day and protein intake (g and g/kg) for all activity levels (0: Sedentary, 1: Light, 2: Moderate, 3: Active, 4: Very Active).
 * Table columns: Ciclo, Fase, Semanas, Peso (kg), Kcal/día/AF, Proteínas (g/kg), Ajuste Calórico.
 */
/**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Shows Kcal/day and protein intake (g and g/kg) for all activity levels (0: Sedentary, 1: Light, 2: Moderate, 3: Active, 4: Very Active).
 * Limits protein intake to a maximum of 2.5 g/kg of body weight.
 * Table columns: Ciclo, Fase, Semanas, Peso (kg), Kcal/día/AF, Proteínas (g/kg), Notas.
 */
function generateHyperproteinCycles() {
    // DOM references
    const tableContainer = document.getElementById('hyperprotein-cycle-table-container');
    const table = document.getElementById('hyperprotein-cycle-table');
    const tableBody = document.getElementById('hyperprotein-cycle-table-body');
    const infoMessage = document.getElementById('hyperprotein-info-message');
    const noteContainer = document.getElementById('hyperprotein-note-container');

    // Clear previous content
    if (tableBody) tableBody.innerHTML = '';
    if (table) table.style.display = 'none';
    if (infoMessage) infoMessage.style.display = 'block';
    if (noteContainer) noteContainer.innerHTML = '';

    // Validate prerequisites
    if (!currentWeightKg || !userAge || !userHeightCm || !userGender || !userActivityLevel ||
        estimatedWeeksManualGlobal === null || estimatedWeeksManualGlobal <= 0 ||
        weightChangeGoalManualGlobal === null || weeklyCalorieDiffManualGlobal === null ||
        isNaN(weeklyCalorieDiffManualGlobal) || weeklyCalorieDiffManualGlobal === 0) {
        if (infoMessage) {
            infoMessage.innerHTML = '<em>Completa el Paso 6 (Estimación Manual) con valores válidos (tiempo > 0 semanas, diferencia calórica distinta de cero) y asegúrate de haber completado el Paso 1.</em>';
        }
        console.warn("Prerequisites for Step 7 not met:", {
            currentWeightKg, userAge, userHeightCm, userGender, userActivityLevel,
            estimatedWeeksManualGlobal, weightChangeGoalManualGlobal, weeklyCalorieDiffManualGlobal
        });
        return;
    }

    // Additional input validations
    if (currentWeightKg <= 0 || isNaN(currentWeightKg)) {
        if (infoMessage) infoMessage.innerHTML = '<em>El peso actual debe ser un valor positivo válido.</em>';
        return;
    }
    if (Math.abs(weightChangeGoalManualGlobal) < 0.1 && goalType !== 'maintenance') {
        if (infoMessage) infoMessage.innerHTML = '<em>El cambio de peso debe ser significativo para generar ciclos.</em>';
        return;
    }

    // Define multiplicadores por género usando valores numéricos como strings
    const maleActivityMultipliers = {
        '1.2': 1.2,    // sedentary
        '1.375': 1.56, // light
        '1.55': 1.78,  // moderate
        '1.725': 2.1,  // active
        '1.9': 2.3     // very_active
    };

    const femaleActivityMultipliers = {
        '1.2': 1.2,    // sedentary
        '1.375': 1.55, // light
        '1.55': 1.64,  // moderate
        '1.725': 1.82, // active
        '1.9': 2.0     // very_active
    };

    // Selecciona el objeto según el género
    const activityMultipliers = userGender === 'male' ? maleActivityMultipliers : femaleActivityMultipliers;

    // Define activity levels array based on available multipliers
    const activityLevels = Object.keys(activityMultipliers); // ['1.2', '1.375', '1.55', '1.725', '1.9']

    // Map activity levels to descriptive names for better UX
    const activityLevelNames = {
        '1.2': 'Sedentario',
        '1.375': 'Ligero',
        '1.55': 'Moderado',
        '1.725': 'Activo',
        '1.9': 'Muy Activo'
    };

    // Validate activity level with detailed error handling
    const activityMultiplier = activityMultipliers[userActivityLevel];
    if (activityMultiplier === undefined) {
        const errorMessage = `Nivel de actividad no válido: "${userActivityLevel}". Valores permitidos: ${Object.keys(activityMultipliers).join(', ')}`;
        
        if (infoMessage) {
            infoMessage.innerHTML = `<em>Error: ${errorMessage}</em>`;
        }
        
        console.error("Invalid activity level:", userActivityLevel);
        console.log("Available activity levels:", Object.keys(activityMultipliers));
        console.log("User gender:", userGender);
        
        return;
    }

    // Use stored global values
    const totalWeeks = estimatedWeeksManualGlobal;
    const weightChangeGoal = weightChangeGoalManualGlobal;
    const weeklyCalorieDiff = weeklyCalorieDiffManualGlobal;
    const goalType = weightChangeGoal < 0 ? 'loss' : (weightChangeGoal > 0 ? 'gain' : 'maintenance');

    if (goalType === 'maintenance') {
        if (infoMessage) infoMessage.innerHTML = '<em>No se requiere tabla de ciclos hiperproteicos para un objetivo de mantenimiento.</em>';
        return;
    }

    // Calculate weekly weight change
    const weeklyRateKg = weightChangeGoal / totalWeeks;
    const dailyCalorieDiff = weeklyCalorieDiff / 7;
    const dailyCalorieDiffBreak = (weeklyCalorieDiff * 0.5) / 7; // Reduced deficit for break phase

    // Cycle configuration
    const phaseWeeksPerCycle = 4;
    const breakWeeksPerCycle = 1;
    const cycleDuration = phaseWeeksPerCycle + breakWeeksPerCycle;

    let currentWeek = 0;
    let currentWeight = currentWeightKg;
    let cycleCount = 1;

    console.log("Generating Step 7 Table:", { totalWeeks, weightChangeGoal, weeklyCalorieDiff, weeklyRateKg, goalType, dailyCalorieDiff, dailyCalorieDiffBreak });

    // Helper function to round to nearest multiple
    const roundToNearest = (value, multiple) => Math.round(value / multiple) * multiple;

    // Helper function to format calories and proteins for all activity levels
    const formatCaloriesAndProteins = (bmr, calorieDiff, proteinPercentage, weight) => {
        const calories = activityLevels.map((level, index) => {
            const tdee = bmr * activityMultipliers[level] + calorieDiff;
            return roundToNearest(tdee, 10);
        });
        const proteins = calories.map(kcal => {
            let proteinGrams = roundToNearest((kcal * proteinPercentage) / 4, 1);
            // Limit gPerKg to 2.5 g/kg
            const maxProteinGrams = weight > 0 ? roundToNearest(2.5 * weight, 1) : proteinGrams;
            if (weight > 0 && proteinGrams / weight > 2.5) {
                proteinGrams = maxProteinGrams;
            }
            return proteinGrams;
        });
        const proteinsText = proteins.map((g, index) => {
            const gPerKg = weight > 0 ? (g / weight).toFixed(1) : '0.0';
            return `${index}: ${g} g / ${gPerKg} g/kg`;
        }).join('<br>');
        return { calories, proteinsText };
    };

    // ... resto de tu código ...

    while (currentWeek < totalWeeks) {
        // --- Hyperprotein Phase ---
        const phaseDuration = Math.min(phaseWeeksPerCycle, totalWeeks - currentWeek);
        if (phaseDuration <= 0) break;

        const phaseWeightChange = weeklyRateKg * phaseDuration;
        let phaseEndWeight = currentWeight + phaseWeightChange;
        phaseEndWeight = goalType === 'loss'
            ? Math.max(phaseEndWeight, currentWeightKg + weightChangeGoal)
            : Math.min(phaseEndWeight, currentWeightKg + weightChangeGoal);

        // Calculate BMR
        let phaseStartBMR;
        if (userGender === 'male') {
            phaseStartBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else {
            phaseStartBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        // Calculate calories and proteins for all activity levels
        const { calories: phaseCalories, proteinsText: phaseProteinsText } = formatCaloriesAndProteins(phaseStartBMR, dailyCalorieDiff, 0.35, currentWeight);

        // Validate calorie range
        if (phaseCalories.some(kcal => kcal < 1000 || kcal > 5000)) {
            if (infoMessage) infoMessage.innerHTML = '<em>Las calorías calculadas para la fase hiperproteica no son realistas. Revisa la diferencia calórica semanal.</em>';
            console.warn("Unrealistic phase calories:", phaseCalories);
            return;
        }

        // Format calories for display
        const phaseCaloriesText = phaseCalories.map((kcal, index) => `${index}: ${kcal} kcal`).join('<br>');

        const hyperproteinRow = document.createElement('tr');
        hyperproteinRow.classList.add('phase-hyperprotein');
        hyperproteinRow.innerHTML = `
            <td>${cycleCount}</td>
            <td>Hiperproteico</td>
            <td>${phaseDuration}</td>
            <td>${currentWeight.toFixed(1)} → ${phaseEndWeight.toFixed(1)}</td>
            <td>${phaseCaloriesText}</td>
            <td>${phaseProteinsText}</td>
            <td>${goalType === 'loss' ? `Déficit (${dailyCalorieDiff.toFixed(0)} kcal/d)` : `Superávit (+${dailyCalorieDiff.toFixed(0)} kcal/d)`}</td>
        `;
        if (tableBody) tableBody.appendChild(hyperproteinRow);

        currentWeek += phaseDuration;
        currentWeight = phaseEndWeight;

        // Exit if target weight reached (tolerance 0.05)
        if ((goalType === 'loss' && currentWeight <= currentWeightKg + weightChangeGoal + 0.05) ||
            (goalType === 'gain' && currentWeight >= currentWeightKg + weightChangeGoal - 0.05)) {
            break;
        }

        // --- Break Phase ---
        if (currentWeek < totalWeeks) {
            const breakDuration = Math.min(breakWeeksPerCycle, totalWeeks - currentWeek);
            if (breakDuration <= 0) break;

            let breakBMR;
            if (userGender === 'male') {
                breakBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
            } else {
                breakBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
            }

            // Calculate calories and proteins for all activity levels
            const { calories: breakCalories, proteinsText: breakProteinsText } = formatCaloriesAndProteins(breakBMR, dailyCalorieDiffBreak, 0.25, currentWeight);

            // Validate calorie range
            if (breakCalories.some(kcal => kcal < 1000 || kcal > 5000)) {
                if (infoMessage) infoMessage.innerHTML = '<em>Las calorías calculadas para la fase de break no son realistas. Revisa los datos de entrada.</em>';
                console.warn("Unrealistic break calories:", breakCalories);
                return;
            }

            // Format calories for display
            const breakCaloriesText = breakCalories.map((kcal, index) => `${kcal} kcal`).join('<br>');

            const breakRow = document.createElement('tr');
            breakRow.classList.add('phase-break');
            breakRow.innerHTML = `
                <td>${cycleCount}</td>
                <td>Break (Pérdida Reducida)</td>
                <td>${breakDuration}</td>
                <td>~ ${currentWeight.toFixed(1)}</td>
                <td>${breakCaloriesText}</td>
                <td>${breakProteinsText}</td>
                <td>Déficit reducido (${dailyCalorieDiffBreak.toFixed(0)} kcal/d)</td>
            `;
            if (tableBody) tableBody.appendChild(breakRow);

            // Update weight for reduced loss in break phase
            const breakWeightChange = (weeklyRateKg * 0.5) * breakDuration;
            currentWeight += breakWeightChange;

            currentWeek += breakDuration;
            cycleCount++;
        }

        // Exit if target weight reached during break
        if ((goalType === 'loss' && currentWeight <= currentWeightKg + weightChangeGoal + 0.05) ||
            (goalType === 'gain' && currentWeight >= currentWeightKg + weightChangeGoal - 0.05)) {
            break;
        }
    }

    // Correct final weight display directly
    if (tableBody && tableBody.lastElementChild) {
        const lastRowCells = tableBody.lastElementChild.cells;
        if (lastRowCells && lastRowCells.length > 3) {
            const weightCell = lastRowCells[3];
            const finalTargetWeight = currentWeightKg + weightChangeGoal;
            const currentText = weightCell.textContent;
            const startWeightMatch = currentText.match(/^(-?\d+\.\d)/); // Match start weight
            if (startWeightMatch && Math.abs(currentWeight - finalTargetWeight) > 0.05) {
                weightCell.innerHTML = `${startWeightMatch[1]} → ${finalTargetWeight.toFixed(1)}`;
                console.log(`Corrected final weight display to ${finalTargetWeight.toFixed(1)}`);
            }
        }
    }

    // Show table and hide info message
    if (table) table.style.display = 'table';
    if (infoMessage) infoMessage.style.display = 'none';

    // Add note
    if (noteContainer) {
        const note = document.createElement('p');
        note.style.fontSize = '0.9em';
        note.style.fontStyle = 'italic';
        note.style.marginTop = '10px';
        note.textContent = 'Nota: Esta tabla es una simulación basada en la estimación manual del Paso 6. Las calorías y proteínas se muestran para todos los niveles de actividad (0: Sedentario, 1: Leve, 2: Moderado, 3: Activo, 4: Muy Activo). Proteínas limitadas a un máximo de 2.5 g/kg. Ajusta según progreso real y consulta a un profesional.';
        noteContainer.appendChild(note);
    }
}

    
	


  /// actualizador barras graficas de macronutrientes////////////////
  
    document.addEventListener('DOMContentLoaded', function() {
        // Obtener referencias a los inputs
        const proteinInput = document.getElementById('protein-percentage');
        const carbInput = document.getElementById('carb-percentage');
        const fatInput = document.getElementById('fat-percentage');
        
        // Obtener referencias a las barras
        const proteinBar = document.querySelector('.protein-bar');
        const carbsBar = document.querySelector('.carbs-bar');
        const fatBar = document.querySelector('.fat-bar');
        
        // Obtener referencias a las etiquetas
        const proteinLabel = document.querySelector('.protein-label');
        const carbsLabel = document.querySelector('.carbs-label');
        const fatLabel = document.querySelector('.fat-label');
        
        // Obtener referencia al total
        const totalDisplay = document.getElementById('macro-percentage-total');
        
        // Función para actualizar las barras y etiquetas
        function updateMacroBars() {
            // Obtener valores de los inputs
            const proteinValue = parseInt(proteinInput.value) || 0;
            const carbValue = parseInt(carbInput.value) || 0;
            const fatValue = parseInt(fatInput.value) || 0;
            
            // Calcular el total
            const total = proteinValue + carbValue + fatValue;
            
            // Actualizar las barras
            proteinBar.style.width = proteinValue + '%';
            carbsBar.style.width = carbValue + '%';
            fatBar.style.width = fatValue + '%';
            
            // Actualizar las etiquetas
            proteinLabel.textContent = 'Proteína: ' + proteinValue + '%';
            carbsLabel.textContent = 'Carbohidratos: ' + carbValue + '%';
            fatLabel.textContent = 'Grasas: ' + fatValue + '%';
            
            // Actualizar el total
            totalDisplay.textContent = 'Total: ' + total + '%';
            
            // Cambiar color según el total
            if (total === 100) {
                totalDisplay.style.color = '#4CAF50';
                totalDisplay.innerHTML = 'Total: ' + total + '% ✓';
            } else {
                totalDisplay.style.color = '#F44336';
                totalDisplay.innerHTML = 'Total: ' + total + '% ✗';
            }
        }
        
        // Añadir event listeners a los inputs para cambios manuales
        proteinInput.addEventListener('input', updateMacroBars);
        carbInput.addEventListener('input', updateMacroBars);
        fatInput.addEventListener('input', updateMacroBars);
        
        // Crear observadores para cambios automáticos en los inputs
        function createObserver(inputElement) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                        updateMacroBars();
                    }
                });
            });
            
            observer.observe(inputElement, { 
                attributes: true, 
                attributeFilter: ['value'] 
            });
        }
        
        // Configurar observadores para cada input
        createObserver(proteinInput);
        createObserver(carbInput);
        createObserver(fatInput);
        
        // También verificar cambios periódicamente (como respaldo)
        setInterval(updateMacroBars, 1000);
        
        // Inicializar la visualización
        updateMacroBars();
        
        // Hacer la función accesible globalmente para otras funciones
        window.updateMacroBars = updateMacroBars;
    });

	 // Inicializa los popovers
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
    const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));



		/* =====================================
		   Referencias rápidas
		===================================== */
		const weightChangeEl = document.getElementById('weight-change-goal');
		const weeklyDiffEl   = document.getElementById('weekly-calorie-diff');
		const getEl          = document.getElementById('get-calories');   // fijo
		const goalCalEl      = document.getElementById('goal-calories');
		const pcEl           = document.getElementById('goal-caloriespc');

		/* =====================================
		   Funciones auxiliares
		===================================== */
		// Devuelve el GET como número
		function getGET() {
		  return parseFloat(getEl.value) || 0;
		}

		// % → diferencia semanal (con signo)
		function pcToWeeklyDiff(pc) {
		  const weekly = (Number(pc) / 100) * (getGET() * 7);
		  return Math.round(weekly * (Number(weightChangeEl.value) < 0 ? -1 : 1));
		}

		// diferencia semanal → %
		function weeklyDiffToPc(diff) {
		  return Math.round(Math.abs(Number(diff)) / (getGET() * 7) * 100);
		}

		// actualiza Kcal/día según objetivo
		function updateGoalCal() {
		  const weekly = Number(weeklyDiffEl.value) || 0;
		  const daily  = Math.round(getGET() + weekly / 7);
		  goalCalEl.value = daily;
		}

		/* =====================================
		   Listeners
		===================================== */
		pcEl.addEventListener('input', () => {
		  const pc = Number(pcEl.value) || 0;
		  const diff = pcToWeeklyDiff(pc);
		  weeklyDiffEl.value = diff;   // número
		  updateGoalCal();
		});

		weeklyDiffEl.addEventListener('input', () => {
		  const diff = Number(weeklyDiffEl.value) || 0;
		  const pc = weeklyDiffToPc(diff);
		  pcEl.value = pc;             // número
		  updateGoalCal();
		});

		weightChangeEl.addEventListener('input', () => {
		  const pc = Number(pcEl.value) || 0;
		  weeklyDiffEl.value = pcToWeeklyDiff(pc);
		  updateGoalCal();
		});

		/* =====================================
		   Inicialización
		===================================== */
updateGoalCal();
// FUNCIONALIDAD PDF
document.getElementById("save-pdf-button").addEventListener("click", async function () {
    // Convertir gráficos a imágenes
    const charts = document.querySelectorAll('canvas');
    const promises = Array.from(charts).map(chart => {
        return new Promise(resolve => {
            const image = new Image();
            image.src = chart.toDataURL();
            image.onload = () => {
                const img = document.createElement('img');
                img.src = image.src;
                img.style.maxWidth = '90%';
                chart.parentNode.replaceChild(img, chart);
                resolve();
            };
        });
    });

    await Promise.all(promises);

    const opt = {
        margin: [5, 5, 5, 5],
        filename: 'Plan_Nutricional.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { 
            scale: 2,
            scrollY: 0,
            useCORS: true,
            allowTaint: true,
            logging: true
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait' 
        },
        pagebreak: { mode: 'avoid-all' }
    };

    const element = document.documentElement;
    html2pdf().set(opt).from(element).save().then(() => {
        // Restaurar los canvas después de la exportación
        charts.forEach((chart, index) => {
            const img = chart.parentNode.querySelector('img');
            if(img) img.replaceWith(chart);
        });
    });
});

 // --- PDF Generation ---
            function guardarComoPDF2() {
                if (!calculatedTDEE) {
                    alert("Por favor, completa al menos el Paso 1 (Cálculo de Necesidades) antes de generar el PDF.");
                    return;
                }

                const mainElement = document.querySelector('main');
                const headerElement = document.querySelector('header');
                const footerElement = document.querySelector('footer');
                const allButtons = document.querySelectorAll('button'); // Select all buttons

                // Hide elements not needed in PDF
                if (headerElement) headerElement.style.display = 'none';
                if (footerElement) footerElement.style.display = 'none';
                allButtons.forEach(btn => btn.style.display = 'none');

                // Temporarily make chart containers visible if they have content
                const chartContainers = document.querySelectorAll('#chart-container, #weight-chart-container, #time-estimation-chart-container');
                const originalDisplayStyles = [];
                chartContainers.forEach(container => {
                    originalDisplayStyles.push(container.style.display);
                    if (container.querySelector('canvas') && container.style.display === 'none') {
                        container.style.display = 'block';
                    }
                });

                const opt = {
                    margin: [15, 10, 15, 10],
                    filename: 'NutriPlan_Plan_Dietetico_Personalizado.pdf',
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { scale: 2, useCORS: true, logging: false, windowWidth: mainElement.scrollWidth, windowHeight: mainElement.scrollHeight },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.plan-step' }
                };

                console.log("Generating PDF...");
                html2pdf().from(mainElement).set(opt).save().then(() => {
                    console.log("PDF generated successfully.");
                    // Restore visibility
                    if (headerElement) headerElement.style.display = 'flex';
                    if (footerElement) footerElement.style.display = 'block';
                    allButtons.forEach(btn => btn.style.display = 'block');
                    chartContainers.forEach((container, index) => { container.style.display = originalDisplayStyles[index]; });
                }).catch(err => {
                    console.error("Error generating PDF:", err);
                    alert("Hubo un error al generar el PDF. Revisa la consola del navegador (F12) para más detalles.");
                    // Restore visibility even on error
                    if (headerElement) headerElement.style.display = 'flex';
                    if (footerElement) footerElement.style.display = 'block';
                    allButtons.forEach(btn => btn.style.display = 'block');
                    chartContainers.forEach((container, index) => { container.style.display = originalDisplayStyles[index]; });
                });
            }

	
   
//--------------- Funciones para las Tablas de la Seccion Ciclos Dieteticos---------------------------------//

		// --- Definición de estructura de fases por objetivo ---
// Esta estructura define las fases típicas, su duración relativa y macros base.
// Se puede ampliar para ganancia, mantenimiento, mixto.
const estructuraFasesPorObjetivo = {
    // --- Pérdida de Peso ---
    perdida: [
        {
            nombre: "Inducción Cetogénica",
            // Duración relativa: un número que representa la proporción de tiempo.
            // Por ejemplo, si Induccion=2, Ciclado=3, Transicion=1, la proporcion es 2:3:1
            duracionRelativa: 2, 
            // Macros base para la fase (%)
            macros: { proteinas: [20, 25], carbohidratos: [5, 10], grasas: [65, 75] },
            objetivoPrincipal: "Reset metabólico, inicio de pérdida de grasa, reducción de insulina.",
            observaciones: "Monitorizar lípidos, electrolitos, presión arterial. Priorizar grasas insaturadas."
        },
        {
            nombre: "Ciclado Metabólico",
            duracionRelativa: 3,
            macros: { proteinas: [25, 30], carbohidratos: [10, 25], grasas: [40, 65] },
            objetivoPrincipal: "Continuar pérdida de peso, mantener rendimiento físico y evitar estancamiento.",
            observaciones: "Carbohidratos estratégicos antes/después del ejercicio."
        },
        {
            nombre: "Transición a Mantenimiento",
            duracionRelativa: 1, // Proporcional al resto
            macros: { proteinas: [20, 25], carbohidratos: [26, 40], grasas: [30, 45] },
            objetivoPrincipal: "Mantener peso, favorecer adherencia social y equilibrio nutricional.",
            observaciones: "Seguir entrenando, ajustar según objetivos. Revaluar analíticas y composición corporal."
        }
    ],
    // --- Ganancia de Peso (Volumen Muscular) ---
    ganancia: [
         {
            nombre: "Volumen Muscular Inicial",
            duracionRelativa: 2,
            macros: { proteinas: [25, 30], carbohidratos: [40, 50], grasas: [20, 30] },
            objetivoPrincipal: "Establecer base calórica alta, favorecer síntesis proteica.",
            observaciones: "Priorizar calidad de alimentos. Monitorizar digestión."
        },
        {
            nombre: "Volumen Muscular Avanzado",
            duracionRelativa: 3,
            macros: { proteinas: [25, 35], carbohidratos: [45, 55], grasas: [15, 25] },
            objetivoPrincipal: "Maximizar aporte energético para entrenos intensos, ganar masa muscular.",
            observaciones: "Ajustar calorías según progreso. Timing post-entreno."
        },
        {
            nombre: "Definición/Recomposición Corporal",
            duracionRelativa: 1,
            macros: { proteinas: [30, 35], carbohidratos: [20, 30], grasas: [35, 45] },
            objetivoPrincipal: "Reducir ganancia de grasa mientras se mantiene/masa muscular ganada.",
            observaciones: "Control más estricto de HC. Posible inclusión de ciclos de déficit ligero."
        }
    ],
    // --- Mantenimiento ---
    mantenimiento: [
        {
            nombre: "Estabilización",
            duracionRelativa: 1, // En mantenimiento, el tiempo es más lineal o cíclico
            macros: { proteinas: [20, 25], carbohidratos: [35, 45], grasas: [30, 35] },
            objetivoPrincipal: "Consolidar hábitos, equilibrar energía.",
            observaciones: "Flexible Dieting (80/20). Monitoreo de peso y sensación de saciedad."
        }
        // Se podría añadir un ciclo anual aquí si se desea
    ],
     // --- Mixto/Combinado ---
    mixto: [
        // El mixto puede ser una combinación de bloques de las otras fases
        // Por ejemplo: 3 meses de Volumen, 2 meses de Definición, 1 mes de Mantenimiento
        // Lo definiremos más específicamente cuando se genere la tabla, basándonos en estimatedWeeksManualGlobal
        // y posiblemente en weightChangeGoalManualGlobal para determinar la proporción.
         {
            nombre: "Fase Variable (Mixta)",
            duracionRelativa: 1, // Placeholder
            macros: { proteinas: [20, 35], carbohidratos: [10, 55], grasas: [15, 45] }, // Rango muy amplio
            objetivoPrincipal: "Alternar entre objetivos de volumen, definición y mantenimiento.",
            observaciones: "Planificación cíclica. Ajustar macros y calorías según fase del ciclo."
        }
    ]
    // Se pueden añadir más objetivos si es necesario
};

/**
 * Calcula la distribución de semanas para cada fase basándose en el tiempo total y la estructura.
 * @param {number} totalWeeks - Las semanas totales estimadas (estimatedWeeksManualGlobal).
 * @param {string} objetivo - El objetivo del usuario ('perdida', 'ganancia', 'mantenimiento', 'mixto').
 * @returns {ArrayObject>} Un array de objetos, cada uno representando una fase con su nombre, semanas asignadas, etc.
 */
function calcularDistribucionSemanas(totalWeeks, objetivo) {
    const estructura = estructuraFasesPorObjetivo[objetivo];
    if (!estructura || totalWeeks <= 0) {
        console.error("Datos insuficientes para calcular distribución de semanas.");
        return [];
    }

    // Calcular la suma total de las duraciones relativas
    const sumaDuracionesRelativas = estructura.reduce((suma, fase) => suma + fase.duracionRelativa, 0);
    
    // Si la suma es 0, evitar división por cero
    if (sumaDuracionesRelativas === 0) {
         console.warn("Suma de duraciones relativas es 0. Asignando tiempo igualitariamente.");
         return estructura.map(fase => ({
             ...fase,
             semanasAsignadas: Math.ceil(totalWeeks / estructura.length)
         }));
    }

    // Calcular semanas para cada fase
    let semanasAsignadasAcumuladas = 0;
    const fasesConSemanas = estructura.map((fase, index) => {
        // Calcular semanas proporcionales
        let semanasParaEstaFase = Math.round((fase.duracionRelativa / sumaDuracionesRelativas) * totalWeeks);
        
        // Ajuste para el último elemento: asegurar que la suma sea exactamente totalWeeks
        // Esto corrige errores de redondeo.
        if (index === estructura.length - 1) {
            semanasParaEstaFase = totalWeeks - semanasAsignadasAcumuladas;
        }
        semanasAsignadasAcumuladas += semanasParaEstaFase;

        return {
            ...fase,
            semanasAsignadas: semanasParaEstaFase
        };
    });

    return fasesConSemanas;
}
/**
 * Calcula el cambio de peso estimado para una fase dada su duración y la diferencia calórica semanal.
 * @param {number} semanasEnFase - Número de semanas que dura la fase.
 * @param {number} weeklyCalorieDiff - Diferencia calórica semanal estimada (puede ser negativa para pérdida).
 * @returns {number} El cambio de peso estimado en kg para esa fase.
 */
function calcularCambioPesoPorFase(semanasEnFase, weeklyCalorieDiff) {
    const KCAL_POR_KG_GRASA = 7700;
    // Cambio de peso por semana = (Diferencia semanal en kcal) / (kcal por kg)
    const cambioPorSemanaKg = weeklyCalorieDiff / KCAL_POR_KG_GRASA;
    // Cambio total de peso en la fase = cambio por semana * número de semanas
    return cambioPorSemanaKg * semanasEnFase;
}

/**
 * Genera un array con el peso estimado al inicio y al final de cada fase.
 * @param {ArrayObject>} fasesConSemanas - Array de fases con semanas asignadas.
 * @param {number} pesoInicial - Peso inicial del usuario (currentWeightKg).
 * @param {number} weeklyCalorieDiff - Diferencia calórica semanal (weeklyCalorieDiffManualGlobal).
 * @returns {ArrayObject>} Array de fases con propiedades adicionales: pesoInicioFase, pesoFinFase.
 */
function calcularPesosPorFase(fasesConSemanas, pesoInicial, weeklyCalorieDiff) {
    let pesoActual = pesoInicial;
    return fasesConSemanas.map(fase => {
        const cambioPesoEnFase = calcularCambioPesoPorFase(fase.semanasAsignadas, weeklyCalorieDiff);
        const pesoInicioFase = pesoActual;
        const pesoFinFase = pesoActual + cambioPesoEnFase;
        pesoActual = pesoFinFase; // Actualizar para la siguiente fase

        return {
            ...fase,
            pesoInicioFase: pesoInicioFase,
            pesoFinFase: pesoFinFase
        };
    });
}
function calcularPesosPorFaseGanacia(fases, pesoInicial, cambioTotal) {
    const distribucion = [0.4, 0.3, 0.2, 0.1]; // Mayor ganancia al inicio
    let pesoActual = pesoInicial;
    return fases.map((fase, index) => {
        const cambio = cambioTotal * distribucion[index];
        const pesoFin = pesoActual + cambio;
        const faseData = { ...fase, pesoInicioFase: pesoActual, pesoFinFase: pesoFin };
        pesoActual = pesoFin;
        return faseData;
    });
}
///////////////////////funciones aux modal tabla general fases/////
//////////////////////  FUNCIONES DE UTILIDAD ////////////////////
function mostrarCarga(contenedorId, mensaje = 'Generando detalles...') {
    const contenedor = document.getElementById(contenedorId);
    if (contenedor) {
        contenedor.innerHTML = `
            <div class="loading-spinner">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h4 class="text-primary">${mensaje}</h4>
                <p class="text-muted mt-2">Esto puede tardar unos segundos...</p>
            </div>
        `;
    }
}
function mostrarError(mensaje, contenedorId = 'detailed-phase-container') {
    const contenedor = document.getElementById(contenedorId);
    if (contenedor) {
        contenedor.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${mensaje}
            </div>
        `;
    }
}

        // Catálogo de estrategias avanzadas
        // Catálogo de estrategias avanzadas
const catalogoEstrategias = {
    cetogenicas: [
        {
            id: "tkd",
            title: "Targeted Ketogenic Diet (TKD)",
            description: "Carbohidratos estratégicos solo alrededor del entreno",
            features: [
                "25-50g HC 30-60 min antes/después del entreno",
                "Mantener cetosis el resto del día (cetona >0.5 mmol/L)",
                "PROPÓSITO: Solo válido para RENDIMIENTO (fuerza intermitente)",
                "INCOMPATIBILIDAD: No recomendado para salud general ni estética",
                "VALIDACIÓN CIENTÍFICA: [JISSN, 2022] - Óptimo para CrossFit, no para deportes >90% VO2max"
            ],
            aplicable: ["perdida"],
            macros: {
                proteinPct: "20-25% (salud/estética) | 25-30% (rendimiento)",
                fatPct: "65-75% (todas)",
                carbPct: "5-10% + 25-50g HC peri-entreno",
                proteinGr: "1.8-2.2 g/kg/día (salud) | 2.2-2.6 g/kg/día (rendimiento)",
                carbinGr: "0.3-0.7 g/kg/día + 0.4-0.7g/kg peri-entreno",
                fatinGr: "1.5-2.0 g/kg/día"
            }
        },
        {
            id: "ckd",
            title: "Cyclic Ketogenic Diet (CKD)",
            description: "Ciclo de días cetosis y días de recarga",
            features: [
                "5-6 días cetosis + 1-2 días carb-loading (3-4g/kg HC)",
                "Refeed completo de glucógeno muscular",
                "PROPÓSITO: Solo válido para RENDIMIENTO (fuerza pura)",
                "INCOMPATIBILIDAD: No recomendado para salud ni estética",
                "VALIDACIÓN CIENTÍFICA: [Sports Med, 2021] - Superior en powerlifting vs. dieta estándar"
            ],
            aplicable: ["perdida", "mixto"],
            macros: {
                proteinPct: "20-25% (cetosis) | 15-20% (carb-loading)",
                fatPct: "70-75% (cetosis) | 20-25% (carb-loading)",
                carbPct: "5-10% (cetosis) | 60-65% (carb-loading)",
                proteinGr: "2.0-2.4 g/kg/día (constante)",
                carbinGr: "0.3-0.6 g/kg/día (cetosis) | 3.0-4.0 g/kg/día (carb-loading)",
                fatinGr: "1.8-2.2 g/kg/día (cetosis) | 0.5-0.8 g/kg/día (carb-loading)"
            }
        },
        {
            id: "restricted",
            title: "Restricted Ketogenic Diet",
            description: "Cetosis estricta con restricción calórica intensa",
            features: [
                "80-85% grasas, déficit severo (25-30% TMB)",
                "Cetosis estricta (cetona >1.5 mmol/L)",
                "PROPÓSITO: Solo válido para SALUD (casos médicos bajo supervisión)",
                "INCOMPATIBILIDAD: No recomendado para estética ni rendimiento",
                "VALIDACIÓN CIENTÍFICA: [Nutrients, 2021] - Solo para NAFLD grave o epilepsia"
            ],
            aplicable: ["perdida"],
            macros: {
                proteinPct: "15-20% (máx 1.2g/kg/día)",
                fatPct: "80-85%",
                carbPct: "3-5% (≤20g/día)",
                proteinGr: "0.8-1.2 g/kg/día",
                carbinGr: "0.1-0.3 g/kg/día",
                fatinGr: "2.5-3.0 g/kg/día"
            }
        },
        {
            id: "modified",
            title: "Modified Ketogenic Diet",
            description: "Cetosis moderada con flexibilidad selectiva",
            features: [
                "60-70% grasas, más proteína (1.8-2.2g/kg/día)",
                "Cetosis moderada (cetona 0.5-1.5 mmol/L)",
                "PROPÓSITO: Válido para SALUD y ESTÉTICA",
                "INCOMPATIBILIDAD: No recomendado para rendimiento de alta intensidad",
                "VALIDACIÓN CIENTÍFICA: [Front Nutr, 2020] - 60-70% grasas óptimo para sostenibilidad"
            ],
            aplicable: ["perdida", "mantenimiento"],
            macros: {
                proteinPct: "20-25% (fase inicial) | 25-30% (fase avanzada)",
                fatPct: "60-70%",
                carbPct: "5-10% (50-80g/día)",
                proteinGr: "1.8-2.2 g/kg/día (salud) | 2.2-2.6 g/kg/día (estética)",
                carbinGr: "0.7-1.1 g/kg/día",
                fatinGr: "1.3-1.8 g/kg/día"
            }
        }
    ],
    ciclado: [
        {
            id: "carb-cycling",
            title: "Carb Cycling",
            description: "Variación de carbohidratos según entrenamiento",
            features: [
                "Días altos/bajos HC según entrenamiento",
                "Entreno: alto HC, descanso: bajo HC",
                "PROPÓSITO: Válido para todos los propósitos",
                "HIGH CARB: 65-75% HC en días de alta carga (>90' entrenamiento)",
                "ESTÁNDAR: 50-60% HC en mantenimiento salud",
                "VALIDACIÓN CIENTÍFICA: [Obesity Rev, 2022] - Óptimo para prevenir adaptación metabólica"
            ],
            aplicable: ["perdida", "ganancia", "mixto"],
            macros: {
                proteinPct: "20-25% (salud) | 25-30% (estética/rendimiento)",
                fatPct: "40-55% (días descanso) | 25-35% (días entrenamiento)",
                carbPct: "Salud: 3-4g/kg (entreno) | Estética: 5-7g/kg (entreno) | Rendimiento: 4-8g/kg (entreno)",
                proteinGr: "1.6-2.0 g/kg/día (salud) | 2.0-2.4 g/kg/día (estética/rendimiento)",
                carbinGr: "Salud: 3-4g/kg (entreno) | Estética: 5-7g/kg (entreno) | Rendimiento: 4-8g/kg (entreno)",
                fatinGr: "Salud: 0.8-1.2g/kg (entreno) | Estética: 0.6-0.9g/kg (entreno)"
            }
        },
        {
            id: "high-carb-resistance",
            title: "High Carb Resistencia",
            description: "Enfoque específico para deportes de resistencia prolongada",
            features: [
                "65-75% HC en días de alta carga (>90' entrenamiento)",
                "5-6g/kg HC para optimizar glucógeno muscular",
                "PROPÓSITO: Solo válido para RENDIMIENTO (deportes de resistencia)",
                "INCOMPATIBILIDAD: Contraindicado en salud general y estética",
                "VALIDACIÓN CIENTÍFICA: [ISSN Pos Stand, 2018] - 6-10g/kg HC óptimo para maratón/ciclismo"
            ],
            aplicable: ["ganancia", "mixto"],
            macros: {
                proteinPct: "15-20%",
                fatPct: "15-20%",
                carbPct: "Días alta carga: 65-75% | Días descanso: 30-40%",
                proteinGr: "1.6-2.0 g/kg/día",
                carbinGr: "Días alta carga: 5.0-6.0 g/kg/día | Días descanso: 2.0-2.5 g/kg/día",
                fatinGr: "Días alta carga: 0.4-0.5 g/kg/día | Días descanso: 0.6-0.8 g/kg/día"
            }
        },
        {
            id: "protein-cycling",
            title: "Protein Cycling",
            description: "Variación de proteína en ciclos",
            features: [
                "4 semanas alta proteína + 1 semana moderada",
                "Prevención de adaptación metabólica renal",
                "PROPÓSITO: Solo válido para ESTÉTICA y RENDIMIENTO (>12 semanas)",
                "INCOMPATIBILIDAD: No recomendado en fases iniciales (<12 semanas)",
                "VALIDACIÓN CIENTÍFICA: [Obesity Rev, 2023] - 4 semanas alta + 1 semana moderada óptimo"
            ],
            aplicable: ["perdida", "ganancia", "mixto"],
            macros: {
                proteinPct: "25-30% (semanas alta) | 18-22% (semana moderada)",
                fatPct: "25-30% (semanas alta) | 35-40% (semana moderada)",
                carbPct: "40-45% (semanas alta) | 45-50% (semana moderada)",
                proteinGr: "2.2-2.6 g/kg/día (semanas alta) | 1.6-1.8 g/kg/día (semana moderada)",
                carbinGr: "1.8-2.2 g/kg/día (semanas alta) | 2.2-2.5 g/kg/día (semana moderada)",
                fatinGr: "0.7-0.9 g/kg/día (semanas alta) | 0.9-1.1 g/kg/día (semana moderada)"
            }
        },
        {
            id: "calorie-cycling",
            title: "Calorie Cycling",
            description: "Ciclo de déficit y superávit calórico",
            features: [
                "3 días déficit + 2 días superávit (mantenimiento o +100-200kcal)",
                "Mantiene TMB y adherencia",
                "PROPÓSITO: Válido para todos los propósitos",
                "ESTÁNDAR: 50-60% HC en mantenimiento salud",
                "VALIDACIÓN CIENTÍFICA: [AJCN, 2020] - MATADOR Study: 3d déficit + 2d superávit superior a déficit continuo"
            ],
            aplicable: ["perdida", "mixto", "mantenimiento"],
            macros: {
                proteinPct: "25-30% (constante)",
                fatPct: "30-40% (déficit) | 25-35% (superávit)",
                carbPct: "30-40% (déficit) | 45-55% (superávit)",
                proteinGr: "1.8-2.4 g/kg/día (constante)",
                carbinGr: "1.2-1.8 g/kg/día (déficit) | 2.2-2.8 g/kg/día (superávit)",
                fatinGr: "0.7-1.0 g/kg/día (déficit) | 0.6-0.8 g/kg/día (superávit)"
            }
        },
        {
            id: "metabolic-flexibility",
            title: "Metabolic Flexibility Training",
            description: "Rotación de macronutrientes para mejorar flexibilidad metabólica",
            features: [
                "Semanal: cetosis → moderate carb → high carb",
                "Mejora flexibilidad metabólica y previene plateaus",
                "PROPÓSITO: Solo válido para fases avanzadas (>24 semanas)",
                "HIGH CARB: 65-75% HC en fase 'high carb' para deportes de resistencia",
                "ESTÁNDAR: 50-60% HC en fase 'moderate' para salud",
                "VALIDACIÓN CIENTÍFICA: [Obesity Rev, 2023] - Rotación semanal esencial tras 24 semanas"
            ],
            aplicable: ["perdida", "mantenimiento", "mixto"],
            macros: {
                proteinPct: "25-30% (constante)",
                fatPct: "65-70% (cetosis) | 35-40% (moderate) | 25-30% (high carb)",
                carbPct: "5-10% (cetosis) | 30-40% (moderate) | 50-60% (high carb)",
                proteinGr: "1.8-2.2 g/kg/día (constante)",
                carbinGr: "0.3-0.6 g/kg/día (cetosis) | 1.5-2.0 g/kg/día (moderate) | 3.5-4.5 g/kg/día (high carb)",
                fatinGr: "1.8-2.2 g/kg/día (cetosis) | 0.9-1.2 g/kg/día (moderate) | 0.6-0.8 g/kg/día (high carb)"
            }
        }
    ],
    timing: [
        {
            id: "refeed",
            title: "Refeed Strategy",
            description: "Días estratégicos de alta ingesta calórica",
            features: [
                "Mensuales o según avance (1-2 días)",
                "Optimiza leptina y T3 post-déficit",
                "PROPÓSITO: Solo válido para ESTÉTICA y MIXTO (post-corte)",
                "INCOMPATIBILIDAD: No recomendado durante ganancia activa",
                "VALIDACIÓN CIENTÍFICA: [Obesity Rev, 2022] - 4-5g/kg HC óptimo para normalizar hormonas"
            ],
            aplicable: ["perdida", "mixto"],
            macros: {
                proteinPct: "15-20% (día refeed)",
                fatPct: "15-20% (día refeed)",
                carbPct: "60-70% (4-5g/kg HC)",
                proteinGr: "1.6-1.8 g/kg/día (día refeed)",
                carbinGr: "4.0-5.0 g/kg/día (día refeed)",
                fatinGr: "0.4-0.6 g/kg/día (día refeed)"
            }
        },
        {
            id: "flexible-dieting",
            title: "Flexible Dieting (80/20 rule)",
            description: "80% alimentos nutrientes + 20% flexibilidad",
            features: [
                "Aumenta adherencia en 65%",
                "Mantiene composición corporal",
                "PROPÓSITO: Válido para ESTÉTICA y MANTENIMIENTO",
                "ESTÁNDAR: 50-60% HC para mantenimiento salud",
                "INCOMPATIBILIDAD: No recomendado en fases iniciales de pérdida/ganancia",
                "VALIDACIÓN CIENTÍFICA: [Int J Obesity, 2019] - 80/20 rule superior a dietas rígidas"
            ],
            aplicable: ["perdida", "mantenimiento", "mixto"],
            macros: {
                proteinPct: "25-30% (salud) | 25-35% (estética)",
                fatPct: "25-35% (salud) | 20-25% (estética)",
                carbPct: "35-45% (salud) | 40-50% (estética)",
                proteinGr: "1.6-2.0 g/kg/día (salud) | 2.0-2.4 g/kg/día (estética)",
                carbinGr: "1.5-2.0 g/kg/día (salud) | 2.2-2.8 g/kg/día (estética)",
                fatinGr: "0.7-1.0 g/kg/día (salud) | 0.5-0.7 g/kg/día (estética)"
            }
        },
        {
            id: "dieta-estandar",
            title: "Dieta Estándar/Equilibrada",
            description: "Enfoque alineado con recomendaciones OMS para salud general",
            features: [
                "15-20% proteína | 25-35% grasas | 50-60% HC",
                "Requiere >30g fibra/día y HC complejos",
                "PROPÓSITO: Solo válido para SALUD (mantenimiento)",
                "INCOMPATIBILIDAD: No recomendado para estética ni rendimiento",
                "VALIDACIÓN CIENTÍFICA: [Dietary Guidelines, 2020-2025] - Reduce riesgo CV en 25%"
            ],
            aplicable: ["mantenimiento"],
            macros: {
                proteinPct: "15-20%",
                fatPct: "25-35%",
                carbPct: "50-60%",
                proteinGr: "1.2-1.6 g/kg/día",
                carbinGr: "2.5-3.0 g/kg/día",
                fatinGr: "0.7-1.0 g/kg/día"
            }
        },
        {
            id: "intermittent-fasting",
            title: "Intermittent Fasting + Cycling",
            description: "Ayuno intermitente combinado con ciclado metabólico",
            features: [
                "5 días IF 16:8 + 2 días alimentación normal",
                "Potencia cetosis y autofagia",
                "PROPÓSITO: Solo válido para SALUD (fases medias >12 semanas)",
                "INCOMPATIBILIDAD: No recomendado en fases iniciales ni para rendimiento",
                "VALIDACIÓN CIENTÍFICA: [Obesity Rev, 2022] - Solo efectivo tras 12 semanas de estabilidad"
            ],
            aplicable: ["perdida", "mantenimiento"],
            macros: {
                proteinPct: "25-30% (ventana alimentación)",
                fatPct: "40-50% (ventana alimentación)",
                carbPct: "20-30% (ventana alimentación)",
                proteinGr: "2.0-2.5 g/kg/día (ventana alimentación)",
                carbinGr: "0.9-1.3 g/kg/día (ventana alimentación)",
                fatinGr: "1.1-1.5 g/kg/día (ventana alimentación)"
            }
        },
        {
            id: "meal-timing",
            title: "Meal Timing Optimization",
            description: "Optimización del timing de comidas",
            features: [
                "Ventana de alimentación ajustada",
                "Pre/post-entreno específico",
                "PROPÓSITO: Válido para todos los propósitos",
                "ESTÁNDAR: 50-60% HC en distribución equilibrada",
                "VALIDACIÓN CIENTÍFICA: [ISSN Pos Stand, 2018] - 0.8g/kg HC + 0.4g/kg proteína post-entreno óptimo"
            ],
            aplicable: ["perdida", "ganancia", "mixto"],
            macros: {
                proteinPct: "25-30% (constante)",
                fatPct: "25-35% (constante)",
                carbPct: "35-45% (constante)",
                proteinGr: "1.8-2.4 g/kg/día (distribuido en 4-5 comidas)",
                carbinGr: "Salud: 1.5-2.0 g/kg/día | Rendimiento: 3.0-5.0 g/kg/día (días entrenamiento)",
                fatinGr: "0.6-0.9 g/kg/día"
            }
        },
        {
            id: "neat-optimization",
            title: "NEAT Optimization",
            description: "Aumentar actividad no planeada para compensar adaptación metabólica",
            features: [
                "+5,000 pasos/día",
                "Actividades espontáneas (subir escaleras, caminar)",
                "PROPÓSITO: Solo válido para SALUD y PÉRDIDA",
                "INCOMPATIBILIDAD: No recomendado en fases de ganancia activa",
                "VALIDACIÓN CIENTÍFICA: [Br J Sports Med, 2022] - Compensa 15-20% gasto energético post-pérdida"
            ],
            aplicable: ["perdida", "mantenimiento", "mixto"],
            macros: {
                proteinPct: "25-30% (salud) | 30-35% (estética)",
                fatPct: "30-35% (salud) | 25-30% (estética)",
                carbPct: "35-40% (salud) | 40-45% (estética)",
                proteinGr: "1.6-2.0 g/kg/día (salud) | 2.0-2.4 g/kg/día (estética)",
                carbinGr: "1.5-1.8 g/kg/día (salud) | 2.0-2.4 g/kg/día (estética)",
                fatinGr: "0.8-1.0 g/kg/día (salud) | 0.6-0.8 g/kg/día (estética)"
            }
        },
        {
            id: "hydration-strategy",
            title: "Hydration Strategy",
            description: "Hidratación estratégica para evitar fluctuaciones",
            features: [
                "1.5-2L agua/día",
                "500-700mg sodio/día en entrenamientos",
                "PROPÓSITO: Solo válido para RENDIMIENTO",
                "INCOMPATIBILIDAD: No recomendado para salud general sin supervisión",
                "VALIDACIÓN CIENTÍFICA: [Br J Sports Med, 2023] - 500-700mg sodio previene retención hídrica"
            ],
            aplicable: ["perdida", "mantenimiento", "mixto"],
            macros: {
                proteinPct: "20-25% (rendimiento fuerza) | 15-20% (rendimiento resistencia)",
                fatPct: "20-25% (rendimiento fuerza) | 25-30% (rendimiento resistencia)",
                carbPct: "55-60% (rendimiento fuerza) | 60-65% (rendimiento resistencia)",
                proteinGr: "1.8-2.2 g/kg/día (fuerza) | 1.6-2.0 g/kg/día (resistencia)",
                carbinGr: "4.5-5.5 g/kg/día (fuerza) | 6.0-7.0 g/kg/día (resistencia)",
                fatinGr: "0.5-0.7 g/kg/día (fuerza) | 0.7-0.9 g/kg/día (resistencia)"
            }
        },
        {
            id: "targeted-carb-timing",
            title: "Targeted Carb Timing",
            description: "HC estratégicos para mantener rendimiento en déficit",
            features: [
                "25-50g HC 30 min pre-entreno",
                "0.8g/kg HC post-entreno",
                "PROPÓSITO: Solo válido para RENDIMIENTO",
                "INCOMPATIBILIDAD: No recomendado para salud general ni estética",
                "VALIDACIÓN CIENTÍFICA: [ISSN Pos Stand, 2018] - 0.8g/kg HC post-entreno mantiene rendimiento en déficit"
            ],
            aplicable: ["ganancia", "mixto"],
            macros: {
                proteinPct: "25-30% (constante)",
                fatPct: "20-25% (constante)",
                carbPct: "45-55% (días entrenamiento) | 30-40% (días descanso)",
                proteinGr: "2.0-2.4 g/kg/día (constante)",
                carbinGr: "3.0-4.0 g/kg/día (días entrenamiento) | 1.5-2.0 g/kg/día (días descanso)",
                fatinGr: "0.5-0.7 g/kg/día (días entrenamiento) | 0.7-0.9 g/kg/día (días descanso)"
            }
        },
		
		{
			id: "protein-pacing",
			title: "Protein Pacing",
			description: "Distribución óptima de proteína a lo largo del día",
			features: [
				"0.4-0.5g/kg proteína cada 3-4 horas",
				"Maximiza la síntesis proteica muscular",
				"PROPÓSITO: Válido para ESTÉTICA y RENDIMIENTO",
				"INCOMPATIBILIDAD: No recomendado en fases iniciales (<8 semanas) para salud",
				"VALIDACIÓN CIENTÍFICA: [JISSN, 2022] - Distribución óptima: 4-5 comidas con 0.4-0.5g/kg"
			],
			aplicable: ["perdida", "ganancia", "mixto", "mantenimiento"],
			macros: {
				proteinPct: "25-30% (constante)",
				fatPct: "25-35% (constante)",
				carbPct: "35-45% (constante)",
				proteinGr: "Distribución: 0.4-0.5g/kg cada 3-4h",
				carbinGr: "1.8-2.4 g/kg/día (distribuido en 4-5 comidas)",
				fatinGr: "0.7-0.9 g/kg/día (distribuido en 4-5 comidas)"
			}
		},
		
    ]
};
// Configuración de estrategias base por objetivo y fase (ESTRUCTURA EXACTA)
const estrategiasBaseConfig = {
    perdida: {
        "Fase 1 (0-12 sem)": [
            {
                id: "mkd-inicial",
                title: "Modified Ketogenic Diet",
                description: "Modified Ketogenic Diet para inicio seguro",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "60-70%",
                        carbPct: "5-10%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "0.7-1.1 g/kg/día",
                        fatinGr: "1.3-1.8 g/kg/día"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "50-65%",
                        carbPct: "5-8%",
                        proteinGr: "2.0-2.4 g/kg/día",
                        carbinGr: "0.5-0.8 g/kg/día",
                        fatinGr: "1.1-1.5 g/kg/día"
                    },
                    macrosRendimiento: {
                        proteinPct: "25-30%",
                        fatPct: "40-50%",
                        carbPct: "10-15%",
                        proteinGr: "2.0-2.4 g/kg/día",
                        carbinGr: "1.0-1.5 g/kg/día",
                        fatinGr: "0.9-1.2 g/kg/día"
                    }
                },
                details: "Esta fase establece una cetosis metabólica moderada (no estricta) para reducir la resistencia a la insulina y comenzar la quema de grasa corporal, priorizando la preservación muscular mediante una ingesta proteica adecuada. Es ideal para la primera fase de pérdida de grasa, especialmente en personas con mayor porcentaje de grasa corporal (>25% en hombres, >32% en mujeres). A diferencia de la Restricted Ketogenic Diet (RKD), esta estrategia evita el déficit calórico severo y mantiene una ingesta proteica suficiente para minimizar la pérdida muscular. Basado en evidencia de Frontiers in Nutrition (2020), es más sostenible y segura para la mayoría de las personas que inician un proceso de pérdida de peso con propósito de salud."
            },
            {
				id: "hiperproteica",
				title: "Fase de Ciclado Metabólico inicial",
				description: "Ciclado metabólico inicial con enfoque hiperproteico",
				aplicable: ["perdida"],
				macros: {
				macrosSalud: {
				proteinPct: "20-25%",
				fatPct: "50-65%",
				carbPct: "10-15%",
				proteinGr: "1.6-2.0 g/kg/día",
				carbinGr: "1.0-1.5 g/kg/día",
				fatinGr: "1.1-1.5 g/kg/día"
				},
				macrosEstetica: {
				diasDescanso: {
				proteinPct: "25-30%",
				fatPct: "50-65%",
				carbPct: "5-8%",
				proteinGr: "2.0-2.4 g/kg/día",
				carbinGr: "0.5-0.8 g/kg",
				fatinGr: "1.1-1.5 g/kg"
				},
				diasEntreno: {
				proteinPct: "25-30%",
				fatPct: "50-65%",
				carbPct: "15-20%",
				proteinGr: "2.0-2.4 g/kg/día",
				carbinGr: "1.3-1.8 g/kg",
				fatinGr: "0.9-1.2 g/kg"
				}
				},
				macrosRendimiento: {
				diasDescanso: {
				proteinPct: "25-30%",
				fatPct: "40-50%",
				carbPct: "10-15%",
				proteinGr: "2.0-2.4 g/kg/día",
				carbinGr: "1.0-1.5 g/kg",
				fatinGr: "0.9-1.2 g/kg"
				},
				diasEntreno: {
				proteinPct: "25-30%",
				fatPct: "40-50%",
				carbPct: "25-35%",
				proteinGr: "2.0-2.4 g/kg/día",
				carbinGr: "2.2-2.8 g/kg",
				fatinGr: "0.7-0.9 g/kg"
				}
				}
				},
				details: "Esta fase combina días de bajo y alto consumo de carbohidratos según el entrenamiento para mantener la masa muscular durante la pérdida de grasa, con un enfoque proteico elevado. Es ideal para atletas o personas con menor porcentaje de grasa corporal que necesitan preservar músculo mientras reducen grasa. Los días de entrenamiento incluyen un rango controlado de carbohidratos (15-20% de calorías) para optimizar el rendimiento y la recuperación, mientras que los días de descanso mantienen un nivel bajo (5-8%) para potenciar la oxidación de grasas. Basado en Journal of the International Society of Sports Nutrition (2021), este enfoque es superior a dietas cetogénicas estrictas para la preservación muscular en individuos con propósitos estéticos."
			},

				
			{
					id: "low-carb-general",
					title: "Dieta Low Carb General",
					description: "Enfoque bajo en HC para inicio seguro y adaptable segun variabilidad.",
					aplicable: ["perdida", "mantenimiento"],
					macros: {
						macrosSalud: {
						proteinPct: "20-25%",
						fatPct: "45-55%",
						carbPct: "20-30%",
						proteinGr: "1.6-1.8 g/kg/día",
						carbinGr: "1.5-2.0 g/kg/día",
						fatinGr: "1.0-1.2 g/kg/día"
						},
					macrosEstetica: {
						proteinPct: "25-30%",
						fatPct: "50-60%",
						carbPct: "10-20%",
						proteinGr: "1.8-2.2 g/kg/día",
						carbinGr: "1.0-1.5 g/kg/día",
						fatinGr: "1.0-1.3 g/kg/día"
						},
					macrosRendimiento: {
						proteinPct: "20-25%",
						fatPct: "40-50%",
						carbPct: "30-40%",
						proteinGr: "1.6-1.8 g/kg/día",
						carbinGr: "2.5-3.0 g/kg/día",
						fatinGr: "0.8-1.0 g/kg/día"
						}
				},
					details: "La dieta low carb (LCD) es una estrategia flexible con ingestas moderadas de carbohidratos (50-150 g/día) que se adapta a diversos objetivos. En pérdida de peso, induce un déficit calórico con mayor quema de grasa y control glucémico. En mantenimiento, promueve la estabilidad metabólica y previene la recuperación de peso. Para ganancia muscular, requiere ciclado de carbohidratos y superávit controlado para optimizar el glucógeno muscular. En recomposición corporal, combina alta proteína con entrenamiento de resistencia para perder grasa y ganar músculo simultáneamente. Basada en evidencia de Nutrition Reviews (2021), es sostenible a largo plazo y compatible con actividad física regular cuando se ajustan los macros según el propósito."
			}
        ],
        "Fase 2 (12-24 sem)": [
            {
                id: "cicladoMetabolico",
				title: "Fase de Ciclado Metabólico",
				description: "Ciclado metabólico avanzado",
				aplicable: ["perdida"],
				macros: {
			macrosSalud: {
					proteinPct: "20-25%",
					fatPct: "45-55%",
					carbPct: "20-25%",
					proteinGr: "1.6-2.0 g/kg/día",
					carbinGr: "1.5-1.8 g/kg/día",
					fatinGr: "1.0-1.3 g/kg/día"
			},
			macrosEstetica: {
				diasDescanso: {
					proteinPct: "25-30%",
					fatPct: "40-50%",
					carbPct: "10-20%",
					proteinGr: "2.0-2.4 g/kg/día",
					carbinGr: "1.0-1.8 g/kg",
					fatinGr: "0.9-1.2 g/kg"
			},
				diasEntreno: {
					proteinPct: "25-30%",
					fatPct: "40-50%",
					carbPct: "30-40%",
					proteinGr: "2.0-2.4 g/kg/día",
					carbinGr: "2.2-2.8 g/kg",
					fatinGr: "0.7-0.9 g/kg"
			}
			},
			macrosRendimiento: {
				diasDescanso: {
					proteinPct: "25-30%",
					fatPct: "35-45%",
					carbPct: "15-25%",
					proteinGr: "2.0-2.4 g/kg/día",
					carbinGr: "1.5-2.0 g/kg",
					fatinGr: "0.8-1.0 g/kg"
				},
				diasEntreno: {
					proteinPct: "25-30%",
					fatPct: "35-45%",
					carbPct: "40-50%",
					proteinGr: "2.0-2.4 g/kg/día",
					carbinGr: "3.0-4.0 g/kg",
					fatinGr: "0.6-0.8 g/kg"
				}
			}
			},
				details: "Esta fase implementa un ciclado avanzado de carbohidratos para optimizar el rendimiento y la recuperación mientras se mantiene la pérdida de grasa. Los días de entrenamiento incluyen un rango más elevado de carbohidratos (30-40% de calorías) para maximizar el rendimiento y la síntesis proteica, mientras que los días de descanso mantienen un nivel moderado-bajo (10-20%) para continuar con la oxidación de grasas. La proteína se mantiene alta (2.0-2.4 g/kg/día) para preservar la masa muscular, especialmente crítica en fases medias de pérdida de peso donde el riesgo de pérdida muscular aumenta. Basado en Obesity Reviews (2022), este enfoque previene la adaptación metabólica que ocurre tras 12 semanas de déficit continuo, manteniendo la tasa metabólica basal (TMB) y mejorando la adherencia al plan nutricional."
			},
			{
					id: "low-carb-general2",
					title: "Dieta Low Carb Ciclada",
					description: "Enfoque bajo en HC para inicio seguro y adaptable segun variabilidad.",
					aplicable: ["perdida", "mantenimiento"],
					macros: {
						macrosSalud: {
						proteinPct: "20-25%",
						fatPct: "45-55%",
						carbPct: "20-30%",
						proteinGr: "1.6-1.8 g/kg/día",
						carbinGr: "1.5-2.0 g/kg/día",
						fatinGr: "1.0-1.2 g/kg/día"
						},
					macrosEstetica: {
						proteinPct: "25-30%",
						fatPct: "50-60%",
						carbPct: "10-20%",
						proteinGr: "1.8-2.2 g/kg/día",
						carbinGr: "1.0-1.5 g/kg/día",
						fatinGr: "1.0-1.3 g/kg/día"
						},
					macrosRendimiento: {
						proteinPct: "20-25%",
						fatPct: "40-50%",
						carbPct: "30-40%",
						proteinGr: "1.6-1.8 g/kg/día",
						carbinGr: "2.5-3.0 g/kg/día",
						fatinGr: "0.8-1.0 g/kg/día"
						}
				},
					details: "La dieta low carb (LCD) es una estrategia flexible con ingestas moderadas de carbohidratos (50-150 g/día) que se adapta a diversos objetivos. En pérdida de peso, induce un déficit calórico con mayor quema de grasa y control glucémico. En mantenimiento, promueve la estabilidad metabólica y previene la recuperación de peso. Para ganancia muscular, requiere ciclado de carbohidratos y superávit controlado para optimizar el glucógeno muscular. En recomposición corporal, combina alta proteína con entrenamiento de resistencia para perder grasa y ganar músculo simultáneamente. Basada en evidencia de Nutrition Reviews (2021), es sostenible a largo plazo y compatible con actividad física regular cuando se ajustan los macros según el propósito."
			}
        ],
        "Fase 3 Avanzada (>24 sem)": [
            {
				id: "metabolic-flex",
				title: "Fase de Ajuste Metabólico",
				description: "Metabolic Flexibility Training para superar plateaus",
				aplicable: ["perdida"],
		macros: {
			macrosSalud: {
				proteinPct: "20-25%",
				fatPct: "35-45%",
				carbPct: "30-40%",
				proteinGr: "1.6-2.0 g/kg/día",
				carbinGr: "2.0-2.5 g/kg/día",
				fatinGr: "0.8-1.0 g/kg/día"
				},
			macrosEstetica: {
				semanaLow: {
					proteinPct: "25-30%",
					fatPct: "35-60%",
					carbPct: "5-10%",
					proteinGr: "2.0-2.4 g/kg/día",
					carbinGr: "0.5-1.0 g/kg/día",
					fatinGr: "1.3-1.7 g/kg/día"
				},
				semanaModerate: {
					proteinPct: "25-30%",
					fatPct: "35-45%",
					carbPct: "30-40%",
					proteinGr: "1.8-2.2 g/kg/día",
					carbinGr: "2.0-2.5 g/kg/día",
					fatinGr: "0.9-1.2 g/kg/día"
				},
				semanaHigh: {
					proteinPct: "25-30%",
					fatPct: "35-45%",
					carbPct: "50-60%",
					proteinGr: "1.8-2.2 g/kg/día",
					carbinGr: "3.5-4.5 g/kg/día",
					fatinGr: "0.6-0.8 g/kg/día"
				}
			},
			macrosRendimiento: {
				semanaLow: {
					proteinPct: "25-30%",
					fatPct: "45-60%",
					carbPct: "10-15%",
					proteinGr: "2.0-2.4 g/kg/día",
					carbinGr: "1.0-1.5 g/kg/día",
					fatinGr: "1.3-1.8 g/kg/día"
				},
				semanaModerate: {
					proteinPct: "25-30%",
					fatPct: "30-40%",
					carbPct: "35-45%",
					proteinGr: "2.0-2.2 g/kg/día",
					carbinGr: "2.5-3.0 g/kg/día",
					fatinGr: "0.8-1.0 g/kg/día"
				},
				semanaHigh: {
					proteinPct: "25-30%",
					fatPct: "30-40%",
					carbPct: "55-65%",
					proteinGr: "2.0-2.4 g/kg/día",
					carbinGr: "4.5-5.5 g/kg/día",
					fatinGr: "0.5-0.7 g/kg/día"
				}
			}
		},
			details: "Esta fase avanzada implementa una rotación semanal de macronutrientes para superar plateaus metabólicos tras 24 semanas de déficit continuo. La rotación semanal (cetosis → moderate carb → high carb) mejora la flexibilidad metabólica, permitiendo al cuerpo adaptarse a diferentes fuentes de energía y previniendo la adaptación que ralentiza la pérdida de peso. Los días de high carb (40-50% de calorías en HC) ayudan a normalizar hormonas como la leptina y la T3, que tienden a disminuir en déficit prolongado. Basado en Obesity Reviews (2023), esta estrategia es crítica para evitar el 'efecto yoyó' y mantener la adherencia a largo plazo, especialmente en individuos que han estado en déficit calórico durante más de 6 meses."
		},
            {
                id: "equilibrada",
                title: "Fase de Transición a Mantenimiento",
                description: "Dieta equilibrada para estabilización metabólica",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "35-45%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "1.8-2.2 g/kg/día",
                        fatinGr: "0.7-0.9 g/kg/día"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "40-45%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "2.2-2.6 g/kg/día",
                        fatinGr: "0.6-0.8 g/kg/día"
                    },
                    macrosRendimiento: {
                        proteinPct: "25-30%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "2.8-3.5 g/kg/día",
                        fatinGr: "0.5-0.7 g/kg/día"
                    }
                },
                details: "Esta fase prepara la transición hacia el mantenimiento sostenible mediante un equilibrio adecuado de macronutrientes. El aumento controlado de carbohidratos (40-45% de calorías) ayuda a estabilizar las hormonas metabólicas (leptina, grelina, T3) que se ven afectadas durante el déficit calórico prolongado. La proteína se reduce ligeramente (1.6-2.0 g/kg/día) pero se mantiene por encima de niveles estándar para preservar la masa muscular ganada. Basado en American Journal of Clinical Nutrition (2020), este enfoque gradual previene la recuperación rápida de peso (efecto rebote) y permite una adaptación metabólica más suave, siendo esencial para la sostenibilidad a largo plazo del peso perdido."
            }
        ],
		"Fase 4 Ajuste Metabólico (>32 sem)": [
            {
                id: "metabolic-adaptation-protocol",
                title: "Protocolo de Adaptación Metabolica",
                description: "Protocolo especializado para superar plateaus metabólicos avanzados",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "25-30%",
                        fatPct: "35-45%",
                        carbPct: "25-35%",
                        proteinGr: "2.0-2.4 g/kg/día",
                        carbinGr: "1.8-2.2 g/kg/día",
                        fatinGr: "0.9-1.1 g/kg/día"
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "30-35%",
                            fatPct: "45-55%",
                            carbPct: "10-15%",
                            proteinGr: "2.2-2.6 g/kg/día",
                            carbinGr: "0.8-1.2 g/kg/día",
                            fatinGr: "1.2-1.5 g/kg/día"
                        },
                        diasEntreno: {
                            proteinPct: "30-35%",
                            fatPct: "30-40%",
                            carbPct: "30-40%",
                            proteinGr: "2.2-2.6 g/kg/día",
                            carbinGr: "2.5-3.0 g/kg/día",
                            fatinGr: "0.8-1.0 g/kg/día"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "40-50%",
                            carbPct: "20-30%",
                            proteinGr: "2.0-2.4 g/kg/día",
                            carbinGr: "1.5-2.0 g/kg/día",
                            fatinGr: "1.0-1.3 g/kg/día"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "25-35%",
                            carbPct: "40-50%",
                            proteinGr: "2.0-2.4 g/kg/día",
                            carbinGr: "3.0-3.8 g/kg/día",
                            fatinGr: "0.7-0.9 g/kg/día"
                        }
                    }
                },
                details: "Protocolo especializado para individuos que han alcanzado un plateau metabólico después de 32 semanas de déficit calórico. Implementa una rotación estratégica de macros y calorías para reactivar la respuesta metabólica y hormonal. Incluye periodos de recarga metabólica (3-5 días con aumento calórico del 15-20%) seguidos de periodos de déficit controlado. Basado en Obesity Reviews (2023), este enfoque es crítico para superar la adaptación metabólica avanzada y continuar con la pérdida de grasa en individuos con alta resistencia a la pérdida de peso."
            },
            {
                id: "transicion-mantenimiento-avanzada",
                title: "Fase de Transición a Mantenimiento",
                description: "Transición avanzada hacia el mantenimiento con ajuste metabólico",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "35-45%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "2.0-2.5 g/kg/día",
                        fatinGr: "0.8-1.0 g/kg/día"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "35-45%",
                        proteinGr: "2.0-2.4 g/kg/día",
                        carbinGr: "2.2-2.8 g/kg/día",
                        fatinGr: "0.8-1.0 g/kg/día"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "3.0-3.8 g/kg/día",
                        fatinGr: "0.7-0.9 g/kg/día"
                    }
                },
                details: "Fase avanzada de transición que prepara el metabolismo para el mantenimiento a largo plazo después de un período prolongado de pérdida de peso. Implementa un aumento gradual de calorías (100-150 kcal/semana) hasta alcanzar el mantenimiento, con especial atención al balance de macronutrientes para optimizar la leptina y hormonas tiroideas. Incluye monitorización de adaptaciones metabólicas y ajustes basados en biofeedback. Basado en American Journal of Clinical Nutrition (2020), este enfoque reduce el riesgo de recuperación de peso en un 60% comparado con transiciones abruptas, especialmente en personas que han perdido más del 15% de su peso corporal."
            }
		]
    },
    ganancia: {
        "Fase 1 (0-8 sem)": [
            {
                id: "lean-bulk",
                title: "Fase Lean Bulk Controlado",
                description: "Superávit calórico moderado para ganancia muscular",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "2.2-2.8 g/kg/día",
                        fatinGr: "0.7-0.9 g/kg/día"
                    },
                    macrosEstetica: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "2.5-3.0 g/kg/día",
                        fatinGr: "0.6-0.8 g/kg/día"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "20-25%",
                        carbPct: "55-65%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "3.5-4.5 g/kg/día",
                        fatinGr: "0.5-0.7 g/kg/día"
                    }
                },
                details: "Esta fase establece un superávit calórico moderado (300-500 kcal por encima del mantenimiento) para construir masa muscular sin ganancia excesiva de grasa. La ingesta proteica (1.8-2.2 g/kg/día) está optimizada para maximizar la síntesis proteica sin sobrecargar el sistema renal, mientras que los carbohidratos (45-55% de calorías) proporcionan energía para los entrenamientos y ayudan a reponer el glucógeno muscular. Las grasas se mantienen en un rango saludable (25-30%) para apoyar la producción hormonal. Basado en Journal of the International Society of Sports Nutrition (2019), este enfoque de 'Lean Bulk' es superior al 'Dirty Bulk' tradicional, ya que limita la ganancia de grasa corporal a menos del 30% de la ganancia total de peso, comparado con hasta el 50% en enfoques no controlados."
            },
            {
                 id: "cicladoMetabolico2",
				  title: "Fase de Ciclado Metabólico Ganancia",
				  description: "Ciclado para optimizar ganancia muscular",
				  aplicable: ["ganancia"],
				  macros: {
					macrosSalud: {
					  diasDescanso: {
						proteinPct: "20-25%",
						fatPct: "30-35%",
						carbPct: "40-45%",
						proteinGr: "1.6-2.0 g/kg",
						carbinGr: "2.0-2.4 g/kg",
						fatinGr: "0.8-1.0 g/kg"
					},
					diasEntreno: {
						proteinPct: "20-25%",
						fatPct: "20-25%",
						carbPct: "50-55%",
						proteinGr: "1.6-2.0 g/kg",
						carbinGr: "2.6-3.0 g/kg",
						fatinGr: "0.6-0.8 g/kg"
					}
				},
					macrosEstetica: {
					  diasDescanso: {
						proteinPct: "25-30%",
						fatPct: "25-30%",
						carbPct: "40-45%",
						proteinGr: "2.0-2.4 g/kg/día",
						carbinGr: "2.2-2.6 g/kg",
						fatinGr: "0.7-0.9 g/kg"
					  },
					  diasEntreno: {
						proteinPct: "25-30%",
						fatPct: "25-30%",
						carbPct: "50-55%",
						proteinGr: "2.0-2.4 g/kg/día",
						carbinGr: "2.8-3.2 g/kg",
						fatinGr: "0.6-0.8 g/kg"
					  }
					},
					macrosRendimiento: {
					  diasDescanso: {
						proteinPct: "20-25%",
						fatPct: "20-25%",
						carbPct: "50-55%",
						proteinGr: "1.8-2.2 g/kg/día",
						carbinGr: "3.0-3.5 g/kg",
						fatinGr: "0.6-0.7 g/kg"
					  },
					  diasEntreno: {
						proteinPct: "20-25%",
						fatPct: "20-25%",
						carbPct: "60-65%",
						proteinGr: "1.8-2.2 g/kg/día",
						carbinGr: "4.0-5.0 g/kg",
						fatinGr: "0.5-0.6 g/kg"
					  }
					}
				  },
				  details: "Esta fase implementa un ciclado metabólico para maximizar la ganancia muscular mientras se controla la acumulación de grasa. Los días de entrenamiento intenso incluyen un mayor porcentaje de carbohidratos (50-55% de calorías) para maximizar el rendimiento y la recuperación, mientras que los días de menor intensidad o descanso reducen ligeramente los HC (40-45%) para mantener la sensibilidad a la insulina. La proteína se mantiene alta (2.0-2.4 g/kg/día) para optimizar la síntesis proteica, especialmente en el contexto de un superávit calórico moderado. Basado en Sports Medicine (2021), este enfoque es particularmente efectivo para atletas y personas con propósitos estéticos, ya que permite una ganancia muscular más neta con menor ganancia de grasa comparado con enfoques de superávit constante."
				}
        ],
        "Fase 2 (8-20 sem)": [
            {
                id: "hiperproteica2",
                title: "Fase de Volumen Hiperproteico",
                description: "Superávit controlado con énfasis en proteína",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "20-25%",
                        carbPct: "55-65%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "3.0-3.8 g/kg/día",
                        fatinGr: "0.5-0.7 g/kg/día"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "20-25%",
                        carbPct: "45-55%",
                        proteinGr: "2.0-2.4 g/kg/día",
                        carbinGr: "2.5-3.0 g/kg/día",
                        fatinGr: "0.5-0.7 g/kg/día"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "15-20%",
                        carbPct: "60-65%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "4.0-5.0 g/kg/día",
                        fatinGr: "0.4-0.5 g/kg/día"
                    }
                },
                details: "Esta fase principal de volumen mantiene un superávit calórico controlado (300-500 kcal) con un enfoque en proteína para maximizar la hipertrofia muscular mientras se limita la ganancia de grasa. La ingesta proteica elevada (2.0-2.4 g/kg/día) se distribuye en 4-5 comidas para optimizar la síntesis proteica a lo largo del día, aprovechando el 'muscle full signal' que limita los beneficios de más de 40g de proteína por comida. Los carbohidratos (45-55% de calorías) se ajustan según la intensidad del entrenamiento, siendo más altos en días de mayor demanda. Basado en Sports Medicine (2022), este enfoque es especialmente efectivo para individuos con propósitos estéticos, ya que maximiza la relación músculo-grasa durante la fase de volumen, con una ganancia muscular estimada del 70-80% del peso total ganado."
            },
                        {
                id: "altaHc",
                title: "Fase de Volumen con alto en HC",
                description: "Superávit con enfoque en carbohidratos",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        proteinPct: "15-20%",
                        fatPct: "15-20%",
                        carbPct: "65-70%",
                        proteinGr: "1.2-1.6 g/kg/día",
                        carbinGr: "4.0-5.0 g/kg/día",
                        fatinGr: "0.4-0.5 g/kg/día"
                    },
                    macrosEstetica: {
                        proteinPct: "20-25%",
                        fatPct: "20-25%",
                        carbPct: "55-60%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "3.0-3.5 g/kg/día",
                        fatinGr: "0.5-0.7 g/kg/día"
                    },
                    macrosRendimiento: {
                        diasEntreno: {
									// Usa fuerza
                            proteinPct: "15-20%",
                            fatPct: "20-25%",
                            carbPct: "55-60%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "3.0-3.5 g/kg",
                            fatinGr: "0.5-0.6 g/kg"
                        },
                        diasDescanso: {
										// Usa resistencia
                            proteinPct: "15-20%",
                            fatPct: "20-25%",
                            carbPct: "60-65%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "4.0-5.0 g/kg",
                            fatinGr: "0.6-0.7 g/kg"
                        }
                    }
                },
                details: "Esta fase está diseñada específicamente para atletas de alto rendimiento, con un enfoque en carbohidratos para maximizar el rendimiento y el crecimiento muscular. Para atletas de fuerza, los HC representan el 55-60% de las calorías, optimizando el glucógeno muscular para sesiones de alta intensidad. Para deportes de resistencia, el rango aumenta al 60-65% para soportar la demanda energética prolongada. La proteína se mantiene en 1.8-2.2 g/kg/día, suficiente para la hipertrofia sin desplazar HC necesarios para el rendimiento. Basado en el Position Stand de la International Society of Sports Nutrition (2018), este enfoque es crítico para atletas competitivos, ya que el glucógeno muscular es el limitante principal en deportes de alta intensidad y la recuperación entre sesiones."
            },
			{
                id: "carb-cycling-protein-pacing",
                title: "Carb Cycling / Protein Pacing",
                description: "Combinación de ciclado de carbohidratos y distribución optimizada de proteína",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "30-35%",
                            carbPct: "35-40%",
                            proteinGr: "1.8-2.2 g/kg",
                            carbinGr: "2.0-2.5 g/kg",
                            fatinGr: "0.8-1.0 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "20-25%",
                            carbPct: "45-50%",
                            proteinGr: "1.8-2.2 g/kg",
                            carbinGr: "3.0-3.5 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "30-35%",
                            fatPct: "30-35%",
                            carbPct: "30-35%",
                            proteinGr: "2.2-2.6 g/kg",
                            carbinGr: "2.0-2.4 g/kg",
                            fatinGr: "0.8-1.0 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "30-35%",
                            fatPct: "20-25%",
                            carbPct: "40-45%",
                            proteinGr: "2.2-2.6 g/kg",
                            carbinGr: "2.8-3.2 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "40-45%",
                            proteinGr: "2.0-2.4 g/kg",
                            carbinGr: "2.5-3.0 g/kg",
                            fatinGr: "0.7-0.9 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "15-20%",
                            carbPct: "50-55%",
                            proteinGr: "2.0-2.4 g/kg",
                            carbinGr: "4.0-4.8 g/kg",
                            fatinGr: "0.5-0.7 g/kg"
                        }
                    }
				},
                details: "Estrategia combinada que optimiza la ganancia muscular mediante ciclado de carbohidratos según la actividad y distribución de proteína en 4-6 comidas diarias (protein pacing). Los días de entrenamiento priorizan carbohidratos para rendimiento y recuperación, mientras los días de descanso moderan los HC para minimizar ganancia de grasa. La proteína se distribuye en dosis de 0.4-0.55 g/kg cada 3-4 horas para maximizar la síntesis proteica muscular. Basado en Journal of the International Society of Sports Nutrition (2021), este enfoque produce un 25% más de ganancia muscular magra comparado con enfoques tradicionales de superávit constante."
            }
        ],
        "Fase 3 (20+ sem)": [
            {
                id: "mantenimiento_reausjuste",
				title: "Fase de Mantenimiento y Reajuste",
				description: "Ciclado para consolidar ganancias",
				aplicable: ["ganancia"],
				macros: {
					macrosSalud: {
						diasDescanso: {
							proteinPct: "20-25%",
							fatPct: "30-35%",
							carbPct: "40-45%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "2.0-2.4 g/kg",
							fatinGr: "0.8-1.0 g/kg"
						},
						diasEntreno: {
							proteinPct: "20-25%",
							fatPct: "20-25%",
							carbPct: "50-55%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "2.6-3.0 g/kg",
							fatinGr: "0.6-0.8 g/kg"
						}
					},
					macrosEstetica: {
						diasDescanso: {
							proteinPct: "25-30%",
							fatPct: "30-35%",
							carbPct: "35-40%",
							proteinGr: "1.8-2.2 g/kg",
							carbinGr: "1.8-2.2 g/kg",
							fatinGr: "0.7-0.9 g/kg"
						},
						diasEntreno: {
							proteinPct: "25-30%",
							fatPct: "20-25%",
							carbPct: "45-50%",
							proteinGr: "1.8-2.2 g/kg",
							carbinGr: "2.3-2.8 g/kg",
							fatinGr: "0.5-0.7 g/kg"
						}
					},
					macrosRendimiento: {
						diasDescanso: {
							proteinPct: "20-25%",
							fatPct: "25-30%",
							carbPct: "45-50%",
							proteinGr: "1.8-2.2 g/kg",
							carbinGr: "2.5-3.0 g/kg",
							fatinGr: "0.6-0.8 g/kg"
						},
						diasEntreno: {
							proteinPct: "20-25%",
							fatPct: "15-20%",
							carbPct: "55-60%",
							proteinGr: "1.8-2.2 g/kg",
							carbinGr: "3.0-3.8 g/kg",
							fatinGr: "0.4-0.6 g/kg"
						}
					}
				},
				details: "Esta fase de mantenimiento post-ganancia implementa ciclado metabólico para consolidar las ganancias musculares y prevenir el exceso de grasa. El superávit calórico se reduce a niveles de mantenimiento, con ligeros ajustes según el progreso (±100-200 kcal). Los carbohidratos se ajustan según la actividad (40-50% de calorías), manteniendo la sensibilidad a la insulina y el rendimiento. La proteína se mantiene elevada (1.8-2.2 g/kg/día) para proteger la masa muscular ganada. Además, se incorpora NEAT Optimization (+5,000 pasos/día) para compensar la adaptación metabólica que ocurre tras períodos prolongados de superávit. Basado en British Journal of Sports Medicine (2022), este enfoque es esencial para la sostenibilidad a largo plazo de las ganancias musculares, evitando la recuperación de grasa que ocurre en muchos enfoques de 'hardgainer' tradicionales."
			}
        ],
		 "Fase 4 (>28 sem)": [
            {
                id: "metabolic-flexibility-training-ganancia",
                title: "Metabolic Flexibility Training",
                description: "Entrenamiento de flexibilidad metabólica para optimizar composición corporal",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-50%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "3.0-3.5 g/kg/día",
                        fatinGr: "0.8-1.0 g/kg/día"
                    },
                    macrosEstetica: {
                        semanasBajasHC: {
                            proteinPct: "30-35%",
                            fatPct: "35-40%",
                            carbPct: "25-30%",
                            proteinGr: "2.2-2.6 g/kg/día",
                            carbinGr: "1.8-2.2 g/kg/día",
                            fatinGr: "1.0-1.2 g/kg/día"
                        },
                        semanasAltasHC: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "40-45%",
                            proteinGr: "2.0-2.4 g/kg/día",
                            carbinGr: "3.0-3.5 g/kg/día",
                            fatinGr: "0.8-1.0 g/kg/día"
                        }
                    },
                    macrosRendimiento: {
                        semanasBajasHC: {
                            proteinPct: "25-30%",
                            fatPct: "30-35%",
                            carbPct: "35-40%",
                            proteinGr: "2.0-2.4 g/kg/día",
                            carbinGr: "2.5-3.0 g/kg/día",
                            fatinGr: "0.9-1.1 g/kg/día"
                        },
                        semanasAltasHC: {
                            proteinPct: "20-25%",
                            fatPct: "20-25%",
                            carbPct: "50-55%",
                            proteinGr: "1.8-2.2 g/kg/día",
                            carbinGr: "4.0-4.8 g/kg/día",
                            fatinGr: "0.6-0.8 g/kg/día"
                        }
                    }
                },
                details: "Fase avanzada de entrenamiento de la flexibilidad metabólica para atletas experimentados. Implementa rotaciones periódicas (2-3 semanas) entre periodos de moderado y alto contenido de carbohidratos para mejorar la capacidad del organismo de utilizar diferentes sustratos energéticos eficientemente. Mejora la sensibilidad insulinica, la capacidad oxidativa mitocondrial y previene la adaptación metabólica que limita las ganancias a largo plazo. Basado en Sports Medicine (2022), este enfoque permite continuar con ganancias musculares de calidad mientras se mantiene un porcentaje de grasa corporal bajo en atletas avanzados."
            },
            {
                id: "lean-bulk-controlado-avanzado",
                title: "Fase Lean Bulk Controlado",
                description: "Enfoque avanzado de superávit controlado para ganancia muscular magra",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        proteinPct: "25-30%",
                        fatPct: "25-30%",
                        carbPct: "40-45%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "2.8-3.2 g/kg/día",
                        fatinGr: "0.8-1.0 g/kg/día"
                    },
                    macrosEstetica: {
                        proteinPct: "30-35%",
                        fatPct: "25-30%",
                        carbPct: "35-40%",
                        proteinGr: "2.2-2.6 g/kg/día",
                        carbinGr: "2.5-2.8 g/kg/día",
                        fatinGr: "0.8-1.0 g/kg/día"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "20-25%",
                        carbPct: "50-55%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "3.8-4.5 g/kg/día",
                        fatinGr: "0.7-0.9 g/kg/día"
                    }
                },
                details: "Versión avanzada del enfoque Lean Bulk, optimizada para atletas con varios años de experiencia. Utiliza un superávit calórico muy controlado (200-300 kcal) con distribución estratégica de nutrientes alrededor de los entrenamientos. Incorpora periodos de mantenimiento cada 8-12 semanas para resetear la sensibilidad metabólica y minimizar la ganancia de grasa. Basado en Journal of the International Society of Sports Nutrition (2022), este enfoque produce una relación músculo:grasa de 4:1 en atletas avanzados, comparado con 2:1 en enfoques tradicionales de volumen."
            }
        ]
    
    },
    mantenimiento: {
        "Fase 1 (0-6 meses)": [
            {
                id: "equilibrada",
                title: "Fase de Dieta Equilibrada",
                description: "Dieta equilibrada para mantenimiento",
                aplicable: ["mantenimiento"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "30-35%",
                        carbPct: "40-45%",
                        proteinGr: "1.4-1.8 g/kg/día",
                        carbinGr: "2.0-2.5 g/kg/día",
                        fatinGr: "0.8-1.0 g/kg/día"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "35-45%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "1.8-2.2 g/kg/día",
                        fatinGr: "0.7-0.9 g/kg/día"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "2.5-3.0 g/kg/día",
                        fatinGr: "0.6-0.8 g/kg/día"
                    }
                },
                details: "Esta fase inicial de mantenimiento establece un equilibrio adecuado de macronutrientes para mantener el peso de forma sostenible sin estrés metabólico. La proteína se mantiene ligeramente por encima de los niveles estándar (1.6-2.2 g/kg/día) para preservar la masa muscular, especialmente crítica tras períodos de pérdida o ganancia de peso. Los carbohidratos (35-45% de calorías) provienen principalmente de fuentes complejas y ricas en fibra (>30g/día), mientras que las grasas saludables (30-35%) apoyan la producción hormonal. Basado en International Journal of Obesity (2019), este enfoque equilibrado es superior a dietas extremas para el mantenimiento a largo plazo, ya que minimiza las fluctuaciones hormonales que conducen al 'efecto yoyó'."
            },
            {
                id: "flexible-dieting",
                title: "Fase de Flexible Dieting",
                description: "80/20 rule para adherencia a largo plazo",
                aplicable: ["mantenimiento"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "30-35%",
                        carbPct: "40-45%",
                        proteinGr: "1.4-1.8 g/kg/día",
                        carbinGr: "2.0-2.5 g/kg/día",
                        fatinGr: "0.8-1.0 g/kg/día"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "35-45%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "1.8-2.2 g/kg/día",
                        fatinGr: "0.7-0.9 g/kg/día"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "2.5-3.0 g/kg/día",
                        fatinGr: "0.6-0.8 g/kg/día"
                    }
                },
                details: "Esta fase implementa la regla 80/20 (80% alimentos nutrientes + 20% flexibilidad) para aumentar la adherencia al plan nutricional a largo plazo. Los macronutrientes se mantienen en rangos saludables (proteína 25-30%, grasas 30-35%, HC 35-45%), pero con espacio para alimentos preferidos que mejoran la calidad de vida y reducen el estrés psicológico asociado a dietas rígidas. La proteína se mantiene en 1.6-2.0 g/kg/día, suficiente para preservar la masa muscular en mantenimiento. Basado en International Journal of Obesity (2019), este enfoque aumenta la adherencia en un 65% comparado con dietas estrictas, siendo esencial para el éxito a largo plazo en el mantenimiento de peso, especialmente en individuos con propósitos estéticos o de salud general."
            },
			{
					id: "low-carb-general",
					title: "Dieta Low Carb Mantenimiento",
					description: "Enfoque bajo en HC para inicio seguro y adaptable segun variabilidad.",
					aplicable: ["perdida", "mantenimiento"],
					macros: {
						macrosSalud: {
						proteinPct: "20-25%",
						fatPct: "45-55%",
						carbPct: "20-30%",
						proteinGr: "1.6-1.8 g/kg/día",
						carbinGr: "1.5-2.0 g/kg/día",
						fatinGr: "1.0-1.2 g/kg/día"
						},
					macrosEstetica: {
						proteinPct: "25-30%",
						fatPct: "50-60%",
						carbPct: "10-20%",
						proteinGr: "1.8-2.2 g/kg/día",
						carbinGr: "1.0-1.5 g/kg/día",
						fatinGr: "1.0-1.3 g/kg/día"
						},
					macrosRendimiento: {
						proteinPct: "20-25%",
						fatPct: "40-50%",
						carbPct: "30-40%",
						proteinGr: "1.6-1.8 g/kg/día",
						carbinGr: "2.5-3.0 g/kg/día",
						fatinGr: "0.8-1.0 g/kg/día"
						}
				},
					details: "La dieta low carb (LCD) es una estrategia flexible con ingestas moderadas de carbohidratos (50-150 g/día) que se adapta a diversos objetivos. En pérdida de peso, induce un déficit calórico con mayor quema de grasa y control glucémico. En mantenimiento, promueve la estabilidad metabólica y previene la recuperación de peso. Para ganancia muscular, requiere ciclado de carbohidratos y superávit controlado para optimizar el glucógeno muscular. En recomposición corporal, combina alta proteína con entrenamiento de resistencia para perder grasa y ganar músculo simultáneamente. Basada en evidencia de Nutrition Reviews (2021), es sostenible a largo plazo y compatible con actividad física regular cuando se ajustan los macros según el propósito."
			}
        ],
        "Fase 2 (6+ meses)": [
            {
               id: "calorie-cycling",
				title: "Calorie Cycling Dinámico",
				description: "Ciclo de mantenimiento y ligero déficit/superávit",
				aplicable: ["mantenimiento"],
				macros: {
					macrosSalud: {
						diasDescanso: {
									// Usa días de déficit
							proteinPct: "20-25%",
							fatPct: "30-35%",
							carbPct: "35-40%",
							proteinGr: "1.4-1.8 g/kg",
							carbinGr: "1.8-2.0 g/kg",
							fatinGr: "0.8-1.0 g/kg"
						},
						diasEntreno: {
									// Usa días de superávit
							proteinPct: "25-30%",
							fatPct: "25-35%",
							carbPct: "45-50%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "2.2-2.5 g/kg",
							fatinGr: "0.7-0.8 g/kg"
						}
					},
					macrosEstetica: {
						diasDescanso: {
									// Usa días de déficit
							proteinPct: "25-30%",
							fatPct: "25-35%",
							carbPct: "35-40%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "1.8-2.0 g/kg",
							fatinGr: "0.8-0.9 g/kg"
						},
						diasEntreno: {
									// Usa días de superávit
							proteinPct: "25-30%",
							fatPct: "25-35%",
							carbPct: "45-50%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "2.2-2.5 g/kg",
							fatinGr: "0.7-0.8 g/kg"
						}
					},
					macrosRendimiento: {
						diasDescanso: {
									// Usa días de déficit
							proteinPct: "20-25%",
							fatPct: "25-30%",
							carbPct: "40-45%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "2.2-2.5 g/kg",
							fatinGr: "0.7-0.8 g/kg"
						},
						diasEntreno: {
									// Usa días de superávit
							proteinPct: "20-25%",
							fatPct: "25-30%",
							carbPct: "55-60%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "3.0-3.5 g/kg",
							fatinGr: "0.6-0.7 g/kg"
						}
					}
				},
				details: "Esta fase avanzada implementa Calorie Cycling Dinámico (3 días mantenimiento + 2 días ligero déficit/superávit de ±100 kcal) para prevenir la adaptación metabólica que ocurre tras 6 meses de mantenimiento constante. El ligero déficit en algunos días compensa la reducción natural de la tasa metabólica basal (TMB) post-pérdida de peso (5-8%), mientras que el ligero superávit en otros días mantiene la función hormonal y la adherencia psicológica. Los macronutrientes se mantienen estables en rangos saludables, con especial atención a la calidad de los alimentos. Basado en el MATADOR Study Extension (American Journal of Clinical Nutrition, 2020), este enfoque es crítico para el mantenimiento sostenible, ya que previene el 'efecto rebote' que afecta al 80% de las personas que intentan mantener la pérdida de peso con enfoques estáticos."
			},
            {
                id: "metabolic-flexibility",
				title: "Fase de Metabolic Flexibility Training",
				description: "Rotación avanzada para mantener flexibilidad metabólica",
				aplicable: ["mantenimiento"],
				macros: {
					macrosSalud: {
						diasDescanso: {
										// Usa semanasBajasHC
							proteinPct: "20-25%",
							fatPct: "25-35%",
							carbPct: "35-45%",
							proteinGr: "1.4-1.8 g/kg/día",
							carbinGr: "2.0-2.5 g/kg/día",
							fatinGr: "0.8-1.0 g/kg/día"
						},
						diasEntreno: {
										// Usa semanasAltasHC
							proteinPct: "20-25%",
							fatPct: "25-35%",
							carbPct: "50-60%",
							proteinGr: "1.4-1.8 g/kg/día",
							carbinGr: "2.8-3.5 g/kg/día",
							fatinGr: "0.6-0.8 g/kg/día"
						}
					},
					macrosEstetica: {
						diasDescanso: {
										// Usa semanasBajasHC
							proteinPct: "25-30%",
							fatPct: "25-35%",
							carbPct: "35-45%",
							proteinGr: "1.6-2.0 g/kg/día",
							carbinGr: "1.8-2.2 g/kg/día",
							fatinGr: "0.7-0.9 g/kg/día"
						},
						diasEntreno: {
										// Usa semanasAltasHC
							proteinPct: "25-30%",
							fatPct: "25-35%",
							carbPct: "50-60%",
							proteinGr: "1.6-2.0 g/kg/día",
							carbinGr: "2.5-3.0 g/kg/día",
							fatinGr: "0.6-0.7 g/kg/día"
						}
					},
					macrosRendimiento: {
						diasDescanso: {
										// Usa semanasBajasHC
							proteinPct: "20-25%",
							fatPct: "20-30%",
							carbPct: "45-55%",
							proteinGr: "1.6-2.0 g/kg/día",
							carbinGr: "2.5-3.0 g/kg/día",
							fatinGr: "0.6-0.8 g/kg/día"
						},
						diasEntreno: {
										// Usa semanasAltasHC
							proteinPct: "20-25%",
							fatPct: "20-30%",
							carbPct: "60-70%",
							proteinGr: "1.6-2.0 g/kg/día",
							carbinGr: "3.5-4.5 g/kg/día",
							fatinGr: "0.5-0.6 g/kg/día"
						}
					}
				},
				details: "Esta fase de mantenimiento avanzado implementa una rotación semanal de macronutrientes para mantener la flexibilidad metabólica y prevenir la adaptación a largo plazo. La rotación (moderate carb → high carb) mejora la capacidad del cuerpo para utilizar diferentes fuentes de energía, manteniendo la sensibilidad a la insulina y la función mitocondrial. Los días de high carb (45-55% de calorías en HC) ayudan a normalizar hormonas como la leptina, que pueden verse afectadas en mantenimiento prolongado. Basado en Obesity Reviews (2021), esta estrategia es esencial para individuos que han mantenido su peso por más de 18 meses, ya que previene la reducción gradual de la tasa metabólica y mantiene la adherencia al plan nutricional mediante variabilidad controlada."
			}
        ],
		"Fase 3 (18+ meses)": [
            {
                id: "metabolic-flexibility-mantenimiento",
                title: "Fase de Metabolic Flexibility Training",
                description: "Mantenimiento avanzado con enfoque en flexibilidad metabólica",
                aplicable: ["mantenimiento"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "30-35%",
                        carbPct: "40-45%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "2.5-3.0 g/kg/día",
                        fatinGr: "0.9-1.1 g/kg/día"
                    },
                    macrosEstetica: {
                        semanasBajasHC: {
                            proteinPct: "25-30%",
                            fatPct: "35-40%",
                            carbPct: "30-35%",
                            proteinGr: "1.8-2.2 g/kg/día",
                            carbinGr: "2.0-2.5 g/kg/día",
                            fatinGr: "1.0-1.2 g/kg/día"
                        },
                        semanasAltasHC: {
                            proteinPct: "20-25%",
                            fatPct: "25-30%",
                            carbPct: "45-50%",
                            proteinGr: "1.6-2.0 g/kg/día",
                            carbinGr: "3.0-3.5 g/kg/día",
                            fatinGr: "0.8-1.0 g/kg/día"
                        }
                    },
                    macrosRendimiento: {
                        semanasBajasHC: {
                            proteinPct: "20-25%",
                            fatPct: "30-35%",
                            carbPct: "40-45%",
                            proteinGr: "1.8-2.2 g/kg/día",
                            carbinGr: "2.8-3.2 g/kg/día",
                            fatinGr: "0.9-1.1 g/kg/día"
                        },
                        semanasAltasHC: {
                            proteinPct: "15-20%",
                            fatPct: "20-25%",
                            carbPct: "55-60%",
                            proteinGr: "1.6-2.0 g/kg/día",
                            carbinGr: "4.0-4.5 g/kg/día",
                            fatinGr: "0.7-0.9 g/kg/día"
                        }
                    }
                },
                details: "Estrategia avanzada de mantenimiento para quienes han sostenido su composición corporal por más de 18 meses. Implementa variación periódica de macronutrientes (rotaciones cada 2-4 semanas) para mantener la flexibilidad metabólica y prevenir adaptaciones que podrían llevar a gradual aumento de peso. Incluye periodos de moderado déficit y superávit calórico (±10-15%) para mantener el set point metabólico. Basado en Obesity Reviews (2021), este enfoque es esencial para el mantenimiento a muy largo plazo, especialmente en personas con predisposición a recuperar peso, ya que mantiene activas las vías metabólicas de regulación del peso corporal."
            }
        ]
    
    },
    mixto: {
        "Fase 1 Volume (0-12 sem)": [
            {
                id: "lean-bulk",
                title: "Fase de Volumen Controlado",
                description: "Superávit moderado para construir base muscular",
                aplicable: ["mixto"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.6-2.0 g/kg/día",
                        carbinGr: "2.2-2.8 g/kg/día",
                        fatinGr: "0.7-0.9 g/kg/día"
                    },
                    macrosEstetica: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "2.5-3.0 g/kg/día",
                        fatinGr: "0.6-0.8 g/kg/día"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "20-25%",
                        carbPct: "55-65%",
                        proteinGr: "1.8-2.2 g/kg/día",
                        carbinGr: "3.5-4.5 g/kg/día",
                        fatinGr: "0.5-0.7 g/kg/día"
                    }
                },
                details: "Esta fase inicial de recomposición corporal establece un superávit calórico moderado (100-300 kcal) para construir masa muscular antes de la fase de definición, evitando una ganancia excesiva de grasa. La ingesta proteica (1.8-2.2 g/kg/día) está optimizada para maximizar la síntesis proteica, mientras que los carbohidratos (45-55% de calorías) proporcionan energía para los entrenamientos y ayudan a reponer el glucógeno muscular. Las grasas se mantienen en un rango saludable (25-30%) para apoyar la producción hormonal. Basado en Journal of the International Society of Sports Nutrition (2021), este enfoque es fundamental para la recomposición corporal exitosa, ya que establece una base muscular que permitirá una mayor tasa metabólica durante la fase de déficit posterior, mejorando la relación músculo-grasa a largo plazo."
            },
            {
                 id: "cicladoMetabolico4",
				title: "Fase de Ciclado Metabólico Ganancia",
				description: "Ciclado para optimizar ganancia muscular",
				aplicable: ["mixto"],
				macros: {
					macrosSalud: {
						diasDescanso: {
							proteinPct: "20-25%",
							fatPct: "30-35%",
							carbPct: "40-45%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "2.0-2.4 g/kg",
							fatinGr: "0.8-1.0 g/kg"
						},
						diasEntreno: {
							proteinPct: "20-25%",
							fatPct: "20-25%",
							carbPct: "50-55%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "2.6-3.0 g/kg",
							fatinGr: "0.6-0.8 g/kg"
						}
					},
					macrosEstetica: {
						diasDescanso: {
							proteinPct: "25-30%",
							fatPct: "25-30%",
							carbPct: "40-45%",
							proteinGr: "2.0-2.4 g/kg",
							carbinGr: "2.2-2.6 g/kg",
							fatinGr: "0.7-0.9 g/kg"
						},
						diasEntreno: {
							proteinPct: "25-30%",
							fatPct: "25-30%",
							carbPct: "50-55%",
							proteinGr: "2.0-2.4 g/kg",
							carbinGr: "2.8-3.2 g/kg",
							fatinGr: "0.6-0.8 g/kg"
						}
					},
					macrosRendimiento: {
						diasDescanso: {
							proteinPct: "20-25%",
							fatPct: "20-25%",
							carbPct: "50-55%",
							proteinGr: "1.8-2.2 g/kg",
							carbinGr: "3.0-3.5 g/kg",
							fatinGr: "0.6-0.7 g/kg"
						},
						diasEntreno: {
							proteinPct: "20-25%",
							fatPct: "20-25%",
							carbPct: "60-65%",
							proteinGr: "1.8-2.2 g/kg",
							carbinGr: "4.0-5.0 g/kg",
							fatinGr: "0.5-0.6 g/kg"
						}
					}
				},
				details: "Esta fase implementa un ciclado metabólico para maximizar la ganancia muscular con control de grasa durante la fase de volume en recomposición. Los días de entrenamiento intenso incluyen un mayor porcentaje de carbohidratos (50-55% de calorías) para maximizar el rendimiento y la recuperación, mientras que los días de menor intensidad o descanso reducen ligeramente los HC (40-45%) para mantener la sensibilidad a la insulina. La proteína se mantiene alta (2.0-2.4 g/kg/día) para optimizar la síntesis proteica, especialmente en el contexto de un superávit calórico moderado. Basado en Sports Medicine (2021), este enfoque es particularmente efectivo para la recomposición corporal, ya que permite una ganancia muscular neta incluso en déficit calórico leve cuando se combina con entrenamiento de fuerza intenso."
			}
        ],
        "Fase 2 Definición (12-24 sem)": [
            {
               
				id: "calorie-cycling",
				title: "Fase de Calorie Cycling Dinámico",
				description: "Ciclo de déficit y ligero superávit",
				aplicable: ["mixto"],
				macros: {
					macrosSalud: {
						diasDescanso: {
							proteinPct: "20-25%",
							fatPct: "50-55%",
							carbPct: "20-25%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "1.5-1.8 g/kg",
							fatinGr: "1.1-1.3 g/kg"
						},
						diasEntreno: {
							proteinPct: "20-25%",
							fatPct: "40-45%",
							carbPct: "30-35%",
							proteinGr: "1.6-2.0 g/kg",
							carbinGr: "2.0-2.4 g/kg",
							fatinGr: "0.9-1.1 g/kg"
						}
					},
					macrosEstetica: {
						diasDescanso: {
							proteinPct: "25-30%",
							fatPct: "45-50%",
							carbPct: "10-20%",
							proteinGr: "2.0-2.4 g/kg",
							carbinGr: "1.0-1.8 g/kg",
							fatinGr: "0.9-1.2 g/kg"
						},
						diasEntreno: {
							proteinPct: "25-30%",
							fatPct: "35-40%",
							carbPct: "30-40%",
							proteinGr: "2.0-2.4 g/kg",
							carbinGr: "2.2-2.8 g/kg",
							fatinGr: "0.7-0.9 g/kg"
						}
					},
					macrosRendimiento: {
						diasDescanso: {
							proteinPct: "25-30%",
							fatPct: "40-45%",
							carbPct: "15-25%",
							proteinGr: "2.0-2.4 g/kg",
							carbinGr: "1.5-2.0 g/kg",
							fatinGr: "0.8-1.0 g/kg"
						},
						diasEntreno: {
							proteinPct: "25-30%",
							fatPct: "30-35%",
							carbPct: "40-50%",
							proteinGr: "2.0-2.4 g/kg",
							carbinGr: "3.0-4.0 g/kg",
							fatinGr: "0.6-0.8 g/kg"
						}
					}
				},
				details: "Esta fase de definición implementa Calorie Cycling Dinámico (3 días déficit de 200-300 kcal + 2 días ligero superávit de 100-200 kcal + 2 días mantenimiento) para optimizar la pérdida de grasa mientras se preserva la masa muscular ganada en la fase 1. Los días de entrenamiento incluyen un rango controlado de carbohidratos (30-40% de calorías) para mantener el rendimiento y la síntesis proteica, mientras que los días de descanso reducen los HC (10-20%) para potenciar la oxidación de grasas. La proteína se mantiene elevada (2.0-2.4 g/kg/día) para proteger la masa muscular. Basado en Sports Medicine (2022), este enfoque es superior al déficit calórico constante para la recomposición corporal, ya que previene la adaptación metabólica y mantiene la tasa de pérdida de grasa a lo largo del tiempo, especialmente en individuos con propósitos estéticos."
			},
			{
					id: "low-carb-general",
					title: "Dieta Low Carb Ciclada",
					description: "Enfoque bajo en HC para inicio seguro y adaptable segun variabilidad.",
					aplicable: ["perdida", "mantenimiento"],
					macros: {
						macrosSalud: {
						proteinPct: "20-25%",
						fatPct: "45-55%",
						carbPct: "20-30%",
						proteinGr: "1.6-1.8 g/kg/día",
						carbinGr: "1.5-2.0 g/kg/día",
						fatinGr: "1.0-1.2 g/kg/día"
						},
					macrosEstetica: {
						proteinPct: "25-30%",
						fatPct: "50-60%",
						carbPct: "10-20%",
						proteinGr: "1.8-2.2 g/kg/día",
						carbinGr: "1.0-1.5 g/kg/día",
						fatinGr: "1.0-1.3 g/kg/día"
						},
					macrosRendimiento: {
						proteinPct: "20-25%",
						fatPct: "40-50%",
						carbPct: "30-40%",
						proteinGr: "1.6-1.8 g/kg/día",
						carbinGr: "2.5-3.0 g/kg/día",
						fatinGr: "0.8-1.0 g/kg/día"
						}
				},
					details: "La dieta low carb (LCD) es una estrategia flexible con ingestas moderadas de carbohidratos (50-150 g/día) que se adapta a diversos objetivos. En pérdida de peso, induce un déficit calórico con mayor quema de grasa y control glucémico. En mantenimiento, promueve la estabilidad metabólica y previene la recuperación de peso. Para ganancia muscular, requiere ciclado de carbohidratos y superávit controlado para optimizar el glucógeno muscular. En recomposición corporal, combina alta proteína con entrenamiento de resistencia para perder grasa y ganar músculo simultáneamente. Basada en evidencia de Nutrition Reviews (2021), es sostenible a largo plazo y compatible con actividad física regular cuando se ajustan los macros según el propósito."
			}
        ],
        "Fase 3 Mantenimiento Metabólico (24-32 sem)": [
            {
               id: "metabolic-flexibility2",
				title: "Fase de Mantenimiento Metabólico",
				description: "Rotación para estabilizar TMB",
				aplicable: ["mixto"],
				macros: {
					macrosSalud: {
						diasDescanso: {
										// Usa semanasBajasHC
							proteinPct: "20-25%",
							fatPct: "35-45%",
							carbPct: "30-40%",
							proteinGr: "1.6-2.0 g/kg/día",
							carbinGr: "2.0-2.5 g/kg/día",
							fatinGr: "0.8-1.0 g/kg/día"
						},
						diasEntreno: {
										// Usa semanasAltasHC
							proteinPct: "20-25%",
							fatPct: "30-40%",
							carbPct: "40-50%",
							proteinGr: "1.6-2.0 g/kg/día",
							carbinGr: "2.5-3.0 g/kg/día",
							fatinGr: "0.7-0.9 g/kg/día"
						}
					},
					macrosEstetica: {
						diasDescanso: {
										// Usa semanasBajasHC
							proteinPct: "25-30%",
							fatPct: "30-35%",
							carbPct: "30-40%",
							proteinGr: "1.8-2.2 g/kg/día",
							carbinGr: "2.0-2.5 g/kg/día",
							fatinGr: "0.8-1.0 g/kg/día"
						},
						diasEntreno: {
										// Usa semanasAltasHC
							proteinPct: "25-30%",
							fatPct: "30-35%",
							carbPct: "50-60%",
							proteinGr: "1.8-2.2 g/kg/día",
							carbinGr: "3.5-4.5 g/kg/día",
							fatinGr: "0.6-0.8 g/kg/día"
						}
					},
					macrosRendimiento: {
						diasDescanso: {
										// Usa semanasBajasHC
							proteinPct: "25-30%",
							fatPct: "25-35%",
							carbPct: "35-45%",
							proteinGr: "2.0-2.4 g/kg/día",
							carbinGr: "2.5-3.0 g/kg/día",
							fatinGr: "0.7-0.9 g/kg/día"
						},
						diasEntreno: {
										// Usa semanasAltasHC
							proteinPct: "25-30%",
							fatPct: "25-35%",
							carbPct: "55-65%",
							proteinGr: "2.0-2.4 g/kg/día",
							carbinGr: "4.5-5.5 g/kg/día",
							fatinGr: "0.5-0.7 g/kg/día"
						}
					}
				},
				details: "Esta fase de mantenimiento metabólico implementa una rotación semanal de macronutrientes para estabilizar la tasa metabólica basal (TMB) tras 24 semanas de déficit calórico intermitente. La rotación (moderate carb → high carb) mejora la flexibilidad metabólica, permitiendo al cuerpo adaptarse a diferentes fuentes de energía y previniendo la adaptación que ralentiza la recomposición corporal. Los días de high carb (40-50% de calorías en HC) ayudan a normalizar hormonas como la leptina y la T3, que tienden a disminuir en déficit prolongado. Basado en Obesity Reviews (2022), esta estrategia es crítica para mantener la progresión en recomposición corporal avanzada, especialmente en individuos que han estado en déficit intermitente durante más de 6 meses y necesitan estabilizar su metabolismo antes de la fase final de ajuste."
			}
        ],
        "Fase 4 Ajuste Metabólico (>32 sem)": [
                      {
				id: "metabolic-adaptation",
				title: "Fase de Ajuste Metabólico",
				description: "Protocolo para superar plateaus avanzados",
				aplicable: ["mixto"],
				macros: {
					macrosSalud: {
						diasDescanso: {
							proteinPct: "20-25%",
							fatPct: "25-35%",
							carbPct: "35-40%",
							proteinGr: "1.6-2.0 g/kg/día",
							carbinGr: "2.0-2.5 g/kg/día",
							fatinGr: "0.8-0.9 g/kg/día"
						},
						diasEntreno: {
							proteinPct: "20-25%",
							fatPct: "25-30%",
							carbPct: "40-45%",
							proteinGr: "1.6-2.0 g/kg/día",
							carbinGr: "2.5-2.8 g/kg/día",
							fatinGr: "0.7-0.8 g/kg/día"
						}
					},
					macrosEstetica: {
						diasDescanso: {
							proteinPct: "25-30%",
							fatPct: "30-35%",
							carbPct: "40-45%",
							proteinGr: "1.8-2.2 g/kg/día",
							carbinGr: "2.2-2.6 g/kg/día",
							fatinGr: "0.8-0.9 g/kg/día"
						},
						diasEntreno: {
							proteinPct: "25-30%",
							fatPct: "25-30%",
							carbPct: "50-60%",
							proteinGr: "1.8-2.2 g/kg/día",
							carbinGr: "3.5-4.5 g/kg/día",
							fatinGr: "0.6-0.7 g/kg/día"
						}
					},
					macrosRendimiento: {
						diasDescanso: {
							proteinPct: "25-30%",
							fatPct: "25-30%",
							carbPct: "45-50%",
							proteinGr: "2.0-2.4 g/kg/día",
							carbinGr: "2.8-3.5 g/kg/día",
							fatinGr: "0.7-0.8 g/kg/día"
						},
						diasEntreno: {
							proteinPct: "25-30%",
							fatPct: "20-25%",
							carbPct: "55-65%",
							proteinGr: "2.0-2.4 g/kg/día",
							carbinGr: "4.5-5.5 g/kg/día",
							fatinGr: "0.5-0.6 g/kg/día"
						}
					}
				},
				details: "Esta fase avanzada implementa el Metabolic Adaptation Protocol con ajustes específicos para días de entrenamiento y descanso. En días de descanso se prioriza un moderado déficit calórico y mayor aporte de grasas, mientras los días de entrenamiento maximizan la carga de carbohidratos para rendimiento y recuperación. La proteína se mantiene alta (1.8-2.4 g/kg/día) consistentemente para proteger masa muscular. La rotación avanzada de macronutrientes según la actividad física mantiene la flexibilidad metabólica y optimiza la recomposición corporal en atletas avanzados."
			},
                        {
                id: "cicladoMetabolico5",
			title: "Fase de Ciclado Metabólico Avanzado",
			description: "Ciclado avanzado para optimización",
			aplicable: ["mixto"],
			macros: {
				macrosSalud: {
					diasDescanso: {
						proteinPct: "20-25%",
						fatPct: "30-35%",
						carbPct: "35-40%",
						proteinGr: "1.6-2.0 g/kg/día",
						carbinGr: "2.0-2.5 g/kg/día",
						fatinGr: "0.8-0.9 g/kg/día"
					},
					diasEntreno: {
						proteinPct: "20-25%",
						fatPct: "25-30%",
						carbPct: "40-45%",
						proteinGr: "1.6-2.0 g/kg/día",
						carbinGr: "2.5-2.8 g/kg/día",
						fatinGr: "0.7-0.8 g/kg/día"
					}
				},
				macrosEstetica: {
					diasDescanso: {
						proteinPct: "25-30%",
						fatPct: "30-35%",
						carbPct: "40-45%",
						proteinGr: "1.8-2.2 g/kg/día",
						carbinGr: "2.2-2.6 g/kg/día",
						fatinGr: "0.8-0.9 g/kg/día"
					},
					diasEntreno: {
						proteinPct: "25-30%",
						fatPct: "25-30%",
						carbPct: "50-60%",
						proteinGr: "1.8-2.2 g/kg/día",
						carbinGr: "3.0-3.5 g/kg/día",
						fatinGr: "0.6-0.7 g/kg/día"
					}
				},
				macrosRendimiento: {
					diasDescanso: {
						proteinPct: "25-30%",
						fatPct: "25-30%",
						carbPct: "45-50%",
						proteinGr: "2.0-2.4 g/kg/día",
						carbinGr: "2.8-3.5 g/kg/día",
						fatinGr: "0.6-0.8 g/kg/día"
					},
					diasEntreno: {
						proteinPct: "25-30%",
						fatPct: "20-25%",
						carbPct: "50-60%",
						proteinGr: "2.0-2.4 g/kg/día",
						carbinGr: "3.5-4.5 g/kg/día",
						fatinGr: "0.5-0.6 g/kg/día"
					}
				}
                },
                details: "Esta fase implementa un ciclado metabólico avanzado específicamente diseñado para atletas intermedios/avanzados que buscan optimizar su composición corporal y rendimiento. Para propósitos estéticos, los carbohidratos se mantienen en un rango controlado (40-45% de calorías) para maximizar la definición muscular, mientras que para propósitos de rendimiento, el rango aumenta (45-50%) para soportar la demanda energética de los entrenamientos. La proteína se distribuye en 4-5 comidas (0.4-0.5g/kg cada 3-4h) para maximizar la síntesis proteica a lo largo del día. Basado en Journal of the International Society of Sports Nutrition (2022), este enfoque avanzado es críticamente importante para superar plateaus en recomposición corporal prolongada, especialmente en individuos que han estado en déficit intermitente por más de 8 meses y necesitan ajustes finos para continuar progresando."
            }
        ]
    }
};
// Matriz de compatibilidad basada en tu tabla
 // Matriz de compatibilidad completa para todas las estrategias
const matrizCompatibilidad = {
    perdida: {
			"Fase 1 (0-12 sem)": {
				"Modified Ketogenic Diet": {
					"Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "neutral" },
					"Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Restricted Ketogenic Diet (RKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Carb Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Protein Cycling": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Metabolic Flexibility Training": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Refeed Strategy": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
					"Flexible Dieting (80/20 rule)": { "salud": "mo recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Dieta Estándar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Intermittent Fasting + Cycling": { "salud": "on recomendada", "estetica": "no recomendada", "rendimiento": "no recomedada" },
					"Hydration Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Protein Pacing": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
				},
				"Fase de Ciclado Metabólico inicial": {
					"Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "neutral" },
					"Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Restricted Ketogenic Diet (RKD)": { "salud": "neutral", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Protein Cycling": { "salud": "no recomendado", "estetica": "no recomendada", "rendimiento": "neutral" },
					"Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Metabolic Flexibility Training": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Flexible Dieting (80/20 rule)": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Dieta Estándar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Intermittent Fasting + Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Protein Pacing": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" }
				},
				"Dieta Low Carb General": {
					"Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "neutral", "rendimiento": "recomendada" },
					"Restricted Ketogenic Diet (RKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Protein Cycling": { "salud": "no recomendado", "estetica": "no recomendada", "rendimiento": " no recomendada" },
					"Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Flexible Dieting (80/20 rule)": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Dieta Estándar/Equilibrada": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
					"Intermittent Fasting + Cycling": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Hydration Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Protein Pacing": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" }
				}
			},
			"Fase 2 (12-24 sem)": {
				"Fase de Ciclado Metabólico": {
					"Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "neutral" },
					"Restricted Ketogenic Diet (RKD)": { "salud": "neutral", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Protein Cycling": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Flexible Dieting (80/20 rule)": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Dieta Estándar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Intermittent Fasting + Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "no recomendada" },
					"High Carb Resistencia": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Protein Pacing": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Metabolic Flexibility Training": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" }
				},
				"Dieta Low Carb Ciclada": {
					"Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Restricted Ketogenic Diet (RKD)": { "salud": "neutral", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Protein Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Metabolic Flexibility Training": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
					"Refeed Strategy": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Dieta Estándar/Equilibrada": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
					"Intermittent Fasting + Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "no RECOMENDADA" },
					"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Hydration Strategy": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
					"Targeted Carb Timing": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
					"Protein Pacing": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" }
				}
			},
			"Fase 3 Avanzada (>24 sem)": {
				"Fase de Ajuste Metabólico": {
					"Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "neutral" },
					"Cyclic Ketogenic Diet (CKD)": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
					"Carb Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
					"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Protein Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Calorie Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Dieta Estándar/Equilibrada": { "salud": "recomendada", "estetica": "neutral", "rendimiento": "neutral" },
					"Intermittent Fasting + Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Targeted Carb Timing": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
					"Protein Pacing": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" }
				},
				"Fase de Transición a Mantenimiento": {
					"Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Carb Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Protein Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Dieta Estándar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Intermittent Fasting + Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" }
				}
			},
			"Fase 4 Ajuste Metabólico (>32 sem)": {
				"Protocolo de Adaptación Metabolica": {
					"Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "neutral" },
					"Cyclic Ketogenic Diet (CKD)": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
					"Carb Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
					"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Protein Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Calorie Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Dieta Estándar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Intermittent Fasting + Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
					"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Targeted Carb Timing": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
					"Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" }
				},
				"Fase de Transición a Mantenimiento": {
					"Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
					"Carb Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Protein Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Dieta Estándar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Intermittent Fasting + Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
					"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
					"Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
					"Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" }
				}
			}
    },
    ganancia: {
        "Fase 1 (0-8 sem)": {
            "Fase Lean Bulk Controlado": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" }
				
				
            },
            "Fase de Ciclado Metabólico Ganancia": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" }
				
            }
        },
        "Fase 2 (8-20 sem)": {
            "Carb Cycling / Protein Pacing": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" }
				
            },
            "Fase de Volumen Hiperproteico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" }
				
            },
            "Fase de Volumen con alto en HC": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" }
				
            }
        },
        "Fase 3 (20-28 sem)": {
            "Fase de Mantenimiento y Reajuste": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "neutal" }
				
            }
        },
        "Fase 4 (>28 sem)": {
            "Metabolic Flexibility Training": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" }
				
            },
			
			"Fase Lean Bulk Controlado": {
			}
        }
    },
    mantenimiento: {
        "Fase 1 (0-6 meses)": {
            "Fase de Flexible Dieting": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }
				
            },
            "Fase de Dieta Equilibrada": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }
				
            },
			"Dieta Low Carb General": {
				"Targeted Ketogenic Diet (TKD)": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
				"Cyclic Ketogenic Diet (CKD)": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
				"Restricted Ketogenic Diet (RKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
				"Modified Ketogenic Diet": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
				"Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
				"Protein Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
				"Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
				"Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Dieta Estándar/Equilibrada": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
				"Intermittent Fasting + Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
				"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
				"Protein Pacing": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" }
			  }
        },
        "Fase 2 (6-18 meses)": {
            "Dieta Equilibrada": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }
				
            },
            "Calorie Cycling Dinámico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }
				
            }
        },
        "Fase 3 (18+ meses)": {
            "Fase de Metabolic Flexibility Training": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "recomendada", estetica: "neutral", rendimiento: "recomendada" }
				
            }
        }
    },
    mixto: {
        "Fase 1 Volumen (0-12 sem)": {
            "Fase de Volumen Controlado": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Calorie Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }
				
            },
            "Fase de Ciclado Metabólico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }
				
            }
        },
        "Fase 2 Definición (12-24 sem)": {
            "Fase de Calorie Cycling Dinámico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }
				
            },
            "Fase deCalorie Cycling Dinámico + Carb Cycling": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }
				
            },
			"Dieta Low Carb Ciclada": {
				"Targeted Ketogenic Diet (TKD)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Cyclic Ketogenic Diet (CKD)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Restricted Ketogenic Diet (RKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
				"Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
				"Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
				"Protein Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Refeed Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
				"Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
				"Dieta Estándar/Equilibrada": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
				"Intermittent Fasting + Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
				"Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
				"Targeted Carb Timing": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
				"Protein Pacing": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" }
			  }
			
        },
        "Fase 3 Mantenimiento Metabólico (24-32 sem)": {
            "Fase de Mantenimiento Metabólico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Intermittent Fasting + Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" }
				
            }
        },
        "Fase 4 Ajuste Metabólico (>32 sem)": {
            "Fase de Ajuste Metabólico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" }
				
            },
            "Fase de Ciclado Metabólico Avanzado": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Estándar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
				"Dieta Low Carb General": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" }
				
            }
        }
    }
};
const recomendacionesBaseMatriz = {
	"perdida": {
	"Fase 1 (0-12 sem)": {
	"Modified Ketogenic Diet": [
	"Inicia con 50-100g de carbohidratos netos diarios para inducir cetosis suave (1.5-3.0 mmol/L de beta-hidroxibutirato), respaldado por estudios de Paoli et al. (2019) que demuestran eficacia en pérdida de grasa sin comprometer masa muscular.",
	"Monitorea electrolitos (sodio 5-7g, potasio 3-4.5g, magnesio 400mg diarios) para prevenir el 'keto flu' y mantener función muscular, según evidencia de Masood et al. (2020) en Journal of the American College of Nutrition.",
	"Limita el déficit calórico a 300-500 kcal/día (15-20% por debajo de mantenimiento) para preservar masa muscular, basado en meta-análisis de Helms et al. (2014) que muestra que déficits mayores (>25%) aumentan riesgo de sarcopenia.",
	"Prioriza grasas monoinsaturadas y omega-3 (aceite de oliva, aguacate, pescado graso) para reducir inflamación sistémica, respaldado por estudios de Santos et al. (2012) en Nutrición Journal.",
	"Incorpora fibra soluble (psyllium, chía) 15-20g/día para mantener salud intestinal durante la transición cetogénica, según evidencia de Reddel et al. (2019) en Nutrients."
	],
	"Fase de Ciclado Metabólico inicial": [
	"Implementa ciclos semanales de carbohidratos (5 días bajos HC: 30-50g, 2 días moderados: 100-150g) para mejorar flexibilidad metabólica, respaldado por estudios de de Luis et al. (2017) que muestran mejoras en sensibilidad a la insulina.",
	"Combina con ayuno intermitente (14-16h) solo después de 8 semanas de estabilidad, basado en evidencia de Patterson et al. (2015) que indica que la implementación prematura puede aumentar cortisol y estrés metabólico.",
	"Enfócate en hidratación óptima (30-35ml/kg/día) con electrolitos para mantener volumen plasmático y función renal, respaldado por estudios de Perrier et al. (2020) en European Journal of Clinical Nutrition.",
	"Incorpora 1-2 sesiones semanales de entrenamiento de fuerza de alta intensidad para preservar masa muscular durante la adaptación, según meta-análisis de Schoenfeld et al. (2017) en Sports Medicine.",
	"Monitorea indicadores de estrés metabólico (cortisol matutino, HRV) para ajustar intensidad del protocolo, basado en recomendaciones de Campbell et al. (2018) en Journal of the International Society of Sports Nutrition."
	],
	"Dieta Low Carb General": [
	"Mantén carbohidratos en 80-120g diarios para pérdida de grasa sostenida, con evidencia de Hall et al. (2015) en Cell Metabolism mostrando superioridad sobre dietas altas en HC para reducción de grasa visceral.",
	"Incorpora protein pacing (0.4-0.55g/kg por comida, 4-5 comidas) para maximizar síntesis proteica y saciedad, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
	"Optimiza NEAT incrementando 2,000-4,000 pasos diarios adicionales para elevar gasto energético 150-300kcal/día, basado en evidencia de Levine et al. (2006) en PLOS Medicine.",
	"Prioriza vegetales de hoja verde y crucíferas (2-3 tazas diarias) para fibra y micronutrientes, respaldado por estudios de Hruby et al. (2016) en American Journal of Clinical Nutrition.",
	"Incluye 1-2 días semanales de mayor ingesta (80-90% de mantenimiento) para prevenir adaptación metabólica temprana, según evidencia de Tremblay et al. (2018) en Obesity Reviews."
	]
	},
	"Fase 2 (12-24 sem)": {
	"Fase de Ciclado Metabólico": [
	"Alterna ciclos semanales de carbohidratos (3 días bajos HC: 50g, 2 días medios HC: 100g, 2 días altos HC: 150-200g) para prevenir adaptación, respaldado por estudios de Thiel et al. (2020) en Nutrients que muestran mejoras en oxidación de grasas.",
	"Incluye refeeds moderados (1 día cada 10-14 días con 110-120% de mantenimiento) para restaurar leptina y evitar desaceleración metabólica, basado en evidencia de Doucet et al. (2009) en International Journal of Obesity.",
	"Ajusta timing de comidas: distribuye proteínas en 4-6 ingestas con 0.4-0.5g/kg por comida para maximizar MPS, respaldado por estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
	"Implementa 1-2 sesiones semanales de entrenamiento HIIT para mejorar flexibilidad metabólica, según meta-análisis de Viana et al. (2019) en Sports Medicine.",
	"Monitorea marcadores de salud (HbA1c, perfil lipídico) cada 8-12 semanas para ajustes personalizados, basado en recomendaciones de Santos et al. (2018) en Journal of Clinical Lipidology."
	],
	"Dieta Low Carb Ciclada": [
	"Cicla bajos carbohidratos (40-60g) con 1-2 días targeted (100-150g) alrededor de entrenamientos para sostener rendimiento, respaldado por estudios de Zinn et al. (2017) en Journal of the International Society of Sports Nutrition.",
	"Limita déficits a 200-300kcal/día en plateau, con monitoreo de DEXA cada 12 semanas para ajustes, basado en evidencia de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
	"Incorpora flexibilidad dietética (80/20) con enfoque en alimentos integrales, respaldado por estudios de Dunn et al. (2016) en Journal of the Academy of Nutrition and Dietetics.",
	"Ajusta grasa total según ingesta de HC (60-70% de calorías en días bajos HC, 50-60% en días altos HC) para mantener balance energético, basado en recomendaciones de Krieger et al. (2018) en Nutrients.",
	"Implementa estrategias de manejo del estrés (meditación, sueño óptimo) para regular cortisol y hambre, respaldado por estudios de Tomiyama et al. (2014) en Obesity."
	]
	},
	"Fase 3 Avanzada (>24 sem)": {
	"Fase de Ajuste Metabólico": [
	"Introduce entrenamiento de flexibilidad metabólica con rotaciones de macronutrientes (3 días cetogénicos, 2 días carbos moderados, 2 días carbos altos) para optimizar uso de combustibles, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
	"Usa refeeds estratégicos (cada 4-6 semanas, 24-48h con 110-130% de mantenimiento) para mitigar adaptación metabólica, basado en evidencia de Müller et al. (2019) en Obesity Reviews.",
	"Enfócate en protein pacing avanzado (0.4-0.55g/kg por comida, 5-6 comidas) y timing de carbohidratos targeted (20-40g pre-entrenamiento) para rendimiento, respaldado por estudios de Areta et al. (2013) en Journal of Physiology.",
	"Incorpora periodización nutricional alineada con entrenamiento (semanas de volumen vs. intensidad), según evidencia de Tinsley et al. (2018) en Sports Medicine.",
	"Monitorea RMR cada 8-12 semanas para ajustar déficit y prevenir plateau, basado en recomendaciones de Müller et al. (2020) en European Journal of Clinical Nutrition."
	],
	"Fase de Transición a Mantenimiento": [
	"Transita gradualmente aumentando carbohidratos 10-15g cada 3-4 días hasta 150-200g/día, con evidencia de Hall et al. (2019) en Cell Metabolism mostrando mejoras en salud metabólica post-pérdida.",
	"Incorpora ayuno intermitente 14-16h máximo 3-4 días/semana para control de apetito, basado en estudios de de Cabo et al. (2019) en New England Journal of Medicine.",
	"Optimiza hidratación (35ml/kg/día) y NEAT (aumento progresivo a 10,000 pasos/día) para mantenimiento sin rebote, respaldado por estudios de Pontzer et al. (2016) en Current Biology.",
	"Implementa 'cheat meals' controlados (1-2 veces/semana, 20-30% sobre mantenimiento) para adherencia, basado en evidencia de Klem et al. (2018) en Obesity Science & Practice.",
	"Establece protocolo de monitoreo continuo (peso semanal, medidas corporales, análisis sanguíneos trimestrales) para ajustes proactivos, según recomendaciones del American College of Sports Medicine (2020)."
	]
	},
	"Fase 4 Ajuste Metabólico (>32 sem)": {
	"Protocolo de Adaptación Metabolica": [
	"Entrena flexibilidad metabólica con ciclos avanzados (semanas alternas de 50-70g HC y 150-200g HC) para eficiencia energética, respaldado por estudios de Thiel et al. (2021) en Nutrients.",
	"Monitorea marcadores avanzados (HOMA-IR, adiponectina, perfil lipídico completo) cada 12 semanas, con beneficios respaldados en estudios de Volek et al. (2016) en Nutritional Metabolism.",
	"Ajusta calorie cycling (5 días déficit 200kcal, 2 días mantenimiento) para prevenir estancamiento, enfocando en rendimiento y estética, basado en evidencia de Campbell et al. (2019) en Journal of the International Society of Sports Nutrition.",
	"Incorpora periodización de suplementos (creatina en días de fuerza, beta-alanina en días de resistencia) para optimizar rendimiento, respaldado por estudios de Trexler et al. (2015) en Journal of the International Society of Sports Nutrition.",
	"Implementa estrategias de recuperación avanzadas (crioterapia, terapia de compresión) para optimizar adaptaciones metabólicas, según evidencia de Leeder et al. (2012) en British Journal of Sports Medicine."
	],
	"Fase de Transición a Mantenimiento": [
	"Aumenta gradualmente ingesta calórica 50-100kcal cada 3-4 días hasta mantenimiento, incorporando flexible dieting para adherencia, basado en estudios de Klem et al. (2020) en International Journal of Obesity.",
	"Usa meal timing optimization (ventana de alimentación 10-12h) para maximizar recuperación y control de peso, respaldado por evidencia de Patterson et al. (2017) en Nutrients.",
	"Incluye estrategias de hidratación personalizada (30-35ml/kg/día con ajuste por clima) y protein pacing (1.8-2.2g/kg distribuidos) para salud general, según recomendaciones de Jäger et al. (2017) en Journal of the International Society of Sports Nutrition.",
	"Implementa 'micro-cycles' de 3-4 días de ligero déficit (100-200kcal) mensuales para prevenir ganancia de grasa, basado en evidencia de Helms et al. (2021) en Sports Medicine.",
	"Establece protocolo de monitoreo de composición corporal mediante DEXA cada 12-16 semanas para ajustes precisos, respaldado por recomendaciones de Heymsfield et al. (2014) en Obesity."
	]
	}
	},
	"ganancia": {
	"Fase 1 (0-8 sem)": {
	"Fase Lean Bulk Controlado": [
	"Mantén superávit calórico moderado (300-500 kcal) con énfasis en proteínas 1.6-2.2g/kg para ganancia muscular limpia, respaldado por meta-análisis de Morton et al. (2018) en Journal of the International Society of Sports Nutrition.",
	"Incorpora carb cycling (días de entrenamiento: 4-6g/kg HC, días de descanso: 2-3g/kg HC) para optimizar rendimiento y recuperación, basado en estudios de Thomas et al. (2016) en Journal of the International Society of Sports Nutrition.",
	"Enfócate en protein pacing (0.4-0.55g/kg por comida, 4-6 comidas) para síntesis proteica máxima, respaldado por evidencia de Mamerow et al. (2014) en Journal of Nutrition.",
	"Prioriza carbohidratos de absorción lenta (avena, batata, arroz integral) en 60-65% de las comidas para estabilidad glucémica, según estudios de Thomas et al. (2016) en Journal of the International Society of Sports Nutrition.",
	"Incluye 1-2 días semanales de 'maintenance' para prevenir adaptación metabólica temprana, basado en evidencia de Helms et al. (2020) en Journal of the International Society of Sports Nutrition."
	],
	"Fase de Ciclado Metabólico Ganancia": [
	"Cicla carbohidratos altos (5-7g/kg) en días de entrenamiento para apoyar hipertrofia, con evidencia de Aragon et al. (2017) en Journal of the International Society of Sports Nutrition mostrando mejoras en síntesis proteica.",
	"Combina con calorie cycling (5 días superávit 300-500kcal, 2 días mantenimiento) para controlar ganancia de grasa, respaldado por estudios de Helms et al. (2016) en Journal of the International Society of Sports Nutrition.",
	"Asegura hidratación óptima (35-40ml/kg/día) para volumen celular y performance, basado en recomendaciones de Shirreffs et al. (2004) en Journal of Sports Sciences.",
	"Incorpora 1-2 sesiones semanales de cardio de baja intensidad para mejorar capacidad aeróbica sin interferir con ganancia muscular, según evidencia de Schoenfeld et al. (2017) en Sports Medicine.",
	"Monitorea relación grasa/músculo mediante DEXA cada 8-12 semanas para ajustar protocolo, respaldado por estudios de Heymsfield et al. (2014) en Obesity."
	]
	},
	"Fase 2 (8-20 sem)": {
	"Carb Cycling / Protein Pacing": [
	"Alterna días altos HC (5-7g/kg) y bajos HC (2-3g/kg) con protein pacing avanzado (0.4-0.55g/kg por comida, 5-6 comidas) para maximizar ganancia muscular, respaldado por estudios de Churchward-Venne et al. (2014) en Journal of Physiology.",
	"Usa targeted carb timing (30-50g HC 30-60 min pre-entrenamiento) para boost en rendimiento, respaldado por meta-análisis de Grgic et al. (2018) en Journal of the International Society of Sports Nutrition.",
	"Incluye refeeds semanales (1 día con 110-120% de mantenimiento) para mantener motivación y adherencia, basado en evidencia de Krieger (2017) en Journal of the International Society of Sports Nutrition.",
	"Implementa periodización nutricional alineada con mesociclos de entrenamiento (volumen vs. intensidad), según recomendaciones de Tinsley et al. (2018) en Sports Medicine.",
	"Monitorea indicadores de estrés metabólico (cortisol, HRV) para ajustar intensidad del protocolo, basado en estudios de Campbell et al. (2018) en Journal of the International Society of Sports Nutrition."
	],
	"Fase de Volumen Hiperproteico": [
	"Eleva proteínas a 2.3-2.6g/kg con calorie cycling (superávit 300-500kcal en días de entrenamiento, mantenimiento en días de descanso) para hipertrofia óptima, respaldado por meta-análisis de Morton et al. (2018) en Journal of the International Society of Sports Nutrition.",
	"Enfócate en meal timing post-entreno (20-40g proteína + 0.8g/kg HC dentro de 45 min) para síntesis proteica máxima, basado en estudios de Areta et al. (2013) en Journal of Physiology.",
	"Monitorea NEAT y ajusta ingesta para mantener ganancia de grasa <0.5kg/mes, respaldado por evidencia de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
	"Incorpora 1-2 días semanales de 'recovery nutrition' con mayor ingesta de grasas saludables (30-35% de calorías) para reducir inflamación, según estudios de Goto et al. (2018) en Nutrients.",
	"Implementa monitoreo de marcadores renales (creatinina, BUN) cada 12 semanas para seguridad, basado en recomendaciones de Devries et al. (2018) en Journal of the International Society of Sports Nutrition."
	],
	"Fase de Volumen con alto en HC": [
	"Usa dieta alta en carbohidratos (6-8g/kg) para deportes de resistencia, mejorando rendimiento y recuperación, respaldado por estudios de Burke et al. (2011) en Medicine & Science in Sports & Exercise.",
	"Cicla calorías (superávit 400-600kcal en días de entrenamiento intenso, 200-300kcal en días de descanso) para bulk controlado, según evidencia de Tinsley et al. (2018) en Sports Medicine.",
	"Incorpora protein pacing (1.8-2.2g/kg distribuidos en 5-6 comidas) para balance y preservación de estética, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
	"Prioriza carbohidratos de alta calidad (frutas, vegetales, granos integrales) para fibra y micronutrientes, según recomendaciones de Thomas et al. (2016) en Journal of the International Society of Sports Nutrition.",
	"Incluye estrategias de hidratación personalizada (1.5L/hora de ejercicio intenso) para rendimiento óptimo, basado en estudios de Sawka et al. (2007) en Medicine & Science in Sports & Exercise."
	]
	},
	"Fase 3 (20-28 sem)": {
	"Fase de Mantenimiento y Reajuste": [
	"Ajusta a mantenimiento con flexibilidad dietética (80/20 rule) para consolidar ganancias, con evidencia de Krieger (2017) en Journal of the International Society of Sports Nutrition mostrando mejor adherencia a largo plazo.",
	"Incluye metabolic flexibility training (ciclos semanales de HC) para eficiencia en uso de combustibles, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
	"Optimiza hydration (35-40ml/kg/día) y targeted carb timing (20-30g HC pre-entrenamiento) para sostenibilidad, basado en recomendaciones de Shirreffs et al. (2004) en Journal of Sports Sciences.",
	"Implementa 1-2 días semanales de 'metabolic reset' con ligero déficit (200-300kcal) para prevenir adaptación, respaldado por evidencia de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
	"Monitorea composición corporal mediante DEXA cada 12 semanas para ajustes precisos, según recomendaciones de Heymsfield et al. (2014) en Obesity."
	]
	},
	"Fase 4 (>28 sem)": {
	"Metabolic Flexibility Training": [
	"Entrena alternando combustibles con ciclos avanzados (semanas alternas de 3-4g/kg y 6-7g/kg HC) para ganancias avanzadas, respaldado por estudios de Thiel et al. (2021) en Nutrients.",
	"Combina con intermittent fasting 14-16h máximo 2-3 días/semana para control de composición corporal, basado en evidencia de Patterson et al. (2017) en Nutrients.",
	"Enfócate en protein pacing avanzado (0.4-0.55g/kg por comida, 5-6 comidas) y meal timing para rendimiento óptimo, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
	"Incorpora periodización de suplementos (creatina en días de fuerza, beta-alanina en días de resistencia) para optimizar adaptaciones, según estudios de Trexler et al. (2015) en Journal of the International Society of Sports Nutrition.",
	"Implementa monitoreo de marcadores avanzados (HOMA-IR, perfil lipídico completo) cada 12 semanas para salud metabólica, basado en recomendaciones de Volek et al. (2016) en Nutritional Metabolism."
	],
	"Fase Lean Bulk Controlado": [
	"Mantén bulk lean con superávit controlado (200-400kcal) y flexible dieting para adherencia, respaldado por estudios de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
	"Usa NEAT optimization (aumento progresivo a 10,000 pasos/día) para balance energético, basado en evidencia de Pontzer et al. (2016) en Current Biology.",
	"Incorpora refeed strategy (1 día cada 10-14 días con 110-120% de mantenimiento) para prevenir fatiga metabólica, respaldado por estudios de Doucet et al. (2009) en International Journal of Obesity.",
	"Implementa estrategias de recuperación avanzadas (crioterapia, terapia de compresión) para optimizar adaptaciones, según evidencia de Leeder et al. (2012) en British Journal of Sports Medicine.",
	"Monitorea relación grasa/músculo mediante DEXA cada 8-12 semanas para ajustes precisos, basado en recomendaciones de Heymsfield et al. (2014) en Obesity."
	]
	}
	},
	"mantenimiento": {
	"Fase 1 (0-6 meses)": {
	"Fase de Flexible Dieting": [
	"Aplica regla 80/20 con enfoque en alimentos integrales para sostenibilidad, respaldado por estudios de Dunn et al. (2016) en Journal of the Academy of Nutrition and Dietetics.",
	"Optimiza meal timing (ventana de alimentación 10-12h) para estabilidad energética, basado en evidencia de Patterson et al. (2017) en Nutrients.",
	"Enfócate en hidratación óptima (30-35ml/kg/día) y NEAT (8,000-10,000 pasos/día) para mantenimiento de composición corporal, respaldado por estudios de Pontzer et al. (2016) en Current Biology.",
	"Incorpora protein pacing (1.6-2.2g/kg distribuidos en 4-5 comidas) para preservación muscular, según estudios de Mamerow et al. (2014) en Journal of Nutrition.",
	"Implementa 'micro-cycles' mensuales (3-4 días de ligero déficit 100-200kcal) para prevenir ganancia de grasa, respaldado por evidencia de Helms et al. (2021) en Sports Medicine."
	],
	"Fase de Dieta Equilibrada": [
	"Mantén balance de macronutrientes estándar (45-55% HC, 25-35% grasas, 15-25% proteínas) para salud general, respaldado por recomendaciones de American College of Sports Medicine (2020).",
	"Incorpora protein pacing (0.3-0.4g/kg por comida, 4-5 comidas) para saciedad y preservación muscular, basado en estudios de Mamerow et al. (2014) en Journal of Nutrition.",
	"Usa calorie cycling leve (±100-200kcal diarios) para evitar adaptación metabólica, respaldado por evidencia de Helms et al. (2021) en Sports Medicine.",
	"Prioriza alimentos ricos en fibra (25-38g/día) para salud intestinal y saciedad, según recomendaciones de Slavin (2013) en Nutrition Reviews.",
	"Incluye 1-2 días semanales de 'metabolic challenge' (variación de 200-300kcal) para mantener flexibilidad metabólica, basado en estudios de de Luis et al. (2021) en Nutrients."
	],
	"Dieta Low Carb General": [
	"Mantén carbohidratos en 50-100g diarios para estabilidad metabólica, con evidencia de Volek et al. (2016) en Nutritional Metabolism mostrando mejoras en sensibilidad a la insulina.",
	"Cicla proteínas (1.8-2.2g/kg) y refeeds semanales (1 día con 105-110% de mantenimiento) para variedad y adherencia, respaldado por estudios de de Luis et al. (2017) en Nutrients.",
	"Monitorea rendimiento con targeted carb timing (20-30g HC pre-entrenamiento) si es necesario, basado en evidencia de Grgic et al. (2018) en Journal of the International Society of Sports Nutrition.",
	"Incorpora grasas saludables (40-50% de calorías) con énfasis en omega-3 (1-2g EPA/DHA diarios) para reducir inflamación, según estudios de Goto et al. (2018) en Nutrients.",
	"Implementa monitoreo de electrolitos y marcadores renales cada 12 semanas para seguridad, respaldado por recomendaciones de Devries et al. (2018) en Journal of the International Society of Sports Nutrition."
	]
	},
	"Fase 2 (6-18 meses)": {
	"Dieta Equilibrada": [
	"Sostén dieta equilibrada con flexibilidad para largo plazo, enfocando en salud estética y rendimiento, respaldado por estudios de Dunn et al. (2016) en Journal of the Academy of Nutrition and Dietetics.",
	"Incluye intermittent fasting 14-16h máximo 2-3 días/semana para beneficios en control de peso, basado en evidencia de Patterson et al. (2017) en Nutrients.",
	"Optimiza NEAT (aumento progresivo a 10,000 pasos/día) y hydration (35ml/kg/día) para equilibrio energético, respaldado por estudios de Pontzer et al. (2016) en Current Biology.",
	"Incorpora protein pacing avanzado (0.4-0.5g/kg por comida, 5 comidas) para salud muscular, según estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
	"Implementa 'macro cycling' mensual (variación de 10-15% en HC y grasas) para prevenir adaptación, basado en evidencia de Helms et al. (2021) en Sports Medicine."
	],
	"Calorie Cycling Dinámico": [
	"Cicla calorías dinámicamente (±200-400kcal diarios) para mantenimiento sin estancamiento, respaldado por estudios de Helms et al. (2021) en Sports Medicine.",
	"Combina con carb cycling (variación de 30-50g HC diarios) para variedad metabólica, basado en evidencia de de Luis et al. (2021) en Nutrients.",
	"Enfócate en protein pacing (1.8-2.2g/kg distribuidos) para salud muscular, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
	"Incorpora 1-2 días semanales de 'metabolic reset' con ligero déficit (200kcal) para mantener sensibilidad, según estudios de Müller et al. (2019) en Obesity Reviews.",
	"Monitorea composición corporal mediante DEXA cada 16 semanas para ajustes precisos, basado en recomendaciones de Heymsfield et al. (2014) en Obesity."
	]
	},
	"Fase 3 (18+ meses)": {
	"Fase de Metabolic Flexibility Training": [
	"Entrena flexibilidad con rotaciones avanzadas de macronutrientes (semanas alternas de 3-4g/kg y 5-6g/kg HC) para salud avanzada, respaldado por estudios de Thiel et al. (2021) en Nutrients.",
	"Incorpora refeeds estratégicos (cada 4-6 semanas, 24-48h con 110-130% de mantenimiento) y fasting 14-16h 2-3 días/semana para optimización metabólica, basado en evidencia de Patterson et al. (2017) en Nutrients.",
	"Usa meal timing personalizado y targeted carbs (20-40g HC pre-entrenamiento) para performance sostenida, respaldado por estudios de Grgic et al. (2018) en Journal of the International Society of Sports Nutrition.",
	"Implementa monitoreo de marcadores avanzados (HOMA-IR, perfil lipídico completo) cada 12 semanas, según recomendaciones de Volek et al. (2016) en Nutritional Metabolism.",
	"Incluye estrategias de recuperación avanzadas (crioterapia, terapia de compresión) para optimizar adaptaciones, basado en evidencia de Leeder et al. (2012) en British Journal of Sports Medicine."
	]
	}
	},
	"mixto": {
	"Fase 1 Volumen (0-12 sem)": {
	"Fase de Volumen Controlado": [
	"Controla superávit con dieting flexible (300-500kcal) para ganancia muscular y control de grasa, respaldado por estudios de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
	"Cicla carbohidratos (días de entrenamiento: 4-6g/kg HC, días de descanso: 2-3g/kg HC) para fases de volumen mixto, basado en evidencia de Thomas et al. (2016) en Journal of the International Society of Sports Nutrition.",
	"Enfócate en protein pacing (0.4-0.55g/kg por comida, 4-6 comidas) para hipertrofia y recuperación, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
	"Incorpora 1-2 días semanales de 'metabolic reset' con ligero déficit (200-300kcal) para prevenir adaptación, según evidencia de Helms et al. (2021) en Sports Medicine.",
	"Monitorea relación grasa/músculo mediante DEXA cada 8-12 semanas para ajustes precisos, basado en recomendaciones de Heymsfield et al. (2014) en Obesity."
	],
	"Fase de Ciclado Metabólico": [
	"Cicla metabólicamente (3 días volumen: superávit 300-500kcal, 2 días mantenimiento, 2 días ligero déficit 200kcal) para balance entre ganancia y definición, respaldado por estudios de Helms et al. (2021) en Sports Medicine.",
	"Usa calorie cycling para ajustes dinámicos según respuesta individual, basado en evidencia de Krieger (2017) en Journal of the International Society of Sports Nutrition.",
	"Optimiza hydration (35ml/kg/día) y NEAT (aumento progresivo a 10,000 pasos/día) para equilibrio, respaldado por estudios de Pontzer et al. (2016) en Current Biology.",
	"Incluye estrategias de manejo del estrés (meditación, sueño óptimo) para regular cortisol, según estudios de Tomiyama et al. (2014) en Obesity.",
	"Implementa monitoreo de marcadores de estrés metabólico (cortisol, HRV) cada 4 semanas para ajustes, basado en recomendaciones de Campbell et al. (2018) en Journal of the International Society of Sports Nutrition."
	]
	},
	"Fase 2 Definición (12-24 sem)": {
	"Fase de Calorie Cycling Dinámico": [
	"Cicla calorías (5 días déficit 300-500kcal, 2 días mantenimiento) para definición mientras se mantiene músculo, respaldado por estudios de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
	"Incluye refeeds estratégicos (cada 8-12 semanas, 24-48h con 110-120% de mantenimiento) para rendimiento, basado en evidencia de Doucet et al. (2009) en International Journal of Obesity.",
	"Monitorea meal timing para optimización (distribución de proteínas en 4-6 comidas), respaldado por estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
	"Incorpora 1-2 sesiones semanales de entrenamiento HIIT para mejorar flexibilidad metabólica, según meta-análisis de Viana et al. (2019) en Sports Medicine.",
	"Implementa monitoreo de RMR cada 8 semanas para ajustar déficit y prevenir plateau, basado en recomendaciones de Müller et al. (2020) en European Journal of Clinical Nutrition."
	],
	"Fase de Calorie Cycling Dinámico + Carb Cycling": [
	"Combina ciclados (días bajos HC: 50-80g, días medios HC: 100-150g) para definición efectiva, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
	"Usa targeted carb timing (20-30g HC pre-entrenamiento) para workouts, basado en evidencia de Grgic et al. (2018) en Journal of the International Society of Sports Nutrition.",
	"Incorpora protein pacing avanzado (0.4-0.55g/kg por comida, 5-6 comidas) para preservación muscular, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
	"Implementa 'micro-cycles' de 3-4 días de ligero déficit (100-200kcal) mensuales para prevenir adaptación, según evidencia de Helms et al. (2021) en Sports Medicine.",
	"Monitorea indicadores de estrés metabólico (cortisol, HRV) para ajustar intensidad del protocolo, basado en estudios de Campbell et al. (2018) en Journal of the International Society of Sports Nutrition."
	],
	"Dieta Low Carb Ciclada": [
	"Cicla low carb (4 días 50-70g HC, 2 días 100-150g HC, 1 día 200-250g HC) para definición mixta, con beneficios en pérdida de grasa, respaldado por estudios de Zinn et al. (2017) en Journal of the International Society of Sports Nutrition.",
	"Ajusta con refeeds estratégicos (cada 4-6 semanas) para sostenibilidad, basado en evidencia de Doucet et al. (2009) en International Journal of Obesity.",
	"Enfócate en flexibilidad metabólica con rotaciones semanales, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
	"Incorpora protein pacing avanzado (1.8-2.2g/kg distribuidos) para preservación muscular, según estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
	"Implementa monitoreo de electrolitos y marcadores de estrés cada 8 semanas para ajustes precisos, basado en recomendaciones de Devries et al. (2018) en Journal of the International Society of Sports Nutrition."
	]
	},
	"Fase 3 Mantenimiento Metabólico (24-32 sem)": {
	"Fase de Mantenimiento Metabólico": [
	"Mantiene con flexibilidad metabólica (ciclos semanales de HC) para equilibrio a largo plazo, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
	"Usa intermittent fasting 14-16h máximo 3-4 días/semana + cycling para control, basado en evidencia de Patterson et al. (2017) en Nutrients.",
	"Optimiza protein pacing (1.8-2.2g/kg distribuidos en 5-6 comidas) y hydration (35ml/kg/día), respaldado por estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
	"Incorpora 'metabolic challenges' semanales (variación de 200-300kcal) para mantener flexibilidad, según estudios de Müller et al. (2019) en Obesity Reviews.",
	"Monitorea composición corporal mediante DEXA cada 12 semanas para ajustes precisos, basado en recomendaciones de Heymsfield et al. (2014) en Obesity."
	]
	},
	"Fase 4 Ajuste Metabólico (>32 sem)": {
	"Fase de Ajuste Metabólico": [
	"Ajusta metabólicamente con ciclos avanzados (semanas alternas de 3-4g/kg y 5-6g/kg HC) para objetivos mixtos, respaldado por estudios de Thiel et al. (2021) en Nutrients.",
	"Incluye refeed strategy (cada 4-6 semanas, 24-48h con 110-130% de mantenimiento) para salud, basado en evidencia de Doucet et al. (2009) en International Journal of Obesity.",
	"Enfócate en meal timing personalizado y NEAT (10,000-12,000 pasos/día) para optimización, respaldado por estudios de Pontzer et al. (2016) en Current Biology.",
	"Implementa monitoreo de marcadores avanzados (HOMA-IR, perfil lipídico completo) cada 12 semanas, según recomendaciones de Volek et al. (2016) en Nutritional Metabolism.",
	"Incorpora periodización de suplementos (creatina en días de fuerza, beta-alanina en días de resistencia) para optimizar rendimiento, basado en estudios de Trexler et al. (2015) en Journal of the International Society of Sports Nutrition."
	],
	"Fase de Ciclado Metabólico Avanzado": [
	"Cicla avanzado (3 días cetogénicos, 2 días carbos moderados, 2 días carbos altos) para optimización continua, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
	"Combina con dieting flexible (80/20 rule) para adherencia, basado en evidencia de Dunn et al. (2016) en Journal of the Academy of Nutrition and Dietetics.",
	"Usa targeted carbs (20-40g HC pre-entrenamiento) para rendimiento, respaldado por estudios de Grgic et al. (2018) en Journal of the International Society of Sports Nutrition.",
	"Incorpora protein pacing avanzado (0.4-0.55g/kg por comida, 5-6 comidas) para salud muscular, según estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
	"Implementa monitoreo de RMR y composición corporal cada 8 semanas para ajustes precisos, basado en recomendaciones de Müller et al. (2020) en European Journal of Clinical Nutrition."
	]
	}
	}
}
// Definir recomendaciones específicas según objetivo y propósito
    const estrategiaCompleta = {
  perdida: {
    salud: {
      resumenEjecutivo: [
        {
          icon: "fas fa-sync-alt",
          title: "Metabolic Flexibility Training",
          text: "Implementa rotación semanal de HC (50-100g) tras 8-12 semanas para evitar adaptación metabólica"
        },
        {
          icon: "fas fa-clock",
          title: "Ayuno Intermitente",
          text: "Solo tras 12 semanas de estabilidad con MKD, nunca al inicio"
        },
        {
          icon: "fas fa-balance-scale",
          title: "Déficit Moderado",
          text: "Limita el déficit a 300-500 kcal/día para preservar masa muscular"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "RKD (Dieta Cetogénica Estricta) en salud general: Solo para casos médicos específicos (epilepsia, cáncer). En obesidad, aumenta riesgo de hipercolesterolemía. [NEJM, 2022]",
          "No recomendado para personas con trastornos alimentarios o historial de atracones",
          "Requiere supervisión médica en personas con diabetes tipo 1 o insuficiencia renal"
        ],
        conclusion: "Prioriza MKD (Dieta Cetogénica Modificada) + Carb Cycling + Calorie Cycling para salud.",
        ejemplosPracticos: [
          "Fases iniciales: MKD con 20-25% proteínas, 60-70% grasas, 5-10% HC",
          "Fases medias: Carb Cycling (5 días cetosis + 2 días 50-100g HC)"
        ],
        erroresCriticos: [
          {
            titulo: "RKD en salud general",
            descripcion: "Solo para casos médicos (ej.: epilepsia, cáncer). En obesidad, aumenta riesgo de hipercolesterolemía.",
            fuente: "[NEJM, 2022]"
          },
          {
            titulo: "Ignorar adaptación metabólica",
            descripcion: "Sin ciclado, la TMB ↓ un 10-15% tras 24 semanas.",
            fuente: "[Obesity, 2021]"
          },
          {
            titulo: "Exceso de restricción",
            descripcion: "Déficit >500 kcal/día acelera pérdida muscular y disminuye T3.",
            fuente: "[AJCN, 2020]"
          }
        ]
      }
    },
    estetica: {
      resumenEjecutivo: [
        {
          icon: "fas fa-fire",
          title: "Refeed Estratégico",
          text: "1 día/semana HC alto (150-200g) tras 2 semanas de déficit o al notar estancamiento"
        },
        {
          icon: "fas fa-protein",
          title: "Protein Cycling",
          text: "4 semanas 2.4g/kg + 1 semana 1.6g/kg. Solo tras >12 semanas de déficit continuo"
        },
        {
          icon: "fas fa-chart-line",
          title: "Evita el Déficit Estático",
          text: "Sin ciclado, la TMB ↓ un 8-12% tras 12 semanas, frenando la recomposición"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "RKD: Pérdida de masa muscular por déficit calórico extremo y limitación de proteínas",
          "Protein Cycling en fases iniciales: En déficit calórico agudo, >2.2g/kg no aporta beneficios adicionales y estresa riñones [AJCN, 2020]",
          "Refeed sin sincronización con entrenamiento: HC alto en días de descanso ↑ grasa corporal en sujetos con historia de obesidad [International Journal of Obesity, 2022]"
        ],
        conclusion: "Fases iniciales: MKD + Carb Cycling (días de entrenamiento intenso). Fases avanzadas (>12 semanas): Protein Cycling + Refeed estratégico (1 día/semana HC alto).",
        ejemplosPracticos: [
          "Día de entrenamiento: 2.4g/kg proteína, 1.2g/kg HC, 0.8g/kg grasas",
          "Día de refeed: 2.0g/kg proteína, 3.5g/kg HC, 0.6g/kg grasas"
        ],
        erroresCriticos: [
          {
            titulo: "Protein Cycling en fases iniciales",
            descripcion: "En déficit calórico agudo, >2.2g/kg no aporta beneficios adicionales y estresa riñones.",
            fuente: "[AJCN, 2020]"
          },
          {
            titulo: "Refeed sin base científica",
            descripcion: "HC alto en días de descanso ↑ grasa corporal en sujetos con historia de obesidad.",
            fuente: "[International Journal of Obesity, 2022]"
          },
          {
            titulo: "Déficit estático",
            descripcion: "Sin ciclado, la TMB ↓ un 8-12% tras 12 semanas, frenando la recomposición.",
            fuente: "[Obesity, 2019]"
          }
        ]
      }
    },
    rendimiento: {
      resumenEjecutivo: [
        {
          icon: "fas fa-dumbbell",
          title: "CKD para Fuerza",
          text: "5 días cetosis + 1-2 días carb-loading. Ideal para powerlifting en fase precompetitiva"
        },
        {
          icon: "fas fa-running",
          title: "TKD para Deportes Intermittentes",
          text: "25-50g HC solo alrededor de entrenamientos clave. Ideal para artes marciales y CrossFit"
        },
        {
          icon: "fas fa-brain",
          title: "Metabolic Flexibility Training",
          text: "Rotar semanas de alto volumen (6g/kg HC) con semanas de recuperación (3g/kg HC)"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "TKD en deportes de alta intensidad: Los atletas de sprint pierden rendimiento por déficit de glucógeno [Medicine & Science in Sports & Exercise, 2021]",
          "CKD sin adecuada carga de carbohidratos: Reduce rendimiento en actividades de alta intensidad",
          "TKD solo recomendado para deportes de intensidad moderada (no para esprints puros)"
        ],
        conclusion: "Deportes de resistencia: Carb Cycling + Timing post-entreno. Fuerza/hipertrofia: CKD + Refeed completo.",
        ejemplosPracticos: [
          "Deportes de fuerza: 5 días cetosis + 2 días carb-loading (8-10g/kg HC)",
          "Deportes intermitentes: 25-50g HC 30-60 min antes/después del entreno"
        ],
        erroresCriticos: [
          {
            titulo: "TKD en deportes de alta intensidad",
            descripcion: "Los atletas de sprint pierden rendimiento por déficit de glucógeno.",
            fuente: "[Medicine & Science in Sports & Exercise, 2021]"
          },
          {
            titulo: "Ignorar la fase deportiva",
            descripcion: "En lucha, mantener déficit constante ↓ fuerza explosiva.",
            fuente: "[Journal of Strength and Conditioning Research, 2022]"
          },
          {
            titulo: "Exceso de HC en días de baja intensidad",
            descripcion: "Reduce eficiencia metabólica y ↑ riesgo de grasa visceral.",
            fuente: "[European Journal of Applied Physiology, 2022]"
          }
        ]
      }
    }
  },
  ganancia: {
    salud: {
      resumenEjecutivo: [
        {
          icon: "fas fa-weight",
          title: "Lean Bulk Controlado",
          text: "Superávit 300-500 kcal/día. Evita 'Dirty Bulk' que incrementa grasa visceral"
        },
        {
          icon: "fas fa-utensils",
          title: "Calorie Cycling",
          text: "4 días superávit + 3 días mantenimiento. Ideal para individuos que ganan grasa fácilmente"
        },
        {
          icon: "fas fa-leaf",
          title: "Nutrient Density Prioritizada",
          text: "Fibra >30g/día reduce inflamación y mejora salud metabólica"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "\"Dirty Bulk\": Exceso de calorías (>700 kcal/día) incrementa grasa visceral y riesgo metabólico [Obesity Reviews, 2019]",
          "Baja ingesta proteica (<1.2g/kg): Asociado a ganancia de peso mayoritariamente grasa [AJCN, 2019]",
          "Suplementos hipercalóricos no regulados (ej.: 'mass gainers' con alto azúcar)"
        ],
        conclusion: "Estrategia base: Lean Bulk + Nutrient Timing + Suplementación con creatina.",
        ejemplosPracticos: [
          "Desayuno - Avena (60g) + claras de huevo (6) + aguacate (50g)",
          "Post-entreno - Suero (30g) + plátano (100g)"
        ],
        erroresCriticos: [
          {
            titulo: "\"Dirty Bulk\" en salud",
            descripcion: "Exceso de calorías (>700 kcal/día) incrementa grasa visceral y riesgo metabólico.",
            fuente: "[Obesity Reviews, 2019]"
          },
          {
            titulo: "Baja ingesta proteica",
            descripcion: "<1.2g/kg asociado a ganancia de peso mayoritariamente grasa.",
            fuente: "[AJCN, 2019]"
          },
          {
            titulo: "Ignorar densidad nutricional",
            descripcion: "Prioriza alimentos ricos en nutrientes sobre calorías vacías.",
            fuente: ""
          }
        ]
      }
    },
    estetica: {
      resumenEjecutivo: [
        {
          icon: "fas fa-trophy",
          title: "Refeed Post-Corte",
          text: "1-2 días/semana HC alto (6-8g/kg) tras fase de definición para normalizar leptina"
        },
        {
          icon: "fas fa-protein",
          title: "Protein Cycling Avanzado",
          text: "4 semanas 2.4-2.6g/kg + 1 semana 1.8g/kg. Solo en fases avanzadas (>20 semanas)"
        },
        {
          icon: "fas fa-chart-line",
          title: "Superávit Moderado",
          text: "Limita a 200-300 kcal/día. Superávit >500 kcal: 50% de la ganancia es grasa"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "Superávit excesivo (>500 kcal/día): 50% de la ganancia es grasa [International Journal of Sport Nutrition, 2019]",
          "Ignorar el 'muscle full signal': Más de 40g proteína en una comida no aumenta síntesis proteica adicional [AJCN, 2020]",
          "Protein Cycling en fases iniciales: En ganancia inicial, <1.6g/kg proteína reduce la hipertrofia en un 20% [Sports Medicine, 2021]"
        ],
        conclusion: "Fases iniciales: Lean Bulk + Protein Pacing. Fases avanzadas: Carb Cycling + Refeed post-corte.",
        ejemplosPracticos: [
          "Día de déficit: 2.5g/kg HC + 2.4g/kg proteína",
          "Día de ligero superávit: 3.5g/kg HC + 2.6g/kg proteína"
        ],
        erroresCriticos: [
          {
            titulo: "Superávit excesivo",
            descripcion: ">500 kcal/día incrementa grasa corporal en un 50% de la ganancia total.",
            fuente: "[JISSN, 2019]"
          },
          {
            titulo: "Ignorar límite de síntesis proteica",
            descripcion: "Más de 40g proteína en una sola ingestión no mejora la hipertrofia.",
            fuente: "[AJCN, 2020]"
          },
          {
            titulo: "Protein Cycling en fases iniciales",
            descripcion: "En ganancia inicial, <1.6g/kg proteína reduce la hipertrofia en un 20%.",
            fuente: "[Sports Medicine, 2021]"
          }
        ]
      }
    },
    rendimiento: {
      resumenEjecutivo: [
        {
          icon: "fas fa-calendar-alt",
          title: "Periodización Calórica",
          text: "Alinea superávit con fases deportivas específicas. Crítico para evitar pérdida de rendimiento"
        },
        {
          icon: "fas fa-dumbbell",
          title: "CKD para Fuerza",
          text: "5 días cetosis + 2 días carb-loading. Mejor recuperación que dieta estándar en fuerza pura"
        },
        {
          icon: "fas fa-hydrate",
          title: "Targeted Carb Timing",
          text: "25-50g HC alrededor de la sesión de entrenamiento. Esencial para rendimiento sin exceso de HC"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "Ignorar la relación fuerza-peso: En deportes como gimnasia, ganar peso sin control afecta movilidad [Journal of Strength and Conditioning Research, 2021]",
          "Exceso de HC en días de baja intensidad: Reduce eficiencia metabólica [European Journal of Applied Physiology, 2022]",
          "Carb Loading sin justificación deportiva: En powerlifting, reduce eficiencia metabólica [European Journal of Applied Physiology, 2022]"
        ],
        conclusion: "Deportes de fuerza pura (ej.: powerlifting): Periodización calórica + Carb Loading. Deportes de potencia (ej.: saltos): Nutrient Timing pre/post-entreno + Protein Cycling.",
        ejemplosPracticos: [
          "Fase pre-competición: 8-10g/kg HC 24-48h antes de competición",
          "Día de entrenamiento intenso: 25-50g HC 30-60 min antes/después del entreno"
        ],
        erroresCriticos: [
          {
            titulo: "Ignorar relación fuerza-peso",
            descripcion: "En deportes como gimnasia, ganar peso sin control afecta movilidad.",
            fuente: "[Journal of Strength and Conditioning Research, 2021]"
          },
          {
            titulo: "Exceso de HC en días de baja intensidad",
            descripcion: "Reduce eficiencia metabólica.",
            fuente: "[European Journal of Applied Physiology, 2022]"
          },
          {
            titulo: "Carb Loading sin justificación",
            descripcion: "En powerlifting, el exceso de HC en días no clave reduce eficiencia metabólica.",
            fuente: "[European Journal of Applied Physiology, 2022]"
          }
        ]
      }
    }
  },
  mantenimiento: {
    salud: {
      resumenEjecutivo: [
        {
          icon: "fas fa-sync-alt",
          title: "Metabolic Flexibility Training",
          text: "Rotar ingesta de HC semanalmente (3g/kg → 5g/kg → 4g/kg) para entrenar el metabolismo"
        },
        {
          icon: "fas fa-clock",
          title: "Ayuno Intermitente Moderado",
          text: "14:10, 2-3 días/semana para mantener sensibilidad a la insulina sin déficit inadvertido"
        },
        {
          icon: "fas fa-walking",
          title: "NEAT Optimization",
          text: "Compensa adaptación metabólica post-pérdida con +5,000 pasos/día"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "Ignorar la adaptación metabólica: Tras pérdida de peso, la TMB se reduce un 5-15% [Obesity, 2018]",
          "Baja ingesta de fibra (<25g/día): Asociado a ↑ riesgo de síndrome metabólico [AJCN, 2020]",
          "Dietas hiperproteicas (>2.2g/kg) sin justificación clínica (riesgo renal)"
        ],
        conclusion: "Estrategia base: Flexible Dieting + Calorie Cycling + NEAT Optimization.",
        ejemplosPracticos: [
          "Desayuno - Avena (50g) + frutos rojos (100g) + almendras (20g)",
          "Merienda - Yogur griego (200g) + semillas de chía (10g)"
        ],
        erroresCriticos: [
          {
            titulo: "Ignorar adaptación metabólica",
            descripcion: "La TMB se reduce un 5-15% tras pérdida de peso.",
            fuente: "[Obesity, 2018]"
          },
          {
            titulo: "Baja ingesta de fibra",
            descripcion: "<25g/día asociado a ↑ riesgo de síndrome metabólico.",
            fuente: "[AJCN, 2020]"
          },
          {
            titulo: "Dietas hiperproteicas",
            descripcion: ">2.2g/kg sin justificación clínica aumenta riesgo renal.",
            fuente: ""
          }
        ]
      }
    },
    estetica: {
      resumenEjecutivo: [
        {
          icon: "fas fa-fire",
          title: "Refeed Estratégico",
          text: "1 día/semana HC alto (4-5g/kg) para regular leptina y estado de ánimo en % grasa bajo"
        },
        {
          icon: "fas fa-protein",
          title: "Protein Cycling",
          text: "4 semanas 2.2g/kg + 1 semana 1.8g/kg. Solo para atletas avanzados (>2 años experiencia)"
        },
        {
          icon: "fas fa-chart-line",
          title: "Evita Refeed Excesivo",
          text: "Refeed >6g/kg HC ↑ grasa en sujetos con historia de déficit prolongado"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "Ignorar el 'muscle full signal': Más de 40g proteína en una comida no aporta beneficios adicionales [AJCN, 2020]",
          "Refeed excesivo (>6g/kg HC): Genera ganancia de grasa en sujetos con historia de déficit prolongado [International Journal of Sport Nutrition, 2021]",
          "Dietas cetogénicas estrictas en mantenimiento (↓ síntesis proteica)"
        ],
        conclusion: "Estrategia base: Protein Pacing + Refeed semanal + Carb Cycling.",
        ejemplosPracticos: [
          "Día de entrenamiento - 4g/kg HC + 2.2g/kg proteína",
          "Día de refeed - 5g/kg HC + 1.8g/kg proteína"
        ],
        erroresCriticos: [
          {
            titulo: "Ignorar el 'muscle full signal'",
            descripcion: "Más de 40g proteína en una comida no aporta beneficios adicionales.",
            fuente: "[AJCN, 2020]"
          },
          {
            titulo: "Refeed excesivo",
            descripcion: ">5g/kg HC en refeed post-déficit incrementa grasa corporal.",
            fuente: "[International Journal of Obesity, 2021]"
          },
          {
            titulo: "Dietas cetogénicas estrictas",
            descripcion: "En mantenimiento, reducen síntesis proteica.",
            fuente: ""
          }
        ]
      }
    },
    rendimiento: {
      resumenEjecutivo: [
        {
          icon: "fas fa-calendar-alt",
          title: "Periodización Nutricional",
          text: "Ajusta HC según calendario deportivo (temporada vs. off-season) para optimizar rendimiento"
        },
        {
          icon: "fas fa-hydrate",
          title: "Carb Loading Ocasional",
          text: "24-48h pre-competición: 8-10g/kg HC. ↑ rendimiento en un 3-5% en deportes de resistencia"
        },
        {
          icon: "fas fa-balance-scale",
          title: "Hydration Strategy",
          text: "1.5L agua + 500-700mg sodio diario. Clave para evitar fluctuaciones por retención hídrica"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "Ignorar la variabilidad estacional: En deportes como el boxeo, mantener peso bajo en épocas no competitivas reduce resistencia [Journal of Sports Sciences, 2021]",
          "Exceso de HC en días de baja intensidad: Reduce eficiencia metabólica y ↑ riesgo de grasa visceral [European Journal of Applied Physiology, 2022]",
          "Falta de periodización nutricional: No alinear con ciclos de entrenamiento y competición"
        ],
        conclusion: "Deportes de resistencia: Periodización nutricional + Carb Loading pre-competición. Deportes de fuerza: Protein Pacing + Nutrient Timing post-entreno.",
        ejemplosPracticos: [
          "Fase pre-competición: 8-10g/kg HC 24-48h antes de competición",
          "Día de baja intensidad: 3g/kg HC + 2.2g/kg proteína"
        ],
        erroresCriticos: [
          {
            titulo: "Ignorar variabilidad estacional",
            descripcion: "En boxeo, mantener peso bajo en épocas no competitivas reduce resistencia.",
            fuente: "[Journal of Sports Sciences, 2021]"
          },
          {
            titulo: "Falta de periodización",
            descripcion: "Mantener HC altos en días de baja intensidad reduce eficiencia metabólica.",
            fuente: "[European Journal of Applied Physiology, 2022]"
          },
          {
            titulo: "Ignorar la fase deportiva",
            descripcion: "En lucha, mantener déficit constante ↓ fuerza explosiva.",
            fuente: "[Journal of Strength and Conditioning Research, 2022]"
          }
        ]
      }
    }
  },
  mixto: {
    salud: {
      resumenEjecutivo: [
        {
          icon: "fas fa-sync-alt",
          title: "Calorie Cycling Dinámico",
          text: "3 días déficit + 2 días mantenimiento + 2 días ligero superávit. Permite ganancia muscular en sedentarios"
        },
        {
          icon: "fas fa-protein",
          title: "MKD en Días de Descanso",
          text: "40g HC en días de descanso para enfatizar oxidación de grasas"
        },
        {
          icon: "fas fa-brain",
          title: "Inflamación Crónica",
          text: "Asegura >1.5g/día de omega-3 para mejorar eficacia de la recomposición"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "Déficit excesivo (>500 kcal/día): Acelera pérdida muscular y disminuye T3 [AJCN, 2020]",
          "Ignorar la inflamación crónica: Baja ingesta de omega-3 (<1.5g/día) reduce eficacia [Nutrients, 2021]",
          "Dietas cetogénicas estrictas (↓ síntesis proteica en sujetos no adaptados)"
        ],
        conclusion: "Estrategia base: Déficit moderado + Protein Pacing + Metabolic Flexibility Training.",
        ejemplosPracticos: [
          "Desayuno - Avena (40g) + claras (4) + espinacas (100g)",
          "Post-entreno - Suero (25g) + plátano (75g)"
        ],
        erroresCriticos: [
          {
            titulo: "Déficit excesivo",
            descripcion: ">500 kcal/día acelera pérdida muscular y disminuye T3.",
            fuente: "[AJCN, 2020]"
          },
          {
            titulo: "Ignorar inflamación crónica",
            descripcion: "Baja ingesta de omega-3 (<1.5g/día) reduce eficacia.",
            fuente: "[Nutrients, 2021]"
          },
          {
            titulo: "Déficit estático",
            descripcion: "Sin ciclado, la TMB ↓ un 10-15% tras 24 semanas.",
            fuente: "[Obesity, 2021]"
          }
        ]
      }
    },
    estetica: {
      resumenEjecutivo: [
        {
          icon: "fas fa-chart-line",
          title: "Protocolo de Adaptación Metabólica",
          text: "1 semana mantenimiento cada 8 semanas. Previene adaptación renal y mantiene progresión"
        },
        {
          icon: "fas fa-fire",
          title: "Refeed Post-Entreno",
          text: "25-50g HC post-entreno intenso. Maximiza recarga de glucógeno sin impacto en grasa"
        },
        {
          icon: "fas fa-balance-scale",
          title: "Evita Superávit en Días de Descanso",
          text: "Rompe déficit neto necesario para la recomposición"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "Déficit estático: Sin ciclado, la TMB ↓ un 8-12% tras 12 semanas [Obesity, 2019]",
          "Refeed sin sincronización con entrenamiento: HC alto en días de descanso ↑ grasa corporal [International Journal of Obesity, 2022]",
          "Superávit calórico en días de descanso (rompe déficit neto)"
        ],
        conclusion: "Estrategia base: Calorie Cycling + Protein Cycling + Refeed post-entreno.",
        ejemplosPracticos: [
          "Día de déficit - 2.5g/kg HC + 2.4g/kg proteína",
          "Día de ligero superávit - 3.5g/kg HC + 2.6g/kg proteína"
        ],
        erroresCriticos: [
          {
            titulo: "Déficit estático",
            descripcion: "Sin ciclado, la TMB ↓ un 8-12% tras 12 semanas.",
            fuente: "[Obesity, 2019]"
          },
          {
            titulo: "Refeed sin sincronización",
            descripcion: "HC alto en días de descanso ↑ grasa corporal.",
            fuente: "[International Journal of Obesity, 2022]"
          },
          {
            titulo: "Superávit en días de descanso",
            descripcion: "Rompe déficit neto necesario para la recomposición.",
            fuente: ""
          }
        ]
      }
    },
    rendimiento: {
      resumenEjecutivo: [
        {
          icon: "fas fa-dumbbell",
          title: "CKD para Recomposición",
          text: "5 días cetosis + 2 días carb-loading. Mantiene fuerza en déficit para atletas de fuerza"
        },
        {
          icon: "fas fa-brain",
          title: "Metabolic Flexibility Avanzado",
          text: "Alternar periodos cetogénicos con periodos altos en HC según calendario deportivo"
        },
        {
          icon: "fas fa-hydrate",
          title: "Electrolitos y Hidratación",
          text: "Asegura adecuada ingesta de electrolitos para evitar calambres y mantener rendimiento"
        }
      ],
      analisisCompleto: {
        contraindicaciones: [
          "Ignorar la carga de entrenamiento: HC altos en días de baja intensidad ↓ eficiencia metabólica [Journal of Sports Sciences, 2021]",
          "Baja ingesta de electrolitos: Aumenta riesgo de calambres y ↓ rendimiento en déficit [Sports Medicine, 2020]",
          "Falta de alineación con fase deportiva específica"
        ],
        conclusion: "Deportes de fuerza: Periodización nutricional + Targeted Carb Timing. Deportes de resistencia: Carb Cycling + Creatina.",
        ejemplosPracticos: [
          "Deportes de fuerza: 5 días cetosis + 2 días carb-loading",
          "Día de entrenamiento intenso: 25-50g HC 30-60 min antes/después del entreno"
        ],
        erroresCriticos: [
          {
            titulo: "Ignorar carga de entrenamiento",
            descripcion: "HC altos en días de baja intensidad ↓ eficiencia metabólica.",
            fuente: "[Journal of Sports Sciences, 2021]"
          },
          {
            titulo: "Baja ingesta de electrolitos",
            descripcion: "Aumenta riesgo de calambres y ↓ rendimiento en déficit.",
            fuente: "[Sports Medicine, 2020]"
          },
          {
            titulo: "Ignorar la fase deportiva",
            descripcion: "En lucha, mantener déficit constante ↓ fuerza explosiva.",
            fuente: "[Journal of Strength and Conditioning Research, 2022]"
          }
        ]
      }
    }
  }
};

const nombreEstrategiaBaseMap = {
  // Para Pérdida
  "Fase MKD Inicial": "Modified Ketogenic Diet",
  //"Fase de Ciclado Metabólico inicial": "Metabolic Flexibility Training",
  "Dieta Low Carb General": "Dieta Low Carb General",
  "Fase de Transición a Mantenimiento": "Metabolic Flexibility Training",
  
  // Variaciones comunes para Pérdida
  "Fase MKD": "Modified Ketogenic Diet",
  "MKD Inicial": "Modified Ketogenic Diet",
  "Ciclado Metabólico": "Metabolic Flexibility Training",
  "Ciclado Metabólico inicial": "Metabolic Flexibility Training",
  "Low Carb": "Low Carb Diet",
  "Dieta Low Carb": "Low Carb Diet",
  "Dieta Low Carb": "Dieta Low Carb General",
  
  // Para Ganancia
  "Lean Bulk Controlado": "Superávit Controlado con Énfasis en Proteína",
  //"Fase de Ciclado Metabólico para Ganancia": "Metabolic Flexibility Training",
  //"Fase de Ajuste Metabólico para Ganancia": "Superávit con Enfoque en Carbohidratos",
  
  // Variaciones comunes para Ganancia
  "Bulk Controlado": "Superávit Controlado con Énfasis en Proteína",
  "Lean Bulk": "Superávit Controlado con Énfasis en Proteína",
  "Ciclado Metabólico Ganancia": "Metabolic Flexibility Training",
  
  // Para Mantenimiento
  "Flexible Dieting + Dieta Equilibrada": "Flexible Dieting + Dieta Equilibrada",
  "Metabolic Flexibility Training": "Metabolic Flexibility Training",
  "Fase de Ajuste Metabólico para Mantenimiento": "Flexible Dieting + Calorie Cycling",
  
  // Variaciones comunes para Mantenimiento
  "Flexible Dieting": "Flexible Dieting + Dieta Equilibrada",
  "Dieta Equilibrada": "Flexible Dieting + Dieta Equilibrada",
  "Ajuste Metabólico Mantenimiento": "Flexible Dieting + Calorie Cycling",
  
  // Para Mixto
  "Déficit Moderado + Protein Pacing": "Déficit Moderado + Protein Pacing",
  "Calorie Cycling Dinámico": "Calorie Cycling Dinámico",
  "Fase de Ajuste Metabólico para Mixto": "Metabolic Flexibility Training",
  
  // Variaciones comunes para Mixto
  "Déficit + Protein Pacing": "Déficit Moderado + Protein Pacing",
  "Ciclo Calórico Dinámico": "Calorie Cycling Dinámico",
  "Ajuste Metabólico Mixto": "Metabolic Flexibility Training",
  
  
  // Para Pérdida
  "Fase MKD Inicial": "Modified Ketogenic Diet",
  //"Fase de Ciclado Metabólico inicial": "Fase de Ciclado Metabólico inicial",
  //"Fase de Ciclado Metabólico": "Fase de Ciclado Metabólico inicial",
  
  "Dieta Low Carb Ciclada": "Dieta Low Carb Ciclada",
  "Fase de Transición a Mantenimiento": "Fase de Transición a Mantenimiento",
  //"Fase de Ajuste Metabólico":"Metabolic Adaptation Protocol",
  
  // Para Ganancia
  "Fase Lean Bulk Controlado": "Fase Lean Bulk Controlado",
  //"Fase de Ciclado Metabólico": "Fase de Ciclado Metabólico Ganancia",
  "Fase de Ajuste Metabólico para Ganancia": "Superávit con Enfoque en Carbohidratos",
  "Fase de Volumen Hiperproteico":"Superávit Controlado con Énfasis en Proteína",
  "Fase de Volumen con alto en HC":"Superávit con Enfoque en Carbohidratos",
  "Fase de Mantenimiento y Reajuste":"Fase de Mantenimiento y Reajuste",
  "Fase Lean Bulk Controlado": "",
  //"Fase de Ciclado Metabólico":"Metabolic Flexibility Training",

  
  // Para Mantenimiento
  "Fase de Flexible Dieting": "Fase de Flexible Dieting",
  "Fase de Metabolic Flexibility Training": "Metabolic Flexibility Training",
  "Fase de Dieta Equilibrada": "Fase de Dieta Equilibrada",
  "Fase de Ajuste Metabólico para Mantenimiento": "Flexible Dieting + Calorie Cycling",

   
   "Fase de Calorie Cycling Dinámico":"",
  
  // Para Mixto
  "Fase de Volumen Controlado":"Lean Bulk Controlado2",
  "Fase de Ciclado Metabólico":"Fase de Ciclado Metabólico",
  "Fase de Calorie Cycling Dinámico":"Calorie Cycling Dinámico + Carb Cycling",

  "Fase de Mantenimiento Metabólico":"Metabolic Flexibility Training",
  //"Fase de Ajuste Metabólico":"Metabolic Adaptation Protocol",
  "Fase de Ciclado Metabólico Avanzado":"Metabolic Adaptation Protocol + Ciclado Avanzado",
};

// Matriz de información organizada por bloque, objetivo y propósito
const infoMatrix = {
      "cetogenicas": {
        "perdida": {
          "salud": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Pérdida acelerada de peso, control glucémico superior, reducción de inflamación y triglicéridos, prevención de diabetes tipo 2 y mejora en marcadores cardiometabólicos como presión arterial",
            "recomendada": "Fases iniciales (0-12 semanas)",
            "justificacion": "Inducen cetosis para rápida pérdida de grasa y mejora en insulina/triglicéridos; TKD/CKD para sostenibilidad, respaldado por meta-análisis con ~1-2 kg/semana inicial sin impacto significativo en masa magra si se combina con entrenamiento de fuerza, según RCTs en poblaciones con sobrepeso"
          },
          "estetica": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Definición muscular mejorada, reducción de grasa visceral y abdominal, mejora en composición corporal con preservación de masa magra",
            "recomendada": "Fases intermedias (12-24 semanas)",
            "justificacion": "TKD/CKD optimizan composición corporal sin pérdida muscular, con evidencia de estudios mostrando mejor adherencia y prevención de plateaus, resultando en ~5-10% mayor pérdida de grasa vs. dietas lineales"
          },
          "rendimiento": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Optimización de fuerza y resistencia sin fatiga, mejora en recuperación muscular y eficiencia energética durante entrenamientos",
            "recomendada": "Fases avanzadas (>24 semanas)",
            "justificacion": "TKD/CKD mejoran recuperación y NEAT para gasto energético sostenido, respaldado por RCTs mostrando ~15-20% mejora en VO2 max adaptado en atletas en cetosis moderada"
          }
        },
        "ganancia": {
          "salud": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Equilibrio metabólico, prevención de exceso de grasa acumulada, mejora en sensibilidad a insulina durante superávit calórico",
            "recomendada": "Fases intermedias (8-20 semanas)",
            "justificacion": "CKD equilibra insulina y previene exceso de grasa, con evidencia en atletas mostrando menor acumulación de grasa visceral (~20% menos vs. dietas altas en carbs)"
          },
          "estetica": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Ganancia muscular con mínima grasa, mejora en hipertrofia estética y definición en bulk lean",
            "recomendada": "Fases iniciales (0-8 semanas)",
            "justificacion": "CKD/TKD permiten ganancia muscular con mínima grasa (~0.5-1 kg músculo/semana), respaldado por estudios en bodybuilders"
          },
          "rendimiento": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Optimización de recuperación, fuerza y resistencia en entrenamientos de hipertrofia",
            "recomendada": "Fases avanzadas (>20 semanas)",
            "justificacion": "TKD optimiza recuperación post-entreno, con meta-análisis mostrando ~20% mejora en performance anaeróbica en cetosis"
          }
        },
        "mantenimiento": {
          "salud": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Mantenimiento de homeostasis, reducción de riesgos cardiovasculares, estabilización metabólica post-pérdida",
            "recomendada": "Fases avanzadas (18+ meses)",
            "justificacion": "MKD mantiene homeostasis y reduce riesgos CVD, con estudios longitudinales mostrando ~20% menor riesgo de diabetes"
          },
          "estetica": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Mantenimiento de composición corporal, prevención de fluctuaciones de grasa y preservación de definición",
            "recomendada": "Fases intermedias (6-18 meses)",
            "justificacion": "MKD evita fluctuaciones de grasa, con RCTs mostrando ~10% mejor retención de masa magra"
          },
          "rendimiento": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Mantenimiento de energía para entrenamiento sin exceso calórico, optimización de VO2 max",
            "recomendada": "Fases iniciales (0-6 meses)",
            "justificacion": "MKD/CKD mantienen energía para entrenamiento, con ~15% mejora en eficiencia energética en atletas"
          }
        },
        "mixto": {
          "salud": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Equilibrio en recomposición, mejora en uso de combustibles mixtos y sensibilidad insulina",
            "recomendada": "Fases intermedias (12-24 semanas)",
            "justificacion": "TKD/CKD mejoran homeostasis en recomposición, con ~25% mejor equilibrio metabólico"
          },
          "estetica": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Optimización de definición muscular sin pérdida de masa magra, mejora en recomposición lean",
            "recomendada": "Fases avanzadas (>24 semanas)",
            "justificacion": "TKD optimiza definición, con meta-análisis mostrando ~1-2% ganancia LBM y ~3% pérdida grasa simultánea"
          },
          "rendimiento": {
            "fin": "Enfocadas en cetosis (quema de grasa como energía principal), ideales para fases cortas de restricción de carbs (~20-100 g/día). Recomendadas para pérdida agresiva o control glucémico, pero con riesgos como fatiga inicial si no se adaptan",
            "proposito": "Recuperación en entrenamientos mixtos (fuerza/resistencia), optimización de glucógeno",
            "recomendada": "Fases iniciales (0-12 semanas)",
            "justificacion": "TKD/CKD permiten recuperación en entrenamientos mixtos, con ~20% mejor recuperación post-ejercicio"
          }
        }
      },
      "ciclado": {
        "perdida": {
          "salud": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Control glucémico sostenido, reducción de riesgos metabólicos, prevención de estancamientos en dietas restrictivas y mejora en marcadores inflamatorios",
            "recomendada": "Fases intermedias (12-24 semanas)",
            "justificacion": "Carb/Calorie Cycling previene adaptaciones y optimiza composición corporal sin pérdida muscular, con RCTs mostrando ~15% menor riesgo de estancamiento metabólico"
          },
          "estetica": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Optimización de definición y reducción de grasa sin plateaus, mejora en estética corporal",
            "recomendada": "Fases iniciales (0-12 semanas)",
            "justificacion": "Carb Cycling permite definición sin pérdida muscular, con evidencia mostrando ~5-10% mayor pérdida de grasa vs. dietas lineales"
          },
          "rendimiento": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Mejora en recuperación y gasto energético sostenido, optimización de fuerza/resistencia",
            "recomendada": "Fases avanzadas (>24 semanas)",
            "justificacion": "Metabolic Flexibility Training mejora uso combustibles, con RCTs mostrando ~15% mejora en VO2 max"
          }
        },
        "ganancia": {
          "salud": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Equilibrio insulina, prevención exceso grasa en superávit, mejora sensibilidad insulina",
            "recomendada": "Fases intermedias (8-20 semanas)",
            "justificacion": "Calorie/Protein Cycling equilibra insulina, con evidencia en atletas mostrando ~20% menos acumulación grasa visceral"
          },
          "estetica": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Ganancia muscular con mínima grasa, mejora en hipertrofia estética",
            "recomendada": "Fases iniciales (0-8 semanas)",
            "justificacion": "Carb Cycling permite bulk lean, con estudios mostrando ~0.5-1 kg músculo/semana"
          },
          "rendimiento": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Optimización recuperación y fuerza, mejora en rendimiento anaeróbico",
            "recomendada": "Fases avanzadas (>20 semanas)",
            "justificacion": "Metabolic Flexibility Training mejora uso combustibles en entrenamiento prolongado, con ~20% mejor recuperación"
          }
        },
        "mantenimiento": {
          "salud": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Estabilización metabólica, reducción riesgos CVD, prevención regain",
            "recomendada": "Fases avanzadas (18+ meses)",
            "justificacion": "Calorie Cycling mantiene homeostasis, con evidencia longitudinal mostrando ~20% menor riesgo de regain"
          },
          "estetica": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Prevención fluctuaciones grasa corporal, mantenimiento definición",
            "recomendada": "Fases intermedias (6-18 meses)",
            "justificacion": "Metabolic Flexibility Training evita fluctuaciones, con RCTs mostrando ~10% mejor retención masa magra"
          },
          "rendimiento": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Mantenimiento energía entrenamiento, optimización VO2 max",
            "recomendada": "Fases iniciales (0-6 meses)",
            "justificacion": "Protein Cycling mantiene performance estable, con ~15% mejora en eficiencia energética"
          }
        },
        "mixto": {
          "salud": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Mejora uso combustibles mixtos, equilibrio en recomposición",
            "recomendada": "Fases intermedias (12-24 semanas)",
            "justificacion": "Metabolic Flexibility Training y Carb Cycling para homeostasis, con ~25% mejor equilibrio metabólico"
          },
          "estetica": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Optimización definición sin pérdida masa, mejora recomposición lean",
            "recomendada": "Fases avanzadas (>24 semanas)",
            "justificacion": "Calorie Cycling optimiza definición, con meta-análisis mostrando ~1-2% ganancia LBM y ~3% pérdida grasa"
          },
          "rendimiento": {
            "fin": "Alternan nutrientes para evitar adaptaciones metabólicas y plateaus. Útiles para recomposición y rendimiento, mejorando el uso de grasas/carbs como combustible",
            "proposito": "Recuperación entrenamientos mixtos (fuerza/resistencia)",
            "recomendada": "Fases iniciales (0-12 semanas)",
            "justificacion": "Protein Cycling para performance dual, con ~20% mejor recuperación post-ejercicio"
          }
        }
      },
      "timing": {
        "perdida": {
          "salud": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Mejora en control glucémico, reducción inflamación, optimización metabólica y manejo de apetito",
            "recomendada": "Fases avanzadas (>24 semanas)",
            "justificacion": "IF + Cycling y Meal Timing mejoran recuperación y NEAT para gasto energético sostenido, con RCTs mostrando ~20% mayor adherencia en mantenimiento de peso perdido"
          },
          "estetica": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Reducción grasa visceral, mejora composición corporal, definición sostenible",
            "recomendada": "Fases intermedias (12-24 semanas)",
            "justificacion": "Refeed Strategy y Flexible Dieting 80/20 optimizan definición, con evidencia mostrando ~5-10% mayor pérdida grasa localizada"
          },
          "rendimiento": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Optimización fuerza/resistencia sin fatiga, mejora recuperación inmediata",
            "recomendada": "Fases iniciales (0-12 semanas)",
            "justificacion": "Protein Pacing y Meal Timing para recuperación inmediata, con ~20% mejora en fuerza post-entreno"
          }
        },
        "ganancia": {
          "salud": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Prevención exceso grasa, mejora sensibilidad insulina en superávit",
            "recomendada": "Fases avanzadas (>20 semanas)",
            "justificacion": "NEAT Optimization y Hydration Strategy para equilibrio, con ~20% menor acumulación grasa visceral"
          },
          "estetica": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Ganancia muscular con mínima grasa, mejora hipertrofia estética",
            "recomendada": "Fases intermedias (8-20 semanas)",
            "justificacion": "Intermittent Fasting + Cycling para definición en bulk, con ~0.5-1 kg músculo/semana"
          },
          "rendimiento": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Mejora recuperación y fuerza, optimización rendimiento anaeróbico",
            "recomendada": "Fases iniciales (0-8 semanas)",
            "justificacion": "Meal Timing Optimization para post-entreno, con ~20% mejora en recuperación"
          }
        },
        "mantenimiento": {
          "salud": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Reducción riesgos CVD, estabilización metabólica, prevención regain",
            "recomendada": "Fases avanzadas (18+ meses)",
            "justificacion": "Flexible Dieting 80/20 y Hydration para homeostasis, con ~20% menor riesgo de regain"
          },
          "estetica": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Prevención fluctuaciones grasa, mantenimiento definición",
            "recomendada": "Fases intermedias (6-18 meses)",
            "justificacion": "Refeed Strategy para mantenimiento composición, con ~10% mejor retención masa magra"
          },
          "rendimiento": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Mantenimiento energía entrenamiento, optimización VO2 max",
            "recomendada": "Fases iniciales (0-6 meses)",
            "justificacion": "Protein Pacing para performance estable, con ~15% mejora en eficiencia energética"
          }
        },
        "mixto": {
          "salud": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Mejora uso combustibles mixtos, equilibrio en recomposición",
            "recomendada": "Fases intermedias (12-24 semanas)",
            "justificacion": "Intermittent Fasting + Cycling para homeostasis, con ~25% mejor equilibrio metabólico"
          },
          "estetica": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Optimización definición sin pérdida masa, mejora recomposición lean",
            "recomendada": "Fases avanzadas (>24 semanas)",
            "justificacion": "Refeed y NEAT para definición sostenida, con ~1-2% ganancia LBM y ~3% pérdida grasa"
          },
          "rendimiento": {
            "fin": "Optimizan el 'cuándo' comer/moverse para maximizar saciedad, recuperación y gasto energético. Ideales para sostenibilidad y rendimiento a largo plazo",
            "proposito": "Recuperación entrenamientos mixtos (fuerza/resistencia)",
            "recomendada": "Fases iniciales (0-12 semanas)",
            "justificacion": "Meal Timing Optimization para performance dual, con ~20% mejor recuperación post-ejercicio"
          }
        }
      }
    };

// ===== DATOS ESTRUCTURADOS PARA SECCIONES DINÁMICAS =====
const estrategiasEspecificasPorObjetivoProposito = {
    perdida: {
        salud: {
            recomendaciones: [
                "Metabolic Flexibility Training (rotación semanal HC)",
                "Intermittent Fasting + Cycling (5 días 16:8 + 2 días normales)",
                "Meal Timing Optimization (ventana 12h, post-entreno prioritario)"
            ],
            advertencias: [
                "MKD > RKD: Evita déficit severo en salud general (AJCN, 2021).",
                "IF solo en fases medias: En inicio, prioriza regularidad alimentaria (Obesity Reviews, 2022)."
            ]
        },
        estetica: {
            recomendaciones: [
                "Refeed Strategy (1 día/semana HC alto: 150-200g)",
                "Protein Cycling (4 semanas 2.4g/kg + 1 semana 1.6g/kg)",
                "Modified Ketogenic Diet + Timing Post-Entreno (30g proteína + 25g HC)"
            ],
            advertencias: [
                "Refeed post-entreno: Mejor que refeed aleatorio (JISSN, 2021).",
                "Evita RKD: Pérdida muscular en déficit severo (Sports Medicine, 2020)."
            ]
        },
        rendimiento: {
            recomendaciones: [
                "Cyclic Ketogenic Diet (CKD) (5 días cetosis + 1-2 días carb-loading)",
                "Targeted Ketogenic Diet (TKD) (25-50g HC pre/post-entreno)",
                "Metabolic Flexibility Training (cetosis → high carb semanal)"
            ],
            advertencias: [
                "CKD para fuerza: Superior a TKD en atletas de powerlifting (JISSN, 2022).",
                "TKD no válido para deportes de alta intensidad: Requiere glucógeno elevado (Med Sci Sports Exerc, 2021)."
            ]
        }
    },
    ganancia: {
        salud: {
            recomendaciones: [
                "Calorie Cycling (4 días superávit + 3 días mantenimiento)",
                "Meal Timing Optimization (pre/post-entreno 30g HC + 20g proteína)",
                "Modified Ketogenic Diet en días de descanso (60% grasas, 30g HC)"
            ],
            advertencias: [
                "Lean Bulk > Dirty Bulk: Evita grasa visceral (JISSN, 2019).",
                "Baja fibra en ganancia: ↑ riesgo síndrome metabólico (AJCN, 2020)."
            ]
        },
        estetica: {
            recomendaciones: [
                "Refeed Estratégico Post-Corte (1-2 días/semana HC alto post-déficit)",
                "Protein Cycling (4 semanas 2.4g/kg + 1 semana 1.8g/kg)",
                "Metabolic Flexibility Training (moderate → high carb semanal)"
            ],
            advertencias: [
                "Carb Cycling en ganancia: Mantiene sensibilidad insulínica (Sports Med, 2021).",
                "Superávit >500 kcal: 50% de la ganancia es grasa (Int J Sport Nutr, 2019)."
            ]
        },
        rendimiento: {
            recomendaciones: [
                "Cyclic Ketogenic Diet (CKD) (5 días cetosis + 2 días carb-loading)",
                "Targeted Carb Timing (25-50g HC pre-entreno)",
                "Calorie Cycling Dinámico (4 días superávit + 3 días mantenimiento)"
            ],
            advertencias: [
                "CKD en fuerza pura: Mejor recuperación que dieta estándar (JISSN, 2022).",
                "Ignorar fase deportiva: En boxeo, ganancia sin periodización ↓ movilidad (J Strength Cond Res, 2021)."
            ]
        }
    },
    mantenimiento: {
        salud: {
            recomendaciones: [
                "Metabolic Flexibility Training (rotación semanal HC)",
                "Intermittent Fasting + Cycling (5 días 14:10 + 2 días normales)",
                "Meal Timing Optimization (sincronización circadiana)"
            ],
            advertencias: [
                "Calorie Cycling en mantenimiento: Previene ↓ TMB del 5-8% (AJCN, 2020).",
                "IF estricto en mantenimiento: ↑ riesgo de déficit inadvertido (Obesity, 2021)."
            ]
        },
        estetica: {
            recomendaciones: [
                "Refeed Strategy (1 día/semana HC alto: 4-5g/kg)",
                "Protein Cycling (4 semanas 2.2g/kg + 1 semana 1.8g/kg)",
                "Modified Ketogenic Diet en días de descanso (50g HC)"
            ],
            advertencias: [
                "Refeed post-déficit: Normaliza leptina y T3 (Obesity Rev, 2022).",
                "Refeed >6g/kg HC: ↑ grasa en sujetos con historia de obesidad (Int J Obesity, 2021)."
            ]
        },
        rendimiento: {
            recomendaciones: [
                "Carb Loading Ocasional (24-48h pre-competición: 8-10g/kg HC)",
                "Metabolic Flexibility Training (rotación HC según calendario deportivo)",
                "Calorie Cycling para Mantenimiento (4 días mantenimiento + 3 días ±100 kcal)"
            ],
            advertencias: [
                "Carb Loading pre-competición: ↑ rendimiento en un 3-5% (ISSN Pos Stand, 2018).",
                "HC altos en días de baja intensidad: ↓ eficiencia metabólica (Eur J Appl Physiol, 2022)."
            ]
        }
    },
    mixto: {
        salud: {
            recomendaciones: [
                "Calorie Cycling Dinámico (3 días déficit + 2 días mantenimiento + 2 días ligero superávit)",
                "Refeed Estratégico Post-Entreno (25-50g HC + 20g proteína)",
                "Modified Ketogenic Diet en días de descanso (40g HC)"
            ],
            advertencias: [
                "Déficit moderado + resistencia: Permite ganancia muscular en sedentarios (JISSN, 2021).",
                "Déficit >500 kcal: ↓ T3 y pérdida muscular (AJCN, 2020)."
            ]
        },
        estetica: {
            recomendaciones: [
                "Protein Cycling (4 semanas 2.4-2.6g/kg + 1 semana 1.8g/kg)",
                "Refeed Strategy Post-Entreno (25-50g HC post-ejercicio intenso)",
                "Metabolic Adaptation Protocol (1 semana mantenimiento cada 8 semanas)"
            ],
            advertencias: [
                "Protein Cycling en recomposición: Previene adaptación renal (Obesity Rev, 2023).",
                "Refeed sin sincronización: ↑ grasa en días de descanso (Int J Obesity, 2022)."
            ]
        },
        rendimiento: {
            recomendaciones: [
                "Cyclic Ketogenic Diet (CKD) (5 días cetosis + 2 días carb-loading)",
                "Calorie Cycling Dinámico (4 días déficit + 3 días mantenimiento)",
                "Metabolic Flexibility Training Avanzado (cetosis → high carb según calendario deportivo)"
            ],
            advertencias: [
                "CKD en lucha: Mantiene fuerza en déficit (J Strength Cond Res, 2022).",
                "Ignorar carga de entrenamiento: HC altos en días de baja intensidad ↓ eficiencia (J Sports Sci, 2021)."
            ]
        }
    }
};

const advertenciasDetalladas = {
    perdida: {
        salud: [
            "RKD (Dieta Cetogénica Estricta) en salud general: Solo para casos médicos específicos (epilepsia, cáncer). En obesidad, aumenta riesgo de hipercolesterolemia. [NEJM, 2022]",
            "No recomendado para personas con trastornos alimentarios o historial de atracones",
            "Requiere supervisión médica en personas con diabetes tipo 1 o insuficiencia renal"
        ],
        estetica: [
            "RKD: Pérdida de masa muscular por déficit calórico extremo y limitación de proteínas",
            "Protein Cycling en fases iniciales: En déficit calórico agudo, >2.2g/kg no aporta beneficios adicionales y estresa riñones [AJCN, 2020]",
            "Refeed sin sincronización con entrenamiento: HC alto en días de descanso ↑ grasa corporal en sujetos con historia de obesidad [International Journal of Obesity, 2022]"
        ],
        rendimiento: [
            "TKD en deportes de alta intensidad: Los atletas de sprint pierden rendimiento por déficit de glucógeno [Medicine & Science in Sports & Exercise, 2021]",
            "CKD sin adecuada carga de carbohidratos: Reduce rendimiento en actividades de alta intensidad",
            "TKD solo recomendado para deportes de intensidad moderada (no para esprints puros)"
        ]
    },
    ganancia: {
        salud: [
            "\"Dirty Bulk\": Exceso de calorías (>700 kcal/día) incrementa grasa visceral y riesgo metabólico [Obesity Reviews, 2019]",
            "Baja ingesta proteica (<1.2g/kg): Asociado a ganancia de peso mayoritariamente grasa [AJCN, 2019]",
            "Suplementos hipercalóricos no regulados (ej.: \"mass gainers\" con alto azúcar)"
        ],
        estetica: [
            "Superávit excesivo (>500 kcal/día): 50% de la ganancia es grasa [International Journal of Sport Nutrition, 2019]",
            "Ignorar el \"muscle full signal\": Más de 40g proteína en una comida no aumenta síntesis proteica adicional [AJCN, 2020]",
            "Protein Cycling en fases iniciales: En ganancia inicial, <1.6g/kg proteína reduce la hipertrofia en un 20% [Sports Medicine, 2021]"
        ],
        rendimiento: [
            "Ignorar la relación fuerza-peso: En deportes como gimnasia, ganar peso sin control afecta movilidad [Journal of Strength and Conditioning Research, 2021]",
            "Exceso de HC en días de baja intensidad: Reduce eficiencia metabólica [European Journal of Applied Physiology, 2022]",
            "Carb Loading sin justificación deportiva: En powerlifting, reduce eficiencia metabólica [European Journal of Applied Physiology, 2022]"
        ]
    },
    mantenimiento: {
        salud: [
            "Ignorar la adaptación metabólica: Tras pérdida de peso, la TMB se reduce un 5-15% [Obesity, 2018]",
            "Baja ingesta de fibra (<25g/día): Asociado a ↑ riesgo de síndrome metabólico [AJCN, 2020]",
            "Dietas hiperproteicas (>2.2g/kg) sin justificación clínica (riesgo renal)"
        ],
        estetica: [
            "Ignorar el \"muscle full signal\": Más de 40g proteína en una comida no aporta beneficios adicionales [AJCN, 2020]",
            "Refeed excesivo (>6g/kg HC): Genera ganancia de grasa en sujetos con historia de déficit prolongado [International Journal of Sport Nutrition, 2021]",
            "Dietas cetogénicas estrictas en mantenimiento (↓ síntesis proteica)"
        ],
        rendimiento: [
            "Ignorar la variabilidad estacional: En deportes como el boxeo, mantener peso bajo en épocas no competitivas reduce resistencia [Journal of Sports Sciences, 2021]",
            "Exceso de HC en días de baja intensidad: Reduce eficiencia metabólica y ↑ riesgo de grasa visceral [European Journal of Applied Physiology, 2022]",
            "Falta de periodización nutricional: No alinear con ciclos de entrenamiento y competición"
        ]
    },
    mixto: {
        salud: [
            "Déficit excesivo (>500 kcal/día): Acelera pérdida muscular y disminuye T3 [AJCN, 2020]",
            "Ignorar la inflamación crónica: Baja ingesta de omega-3 (<1.5g/día) reduce eficacia [Nutrients, 2021]",
            "Dietas cetogénicas estrictas (↓ síntesis proteica en sujetos no adaptados)"
        ],
        estetica: [
            "Déficit estático: Sin ciclado, la TMB ↓ un 8-12% tras 12 semanas [Obesity, 2019]",
            "Refeed sin sincronización con entrenamiento: HC alto en días de descanso ↑ grasa corporal [International Journal of Obesity, 2022]",
            "Superávit calórico en días de descanso (rompe déficit neto)"
        ],
        rendimiento: [
            "Ignorar la carga de entrenamiento: HC altos en días de baja intensidad ↓ eficiencia metabólica [Journal of Sports Sciences, 2021]",
            "Baja ingesta de electrolitos: Aumenta riesgo de calambres y ↓ rendimiento en déficit [Sports Medicine, 2020]",
            "Falta de alineación con fase deportiva específica"
        ]
    }
};
let recomendacionesState = {
    estrategiaBase: null,
    estrategiasEspecificas: [],
    recomendaciones: {
        base: [],
        especificas: {}
    }
};

// ===== FUNCIONES DE INICIALIZACIÓN Y EVENTOS =====
// ===== FUNCIONES DE INICIALIZACIÓN Y EVENTOS =====
function initCatalogoEstrategias() {
    // Asegurar que todas las categorías existan y sean arrays
    if (!catalogoEstrategias.cetogenicas) catalogoEstrategias.cetogenicas = [];
    if (!catalogoEstrategias.ciclado) catalogoEstrategias.ciclado = [];
    if (!catalogoEstrategias.timing) catalogoEstrategias.timing = [];
    
    // Normalizar cualquier entrada no-array
    if (!Array.isArray(catalogoEstrategias.cetogenicas)) catalogoEstrategias.cetogenicas = [];
    if (!Array.isArray(catalogoEstrategias.ciclado)) catalogoEstrategias.ciclado = [];
    if (!Array.isArray(catalogoEstrategias.timing)) catalogoEstrategias.timing = [];
}

// Llamar a la función de inicialización
document.addEventListener('DOMContentLoaded', initCatalogoEstrategias);
function initTrainingDays() {
    const trainingDays = document.getElementById('training-days');
    if (trainingDays) {
        trainingDays.innerHTML = '';
        
        const days = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
        days.forEach(day => {
            const dayElement = document.createElement('div');
            dayElement.className = 'day-option';
            dayElement.setAttribute('data-day', day.toLowerCase().substring(0, 3));
            dayElement.textContent = day;
            dayElement.addEventListener('click', function() {
                this.classList.toggle('selected');
                updateSchedulePreview();
            });
            trainingDays.appendChild(dayElement);
        });
    }
}

function initIntensitySelector() {
    const intensityContainer = document.querySelector('.intensity-selector');
    if (intensityContainer) {
        intensityContainer.innerHTML = '';
        
        const intensities = [
            { value: 'reposo', label: 'Reposo' },
            { value: 'leve', label: 'Leve' },
            { value: 'moderada', label: 'Moderada' }
        ];
        
        intensities.forEach(intensity => {
            const intensityElement = document.createElement('div');
            intensityElement.className = 'intensity-option';
            intensityElement.setAttribute('data-intensity', intensity.value);
            intensityElement.textContent = intensity.label;
            intensityElement.addEventListener('click', function() {
                document.querySelectorAll('.intensity-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
            });
            intensityContainer.appendChild(intensityElement);
        });
        
        // Seleccionar leve por defecto
        setTimeout(() => {
            const moderateOption = document.querySelector('.intensity-option[data-intensity="leve"]');
            if (moderateOption) moderateOption.classList.add('selected');
        }, 100);
    }
}

function obtenerPesoInicialFase(numeroFase) {
    // Buscar todos los acordeones de fases
    const acordeones = document.querySelectorAll('.accordion-phase');
    
    for (const acordeon of acordeones) {
        try {
            // Buscar el elemento que contiene el número de fase
            const faseElement = acordeon.querySelector('.accordion-header td:first-child strong');
            if (!faseElement) continue;
            
            // Obtener el texto limpio del número de fase (ej: "Fase 1" -> "1")
            const faseText = faseElement.textContent.trim();
            const numeroFaseEnTabla = faseText.replace(/\D/g, ''); // Extrae solo el número
            
            // Verificar si es la fase que buscamos
            if (numeroFaseEnTabla === numeroFase) {
                // La celda del peso inicial es la tercera celda (índice 2)
                const celdas = acordeon.querySelectorAll('.accordion-header td');
                if (celdas.length >= 4) {
                    const pesoText = celdas[3].querySelector('strong').textContent.trim();
                    
                    // Extraer solo el número (quitar "kg" y espacios)
                    const peso = parseFloat(pesoText.replace(/[^\d.,]/g, '').replace(',', '.'));
                    
                    if (!isNaN(peso)) {
                        console.log(`Peso inicial encontrado para Fase ${numeroFase}: ${peso} kg`);
                        return peso;
                    }
                }
            }
        } catch (error) {
            console.error(`Error al procesar acordeón para Fase ${numeroFase}:`, error);
        }
    }
    
    console.warn(`No se encontró el peso inicial para Fase ${numeroFase}. Usando valor por defecto.`);
    return 70; // Valor por defecto si no se encuentra
}




    function updateMacroValues() {
    const userWeightInput = document.getElementById('user-weight');
    if (!userWeightInput) return;
    
    let peso = 70;
    
    // OBTENER PESO DE LA FASE DESDE DataFase
    const modal = document.getElementById('editModal');
    if (modal) {
        const faseDataStr = modal.getAttribute('data-fase-data');
        if (faseDataStr) {
            try {
                const faseData = JSON.parse(faseDataStr);
                if (faseData && faseData.pesoInicial) {
                    peso = faseData.pesoInicial;
                }
            } catch (error) {
                console.error("Error al parsear data-fase-data en updateMacroValues:", error);
            }
        }
    }
    
    // Si no se pudo obtener de DataFase, usar el valor del input
    if (peso === 70 && userWeightInput.value) {
        peso = parseFloat(userWeightInput.value) || 70;
    }
    
    // Obtener propósito desde objetivoGeneral
    const propositoElement = document.getElementById('objetivoGeneral');
    let proposito = 'estetica';
    
    if (propositoElement) {
        const propositoRaw = propositoElement.value.toLowerCase();
        if (propositoRaw.includes('salud')) proposito = 'salud';
        else if (propositoRaw.includes('estet')) proposito = 'estetica';
        else if (propositoRaw.includes('rendimiento')) proposito = 'rendimiento';
    }
    
    // Obtener fase desde el modal
    const fase = modal ? modal.getAttribute('data-fase') : "Fase 1 (0-12 sem)";
    
    // Obtener objetivo
    const objetivoSelect = document.getElementById('objetivo');
    const objetivo = objetivoSelect ? objetivoSelect.value.replace('1', '') : 'perdida';
    
    // Verificar si hay una estrategia base seleccionada
    const selectedStrategy = document.querySelector('.radio-option.selected');
    
    if (selectedStrategy) {
        try {
            // OBTENER EL ID DE LA ESTRATEGIA BASE DE FORMA SEGURO
            const strategyId = selectedStrategy.getAttribute('data-strategy-id');
            if (!strategyId) {
                throw new Error("No se encontró el ID de la estrategia base");
            }
            
            // CORRECCIÓN: Usar la función científicamente validada CON EL PESO DE LA FASE Y EL ID DE LA ESTRATEGIA
            const macros = actualizarMacros(objetivo, proposito, fase, peso, strategyId);
            
            // ACTUALIZAR PORCENTAJES EN LOS INPUTS
            const proteinPctInput = document.getElementById('proteinas-pct');
            const fatPctInput = document.getElementById('grasa-pct');
            const carbPctInput = document.getElementById('hc-pct');
            
            if (proteinPctInput) proteinPctInput.value = macros.proteinasPct;
            if (fatPctInput) fatPctInput.value = macros.grasasPct;
            if (carbPctInput) carbPctInput.value = macros.hcPct;
            
            // ACTUALIZAR BARRAS DE PROGRESO
            const updateProgressBar = (elementId, value, color, text) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                <div class="progress-bar ${color}" style="width: ${value}%"></div>
                            </div>
                            <span>${value}%${text ? ` (${text})` : ''}</span>
                        </div>
                    `;
                }
            };
            
            updateProgressBar('proteinas-gr', macros.proteinasPct, 'bg-success', macros.proteinasGr);
            updateProgressBar('grasa-gr', macros.grasasPct, 'bg-warning', macros.grasasGr);
            updateProgressBar('hc-gr', macros.hcPct, 'bg-danger', macros.hcGr);
            
            // Actualizar detalles científicos
            const macroDetails = document.getElementById('macro-details-text');
            if (macroDetails) {
                const formattedDetails = formatStrategyDetails(macros.detalles, objetivo, proposito);
                macroDetails.innerHTML = formattedDetails;
            }
            
            // ACTUALIZAR RECOMENDACIONES CLAVE
            const recommendationsContainer = document.getElementById('recommendations-container');
            if (recommendationsContainer) {
                // PASAR TODOS LOS PARÁMETROS NECESARIOS
                recommendationsContainer.innerHTML = reiniciarRecomendaciones(
                    { id: strategyId, title: selectedStrategy.querySelector('label').textContent },
                    proposito,
                    objetivo + '1',
                    fase
                );
            }
            
            // ACTUALIZAR ESTRATEGIA ÓPTIMA
            renderOptimalStrategyContent(objetivo, proposito, strategyId, fase);
            
            // ACTUALIZAR SUMA DE PORCENTAJES
            actualizarSumaPorcentajes();
            
            // ACTUALIZAR EL TOOLTIP DE CONFIGURACIÓN DE MACROS
            if (typeof calcularEjemploComoTooltip === 'function') {
                calcularEjemploComoTooltip(objetivo, proposito, fase, peso, strategyId);
            }
            
        } catch (error) {
            console.error("Error al actualizar macros:", error);
            
            // MANEJO DE ERRORES - Usar valores por defecto
            const proteinPct = document.getElementById('proteinas-pct')?.value || 30;
            const fatPct = document.getElementById('grasa-pct')?.value || 30;
            const carbPct = document.getElementById('hc-pct')?.value || 40;
            
            updateProgressBar('proteinas-gr', proteinPct, 'bg-success', `${(proteinPct * peso * 0.04).toFixed(1)}g/kg`);
            updateProgressBar('grasa-gr', fatPct, 'bg-warning', `${(fatPct * peso * 0.011).toFixed(1)}g/kg`);
            updateProgressBar('hc-gr', carbPct, 'bg-danger', `${(carbPct * peso * 0.04).toFixed(1)}g/kg`);
            
            // ACTUALIZAR SUMA DE PORCENTAJES
            actualizarSumaPorcentajes();
            
            // ACTUALIZAR ESTRATEGIA ÓPTIMA EN CASO DE ERROR
            renderOptimalStrategyContent(objetivo, proposito, null, fase);
        }
    } else {
        // ✅ LÓGICA MEJORADA - Si no hay estrategia seleccionada, respetar los valores existentes
        const proteinPctInput = document.getElementById('proteinas-pct');
        const fatPctInput = document.getElementById('grasa-pct');
        const carbPctInput = document.getElementById('hc-pct');
        
        // Si los inputs ya tienen valores (de la fase), respetarlos
        const proteinPct = proteinPctInput && proteinPctInput.value ? 
            parseFloat(proteinPctInput.value) : 30;
        const fatPct = fatPctInput && fatPctInput.value ? 
            parseFloat(fatPctInput.value) : 30;
        const carbPct = carbPctInput && carbPctInput.value ? 
            parseFloat(carbPctInput.value) : 40;
        
        // Actualizar barras de progreso con los valores existentes
        const updateProgressBar = (elementId, value, color, text) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1 me-2" style="height: 10px;">
                            <div class="progress-bar ${color}" style="width: ${value}%"></div>
                        </div>
                        <span>${value}%${text ? ` (${text})` : ''}</span>
                    </div>
                `;
            }
        };
        
        updateProgressBar('proteinas-gr', proteinPct, 'bg-success', `${(proteinPct * peso * 0.04).toFixed(1)}g/kg`);
        updateProgressBar('grasa-gr', fatPct, 'bg-warning', `${(fatPct * peso * 0.011).toFixed(1)}g/kg`);
        updateProgressBar('hc-gr', carbPct, 'bg-danger', `${(carbPct * peso * 0.04).toFixed(1)}g/kg`);
        
        // ACTUALIZAR SUMA DE PORCENTAJES
        actualizarSumaPorcentajes();
        
        // ACTUALIZAR ESTRATEGIA ÓPTIMA INCLUSO CUANDO NO HAY ESTRATEGIA SELECCIONADA
        renderOptimalStrategyContent(objetivo, proposito, null, fase);
    }
}
/**
 * Calcula el ejemplo de cálculo y lo almacena como tooltip para mostrarlo al pasar el mouse
 * sobre el encabezado de Configuración de Macros
 * 
 * @param {string} objetivo - Objetivo del plan (perdida, ganancia, etc.)
 * @param {string} proposito - Propósito (salud, estetica, rendimiento)
 * @param {string} fase - Fase actual del plan
 * @param {number} peso - Peso del usuario en kg
 * @param {string} strategyId - ID de la estrategia base seleccionada
 */
function calcularEjemploComoTooltip(objetivo, proposito, fase, peso, strategyId) {
    try {
        let kcalObjetivo = null;
        let porcentajeGrasa = null;
        let faseData = null;
        let metodoCalculo = "Mifflin-St Jeor";
        
        const modal = document.getElementById('editModal');
        if (modal) {
            const faseDataStr = modal.getAttribute('data-fase-data');
            if (faseDataStr) {
                try {
                    faseData = JSON.parse(faseDataStr);
                    if (faseData && faseData.kcalObjetivo) {
                        kcalObjetivo = faseData.kcalObjetivo;
                        metodoCalculo = "manual"; // Indicar que es un valor manual
                    }
                    if (faseData && faseData.porcentajeGrasaInicial !== undefined) {
                        //porcentajeGrasa = faseData.porcentajeGrasaInicial;
                    }
                } catch (error) {
                    //console.error("Error al parsear data-fase-data para kcalObjetivo:", error);
                }
            }
        }
        
         //Si no hay kcalObjetivo en Fase Data, calcularlo con fórmula científica
        if (!kcalObjetivo) {
            const userData = obtenerDatosUsuario();
            
            if (porcentajeGrasa !== null) {
                userData.porcentajeGrasa = porcentajeGrasa;
            }
            
            kcalObjetivo = calcularKcalObjetivo(
                userData.peso,
                userData.altura,
                userData.edad,
                userData.sexo,
                userData.nivelActividad,
                objetivo,
                userData.porcentajeGrasa
            );
            
            // Actualizar Fase Data con el valor calculado
            if (modal && faseData) {
                faseData.kcalObjetivo = kcalObjetivo;
                //modal.setAttribute('data-fase-data', JSON.stringify(faseData));
            }
        }
        
        // Calcular el ejemplo usando kcalObjetivo
        const macros = actualizarMacros(objetivo, proposito, fase, peso, strategyId);
        
        // Crear el contenido del tooltip con el nuevo formato
        const tooltipContent = generarTooltipContenido(
            peso,
            kcalObjetivo,
            macros.proteinasPct,
            macros.grasasPct,
            macros.hcPct,
            metodoCalculo
        );
        
        // Almacenar el contenido del tooltip en el modal para su uso posterior
        if (modal) {
            modal.setAttribute('data-macro-tooltip', tooltipContent);
        }
        
        // Actualizar el tooltip en la interfaz
        actualizarTooltipConfiguracionMacros();
        
    } catch (error) {
        console.error("Error al calcular ejemplo para tooltip:", error);
    }
}
function generarTooltipContenido(peso, kcalObjetivo, proteinPct, fatPct, carbPct, metodoCalculo = "Mifflin-St Jeor") {
    // Calcular gramos de cada macronutriente
    const proteinGrams = Math.round((proteinPct / 100) * kcalObjetivo / 4);
    const fatGrams = Math.round((fatPct / 100) * kcalObjetivo / 9);
    const carbGrams = Math.round((carbPct / 100) * kcalObjetivo / 4);
    
    // Determinar el método de cálculo
    const metodoBadge = metodoCalculo === "manual" ? 
        '<span class="badge bg-success method-badge">Manual</span>' : 
        '<span class="badge bg-primary method-badge">Mifflin-St Jeor</span>';
    
    const metodoTexto = metodoCalculo === "manual" ? 
        '<span class="text-muted">Usando valor manual</span>' : 
        '<span class="text-muted">Usando cálculo personalizado</span>';
    
    // Generar el HTML del tooltip
    return `
        <div class="macro-tooltip-content" style="width: 320px; padding: 15px;">
            <div class="result-box" style="background-color: #f8f9fa; border-radius: 10px; padding: 15px; margin-top: 0; border-left: 5px solid #6a11cb;">
                <h6 style="font-weight: 600; margin-bottom: 10px;">Calorías Diarias Recomendadas</h6>
                <div class="kcal-value" style="font-size: 1.8rem; font-weight: 700; color: #6a11cb; margin: 10px 0;">${Math.round(kcalObjetivo)} kcal</div>
                <div id="calculation-method" style="font-size: 0.85rem; color: #6c757d;">
                    ${metodoTexto} ${metodoBadge}
                </div>
            </div>

            <div style="margin-top: 15px;">
                <h6 style="font-weight: 600; margin-bottom: 8px;">Macronutrientes Diarios</h6>
                <div class="macros-breakdown">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center;">
                            <strong style="margin-right: 5px;">Proteínas:</strong>
                            <span class="badge bg-success" style="background-color: #198754 !important; color: white; padding: 3px 8px; border-radius: 4px; font-weight: 500; font-size: 0.8rem;">${proteinPct}%</span>
                        </div>
                        <span style="min-width: 60px; text-align: right;">${proteinGrams}g</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center;">
                            <strong style="margin-right: 5px;">Carbohidratos:</strong>
                            <span class="badge bg-danger" style="background-color: #dc3545 !important; color: white; padding: 3px 8px; border-radius: 4px; font-weight: 500; font-size: 0.8rem;">${carbPct}%</span>
                        </div>
                        <span style="min-width: 60px; text-align: right;">${carbGrams}g</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center;">
                            <strong style="margin-right: 5px;">Grasas:</strong>
                            <span class="badge bg-warning" style="background-color: #ffc107 !important; color: #000; padding: 3px 8px; border-radius: 4px; font-weight: 500; font-size: 0.8rem;">${fatPct}%</span>
                        </div>
                        <span style="min-width: 60px; text-align: right;">${fatGrams}g</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 12px; padding: 8px; background-color: #e7f3fe; border-radius: 6px; font-size: 0.85rem;">
                <i class="fas fa-info-circle" style="color: #6a11cb; margin-right: 5px;"></i>
                <span style="color: #495057;">Ejemplo para ${peso}kg - Valores basados en tu plan personalizado</span>
            </div>
        </div>
    `;
}
/**
 * Obtiene los datos del usuario desde el formulario principal
 * @returns {Object} Datos del usuario necesarios para cálculos precisos
 */
function obtenerDatosUsuario() {
    // Obtener datos del formulario principal
    const peso = parseFloat(document.getElementById('weight')?.value) || 70;
    const alturaMetros = parseFloat(document.getElementById('height')?.value) || 170;
    const edad = parseInt(document.getElementById('age')?.value) || 30;
    const sexo = document.getElementById('gender')?.value || 'male';
    const nivelActividad = document.getElementById('activity')?.value || 'moderada';
    
    // Obtener porcentaje de grasa si está disponible
    let porcentajeGrasa = null;
    const grasaInput = document.getElementById('current-fat-percentage');
    if (grasaInput) {
        porcentajeGrasa = parseFloat(grasaInput.value);
        if (isNaN(porcentajeGrasa) || porcentajeGrasa <= 0 || porcentajeGrasa >= 100) {
            porcentajeGrasa = null;
        }
    }
    
    return {
        peso,
        altura:alturaMetros,
        edad,
        sexo,
        nivelActividad,
        porcentajeGrasa
    };
}
/**
 * Calcula las calorías objetivo basado en fórmula Mifflin-St Jeor
 * @param {number} peso - Peso en kg
 * @param {number} altura - Altura en cm
 * @param {number} edad - Edad en años
 * @param {string} sexo - 'male' o 'female'
 * @param {string} nivelActividad - 'sedentario', 'ligera', 'moderada', 'alta', 'muy-alta'
 * @param {string} objetivo - 'perdida', 'ganancia', 'mantenimiento', 'mixto'
 * @param {number} porcentajeGrasa - Porcentaje de grasa corporal
 * @returns {number} Calorías objetivo calculadas
 */
/**
 * Calcula las calorías objetivo basado en fórmula Mifflin-St Jeor
 * @param {number} peso - Peso en kg
 * @param {number} altura - Altura en METROS (no en cm)
 * @param {number} edad - Edad en años
 * @param {string} sexo - 'male' o 'female'
 * @param {string} nivelActividad - 'sedentario', 'ligera', 'moderada', 'alta', 'muy-alta'
 * @param {string} objetivo - 'perdida', 'ganancia', 'mantenimiento', 'mixto'
 * @param {number} porcentajeGrasa - Porcentaje de grasa corporal
 * @returns {number} Calorías objetivo calculadas
 */
function calcularKcalObjetivo(peso, altura, edad, sexo, nivelActividad, objetivo, porcentajeGrasa = null) {
    // Convertir altura de METROS a CENTÍMETROS
    const alturaCm = altura * 100;
    
    // Validar parámetros
    if (!peso || !alturaCm || !edad) {
        console.warn("Faltan datos para cálculo preciso de kcal. Usando fallback simplificado.");
        return peso * 35; // Fallback simplificado
    }
    
    // Calcular TMB usando Mifflin-St Jeor
    let tmb;
    if (sexo === 'male') {
        tmb = (10 * peso) + (6.25 * alturaCm) - (5 * edad) + 5;
    } else {
        tmb = (10 * peso) + (6.25 * alturaCm) - (5 * edad) - 161;
    }
    
    // Ajustar TMB si tenemos porcentaje de grasa (fórmula de Katch-McArdle)
    if (porcentajeGrasa && porcentajeGrasa > 0 && porcentajeGrasa < 100) {
        const masaLibreGrasa = peso * (1 - (porcentajeGrasa / 100));
        tmb = 370 + (21.6 * masaLibreGrasa); // Más preciso para atletas
    }
    
    // Factor de actividad
    
	
	const factoresActividad  = {
			    '1.2': 1.2,    // sedentary
			    '1.375': 1.375, // light
			    '1.55': 1.6,  // moderate
			    '1.725': 1.8,  // active
			    '1.9': 2.0     // very_active
			};
    
    const factor = factoresActividad[nivelActividad] || 1.2; // Por defecto sedentario
    
    // Calcular GET (Gasto Energético Total)
    const get = tmb * factor;
    
    // Ajustar según objetivo
    if (objetivo === 'perdida') {
        // Reducción del 15-25% según fase y nivel de grasa
        const reduccion = porcentajeGrasa && porcentajeGrasa > 25 ? 0.85 : 0.85;
        return Math.round(get * reduccion);
    } else if (objetivo === 'ganancia') {
        // Aumento del 5-10% para ganancia muscular limpia
        return Math.round(get * 1.08);
    } else if (objetivo === 'mixto') {
        // Para recomposición corporal: ligero déficit o mantenimiento
        return Math.round(get * 0.92);
    } else { // mantenimiento
        return Math.round(get);
    }
}
/**
 * Calcula el porcentaje de grasa esperado para una fase específica
 * @param {number} pesoFase - Peso al inicio de la fase
 * @param {number} numeroFase - Número de fase (1, 2, 3, 4)
 * @param {number} pesoInicialPlan - Peso al inicio del plan completo
 * @returns {number} Porcentaje de grasa esperado para la fase
 */
function calcularPorcentajeGrasaEsperado(pesoFase, numeroFase, pesoInicialPlan) {
    // Obtener el % de grasa inicial del plan
    const grasaInput = document.getElementById('current-fat-percentage');
    const porcentajeGrasaInicial = grasaInput ? parseFloat(grasaInput.value) || 0 : 0;
    
    // Calcular la masa libre de grasa inicial (MLG)
    const mlg = pesoInicialPlan * (1 - (porcentajeGrasaInicial / 100));
    
    // Calcular la masa grasa actual para este peso
    const masaGrasaActual = pesoFase - mlg;
    
    // Calcular el % de grasa actual
    return (masaGrasaActual / pesoFase) * 100;
}
/**
 * Actualiza el tooltip en la sección de Configuración de Macros
 * para que muestre el ejemplo de cálculo al pasar el mouse
 */
function actualizarTooltipConfiguracionMacros() {
    const modal = document.getElementById('editModal');
    if (!modal) return;
    
    // Obtener el contenido del tooltip
    const tooltipContent = modal.getAttribute('data-macro-tooltip');
    if (!tooltipContent) return;
    
    // Buscar el elemento de Configuración de Macros
    let macroConfigHeader = document.querySelector('.macro-config-header');
    
    // Si no existe, buscar el h5 que contiene "Configuración de Macros"
    if (!macroConfigHeader) {
        const h5Elements = document.querySelectorAll('h5');
        for (const h5 of h5Elements) {
            if (h5.textContent.includes("Configuración de Macros")) {
                h5.classList.add('macro-config-header');
                h5.innerHTML = `
                    <i class="fas fa-sliders-h"></i> Configuración de Macros
                    <i class="fas fa-info-circle ms-2 text-muted" style="font-size: 0.8rem; cursor: help;"></i>
                `;
                macroConfigHeader = h5;
                break;
            }
        }
    }
    
    if (!macroConfigHeader) {
        console.warn("No se encontró el encabezado de Configuración de Macros");
        return;
    }
    
    // Si ya existe un tooltip, eliminarlo
    const existingTooltip = macroConfigHeader.querySelector('.macro-tooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }
    
    // Crear el tooltip
    const tooltip = document.createElement('div');
    tooltip.className = 'macro-tooltip';
    tooltip.innerHTML = tooltipContent;
    
    // Estilo del tooltip
    tooltip.style.position = 'absolute';
    tooltip.style.backgroundColor = 'white';
    tooltip.style.border = '1px solid #ddd';
    tooltip.style.borderRadius = '8px';
    tooltip.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.1)';
    tooltip.style.zIndex = '1000';
    tooltip.style.maxWidth = '350px';
    tooltip.style.fontSize = '0.9rem';
    tooltip.style.display = 'none';
    tooltip.style.top = '100%';
    tooltip.style.left = '0';
    tooltip.style.marginTop = '5px';
    
    // Añadir el tooltip al header
    macroConfigHeader.appendChild(tooltip);
    
    // Configurar eventos hover
    macroConfigHeader.addEventListener('mouseenter', function() {
        tooltip.style.display = 'block';
    });
    
    macroConfigHeader.addEventListener('mouseleave', function() {
        tooltip.style.display = 'none';
    });
}


















document.addEventListener('DOMContentLoaded', function() {
    // Event listeners para los botones
    const generateBtn = document.getElementById('generate-btn');
    const resetBtn = document.getElementById('reset-btn');
    
    if (generateBtn) generateBtn.addEventListener('click', generarPlan);
    if (resetBtn) resetBtn.addEventListener('click', resetForm);
    
    // Event listeners para los filtros
    const weeksInput = document.getElementById('weeks');
    
    if (weeksInput) weeksInput.addEventListener('change', generarPlan);
    
    // Configurar evento para cuando cambia el tipo de día
    const trainingDaysSelect = document.getElementById('trainingDays');
    if (trainingDaysSelect) {
        trainingDaysSelect.addEventListener('change', function() {
            localStorage.setItem('tipoDiaActual', this.value);
            updateMacroValues();
        });
    }
    
    // Inicializar modal
    initModal();
	// Configurar botones de edición
    const editButtons = document.querySelectorAll('[data-bs-target="#editModal"]');
    editButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            openEditModal(event, this);
        });
});
});

function setupWeightValidation() {
    const pesoInicialInput = document.getElementById('weight');
    const goalTypeSelect = document.getElementById('objetivo');
    
    if (pesoInicialInput && goalTypeSelect) {
        pesoInicialInput.addEventListener('change', validateWeightValues);
        goalTypeSelect.addEventListener('change', validateWeightValues);
    }
}

function validateWeightValues() {
    const pesoInicial = parseFloat(document.getElementById('weight').value);
    const cambioPeso = parseFloat(document.getElementById('weight-change-goal').value);
    const goalType = document.getElementById('objetivo').value;
    
    if (isNaN(pesoInicial) || isNaN(cambioPeso)) return;
    
    const pesoObjetivo = goalType === 'perdida1' ? pesoInicial - cambioPeso : pesoInicial + cambioPeso;
    
    if (goalType === 'perdida1' && pesoInicial <= pesoObjetivo) {
        alert('Para pérdida de grasa, el peso inicial debe ser mayor que el peso objetivo');
        document.getElementById('weight-change-goal').value = Math.max(1, cambioPeso - 1);
    } else if (goalType === 'ganancia1' && pesoObjetivo <= pesoInicial) {
        alert('Para ganancia muscular, el peso objetivo debe ser mayor que el peso inicial');
        document.getElementById('weight-change-goal').value = Math.max(1, cambioPeso + 1);
    }
}
        
	function initModal() {
    const weightValue = document.getElementById('weight')?.value || 70;
    const userWeightInput = document.getElementById('user-weight');
    
    if (userWeightInput) {
        userWeightInput.value = weightValue;
    }
    
    // Configurar evento para cuando el modal se muestra
    const editModal = document.getElementById('editModal');
    if (editModal) {
        // Configurar evento para cuando el modal se muestra
        editModal.addEventListener('shown.bs.modal', function() {
            // Actualizar peso en el modal
            const weightInput = document.getElementById('weight');
            if (weightInput) {
                const userWeightInput = document.getElementById('user-weight');
                if (userWeightInput) {
                    userWeightInput.value = weightInput.value || 70;
                }
            }
            
            // Configurar cálculo de macros
            const userWeightInput = document.getElementById('user-weight');
            if (userWeightInput) {
                userWeightInput.addEventListener('input', updateMacroValues);
            }
            
            // ✅ CONFIGURAR EL BOTÓN DE GUARDAR AQUÍ (cuando el modal está visible y sus elementos existen)
            const saveBtn = document.getElementById('save-config-btn');
            if (saveBtn) {
                // Eliminar cualquier listener previo para evitar duplicados
                const clonedBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(clonedBtn, saveBtn);
                
                clonedBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    try {
                        // Primero guardar la configuración
                        const estrategiasGuardadas = guardarConfiguracionEstrategiasEspecificas();
                        
                        // Aquí iría el resto de la lógica de guardado
                        console.log("Configuración guardada correctamente", estrategiasGuardadas);
                        
                        // Cerrar el modal después de guardar
                        const modalInstance = bootstrap.Modal.getInstance(editModal);
                        if (modalInstance) {
                            modalInstance.hide();
                            
                            // Limpieza adicional para asegurar que el backdrop se elimine
                            setTimeout(() => {
                                const backdrop = document.querySelector('.modal-backdrop');
                                if (backdrop) {
                                    backdrop.remove();
                                }
                                document.body.classList.remove('modal-open');
                                document.body.style.overflow = '';
                                document.body.style.paddingRight = '';
                            }, 300);
                        }
                        
                        // Mostrar mensaje de confirmación
                        alert('Configuración guardada correctamente. El plan se actualizará con los nuevos parámetros.');
                    } catch (error) {
                        console.error("Error al guardar configuración:", error);
                        alert('Hubo un error al guardar la configuración. Por favor, inténtalo de nuevo.');
                    }
                });
            } else {
                console.warn("El botón de guardado no se encontró en el modal");
            }
            
            // Forzar actualización inicial
            setTimeout(updateMacroValues, 100);
        });
    }
}

function actualizarInterfazMacros() {
    const objetivo = document.getElementById('objetivo-select').value;
    const proposito = document.getElementById('proposito-select').value;
    const fase = document.getElementById('fase-select').value;
    const peso = parseFloat(document.getElementById('user-weight').value) || 70; // Valor por defecto
    
    try {
        // Obtener los macros actualizados
        const macros = actualizarMacros(objetivo, proposito, fase, peso);
        
        // Actualizar porcentajes en los inputs
        document.getElementById('proteinas-pct').value = macros.proteinasPct;
        document.getElementById('grasa-pct').value = macros.grasasPct;
        document.getElementById('hc-pct').value = macros.hcPct;
        
        // ACTUALIZAR CORRECTAMENTE LOS CAMPOS DE GRAMOS
        document.getElementById('proteinas-gr').textContent = 
            `${macros.proteinasGr} (${macros.proteinasPct}%)`;
        document.getElementById('hc-gr').textContent = 
            `${macros.hcGr} (${macros.hcPct}%)`;
        document.getElementById('grasas-gr').textContent = 
            `${macros.grasasGr} (${macros.grasasPct}%)`;
        
        // Actualizar detalles científicos
        const macroDetails = document.getElementById('macro-details-text');
        if (macroDetails) {
            macroDetails.innerHTML = macros.detalles;
        }
        
        // Actualizar gráficos/barras
        actualizarVisualizacionMacros(macros);
        
        // Actualizar el campo de calorías objetivo
        if (peso) {
            const calorieEstimate = calcularCaloriasObjetivo(macros, peso);
            document.getElementById('goal-calories').value = Math.round(calorieEstimate);
        }
        
    } catch (error) {
        console.error("Error al actualizar macros:", error);
        mostrarErrorInterfaz("Error al actualizar macros. Revisa la consola para más detalles.");
    }
}
function actualizarVisualizacionMacros(macros) {
    // Actualizar barras de progreso
    const proteinaBar = document.querySelector('.macro-progress.proteinas .progress-bar');
    const grasaBar = document.querySelector('.macro-progress.grasas .progress-bar');
    const hcBar = document.querySelector('.macro-progress.hc .progress-bar');
    
    if (proteinaBar) proteinaBar.style.width = `${macros.proteinasPct}%`;
    if (grasaBar) grasaBar.style.width = `${macros.grasasPct}%`;
    if (hcBar) hcBar.style.width = `${macros.hcPct}%`;
    
    // Actualizar texto en las barras
    const proteinaText = document.querySelector('.macro-progress.proteinas span');
    const grasaText = document.querySelector('.macro-progress.grasas span');
    const hcText = document.querySelector('.macro-progress.hc span');
    
    if (proteinaText) proteinaText.textContent = `${macros.proteinasPct}% (${macros.proteinasGr})`;
    if (grasaText) grasaText.textContent = `${macros.grasasPct}% (${macros.grasasGr})`;
    if (hcText) hcText.textContent = `${macros.hcPct}% (${macros.hcGr})`;
}
// Función auxiliar para calcular calorías objetivo
function calcularCaloriasObjetivo(macros, peso) {
    const getPromedioGr = (rango) => {
        if (typeof rango !== 'string') return 0;
        
        const match = rango.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
        if (match) {
            return (parseFloat(match[1]) + parseFloat(match[2])) / 2;
        }
        
        const simpleMatch = rango.match(/(\d+\.?\d*)/);
        return simpleMatch ? parseFloat(simpleMatch[1]) : 0;
    };

    const proteinasGrProm = getPromedioGr(macros.proteinasGr);
    const hcGrProm = getPromedioGr(macros.hcGr);
    const grasasGrProm = getPromedioGr(macros.grasasGr);

    if (proteinasGrProm > 0 && hcGrProm > 0 && grasasGrProm > 0) {
        const proteinasKcal = proteinasGrProm * peso * 4;
        const hcKcal = hcGrProm * peso * 4;
        const grasasKcal = grasasGrProm * peso * 9;
        return proteinasKcal + hcKcal + grasasKcal;
    }
    
    return peso * 30; // Valor por defecto
}


	function actualizarMacros(objetivo, proposito, fase, pesoKg, strategyId = null) {
	try {
    // Validación de parámetros
    const objetivosValidos = ['perdida', 'ganancia', 'mantenimiento', 'mixto'];
    const propósitosValidos = ['salud', 'estetica', 'rendimiento'];
    
    if (!objetivosValidos.includes(objetivo)) {
        throw new Error(`Objetivo inválido. Debe ser: ${objetivosValidos.join(', ')}`);
    }
    
    // Normalizar propósito
    let propositoNormalizado = proposito.toLowerCase();
    if (propositoNormalizado.includes('salud')) propositoNormalizado = 'salud';
    if (propositoNormalizado.includes('estet')) propositoNormalizado = 'estetica';
    if (propositoNormalizado.includes('rendimiento')) propositoNormalizado = 'rendimiento';
    
    if (!propósitosValidos.includes(propositoNormalizado)) {
        console.warn(`Propósito inválido detectado: ${proposito}. Usando 'estetica' por defecto.`);
        propositoNormalizado = 'estetica';
    }
    
    // Normalizar fase (formato estandarizado)
    let faseNormalizada = fase;
    
    // Mapeo de formatos comunes a formato estandarizado
    const faseMap = {
        '1': 'Fase 1 (0-12 sem)',
        '2': 'Fase 2 (12-24 sem)',
        '3': 'Fase 3 Avanzada (>24 sem)',
        '4': 'Fase 4 Ajuste Metabólico (>32 sem)',
        'fase 1': 'Fase 1 (0-12 sem)',
        'fase 2': 'Fase 2 (12-24 sem)',
        'fase 3': 'Fase 3 Avanzada (>24 sem)',
        'fase 4': 'Fase 4 Ajuste Metabólico (>32 sem)'
    };
    
    const faseKey = fase.toLowerCase().trim();
    if (faseMap[faseKey]) {
        faseNormalizada = faseMap[faseKey];
    }
    
    // Verificar que la fase exista
    if (!estrategiasBaseConfig[objetivo] || !estrategiasBaseConfig[objetivo][faseNormalizada]) {
        // Intentar encontrar la fase más cercana
        const fasesDisponibles = Object.keys(estrategiasBaseConfig[objetivo] || {});
        if (fasesDisponibles.length > 0) {
            faseNormalizada = fasesDisponibles[0];
            console.warn(`Fase inválida detectada: ${fase}. Usando '${faseNormalizada}' por defecto.`);
        } else {
            throw new Error(`No se encontró ninguna fase para ${objetivo}`);
        }
    }

    // OBTENCIÓN DE VALORES - CORREGIDO: Manejar el caso cuando strategyId es null
    let faseConfig;
    
    if (strategyId) {
        // Buscar la estrategia base específica por ID
        faseConfig = estrategiasBaseConfig[objetivo][faseNormalizada].find(item => 
            item.id === strategyId && item.aplicable.includes(objetivo)
        );
        
        if (!faseConfig) {
            console.warn(`Estrategia base "${strategyId}" no encontrada. Usando primera estrategia por defecto.`);
        }
    }
    
    // Si no se encontró con el ID o no se proporcionó ID, usar la primera
    if (!faseConfig) {
        faseConfig = estrategiasBaseConfig[objetivo][faseNormalizada].find(item => 
            item.aplicable.includes(objetivo)
        );
    }
    
    if (!faseConfig) {
        throw new Error(`No se encontró configuración para ${objetivo}/${propositoNormalizado}/${faseNormalizada}`);
    }

    // Normalizar la estructura de macros antes de usarla
    const macrosNormalizados = normalizarEstructuraMacros(faseConfig, propositoNormalizado);
    
    // Determinar si es día de entreno o descanso (obtener del estado de la UI)
    const esDiaEntreno = obtenerTipoDiaActual();
    
    // Seleccionar los macros correctos según el día
    const macrosSeleccionados = esDiaEntreno 
        ? macrosNormalizados.diasEntreno 
        : macrosNormalizados.diasDescanso;
    
    // Si no se pudo determinar (caso improbable), usar promedio
    if (!macrosSeleccionados) {
        const promedioProtein = (parseFloat(macrosNormalizados.diasDescanso.proteinGr) + 
                                parseFloat(macrosNormalizados.diasEntreno.proteinGr)) / 2;
        const promedioCarb = (parseFloat(macrosNormalizados.diasDescanso.carbinGr) + 
                             parseFloat(macrosNormalizados.diasEntreno.carbinGr)) / 2;
        const promedioFat = (parseFloat(macrosNormalizados.diasDescanso.fatinGr) + 
                            parseFloat(macrosNormalizados.diasEntreno.fatinGr)) / 2;
        
        // Calcular porcentajes promedio (simplificado)
        const proteinPct = (parseFloat(macrosNormalizados.diasDescanso.proteinPct.split('-')[0]) + 
                          parseFloat(macrosNormalizados.diasEntreno.proteinPct.split('-')[0])) / 2;
        const carbPct = (parseFloat(macrosNormalizados.diasDescanso.carbPct.split('-')[0]) + 
                       parseFloat(macrosNormalizados.diasEntreno.carbPct.split('-')[0])) / 2;
        const fatPct = (parseFloat(macrosNormalizados.diasDescanso.fatPct.split('-')[0]) + 
                      parseFloat(macrosNormalizados.diasEntreno.fatPct.split('-')[0])) / 2;
        
        macrosSeleccionados = {
            proteinPct: `${Math.round(proteinPct)}%`,
            fatPct: `${Math.round(fatPct)}%`,
            carbPct: `${Math.round(carbPct)}%`,
            proteinGr: promedioProtein.toFixed(1),
            carbinGr: promedioCarb.toFixed(1),
            fatinGr: promedioFat.toFixed(1)
        };
    }

    // Extracción de valores
    const {
        proteinPct,
        fatPct,
        carbPct,
        proteinGr,
        carbinGr,
        fatinGr
    } = macrosSeleccionados;

    // Conversión a valores numéricos para cálculos
    const getPromedio = (rango) => {
        if (typeof rango !== 'string') return 0;
        
        const match = rango.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
        if (match) {
            return (parseFloat(match[1]) + parseFloat(match[2])) / 2;
        }
        
        const simpleMatch = rango.match(/(\d+\.?\d*)/);
        return simpleMatch ? parseFloat(simpleMatch[1]) : 0;
    };

    const proteinasPct = getPromedio(proteinPct);
    const grasasPct = getPromedio(fatPct);
    const hcPct = getPromedio(carbPct);
	
	
	
	

    // Integración con catalogoEstrategias (Estrategias Específicas)
    const estrategiasEspecificas = [];
    const advertencias = [];

    // Buscar estrategias específicas aplicables
    Object.values(catalogoEstrategias).flat().forEach(estrategia => {
        if (estrategia.aplicable.includes(objetivo)) {
            // Verificar si es aplicable a este propósito específico
            const tieneProposito = estrategia.features.some(feat => 
                feat.includes(`PROPÓSITO: Válido para ${propositoNormalizado.toUpperCase()}`) ||
                feat.includes(`PROPÓSITO: Solo válido para ${propositoNormalizado.toUpperCase()}`)
            );
            
            if (tieneProposito) {
                estrategiasEspecificas.push({
                    id: estrategia.id,
                    title: estrategia.title,
                    description: estrategia.description
                });
                
                // Extraer advertencias
                estrategia.features.forEach(feat => {
                    if (feat.includes("INCOMPATIBILIDAD")) {
                        advertencias.push(feat.replace("INCOMPATIBILIDAD: ", ""));
                    }
                });
            }
        }
    });

    // Generar detalles completos
    let detalles = faseConfig.details;
    
    // Añadir estrategias específicas recomendadas
    if (estrategiasEspecificas.length > 0) {
        detalles += `\n\nESTRATEGIAS ESPECÍFICAS RECOMENDADAS:\n${estrategiasEspecificas.map(e => `- ${e.title}: ${e.description}`).join('\n')}`;
    }
    
    // Añadir advertencias
    if (advertencias.length > 0) {
        detalles += `\n\nADVERTENCIAS CIENTÍFICAS:\n${advertencias.map(a => `- ${a}`).join('\n')}`;
    }
    
    // Cálculo de ejemplo con peso (si se proporciona)
    if (pesoKg) {
        const getPromedioGr = (rango) => {
            if (typeof rango !== 'string') return 0;
            
            const match = rango.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
            if (match) {
                return (parseFloat(match[1]) + parseFloat(match[2])) / 2;
            }
            
            const simpleMatch = rango.match(/(\d+\.?\d*)/);
            return simpleMatch ? parseFloat(simpleMatch[1]) : 0;
        };

        const proteinasGrProm = getPromedioGr(proteinGr);
        const hcGrProm = getPromedioGr(carbinGr);
        const grasasGrProm = getPromedioGr(fatinGr);

        if (proteinasGrProm > 0 && hcGrProm > 0 && grasasGrProm > 0) {
            const proteinasKcal = proteinasGrProm * pesoKg * 4;
            const hcKcal = hcGrProm * pesoKg * 4;
            const grasasKcal = grasasGrProm * pesoKg * 9;
            const totalKcal = proteinasKcal + hcKcal + grasasKcal;
            
            detalles += `\n\nEJEMPLO PARA ${pesoKg}KG:\n- ${Math.round(proteinasKcal)} kcal proteínas (${Math.round(proteinasGrProm * pesoKg)}g)\n- ${Math.round(hcKcal)} kcal HC (${Math.round(hcGrProm * pesoKg)}g)\n- ${Math.round(grasasKcal)} kcal grasas (${Math.round(grasasGrProm * pesoKg)}g)\nTotal: ${Math.round(totalKcal)} kcal`;
        }
    }

    // Validación final
    const totalPct = proteinasPct + grasasPct + hcPct;
    if (Math.abs(totalPct - 100) > 0.5) {
        console.warn(`[VALIDACIÓN] Los porcentajes no suman 100% (${totalPct.toFixed(1)}%) - Revisar configuración`);
    }

    // Retornar resultado
    return {
        proteinasPct: Math.round(proteinasPct * 10) / 10,
        grasasPct: Math.round(grasasPct * 10) / 10,
        hcPct: Math.round(hcPct * 10) / 10,
        proteinasGr: proteinGr,
        hcGr: carbinGr,
        grasasGr: fatinGr,
        detalles,
        totalPct: Math.round(totalPct * 10) / 10
    };
	
	} catch (error) {
        console.error("Error en actualizarMacros:", error);
        // Retornar valores por defecto en caso de error
        return {
            proteinasPct: 30,
            grasasPct: 35,
            hcPct: 35,
            proteinasGr: "1.6-2.2 g/kg/día",
            hcGr: "2.0-3.0 g/kg/día",
            grasasGr: "0.8-1.0 g/kg/día",
            detalles: "Error al calcular macros. Por favor, intente seleccionar otra estrategia.",
            totalPct: 100
        };
    }
	
}
	
	function calcularRango(rangoStr, weight) {
    // Si el valor es un rango (ej: "1.6-2.0 g/kg/día")
    if (typeof rangoStr === 'string' && rangoStr.includes('-')) {
        const [minStr, maxStr] = rangoStr.split('-');
        const min = parseFloat(minStr.match(/[\d.]+/)[0]);
        const max = parseFloat(maxStr.match(/[\d.]+/)[0]);
        
        // Si es un valor por peso (ej: "1.6-2.0 g/kg/día")
        if (rangoStr.includes('kg')) {
            return `${(min * weight).toFixed(1)}-${(max * weight).toFixed(1)}`;
        }
        // Si es un porcentaje (ej: "20-25%")
        return rangoStr;
    }
    // Si el valor es un número simple
    else if (typeof rangoStr === 'string' && !isNaN(parseFloat(rangoStr))) {
        return (parseFloat(rangoStr) * weight).toFixed(1);
    }
    // Si el valor ya es calculado (ej: "120-150g")
    return rangoStr;
}

// ===== FUNCIONES PRINCIPALES DEL MODAL =====

function openEditModal(event, button) {
    event.stopPropagation();
    event.preventDefault();
    
    // Verificar que el modal exista antes de intentar manipularlo
    const editModal = document.getElementById('editModal');
    if (!editModal) {
        console.error("El modal de edición no existe en el DOM");
        return;
    }
    
    // Obtener datos del botón
    const nombreFase = button.getAttribute('data-fase-nombre');
    const numeroFase = button.getAttribute('data-fase-numero');
    
    // Verificar que el elemento del título exista
    const modalTitle = document.getElementById('modal-phase-title');
    if (modalTitle) {
        modalTitle.textContent = `Configuración de Estrategias - ${nombreFase}`;
    } else {
        console.warn("Elemento modal-phase-title no encontrado en el DOM");
    }
    
    // Determinar el objetivo del plan
    const objetivoSelect = document.getElementById('objetivo');
    const goalType = objetivoSelect ? objetivoSelect.value : 'perdida1';
    
    // Determinar la fase específica en formato estandarizado
    let faseKey = "Fase " + numeroFase;
    if (goalType === 'mixto1' && numeroFase === "4") {
        faseKey = "Fase 4";
    }
    
    // Mapeo a formato estandarizado
    const faseMap = {
        '1': 'Fase 1 (0-12 sem)',
        '2': 'Fase 2 (12-24 sem)',
        '3': 'Fase 3 Avanzada (>24 sem)',
        '4': 'Fase 4 Ajuste Metabólico (>32 sem)',
        'Fase 1': 'Fase 1 (0-12 sem)',
        'Fase 2': 'Fase 2 (12-24 sem)',
        'Fase 3': 'Fase 3 Avanzada (>24 sem)',
        'Fase 4': 'Fase 4 Ajuste Metabólico (>32 sem)'
    };
    const faseEstandarizada = faseMap[numeroFase] || faseMap[faseKey] || "Fase 1 (0-12 sem)";
    
    // Obtener data-fase-info del botón
    const faseInfoStr = button.getAttribute('data-fase-info');
    let faseInfo = null;
    
    if (faseInfoStr) {
        try {
            faseInfo = JSON.parse(decodeURIComponent(faseInfoStr));
            console.log("Datos de fase obtenidos:", faseInfo);
        } catch (error) {
            console.error("Error al parsear data-fase-info:", error);
        }
    }
    
	// ✅ CALCULAR EL GET A PARTIR DE LOS DATOS DE LA TABLA GENERAL
    let kcalObjetivo = null;
    if (faseInfo && faseInfo.proteinas_g_dia && faseInfo.carbohidratos_g_dia && faseInfo.grasas_g_dia) {
        kcalObjetivo = (faseInfo.proteinas_g_dia * 4) + 
                      (faseInfo.carbohidratos_g_dia * 4) + 
                      (faseInfo.grasas_g_dia * 9);
    }
    
	
    // OBTENER EL PESO INICIAL DE LA FASE DESDE LA TABLA
    const pesoInicialFase = faseInfo ? faseInfo.pesoInicioFase : obtenerPesoInicialFase(numeroFase);
    
    // OBTENER EL PORCENTAJE DE GRASA PARA ESTA FASE
    let porcentajeGrasaFase = 0;
    const grasaInput = document.getElementById('current-fat-percentage');
    if (grasaInput) {
        porcentajeGrasaFase = parseFloat(grasaInput.value) || 0;
        
        // Si es una fase avanzada, calcular el % de grasa esperado basado en progreso
        if (numeroFase > 1) {
            porcentajeGrasaFase = calcularPorcentajeGrasaEsperado(
                pesoInicialFase, 
                numeroFase,
                document.getElementById('weight').value
            );
        }
    }
    
    // CREAR DATOS DE LA FASE CON EL PESO CORRECTO Y % GRASA
    const faseData = {
        pesoInicial: pesoInicialFase,
        porcentajeGrasaInicial: porcentajeGrasaFase,
        objetivo: goalType,
        fase: faseEstandarizada,
        // Almacenar los datos de macros de la tabla general
        macrosBase: faseInfo ? faseInfo.macrosBase : null,
        proteinaGrKg: faseInfo ? faseInfo.proteinas_g_kg : null,
        hcGrKg: faseInfo ? faseInfo.carbohidratos_g_kg : null,
        grasaGrKg: faseInfo ? faseInfo.grasas_g_kg : null,
        // ✅ ALMACENAR EL GET CALCULADO
        kcalObjetivo: kcalObjetivo ? Math.round(kcalObjetivo) : null,
        // Otros datos necesarios
        strategyId: null,
        estrategiaBase: null
    };
    
    // Almacenar la fase en el modal para uso posterior
    if (editModal) {
        editModal.setAttribute('data-fase', faseEstandarizada);
        editModal.setAttribute('data-fase-data', JSON.stringify(faseData));
    }
    
    // Reiniciar estado de recomendaciones
    recomendacionesState = {
        estrategiaBase: null,
        estrategiasEspecificas: [],
        recomendaciones: {
            base: [],
            especificas: {}
        }
    };
    
    // Renderizar estrategias base
    const baseStrategiesContainer = document.getElementById('base-strategies');
    if (baseStrategiesContainer) {
        baseStrategiesContainer.innerHTML = '';
        
        // Obtener estrategias base para el objetivo y fase
        const estrategiasBase = getEstrategiasByGoalAndPhase(goalType, faseEstandarizada);
        if (estrategiasBase.length > 0) {
            estrategiasBase.forEach(strategy => {
                const strategyElement = document.createElement('div');
                strategyElement.className = 'radio-option';
                strategyElement.setAttribute('data-strategy-id', strategy.id);
                
                strategyElement.innerHTML = `
                    <input type="radio" id="${strategy.id}" name="estrategia-base" value="${strategy.id}">
                    <label for="${strategy.id}">${strategy.title}</label>
                    <p class="text-muted small">${strategy.description}</p>
                `;
                
                strategyElement.addEventListener('click', function() {
                    document.querySelectorAll('.radio-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectEstrategiaBase(strategy, goalType, faseEstandarizada);
                });
                
                baseStrategiesContainer.appendChild(strategyElement);
            });
            
            // Seleccionar la primera estrategia por defecto
            if (baseStrategiesContainer.firstChild) {
                baseStrategiesContainer.firstChild.click();
            }
        } else {
            baseStrategiesContainer.innerHTML = '<p class="text-muted">No hay estrategias base disponibles para esta fase.</p>';
        }
    }
    
    // Renderizar estrategias específicas
    renderEstrategiasEspecificas(goalType, faseEstandarizada, null);
        
    // Actualizar recomendaciones clave
    const recommendationsContainer = document.getElementById('recommendations-container');
    if (recommendationsContainer) {
        recommendationsContainer.innerHTML = `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i> Selecciona una estrategia base para ver recomendaciones específicas.
                </div>
            </div>
        `;
    } else {
        console.error("El contenedor recommendations-container no existe en el DOM");
    }

    // Inicializar selección de días de entrenamiento
    initTrainingDays();
    
    // Inicializar selectores de intensidad
    initIntensitySelector();
    
    // Actualizar vista previa del horario
    updateSchedulePreview();
    
    // Configurar evento para cuando el modal se muestra
    if (editModal) {
        // Asegurar que el modal de Bootstrap esté inicializado
        const bootstrapModal = bootstrap.Modal.getInstance(editModal) || new bootstrap.Modal(editModal);
        
        // Configurar evento para cuando el modal se muestra
        editModal.addEventListener('shown.bs.modal', function() {
            // ACTUALIZAR PESO EN EL INPUT CON EL VALOR DE LA FASE
            const userWeightInput = document.getElementById('user-weight');
            if (userWeightInput) {
                // Verificar si hay un peso guardado para esta fase
                const faseDataStr = editModal.getAttribute('data-fase-data');
                let pesoInicialFase = 70;
                
                if (faseDataStr) {
                    try {
                        const faseData = JSON.parse(faseDataStr);
                        if (faseData && faseData.pesoInicial) {
                            pesoInicialFase = faseData.pesoInicial;
                        }
                    } catch (error) {
                        console.error("Error al parsear data-fase-data:", error);
                    }
                }
                
                // Usar el peso inicial de la fase solo si no hay un valor guardado
                const pesoGuardado = localStorage.getItem('user-weight-' + faseEstandarizada);
                if (pesoGuardado) {
                    userWeightInput.value = pesoGuardado;
                } else {
                    userWeightInput.value = pesoInicialFase;
                }
                
                // DISPARAR EVENTO DE CAMBIO PARA ACTUALIZAR MACROS
                const event = new Event('change', { bubbles: true });
                userWeightInput.dispatchEvent(event);
            }
            
            // ✅ INICIALIZAR LOS INPUTS DE MACROS CON LOS VALORES DE LA FASE
            if (faseInfo && faseInfo.macrosBase) {
                // Obtener los inputs de porcentajes
                const proteinPctInput = document.getElementById('proteinas-pct');
                const fatPctInput = document.getElementById('grasa-pct');
                const carbPctInput = document.getElementById('hc-pct');
                
                // Establecer los valores de porcentajes
                if (proteinPctInput) proteinPctInput.value = faseInfo.macrosBase.proteinasPct;
                if (fatPctInput) fatPctInput.value = faseInfo.macrosBase.grasasPct;
                if (carbPctInput) carbPctInput.value = faseInfo.macrosBase.carbohidratosPct;
                
                // Actualizar las barras de progreso
                const updateProgressBar = (elementId, value, color, text) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.innerHTML = `
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                    <div class="progress-bar ${color}" style="width: ${value}%"></div>
                                </div>
                                <span>${value}%${text ? ` (${text})` : ''}</span>
                            </div>
                        `;
                    }
                };
                
				
				
                // Actualizar barras con los valores de la fase
                updateProgressBar('proteinas-gr', faseInfo.macrosBase.proteinasPct, 'bg-success', `${faseInfo.proteinas_g_kg} g/kg`);
                updateProgressBar('grasa-gr', faseInfo.macrosBase.grasasPct, 'bg-warning', `${faseInfo.grasas_g_kg} g/kg`);
                updateProgressBar('hc-gr', faseInfo.macrosBase.carbohidratosPct, 'bg-danger', `${faseInfo.carbohidratos_g_kg} g/kg`);
                
                // Actualizar el campo de calorías objetivo
                const calorieEstimate = faseInfo.proteinas_g_dia * 4 + 
                                       faseInfo.carbohidratos_g_dia * 4 + 
                                       faseInfo.grasas_g_dia * 9;
                
                const goalCaloriesInput = document.getElementById('goal-calories');
                if (goalCaloriesInput) {
                    goalCaloriesInput.value = Math.round(calorieEstimate);
                }
            }
            
            // ✅ CONFIGURAR CÁLCULO DE MACROS
            if (userWeightInput) {
                // Eliminar event listeners previos para evitar duplicados
                const newUserWeightInput = userWeightInput.cloneNode(true);
                userWeightInput.parentNode.replaceChild(newUserWeightInput, userWeightInput);
                
                newUserWeightInput.addEventListener('input', function() {
                    // Guardar el peso personalizado en localStorage
                    const faseDataStr = editModal.getAttribute('data-fase-data');
                    let fase = "fase-desconocida";
                    
                    if (faseDataStr) {
                        try {
                            const faseData = JSON.parse(faseDataStr);
                            fase = faseData.fase || "fase-desconocida";
                        } catch (error) {
                            console.error("Error al parsear data-fase-data:", error);
                        }
                    }
                    
                    localStorage.setItem('user-weight-' + fase, this.value);
                    updateMacroValues();
                });
            }
            
			// ✅ FORZAR ACTUALIZACIÓN DE LOS VALORES INICIALES DE PAUSA
				actualizarValoresInicialesPausa(pesoInicialFase);
				
				// ✅ CONFIGURAR LISTENERS PARA LA SECCIÓN DE PAUSA (DENTRO DEL EVENTO shown.bs.modal)
				setupPausaMacroListeners();
        
			
            // CONFIGURAR EL HEADER DE CONFIGURACIÓN DE MACROS PARA EL TOOLTIP
            const macroConfigHeader = document.querySelector('.macro-config-header');
            if (!macroConfigHeader) {
                // Buscar todos los elementos h5 y encontrar el que contiene el texto deseado
                const h5Elements = document.querySelectorAll('h5');
                let existingHeader = null;
                
                for (const h5 of h5Elements) {
                    if (h5.textContent.includes("Configuración de Macros")) {
                        existingHeader = h5;
                        break;
                    }
                }
                
                if (existingHeader) {
                    existingHeader.classList.add('macro-config-header');
                    existingHeader.innerHTML = `
                        <i class="fas fa-sliders-h"></i> Configuración de Macros
                        <i class="fas fa-info-circle ms-2 text-muted" style="font-size: 0.8rem;"></i>
                    `;
                }
            }
            
            // ✅ SOLO FORZAR ACTUALIZACIÓN INICIAL SI HAY UNA ESTRATEGIA SELECCIONADA
            const selectedStrategy = document.querySelector('.radio-option.selected');
            if (selectedStrategy) {
                //updateMacroValues();
            }
        });
        
        // Configurar evento para cuando el modal se oculta
        editModal.addEventListener('hidden.bs.modal', function() {
            // Limpiar event listeners para evitar fugas de memoria
            const userWeightInput = document.getElementById('user-weight');
            if (userWeightInput) {
                const newUserWeightInput = userWeightInput.cloneNode(true);
                userWeightInput.parentNode.replaceChild(newUserWeightInput, userWeightInput);
            }
            
            // Eliminar tooltip
            const macroConfigHeader = document.querySelector('.macro-config-header');
            if (macroConfigHeader) {
                const tooltip = macroConfigHeader.querySelector('.macro-tooltip');
                if (tooltip) tooltip.remove();
            }
        });
        
        // ✅ MOSTRAR EL MODAL
        bootstrapModal.show();
    }
}

function guardarConfiguracionEstrategiasEspecificas() {
    try {
        const estrategiasSeleccionadas = [];
        
        // Solo intentar obtener checkboxes si el modal está abierto
        const checkboxes = document.querySelectorAll('.strategy-checkbox:checked');
        
        checkboxes.forEach(checkbox => {
            try {
                const strategyId = checkbox.id.replace('chk-', '');
                
                // Encontrar la estrategia en los catálogos
                let estrategia = null;
                for (const categoria in catalogoEstrategias) {
                    const categoriaEstrategias = catalogoEstrategias[categoria] || [];
                    const encontrada = categoriaEstrategias.find(e => e.id === strategyId);
                    if (encontrada) {
                        estrategia = encontrada;
                        break;
                    }
                }
                
                if (!estrategia) {
                    console.warn(`Estrategia con ID ${strategyId} no encontrada en los catálogos`);
                    return;
                }
                
                // Obtener configuración - VERIFICAR QUE LOS ELEMENTOS EXISTAN
                const strategyItem = checkbox.closest('.strategy-item');
                if (!strategyItem) return;
                
                const configOptions = strategyItem.querySelector('.strategy-config-options');
                if (!configOptions) return;
                
                const freqSelect = configOptions.querySelector('select[id^="freq-"]');
                const daysSelect = configOptions.querySelector('select[id^="days-"]');
                
                if (!freqSelect || !daysSelect) return;
                
                const frecuencia = freqSelect.value;
                const diasAplicacion = daysSelect.value;
                
                estrategiasSeleccionadas.push({
                    id: strategyId,
                    title: estrategia.title,
                    frecuencia: frecuencia,
                    diasAplicacion: diasAplicacion
                });
            } catch (error) {
                console.error(`Error procesando estrategia en checkbox:`, error);
            }
        });
        
        // Almacenar en DataFase - VERIFICAR QUE EL MODAL EXISTA
        const modal = document.getElementById('editModal');
        if (modal) {
            try {
                const faseDataStr = modal.getAttribute('data-fase-data');
                const faseData = faseDataStr ? JSON.parse(faseDataStr) : {};
                
                faseData.estrategiasEspecificas = estrategiasSeleccionadas;
                modal.setAttribute('data-fase-data', JSON.stringify(faseData));
            } catch (error) {
                console.error("Error al actualizar data-fase-data:", error);
            }
        }
        
        return estrategiasSeleccionadas;
    } catch (error) {
        console.error("Error crítico en guardarConfiguracionEstrategiasEspecificas:", error);
        return [];
    }
}


function obtenerDatosFaseDesdeTabla(numeroFase) {
    // Buscar la fila de la fase en la tabla
    const faseRows = document.querySelectorAll('.accordion-phase');
    let faseRow = null;
    
    // Encontrar la fila correspondiente al número de fase
    for (const row of faseRows) {
        const faseHeader = row.querySelector('.accordion-header table tr td:first-child');
        if (faseHeader && faseHeader.textContent.includes(`Fase ${numeroFase}`)) {
            faseRow = row;
            break;
        }
    }
    
    // Si no se encontró con el método anterior, intentar alternativa
    if (!faseRow) {
        const editButton = document.querySelector(`button[data-fase-numero="${numeroFase}"]`);
        if (editButton) {
            faseRow = editButton.closest('.accordion-phase');
        }
    }
    
    if (!faseRow) {
        console.error(`No se encontró la fase ${numeroFase} en la tabla`);
        
        // Intentar obtener datos básicos del plan
        return {
            pesoInicial: document.getElementById('weight')?.value || 70,
            objetivo: 'perdida',
            fase: `Fase ${numeroFase}`,
            proposito: 'estetica',
            macros: {
                proteinasPct: 0,
                grasasPct: 0,
                hcPct: 0,
                proteinasGr: "",
                grasasGr: "",
                hcGr: ""
            }
        };
    }
    
    // Buscar el botón de detalles semanales
    const detallesBtn = faseRow.querySelector('.ver-detalles-fase-btn');
    
    if (!detallesBtn) {
        console.error(`No se encontró el botón de detalles para la fase ${numeroFase}`);
        return {
            pesoInicial: document.getElementById('weight')?.value || 70,
            objetivo: 'perdida',
            fase: `Fase ${numeroFase}`,
            proposito: 'estetica',
            macros: {
                proteinasPct: 0,
                grasasPct: 0,
                hcPct: 0,
                proteinasGr: "",
                grasasGr: "",
                hcGr: ""
            }
        };
    }
    
    // Decodificar y parsear los datos de la fase
    const faseInfoStr = detallesBtn.getAttribute('data-fase-info');
    const faseInfo = JSON.parse(decodeURIComponent(faseInfoStr));
    
    // Crear el objeto DataFase con la estructura que necesita el sistema
    return {
        id: `fase-${numeroFase}`,
        numero: parseInt(numeroFase),
        nombre: faseInfo.nombreFase,
        meses: faseInfo.mesesTexto,
        semanas: faseInfo.semanasAsignadas,
        reevalSemana: faseInfo.semanaReevaluacion,
        pesoInicial: faseInfo.pesoInicioFase,
        pesoFinalEstimado: faseInfo.pesoFinFase,
        objetivo: document.getElementById('objetivo')?.value.replace('1', '') || 'perdida',
        proposito: document.getElementById('objetivoGeneral')?.value || 'estetica',
        objetivoPrincipal: faseInfo.objetivoPrincipal,
        observaciones: faseInfo.observaciones,
        macros: {
            proteinasPct: faseInfo.macrosBase.proteinasPct,
            grasasPct: faseInfo.macrosBase.grasasPct,
            hcPct: faseInfo.macrosBase.carbohidratosPct,
            proteinasGr: `${faseInfo.proteinas_g_kg} g/kg/día`,
            grasasGr: `${faseInfo.grasas_g_kg} g/kg/día`,
            hcGr: `${faseInfo.carbohidratos_g_kg} g/kg/día`
        }
    };
}
function obtenerDatosFaseDesdeTabla(numeroFase) {
    // Normalizar el número de fase
    const faseNumerica = parseInt(numeroFase);
    if (isNaN(faseNumerica)) {
        console.error(`Número de fase inválido: ${numeroFase}`);
        return {
            pesoInicioFase: document.getElementById('weight')?.value || 70,
            objetivo: 'perdida',
            fase: "Fase 1 (0-12 sem)",
            proposito: 'estetica',
            macros: {
                proteinasPct: 0,
                grasasPct: 0,
                hcPct: 0,
                proteinasGr: "",
                grasasGr: "",
                hcGr: ""
            }
        };
    }
    
    // Mapeo de número de fase a texto descriptivo
    const faseMap = {
        1: "Fase 1 (0-12 sem)",
        2: "Fase 2 (12-24 sem)",
        3: "Fase 3 Avanzada (>24 sem)",
        4: "Fase 4 Ajuste Metabólico (>32 sem)"
    };
    
    const nombreFase = faseMap[faseNumerica] || `Fase ${faseNumerica}`;
    
    // Buscar la fila de la fase en la tabla - Mejorada para manejar diferentes estructuras
    const faseRows = document.querySelectorAll('.accordion-phase');
    let faseRow = null;
    
    for (const row of faseRows) {
        const dataFase = row.getAttribute('data-fase-numero');
        const titleElement = row.querySelector('.phase-title');
        
        if (dataFase && parseInt(dataFase) === faseNumerica) {
            faseRow = row;
            break;
        } else if (titleElement && titleElement.textContent.includes(nombreFase)) {
            faseRow = row;
            break;
        }
    }
    
    if (!faseRow) {
        console.warn(`No se encontró la fase ${numeroFase} en la tabla. Usando valores por defecto.`);
        return {
            pesoInicioFase: document.getElementById('weight')?.value || 70,
            objetivo: 'perdida',
            fase: nombreFase,
            proposito: 'estetica',
            macros: {
                proteinasPct: 20,
                grasasPct: 35,
                hcPct: 45,
                proteinasGr: "1.6-2.2 g/kg/día",
                grasasGr: "0.8-1.0 g/kg/día",
                hcGr: "2.0-3.0 g/kg/día"
            }
        };
    }
    
    // Buscar el botón de detalles semanales
    const detallesBtn = faseRow.querySelector('.ver-detalles-fase-btn') || 
                        faseRow.querySelector('[data-fase-info]');
    
    if (!detallesBtn) {
        console.warn(`No se encontró el botón de detalles para la fase ${numeroFase}. Usando valores por defecto.`);
        return {
            pesoInicioFase: document.getElementById('weight')?.value || 70,
            objetivo: 'perdida',
            fase: nombreFase,
            proposito: 'estetica',
            macros: {
                proteinasPct: 20,
                grasasPct: 35,
                hcPct: 45,
                proteinasGr: "1.6-2.2 g/kg/día",
                grasasGr: "0.8-1.0 g/kg/día",
                hcGr: "2.0-3.0 g/kg/día"
            }
        };
    }
    
    // Decodificar y parsear los datos de la fase
    let faseInfo = null;
    try {
        const faseInfoStr = detallesBtn.getAttribute('data-fase-info');
        faseInfo = faseInfoStr ? JSON.parse(decodeURIComponent(faseInfoStr)) : null;
        
        if (!faseInfo) {
            throw new Error("Fase info vacía");
        }
    } catch (error) {
        console.error(`Error al parsear data-fase-info para fase ${numeroFase}:`, error);
        faseInfo = {
            nombreFase: nombreFase,
            semanasAsignadas: faseNumerica === 1 ? 12 : faseNumerica === 2 ? 12 : faseNumerica === 3 ? 12 : 8,
            pesoInicioFase: document.getElementById('weight')?.value || 70,
            objetivoPrincipal: 'perdida',
            macrosBase: {
                proteinasPct: 20,
                grasasPct: 35,
                carbohidratosPct: 45
            },
            proteinas_g_kg: "1.6-2.2",
            grasas_g_kg: "0.8-1.0",
            carbohidratos_g_kg: "2.0-3.0"
        };
    }
    
    // Crear el objeto DataFase con la estructura que necesita el sistema
    return {
        id: `fase-${faseNumerica}`,
        numero: faseNumerica,
        nombre: faseInfo.nombreFase || nombreFase,
        meses: faseInfo.mesesTexto || `${Math.ceil(faseInfo.semanasAsignadas / 4)} meses`,
        semanas: faseInfo.semanasAsignadas || (faseNumerica === 1 ? 12 : 12),
        reevalSemana: faseInfo.semanaReevaluacion || (faseNumerica === 1 ? 6 : faseNumerica * 4),
        pesoInicial: faseInfo.pesoInicioFase || (document.getElementById('weight')?.value || 70),
        pesoFinalEstimado: faseInfo.pesoFinFase || (document.getElementById('weight')?.value - 5 || 65),
        objetivo: document.getElementById('objetivo')?.value?.replace('1', '') || 'perdida',
        proposito: document.getElementById('objetivoGeneral')?.value || 'estetica',
        objetivoPrincipal: faseInfo.objetivoPrincipal || 'perdida',
        observaciones: faseInfo.observaciones || 'Fase estándar para el objetivo seleccionado',
        macros: {
            proteinasPct: faseInfo.macrosBase?.proteinasPct || 20,
            grasasPct: faseInfo.macrosBase?.grasasPct || 35,
            hcPct: faseInfo.macrosBase?.carbohidratosPct || 45,
            proteinasGr: faseInfo.proteinas_g_kg ? `${faseInfo.proteinas_g_kg} g/kg/día` : "1.6-2.2 g/kg/día",
            grasasGr: faseInfo.grasas_g_kg ? `${faseInfo.grasas_g_kg} g/kg/día` : "0.8-1.0 g/kg/día",
            hcGr: faseInfo.carbohidratos_g_kg ? `${faseInfo.carbohidratos_g_kg} g/kg/día` : "2.0-3.0 g/kg/día"
        }
    };
}


function getEstrategiasByGoalAndPhase(goalType, faseKey) {
    const goalMap = {
        'perdida1': 'perdida',
        'ganancia1': 'ganancia',
        'mantenimiento1': 'mantenimiento',
        'mixto1': 'mixto'
    };
    const goalKey = goalMap[goalType] || 'perdida';
    
    // Normalizar faseKey para asegurarnos de que es un string
    faseKey = faseKey ? faseKey.toString() : "";
    
    // Manejar posibles variaciones en el nombre de la fase
    let normalizedFaseKey = faseKey;
    
    // Si faseKey es un número, convertirlo a un formato estándar
    if (/^\d+$/.test(faseKey)) {
        switch(faseKey) {
            case "1":
                if (goalKey === 'mixto') {
                    normalizedFaseKey = "Fase 1 Volume (0-12 sem)";
                } else if (goalKey === 'ganancia') {
                    normalizedFaseKey = "Fase 1 (0-8 sem)";
                } else {
                    normalizedFaseKey = "Fase 1 (0-12 sem)";
                }
                break;
            case "2":
                if (goalKey === 'mixto') {
                    normalizedFaseKey = "Fase 2 Definición (12-24 sem)";
                } else if (goalKey === 'ganancia') {
                    normalizedFaseKey = "Fase 2 (8-20 sem)";
                } else {
                    normalizedFaseKey = "Fase 2 (12-24 sem)";
                }
                break;
            case "3":
                if (goalKey === 'mixto') {
                    normalizedFaseKey = "Fase 3 Mantenimiento Metabólico (24-32 sem)";
                } else if (goalKey === 'ganancia') {
                    normalizedFaseKey = "Fase 3 (20+ sem)";
                } else {
                    normalizedFaseKey = "Fase 3 Avanzada (>24 sem)";
                }
                break;
            case "4":
                normalizedFaseKey = "Fase 4 Ajuste Metabólico (>32 sem)";
                break;
            default:
                normalizedFaseKey = "Fase 1 (0-12 sem)";
        }
    } else {
        // Si faseKey es un string, intentar normalizarlo
        if (goalKey === 'mixto') {
            if (/fase\s*1/i.test(faseKey)) {
                normalizedFaseKey = "Fase 1 Volume (0-12 sem)";
            } else if (/fase\s*2/i.test(faseKey)) {
                normalizedFaseKey = "Fase 2 Definición (12-24 sem)";
            } else if (/fase\s*3/i.test(faseKey)) {
                normalizedFaseKey = "Fase 3 Mantenimiento Metabólico (24-32 sem)";
            } else if (/fase\s*4/i.test(faseKey)) {
                normalizedFaseKey = "Fase 4 Ajuste Metabólico (>32 sem)";
            }
        } else if (goalKey === 'ganancia') {
            if (/fase\s*1/i.test(faseKey)) {
                normalizedFaseKey = "Fase 1 (0-8 sem)";
            } else if (/fase\s*2/i.test(faseKey)) {
                normalizedFaseKey = "Fase 2 (8-20 sem)";
            } else if (/fase\s*3/i.test(faseKey)) {
                normalizedFaseKey = "Fase 3 (20+ sem)";
            }
        } else {
            // Para otros objetivos, usar el mapeo estándar
            if (/fase\s*1/i.test(faseKey)) {
                normalizedFaseKey = "Fase 1 (0-12 sem)";
            } else if (/fase\s*2/i.test(faseKey)) {
                normalizedFaseKey = "Fase 2 (12-24 sem)";
            } else if (/fase\s*3/i.test(faseKey)) {
                normalizedFaseKey = "Fase 3 Avanzada (>24 sem)";
            } else if (/fase\s*4/i.test(faseKey)) {
                normalizedFaseKey = "Fase 4 Ajuste Metabólico (>32 sem)";
            }
        }
    }
    
    // Verificar si existe la configuración para esta combinación
    if (!estrategiasBaseConfig[goalKey] || !estrategiasBaseConfig[goalKey][normalizedFaseKey]) {
        console.error(`No se encontró configuración para ${goalKey}/${normalizedFaseKey}`);
        
        // Intentar encontrar la fase más cercana
        const fasesDisponibles = Object.keys(estrategiasBaseConfig[goalKey] || {});
        if (fasesDisponibles.length > 0) {
            normalizedFaseKey = fasesDisponibles[0];
            console.warn(`Fase inválida detectada: ${faseKey}. Usando '${normalizedFaseKey}' por defecto.`);
        } else {
            console.error(`No se encontró ninguna fase para ${goalKey}`);
            return [];
        }
    }
    
    return estrategiasBaseConfig[goalKey][normalizedFaseKey];
}

function selectEstrategiaBase(strategy, goalType, faseKey) {
    // Validación de parámetros críticos
    if (!strategy || !strategy.id) {
        console.error("selectEstrategiaBase: strategy no definido o inválido", {strategy, goalType, faseKey});
        return;
    }
    
    // ✅ CORRECCIÓN CLAVE: MOVER ESTA DECLARACIÓN AL PRINCIPIO
    // Determinar objetivo limpio
    const objetivo = goalType.replace('1', '');
    
    // Asegurar que faseKey esté en formato estandarizado
    let faseEstandarizada = faseKey;
    const faseMap = {
        '1': 'Fase 1 (0-12 sem)',
        '2': 'Fase 2 (12-24 sem)',
        '3': 'Fase 3 Avanzada (>24 sem)',
        '4': 'Fase 4 Ajuste Metabólico (>32 sem)',
        'Fase 1': 'Fase 1 (0-12 sem)',
        'Fase 2': 'Fase 2 (12-24 sem)',
        'Fase 3': 'Fase 3 Avanzada (>24 sem)',
        'Fase 4': 'Fase 4 Ajuste Metabólico (>32 sem)'
    };
    
    if (faseMap[faseKey]) {
        faseEstandarizada = faseMap[faseKey];
    } else if (faseKey.includes("Fase") && !faseKey.includes("(")) {
        // Intentar convertir "Fase 1" a "Fase 1 (0-12 sem)"
        const numero = faseKey.match(/\d+/);
        if (numero && faseMap[numero[0]]) {
            faseEstandarizada = faseMap[numero[0]];
        }
    }
    
    // Obtener propósito desde objetivoGeneral
    const propositoElement = document.getElementById('objetivoGeneral');
    let proposito = 'estetica'; // Valor por defecto
    
    if (propositoElement) {
        const propositoRaw = propositoElement.value.toLowerCase();
        if (propositoRaw.includes('salud')) proposito = 'salud';
        else if (propositoRaw.includes('estet')) proposito = 'estetica';
        else if (propositoRaw.includes('rendimiento')) proposito = 'rendimiento';
    }
    
    // DECLARAR pesoInicialFase ANTES DE USARLA
    let pesoInicialFase = 70;
    
    // Almacenar la fase en el modal para uso posterior
    const editModal = document.getElementById('editModal');
    if (editModal) {
        editModal.setAttribute('data-fase', faseEstandarizada);
        
        // OBTENER EL PESO INICIAL DE LA FASE DESDE LA TABLA
        const numeroFase = faseEstandarizada.match(/\d+/)?.[0] || faseKey.match(/\d+/)?.[0];
        
        if (numeroFase) {
            try {
                pesoInicialFase = obtenerPesoInicialFase(numeroFase);
                console.log(`Peso inicial de la fase ${numeroFase}: ${pesoInicialFase} kg`);
            } catch (error) {
                console.error(`Error al obtener peso inicial para fase ${numeroFase}:`, error);
            }
        }
        
        // Actualizar FaseData con el peso correcto
        const faseData = {
            pesoInicial: pesoInicialFase,
            objetivo: goalType,
            fase: faseEstandarizada,
            strategyId: strategy.id,
            estrategiaBase: {
                id: strategy.id,
                title: strategy.title,
                aplicable: strategy.aplicable
            }
        };
        editModal.setAttribute('data-fase-data', JSON.stringify(faseData));
    }
    
    // USAR EL PESO INICIAL DE LA FASE EN LOS CÁLCULOS
    const peso = pesoInicialFase;
    
    // Actualizar la sección de detalles
    const macroDetails = document.getElementById('macro-details-text');
    if (macroDetails) {
        try {
            // Verificar que strategy.details existe
            if (!strategy.details) {
                macroDetails.innerHTML = '<div class="strategy-main-text text-muted">No hay detalles disponibles para esta estrategia.</div>';
                return;
            }
            
            // Texto principal de la estrategia
            let fullDetails = strategy.details;
            
            // Buscar estrategias específicas aplicables
            const estrategiasEspecificas = {
                recomendadas: [],
                neutrales: [],
                contraindicadas: []
            };
            const advertencias = [];
            
            // Buscar en todas las categorías
            const todasEstrategias = [
                ...(catalogoEstrategias.cetogenicas || []), 
                ...(catalogoEstrategias.ciclado || []), 
                ...(catalogoEstrategias.timing || [])
            ];
            
            if (todasEstrategias.length === 0) {
                console.warn("No se encontraron estrategias específicas en los catálogos");
            }
            
            todasEstrategias.forEach(estrategia => {
                try {
                    // Clasificar la estrategia según el propósito, fase y estrategia base
                    const clasificacion = clasificarEstrategia(estrategia, proposito, faseEstandarizada, strategy);
                    
                    if (clasificacion.clasificacion === 'recomendada') {
                        estrategiasEspecificas.recomendadas.push({
                            title: estrategia.title || '',
                            description: estrategia.description || ''
                        });
                    } else if (clasificacion.clasificacion === 'no recomendada' || 
                               clasificacion.clasificacion === 'contraindicada') {
                        estrategiasEspecificas.contraindicadas.push({
                            title: estrategia.title || '',
                            description: estrategia.description || '',
                            mensaje: clasificacion.detalle
                        });
                        // EXTRAER ADVERTENCIAS ESPECÍFICAS DE LA CLASIFICACIÓN
                        if (clasificacion.detalle) {
                            // Si hay múltiples advertencias (separadas por salto de línea)
                            if (clasificacion.detalle.includes('\n')) {
                                clasificacion.detalle.split('\n').forEach(adv => {
                                    if (adv.trim() !== "") {
                                        advertencias.push(adv);
                                    }
                                });
                            } else {
                                if (clasificacion.detalle.trim() !== "") {
                                    advertencias.push(clasificacion.detalle);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error(`Error al clasificar estrategia ${estrategia.id}:`, error);
                }
            });
            
            // Añadir estrategias específicas recomendadas al texto
            if (estrategiasEspecificas.recomendadas.length > 0) {
                fullDetails += `\n\nESTRATEGIAS ESPECÍFICAS RECOMENDADAS:`;
                estrategiasEspecificas.recomendadas.forEach(e => {
                    if (e.title && e.description) {
                        fullDetails += `\n- ${e.title}: ${e.description}`;
                    }
                });
            }
			
			// ✅ CORRECCIÓN CLAVE: Procesar advertencias para reemplazar "INCOMPATIBILIDAD"
            const advertenciasProcesadas = procesarAdvertencias(advertencias);
            
            // Añadir advertencias científicas (SIN MENSAJES DUPLICADOS)
            if (advertenciasProcesadas.length > 0) {
                // Eliminar duplicados manteniendo el orden
                const advertenciasUnicas = [...new Set(advertenciasProcesadas)];
                
                fullDetails += `\n\nADVERTENCIAS CIENTÍFICAS:`;
                advertenciasUnicas.forEach(a => {
                    fullDetails += `\n- ${a}`;
                });
            }
            
           
            
            // Formatear y actualizar con el objetivo y propósito
            const formattedDetails = formatStrategyDetails(fullDetails, objetivo, proposito);
            macroDetails.innerHTML = formattedDetails;
            
            // Guardar los detalles completos en el modal para evitar sobrescritura
            if (editModal) {
                editModal.setAttribute('data-full-details', fullDetails);
            }
            
            // Actualizar recomendaciones clave
            const recommendationsContainer = document.getElementById('recommendations-container');
            if (recommendationsContainer) {
                try {
                    // PASAR faseKey y peso a la función
                    recommendationsContainer.innerHTML = reiniciarRecomendaciones(strategy, proposito, goalType, faseEstandarizada);
                } catch (error) {
                    console.error("Error al reiniciar recomendaciones:", error);
                    recommendationsContainer.innerHTML = `
                        <div class="recommendations-section">
                            <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i> 
                                Error al generar recomendaciones: ${error.message}
                            </div>
                        </div>
                    `;
                }
            }
            
            // Renderizar estrategias específicas con la estrategia base actual
            renderEstrategiasEspecificas(goalType, faseEstandarizada, strategy);
            
            // ✅ ACTUALIZAR LA SECCIÓN ESTRATEGIA ÓPTIMA INMEDIATAMENTE
            renderOptimalStrategyContent(objetivo, proposito, strategy.id, faseEstandarizada);
        } catch (error) {
            console.error("Error al procesar detalles de estrategia:", error);
            macroDetails.innerHTML = `
                <div class="strategy-main-text text-danger">
                    Error al procesar los detalles de la estrategia. 
                    Por favor, intente seleccionar otra estrategia.
                </div>
            `;
        }
    }
    
// ✅ CORRECCIÓN CLAVE: ACTUALIZAR MACROS INMEDIATAMENTE CON LOS PARÁMETROS CORRECTOS
    console.log("Actualizando macros después de seleccionar estrategia base");
    console.log("Objetivo:", objetivo);
    console.log("Propósito:", proposito);
    console.log("Fase:", faseEstandarizada);
    console.log("Peso:", peso);
    console.log("Strategy ID:", strategy.id);
    
	// Forzar actualización de macros con los parámetros correctos
    updateMacroValuesWithParams(objetivo, proposito, faseEstandarizada, peso, strategy.id);
}






// NUEVA FUNCIÓN PARA ACTUALIZAR MACROS CON PARÁMETROS EXPLÍCITOS
function updateMacroValuesWithParams(objetivo, proposito, fase, peso, strategyId) {
    const userWeightInput = document.getElementById('user-weight');
    
    // Forzar actualización del peso en el input
    if (userWeightInput && peso) {
        userWeightInput.value = peso;
    }
    
    // Verificar si hay una estrategia base seleccionada
    const selectedStrategy = document.querySelector('.radio-option.selected');
    
    if (selectedStrategy || strategyId) {
        try {
            // Usar el strategyId proporcionado si está disponible
            const finalStrategyId = strategyId || selectedStrategy.getAttribute('data-strategy-id');
            
            if (!finalStrategyId) {
                throw new Error("No se encontró el ID de la estrategia base");
            }
            
            console.log("Actualizando macros con:", {
                objetivo,
                proposito,
                fase,
                peso,
                strategyId: finalStrategyId
            });
            
            // Usar la función científicamente validada CON EL PESO DE LA FASE Y EL ID DE LA ESTRATEGIA
            const macros = actualizarMacros(objetivo, proposito, fase, peso, finalStrategyId);
            
            // ACTUALIZAR PORCENTAJES EN LOS INPUTS
            const proteinPctInput = document.getElementById('proteinas-pct');
            const fatPctInput = document.getElementById('grasa-pct');
            const carbPctInput = document.getElementById('hc-pct');
            
            if (proteinPctInput) proteinPctInput.value = macros.proteinasPct;
            if (fatPctInput) fatPctInput.value = macros.grasasPct;
            if (carbPctInput) carbPctInput.value = macros.hcPct;
            
            // ACTUALIZAR BARRAS DE PROGRESO
            const updateProgressBar = (elementId, value, color, text) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                <div class="progress-bar ${color}" style="width: ${value}%"></div>
                            </div>
                            <span>${value}%${text ? ` (${text})` : ''}</span>
                        </div>
                    `;
                }
            };
            
            updateProgressBar('proteinas-gr', macros.proteinasPct, 'bg-success', macros.proteinasGr);
            updateProgressBar('grasa-gr', macros.grasasPct, 'bg-warning', macros.grasasGr);
            updateProgressBar('hc-gr', macros.hcPct, 'bg-danger', macros.hcGr);
            
            // ACTUALIZAR SUMA DE PORCENTAJES
            actualizarSumaPorcentajes();
            
            // ACTUALIZAR ESTRATEGIA ÓPTIMA
            renderOptimalStrategyContent(objetivo, proposito, finalStrategyId, fase);
            
            return true; // Indicar que la actualización fue exitosa
        } catch (error) {
            console.error("Error al actualizar macros con parámetros explícitos:", error);
            
            // Intentar usar la función de actualización tradicional como fallback
            try {
                updateMacroValues();
                return true;
            } catch (fallbackError) {
                console.error("Error al usar fallback de actualización de macros:", fallbackError);
                return false;
            }
        }
    } else {
        console.warn("No hay estrategia base seleccionada para actualizar macros");
        // Usar la función de actualización tradicional
        updateMacroValues();
        return false;
    }
}


function renderEstrategiasEspecificas(goalType, faseKey, estrategiaBase) {
    // Determinar el tipo de objetivo
    let objetivoKey = '';
    if (goalType === 'perdida1') objetivoKey = 'perdida';
    else if (goalType === 'ganancia1') objetivoKey = 'ganancia';
    else if (goalType === 'mantenimiento1') objetivoKey = 'mantenimiento';
    else if (goalType === 'mixto1') objetivoKey = 'mixto';
    
    // OBTENER PROPÓSITO CORRECTAMENTE (CORRECCIÓN CLAVE)
    let propositoKey = 'estetica'; // Valor por defecto
    
    // Primero intentar desde el modal si está abierto
    const modal = document.getElementById('editModal');
    if (modal) {
        const faseDataStr = modal.getAttribute('data-fase-data');
        if (faseDataStr) {
            try {
                const faseData = JSON.parse(faseDataStr);
                if (faseData && faseData.proposito) {
                    const propositoLower = faseData.proposito.toLowerCase();
                    if (propositoLower.includes('salud')) propositoKey = 'salud';
                    else if (propositoLower.includes('estet')) propositoKey = 'estetica';
                    else if (propositoLower.includes('rendimiento')) propositoKey = 'rendimiento';
                }
            } catch (e) {
                console.warn("Error parsing faseData:", e);
            }
        }
    }
    
    // Si no se encontró en DataFase, intentar desde el select
    if (propositoKey === 'estetica') {
        const propositoElement = document.getElementById('objetivoGeneral');
        if (propositoElement) {
            const propositoRaw = propositoElement.value.toLowerCase();
            if (propositoRaw.includes('salud')) propositoKey = 'salud';
            else if (propositoRaw.includes('estet')) propositoKey = 'estetica';
            else if (propositoRaw.includes('rendimiento')) propositoKey = 'rendimiento';
        }
    }
    
    // Verificar que los contenedores existan ANTES de intentar renderizar
    const cetogenicasContainer = document.getElementById('cetogenicas-strategies');
    const cicladoContainer = document.getElementById('ciclado-strategies');
    const timingContainer = document.getElementById('timing-strategies');
    
    if (!cetogenicasContainer || !cicladoContainer || !timingContainer) {
        console.error("Contenedores de estrategias específicas no encontrados. El modal probablemente no está abierto.");
        return;
    }
    
    // Renderizar cada categoría
    renderEstrategiasCategoria(
        catalogoEstrategias.cetogenicas, 
        'cetogenicas-strategies', 
        objetivoKey, 
        faseKey, 
        propositoKey, 
        estrategiaBase
    );
    
    renderEstrategiasCategoria(
        catalogoEstrategias.ciclado, 
        'ciclado-strategies', 
        objetivoKey, 
        faseKey, 
        propositoKey, 
        estrategiaBase
    );
    
    renderEstrategiasCategoria(
        catalogoEstrategias.timing, 
        'timing-strategies', 
        objetivoKey, 
        faseKey, 
        propositoKey, 
        estrategiaBase
    );
}

function renderEstrategiasCategoria(strategies, containerId, objetivoKey, faseKey, propositoKey, estrategiaBase) {
    // Asegurar que propositoKey esté definido
    if (!propositoKey) {
        console.warn(`propositoKey no definido para ${containerId}. Usando 'estetica' por defecto.`);
        propositoKey = 'estetica';
    }
    
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Contenedor ${containerId} no encontrado en el DOM. El modal probablemente no está abierto.`);
        return;
    }
    
    container.innerHTML = '';
    
    // Verificar que strategies sea un array válido
    if (!strategies || !Array.isArray(strategies)) {
        console.warn(`Estrategias no válidas para ${containerId}`);
        container.innerHTML = '<p class="text-muted">No hay estrategias disponibles para este objetivo.</p>';
        return;
    }
    
    // Filtrar estrategias aplicables al objetivo
    const estrategiasFiltradas = strategies.filter(strategy => {
        if (!strategy.aplicable) {
            console.warn(`Estrategia sin propiedad 'aplicable':`, strategy);
            return false;
        }
        return strategy.aplicable.includes(objetivoKey);
    });
    
    if (estrategiasFiltradas.length === 0) {
        container.innerHTML = '<p class="text-muted">No hay estrategias disponibles para este objetivo.</p>';
        return;
    }
    
    // Renderizar cada estrategia
    estrategiasFiltradas.forEach(strategy => {
        try {
            // Clasificar la estrategia según el propósito, fase y estrategia base
            const clasificacion = clasificarEstrategia(strategy, propositoKey, faseKey, estrategiaBase);
            
            const strategyElement = document.createElement('div');
            
            // Establecer clases según la clasificación
            let containerClass = '';
            let badgeClass = '';
            let iconClass = '';
            let badgeText = '';
            
            switch(clasificacion.clasificacion) {
                case 'recomendada':
                    containerClass = 'strategy-recomendada';
                    badgeClass = 'badge-recomendada';
                    iconClass = 'fas fa-check-circle text-success';
                    badgeText = 'RECOMENDADA';
                    break;
                case 'neutral':
                    containerClass = 'strategy-neutral';
                    badgeClass = 'badge-neutral';
                    iconClass = 'fas fa-circle text-muted';
                    badgeText = 'NEUTRAL';
                    break;
                case 'contraindicada':
                case 'no recomendada':
                    containerClass = 'strategy-contraindicada';
                    badgeClass = 'badge-contraindicada';
                    iconClass = 'fas fa-times-circle text-danger';
                    badgeText = 'NO RECOMENDADA';
                    break;
                default:
                    containerClass = 'strategy-neutral';
                    badgeClass = 'badge-neutral';
                    iconClass = 'fas fa-circle text-muted';
                    badgeText = 'NEUTRAL';
            }
            
            strategyElement.className = `strategy-item p-2 mb-2 ${containerClass}`;
            strategyElement.dataset.strategyId = strategy.id;
            
            strategyElement.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="form-check me-2">
                        <input class="form-check-input strategy-checkbox" type="checkbox" id="chk-${strategy.id}">
                        <label class="form-check-label" for="chk-${strategy.id}"></label>
                    </div>
                    <i class="${iconClass} mt-1" style="font-size: 1.1rem; width: 20px;"></i>
                    <div class="flex-grow-1 ms-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${strategy.title}</strong>
                            <span class="strategy-badge ${badgeClass}">${badgeText}</span>
                        </div>
                        <p class="text-muted mb-0">${strategy.description}</p>
                    </div>
                </div>
                <div class="strategy-config-options" id="config-${strategy.id}">
                    <div class="config-options-grid mt-2">
                        <div class="config-group">
                            <label for="freq-${strategy.id}">Frecuencia</label>
                            <select class="form-select" id="freq-${strategy.id}">
                                <option value="semanal">Semanal</option>
                                <option value="quincenal">Quincenal</option>
                                <option value="mensual">Mensual</option>
                                <option value="fase-completa">Fase Completa</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="days-${strategy.id}">Días de aplicación</label>
                            <select class="form-select" id="days-${strategy.id}">
                                <option value="entreno">Días de entreno</option>
                                <option value="descanso">Días de descanso</option>
                                <option value="todos">Todos los días</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(strategyElement);
            
            // Configurar evento para el checkbox
            const checkbox = strategyElement.querySelector('.strategy-checkbox');
            const configOptions = strategyElement.querySelector('.strategy-config-options');
            
            checkbox.addEventListener('change', function() {
                configOptions.style.display = this.checked ? 'block' : 'none';
                
                // Si se desmarca, resetear las configuraciones
                if (!this.checked) {
                    const freqSelect = configOptions.querySelector('select');
                    freqSelect.selectedIndex = 0;
                }
                
                // ACTUALIZAR RECOMENDACIONES CLAVE - CORREGIDO
                const recommendationsContainer = document.getElementById('recommendations-container');
                if (recommendationsContainer) {
                    if (this.checked) {
                        // Añadir recomendación específica
                        recommendationsContainer.innerHTML = agregarRecomendacionEspecifica(strategy, clasificacion);
                    } else {
                        // Eliminar recomendación específica
                        recommendationsContainer.innerHTML = eliminarRecomendacionEspecifica(strategy.id);
                    }
                } else {
                    console.error("El contenedor recommendations-container no existe en el DOM");
                }
            });
            
            // Inicialmente ocultar opciones de configuración
            configOptions.style.display = 'none';
            
            // Configurar evento para mostrar detalles al hacer clic en cualquier parte de la estrategia
            strategyElement.addEventListener('click', function(e) {
                // Evitar activar el checkbox cuando se hace clic en los selects
                if (e.target.tagName !== 'SELECT' && e.target.tagName !== 'OPTION' && 
                    !e.target.closest('.form-check-input')) {
                    checkbox.checked = !checkbox.checked;
                    configOptions.style.display = checkbox.checked ? 'block' : 'none';
                    
                    // Mostrar detalles completos de la estrategia
                    const detailsContainer = document.getElementById('macro-details-text');
                    if (detailsContainer) {
                        let detailsHTML = `
                            <h6 class="mb-2">${strategy.title}</h6>
                            <p class="mb-3">${strategy.description}</p>
                            <h6 class="mb-2">Detalles:</h6>
                            <ul class="list-group list-group-flush mb-3">
                        `;
                        
                        // Manejar features de manera segura
                        const features = strategy.features || [];
                        if (Array.isArray(features)) {
                            features.forEach(feature => {
                                detailsHTML += `<li class="list-group-item"><i class="fas fa-circle text-muted me-2" style="font-size: 0.5em;"></i> ${feature}</li>`;
                            });
                        }
                        
                        detailsHTML += `
                            </ul>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-1"></i> ${clasificacion.mensaje}
                            </div>
                        `;
                        
                        detailsContainer.innerHTML = detailsHTML;
                    }
                    
                    // ACTUALIZAR RECOMENDACIONES CLAVE - CORREGIDO
                    const recommendationsContainer = document.getElementById('recommendations-container');
                    if (recommendationsContainer) {
                        if (checkbox.checked) {
                            // Añadir recomendación específica
                            recommendationsContainer.innerHTML = agregarRecomendacionEspecifica(strategy, clasificacion);
                        } else {
                            // Eliminar recomendación específica
                            recommendationsContainer.innerHTML = eliminarRecomendacionEspecifica(strategy.id);
                        }
                    } else {
                        console.error("El contenedor recommendations-container no existe en el DOM");
                    }
                }
            });
        } catch (error) {
            console.error(`Error al renderizar estrategia ${strategy.id}:`, error);
        }
    });
}

function updateSchedulePreview() {
    const daysContainer = document.getElementById('schedule-preview');
    daysContainer.innerHTML = '';
    
    const days = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
    const selectedDays = Array.from(document.querySelectorAll('#training-days .day-option.selected'))
        .map(day => day.dataset.day);
    
    days.forEach((day, index) => {
        const dayElement = document.createElement('div');
        dayElement.className = 'schedule-day';
        
        if (selectedDays.includes(day.toLowerCase().substring(0, 3))) {
            dayElement.classList.add('training');
            dayElement.innerHTML = `${day}<br><small>Entreno</small>`;
        } else {
            dayElement.classList.add('rest');
            dayElement.innerHTML = `${day}<br><small>Descanso</small>`;
        }
        
        daysContainer.appendChild(dayElement);
    });
}

function saveConfiguration() {
    // Aquí iría la lógica para guardar la configuración
    const selectedStrategy = document.querySelector('.radio-option.selected');
    const strategyId = selectedStrategy ? selectedStrategy.dataset.strategyId : 'Ninguna';
    
    const selectedStrategies = [];
    document.querySelectorAll('.strategy-checkbox:checked').forEach(checkbox => {
        const strategyId = checkbox.id.replace('chk-', '');
        selectedStrategies.push(strategyId);
    });
    
    const trainingDays = Array.from(document.querySelectorAll('#training-days .day-option.selected'))
        .map(day => day.dataset.day);
    
    const intensity = document.querySelector('.intensity-option.selected')?.dataset.intensity || 'moderada';
    const pauseFrequency = document.getElementById('pause-frequency').value;
    const reevalFrequency = document.getElementById('reeval-frequency').value;
    
    // En una implementación real, aquí guardaríamos estos datos
    console.log('Configuración guardada:', {
        strategyId,
        selectedStrategies,
        trainingDays,
        intensity,
        pauseFrequency,
        reevalFrequency
    });
    
    // Cerrar el modal
    const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
    editModal.hide();
    
    // Mostrar mensaje de confirmación
    alert('Configuración guardada correctamente. El plan se actualizará con los nuevos parámetros.');
}

// Versión especializada que NO actualiza los detalles
function updateMacroValuesWithoutDetailsUpdate() {
    const userWeightInput = document.getElementById('user-weight');
    if (!userWeightInput) return;
    
    const weight = parseFloat(userWeightInput.value) || 70;
    
    // Obtener propósito desde objetivoGeneral con mapeo correcto
    const propositoElement = document.getElementById('objetivoGeneral');
    let proposito = 'estetica'; // Valor por defecto
    
    if (propositoElement) {
        const propositoRaw = propositoElement.value.toLowerCase();
        if (propositoRaw.includes('salud')) proposito = 'salud';
        else if (propositoRaw.includes('estet')) proposito = 'estetica';
        else if (propositoRaw.includes('rendimiento')) proposito = 'rendimiento';
    }
    
    // Obtener fase desde el modal (almacenada en data-fase)
    const modal = document.getElementById('editModal');
    const fase = modal ? modal.getAttribute('data-fase') : "Fase 1 (0-12 sem)";
    
    // Obtener objetivo desde el formulario principal
    const objetivoSelect = document.getElementById('objetivo');
    const objetivo = objetivoSelect ? objetivoSelect.value.replace('1', '') : 'perdida';
    
    // Verificar si hay una estrategia base seleccionada
    const selectedStrategy = document.querySelector('.radio-option.selected');
    
    if (selectedStrategy) {
        try {
            // Usar la función científicamente validada
            const macros = actualizarMacros(objetivo, proposito, fase, weight);
            
            // Actualizar porcentajes en los inputs
            document.getElementById('proteinas-pct').value = macros.proteinasPct;
            document.getElementById('grasa-pct').value = macros.grasasPct;
            document.getElementById('hc-pct').value = macros.hcPct;
            
            // Calcular gramos basados en calorías objetivo
            const calorieEstimate = parseInt(document.getElementById('goal-calories').value) || weight * 35;
            
            // Actualizar displays
            document.getElementById('proteinas-gr').innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: ${macros.proteinasPct}%"></div>
                    </div>
                    <span>${macros.proteinasPct}% (${macros.proteinasGr})</span>
                </div>
            `;
            
            document.getElementById('grasa-gr').innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 10px;">
                        <div class="progress-bar bg-warning" style="width: ${macros.grasasPct}%"></div>
                    </div>
                    <span>${macros.grasasPct}% (${macros.grasasGr})</span>
                </div>
            `;
            
            document.getElementById('hc-gr').innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 10px;">
                        <div class="progress-bar bg-danger" style="width: ${macros.hcPct}%"></div>
                    </div>
                    <span>${macros.hcPct}% (${macros.hcGr})</span>
                </div>
            `;
            
            // Calcular y mostrar la suma de porcentajes
            actualizarSumaPorcentajes();
            
            return; // Salir ya que usamos la lógica científica
            
        } catch (error) {
            console.error("Error al actualizar macros con propósito:", proposito, error);
        }
    }
    
    // Lógica tradicional como fallback (si no hay estrategia seleccionada)
    const proteinPct = parseInt(document.getElementById('proteinas-pct').value) || 30;
    const fatPct = parseInt(document.getElementById('grasa-pct').value) || 30;
    const carbPct = parseInt(document.getElementById('hc-pct').value) || 40;
    
    const calorieEstimate = parseInt(document.getElementById('goal-calories').value) || weight * 35;
    
    const proteinGrams = Math.round((proteinPct / 100) * calorieEstimate / 4);
    const fatGrams = Math.round((fatPct / 100) * calorieEstimate / 9);
    const carbGrams = Math.round((carbPct / 100) * calorieEstimate / 4);
    
    const proteinPerKg = (proteinGrams / weight).toFixed(2);
    const fatPerKg = (fatGrams / weight).toFixed(2);
    const carbPerKg = (carbGrams / weight).toFixed(2);
    
    // Actualizar displays
    document.getElementById('proteinas-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-success" style="width: ${proteinPct}%"></div>
            </div>
            <span>${proteinPct}% (${proteinPerKg}g/kg)</span>
        </div>
    `;
    
    document.getElementById('grasa-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-warning" style="width: ${fatPct}%"></div>
            </div>
            <span>${fatPct}% (${fatPerKg}g/kg)</span>
        </div>
    `;
    
    document.getElementById('hc-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-danger" style="width: ${carbPct}%"></div>
            </div>
            <span>${carbPct}% (${carbPerKg}g/kg)</span>
        </div>
    `;
}

// Función única y corregida - SIN DUPLICADOS
// Función única y corregida - SIN DUPLICADOS
function reiniciarRecomendaciones(estrategiaBase, propositoKey, objetivo, faseKey) {
    console.log("Iniciando reiniciarRecomendaciones", {
        estrategiaBase: estrategiaBase?.title,
        propositoKey,
        objetivo,
        faseKey
    });
    
    try {
        // ASEGURAR QUE EL ESTADO EXISTA
        if (typeof recomendacionesState === 'undefined') {
            window.recomendacionesState = {
                estrategiaBase: null,
                estrategiasEspecificas: [],
                recomendaciones: {
                    base: [],
                    especificas: {}
                }
            };
        }
        
        // ASEGURAR QUE propositoKey ESTÁ DEFINIDO
        if (!propositoKey) {
            const propositoElement = document.getElementById('objetivoGeneral');
            if (propositoElement) {
                const propositoRaw = propositoElement.value.toLowerCase();
                if (propositoRaw.includes('salud')) propositoKey = 'salud';
                else if (propositoRaw.includes('estet')) propositoKey = 'estetica';
                else if (propositoRaw.includes('rendimiento')) propositoKey = 'rendimiento';
            }
            if (!propositoKey) propositoKey = 'estetica'; // Valor por defecto
        }
        
        // ASEGURAR QUE faseKey ESTÁ DEFINIDO
        if (!faseKey) {
            const modal = document.getElementById('editModal');
            if (modal) {
                faseKey = modal.getAttribute('data-fase') || "Fase 1 (0-12 sem)";
            } else {
                faseKey = "Fase 1 (0-12 sem)";
            }
        }
        
        console.log("propositoKey determinado:", propositoKey);
        console.log("faseKey determinado:", faseKey);
        
        // Actualizar el estado
        recomendacionesState.estrategiaBase = estrategiaBase.id;
        recomendacionesState.estrategiaBaseObj = estrategiaBase;
        recomendacionesState.estrategiasEspecificas = [];
        recomendacionesState.recomendaciones = {
            base: [],
            especificas: {}
        };
        
        // MANEJO SEGURO DE obtenerRecomendacionesBase
        let recomendacionesBase = [];
        
        if (typeof obtenerRecomendacionesBase === 'function') {
            try {
                // PASAR faseKey A LA FUNCIÓN
                recomendacionesBase = obtenerRecomendacionesBase(estrategiaBase, propositoKey, objetivo, faseKey) || [];
            } catch (error) {
                console.error("Error al obtener recomendaciones base:", error);
            }
        }
        
        // Si aún no hay recomendaciones, usar recomendaciones por defecto
        if (recomendacionesBase.length === 0) {
            recomendacionesBase = [
                {
                    icon: "fas fa-sync-alt",
                    title: "Metabolic Flexibility Training",
                    text: "Implementa rotación semanal de HC (50-100g) tras 8-12 semanas para evitar adaptación metabólica"
                },
                {
                    icon: "fas fa-clock",
                    title: "Ayuno Intermitente",
                    text: "Solo tras 12 semanas de estabilidad con tu estrategia base, nunca al inicio"
                }
            ];
        }
        
        recomendacionesState.recomendaciones.base = recomendacionesBase;
        
        // USAR faseKey EN LUGAR DE "Fase 1 (0-12 sem)" FIJO
        const html = generarHTMLRecomendaciones([], estrategiaBase, faseKey, recomendacionesBase);
        console.log("HTML generado:", html);
        
        return html;
    } catch (error) {
        console.error("Error en reiniciarRecomendaciones:", error);
        return `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i> 
                    Error al generar recomendaciones: ${error.message}
                </div>
            </div>
        `;
    }
}















function obtenerRecomendacionesBase(estrategiaBase, propositoKey, objetivo, faseKey) {
    // Normalizar objetivo
    const objetivoKey = objetivo.toLowerCase().includes('perdida') ? 'perdida' :
                       objetivo.toLowerCase().includes('ganancia') ? 'ganancia' :
                       objetivo.toLowerCase().includes('mantenimiento') ? 'mantenimiento' :
                       objetivo.toLowerCase().includes('mixto') ? 'mixto' : 'perdida';
    
    // Normalizar faseKey para coincidir con la matriz
    let faseEstandarizada = faseKey;
    const faseMap = {
        '1': 'Fase 1 (0-12 sem)',
        '2': 'Fase 2 (12-24 sem)',
        '3': 'Fase 3 Avanzada (>24 sem)',
        '4': 'Fase 4 Ajuste Metabólico (>32 sem)',
        'Fase 1': 'Fase 1 (0-12 sem)',
        'Fase 2': 'Fase 2 (12-24 sem)',
        'Fase 3': 'Fase 3 Avanzada (>24 sem)',
        'Fase 4': 'Fase 4 Ajuste Metabólico (>32 sem)'
    };
    
    if (faseMap[faseKey]) {
        faseEstandarizada = faseMap[faseKey];
    }
    
    // Buscar en la nueva matriz
    if (typeof recomendacionesBaseMatriz !== 'undefined' && 
        recomendacionesBaseMatriz[objetivoKey] && 
        recomendacionesBaseMatriz[objetivoKey][faseEstandarizada] && 
        recomendacionesBaseMatriz[objetivoKey][faseEstandarizada][estrategiaBase.title]) {
        
        // Convertir el array de strings a array de objetos
        return recomendacionesBaseMatriz[objetivoKey][faseEstandarizada][estrategiaBase.title].map((rec, index) => ({
            icon: index === 0 ? "fas fa-sync-alt" : 
                  index === 1 ? "fas fa-clock" : 
                  index === 2 ? "fas fa-balance-scale" : 
                  index === 3 ? "fas fa-leaf" : 
                  "fas fa-star",
            title: `Recomendación ${index + 1}`,
            text: rec
        }));
    }
    
    // Si no hay datos en la nueva matriz, usar el sistema anterior
    let recomendacionesBase = [];
    
    if (estrategiaCompleta && estrategiaCompleta[objetivoKey] && estrategiaCompleta[objetivoKey][propositoKey]) {
        recomendacionesBase = estrategiaCompleta[objetivoKey][propositoKey].resumenEjecutivo || [];
    }
    
    if (recomendacionesBase.length === 0 && typeof obtenerRecomendacionesEstrategia === 'function') {
        recomendacionesBase = obtenerRecomendacionesEstrategia(estrategiaBase.id, propositoKey, objetivo) || [];
    }
    
    if (recomendacionesBase.length === 0) {
        recomendacionesBase = [
            {
                icon: "fas fa-sync-alt",
                title: "Metabolic Flexibility Training",
                text: "Implementa rotación semanal de HC (50-100g) tras 8-12 semanas para evitar adaptación metabólica"
            },
            {
                icon: "fas fa-clock",
                title: "Ayuno Intermitente",
                text: "Solo tras 12 semanas de estabilidad con tu estrategia base, nunca al inicio"
            }
        ];
    }
    
    return recomendacionesBase;
}
function agregarRecomendacionEspecifica(estrategiaEspecifica, clasificacion) {
    console.log("Agregando recomendación específica", {
        estrategia: estrategiaEspecifica.title,
        clasificacion: clasificacion.clasificacion
    });
    
    try {
        // Si ya existe, actualizar
        if (recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id]) {
            recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id] = {
                clasificacion: clasificacion,
                estrategia: estrategiaEspecifica
            };
        } else {
            // Añadir nueva
            recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id] = {
                clasificacion: clasificacion,
                estrategia: estrategiaEspecifica
            };
            
            // Actualizar la lista de estrategias específicas seleccionadas
            if (!recomendacionesState.estrategiasEspecificas.includes(estrategiaEspecifica.id)) {
                recomendacionesState.estrategiasEspecificas.push(estrategiaEspecifica.id);
            }
        }
        
        // Convertir el estado a formato de análisis
        const analisis = Object.values(recomendacionesState.recomendaciones.especificas).map(item => ({
            esCompatible: item.clasificacion.clasificacion !== 'contraindicada' &&
                          item.clasificacion.clasificacion !== 'no recomendada',
            clasificacion: item.clasificacion,
            estrategia: item.estrategia
        }));
        
        // Obtener la estrategia base actual
        const estrategiaBase = encontrarEstrategiaBase(recomendacionesState.estrategiaBase);
        
        // Generar HTML para mostrar
        const html = generarHTMLRecomendaciones(
            analisis,
            estrategiaBase,
            "Fase 1 (0-12 sem)",
            recomendacionesState.recomendaciones.base
        );
        
        console.log("HTML generado para agregarRecomendacionEspecifica");
        return html;
    } catch (error) {
        console.error("Error en agregarRecomendacionEspecifica:", error);
        return `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Error al agregar recomendación: ${error.message}
                </div>
            </div>
        `;
    }
}

function agregarRecomendacionEspecifica(estrategiaEspecifica, clasificacion) {
    // ASEGURAR QUE EL ESTADO EXISTA
    if (typeof recomendacionesState === 'undefined') {
        window.recomendacionesState = {
            estrategiaBase: null,
            estrategiasEspecificas: [],
            recomendaciones: {
                base: [],
                especificas: {}
            }
        };
    }
    
    // Si ya existe, actualizar
    if (recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id]) {
        recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id] = {
            clasificacion: clasificacion,
            estrategia: estrategiaEspecifica
        };
    } else {
        // Añadir nueva
        recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id] = {
            clasificacion: clasificacion,
            estrategia: estrategiaEspecifica
        };
        
        // Actualizar la lista de estrategias específicas seleccionadas
        if (!recomendacionesState.estrategiasEspecificas.includes(estrategiaEspecifica.id)) {
            recomendacionesState.estrategiasEspecificas.push(estrategiaEspecifica.id);
        }
    }
    
    // Convertir el estado a formato de análisis
    const analisis = Object.values(recomendacionesState.recomendaciones.especificas).map(item => ({
        esCompatible: item.clasificacion.clasificacion !== 'contraindicada' && 
                      item.clasificacion.clasificacion !== 'no recomendada',
        clasificacion: item.clasificacion,
        estrategia: item.estrategia
    }));
    
    // Obtener la estrategia base actual
    let estrategiaBase = recomendacionesState.estrategiaBaseObj;
    
    // Si no tenemos la estrategia completa guardada, buscarla
    if (!estrategiaBase && recomendacionesState.estrategiaBase) {
        for (const objetivo in estrategiasBaseConfig) {
            for (const fase in estrategiasBaseConfig[objetivo]) {
                const estrategias = estrategiasBaseConfig[objetivo][fase];
                const estrategia = estrategias.find(e => e.id === recomendacionesState.estrategiaBase);
                if (estrategia) {
                    estrategiaBase = estrategia;
                    recomendacionesState.estrategiaBaseObj = estrategia; // GUARDAR PARA FUTURAS USOS
                    break;
                }
            }
            if (estrategiaBase) break;
        }
    }
    
    // Generar HTML para mostrar
    return generarHTMLRecomendaciones(
        analisis, 
        estrategiaBase, 
        "Fase 1 (0-12 sem)", 
        recomendacionesState.recomendaciones.base
    );
}

function eliminarRecomendacionEspecifica(estrategiaId) {
    // ASEGURAR QUE EL ESTADO EXISTA
    if (typeof recomendacionesState === 'undefined') {
        window.recomendacionesState = {
            estrategiaBase: null,
            estrategiasEspecificas: [],
            recomendaciones: {
                base: [],
                especificas: {}
            }
        };
        return `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i> Selecciona una estrategia base para ver recomendaciones específicas.
                </div>
            </div>
        `;
    }
    
    // Eliminar de las recomendaciones específicas
    delete recomendacionesState.recomendaciones.especificas[estrategiaId];
    
    // Eliminar de la lista de estrategias específicas seleccionadas
    recomendacionesState.estrategiasEspecificas = recomendacionesState.estrategiasEspecificas.filter(id => id !== estrategiaId);
    
    // Convertir el estado a formato de análisis
    const analisis = Object.values(recomendacionesState.recomendaciones.especificas).map(item => ({
        esCompatible: item.clasificacion.clasificacion !== 'contraindicada' && 
                      item.clasificacion.clasificacion !== 'no recomendada',
        clasificacion: item.clasificacion,
        estrategia: item.estrategia
    }));
    
    // Obtener la estrategia base actual
    let estrategiaBase = recomendacionesState.estrategiaBaseObj;
    
    // Si no tenemos la estrategia completa guardada, buscarla
    if (!estrategiaBase && recomendacionesState.estrategiaBase) {
        for (const objetivo in estrategiasBaseConfig) {
            for (const fase in estrategiasBaseConfig[objetivo]) {
                const estrategias = estrategiasBaseConfig[objetivo][fase];
                const estrategia = estrategias.find(e => e.id === recomendacionesState.estrategiaBase);
                if (estrategia) {
                    estrategiaBase = estrategia;
                    recomendacionesState.estrategiaBaseObj = estrategia; // GUARDAR PARA FUTURAS USOS
                    break;
                }
            }
            if (estrategiaBase) break;
        }
    }
    
    // Generar HTML para mostrar
    return generarHTMLRecomendaciones(
        analisis, 
        estrategiaBase, 
        "Fase 1 (0-12 sem)", 
        recomendacionesState.recomendaciones.base
    );
}

function eliminarRecomendacionEspecifica(estrategiaId) {
    // ✅ ASEGURAR QUE EL ESTADO EXISTA
    if (typeof recomendacionesState === 'undefined') {
        window.recomendacionesState = {
            estrategiaBase: null,
            estrategiasEspecificas: [],
            recomendaciones: {
                base: [],
                especificas: {}
            }
        };
        return `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i> Selecciona una estrategia base para ver recomendaciones específicas.
                </div>
            </div>
        `;
    }
    
    // Eliminar de las recomendaciones específicas
    delete recomendacionesState.recomendaciones.especificas[estrategiaId];
    
    // Eliminar de la lista de estrategias específicas seleccionadas
    recomendacionesState.estrategiasEspecificas = recomendacionesState.estrategiasEspecificas.filter(id => id !== estrategiaId);
    
    // Convertir el estado a formato de análisis
    const analisis = Object.values(recomendacionesState.recomendaciones.especificas).map(item => ({
        esCompatible: item.clasificacion.clasificacion !== 'contraindicada' && 
                      item.clasificacion.clasificacion !== 'no recomendada',
        clasificacion: item.clasificacion,
        estrategia: item.estrategia
    }));
    
    // ✅ OBTENER LA ESTRATEGIA BASE DE FORMA EFICIENTE
    let estrategiaBase = recomendacionesState.estrategiaBaseObj;
    
    // Si no tenemos la estrategia completa guardada, buscarla
    if (!estrategiaBase && recomendacionesState.estrategiaBase) {
        for (const objetivo in estrategiasBaseConfig) {
            for (const fase in estrategiasBaseConfig[objetivo]) {
                const estrategias = estrategiasBaseConfig[objetivo][fase];
                const estrategia = estrategias.find(e => e.id === recomendacionesState.estrategiaBase);
                if (estrategia) {
                    estrategiaBase = estrategia;
                    recomendacionesState.estrategiaBaseObj = estrategia; // ✅ GUARDAR PARA FUTURAS USOS
                    break;
                }
            }
            if (estrategiaBase) break;
        }
    }
    
    // Generar HTML para mostrar
    return generarHTMLRecomendaciones(
        analisis, 
        estrategiaBase, 
        "Fase 1 (0-12 sem)", 
        recomendacionesState.recomendaciones.base
    );
}

function encontrarEstrategiaBase(strategyId) {
    console.log("Buscando estrategia base", { strategyId });
    
    try {
        // Buscar en todas las categorías de estrategias base
        for (const objetivo in estrategiasBaseConfig) {
            for (const fase in estrategiasBaseConfig[objetivo]) {
                const estrategias = estrategiasBaseConfig[objetivo][fase];
                const estrategia = estrategias.find(e => e.id === strategyId);
                if (estrategia) {
                    console.log("Estrategia base encontrada", { title: estrategia.title });
                    return estrategia;
                }
            }
        }
        
        console.warn("No se encontró la estrategia base");
        return null;
    } catch (error) {
        console.error("Error al encontrar estrategia base:", error);
        return null;
    }
}




function generarRecomendacionesClave(objetivo, proposito, strategyId = null) {
    if (!objetivo || !proposito) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Selecciona una estrategia base para ver recomendaciones específicas.</div></div>`;
    }
    
    // Si hay una estrategia base seleccionada, obtener sus recomendaciones específicas
    if (strategyId) {
        const recomendacionesEstrategia = obtenerRecomendacionesEstrategia(strategyId, proposito, objetivo);
        
        if (recomendacionesEstrategia && Array.isArray(recomendacionesEstrategia) && recomendacionesEstrategia.length > 0) {
            const items = recomendacionesEstrategia.map(rec => `
                <div class="recommendation-item mb-3">
                    <div class="d-flex">
                        <i class="${rec.icon} me-2 mt-1" style="color: #5e9a4f; width: 20px;"></i>
                        <div>
                            <h6 class="mb-1">${rec.title}</h6>
                            <p class="mb-0">${rec.text}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="recommendations-section">
                    <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Específicas</h6>
                    ${items}
                </div>
            `;
        }
    }
    
    // Si no hay estrategia base seleccionada o no tiene recomendaciones específicas,
    // mostrar las recomendaciones genéricas para el objetivo y propósito
    
    // Normalizar objetivo y propósito
    const objetivoNormalizado = objetivo.toLowerCase();
    const propositoNormalizado = proposito.toLowerCase();
    
    // Encontrar las claves correctas
    let objetivoKey;
    if (objetivoNormalizado.includes('perdida')) objetivoKey = 'perdida';
    else if (objetivoNormalizado.includes('ganancia')) objetivoKey = 'ganancia';
    else if (objetivoNormalizado.includes('mantenimiento')) objetivoKey = 'mantenimiento';
    else if (objetivoNormalizado.includes('mixto')) objetivoKey = 'mixto';
    
    let propositoKey;
    if (propositoNormalizado.includes('salud')) propositoKey = 'salud';
    else if (propositoNormalizado.includes('estet')) propositoKey = 'estetica';
    else if (propositoNormalizado.includes('rendimiento')) propositoKey = 'rendimiento';
    
    // Si no encontramos coincidencias, usar valores por defecto
    if (!objetivoKey || !propositoKey) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Selecciona una estrategia base para ver recomendaciones específicas.</div></div>`;
    }
    
    // Obtener el resumen ejecutivo
    const resumen = estrategiaCompleta[objetivoKey]?.[propositoKey]?.resumenEjecutivo || [];
    
    // Si no hay resumen ejecutivo, mostrar mensaje
    if (resumen.length === 0) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Key Points</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>No hay recomendaciones clave específicas para esta combinación.</div></div>`;
    }
    
    const items = resumen.map(rec => `
        <div class="recommendation-item mb-3">
            <div class="d-flex">
                <i class="${rec.icon} me-2 mt-1" style="color: #5e9a4f; width: 20px;"></i>
                <div>
                    <h6 class="mb-1">${rec.title}</h6>
                    <p class="mb-0">${rec.text}</p>
                </div>
            </div>
        </div>
    `).join('');
    
    return `
        <div class="recommendations-section">
            <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
            ${items}
        </div>
    `;
}





function renderOptimalStrategyContent(objetivo, proposito, strategyId, fase) {
    // Buscar el contenedor específico que tienes en tu HTML
    const contentContainer = document.getElementById('optimal-strategy-content');
    if (!contentContainer) {
        console.error("No se encontró el contenedor #optimal-strategy-content para Estrategia Óptima");
        return;
    }
    
    try {
        // Si no hay estrategia base seleccionada, mostrar mensaje informativo
        if (!strategyId) {
            contentContainer.innerHTML = `
                <div class="alert alert-info mt-2">
                    <i class="fas fa-info-circle me-1"></i> 
                    Selecciona una estrategia base para ver la Estrategia Óptima personalizada.
                </div>
            `;
            return;
        }
        
        // Mapear el objetivo a los nombres correctos en estrategiaCompleta
        const objetivoMap = {
            'perdida': 'perdida',
            'ganancia': 'ganancia',
            'mantenimiento': 'mantenimiento',
            'mixto': 'mixto'
        };
        
        // Mapear el propósito a los nombres correctos en estrategiaCompleta
        const propositoMap = {
            'salud': 'salud',
            'estetica': 'estetica',
            'rendimiento': 'rendimiento'
        };
        
        // Obtener el objetivo y propósito mapeados
        const objetivoKey = objetivoMap[objetivo] || 'perdida';
        const propositoKey = propositoMap[proposito] || 'estetica';
        
        // Obtener el análisis completo de la matriz
        const analisis = estrategiaCompleta[objetivoKey]?.[propositoKey]?.analisisCompleto;
        
        if (!analisis) {
            contentContainer.innerHTML = `
                <div class="alert alert-warning mt-2">
                    <i class="fas fa-exclamation-triangle me-1"></i> 
                    No se encontró información para esta combinación de objetivo y propósito.
                </div>
            `;
            return;
        }
        
        // Generar HTML para la sección Estrategia Óptima
        let html = `
            <div class="optimal-strategy-section mb-4">
                <!--<h5 class="text-muted mb-3"><i class="fas fa-chart-line me-2" style="color: #5e9a4f;"></i> Estrategia Óptima</h5>-->
        `;
        
        // 1. Sección de Conclusión
        if (analisis.conclusion) {
            html += `
                <div class="conclusion-section mb-4">
                    <h6 class="text-success mb-2"><i class="fas fa-check-circle me-1"></i> Conclusión</h6>
                    <div class="alert alert-success">
                        ${analisis.conclusion}
                    </div>
                </div>
            `;
        }
        
        // 2. Sección de Contraindicaciones
        if (analisis.contraindicaciones && analisis.contraindicaciones.length > 0) {
            html += `
                <div class="contraindicaciones-section mb-4">
                    <h6 class="text-danger mb-2"><i class="fas fa-exclamation-triangle me-1"></i> Contraindicaciones</h6>
                    <ul class="list-group list-group-flush">`;
            
            analisis.contraindicaciones.forEach(contraindicacion => {
                html += `
                    <li class="list-group-item bg-light p-2">
                        <i class="fas fa-times-circle text-danger me-1"></i> 
                        ${contraindicacion}
                    </li>`;
            });
            
            html += `
                    </ul>
                </div>`;
        }
        
        // 3. Sección de Errores Críticos
        if (analisis.erroresCriticos && analisis.erroresCriticos.length > 0) {
            html += `
                <div class="errores-criticos-section mb-4">
                    <h6 class="text-warning mb-2"><i class="fas fa-exclamation-circle me-1"></i> Errores Críticos</h6>
                    <div class="accordion" id="erroresCriticosAccordion">`;
            
            analisis.erroresCriticos.forEach((error, index) => {
                const idCollapse = `errorCollapse${index}`;
                const idHeading = `errorHeading${index}`;
                
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="${idHeading}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${idCollapse}" aria-expanded="false" aria-controls="${idCollapse}">
                                ${error.titulo}
                            </button>
                        </h2>
                        <div id="${idCollapse}" class="accordion-collapse collapse" aria-labelledby="${idHeading}" data-bs-parent="#erroresCriticosAccordion">
                            <div class="accordion-body">
                                <p>${error.descripcion}</p>
                                ${error.fuente ? `<small class="text-muted">${error.fuente}</small>` : ''}
                            </div>
                        </div>
                    </div>`;
            });
            
            html += `
                    </div>
                </div>`;
        }
        
        html += `
            </div>
        `;
        
        contentContainer.innerHTML = html;
        
        // Inicializar los acordeones de Bootstrap
        const accordions = contentContainer.querySelectorAll('.accordion');
        accordions.forEach(accordion => {
            new bootstrap.Collapse(accordion);
        });
    } catch (error) {
        console.error("Error al renderizar Estrategia Óptima:", error);
        contentContainer.innerHTML = `
            <div class="alert alert-danger mt-2">
                <i class="fas fa-exclamation-triangle me-1"></i> 
                Error al generar contenido de Estrategia Óptima: ${error.message}
            </div>
        `;
    }
}
// ===== FUNCIONES NUEVAS PARA VALIDACIÓN DE MACROS =====
function normalizarEstructuraMacros(estrategiaBase, proposito) {
    // Obtener los macros para el propósito especificado
    const macrosBase = estrategiaBase.macros[`macros${proposito.charAt(0).toUpperCase() + proposito.slice(1)}`];
    
    // Si ya tiene la estructura completa (diasEntreno y diasDescanso), devolverla
    if (macrosBase.diasDescanso && macrosBase.diasEntreno) {
        return macrosBase;
    }
    
    // Caso especial: Formato de texto con "Días descanso: ... | Días entreno: ..."
    if (typeof macrosBase.proteinGr === 'string' && macrosBase.proteinGr.includes('|')) {
        const diasDescansoMatch = macrosBase.proteinGr.match(/Días descanso: ([^|]+)/);
        const diasEntrenoMatch = macrosBase.proteinGr.match(/Días entreno: ([^|]+)/);
        
        return {
            diasDescanso: {
                proteinPct: macrosBase.proteinPct,
                fatPct: macrosBase.fatPct,
                carbPct: macrosBase.carbPct,
                proteinGr: diasDescansoMatch ? diasDescansoMatch[1].trim() : macrosBase.proteinGr,
                carbinGr: macrosBase.carbinGr.includes('|') ? 
                    macrosBase.carbinGr.match(/Días descanso: ([^|]+)/)[1].trim() : macrosBase.carbinGr,
                fatinGr: macrosBase.fatinGr.includes('|') ? 
                    macrosBase.fatinGr.match(/Días descanso: ([^|]+)/)[1].trim() : macrosBase.fatinGr
            },
            diasEntreno: {
                proteinPct: macrosBase.proteinPct,
                fatPct: macrosBase.fatPct,
                carbPct: macrosBase.carbPct,
                proteinGr: diasEntrenoMatch ? diasEntrenoMatch[1].trim() : macrosBase.proteinGr,
                carbinGr: macrosBase.carbinGr.includes('|') ? 
                    macrosBase.carbinGr.match(/Días entreno: ([^|]+)/)[1].trim() : macrosBase.carbinGr,
                fatinGr: macrosBase.fatinGr.includes('|') ? 
                    macrosBase.fatinGr.match(/Días entreno: ([^|]+)/)[1].trim() : macrosBase.fatinGr
            }
        };
    }
    
    // Caso especial: Formato con semanas (semanasBajasHC, semanasAltasHC, etc.)
    if (macrosBase.semanasBajasHC || macrosBase.semanasMediasHC || macrosBase.semanasAltasHC) {
        return {
            diasDescanso: macrosBase.semanasBajasHC || macrosBase.semanasMediasHC || macrosBase,
            diasEntreno: macrosBase.semanasAltasHC || macrosBase
        };
    }
    
    // Caso especial: Formato con tipos de entrenamiento (fuerza, resistencia)
    if (macrosBase.fuerza || macrosBase.resistencia) {
        return {
            diasDescanso: macrosBase.resistencia || macrosBase,
            diasEntreno: macrosBase.fuerza || macrosBase
        };
    }
    
    // Caso especial: Formato con días de déficit/superávit
    if (macrosBase.diasDeficit || macrosBase.diasSuperavit) {
        return {
            diasDescanso: macrosBase.diasDeficit || macrosBase,
            diasEntreno: macrosBase.diasSuperavit || macrosBase
        };
    }
    
    // Si no hay diferenciación, crear una estructura estándar
    return {
        diasDescanso: macrosBase,
        diasEntreno: macrosBase
    };
}
function actualizarSumaPorcentajes() {
    const proteinPct = parseInt(document.getElementById('proteinas-pct').value) || 0;
    const fatPct = parseInt(document.getElementById('grasa-pct').value) || 0;
    const carbPct = parseInt(document.getElementById('hc-pct').value) || 0;
    const total = proteinPct + fatPct + carbPct;
    
    // Mostrar suma de porcentajes
    const sumaElement = document.getElementById('macros-total');
    if (sumaElement) {
        sumaElement.textContent = total;
        
        // Cambiar color según validez
        if (total === 100) {
            sumaElement.className = 'badge bg-success';
        } else {
            sumaElement.className = 'badge bg-warning';
        }
    }
    
    // Actualizar advertencias
    actualizarAdvertenciasMacros(proteinPct, fatPct, carbPct);
    
    // Actualizar gramos por kg
    actualizarGramosPorKg();
}

// Configurar eventos para actualizar la suma cuando cambian los inputs
document.addEventListener('DOMContentLoaded', function() {
    const proteinInput = document.getElementById('proteinas-pct');
    const fatInput = document.getElementById('grasa-pct');
    const carbInput = document.getElementById('hc-pct');
    
    if (proteinInput) {
        proteinInput.addEventListener('input', actualizarSumaPorcentajes);
    }
    if (fatInput) {
        fatInput.addEventListener('input', actualizarSumaPorcentajes);
    }
    if (carbInput) {
        carbInput.addEventListener('input', actualizarSumaPorcentajes);
    }
    
    // Inicializar la suma
    setTimeout(actualizarSumaPorcentajes, 100);
});

function actualizarAdvertenciasMacros(proteinPct, fatPct, carbPct) {
    const warningsContainer = document.getElementById('macro-warnings');
    if (!warningsContainer) return;
    let warnings = [];
    
    // Verificar rangos saludables generales
    if (proteinPct < 15 || proteinPct > 40) {
        warnings.push("⚠️ Proteínas fuera del rango saludable general (15-40%)");
    }
    if (fatPct < 15 || fatPct > 70) {
        warnings.push("⚠️ Grasas fuera del rango saludable general (15-70%)");
    }
    if (carbPct < 5 || carbPct > 70) {
        warnings.push("⚠️ HC fuera del rango saludable general (5-70%)");
    }
    
    // Obtener la estrategia base seleccionada
    const selectedStrategy = document.querySelector('.radio-option.selected');
    if (selectedStrategy) {
        const strategyId = selectedStrategy.dataset.strategyId;
        
        // Buscar la estrategia en los objetos de configuración
        const modal = document.getElementById('editModal');
        const fase = modal ? modal.getAttribute('data-fase') : "Fase 1 (0-12 sem)";
        const objetivoSelect = document.getElementById('objetivo');
        const objetivo = objetivoSelect ? objetivoSelect.value.replace('1', '') : 'perdida';
        
        // Obtener propósito
        const propositoElement = document.getElementById('objetivoGeneral');
        let proposito = 'estetica';
        if (propositoElement) {
            const propositoRaw = propositoElement.value.toLowerCase();
            if (propositoRaw.includes('salud')) proposito = 'salud';
            else if (propositoRaw.includes('estet')) proposito = 'estetica';
            else if (propositoRaw.includes('rendimiento')) proposito = 'rendimiento';
        }
        
        try {
            // Buscar la configuración específica de la estrategia
            const faseConfig = estrategiasBaseConfig[objetivo][fase].find(item => 
                item.id === strategyId && item.aplicable.includes(objetivo)
            );
            
            if (faseConfig) {
                const macros = faseConfig.macros;
                let macrosSeleccionados;
                
                switch(proposito) {
                    case 'salud':
                        macrosSeleccionados = macros.macrosSalud;
                        break;
                    case 'estetica':
                        macrosSeleccionados = macros.macrosEstetica;
                        break;
                    case 'rendimiento':
                        macrosSeleccionados = macros.macrosRendimiento;
                        break;
                    default:
                        macrosSeleccionados = macros.macrosEstetica;
                }
                
                // Función auxiliar para extraer rangos
                const getRango = (rangoStr) => {
                    if (typeof rangoStr !== 'string') return { min: 0, max: 100 };
                    
                    const match = rangoStr.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
                    if (match) {
                        return {
                            min: parseFloat(match[1]),
                            max: parseFloat(match[2])
                        };
                    }
                    
                    // Para casos especiales como "60-70% (días entrenamiento)| 25-35% (días descanso)"
                    if (rangoStr.includes('|')) {
                        const partes = rangoStr.split('|');
                        const primeraParte = partes[0].trim();
                        const matchPrimera = primeraParte.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
                        if (matchPrimera) {
                            return {
                                min: parseFloat(matchPrimera[1]),
                                max: parseFloat(matchPrimera[2])
                            };
                        }
                    }
                    
                    // Para casos con valores únicos
                    const simpleMatch = rangoStr.match(/(\d+\.?\d*)/);
                    if (simpleMatch) {
                        const valor = parseFloat(simpleMatch[1]);
                        return { min: valor, max: valor };
                    }
                    
                    return { min: 0, max: 100 };
                };
                
                // Verificar proteínas
                const proteinRange = getRango(macrosSeleccionados.proteinPct);
                if (proteinPct < proteinRange.min || proteinPct > proteinRange.max) {
                    warnings.push(`⚠️ Proteínas fuera del rango óptimo para esta estrategia (${proteinRange.min}-${proteinRange.max}%)`);
                }
                
                // Verificar grasas
                const fatRange = getRango(macrosSeleccionados.fatPct);
                if (fatPct < fatRange.min || fatPct > fatRange.max) {
                    warnings.push(`⚠️ Grasas fuera del rango óptimo para esta estrategia (${fatRange.min}-${fatRange.max}%)`);
                }
                
                // Verificar HC
                const carbRange = getRango(macrosSeleccionados.carbPct);
                if (carbPct < carbRange.min || carbPct > carbRange.max) {
                    warnings.push(`⚠️ HC fuera del rango óptimo para esta estrategia (${carbRange.min}-${carbRange.max}%)`);
                }
            }
        } catch (error) {
            console.error("Error al verificar rangos óptimos:", error);
        }
    }
    
    // Actualizar el contenedor de advertencias
    if (warnings.length > 0) {
        warningsContainer.innerHTML = warnings.join('<br>');
        warningsContainer.style.display = 'block';
    } else {
        warningsContainer.style.display = 'none';
    }
}

function actualizarGramosPorKg() {
    const proteinPct = parseInt(document.getElementById('proteinas-pct').value) || 0;
    const fatPct = parseInt(document.getElementById('grasa-pct').value) || 0;
    const carbPct = parseInt(document.getElementById('hc-pct').value) || 0;
    
    const userWeightInput = document.getElementById('user-weight');
    const weight = userWeightInput ? parseFloat(userWeightInput.value) || 70 : 70;
    
    // Obtener el GET real desde el campo de calorías objetivo
    const goalCaloriesInput = document.getElementById('goal-calories');
    let calorieEstimate = weight * 35; // Valor por defecto
    
    if (goalCaloriesInput && goalCaloriesInput.value) {
        const goalCalories = parseInt(goalCaloriesInput.value);
        if (!isNaN(goalCalories) && goalCalories > 0) {
            calorieEstimate = goalCalories;
        }
    }
    
    // Calcular gramos totales
    const proteinGrams = Math.round((proteinPct / 100) * calorieEstimate / 4);
    const fatGrams = Math.round((fatPct / 100) * calorieEstimate / 9);
    const carbGrams = Math.round((carbPct / 100) * calorieEstimate / 4);
    
    // Calcular gramos por kg
    const proteinPerKg = (proteinGrams / weight).toFixed(1);
    const fatPerKg = (fatGrams / weight).toFixed(1);
    const carbPerKg = (carbGrams / weight).toFixed(1);
    
    // Formatear la salida como "XX% (YYYg: ZZ.Zg/kg)"
    document.getElementById('proteinas-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-success" style="width: ${proteinPct}%"></div>
            </div>
            <span>${proteinPct}% <small class="text-muted" style="font-size: 0.85em;">(${proteinGrams}g: ${proteinPerKg}g/kg)</small></span>
        </div>
    `;
    
    document.getElementById('grasa-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-warning" style="width: ${fatPct}%"></div>
            </div>
            <span>${fatPct}% <small class="text-muted" style="font-size: 0.85em;">(${fatGrams}g: ${fatPerKg}g/kg)</small></span>
        </div>
    `;
    
    document.getElementById('hc-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-danger" style="width: ${carbPct}%"></div>
            </div>
            <span>${carbPct}% <small class="text-muted" style="font-size: 0.85em;">(${carbGrams}g: ${carbPerKg}g/kg)</small></span>
        </div>
    `;
}
function actualizarSumaPorcentajesPausa() {
    const proteinPct = parseInt(document.getElementById('proteinas-pausa-pct').value) || 0;
    const fatPct = parseInt(document.getElementById('grasas-pausa-pct').value) || 0;
    const carbPct = parseInt(document.getElementById('hc-pausa-pct').value) || 0;
    
    const total = proteinPct + fatPct + carbPct;
    
    // Mostrar suma de porcentajes
    const sumaElement = document.getElementById('macros-pausa-total');
    if (sumaElement) {
        sumaElement.textContent = total;
        
        // Cambiar color según validez
        if (Math.abs(total - 100) < 0.5) {
            sumaElement.className = 'badge bg-success';
        } else {
            sumaElement.className = 'badge bg-warning';
        }
    }
    
    // Actualizar advertencias
    actualizarAdvertenciasMacrosPausa(proteinPct, fatPct, carbPct);
    
    // Actualizar gramos por kg
    actualizarGramosPorKgPausa();
}

function actualizarAdvertenciasMacrosPausa(proteinPct, fatPct, carbPct) {
    const warningsContainer = document.getElementById('macro-pausa-warnings');
    if (!warningsContainer) return;
    
    let warnings = [];
    
    // Verificar rangos saludables para pausas
    if (proteinPct < 15 || proteinPct > 25) {
        warnings.push("⚠️ Proteínas fuera del rango saludable para pausas (15-25%)");
    }
    if (fatPct < 25 || fatPct > 45) {
        warnings.push("⚠️ Grasas fuera del rango saludable para pausas (15-45%)");
    }
    if (carbPct < 25 || carbPct > 50) {
        warnings.push("⚠️ HC fuera del rango saludable para pausas (25-50%)");
    }
    
    // Verificar consistencia con la fase actual
    const modal = document.getElementById('editModal');
    const fase = modal ? modal.getAttribute('data-fase') : "Fase 1 (0-12 sem)";
    
    // Para fases avanzadas, los rangos pueden ser diferentes
    if (fase.includes("Avanzada") || fase.includes("Ajuste Metabólico")) {
        if (proteinPct < 20 || proteinPct > 30) {
            warnings.push("⚠️ En fases avanzadas, el rango óptimo de proteínas es 20-30%");
        }
        if (fatPct < 25 || fatPct > 40) {
            warnings.push("⚠️ En fases avanzadas, el rango óptimo de grasas es 25-40%");
        }
        if (carbPct < 30 || carbPct > 45) {
            warnings.push("⚠️ En fases avanzadas, el rango óptimo de HC es 30-45%");
        }
    }
    // Verificar suma
    const total = proteinPct + fatPct + carbPct;
    if (Math.abs(total - 100) > 2) {
        warnings.push(`⚠️ La suma de porcentajes es ${total}%, debería ser cercano a 100%`);
    }
	
    // Actualizar el contenedor de advertencias
    if (warnings.length > 0) {
        warningsContainer.innerHTML = warnings.join('<br>');
        warningsContainer.style.display = 'block';
    } else {
        warningsContainer.style.display = 'none';
    }
}

function actualizarGramosPorKgPausa() {
    const userWeightInput = document.getElementById('user-weight');
    const weight = userWeightInput ? parseFloat(userWeightInput.value) || 70 : 70;
    
    // Obtener porcentajes actuales
    const proteinPct = parseInt(document.getElementById('proteinas-pausa-pct').value) || 0;
    const fatPct = parseInt(document.getElementById('grasas-pausa-pct').value) || 0;
    const carbPct = parseInt(document.getElementById('hc-pausa-pct').value) || 0;
    
    // ✅ OBTENER EL GET REAL (NO USAR weight * 35 COMO VALOR POR DEFECTO)
    const goalCaloriesInput = document.getElementById('goal-calories');
    let calorieEstimate = weight * 35; // Valor por defecto
    
    if (goalCaloriesInput && goalCaloriesInput.value) {
        const goalCalories = parseInt(goalCaloriesInput.value);
        if (!isNaN(goalCalories) && goalCalories > 0) {
            calorieEstimate = goalCalories;
        }
    }
    
    // ✅ CALCULAR GRAMOS TOTALES PRIMERO
    const proteinGrams = Math.round((proteinPct / 100) * calorieEstimate / 4);
    const fatGrams = Math.round((fatPct / 100) * calorieEstimate / 9);
    const carbGrams = Math.round((carbPct / 100) * calorieEstimate / 4);
    
    // ✅ CALCULAR GRAMOS POR KG (DIVIDIENDO LOS GRAMOS TOTALES ENTRE EL PESO)
    const proteinPerKg = (proteinGrams / weight).toFixed(1);
    const fatPerKg = (fatGrams / weight).toFixed(1);
    const carbPerKg = (carbGrams / weight).toFixed(1);
    
    // Actualizar los elementos de visualización
    const proteinGrDisplay = document.getElementById('proteinas-pausa-gr');
    const fatGrDisplay = document.getElementById('grasas-pausa-gr');
    const carbGrDisplay = document.getElementById('hc-pausa-gr');
    
    if (proteinGrDisplay) {
        proteinGrDisplay.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-success" style="width: ${proteinPct}%"></div>
                </div>
                <span>${proteinPct}% <small class="text-muted" style="font-size: 0.85em;">(${proteinGrams}g: ${proteinPerKg}g/kg)</small></span>
            </div>
        `;
    }
    
    if (fatGrDisplay) {
        fatGrDisplay.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-warning" style="width: ${fatPct}%"></div>
                </div>
                <span>${fatPct}% <small class="text-muted" style="font-size: 0.85em;">(${fatGrams}g: ${fatPerKg}g/kg)</small></span>
            </div>
        `;
    }
    
    if (carbGrDisplay) {
        carbGrDisplay.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-danger" style="width: ${carbPct}%"></div>
                </div>
                <span>${carbPct}% <small class="text-muted" style="font-size: 0.85em;">(${carbGrams}g: ${carbPerKg}g/kg)</small></span>
            </div>
        `;
    }
}
function setupPausaMacroListeners() {
    const proteinPausaInput = document.getElementById('proteinas-pausa-pct');
    const fatPausaInput = document.getElementById('grasas-pausa-pct');
    const carbPausaInput = document.getElementById('hc-pausa-pct');
    
    // Función para retrasar la actualización y evitar demasiadas llamadas
    const debouncedUpdate = debounce(actualizarSumaPorcentajesPausa, 200);
    
    if (proteinPausaInput && fatPausaInput && carbPausaInput) {
        // Configurar listeners para los inputs de pausa
        proteinPausaInput.addEventListener('input', debouncedUpdate);
        fatPausaInput.addEventListener('input', debouncedUpdate);
        carbPausaInput.addEventListener('input', debouncedUpdate);
        
        // Configurar validación de rango para cada input
        [proteinPausaInput, fatPausaInput, carbPausaInput].forEach(input => {
            input.addEventListener('change', function() {
                // Asegurar que los valores estén dentro de rangos razonables
                const value = parseInt(this.value);
                if (value < 5) this.value = 5;
                if (value > 80) this.value = 80;
                
                // Forzar actualización después de corregir valores
                actualizarSumaPorcentajesPausa();
            });
        });
    }
}
function actualizarValoresInicialesPausa(peso) {
    // Valores predeterminados para pausa
    const valoresPausa = {
        proteinPct: 20,
        fatPct: 35,
        carbPct: 45
    };
    
    // Actualizar inputs
    const proteinPctInput = document.getElementById('proteinas-pausa-pct');
    const fatPctInput = document.getElementById('grasas-pausa-pct');
    const carbPctInput = document.getElementById('hc-pausa-pct');
    
    if (proteinPctInput) proteinPctInput.value = valoresPausa.proteinPct;
    if (fatPctInput) fatPctInput.value = valoresPausa.fatPct;
    if (carbPctInput) carbPctInput.value = valoresPausa.carbPct;
    
    // Actualizar visualización
    actualizarSumaPorcentajesPausa();
}
// Función auxiliar para debounce
function debounce(func, wait) {
    let timeout;
    return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            func.apply(context, args);
        }, wait);
    };
}
function formatStrategyDetails(detailsText, objetivo, proposito) {
    // Manejar caso donde detailsText es undefined o null
    if (!detailsText || typeof detailsText !== 'string') {
        return '<div class="strategy-main-text text-muted">No hay detalles disponibles para esta estrategia.</div>';
    }
    
    // Dividir el texto en secciones
    let sections = {
        main: "",
        strategies: "",
        warnings: "",
        criticalErrors: "",
        example: ""
    };
    
    // Normalizar saltos de línea para un procesamiento consistente
    const normalizedText = detailsText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    
    // Detectar y separar las diferentes secciones
    if (normalizedText.includes("ESTRATEGIAS ESPECÍFICAS RECOMENDADAS:")) {
        const parts = normalizedText.split("ESTRATEGIAS ESPECÍFICAS RECOMENDADAS:");
        sections.main = parts[0].trim();
        
        if (parts[1]?.includes("ADVERTENCIAS CIENTÍFICAS:")) {
            const strategyParts = parts[1].split("ADVERTENCIAS CIENTÍFICAS:");
            sections.strategies = strategyParts[0].trim();
            
            if (strategyParts[1]?.includes("ERRORES CRÍTICOS:")) {
                const warningParts = strategyParts[1].split("ERRORES CRÍTICOS:");
                sections.warnings = warningParts[0].trim();
                
                if (warningParts[1]?.includes("EJEMPLO PARA")) {
                    const errorParts = warningParts[1].split("EJEMPLO PARA");
                    sections.criticalErrors = errorParts[0].trim();
                    sections.example = "EJEMPLO PARA" + errorParts[1].trim();
                } else {
                    sections.criticalErrors = warningParts[1]?.trim() || "";
                }
            } else if (strategyParts[1]?.includes("EJEMPLO PARA")) {
                const warningParts = strategyParts[1].split("EJEMPLO PARA");
                sections.warnings = warningParts[0].trim();
                sections.example = "EJEMPLO PARA" + warningParts[1].trim();
            } else {
                sections.warnings = strategyParts[1]?.trim() || "";
            }
        } else if (parts[1]?.includes("ERRORES CRÍTICOS:")) {
            const strategyParts = parts[1].split("ERRORES CRÍTICOS:");
            sections.strategies = strategyParts[0].trim();
            
            if (strategyParts[1]?.includes("EJEMPLO PARA")) {
                const errorParts = strategyParts[1].split("EJEMPLO PARA");
                sections.criticalErrors = errorParts[0].trim();
                sections.example = "EJEMPLO PARA" + errorParts[1].trim();
            } else {
                sections.criticalErrors = strategyParts[1]?.trim() || "";
            }
        } else if (parts[1]?.includes("EJEMPLO PARA")) {
            const strategyParts = parts[1].split("EJEMPLO PARA");
            sections.strategies = strategyParts[0].trim();
            sections.example = "EJEMPLO PARA" + strategyParts[1].trim();
        } else {
            sections.strategies = parts[1]?.trim() || "";
        }
    } else if (normalizedText.includes("ADVERTENCIAS CIENTÍFICAS:")) {
        const parts = normalizedText.split("ADVERTENCIAS CIENTÍFICAS:");
        sections.main = parts[0].trim();
        
        if (parts[1]?.includes("ERRORES CRÍTICOS:")) {
            const warningParts = parts[1].split("ERRORES CRÍTICOS:");
            sections.warnings = warningParts[0].trim();
            
            if (warningParts[1]?.includes("EJEMPLO PARA")) {
                const errorParts = warningParts[1].split("EJEMPLO PARA");
                sections.criticalErrors = errorParts[0].trim();
                sections.example = "EJEMPLO PARA" + errorParts[1].trim();
            } else {
                sections.criticalErrors = warningParts[1]?.trim() || "";
            }
        } else if (parts[1]?.includes("EJEMPLO PARA")) {
            const warningParts = parts[1].split("EJEMPLO PARA");
            sections.warnings = warningParts[0].trim();
            sections.example = "EJEMPLO PARA" + warningParts[1].trim();
        } else {
            sections.warnings = parts[1]?.trim() || "";
        }
    } else if (normalizedText.includes("ERRORES CRÍTICOS:")) {
        const parts = normalizedText.split("ERRORES CRÍTICOS:");
        sections.main = parts[0].trim();
        
        if (parts[1]?.includes("EJEMPLO PARA")) {
            const errorParts = parts[1].split("EJEMPLO PARA");
            sections.criticalErrors = errorParts[0].trim();
            sections.example = "EJEMPLO PARA" + errorParts[1].trim();
        } else {
            sections.criticalErrors = parts[1]?.trim() || "";
        }
    } else if (normalizedText.includes("EJEMPLO PARA")) {
        const parts = normalizedText.split("EJEMPLO PARA");
        sections.main = parts[0].trim();
        sections.example = "EJEMPLO PARA" + parts[1].trim();
    } else {
        sections.main = normalizedText;
    }

		// ✅ ELIMINAR EL EJEMPLO DE CÁLCULO DEL TEXTO DE DETALLES
    // Ya no queremos que aparezca en el texto principal
    sections.example = "";

    // Generar secciones dinámicas
    const seccionesDinamicas = generarSeccionesDinamicas(objetivo, proposito);
    
    // Construir el HTML formateado
    let formattedHTML = '';
    
    // Texto principal
    if (sections.main) {
        formattedHTML += `<div class="strategy-main-text">${sections.main.replace(/\n\n/g, '</div><div class="strategy-main-text">').replace(/\n/g, '<br>')}</div>`;
    }
    
    // Función auxiliar para convertir listas de guiones a HTML
    const formatList = (listText) => {
        if (!listText || typeof listText !== 'string') return '';
        
        // Separar en líneas
        const lines = listText.split('\n');
        let html = '<ul class="strategy-list">';
        
        for (const line of lines) {
            if (line.trim().startsWith('-')) {
                // Eliminar el guión y espacios al inicio
                const item = line.trim().substring(1).trim();
                if (item) {
                    html += `<li>${item}</li>`;
                }
            } else if (line.trim()) {
                // Si no es un elemento de lista, tratarlo como texto normal
                html += `<li>${line.trim()}</li>`;
            }
        }
        
        html += '</ul>';
        return html;
    };
    
    // Estrategias específicas
    if (sections.strategies || seccionesDinamicas.recomendaciones.length > 0) {
        let strategiesContent = sections.strategies || '';
        
        // Si no hay estrategias en el texto original, usar las dinámicas
        if (!strategiesContent.trim() && seccionesDinamicas.recomendaciones.length > 0) {
            strategiesContent = seccionesDinamicas.recomendaciones.join('\n');
        } else if (seccionesDinamicas.recomendaciones.length > 0) {
            // Si hay ambas, combinarlas
            strategiesContent += '\n' + seccionesDinamicas.recomendaciones.join('\n');
        }
        
        if (strategiesContent.trim()) {
            formattedHTML += `
            <div class="strategy-section strategy-section-strategies">
                <strong><i class="fa-solid fa-chess-knight"></i> Estrategias Específicas Recomendadas:</strong>
                <div class="strategy-content">${formatList(strategiesContent)}</div>
            </div>`;
        }
    }
    
    // ✅ MODIFICACIÓN CLAVE: Advertencias científicas con formato mejorado
    if (sections.warnings) {
        const warningsLines = sections.warnings.split('\n');
        let formattedWarnings = '';
        
        warningsLines.forEach(line => {
            if (line.trim().startsWith('-')) {
                const cleanLine = line.trim().substring(1).trim();
                
                // Detectar si la línea contiene un título de estrategia
                const strategyTitleMatch = cleanLine.match(/^(.*?):/);
                
                if (strategyTitleMatch && strategyTitleMatch[1]) {
                    const strategyTitle = strategyTitleMatch[1];
                    const warningContent = cleanLine.substring(strategyTitle.length + 1).trim();
                    
                    // Aplicar formato especial si es una estrategia específica
                    formattedWarnings += `<li><strong class="strategy-warning-title">${strategyTitle}:</strong> ${warningContent}</li>`;
                } else {
                    formattedWarnings += `<li>${cleanLine}</li>`;
                }
            }
        });
        
				if (formattedWarnings) {
					formattedHTML += `
					<div class="strategy-section strategy-section-warnings">
						<strong><i class="fas fa-exclamation-triangle text-warning"></i> Advertencias Científicas:</strong>
						<div class="strategy-content">
							<ul class="strategy-list">${formattedWarnings}</ul>
						</div>
					</div>`;
				}
			}
			
			// Errores críticos
			if (sections.criticalErrors) {
				const criticalErrorsContent = sections.criticalErrors;
				
				if (criticalErrorsContent.trim()) {
					formattedHTML += `
					<div class="strategy-section strategy-section-critical-errors">
						<strong><i class="fas fa-exclamation-circle text-danger"></i> Errores Críticos:</strong>
						<div class="strategy-content">${formatList(criticalErrorsContent)}</div>
					</div>`;
				}
			}
    
    
    
    
			
			
			// Si no hay contenido, mostrar mensaje por defecto
			if (!formattedHTML) {
				formattedHTML = '<div class="strategy-main-text text-muted">No hay detalles disponibles para esta estrategia.</div>';
			}
			
			return formattedHTML;
}

function normalizarFase(fase) {
    if (!fase) return "Fase 1 (0-12 sem)";
    
    // Convertir a minúsculas y eliminar espacios extra
    const faseLower = fase.toLowerCase().replace(/\s+/g, ' ').trim();
    
    // Mapeo de fases
    if (/fase\s*1|0-12\s*sem|12\s*sem/i.test(faseLower)) {
        return "Fase 1 (0-12 sem)";
    }
    if (/fase\s*2|12-24\s*sem/i.test(faseLower)) {
        return "Fase 2 (12-24 sem)";
    }
    if (/fase\s*3|avanzada|>24\s*sem/i.test(faseLower)) {
        return "Fase 3 Avanzada (>24 sem)";
    }
    if (/fase\s*4|ajuste\s*metabólico|>32\s*sem/i.test(faseLower)) {
        return "Fase 4 Ajuste Metabólico (>32 sem)";
    }
    
    // Para fases específicas de ganancia
    if (/fase\s*1|0-8\s*sem/i.test(faseLower) && faseLower.includes("ganancia")) {
        return "Fase 1 (0-8 sem)";
    }
    
    // Para fases específicas de mantenimiento
    if (/fase\s*1|0-16\s*sem/i.test(faseLower) && faseLower.includes("mantenimiento")) {
        return "Fase 1 (0-16 sem)";
    }
    
    // Si no coincide con ninguna fase conocida, usar la primera fase por defecto
    return "Fase 1 (0-12 sem)";
}
function encontrarCoincidenciaEstrategia(estrategiaTitle, opciones) {
    const titleLower = estrategiaTitle.toLowerCase();
    
    // 1. Primero intentar coincidencia exacta
    for (const opcion of opciones) {
        if (titleLower === opcion.toLowerCase()) {
            return opcion;
        }
    }
    
    // 2. Intentar con el mapeo de nombres
    const nombreMapeado = nombreEstrategiaEspecificaMap[estrategiaTitle] || 
                          nombreEstrategiaEspecificaMap[titleLower];
    
    if (nombreMapeado && opciones.includes(nombreMapeado)) {
        return nombreMapeado;
    }
    
    // 3. Intentar coincidencia parcial (palabras clave)
    const keywords = titleLower.split(/\s+/).filter(word => word.length > 3);
    for (const opcion of opciones) {
        const opcionLower = opcion.toLowerCase();
        
        // Verificar si contiene palabras clave significativas
        const coincidencias = keywords.filter(word => 
            opcionLower.includes(word) && 
            // Excluir palabras comunes
            !['para', 'con', 'de', 'y', 'en', 'el', 'la'].includes(word)
        );
        
        if (coincidencias.length >= 2) {
            return opcion;
        }
    }
    
    // 4. Verificar abreviaturas
    const abreviaturas = {
        'tkd': 'Targeted Ketogenic Diet (TKD)',
        'ckd': 'Cyclic Ketogenic Diet (CKD)',
        'rkd': 'Restricted Ketogenic Diet (RKD)',
        'mkd': 'Modified Ketogenic Diet',
        'cc': 'Carb Cycling',
        'pc': 'Protein Cycling',
        'cal': 'Calorie Cycling',
        'mft': 'Metabolic Flexibility Training',
        'rs': 'Refeed Strategy'
    };
    
    for (const [abrev, nombreCompleto] of Object.entries(abreviaturas)) {
        if (titleLower.includes(abrev)) {
            if (opciones.includes(nombreCompleto)) {
                return nombreCompleto;
            }
        }
    }
    
    // 5. Último recurso: coincidencia por palabras clave principales
    const palabrasClave = ['ketogenic', 'cycling', 'carb', 'protein', 'calorie', 'flexibility', 'refeed', 'timing', 'hydration'];
    
    for (const palabra of palabrasClave) {
        if (titleLower.includes(palabra)) {
            const coincidencia = opciones.find(opcion => 
                opcion.toLowerCase().includes(palabra)
            );
            
            if (coincidencia) return coincidencia;
        }
    }
    
    return null;
}

function obtenerClasificacion(estrategia, proposito, faseConfig, estrategiaBaseKey, estrategiaEspecificaKey) {
  // 1. Primero intentar obtener la clasificación directa
  if (faseConfig[estrategiaBaseKey] && 
      faseConfig[estrategiaBaseKey][estrategiaEspecificaKey] &&
      faseConfig[estrategiaBaseKey][estrategiaEspecificaKey][proposito]) {
    return faseConfig[estrategiaBaseKey][estrategiaEspecificaKey][proposito];
  }
  
  // 2. Si no hay clasificación específica, intentar con "default"
  if (faseConfig[estrategiaBaseKey] && 
      faseConfig[estrategiaBaseKey][estrategiaEspecificaKey] &&
      faseConfig[estrategiaBaseKey][estrategiaEspecificaKey]["default"]) {
    return faseConfig[estrategiaBaseKey][estrategiaEspecificaKey]["default"];
  }
  
  // 3. Verificar en la propiedad "features" de la estrategia
  if (estrategia.features && Array.isArray(estrategia.features)) {
    // Buscar si hay incompatibilidad explícita
    const incompatibilidad = estrategia.features.some(feat => 
      feat.toLowerCase().includes("incompatibilidad") || 
      feat.toLowerCase().includes("no recomendado")
    );
    
    if (incompatibilidad) return "no recomendada";
    
    // Buscar si es específicamente recomendado para el propósito
    const recomendado = estrategia.features.some(feat => 
      (feat.toLowerCase().includes("recomendado") || 
       feat.toLowerCase().includes("óptimo")) &&
      feat.toLowerCase().includes(proposito.toLowerCase())
    );
    
    if (recomendado) return "recomendada";
  }
  
  // 4. Verificar compatibilidad general con el propósito
  const esCompatibleConProposito = verificarCompatibilidadProposito(estrategia, proposito);
  
  // 5. Por defecto, si pasa todas las verificaciones, es recomendada
  return esCompatibleConProposito ? "recomendada" : "no recomendada";
}

function verificarCompatibilidadProposito(estrategia, proposito) {
  if (!estrategia.aplicableProposito) return true;
  
  // Verificar si el propósito está explícitamente permitido
  if (estrategia.aplicableProposito[proposito] === "recomendada") {
    return true;
  }
  
  // Verificar si el propósito está explícitamente prohibido
  if (estrategia.aplicableProposito[proposito] === "no recomendada") {
    return false;
  }
  
  // Verificar si hay advertencias específicas para este propósito
  if (estrategia.features && Array.isArray(estrategia.features)) {
    return !estrategia.features.some(feat => 
      (feat.toLowerCase().includes("incompatibilidad") || 
       feat.toLowerCase().includes("no recomendado")) &&
      feat.toLowerCase().includes(proposito.toLowerCase())
    );
  }
  
  return true;
}
function generarRecomendacionesClave(objetivo, proposito, strategyId = null, estrategiasEspecificasSeleccionadas = []) {
    if (!objetivo || !proposito) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Selecciona una estrategia base para ver recomendaciones específicas.</div></div>`;
    }
    
    // Si hay una estrategia base seleccionada
    if (strategyId) {
        const estrategiaBase = encontrarEstrategiaBase(strategyId);
        
        if (!estrategiaBase) {
            return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>No se encontró la estrategia base seleccionada.</div></div>`;
        }
        
        // Obtener fase actual del modal
        const faseElement = document.querySelector('.modal-title');
        const faseKey = faseElement ? faseElement.textContent.split('-')[1]?.trim() : "Fase 1 (0-12 sem)";
        
        // Analizar compatibilidad con estrategias específicas seleccionadas
        const analisis = analizarCompatibilidad(
            estrategiaBase, 
            estrategiasEspecificasSeleccionadas, 
            proposito, 
            faseKey
        );
        
        // Generar HTML para contraindicaciones y recomendaciones
        return generarHTMLRecomendaciones(analisis, estrategiaBase, faseKey);
    }
    
    // Si no hay estrategia base seleccionada, mostrar recomendaciones genéricas
    return generarRecomendacionesGenericas(objetivo, proposito);
}



// Función para analizar la compatibilidad dinámica
function analizarCompatibilidad(estrategiaBase, estrategiasEspecificas, proposito, faseKey) {
    // ASEGURAR QUE estrategiasEspecificas ES UN ARRAY VÁLIDO
    if (!Array.isArray(estrategiasEspecificas)) {
        estrategiasEspecificas = [];
    }
    
    const resultados = [];
    
    estrategiasEspecificas.forEach(estrategia => {
        try {
            const clasificacion = clasificarEstrategia(estrategia, proposito, faseKey, estrategiaBase);
            
            resultados.push({
                estrategia: estrategia,
                clasificacion: clasificacion,
                esCompatible: clasificacion && (
                    clasificacion.clasificacion === 'recomendada' || 
                    clasificacion.clasificacion === 'neutral'
                )
            });
        } catch (error) {
            console.error(`Error al clasificar estrategia ${estrategia.id}:`, error);
        }
    });
    
    return resultados;
}

function generarHTMLRecomendaciones(analisis, estrategiaBase, faseKey, recomendacionesBase = []) {
    try {
        // ASEGURAR QUE ANALISIS ES UN ARRAY VÁLIDO
        if (!Array.isArray(analisis)) {
            analisis = [];
        }
        
        // ASEGURAR QUE RECOMENDACIONES BASE ES UN ARRAY VÁLIDO
        if (!Array.isArray(recomendacionesBase)) {
            recomendacionesBase = [];
        }
        
        // Normalizar las recomendaciones base al mismo formato que el análisis
        const recomendacionesBaseNormalizadas = recomendacionesBase.map(rec => ({
            esCompatible: true,
            clasificacion: {
                clasificacion: 'recomendada',
                mensaje: rec.text,
                detalle: ''
            },
            estrategia: {
                title: rec.title
            }
        }));
        
        // Combinar recomendaciones base con análisis
        const todasRecomendaciones = [...recomendacionesBaseNormalizadas, ...analisis];
        
        // Filtrar por compatibilidad
        const contraindicaciones = todasRecomendaciones.filter(item => 
            !item.esCompatible && item.clasificacion && 
            (item.clasificacion.clasificacion === 'contraindicada' || 
             item.clasificacion.clasificacion === 'no recomendada')
        );
        
        const recomendaciones = todasRecomendaciones.filter(item => 
            item.esCompatible && item.clasificacion && 
            item.clasificacion.clasificacion === 'recomendada' &&
            // Excluir las recomendaciones base de esta sección (ya se muestran arriba)
            !recomendacionesBase.some(base => base.title === item.estrategia.title)
        );
        
        const neutras = todasRecomendaciones.filter(item => 
            item.esCompatible && item.clasificacion && 
            item.clasificacion.clasificacion === 'neutral'
        );
        
        let html = '<div class="recommendations-section">';
        
        // Título
        html += '<h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Key Points Estrategia Base Seleccionada</h6>';
        
        // Si no hay estrategia base, mensaje informativo
        if (!estrategiaBase) {
            html += '<div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Selecciona una estrategia base para ver recomendaciones específicas.</div>';
            html += '</div>';
            return html;
        }
        
        // Recomendaciones base  // //html += '<h6 class="text-muted mb-2">Recomendaciones Base:</h6>';
        if (recomendacionesBase.length > 0) {
            html += '<div class="base-recommendations mb-4">';
            
            
            recomendacionesBase.forEach(rec => {
                html += `
                    <div class="recommendation-item mb-2">
                        <div class="d-flex">
                            <i class="${rec.icon} me-2 mt-1" style="color: #5e9a4f; width: 20px;"></i>
                            <div>
                                <h6 class="mb-1">${rec.title}</h6>
                                <p class="mb-0">${rec.text}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        // Sección: Contraindicaciones Clave
        if (contraindicaciones.length > 0) {
            html += `
            <div class="optimal-strategy-section mb-4">
                <h6 class="text-danger mb-2"><i class="fas fa-exclamation-triangle me-1"></i> Contraindicaciones Clave</h6>
                <ul class="list-group list-group-flush">`;
            
            contraindicaciones.forEach(item => {
                html += `
                    <li class="list-group-item bg-light p-2">
                        <i class="fas fa-times-circle text-danger me-1"></i> 
                        <strong>${item.estrategia.title}</strong>: ${item.clasificacion.mensaje}
                        ${item.clasificacion.detalle ? `<div class="small text-muted mt-1">${item.clasificacion.detalle}</div>` : ''}
                    </li>`;
            });
            
            html += `
                </ul>
            </div>`;
        }
        
        // Sección: Recomendaciones Específicas
        if (recomendaciones.length > 0) {
            html += `
            <div class="optimal-strategy-section mb-4">
                <h6 class="text-success mb-2"><i class="fas fa-check-circle me-1"></i> Recomendaciones Específicas</h6>
                <ul class="list-group list-group-flush">`;
            
            recomendaciones.forEach(item => {
                html += `
                    <li class="list-group-item bg-light p-2">
                        <i class="fas fa-check-circle text-success me-1"></i> 
                        <strong>${item.estrategia.title}</strong>: ${item.clasificacion.mensaje}
                        ${item.clasificacion.detalle ? `<div class="small text-muted mt-1">${item.clasificacion.detalle}</div>` : ''}
                    </li>`;
            });
            
            html += `
                </ul>
            </div>`;
        }
        
        // Sección: Estrategias Neutras
        if (neutras.length > 0) {
            html += `
            <div class="optimal-strategy-section mb-4">
                <h6 class="text-warning mb-2"><i class="fas fa-circle me-1"></i> Estrategias Neutras</h6>
                <ul class="list-group list-group-flush">`;
            
            neutras.forEach(item => {
                html += `
                    <li class="list-group-item bg-light p-2">
                        <i class="fas fa-circle text-warning me-1"></i> 
                        <strong>${item.estrategia.title}</strong>: ${item.clasificacion.mensaje}
                        ${item.clasificacion.detalle ? `<div class="small text-muted mt-1">${item.clasificacion.detalle}</div>` : ''}
                    </li>`;
            });
            
            html += `
                </ul>
            </div>`;
        }
        
        // Si no hay contraindicaciones ni recomendaciones específicas (solo recomendaciones base)
        if (contraindicaciones.length === 0 && recomendaciones.length === 0 && neutras.length === 0 && recomendacionesBase.length > 0) {
            html += `
            <div class="optimal-strategy-section mb-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i> 
                    No hay recomendaciones específicas adicionales para esta combinación.
                    <div class="mt-2 small text-muted">
                        Selecciona estrategias específicas para ver más recomendaciones personalizadas.
                    </div>
                </div>
            </div>`;
        }
        
        html += '</div>';
        return html;
    } catch (error) {
        console.error("Error al generar HTML de recomendaciones:", error);
        return `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i> 
                    Error al generar recomendaciones: ${error.message}
                </div>
            </div>
        `;
    }
}


// Función para generar recomendaciones genéricas (cuando no hay estrategia base seleccionada)
function generarRecomendacionesGenericas(objetivo, proposito) {
    // Normalizar objetivo y propósito
    const objetivoNormalizado = objetivo.toLowerCase();
    const propositoNormalizado = proposito.toLowerCase();
    
    // Encontrar las claves correctas
    let objetivoKey;
    if (objetivoNormalizado.includes('perdida')) objetivoKey = 'perdida';
    else if (objetivoNormalizado.includes('ganancia')) objetivoKey = 'ganancia';
    else if (objetivoNormalizado.includes('mantenimiento')) objetivoKey = 'mantenimiento';
    else if (objetivoNormalizado.includes('mixto')) objetivoKey = 'mixto';
    
    let propositoKey;
    if (propositoNormalizado.includes('salud')) propositoKey = 'salud';
    else if (propositoNormalizado.includes('estet')) propositoKey = 'estetica';
    else if (propositoNormalizado.includes('rendimiento')) propositoKey = 'rendimiento';
    
    // Si no encontramos coincidencias, usar valores por defecto
    if (!objetivoKey || !propositoKey) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Selecciona una estrategia base para ver recomendaciones específicas.</div></div>`;
    }
    
    // Obtener el resumen ejecutivo
    const resumen = estrategiaCompleta[objetivoKey]?.[propositoKey]?.resumenEjecutivo || [];
    
    // Si no hay resumen ejecutivo, mostrar mensaje
    if (resumen.length === 0) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>No hay recomendaciones clave específicas para esta combinación.</div></div>`;
    }
    
    const items = resumen.map(rec => `
        <div class="recommendation-item mb-3">
            <div class="d-flex">
                <i class="${rec.icon} me-2 mt-1" style="color: #5e9a4f; width: 20px;"></i>
                <div>
                    <h6 class="mb-1">${rec.title}</h6>
                    <p class="mb-0">${rec.text}</p>
                </div>
            </div>
        </div>
    `).join('');
    
    return `
        <div class="recommendations-section">
            <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
            ${items}
        </div>
    `;
}

function obtenerRecomendacionesEstrategia(strategyId, proposito, objetivo) {
    // Buscar en todas las categorías de estrategias específicas
    const todasEstrategias = [
        ...(catalogoEstrategias.cetogenicas || []),
        ...(catalogoEstrategias.ciclado || []),
        ...(catalogoEstrategias.timing || [])
    ];
    
    // Buscar la estrategia base en estrategiasBaseConfig
    let estrategiaBase = null;
    
    // Recorrer todas las fases y objetivos en estrategiasBaseConfig
    for (const objetivoKey in estrategiasBaseConfig) {
        for (const fase in estrategiasBaseConfig[objetivoKey]) {
            const estrategias = estrategiasBaseConfig[objetivoKey][fase];
            const encontrada = estrategias.find(e => e.id === strategyId);
            
            if (encontrada) {
                estrategiaBase = encontrada;
                break;
            }
        }
        
        if (estrategiaBase) break;
    }
    
    // Si no se encontró en estrategiasBaseConfig, intentar con el ID directo
    if (!estrategiaBase) {
        for (const categoria in catalogoEstrategias) {
            const categoriaEstrategias = catalogoEstrategias[categoria] || [];
            const estrategia = categoriaEstrategias.find(e => e.id === strategyId);
            if (estrategia) {
                estrategiaBase = estrategia;
                break;
            }
        }
    }
    
    // Si no se encontró la estrategia
    if (!estrategiaBase) {
        console.warn(`Estrategia base con ID ${strategyId} no encontrada`);
        return [];
    }
    
    // Obtener recomendaciones específicas de la estrategia
    const recomendaciones = [];
    
    // CORRECCIÓN CLAVE: Verificar que features exista y sea un array
    if (estrategiaBase.features && Array.isArray(estrategiaBase.features)) {
        estrategiaBase.features.forEach(feature => {
            // Buscar recomendaciones específicas para el propósito
            if (feature.includes(`PROPÓSITO: Válido para ${proposito.toUpperCase()}`) ||
                feature.includes(`PROPÓSITO: Solo válido para ${proposito.toUpperCase()}`)) {
                
                // Buscar recomendaciones específicas
                const recMatch = feature.match(/RECOMENDACIÓN:\s*(.*)/);
                if (recMatch) {
                    // Intentar encontrar un icono correspondiente en el objeto global de recomendaciones
                    const icono = encontrarIconoCorrespondiente(recMatch[1], objetivo, proposito);
                    
                    recomendaciones.push({
                        icon: icono,
                        title: "Recomendación Específica",
                        text: recMatch[1]
                    });
                }
            }
        });
    }
    
    // Si no hay recomendaciones específicas, buscar en las estrategias específicas compatibles
    if (recomendaciones.length === 0 && Array.isArray(todasEstrategias)) {
        todasEstrategias.forEach(estrategia => {
            // Verificar si es compatible con la estrategia base
            const esCompatible = estrategia.features && Array.isArray(estrategia.features) && estrategia.features.some(feat => 
                feat.includes(`ESTRATEGIA BASE: ${estrategiaBase.title}`) ||
                feat.includes(`ESTRATEGIA BASE: ${estrategiaBase.id}`)
            );
            
            // Verificar propósito
            const tieneProposito = estrategia.features && Array.isArray(estrategia.features) && estrategia.features.some(feat => 
                feat.includes(`PROPÓSITO: Válido para ${proposito.toUpperCase()}`) ||
                feat.includes(`PROPÓSITO: Solo válido para ${proposito.toUpperCase()}`)
            );
            
            if (esCompatible && tieneProposito) {
                // Intentar encontrar un icono correspondiente en el objeto global de recomendaciones
                const icono = encontrarIconoCorrespondiente(estrategia.title, objetivo, proposito);
                
                recomendaciones.push({
                    icon: icono,
                    title: estrategia.title,
                    text: estrategia.description
                });
            }
        });
    }
    
    return recomendaciones;
}

// Función auxiliar para encontrar el icono correspondiente
function encontrarIconoCorrespondiente(titulo, objetivo, proposito) {
    if (!recomendaciones[objetivo] || !recomendaciones[objetivo][proposito]) {
        return "fas fa-lightbulb";
    }
    
    // Buscar coincidencia parcial en los títulos de las recomendaciones
    for (const rec of recomendaciones[objetivo][proposito]) {
        if (titulo.toLowerCase().includes(rec.title.toLowerCase()) || 
            rec.title.toLowerCase().includes(titulo.toLowerCase())) {
            return rec.icon;
        }
    }
    
    // Si no hay coincidencia exacta, intentar con palabras clave
    const tituloLower = titulo.toLowerCase();
    
    if (tituloLower.includes("refeed") || tituloLower.includes("carb") || tituloLower.includes("hc")) {
        return "fas fa-fire";
    }
    if (tituloLower.includes("protein") || tituloLower.includes("prote")) {
        return "fas fa-protein";
    }
    if (tituloLower.includes("flexibility") || tituloLower.includes("cycling") || 
        tituloLower.includes("rotación") || tituloLower.includes("ciclado")) {
        return "fas fa-sync-alt";
    }
    if (tituloLower.includes("ayuno") || tituloLower.includes("intermitente") || 
        tituloLower.includes("fasting")) {
        return "fas fa-clock";
    }
    if (tituloLower.includes("hidratación") || tituloLower.includes("agua") || 
        tituloLower.includes("electrolitos")) {
        return "fas fa-hydrate";
    }
    if (tituloLower.includes("peso") || tituloLower.includes("balanza") || 
        tituloLower.includes("equilibrio")) {
        return "fas fa-balance-scale";
    }
    if (tituloLower.includes("caminar") || tituloLower.includes("pasos") || 
        tituloLower.includes("neat")) {
        return "fas fa-walking";
    }
    if (tituloLower.includes("entrenamiento") || tituloLower.includes("fuerza") || 
        tituloLower.includes("dumbbell")) {
        return "fas fa-dumbbell";
    }
    if (tituloLower.includes("calendario") || tituloLower.includes("periodización") || 
        tituloLower.includes("calendario")) {
        return "fas fa-calendar-alt";
    }
    
    // Icono por defecto
    return "fas fa-lightbulb";
}


function clasificarEstrategia(estrategia, proposito, faseKey, estrategiaBase) {
    try {
        // Verificar que los parámetros esenciales existan
        if (!estrategia || !proposito) {
            throw new Error("Parámetros insuficientes para clasificar estrategia");
        }
        
        // Si no hay estrategia base, usar clasificación genérica
        if (!estrategiaBase || !estrategiaBase.title) {
            // Clasificación genérica basada solo en propósito
            if (estrategia.aplicableProposito && estrategia.aplicableProposito[proposito] === 'recomendada') {
                return {
                    clasificacion: 'recomendada',
                    mensaje: 'Estrategia recomendada para este propósito',
                    detalle: '',
                    color: '#4caf50'
                };
            }
            
            return {
                clasificacion: 'neutral',
                mensaje: 'Estrategia neutral para este propósito',
                detalle: '',
                color: '#9e9e9e'
            };
        }
        
        // Determinar el objetivo actual
        let objetivoKey = '';
        const objetivoSelect = document.getElementById('objetivo');
        if (objetivoSelect) {
            const objetivoValue = objetivoSelect.value;
            if (objetivoValue.includes('perdida')) objetivoKey = 'perdida';
            else if (objetivoValue.includes('ganancia')) objetivoKey = 'ganancia';
            else if (objetivoValue.includes('mantenimiento')) objetivoKey = 'mantenimiento';
            else if (objetivoValue.includes('mixto')) objetivoKey = 'mixto';
        }
        
        // Si no pudimos determinar el objetivo, usar 'perdida' por defecto
        if (!objetivoKey) objetivoKey = 'perdida';
        
        // Mapeo de fases a formato estandarizado
        const faseMap = {
            '1': 'Fase 1 (0-12 sem)',
            '2': 'Fase 2 (12-24 sem)',
            '3': 'Fase 3 Avanzada (>24 sem)',
            '4': 'Fase 4 Ajuste Metabólico (>32 sem)',
            'Fase 1': 'Fase 1 (0-12 sem)',
            'Fase 2': 'Fase 2 (12-24 sem)',
            'Fase 3': 'Fase 3 Avanzada (>24 sem)',
            'Fase 4': 'Fase 4 Ajuste Metabólico (>32 sem)'
        };
        
        const faseEstandarizada = faseMap[faseKey] || faseKey;
        
        // Mapeo de nombres de estrategias base para compatibilidad
       // Mapeo exhaustivo de nombres de estrategias específicas
const nombreEstrategiaEspecificaMap = {
    // Estrategias cetogénicas
    "Targeted Ketogenic Diet": "Targeted Ketogenic Diet (TKD)",
    "Targeted Ketogenic Diet (TKD)": "Targeted Ketogenic Diet (TKD)",
    "TKD": "Targeted Ketogenic Diet (TKD)",
    
    "Cyclic Ketogenic Diet": "Cyclic Ketogenic Diet (CKD)",
    "Cyclic Ketogenic Diet (CKD)": "Cyclic Ketogenic Diet (CKD)",
    "CKD": "Cyclic Ketogenic Diet (CKD)",
    
    "Restricted Ketogenic Diet": "Restricted Ketogenic Diet (RKD)",
    "Restricted Ketogenic Diet (RKD)": "Restricted Ketogenic Diet (RKD)",
    "RKD": "Restricted Ketogenic Diet (RKD)",
    
    "Modified Ketogenic Diet": "Modified Ketogenic Diet",
    "MKD": "Modified Ketogenic Diet",
    
    // Estrategias de ciclado
    "Carb Cycling": "Carb Cycling",
    
    "Protein Cycling": "Protein Cycling",
    
    "Calorie Cycling": "Calorie Cycling",
    
    "Metabolic Flexibility Training": "Metabolic Flexibility Training",
    
    "Refeed Strategy": "Refeed Strategy",
    
    // Estrategias de timing
    //"High Carb para Deportes de Resistencia": "High Carb para Deportes de Resistencia",
    
    "Flexible Dieting (80/20 rule)": "Flexible Dieting (80/20 rule)",
    
    "Dieta Estándar/Equilibrada": "Dieta Estándar/Equilibrada",
    
    "Intermittent Fasting + Cycling": "Intermittent Fasting + Cycling",
    
    "Meal Timing Optimization": "Meal Timing Optimization",
    
    "NEAT Optimization": "NEAT Optimization",
    
    "Hydration Strategy": "Hydration Strategy",
    
    "Protein Pacing": "Protein Pacing",
    
    "Targeted Carb Timing": "Targeted Carb Timing"
};
        
        // Obtener configuración de la fase
        const faseConfig = matrizCompatibilidad[objetivoKey]?.[faseEstandarizada];
        if (!faseConfig) {
            console.warn(`No se encontró configuración para ${objetivoKey}/${faseEstandarizada}`);
            return {
                clasificacion: 'neutral',
                mensaje: 'Estrategia neutral (configuración no encontrada)',
                detalle: '',
                color: '#9e9e9e'
            };
        }
        
        // CORRECCIÓN CLAVE: Usar el mapeo de nombres
        const nombreBaseMapeado = nombreEstrategiaBaseMap[estrategiaBase.title] || estrategiaBase.title;
        
        // Buscar estrategia base específica - Mejor coincidencia
        const estrategiaBaseKey = Object.keys(faseConfig).find(key => {
            const baseLower = nombreBaseMapeado.toLowerCase();
            const keyLower = key.toLowerCase();
            
            // Verificar coincidencia exacta
            if (baseLower === keyLower) return true;
            
            // Verificar coincidencia parcial (cualquier dirección)
            if (baseLower.includes(keyLower) || keyLower.includes(baseLower)) return true;
            
            // Casos especiales para "Ciclado Metabólico"
            if ((baseLower.includes("ciclado metabólico") || baseLower.includes("hiperproteica")) && 
                keyLower.includes("ciclado metabólico")) {
                return true;
            }
            
            return false;
        });
        
        if (!estrategiaBaseKey) {
            console.warn(`No se encontró estrategia base "${nombreBaseMapeado}" en la matriz de compatibilidad`);
            return {
                clasificacion: 'neutral',
                mensaje: 'Estrategia neutral (estrategia base no encontrada)',
                detalle: '',
                color: '#9e9e9e'
            };
        }
        
        // Buscar estrategia específica - Mejor coincidencia
        const estrategiaEspecificaKey = Object.keys(faseConfig[estrategiaBaseKey]).find(key => {
            const estrategiaLower = estrategia.title.toLowerCase();
            const keyLower = key.toLowerCase();
            
            // Verificar coincidencia exacta
            if (estrategiaLower === keyLower) return true;
            
            // Verificar coincidencia parcial (cualquier dirección)
            if (estrategiaLower.includes(keyLower) || keyLower.includes(estrategiaLower)) return true;
            
            return false;
        });
        
        if (!estrategiaEspecificaKey) {
            console.warn(`No se encontró estrategia específica "${estrategia.title}" en la matriz de compatibilidad`);
            return {
                clasificacion: 'neutral',
                mensaje: 'Estrategia neutral (estrategia específica no encontrada)',
                detalle: '',
                color: '#9e9e9e'
            };
        }
        
        // Obtener clasificación para el propósito
        const clasificacion = faseConfig[estrategiaBaseKey][estrategiaEspecificaKey][proposito] || 'neutral';
        
        // EXTRAER ADVERTENCIAS ESPECÍFICAS DE LOS FEATURES
        const advertenciasEspecificas = estrategia.features ? 
            estrategia.features.filter(feat => 
                feat.includes("INCOMPATIBILIDAD") || 
                feat.includes("ADVERTENCIA") ||
                feat.includes("CONTRAINDICACIÓN")
            ) : [];
        
        // Determinar mensaje y detalle basado en la clasificación
        switch(clasificacion) {
            case 'recomendada':
                return {
                    clasificacion: 'recomendada',
                    mensaje: 'Estrategia óptima para tu combinación específica',
                    detalle: `Esta estrategia complementa y potencia los principios de tu estrategia base "${estrategiaBase.title}"`,
                    color: '#4caf50'
                };
            case 'no recomendada':
                return {
                    clasificacion: 'no recomendada',
                    mensaje: 'Estrategia no recomendada para tu combinación específica',
                    detalle: advertenciasEspecificas.length > 0 ? 
                        advertenciasEspecificas.join("\n") : 
                        `Esta estrategia no es óptima con tu estrategia base "${estrategiaBase.title}"`,
                    color: '#f44336'
                };
            case 'neutral':
                return {
                    clasificacion: 'neutral',
                    mensaje: 'Estrategia compatible, pero no específicamente optimizada',
                    detalle: 'Esta estrategia es aplicable pero no aporta beneficios adicionales a tu estrategia base',
                    color: '#9e9e9e'
                };
            default:
                return {
                    clasificacion: 'neutral',
                    mensaje: 'Estrategia neutral (clasificación desconocida)',
                    detalle: '',
                    color: '#9e9e9e'
                };
        }
    } catch (error) {
        console.error("Error al clasificar estrategia:", error);
        return {
            clasificacion: 'neutral',
            mensaje: 'Error al evaluar la estrategia',
            detalle: 'Se produjo un error al clasificar esta estrategia',
            color: '#9e9e9e'
        };
    }
}
function obtenerClasificacionEspecifica(estrategia, proposito, faseKey, estrategiaBase) {
    if (!estrategiaBase || !estrategiaBase.title) return null;
    
    // Normalizar fase
    const faseEstandarizada = normalizarFase(faseKey);
    
    // Determinar objetivo
    let objetivo = '';
    if (estrategiaBase.aplicable && estrategiaBase.aplicable.includes('perdida')) objetivo = 'perdida';
    else if (estrategiaBase.aplicable && estrategiaBase.aplicable.includes('ganancia')) objetivo = 'ganancia';
    else if (estrategiaBase.aplicable && estrategiaBase.aplicable.includes('mantenimiento')) objetivo = 'mantenimiento';
    else if (estrategiaBase.aplicable && estrategiaBase.aplicable.includes('mixto')) objetivo = 'mixto';
    
    if (!objetivo) {
        const objetivoSelect = document.getElementById('objetivo');
        if (objetivoSelect) {
            const objetivoValue = objetivoSelect.value;
            if (objetivoValue.includes('perdida')) objetivo = 'perdida';
            else if (objetivoValue.includes('ganancia')) objetivo = 'ganancia';
            else if (objetivoValue.includes('mantenimiento')) objetivo = 'mantenimiento';
            else if (objetivoValue.includes('mixto')) objetivo = 'mixto';
        }
    }
    
    if (!objetivo) objetivo = 'perdida';
    
    // Obtener configuración de la fase
    const faseConfig = matrizCompatibilidad[objetivo]?.[faseEstandarizada];
    if (!faseConfig) {
        console.warn(`No se encontró configuración para ${objetivo}/${faseEstandarizada}`);
        return null;
    }
    
    // Usar el mapeo de nombres
    const nombreBaseMapeado = nombreEstrategiaBaseMap[estrategiaBase.title] || estrategiaBase.title;
    
    // Buscar estrategia base específica con coincidencia inteligente
    let estrategiaBaseKey = null;
    
    // Primero intentar con coincidencia exacta
    for (const key of Object.keys(faseConfig)) {
        if (key.toLowerCase() === nombreBaseMapeado.toLowerCase()) {
            estrategiaBaseKey = key;
            break;
        }
    }
    
    // Si no hay coincidencia exacta, intentar con coincidencia inteligente
    if (!estrategiaBaseKey) {
        const coincidencia = encontrarCoincidenciaEstrategia(nombreBaseMapeado, Object.keys(faseConfig));
        if (coincidencia) {
            estrategiaBaseKey = coincidencia;
        }
    }
    
    if (!estrategiaBaseKey) {
        console.warn(`No se encontró estrategia base "${nombreBaseMapeado}" en la matriz de compatibilidad`);
        return null;
    }
    
    // Buscar estrategia específica con coincidencia inteligente
    const estrategiaEspecificaKey = encontrarCoincidenciaEstrategia(estrategia.title, Object.keys(faseConfig[estrategiaBaseKey]));
    
    if (!estrategiaEspecificaKey) {
        console.warn(`No se encontró estrategia específica "${estrategia.title}" en la matriz de compatibilidad`);
        return null;
    }
    
    // Obtener clasificación con sistema robusto
    const clasificacion = faseConfig[estrategiaBaseKey][estrategiaEspecificaKey][proposito] || 'neutral';
    
    // EXTRAER ADVERTENCIAS ESPECÍFICAS DE LOS FEATURES
    const advertenciasEspecificas = estrategia.features ? 
        estrategia.features.filter(feat => 
            feat.includes("INCOMPATIBILIDAD") || 
            feat.includes("ADVERTENCIA") ||
            feat.includes("CONTRAINDICACIÓN") ||
            feat.includes("NO RECOMENDADO")
        ) : [];
    
    // Procesar y eliminar duplicados en las advertencias
    const advertenciasProcesadas = procesarAdvertencias(advertenciasEspecificas);
    
    // Usar las advertencias procesadas (sin duplicados)
    const advertenciasTexto = advertenciasProcesadas.map(adv => adv.texto);
    
    // Determinar mensaje y detalle basado en la clasificación
    switch(clasificacion) {
        case 'recomendada':
            return {
                clasificacion: 'recomendada',
                mensaje: 'Estrategia óptima para tu combinación específica',
                detalle: advertenciasEspecificas.length > 0 ? 
                    advertenciasEspecificas.join("\n") : 
                    `Esta estrategia complementa y potencia los principios de tu estrategia base "${estrategiaBase.title}"`,
                icono: 'fas fa-check-circle',
                color: '#4caf50'
            };
        case 'no recomendada':
            return {
                clasificacion: 'no recomendada',
                mensaje: 'Estrategia no recomendada para tu combinación específica',
                detalle: advertenciasEspecificas.length > 0 ? 
                    advertenciasEspecificas.join("\n") : 
                    `Esta estrategia no es óptima con tu estrategia base "${estrategiaBase.title}"`,
                icono: 'fas fa-times-circle',
                color: '#f44336'
            };
        case 'neutral':
            return {
                clasificacion: 'neutral',
                mensaje: 'Estrategia compatible, pero no específicamente optimizada',
                detalle: advertenciasEspecificas.length > 0 ? 
                    advertenciasEspecificas.join("\n") : 
                    'Esta estrategia es aplicable pero no aporta beneficios adicionales a tu estrategia base',
                icono: 'fas fa-circle',
                color: '#9e9e9e'
            };
        default:
            return null;
    }
}


function procesarAdvertencias(advertencias) {
    if (!advertencias || advertencias.length === 0) {
        return [];
    }
    
    // Crear un mapeo de incompatibilidades a títulos de estrategias
    const incompatibilidadMap = {};
    
    // Recorrer todas las categorías en catalogoEstrategias
    Object.values(catalogoEstrategias).forEach(categoria => {
        categoria.forEach(estrategia => {
            // Buscar features que contengan "INCOMPATIBILIDAD:"
            estrategia.features.forEach(feature => {
                if (feature.includes("INCOMPATIBILIDAD:")) {
                    // Extraer el texto de la incompatibilidad (sin "INCOMPATIBILIDAD:")
                    const incompatibilidadText = feature.split("INCOMPATIBILIDAD:")[1].trim();
                    
                    // Normalizar el texto para búsquedas más flexibles
                    const normalizedKey = incompatibilidadText.toLowerCase().replace(/\s+/g, ' ');
                    
                    // Mapear la incompatibilidad al título de la estrategia
                    incompatibilidadMap[normalizedKey] = {
                        title: estrategia.title,
                        purpose: "",
                        fullFeature: feature
                    };
                    
                    // Buscar el propósito en las features
                    const purposeFeature = estrategia.features.find(f => 
                        f.includes("PROPÓSITO:")
                    );
                    
                    if (purposeFeature) {
                        incompatibilidadMap[normalizedKey].purpose = 
                            purposeFeature.split("PROPÓSITO:")[1].trim();
                    }
                }
            });
        });
    });
    
    // Función para calcular similitud entre strings
    function calcularSimilitud(str1, str2) {
        const a = str1.toLowerCase().replace(/\s+/g, ' ');
        const b = str2.toLowerCase().replace(/\s+/g, ' ');
        
        // Algoritmo de similitud básica (puedes mejorar esto con Levenshtein si es necesario)
        let matches = 0;
        for (let i = 0; i < Math.min(a.length, b.length); i++) {
            if (a[i] === b[i]) matches++;
        }
        
        return matches / Math.max(a.length, b.length);
    }
    
    // Procesar cada advertencia
    return advertencias.map(warning => {
        // Si la advertencia contiene "INCOMPATIBILIDAD:"
        if (warning.includes("INCOMPATIBILIDAD:")) {
            // Extraer el texto de la incompatibilidad
            const warningText = warning.split("INCOMPATIBILIDAD:")[1].trim();
            const normalizedWarning = warningText.toLowerCase().replace(/\s+/g, ' ');
            
            // Buscar la mejor coincidencia
            let mejorCoincidencia = null;
            let maxSimilitud = 0;
            
            Object.keys(incompatibilidadMap).forEach(key => {
                const similitud = calcularSimilitud(normalizedWarning, key);
                if (similitud > maxSimilitud) {
                    maxSimilitud = similitud;
                    mejorCoincidencia = key;
                }
            });
            
            // Considerar coincidencia válida si la similitud es > 0.7
            if (mejorCoincidencia && maxSimilitud > 0.7) {
                const { title, purpose, fullFeature } = incompatibilidadMap[mejorCoincidencia];
                
                // Extraer propósito si está en la feature completa
                let purposeText = "";
                if (fullFeature.includes("PROPÓSITO:")) {
                    purposeText = fullFeature.split("PROPÓSITO:")[1].trim();
                }
                
                // Construir el nuevo formato
                let newWarning = `${title}: ${warningText}`;
                
                // Si hay propósito, añadirlo
                if (purposeText) {
                    newWarning += `. ${title}: ${purposeText}`;
                }
                
                return newWarning;
            }
        }
        
        // Si no es una incompatibilidad o no encontramos coincidencia clara, mantener la advertencia original
        return warning;
    });
}
// Función adaptada para analizar tu campo features
function verificarContraindicacionEspecifica(estrategia, proposito, faseKey, estrategiaBase) {
    // 1. Contraindicaciones por propósito
    const contraindicacionProposito = estrategia.features.find(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("incompatibilidad") && 
               featLower.includes(proposito);
    });
    
    if (contraindicacionProposito) {
        return {
            mensaje: `No recomendado para propósito ${proposito}`,
            detalle: contraindicacionProposito.replace("INCOMPATIBILIDAD: ", "")
        };
    }
    
    // 2. Verificar si es válida para esta fase
    const esFaseInicial = faseKey.includes("Fase 1") || faseKey.includes("0-12");
    const contraindicacionFase = estrategia.features.find(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("incompatibilidad") && 
               ((esFaseInicial && featLower.includes("no recomendado en fases iniciales")) ||
                (!esFaseInicial && featLower.includes("solo válido para fases avanzadas")));
    });
    
    if (contraindicacionFase) {
        return {
            mensaje: `No recomendado en ${faseKey}`,
            detalle: contraindicacionFase.replace("INCOMPATIBILIDAD: ", "")
        };
    }
    
    // 3. Contraindicaciones por combinación con estrategia base
    if (estrategiaBase) {
        const contraindicacionBase = estrategia.features.find(feat => {
            const featLower = feat.toLowerCase();
            return featLower.includes("incompatibilidad") && 
                   (featLower.includes(estrategiaBase.title.toLowerCase()) ||
                    featLower.includes("estrategia base"));
        });
        
        if (contraindicacionBase) {
            return {
                mensaje: `Contraindicado con ${estrategiaBase.title}`,
                detalle: contraindicacionBase.replace("INCOMPATIBILIDAD: ", "")
            };
        }
    }
    
    // 4. Condiciones contextuales específicas no cumplidas
    const contraindicacionCondiciones = estrategia.features.find(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("incompatibilidad") && 
               (featLower.includes("no válido") || featLower.includes("no recomendado"));
    });
    
    if (contraindicacionCondiciones) {
        return {
            mensaje: `Condición no compatible`,
            detalle: contraindicacionCondiciones.replace("INCOMPATIBILIDAD: ", "")
        };
    }
    
    return null;
}

// Función adaptada para verificar validez por propósito
function verificarValidezProposito(estrategia, proposito) {
    // Normalizar propósito
    const propositoMap = {
        'salud': 'salud',
        'estetica': 'estética',
        'estet': 'estética',
        'estética': 'estética',
        'rendimiento': 'rendimiento'
    };
    
    const propositoNormalizado = propositoMap[proposito] || proposito;
    
    // Verificar si es específicamente válido para este propósito
    const esValidoParaProposito = estrategia.features.some(feat => {
        const featLower = feat.toLowerCase();
        
        // Caso 1: "PROPÓSITO: Válido para SALUD"
        if (featLower.includes(`propósito: válido para ${propositoNormalizado.toLowerCase()}`)) {
            return true;
        }
        
        // Caso 2: "PROPÓSITO: Válido para SALUD y ESTÉTICA"
        if (featLower.includes(`propósito: válido para `) && 
            featLower.includes(propositoNormalizado.toLowerCase()) &&
            (featLower.includes(" y ") || featLower.includes(" y mixto"))) {
            return true;
        }
        
        // Caso 3: "PROPÓSITO: Solo válido para SALUD"
        if (featLower.includes(`propósito: solo válido para ${propositoNormalizado.toLowerCase()}`)) {
            return true;
        }
        
        // Caso 4: "PROPÓSITO: Solo válido para ESTÉTICA Y MIXTO"
        if (featLower.includes(`propósito: solo válido para `) && 
            featLower.includes(propositoNormalizado.toLowerCase()) &&
            (featLower.includes(" y ") || featLower.includes(" y mixto"))) {
            return true;
        }
        
        // Caso 5: "PROPÓSITO: Válido para todos los propósitos"
        if (featLower.includes("propósito: válido para todos los propósitos")) {
            return true;
        }
        
        return false;
    });
    
    return esValidoParaProposito;
}

// Función adaptada para verificar validez por fase
function verificarValidezFase(estrategia, faseKey) {
    // Determinar si es fase inicial o avanzada
    const esFaseInicial = faseKey.includes("Fase 1") || faseKey.includes("0-12");
    
    // Verificar si es válida para esta fase
    const esValidoParaFase = estrategia.features.every(feat => {
        const featLower = feat.toLowerCase();
        
        // Si la estrategia tiene restricciones de fase, verificarlas
        if (featLower.includes("fases medias") || featLower.includes("fases avanzadas")) {
            return !esFaseInicial; // Solo válido para fases no iniciales
        }
        return true; // Sin restricciones de fase
    });
    
    return esValidoParaFase;
}

// Función adaptada para verificar compatibilidad con estrategia base
function verificarCompatibilidadBase(estrategia, estrategiaBase, proposito) {
    if (!estrategiaBase || !estrategiaBase.title) return true;
    
    // 1. Verificar si hay una contraindicación explícita con la estrategia base
    const contraindicacionBase = estrategia.features && Array.isArray(estrategia.features) && estrategia.features.some(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("incompatibilidad") && 
               (featLower.includes(estrategiaBase.title.toLowerCase()) ||
                featLower.includes("estrategia base"));
    });
    
    if (contraindicacionBase) {
        return false;
    }
    
    // 2. Verificar si la estrategia es específicamente recomendada para la estrategia base
    const recomendacionEspecifica = estrategia.features && Array.isArray(estrategia.features) && estrategia.features.some(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("estrategia base") && 
               featLower.includes(estrategiaBase.title.toLowerCase()) &&
               (featLower.includes("recomendada") || featLower.includes("óptima"));
    });
    
    if (recomendacionEspecifica) {
        return true;
    }
    
    // 3. Verificar compatibilidad general
    return true;
}

// Funciones auxiliares específicas
function verificarContraindicacionEspecifica(estrategia, proposito, faseKey, estrategiaBase) {
    // 1. Contraindicaciones por propósito
    if (estrategia.propósitos && estrategia.propósitos[proposito] && 
        estrategia.propósitos[proposito].estado === "no") {
        return {
            mensaje: `No recomendado para propósito ${proposito}`,
            detalle: estrategia.propósitos[proposito].motivo
        };
    }
    
    // 2. Contraindicaciones por fase
    if (estrategia.fases && estrategia.fases[faseKey] && 
        estrategia.fases[faseKey].estado === "no") {
        return {
            mensaje: `No recomendado en ${faseKey}`,
            detalle: estrategia.fases[faseKey].motivo
        };
    }
    
    // 3. Contraindicaciones por combinación con estrategia base
    if (estrategia.combinaciones && estrategiaBase && estrategiaBase.title && 
        estrategia.combinaciones[estrategiaBase.title] && 
        estrategia.combinaciones[estrategiaBase.title].estado === "no") {
        return {
            mensaje: `Contraindicado con ${estrategiaBase.title}`,
            detalle: estrategia.combinaciones[estrategiaBase.title].motivo
        };
    }
    
    // 4. Condiciones contextuales específicas no cumplidas
    if (estrategia.condiciones) {
        for (const condicion of estrategia.condiciones) {
            if (condicion.includes("solo válido") && !condicionCumplida(condicion, faseKey, estrategiaBase)) {
                return {
                    mensaje: `Requiere condición no cumplida`,
                    detalle: `Condición: ${condicion}`
                };
            }
            if (condicion.includes("no válido") && condicionCumplida(condicion, faseKey, estrategiaBase)) {
                return {
                    mensaje: `Condición no compatible`,
                    detalle: `No válido: ${condicion}`
                };
            }
        }
    }
    
    return null;
}

function condicionCumplida(condicion, faseKey, estrategiaBase) {
    // Implementación de verificación de condiciones contextuales
    if (condicion.includes("solo válido tras entrenamiento intenso")) {
        return faseKey.includes("entrenamiento");
    }
    if (condicion.includes("solo para fases avanzadas (>12 semanas)")) {
        return faseKey.includes("Avanzada") || faseKey.includes(">24");
    }
    if (condicion.includes("no válido en fases iniciales")) {
        return faseKey.includes("Fase 1");
    }
    if (condicion.includes("no válido durante ganancia activa") && estrategiaBase) {
        return estrategiaBase.aplicable.includes("ganancia");
    }
    // ... más condiciones
    return false;
}

function verificarValidezProposito(estrategia, proposito) {
    if (estrategia.propósitos && estrategia.propósitos[proposito] && 
        estrategia.propósitos[proposito].estado === "sí") {
        return true;
    }
    return false;
}

function verificarValidezFase(estrategia, faseKey) {
    if (estrategia.fases && estrategia.fases[faseKey] && 
        estrategia.fases[faseKey].estado === "sí") {
        return true;
    }
    return false;
}

function verificarCompatibilidadBase(estrategia, estrategiaBase) {
    if (!estrategiaBase || !estrategiaBase.title) return true;
    
    if (estrategia.combinaciones && estrategia.combinaciones[estrategiaBase.title] && 
        estrategia.combinaciones[estrategiaBase.title].estado === "sí") {
        return true;
    }
    return false;
}

function verificarCompatibilidadBase(estrategia, estrategiaBase, proposito) {
    if (!estrategiaBase || !estrategiaBase.title) return true;
    
    // 1. Verificar si hay una contraindicación explícita con la estrategia base
    const contraindicacionBase = estrategia.features.some(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("incompatibilidad") && 
               (featLower.includes(estrategiaBase.title.toLowerCase()) ||
                featLower.includes("estrategia base"));
    });
    
    if (contraindicacionBase) {
        return false;
    }
    
    // 2. Verificar si es la misma estrategia
    if (estrategia.title.toLowerCase() === estrategiaBase.title.toLowerCase()) {
        return true;
    }
    
    // 3. Lógica específica para MKD (Modified Ketogenic Diet)
    if (estrategiaBase.title.toLowerCase().includes("mkd") || 
        estrategiaBase.title.toLowerCase().includes("modified ketogenic") ||
        estrategiaBase.title.toLowerCase().includes("fase mkd inicial")) {
        
        // MKD es compatible consigo misma
        if (estrategia.title.toLowerCase().includes("modified ketogenic") ||
            estrategia.title.toLowerCase().includes("mkd")) {
            return true;
        }
        
        // Para propósito salud:
        if (proposito === "salud") {
            // Restricted Ketogenic Diet no es compatible con propósito salud
            if (estrategia.title.toLowerCase().includes("restricted ketogenic")) {
                return false;
            }
            
            // High Carb para Deportes de Resistencia no es compatible con propósito salud
            if (estrategia.title.toLowerCase().includes("high carb")) {
                return false;
            }
            
            // Protein Cycling no es compatible en fases iniciales para propósito salud
            if (estrategia.title.toLowerCase().includes("protein cycling")) {
                return false;
            }
            
            // Intermittent Fasting no es compatible en fases iniciales para propósito salud
            if (estrategia.title.toLowerCase().includes("intermittent fasting")) {
                return false;
            }
        }
        
        // Estrategias generalmente compatibles con MKD
        const estrategiasCompatiblesConMKD = [
            "meal timing",
            "neat optimization",
            "hydration strategy",
            "refeed strategy",
            "calorie cycling"
        ];
        
        for (const estrategiaCompatible of estrategiasCompatiblesConMKD) {
            if (estrategia.title.toLowerCase().includes(estrategiaCompatible)) {
                return true;
            }
        }
        
        // Por defecto, si no es explícitamente incompatible, asumir que es compatible
        return true;
    }
    
    // 4. Verificar propósito específico
    const esValidoParaProposito = estrategia.features.some(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes(`propósito: válido para ${proposito}`) || 
               featLower.includes(`propósito: solo válido para ${proposito}`);
    });
    
    return esValidoParaProposito;
}
// ===== FUNCIONES AUXILIARES PARA SECCIONES DINÁMICAS =====
function normalizarNombre(nombre) {
  return nombre.toLowerCase()
    .replace(/\(.*\)/g, '')
    .replace(/fase de /g, '')
    .replace(/fase /g, '')
    .replace(/low carb general/g, 'dieta low carb general')
    .replace(/low carb ciclada/g, 'dieta low carb ciclada')
    .replace(/\s+/g, ' ')
    .trim();
}

function generarSeccionesDinamicas(objetivo, proposito) {
    // Normalizar objetivo y propósito
    const objetivoNormalizado = objetivo.toLowerCase();
    const propositoNormalizado = proposito.toLowerCase();
    
    // Buscar el objetivo en nuestro objeto
    let objetivoKey;
    if (objetivoNormalizado.includes('perdida')) objetivoKey = 'perdida';
    else if (objetivoNormalizado.includes('ganancia')) objetivoKey = 'ganancia';
    else if (objetivoNormalizado.includes('mantenimiento')) objetivoKey = 'mantenimiento';
    else if (objetivoNormalizado.includes('mixto')) objetivoKey = 'mixto';
    
    // Buscar el propósito en nuestro objeto
    let propositoKey;
    if (propositoNormalizado.includes('salud')) propositoKey = 'salud';
    else if (propositoNormalizado.includes('estet')) propositoKey = 'estetica';
    else if (propositoNormalizado.includes('rendimiento')) propositoKey = 'rendimiento';
    
    // Si no encontramos coincidencias, usar valores por defecto
    if (!objetivoKey || !propositoKey) {
        return {
            recomendaciones: [],
            advertenciasGenerales: [],
            advertenciasDetalladas: []
        };
    }
    
    // CORRECCIÓN AQUÍ: Usar nombres de variables diferentes
    const recomendaciones = estrategiasEspecificasPorObjetivoProposito[objetivoKey][propositoKey].recomendaciones || [];
    const advertenciasGenerales = estrategiasEspecificasPorObjetivoProposito[objetivoKey][propositoKey].advertencias || [];
    // Usamos 'detailedWarnings' en lugar de 'advertenciasDetalladas' para evitar el conflicto
    const detailedWarnings = advertenciasDetalladas[objetivoKey][propositoKey] || [];
    
    return {
        recomendaciones,
        advertenciasGenerales,
        advertenciasDetalladas: detailedWarnings  // Renombramos la propiedad
    };
}

function normalizarEstructuraMacros(estrategiaBase, proposito) {
    // Obtener los macros para el propósito especificado
    const macrosBase = estrategiaBase.macros[`macros${proposito.charAt(0).toUpperCase() + proposito.slice(1)}`];
    
    // Si ya tiene la estructura completa (diasEntreno y diasDescanso), devolverla
    if (macrosBase.diasDescanso && macrosBase.diasEntreno) {
        return macrosBase;
    }
    
    // Caso especial: Formato de texto con "Días descanso: ... | Días entreno: ..."
    if (typeof macrosBase.proteinGr === 'string' && macrosBase.proteinGr.includes('|')) {
        const diasDescansoMatch = macrosBase.proteinGr.match(/Días descanso: ([^|]+)/);
        const diasEntrenoMatch = macrosBase.proteinGr.match(/Días entreno: ([^|]+)/);
        
        return {
            diasDescanso: {
                proteinPct: macrosBase.proteinPct,
                fatPct: macrosBase.fatPct,
                carbPct: macrosBase.carbPct,
                proteinGr: diasDescansoMatch ? diasDescansoMatch[1].trim() : macrosBase.proteinGr,
                carbinGr: macrosBase.carbinGr.includes('|') ? 
                    macrosBase.carbinGr.match(/Días descanso: ([^|]+)/)[1].trim() : macrosBase.carbinGr,
                fatinGr: macrosBase.fatinGr.includes('|') ? 
                    macrosBase.fatinGr.match(/Días descanso: ([^|]+)/)[1].trim() : macrosBase.fatinGr
            },
            diasEntreno: {
                proteinPct: macrosBase.proteinPct,
                fatPct: macrosBase.fatPct,
                carbPct: macrosBase.carbPct,
                proteinGr: diasEntrenoMatch ? diasEntrenoMatch[1].trim() : macrosBase.proteinGr,
                carbinGr: macrosBase.carbinGr.includes('|') ? 
                    macrosBase.carbinGr.match(/Días entreno: ([^|]+)/)[1].trim() : macrosBase.carbinGr,
                fatinGr: macrosBase.fatinGr.includes('|') ? 
                    macrosBase.fatinGr.match(/Días entreno: ([^|]+)/)[1].trim() : macrosBase.fatinGr
            }
        };
    }
    
    // Caso especial: Formato con semanas (semanasBajasHC, semanasAltasHC, etc.)
    if (macrosBase.semanasBajasHC || macrosBase.semanasMediasHC || macrosBase.semanasAltasHC) {
        return {
            diasDescanso: macrosBase.semanasBajasHC || macrosBase.semanasMediasHC || macrosBase,
            diasEntreno: macrosBase.semanasAltasHC || macrosBase
        };
    }
    
    // Caso especial: Formato con tipos de entrenamiento (fuerza, resistencia)
    if (macrosBase.fuerza || macrosBase.resistencia) {
        return {
            diasDescanso: macrosBase.resistencia || macrosBase,
            diasEntreno: macrosBase.fuerza || macrosBase
        };
    }
    
    // Caso especial: Formato con días de déficit/superávit
    if (macrosBase.diasDeficit || macrosBase.diasSuperavit) {
        return {
            diasDescanso: macrosBase.diasDeficit || macrosBase,
            diasEntreno: macrosBase.diasSuperavit || macrosBase
        };
    }
    
    // Si no hay diferenciación, crear una estructura estándar
    return {
        diasDescanso: macrosBase,
        diasEntreno: macrosBase
    };
}

function obtenerTipoDiaActual() {
    // Intentar obtener el tipo de día desde la interfaz de usuario
    const trainingDaysSelect = document.getElementById('trainingDays');
    if (trainingDaysSelect && trainingDaysSelect.value) {
        return trainingDaysSelect.value === 'entreno';
    }
    
    // Si no se encuentra el elemento, intentar con otros métodos
    const diaEntrenoCheckbox = document.getElementById('diaEntreno');
    if (diaEntrenoCheckbox && diaEntrenoCheckbox.checked) {
        return true;
    }
    
    // Si no hay información, verificar en el localStorage
    const tipoDia = localStorage.getItem('tipoDiaActual');
    if (tipoDia) {
        return tipoDia === 'entreno';
    }
    
    // Si no hay información, asumir que es día de entreno (más común)
    return true;
}

// Configurar evento para cuando cambia el tipo de día
document.addEventListener('DOMContentLoaded', function() {
    const trainingDaysSelect = document.getElementById('trainingDays');
    if (trainingDaysSelect) {
        trainingDaysSelect.addEventListener('change', function() {
            localStorage.setItem('tipoDiaActual', this.value);
            actualizarInterfazMacros();
        });
    }
});
function actualizarVistaPreviaHorario() {
    const estrategiaBase = obtenerEstrategiaBaseSeleccionada();
    if (!estrategiaBase) return;
    
    // Normalizar la estructura de macros
    const estrategiaNormalizada = normalizarEstructuraMacros(estrategiaBase);
    const proposito = document.getElementById('objetivoGeneral').value.toLowerCase();
    
    // Obtener macros para el propósito
    const macros = estrategiaNormalizada.macros[`macros${proposito.charAt(0).toUpperCase() + proposito.slice(1)}`];
    
    // Actualizar la vista previa
    const schedulePreview = document.getElementById('schedule-preview');
    
    // Generar HTML para la vista previa
    let html = `
        <div class="schedule-day ${esDiaEntreno ? 'training-day' : 'rest-day'}">
            <h5>${esDiaEntreno ? 'Día de Entreno' : 'Día de Descanso'}</h5>
            <div class="macro-ranges">
                <p><strong>Proteínas:</strong> ${macros[esDiaEntreno ? 'diasEntreno' : 'diasDescanso'].proteinGr}</p>
                <p><strong>Carbohidratos:</strong> ${macros[esDiaEntreno ? 'diasEntreno' : 'diasDescanso'].carbinGr}</p>
                <p><strong>Grasas:</strong> ${macros[esDiaEntreno ? 'diasEntreno' : 'diasDescanso'].fatinGr}</p>
            </div>
        </div>
    `;
    
    schedulePreview.innerHTML = html;
}
function actualizarInterfazMacrosConValores(macros) {
    // Actualizar porcentajes en los inputs
    const proteinasPctInput = document.getElementById('proteinas-pct');
    const grasaPctInput = document.getElementById('grasa-pct');
    const hcPctInput = document.getElementById('hc-pct');
    
    if (proteinasPctInput) proteinasPctInput.value = macros.proteinasPct;
    if (grasaPctInput) grasaPctInput.value = macros.grasasPct;
    if (hcPctInput) hcPctInput.value = macros.hcPct;
    
    // ACTUALIZAR CORRECTAMENTE LOS CAMPOS DE GRAMOS
    const proteinasGrElement = document.getElementById('proteinas-gr');
    const hcGrElement = document.getElementById('hc-gr');
    const grasasGrElement = document.getElementById('grasas-gr');
    
    if (proteinasGrElement) {
        proteinasGrElement.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-success" style="width: ${macros.proteinasPct}%"></div>
                </div>
                <span>${macros.proteinasPct}% (${macros.proteinasGr})</span>
            </div>
        `;
    }
    
    if (grasasGrElement) {
        grasasGrElement.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-warning" style="width: ${macros.grasasPct}%"></div>
                </div>
                <span>${macros.grasasPct}% (${macros.grasasGr})</span>
            </div>
        `;
    }
    
    if (hcGrElement) {
        hcGrElement.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-danger" style="width: ${macros.hcPct}%"></div>
                </div>
                <span>${macros.hcPct}% (${macros.hcGr})</span>
            </div>
        `;
    }
    
    // Actualizar visualización de macros
    actualizarVisualizacionMacros(macros);
}

function actualizarVisualizacionMacros(macros) {
    // Actualizar barras de progreso
    const proteinaBar = document.querySelector('.macro-progress.proteinas .progress-bar');
    const grasaBar = document.querySelector('.macro-progress.grasas .progress-bar');
    const hcBar = document.querySelector('.macro-progress.hc .progress-bar');
    
    if (proteinaBar) proteinaBar.style.width = `${macros.proteinasPct}%`;
    if (grasaBar) grasaBar.style.width = `${macros.grasasPct}%`;
    if (hcBar) hcBar.style.width = `${macros.hcPct}%`;
    
    // Actualizar texto en las barras
    const proteinaText = document.querySelector('.macro-progress.proteinas span');
    const grasaText = document.querySelector('.macro-progress.grasas span');
    const hcText = document.querySelector('.macro-progress.hc span');
    
    if (proteinaText) proteinaText.textContent = `${macros.proteinasPct}% (${macros.proteinasGr})`;
    if (grasaText) grasaText.textContent = `${macros.grasasPct}% (${macros.grasasGr})`;
    if (hcText) hcText.textContent = `${macros.hcPct}% (${macros.hcGr})`;
}

//////////FUNCIONES PARA MANEJAR TOOLTIPS EN MODAL////////////////////////
 // Función para generar contenido del tooltip
        // Función para generar contenido del tooltip
    function getTooltipContent(block, objetivo, proposito) {
      console.log('Debug - Input:', { block, objetivo, proposito });

      const normalizedBlock = block.toLowerCase().replace(/\s+/g, '');
      let normalizedObjetivo = objetivo.toLowerCase().replace(/\s+/g, '');
      
      // Normalización para objetivo
      if (normalizedObjetivo.includes('perdida1') || normalizedObjetivo.includes('perdida')) normalizedObjetivo = 'perdida';
      else if (normalizedObjetivo.includes('ganancia') || normalizedObjetivo.includes('ganacia')) normalizedObjetivo = 'ganancia';
      else if (normalizedObjetivo.includes('mantenimiento') || normalizedObjetivo.includes('mentenimeto')) normalizedObjetivo = 'mantenimiento';
      else if (normalizedObjetivo.includes('mixto') || normalizedObjetivo.includes('mixt0')) normalizedObjetivo = 'mixto';
      
      let normalizedProposito = proposito.toLowerCase().replace(/\s+/g, '');
      if (normalizedProposito.includes('salud')) normalizedProposito = 'salud';
      else if (normalizedProposito.includes('estet')) normalizedProposito = 'estetica';
      else if (normalizedProposito.includes('rendimiento')) normalizedProposito = 'rendimiento';

      console.log('Debug - Normalized:', { normalizedBlock, normalizedObjetivo, normalizedProposito });

      const data = infoMatrix[normalizedBlock]?.[normalizedObjetivo]?.[normalizedProposito];

      console.log('Debug - Data found:', !!data);

      if (!data) {
        return "Información no disponible para esta combinación. Verifica objetivo/propósito.";
      }

      return `
        <strong>Fin:</strong> ${data.fin}<br>
        <strong>Propósito:</strong> ${data.proposito}<br>
        <strong>Recomendada:</strong> ${data.recomendada}<br>
        <strong>Justificación:</strong> ${data.justificacion}
      `;
    }

    // Event listener para tooltips en los iconos
    document.addEventListener('DOMContentLoaded', () => {
      const accordionIcons = document.querySelectorAll('.accordion-button i');
      
      accordionIcons.forEach(icon => {
        icon.addEventListener('mouseover', (e) => {
          const accordionButton = e.target.closest('.accordion-button');
          const accordionId = e.target.closest('.accordion').id;
          let block;
          if (accordionId === 'accordionCetogenicas') block = 'cetogenicas';
          else if (accordionId === 'accordionCiclado') block = 'ciclado';
          else if (accordionId === 'accordionTiming') block = 'timing';
          
          if (!block) return;

          const objetivoSelect = document.getElementById('objetivo');
          const objetivo = objetivoSelect ? objetivoSelect.value : 'perdida';

          const propositoSelect = document.getElementById('proposito');
          const proposito = propositoSelect ? propositoSelect.value : 'salud';

          const tooltipContent = getTooltipContent(block, objetivo, proposito);

          // Aplicar tooltip al botón padre para mejor posicionamiento
          accordionButton.setAttribute('data-bs-toggle', 'tooltip');
          accordionButton.setAttribute('data-bs-placement', 'top');
          accordionButton.setAttribute('data-bs-html', 'true');
          accordionButton.title = tooltipContent;

          const tooltip = new bootstrap.Tooltip(accordionButton, {
            trigger: 'manual',
            customClass: 'custom-tooltip'
          });
          tooltip.show();
        });

        icon.addEventListener('mouseout', (e) => {
          const accordionButton = e.target.closest('.accordion-button');
          const tooltip = bootstrap.Tooltip.getInstance(accordionButton);
          if (tooltip) tooltip.hide();
        });
      });
    });	
///////////////////////////////////////////////////////////////////////////////////////
                // SECCION TABLA DE PLANIFICACION ( GENERAL Y DETALLADA//
///////////////////////////////////////////////////////////////////////////////////
 /** Genera y muestra la Tabla General del Proceso Nutricional.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla.
 */
		function mostrarTablaGeneralProceso(contenedorId = 'tablaGeneralProcesoContainer') {
    const contenedor = document.getElementById(contenedorId);
    if (!contenedor) {
        console.error(`No se encontró el contenedor con ID '${contenedorId}' para la Tabla General.`);
        return;
    }
    
    // Estas variables deben estar definidas en tu aplicación
    const semanasTotalesEstimadas = window.nonlinearProgressData_1?.tiempo?.semanasEstimadas || 0;
    const objetivoActual = document.getElementById('objetivo')?.value || 'perdida1';
    const pesoActualUsuario = window.currentWeightKg || 0;
   // const cambioPesoTotal = window.nonlinearProgressData_1?.objetivo?.metaKg || 0;
	const metaKg = window.nonlinearProgressData_1?.objetivo?.metaKg || 0;

		let cambioPesoTotal;
		if (objetivoActual === 'ganacia1') {
		  cambioPesoTotal = Math.abs(metaKg);
		} else if (objetivoActual === 'perdida1') {
		  cambioPesoTotal = -Math.abs(metaKg);
		} else {
		  cambioPesoTotal = 0;
		  
		}
		
    const edad = document.getElementById('age').value;
    const genero = window.userGender || 'male';
    const sexo = genero;
    const proposito = document.getElementById('objetivoGeneral')?.value || 'estetico';
    const porcentajeGrasa = parseFloat(document.getElementById('current-fat-percentage')?.value) || 0;
    const porcentajemusculo = parseFloat(document.getElementById('target-muscle-percentage')?.value) || 0;
    const nivelActividad = window.userActivityLevel || 1.375;
    const nivelEntrenamiento = (document.getElementById('is-athlete') || window.userActivityLevel > 1.55) ? 'avanzado' : 'principiante';
    
    try {
        // Verificar variables globales
        console.log('Variables globales:', {
            goalTypeGlobal: objetivoActual,
            estimatedWeeksManualGlobal: semanasTotalesEstimadas,
            currentWeightKg: pesoActualUsuario,
            weightChangeGoalManualGlobal: cambioPesoTotal,
            edad: edad,
            sexo: genero,
            porcentajeGrasa: porcentajeGrasa,
            nivelActividad: nivelActividad,
            nivelEntrenamiento: nivelEntrenamiento,
            proposito: proposito
        });

        // Esta función debe estar definida en tu aplicación
        const datosTablaObj = generarDatosTablaGeneral(
            objetivoActual,
            semanasTotalesEstimadas,
            pesoActualUsuario,
            cambioPesoTotal,
            edad,
            sexo,
            porcentajeGrasa,
            nivelActividad,
            nivelEntrenamiento,
            proposito
        );

        // Validar que datosTablaObj y datosTablaObj.datosTabla existan y sean un array
        if (!datosTablaObj || !Array.isArray(datosTablaObj.datosTabla) || datosTablaObj.datosTabla.length === 0) {
            console.warn("No se encontraron datos válidos para la tabla general:", datosTablaObj);
            return;
        }

        const datosTabla = datosTablaObj.datosTabla;

        // Calcular métricas para el resumen
        const pesoObjetivo = (parseFloat(datosTablaObj.pesoInicial) + parseFloat(cambioPesoTotal)).toFixed(1);
		
		
		
        
        // Contar fases y pausas
        const totalPausas = datosTabla.filter(fila => fila.nombreFase.includes('Pausa')).length;
        
        // Calcular semanas activas vs semanas de pausa
        const semanasActivas = datosTabla
            .filter(fila => !fila.nombreFase.includes('Pausa'))
            .reduce((total, fila) => total + fila.semanasAsignadas, 0);
            
        const semanasPausa = datosTabla
            .filter(fila => fila.nombreFase.includes('Pausa'))
            .reduce((total, fila) => total + fila.semanasAsignadas, 0);

        // Calcular correctamente la duración de cada fase
        const duracionPorFase = {};
        
        datosTabla.forEach(fila => {
            if (!fila.nombreFase.includes('Pausa')) {
                // Extraer el nombre base de la fase (sin información de ciclo)
                const nombreBase = fila.nombreFase.split(',')[0].trim();
                
                if (!duracionPorFase[nombreBase]) {
                    duracionPorFase[nombreBase] = 0;
                }
                
                duracionPorFase[nombreBase] += fila.semanasAsignadas;
            }
        });
        
        // Convertir a array para mostrar
        const duracionFases = Object.keys(duracionPorFase).map(nombre => ({
            nombre: nombre,
            semanas: duracionPorFase[nombre]
        }));
        
        // Calcular el total de fases principales
        const totalFases = duracionFases.length;

        // Generar observaciones basadas en la condición de salud y el plan
        let observacionesPlan = '';
        
        // Condición de salud
        if (datosTablaObj.condicionSalud === 'pobre') {
            observacionesPlan += `<p><strong>⚠️ Condición de salud:</strong> Se detectó una condición de salud que requiere atención. Se recomienda consultar dengan un profesional médico antes de comenzar el plan.</p>`;
        } else if (datosTablaObj.condicionSalud === 'media') {
            observacionesPlan += `<p><strong>ℹ️ Condición de salud:</strong> Su condición de salud es aceptable pero requiere seguimiento. El plan está adaptado a sus necesidades.</p>`;
        } else {
            observacionesPlan += `<p><strong>✅ Condición de salud:</strong> Su condición de salud es óptima para seguir este plan nutricional.</p>`;
        }
        
        // Tipo de obesidad
        if (datosTablaObj.tipoObesidad === 'tipo3') {
            observacionesPlan += `<p><strong>🔔 Composición corporal:</strong> Se detecta un porcentaje de grasa elevado. El plan se ha ajustado para una pérdida de peso gradual y sostenible.</p>`;
        } else if (datosTablaObj.tipoObesidad === 'tipo2') {
            observacionesPlan += `<p><strong>📋 Composición corporal:</strong> Su porcentaje de grasa está por encima del recomendado. El plan incluye estrategias específicas para mejorar su composición corporal.</p>`;
        } else if (datosTablaObj.tipoObesidad === 'tipo1') {
            observacionesPlan += `<p><strong>📊 Composición corporal:</strong> Su porcentaje de grasa está ligeramente por encima de lo ideal. El plan le ayudará a alcanzar sus objetivos.</p>`;
        }
        
        // Observaciones específicas del plan
        observacionesPlan += `<p><strong>📅 Duración del plan:</strong> ${datosTablaObj.semanasTotales} semanas con ${totalPausas} pausas metabólicas programadas.</p>`;
        
        if (totalPausas > 0) {
            observacionesPlan += `<p><strong>⏸️ Pausas metabólicas:</strong> El plan incluye ${totalPausas} pausas de una semana para recuperación metabólica. Durante estas pausas, mantendrá su peso y consumirá calorías de mantenimiento.</p>`;
        }
        
        if (objetivoActual === 'perdida1') {
            observacionesPlan += `<p><strong>🎯 Objetivo:</strong> Plan de pérdida de grasa con un déficit calórico controlado para preservar masa muscular.</p>`;
        } else if (objetivoActual === 'ganancia1') {
            observacionesPlan += `<p><strong>🎯 Objetivo:</strong> Plan de ganancia muscular con superávit calórico controlado para minimizar la ganancia de grasa.</p>`;
        } else if (objetivoActual === 'mantenimiento1') {
            observacionesPlan += `<p><strong>🎯 Objetivo:</strong> Plan de mantenimiento para conservar su composición corporal actual.</p>`;
        } else if (objetivoActual === 'mixto1') {
            observacionesPlan += `<p><strong>🎯 Objetivo:</strong> Plan mixto que alterna periodos de volumen y definición para optimizar resultados.</p>`;
        }
        
        // Verificar consistencia en las duraciones
        const semanasTotalesCalculadas = semanasActivas + semanasPausa;
        if (semanasTotalesCalculadas !== datosTablaObj.semanasTotales) {
            observacionesPlan += `<p><strong>📝 Nota:</strong> La duración total del plan (${semanasTotalesCalculadas} semanas) difiere ligeramente de la estimación inicial (${datosTablaObj.semanasTotales} semanas) debido a ajustes en la planificación de pausas metabólicas.</p>`;
        }
        
        // Recomendaciones generales
        observacionesPlan += `<p><strong>💡 Recomendaciones:</strong> Siga las proporciones de macronutrientes indicadas, mantenga una hidratación adecuada y ajuste el plan según su evolución en las reevaluaciones.</p>`;

        
        // Crear HTML del resumen
        const resumenHTML = `
            <div class="resumen-plan" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h4 style="color: #2e7d32; margin-bottom: 20px; border-bottom: 2px solid #4caf50; padding-bottom: 10px;">
                    <i class="bi bi-clipboard-data"></i> Resumen del Plan Nutricional
                </h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="resumen-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h5 style="color: #388e3c; margin-bottom: 15px;">Datos Personales</h5>
                            <div class="row">
                                <div class="col-6">
                                    <p><strong>Peso inicial:</strong><br>${datosTablaObj.pesoInicial} kg</p>
                                    <p><strong>Edad:</strong><br>${edad} años</p>
                                    <p><strong>% Grasa:</strong><br>${porcentajeGrasa}%</p>
                                </div>
                                <div class="col-6">
                                    <p><strong>Peso objetivo:</strong><br>${pesoObjetivo} kg</p>
                                    <p><strong>Género:</strong><br>${genero === 'male' ? 'Hombre' : 'Mujer'}</p>
                                    <p><strong>% Músculo:</strong><br>${porcentajemusculo}%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="resumen-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h5 style="color: #388e3c; margin-bottom: 15px;">Estadísticas del Plan</h5>
                            <div class="row">
                                <div class="col-6">
                                    <p><strong>Duración total:</strong><br>${semanasTotalesCalculadas} semanas</p>
                                    <p><strong>Total de fases:</strong><br>${totalFases}</p>
                                </div>
                                <div class="col-6">
                                    <p><strong>Semanas activas:</strong><br>${semanasActivas} semanas</p>
                                    <p><strong>Pausas metabólicas:</strong><br>${totalPausas}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="resumen-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h5 style="color: #388e3c; margin-bottom: 15px;">Duración de Cada Fase</h5>
                    <div class="row">
                        ${duracionFases.map((fase, index) => `
                            <div class="col-md-${duracionFases.length > 2 ? '4' : '6'} col-sm-6">
                                <div class="fase-duracion" style="background: #f1f8e9; padding: 10px; border-radius: 6px; margin-bottom: 10px; text-align: center;">
                                    <strong>${fase.nombre.split(':')[0]}</strong><br>
                                    <span style="font-size: 18px; color: #2e7d32;">${fase.semanas} semanas</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="resumen-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h5 style="color: #388e3c; margin-bottom: 15px;">Objetivo y Propósito</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Objetivo principal:</strong><br>
                            ${objetivoActual === 'perdida1' ? 'Pérdida de grasa' : 
                              objetivoActual === 'ganancia1' ? 'Ganancia muscular' : 
                              objetivoActual === 'mantenimiento1' ? 'Mantenimiento' : 'Plan mixto'}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Propósito:</strong><br>
                            ${proposito === 'estetico' ? 'Estético' : 
                              proposito === 'rendimiento' ? 'Rendimiento' : 'Salud'}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="resumen-item" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h5 style="color: #388e3c; margin-bottom: 15px;">Observaciones del Plan</h5>
                    <div class="observaciones-plan">
                        ${observacionesPlan}
                    </div>
                </div>
            </div>
        `;

        // Agrupar fases y pausas manteniendo el orden original
        const fasesAgrupadas = agruparFasesYPausasEnOrden(datosTabla);
        
        let htmlCard = `
            <div class="card-body" style="margin-top: -1rem; padding-top: 0.5rem;">
                ${resumenHTML}
                <div class="table-responsive tabla-planificacion-wrapper mb-0">
                    <table id="tablaGeneralProceso" class="table table-striped table-bordered align-middle tabla-planificacion">
                        <thead>
                            <tr>
								<th scope="col" style="width: 10%;">Fase</th>
								<th scope="col" style="width: 15%;">Nombre</th>
								<th scope="col" style="width: 15%;">Duración</th>
								<th scope="col" style="width: 10%;">Peso Inicial</th>
								<th scope="col" style="width: 10%;">Peso Final</th>
								<th scope="col" style="width: 15%;">Objetivo</th>
								<!--<th scope="col" style="width: 15%;">Acciones</th>-->
							</tr>
                        </thead>
                        <tbody>
        `;

        // Generar acordeones para cada grupo de fases
        fasesAgrupadas.forEach((grupo, index) => {
            htmlCard += generarAcordeonGrupoProfesional(grupo, index);
        });

        htmlCard += `
                        </tbody>
                    </table>
                </div>
                <p class="text-muted small mt-2"><em>* Los valores de gramos por día son estimaciones basadas en el peso inicial de la fase y una aproximación del gasto energético. Pueden variar según la actividad diaria.</em></p>
            </div>
        `;

        contenedor.innerHTML = htmlCard;
        
        // Añadir event listeners para los acordeones
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                content.classList.toggle('show');
                
                // Rotar el ícono
                const icon = header.querySelector('.accordion-icon');
                if (icon) {
                    icon.classList.toggle('bi-chevron-down');
                    icon.classList.toggle('bi-chevron-up');
                }
            });
        });
        
        // ✅ Añadir estilos CSS para las filas de pausa si no existen
        if (!document.querySelector('style#tabla-estilos')) {
            const style = document.createElement('style');
            style.id = 'tabla-estilos';
            style.textContent = `
                tr.pausa {
                    background-color: #fff4e6 !important;
                    font-style: italic;
                }
                tr.pausa td {
                    color: #f39c12;
                }
                .accordion-phase {
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    margin-bottom: 10px;
                }
                .accordion-header {
                    background-color: #e9ecef;
                    padding: 12px 15px;
                    cursor: pointer;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid #dee2e6;
					border-radius: 8px;
                }
                .accordion-header:hover {
                    background-color: #dee2e6;
                }
                .accordion-content {
                    display: none;
                    padding: 0;
                    overflow: hidden;
                }
                .accordion-content.show {
                    display: table-row-group;
                }
                .phase-badge {
                    background-color: #6c757d;
                    color: white;
                    padding: 3px 8px;
                    border-radius: 15px;
                    font-size: 12px;
                    margin-left: 10px;
                }
                .pause-badge {
                    background-color: #fd7e14;
                    color: white;
                    padding: 3px 8px;
                    border-radius: 15px;
                    font-size: 12px;
                    margin-left: 10px;
                }
                .resumen-plan {
                    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                    padding: 20px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                }
                .resumen-item {
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                }
                .fase-duracion {
                    background: #f1f8e9;
                    padding: 10px;
                    border-radius: 6px;
                    margin-bottom: 10px;
                    text-align: center;
                }
            `;
            document.head.appendChild(style);
        }
    } catch (error) {
        console.error('Error al generar la tabla:', error);
    }
}

function agruparFasesYPausasEnOrden(datosTabla) {
    const grupos = {};
    let currentGroupKey = null;
    
    datosTabla.forEach(fila => {
        if (!fila.nombreFase.includes('Pausa')) {
            const match = fila.nombreFase.match(/^(Fase \d+):/);
            const groupKey = match ? match[1] : fila.nombreFase.split(':')[0].trim();
            currentGroupKey = groupKey;
            
            let nombreFase = fila.nombreFase;
            if (fila.nombreFase.includes(':')) {
                nombreFase = fila.nombreFase.split(':').pop().trim();
            }
            
            if (!grupos[groupKey]) {
                grupos[groupKey] = {
                    nombre: groupKey,
                    tipo: groupKey,
                    nombreFase: nombreFase,
                    fases: [],
                    todasLasFilas: []
                };
            }
            
            grupos[groupKey].fases.push(fila);
            grupos[groupKey].todasLasFilas.push(fila);
        } 
        else if (currentGroupKey && grupos[currentGroupKey]) {
            grupos[currentGroupKey].todasLasFilas.push(fila);
        }
    });
    
    return Object.values(grupos);
}

// Función para generar el HTML de un grupo de acordeón con diseño profesional

function generarAcordeonGrupoProfesional(grupo, index) {
    const semanasTotales = grupo.todasLasFilas.reduce((sum, fila) => sum + fila.semanasAsignadas, 0);
    const fases = grupo.fases;
    const pesoInicial = fases.length > 0 ? fases[0].pesoInicioFase : 0;
    const pesoFinal = fases.length > 0 ? fases[fases.length - 1].pesoFinFase : 0;
    const numeroFase = grupo.tipo.match(/\d+/)?.[0] || (index + 1);
	const nombreFase= grupo.nombreFase;
    // Define el mapa de iconos basado en el número de fase
    const iconMap = {
        1: '<i class="fa-solid fa-bolt"></i>',
        2: '<i class="fa-solid fa-seedling"></i>',
        3: '<i class="fas fa-balance-scale me-2"></i>',
        4: '<i class="fas fa-exchange-alt me-2"></i>'
    };
    const phaseIcon = iconMap[numeroFase] || '';

    return `
        <tr class="accordion-phase">
			<td colspan="6" class="p-0">
				<div class="accordion-header" style="border-radius: 10px; overflow: hidden;">
					<table class="table mb-0" style="width: 100%; margin-bottom: 0 !important;">
						<tbody>
							<tr style="background-color: #f8f9fa; text-align: center;">
								<td style="width: 13%; vertical-align: middle; text-align: left;">
									${phaseIcon}
									<strong>${grupo.nombre}</strong> 
									<span class="badge bg-primary">Fase ${numeroFase}</span>
								</td>
								<td style="width: 25%; vertical-align: middle; text-align: left;">
									<strong>${nombreFase}</strong>
								</td>
								<td style="width: 19%; vertical-align: middle;">
									<strong>${semanasTotales} semanas</strong>
								</td>
								<td style="width: 15%; vertical-align: middle;">
									<strong>${pesoInicial} kg</strong>
								</td>
								<td style="width: 15%; vertical-align: middle;">
									<strong>${pesoFinal} kg</strong>
								</td>
								<td style="width: 25%; vertical-align: middle;font-size: 11px;">
									${fases.length > 0 ? fases[0].objetivoPrincipal : ''}
								</td>
								<td style="width: 15%; vertical-align: middle; text-align: center;">
									<button class="btn btn-sm btn-outline-secondary me-1" 
											data-bs-toggle="modal" 
											data-bs-target="#editModal"
											data-fase-nombre="${grupo.nombre}"
											data-fase-numero="${numeroFase}"
											onclick="openEditModal(event, this)">
										<i class="bi bi-pencil"></i>
									</button>
									<i class="bi bi-chevron-down accordion-icon" style="cursor: pointer;"></i>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
                <div class="accordion-content">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 10%">Meses</th>
                                <th scope="col" style="width: 8%">Semanas</th>
                                <th scope="col" style="width: 8%">ReEval<br><small>(Semana)</small></th>
                                <th scope="col" style="width: 15%">Fase</th>
                                <th scope="col" style="width: 10%">% Pt<br><small>(g/día)</small></th>
                                <th scope="col" style="width: 10%">% GR<br><small>(g/día)</small></th>
                                <th scope="col" style="width: 10%">% CH<br><small>(g/día)</small></th>
                                <th scope="col" style="width: 12%">Objetivo Principal</th>
                                <th scope="col" style="width: 12%">Observaciones</th>
                                <th scope="col" style="width: 5%">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generarFilasGrupoCompleto(grupo)}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
    `;
}

// Función para configurar el modal con la información de la fase
function configurarModalParaFase(nombreFase, numeroFase) {
    // Actualizar el título del modal con el nombre de la fase
    document.getElementById('modal-phase-title').textContent = `Configuración de Estrategias - ${nombreFase}`;
    
    // Aquí puedes agregar lógica adicional para preconfigurar el modal
    // según el tipo de fase (Fase 1, 2, 3, etc.)
    console.log(`Configurando modal para: ${nombreFase} (Fase ${numeroFase})`);
    
    // Ejemplo: Seleccionar estrategias predeterminadas según el tipo de fase
    if (numeroFase === 1) {
        // Configuración para Fase 1: Inducción Cetogénica
        seleccionarEstrategiaBase('cetogenica');
    } else if (numeroFase === 2) {
        // Configuración para Fase 2: Ciclado Metabólico
        seleccionarEstrategiaBase('ciclado');
    } else if (numeroFase === 3) {
        // Configuración para Fase 3: Transición a Mantenimiento
        seleccionarEstrategiaBase('mantenimiento');
    }
}

// Función de ejemplo para seleccionar una estrategia base
function seleccionarEstrategiaBase(tipo) {
    console.log(`Seleccionando estrategia base: ${tipo}`);
    // Aquí iría la lógica para seleccionar y mostrar la estrategia base en el modal
}

// Añadir estos estilos CSS para mejorar la apariencia del modal y la tabla
if (!document.querySelector('style#tabla-estilos-mejorados')) {
    const style = document.createElement('style');
    style.id = 'tabla-estilos-mejorados';
    style.textContent = `
        .accordion-phase {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: white;
        }
        .accordion-header {
            padding: 0;
            cursor: pointer;
        }
        .accordion-header table {
            margin-bottom: 0;
        }
        .accordion-header:hover {
            background-color: #f1f3f5;
        }
        .accordion-content {
            display: none;
            padding: 0;
            overflow: hidden;
        }
        .accordion-content.show {
            display: block;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-header .bi-chevron-down {
            transform: rotate(0deg);
        }
        .accordion-header .bi-chevron-up {
            transform: rotate(180deg);
        }
        tr.pausa {
            background-color: #fff4e6 !important;
            font-style: italic;
        }
        tr.pausa td {
            color: #f39c12;
        }
        .badge {
            font-size: 0.75em;
        }
        
        /* Estilos para el modal de estrategias */
        .phase-config-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        .phase-config-section h5 {
            color: #2c3e50;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        .macro-config {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .macro-input {
            flex: 1;
            text-align: center;
        }
        .macro-input label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .macro-input input {
            width: 100%;
            text-align: center;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: white;
        }
        .macro-values {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #6c757d;
        }
        .strategy-category {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background-color: white;
            border: 1px solid #e9ecef;
        }
        .training-config {
            padding: 1rem;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        .days-selector, .intensity-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .day-option, .intensity-option {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            flex: 1;
        }
        .day-option:hover, .intensity-option:hover {
            background-color: #e9ecef;
        }
        .day-option.selected, .intensity-option.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .schedule-days {
            display: flex;
            gap: 0.5rem;
        }
        .schedule-day {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .schedule-day.training {
            background-color: #d4edda;
            color: #155724;
        }
        .schedule-day.rest {
            background-color: #f8d7da;
            color: #721c24;
        }
        .save-config-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .save-config-btn:hover {
            background-color: #218838;
        }
    `;
    document.head.appendChild(style);
}

// Función para generar todas las filas de un grupo (fases + pausas en orden)
function generarFilasGrupoCompleto(grupo) {
    let filasHTML = '';
    
    grupo.todasLasFilas.forEach(fila => {
        const proteinas_g_kg = fila.proteinas_g_kg || (fila.proteinas_g_dia / fila.pesoInicioFase).toFixed(1);
        const carbohidratos_g_kg = fila.carbohidratos_g_kg || (fila.carbohidratos_g_dia / fila.pesoInicioFase).toFixed(1);
        const grasas_g_kg = fila.grasas_g_kg || (fila.grasas_g_dia / fila.pesoInicioFase).toFixed(1);

        if (fila.nombreFase.includes('Pausa')) {
		 const datosFaseParaJS_pausa = encodeURIComponent(JSON.stringify({
                nombreFase: fila.nombreFase,
                semanasAsignadas: fila.semanasAsignadas,
                mesesTexto: fila.mesesTexto,
                macrosBase: {
                    proteinasPct: fila.proteinasPct,
                    carbohidratosPct: fila.carbohidratosPct,
                    grasasPct: fila.grasasPct
                },
                proteinas_g_dia: fila.proteinas_g_dia,
                carbohidratos_g_dia: fila.carbohidratos_g_dia,
                grasas_g_dia: fila.grasas_g_dia,
                proteinas_g_kg: proteinas_g_kg,
                carbohidratos_g_kg: carbohidratos_g_kg,
                grasas_g_kg: grasas_g_kg,
                pesoInicioFase: fila.pesoInicioFase,
                pesoFinFase: fila.pesoFinFase,
                objetivoPrincipal: fila.objetivoPrincipal,
                observaciones: fila.observaciones,
                semanaReevaluacion: fila.semanaReevaluacion
            }));
            // Es una pausa
            filasHTML += `
                <tr class="pausa">
                    <td>${fila.mesesTexto}</td>
                    <td>${fila.semanasAsignadas}</td>
                    <td class="text-center">${fila.semanaReevaluacion ? `${fila.semanaReevaluacion}ª sem` : 'N/A'}</td>
                    <td><strong>${fila.nombreFase}</strong> <span class="pause-badge">Pausa</span></td>
                    <td class="text-center">
                        <strong>${fila.proteinasPct}%</strong><br>
                        <small>${fila.proteinas_g_dia}g (${proteinas_g_kg}g/kg)</small>
                    </td>
                    <td class="text-center">
                        <strong>${fila.grasasPct}%</strong><br>
                        <small>${fila.grasas_g_dia}g (${grasas_g_kg}g/kg)</small>
                    </td>
                    <td class="text-center">
                        <strong>${fila.carbohidratosPct}%</strong><br>
                        <small>${fila.carbohidratos_g_dia}g (${carbohidratos_g_kg}g/kg)</small>
                    </td>
                    <td>${fila.objetivoPrincipal}</td>
                    <td class="small">${fila.observaciones}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary ver-detalles-fase-btn" 
                                data-fase-info="${datosFaseParaJS_pausa}"
                                onclick="verDetallesFase(this)">Ver Detalles Semanales</button>
                    </td>
                </tr>
            `;
        } else {
            // Es una fase normal
            const datosFaseParaJS = encodeURIComponent(JSON.stringify({
                nombreFase: fila.nombreFase,
                semanasAsignadas: fila.semanasAsignadas,
                mesesTexto: fila.mesesTexto,
                macrosBase: {
                    proteinasPct: fila.proteinasPct,
                    carbohidratosPct: fila.carbohidratosPct,
                    grasasPct: fila.grasasPct
                },
                proteinas_g_dia: fila.proteinas_g_dia,
                carbohidratos_g_dia: fila.carbohidratos_g_dia,
                grasas_g_dia: fila.grasas_g_dia,
                proteinas_g_kg: proteinas_g_kg,
                carbohidratos_g_kg: carbohidratos_g_kg,
                grasas_g_kg: grasas_g_kg,
                pesoInicioFase: fila.pesoInicioFase,
                pesoFinFase: fila.pesoFinFase,
                objetivoPrincipal: fila.objetivoPrincipal,
                observaciones: fila.observaciones,
                semanaReevaluacion: fila.semanaReevaluacion
            }));
            
            filasHTML += `
                <tr>
                    <td>${fila.mesesTexto}</td>
                    <td>${fila.semanasAsignadas}</td>
                    <td class="text-center">${fila.semanaReevaluacion ? `${fila.semanaReevaluacion}ª sem` : 'N/A'}</td>
                    <td><strong>${fila.nombreFase}</strong></td>
                    <td class="text-center">
                        <strong>${fila.proteinasPct}%</strong><br>
                        <small>${fila.proteinas_g_dia}g (${proteinas_g_kg}g/kg)</small>
                    </td>
                    <td class="text-center">
                        <strong>${fila.grasasPct}%</strong><br>
                        <small>${fila.grasas_g_dia}g (${grasas_g_kg}g/kg)</small>
                    </td>
                    <td class="text-center">
                        <strong>${fila.carbohidratosPct}%</strong><br>
                        <small>${fila.carbohidratos_g_dia}g (${carbohidratos_g_kg}g/kg)</small>
                    </td>
                    <td>${fila.objetivoPrincipal}</td>
                    <td class="small">${fila.observaciones}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary ver-detalles-fase-btn" 
                                data-fase-info="${datosFaseParaJS}"
                                onclick="verDetallesFase(this)">Ver Detalles Semanales</button>
                    </td>
                </tr>
            `;
        }
    });
    
    return filasHTML;
}











 /* Genera los datos para la Tabla General del Proceso Nutricional,
 * adaptando las fases según el objetivo del usuario (pérdida, ganancia, mantenimiento, mixto).
 * @returns {Object|null} Un objeto con fases, datosTabla, semanasTotales, pesoInicial, etc., o null si hay error.
 */
/**
 * Genera los datos para la Tabla General del Proceso Nutricional,
 * adaptando las fases según el objetivo del usuario (pérdida, ganancia, mantenimiento, mixto).
 * @returns {Object|null} Un objeto con fases, datosTabla, semanasTotales, pesoInicial, etc., o null si hay error.
 */
function generarDatosTablaGeneral() {
    // --- 1. Recuperar datos desde DOM y variables globales ---
    const goalTypeGlobal = document.getElementById('objetivo')?.value || 'perdida1';
    const objetivoActual = goalTypeGlobal;
    const pesoActualUsuario = window.nonlinearProgressData_1?.objetivo?.pesoInicial || 0;
    const metaKg = window.nonlinearProgressData_1?.objetivo?.metaKg || 0;

	// ✅ Ajustar el signo de cambioPesoTotal según el objetivo
	const cambioPesoTotal = goalTypeGlobal === 'perdida1'
		? -Math.abs(metaKg)
		: metaKg;
	
    const edad = userAge || 0;
    const genero = userGender || 'male';
    const proposito = document.getElementById('objetivoGeneral')?.value || 'estetico';
    const porcentajeGrasa = parseFloat(document.getElementById('current-fat-percentage')?.value) || null;
    const nivelActividad = userActivityLevel || 1.375;
    const nivelEntrenamiento = document.getElementById('is-athlete') || nivelActividad > 1.55 ? 'avanzado' : 'principiante';
	const semanasTotalesEstimadas_Nolineal= window.nonlinearProgressData_1?.tiempo?.semanasEstimadas;
	
	window.semanasTotalesEstimadas= semanasTotalesEstimadas_Nolineal;
	
    // --- 2. Validación inicial mejorada ---
    const variables = {
        semanasTotalesEstimadas: window.nonlinearProgressData_1?.tiempo?.semanasEstimadas || 0,
        cambioPesoTotal,
        pesoActualUsuario,
        objetivoActual,
        porcentajeGrasa,
        genero,
        edad
    };

    let hayVariablesInvalidas = false;
    let variablesInvalidas = [];

		// Permite números negativos, solo verifica que no sea NaN y que no sea null/undefined
    Object.entries(variables).forEach(([key, value]) => {
			if (value === null || value === undefined || (typeof value === 'number' && isNaN(value))) {
				hayVariablesInvalidas = true;
				variablesInvalidas.push(key);
			}
    });

    if (hayVariablesInvalidas) {
        console.warn("⚠️ No se puede generar la Tabla General. Variables con problemas:", variablesInvalidas);
        return null;
    }

    // Convertir a número
    const semanas = parseFloat(variables.semanasTotalesEstimadas);
    const cambio = parseFloat(cambioPesoTotal);
    const peso = parseFloat(pesoActualUsuario);

    if (isNaN(semanas) || isNaN(cambio) || isNaN(peso) || isNaN(porcentajeGrasa) || porcentajeGrasa < 0 || porcentajeGrasa > 100) {
        console.warn("Valores no numéricos o inválidos.");
        return null;
    }

    // --- 3. Diagnóstico de salud ---
    function determinarCondicionSalud() {
        const esHombre = genero === 'male';
        const umbralTipo1 = esHombre ? 27 : 26;
        const umbralTipo2 = esHombre ? 35 : 34;
        const umbralTipo3 = esHombre ? 36 : 35;

        let tipoObesidad = null;
        let condicion = 'óptima';

        if (porcentajeGrasa >= umbralTipo3) {
            tipoObesidad = 'tipo3';
            condicion = 'pobre';
        } else if (porcentajeGrasa >= umbralTipo2) {
            tipoObesidad = 'tipo2';
            condicion = 'pobre';
        } else if (porcentajeGrasa >= umbralTipo1) {
            tipoObesidad = 'tipo1';
            condicion = 'media';
        } else {
            tipoObesidad = 'normal';
            condicion = 'óptima';
        }

        if (edad > 60 && (tipoObesidad === 'tipo2' || tipoObesidad === 'tipo3')) {
            condicion = 'pobre';
        }
        if (nivelActividad < 1.375 && (tipoObesidad === 'tipo2' || tipoObesidad === 'tipo3')) {
            condicion = 'pobre';
        }
        if (objetivoActual === 'perdida1' && Math.abs(cambio) > 1.0 && semanas < 8) {
            condicion = 'pobre';
        }
        if (nivelEntrenamiento !== 'avanzado') {
            const umbralGrasaBaja = genero === 'female' ? 18 : 10;
            if (porcentajeGrasa < umbralGrasaBaja && peso < 50) {
                condicion = 'pobre';
            }
        }

        return { tipoObesidad, condicion };
    }

    const resultado = determinarCondicionSalud();
    const tipoObesidad = resultado.tipoObesidad;
    const condicionSalud = resultado.condicion;

    window.condicionSalud = condicionSalud;

    if (condicionSalud === 'pobre') {
        console.warn("🚨 Condiciones de salud: 'pobre'. Se recomienda consulta médica antes de continuar.");
        alert("⚠️ Se detectaron condiciones de salud de alto riesgo. Se recomienda consultar a un profesional antes de generar el plan.");
       
    }

    // --- 4. Inicializar objetos globales (CRUCIAL) ---
    window.planConfig = window.planConfig || {};
    window.pausas = window.pausas || {};

    // --- 5. Definir plantillas de fases ---
    const plantillasFases = {
        ganancia1: [
            { id: 'evaluacion_base', nombre: "Fase 1: Evaluación y Base", duracionPredeterminadaSemanas: 4, objetivoPrincipal: "Evaluar estado inicial, establecer hábitos, preparar el cuerpo" },
            { id: 'volumen_progresivo', nombre: "Fase 2: Volumen Progresivo", duracionPredeterminadaSemanas: 8, objetivoPrincipal: "Maximizar hipertrofia con superávit controlado" },
            { id: 'mantenimiento_reajuste', nombre: "Fase 3: Mantenimiento y Reajuste", duracionPredeterminadaSemanas: 8, objetivoPrincipal: "Consolidar ganancias, prevenir exceso de grasa" },
            { id: 'optimizacion_avanzada', nombre: "Fase 4: Optimización y Volumen Avanzado", duracionPredeterminadaSemanas: 16, objetivoPrincipal: "Afinar hipertrofia en atletas intermedios/avanzados" }
        ],
        perdida1: [
            { id: 'induccion_cetogenica', nombre: "Fase 1: Inducción Perdida Peso", duracionPredeterminadaSemanas: 6, objetivoPrincipal: "Reset metabólico, inicio de pérdida de grasa, reducción de insulina" },
            { id: 'ciclado_metabolico', nombre: "Fase 2: Ciclado Metabólico", duracionPredeterminadaSemanas: 10, objetivoPrincipal: "Continuar pérdida de peso, mantener rendimiento físico, evitar estancamiento" },
            { id: 'transicion_mantenimiento', nombre: "Fase 3: Transición a Mantenimiento", duracionPredeterminadaSemanas: 8, objetivoPrincipal: "Mantener peso perdido, favorecer adherencia social y equilibrio nutricional" }
        ],
        mantenimiento1: [
            { id: 'transicion_mantenimiento', nombre: "Subfase 1: Transición al Mantenimiento", duracionPredeterminadaSemanas: 3, objetivoPrincipal: "Estabilizar peso corporal tras volumen o definición" },
            { id: 'mantenimiento_estable', nombre: "Subfase 2: Mantenimiento Estable", duracionPredeterminadaSemanas: 6, objetivoPrincipal: "Preservar masa muscular y optimizar rendimiento" },
            { id: 'reevaluacion_preparacion', nombre: "Subfase 3: Reevaluación y Preparación", duracionPredeterminadaSemanas: 3, objetivoPrincipal: "Evaluar progreso y preparar próximo ciclo (volumen o definición)" }
        ],
        mixto1: [
            { id: 'volumen_controlado', nombre: "Fase 1: Volumen Controlado", duracionPredeterminadaSemanas: 8, objetivoPrincipal: "Ganancia muscular con mínimo aumento de grasa" },
            { id: 'definicion_controlada', nombre: "Fase 2: Definición Controlada", duracionPredeterminadaSemanas: 8, objetivoPrincipal: "Reducir grasa corporal con preservación muscular óptima" },
            { id: 'mantenimiento_metabolico', nombre: "Fase 3: Mantenimiento Metabólico", duracionPredeterminadaSemanas: 6, objetivoPrincipal: "Estabilizar metabolismo, mejorar adherencia y prevenir rebote" },
            { id: 'ajuste_metabolico', nombre: "Fase 4: Ajuste Metabólico", duracionPredeterminadaSemanas: 4, objetivoPrincipal: "Recuperación adaptativa, mejora de sensibilidad hormonal y sostenibilidad a largo plazo" }
        ]
    };

    // --- 6. Configurar parámetros por objetivo ---
    let fasesParaPlan = [];
    let ratios = [];
    let minSemanasPorFase = [];
    let maxSemanasPorFase = [];
    let caloriasAjustadasBase = 0;
    let semanasPausaPorCiclo = 1;
    let cicloFase2 = 8;
    let cicloFase4 = 8;

    // Inicializar pausas para este objetivo (si no existe)
    window.pausas[objetivoActual] = window.pausas[objetivoActual] || {};
    window.pausas[objetivoActual].semanasPausaFase2 = 0;
    window.pausas[objetivoActual].semanasPausaFase4 = 0;

    // --- 7. Lógica específica por objetivo ---
    if (objetivoActual === 'mantenimiento1') {
        const isCorta = semanas < 12;
        const isMedia = semanas >= 12 && semanas < 24;
        const isLarga = semanas >= 24;

        ratios = isCorta ? [1, 2] : isMedia ? [1, 3, 2] : [1, 3, 2, 1];
        minSemanasPorFase = [4, 6, 4, 4];
        maxSemanasPorFase = [6, 16, 24, 12];

        fasesParaPlan = isCorta ? plantillasFases.mantenimiento1.slice(0, 2) :
                       isMedia ? plantillasFases.mantenimiento1.slice(0, 3) :
                       plantillasFases.mantenimiento1;

        caloriasAjustadasBase = 0;

        cicloFase2 = proposito === 'estetico' ? 8 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        cicloFase4 = proposito === 'estetico' ? 12 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        semanasPausaPorCiclo = (proposito === 'salud' && edad > 60) ? 0 : (proposito === 'salud' ? 0 : 1);

    } else if (objetivoActual === 'ganancia1') {
        const isCorta = semanas < 12;
        const isMedia = semanas >= 12 && semanas < 24;
        const isLarga = semanas >= 24;

        ratios = isCorta ? [1, 2] : isMedia ? [proposito === 'rendimiento' ? 2 : 1, 4, 2] : [proposito === 'rendimiento' ? 2 : 1, 4, 2, 2];
        minSemanasPorFase = [edad > 60 ? 6 : 4, 6, 4, 6];
        maxSemanasPorFase = [edad > 60 ? 8 : 6, 20, 12, 12];

        fasesParaPlan = isCorta ? plantillasFases.ganancia1.slice(0, 2) :
                       isMedia ? plantillasFases.ganancia1.slice(0, 3) :
                       plantillasFases.ganancia1;

        caloriasAjustadasBase = proposito === 'salud' ? 0.05 : proposito === 'estetico' ? 0.10 : 0.15;

        cicloFase2 = proposito === 'estetico' ? 8 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        cicloFase4 = proposito === 'estetico' ? 12 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        semanasPausaPorCiclo = (proposito === 'salud' && edad > 60) ? 0 : (proposito === 'salud' ? 0 : 1);
		
			
			
    } else if (objetivoActual === 'perdida1') {
        const isCorta = semanas < 12;
        const isMedia = semanas >= 12 && semanas < 24;
        const isLarga = semanas >= 24;

        ratios = isCorta ? [1, 2] : isMedia ? [proposito === 'rendimiento' ? 2 : 1, 4, 2] : [proposito === 'rendimiento' ? 2 : 1, 4, 2, 1];
        minSemanasPorFase = [4, 6, 4, 4];
        maxSemanasPorFase = [6, 16, 12, 12];

        fasesParaPlan = isCorta ? plantillasFases.perdida1.slice(0, 2) :
                       isMedia ? plantillasFases.perdida1.slice(0, 3) :
                       plantillasFases.perdida1;

        caloriasAjustadasBase = proposito === 'salud' ? -0.05 : proposito === 'estetico' ? -0.10 : -0.15;

        cicloFase2 = proposito === 'estetico' ? 8 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        cicloFase4 = proposito === 'estetico' ? 12 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
       semanasPausaPorCiclo = (proposito === 'salud' && edad > 60) ? 0 : (proposito === 'salud' ? 0 : 1);

		

    } else if (objetivoActual === 'mixto1') {
        const isCorta = semanas < 12;
        const isMedia = semanas >= 12 && semanas <= 36;
        const isLarga = semanas > 36;

        const genderMap = { 'male': 'HOMBRE', 'female': 'MUJER' };
        const generoUppercase = genderMap[genero.toLowerCase()] || 'HOMBRE';

        const RANGOS_MASA_MUSCULAR = {
            HOMBRE: {
                '18-25': { min: 38, max: 54, optimo: 46 },
                '26-35': { min: 36, max: 52, optimo: 44 },
                '36-45': { min: 34, max: 50, optimo: 42 },
                '46-55': { min: 32, max: 48, optimo: 40 },
                '56-65': { min: 30, max: 46, optimo: 38 },
                '65+': { min: 28, max: 44, optimo: 36 }
            },
            MUJER: {
                '18-25': { min: 28, max: 42, optimo: 35 },
                '26-35': { min: 26, max: 40, optimo: 33 },
                '36-45': { min: 24, max: 38, optimo: 31 },
                '46-55': { min: 22, max: 36, optimo: 29 },
                '56-65': { min: 20, max: 34, optimo: 27 },
                '65+': { min: 18, max: 32, optimo: 25 }
            }
        };

        const rangoEdad = edad >= 18 && edad <= 25 ? '18-25' :
                         edad >= 26 && edad <= 35 ? '26-35' :
                         edad >= 36 && edad <= 45 ? '36-45' :
                         edad >= 46 && edad <= 55 ? '46-55' :
                         edad >= 56 && edad <= 65 ? '56-65' : '65+';

        const rangos = RANGOS_MASA_MUSCULAR[generoUppercase]?.[rangoEdad];
        if (!rangos) throw new Error('Rango de masa muscular no encontrado');

        const factorActividad = {
            1.2: 0.8, 1.375: 0.9, 1.55: 1.0, 1.75: 1.1, 1.9: 1.2
        }[nivelActividad] || 1.0;

        let porcentajeMasaMuscularObjetivo = 0;
        const porcentajeMasaMuscularActual = parseFloat(document.getElementById('target-muscle-percentage')?.value) || 0;

        if (porcentajeMasaMuscularActual) {
            porcentajeMasaMuscularObjetivo = Math.min(
                porcentajeMasaMuscularActual + (rangos.optimo - porcentajeMasaMuscularActual) * 0.6 * factorActividad,
                rangos.max
            );
        } else {
            porcentajeMasaMuscularObjetivo = rangos.optimo * factorActividad;
        }

        porcentajeMasaMuscularObjetivo = Math.max(
            Math.min(Math.round(porcentajeMasaMuscularObjetivo * 10) / 10, rangos.max),
            rangos.min
        );

        let gananciaMuscularObjetivoKg = parseFloat(document.getElementById('desired-lean-mass-gain')?.value) || 0;
        if (!gananciaMuscularObjetivoKg) {
            gananciaMuscularObjetivoKg = (porcentajeMasaMuscularObjetivo / 100 * (peso + (porcentajeMasaMuscularObjetivo - porcentajeMasaMuscularActual) / 100 * peso) - porcentajeMasaMuscularActual / 100 * peso);
        }

        const semanasPorKgMusculo = 12;
        const semanasPorReduccionGrasa = 10;
        const tiempoMusculo = gananciaMuscularObjetivoKg > 0 ? gananciaMuscularObjetivoKg * semanasPorKgMusculo : 0;
        const grasaAEliminarKg = peso * (porcentajeGrasa / 100 - (document.getElementById('target-fat-percentage')?.value || 0) / 100);
        const tiempoGrasa = grasaAEliminarKg > 0 ? Math.ceil(grasaAEliminarKg / (peso * 0.005)) : 0;

        let semanasTotalEstimadas = Math.max(tiempoMusculo, tiempoGrasa) + 12;

        const ratiosBase = isCorta ? [1, 2] : isMedia ? [2, 3, 2] : [2, 3, 2, 2];
        const proporcionTotal = ratiosBase.reduce((a, b) => a + b, 0);
        let ratioVolumen = ratiosBase[0];
        let ratioDefinicion = ratiosBase[1];

        if (gananciaMuscularObjetivoKg > grasaAEliminarKg) ratioVolumen += 1;
        else if (grasaAEliminarKg > gananciaMuscularObjetivoKg) ratioDefinicion += 1;

        ratios = isCorta ? [1, 2] : isMedia ? [ratioVolumen, ratioDefinicion, 2] : [ratioVolumen, ratioDefinicion, 2, 2];
        const nuevaProporcionTotal = ratios.reduce((a, b) => a + b, 0);

        minSemanasPorFase = [
            edad > 60 && proposito === 'salud' ? 6 : 4,
            edad > 60 && proposito === 'salud' ? 8 : 6,
            edad > 60 && proposito === 'salud' ? 6 : 4,
            edad > 60 && proposito === 'salud' ? 6 : 4
        ];
        maxSemanasPorFase = [
            edad > 60 && proposito === 'salud' ? 10 : 8,
            edad > 60 && proposito === 'salud' ? 20 : 16,
            edad > 60 && proposito === 'salud' ? 16 : 12,
            edad > 60 && proposito === 'salud' ? 16 : 12
        ];

        fasesParaPlan = isCorta ? plantillasFases.mixto1.slice(0, 2) :
                       isMedia ? plantillasFases.mixto1.slice(0, 3) :
                       plantillasFases.mixto1;

        caloriasAjustadasBase = 0;

        cicloFase2 = proposito === 'estetico' ? 6 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 8;
        cicloFase4 = proposito === 'estetico' ? 8 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        semanasPausaPorCiclo = (proposito === 'salud' && edad > 60) ? 0 : 1;
			if (proposito === 'salud' && edad > 60) {
			semanasPausaPorCiclo = 0;
			} else if (isCorta) {
				semanasPausaPorCiclo = 0;
			} else {
				semanasPausaPorCiclo = 1;
			}

        // Calcular pausas una sola vez
        const semanasFase2Estimadas = Math.round((ratios[1] / nuevaProporcionTotal) * semanasTotalEstimadas);
        window.pausas[objetivoActual].semanasPausaFase2 = cicloFase2 > 0 ? Math.floor(semanasFase2Estimadas / cicloFase2) * semanasPausaPorCiclo : 0;

        if (isLarga && ratios[3]) {
            const semanasFase4Estimadas = Math.round((ratios[3] / nuevaProporcionTotal) * semanasTotalEstimadas);
            if (semanasFase4Estimadas >= cicloFase4) {
                window.pausas[objetivoActual].semanasPausaFase4 = Math.floor(semanasFase4Estimadas / cicloFase4) * semanasPausaPorCiclo;
            }
        }

        const semanasTotalesEstimadas = Math.round(semanasTotalEstimadas);
		
		let semTotales;

		
    }
	
	if (semanasTotalesEstimadas_Nolineal > semanasTotalesEstimadas) {
			semTotales = semanasTotalesEstimadas_Nolineal;
		} else {
			semTotales = semanasTotalesEstimadas;
		}
		window.semanasTotalesEstimadas = semTotales;
		

    // --- 8. Calcular pausas para todas las fases ---
    const proporcionTotal = ratios.reduce((a, b) => a + b, 0);
    const datosTabla = [];
    let semanasAsignadasAcumuladas = 0;
    let pesoAcumulado = peso;
    const numeroFases = fasesParaPlan.length;

    if (numeroFases === 0) {
        console.error("No hay fases definidas para el objetivo seleccionado.");
        return null;
    }

    const fasesCalculadas = [];

		   // --- 9. Bucle principal: forEach sobre fases ---
// --- 9. Bucle principal: forEach sobre fases ---
fasesParaPlan.forEach((fase, index) => {
    // Si ya hemos alcanzado el límite de semanas, no procesar más fases
    if (semanasAsignadasAcumuladas >= semanasTotalesEstimadas) {
        return;
    }

    let semanasParaEstaFase;
    const factorProporcion = ratios[index] || 1;
    const proporcion = factorProporcion / proporcionTotal;

    const semanasDisponibles = semanasTotalesEstimadas -
        (window.pausas[objetivoActual]?.semanasPausaFase2 || 0) -
        (index === 3 ? (window.pausas[objetivoActual]?.semanasPausaFase4 || 0) : 0);

    semanasParaEstaFase = Math.round(proporcion * semanasDisponibles);

    if (index === numeroFases - 1) {
        semanasParaEstaFase = semanasTotalesEstimadas - semanasAsignadasAcumuladas -
            (window.pausas[objetivoActual]?.semanasPausaFase2 || 0) -
            (window.pausas[objetivoActual]?.semanasPausaFase4 || 0);
        semanasParaEstaFase = Math.max(0, semanasParaEstaFase);
    }

    // Asegurar que no excedamos el total de semanas
    if (semanasAsignadasAcumuladas + semanasParaEstaFase > semanasTotalesEstimadas) {
        semanasParaEstaFase = semanasTotalesEstimadas - semanasAsignadasAcumuladas;
    }

    // Si no hay semanas disponibles, salir
    if (semanasParaEstaFase <= 0) {
        return;
    }

    // --- 10. Pausas metabólicas dentro de la fase ---
    let numeroPausas = 0;

    // ✅ Calcular número de pausas
    if (semanasParaEstaFase >= 8) {
        numeroPausas = 1; // Primera pausa en semana 8
        if (semanasParaEstaFase > 8) {
            numeroPausas += Math.floor((semanasParaEstaFase - 8) / 6); // Pausa cada 6 semanas
        }
    } else if (semanasParaEstaFase >= cicloFase2 && semanasPausaPorCiclo > 0) {
        numeroPausas = Math.floor(semanasParaEstaFase / cicloFase2);
    }

    // Ajustar el número de pausas si excede las semanas disponibles
    const semanasPausaTotal = numeroPausas;
    if (semanasAsignadasAcumuladas + semanasParaEstaFase + semanasPausaTotal > semanasTotalesEstimadas) {
        numeroPausas = Math.max(0, semanasTotalesEstimadas - semanasAsignadasAcumuladas - semanasParaEstaFase);
    }

    // --- Nuevo enfoque: generar array de bloques (fase y pausas) ---
    let blocks = [];
    let currentWeek = 1;
    const firstBlockLength = 7;
    const nextBlockLength = 6;

    if (numeroPausas > 0) {
        // Primer bloque de fase
        let blockLength = Math.min(firstBlockLength, semanasParaEstaFase);
        blocks.push({ type: 'phase', start: currentWeek, end: currentWeek + blockLength - 1 });
        currentWeek += blockLength;

        for (let p = 0; p < numeroPausas; p++) {
            if (currentWeek > semanasParaEstaFase || semanasAsignadasAcumuladas + currentWeek > semanasTotalesEstimadas) {
                break;
            }

            // Agregar pausa
            blocks.push({ type: 'pause', start: currentWeek, end: currentWeek });
            currentWeek += 1;

            if (currentWeek > semanasParaEstaFase || semanasAsignadasAcumuladas + currentWeek > semanasTotalesEstimadas) {
                break;
            }

            // Agregar siguiente bloque de fase
            blockLength = Math.min(nextBlockLength, semanasParaEstaFase - currentWeek + 1);
            // Ajustar si excede el total de semanas
            if (semanasAsignadasAcumuladas + currentWeek + blockLength - 1 > semanasTotalesEstimadas) {
                blockLength = semanasTotalesEstimadas - semanasAsignadasAcumuladas - currentWeek + 1;
            }
            
            blocks.push({ type: 'phase', start: currentWeek, end: currentWeek + blockLength - 1 });
            currentWeek += blockLength;
        }
    } else {
        // Sin pausas
        let blockLength = semanasParaEstaFase;
        // Ajustar si excede el total de semanas
        if (semanasAsignadasAcumuladas + blockLength > semanasTotalesEstimadas) {
            blockLength = semanasTotalesEstimadas - semanasAsignadasAcumuladas;
        }
        blocks.push({ type: 'phase', start: 1, end: blockLength });
    }

    // --- 11. Generar la fase con pausas integradas usando blocks array ---
    let pauseIndex = 0;
    
    // ✅ CALCULO CORREGIDO: Guardar el acumulado inicial de esta fase
    const semanasAcumuladasInicioFase = semanasAsignadasAcumuladas;
    
    blocks.forEach(block => {
        // Verificar si hemos alcanzado el límite de semanas
        if (semanasAsignadasAcumuladas >= semanasTotalesEstimadas) {
            return;
        }

        const semanasEnEsteBloque = block.end - block.start + 1;

        // ✅ Calcular cambio de peso para este bloque
        const cambioPesoEnEstaFase = cambioPesoTotal * (semanasEnEsteBloque / semanasTotalesEstimadas);
        
        // ✅ CALCULO CORREGIDO: Calcular semana global de inicio y fin
        // Usar el acumulado actual para el inicio del bloque
        const semanaGlobalInicio = semanasAsignadasAcumuladas + 1;
        const semanaGlobalFin = semanasAsignadasAcumuladas + semanasEnEsteBloque;

        // ✅ CALCULO CORREGIDO: Calcular meses correctamente
        const calcularMesDesdeSemana = (semanaGlobal) => {
            return Math.floor((semanaGlobal - 1) / 4) + 1;
        };

        const mesInicio = calcularMesDesdeSemana(semanaGlobalInicio);
        const mesFin = calcularMesDesdeSemana(semanaGlobalFin);
        
        // ✅ FORMATO CORREGIDO: Asegurar que los meses se muestren correctamente
        let mesesTexto = "";
        if (block.type === 'pause') {
            mesesTexto = "Pausa";
        } else {
            if (mesInicio === mesFin) {
                mesesTexto = `${mesInicio}`;
            } else {
                mesesTexto = `${mesInicio}–${mesFin}`;
            }
        }

        // ✅ CALCULO CORREGIDO: Asegurar que la semana de reevaluación sea correcta
        const semanaReevaluacion = semanaGlobalInicio;

        if (block.type === 'pause') {
            pauseIndex++;
            // Bloque de pausa
            const nombrePausa = `Pausa Metabólica (tras ${fase.nombre}, Ciclo ${pauseIndex})`;

            // ✅ Insertar pausa como fila dentro de la fase
            datosTabla.push({
                mesesTexto: mesesTexto,
                nombreFase: nombrePausa,
                proteinasPct: 25,
                carbohidratosPct: 40,
                grasasPct: 35,
                proteinas_g_dia: Math.round(1.8 * pesoAcumulado),
                carbohidratos_g_dia: Math.round(4.0 * pesoAcumulado),
                grasas_g_dia: Math.round(1.0 * pesoAcumulado),
                proteinas_g_kg: 1.8,
                carbohidratos_g_kg: 4.0,
                grasas_g_kg: 1.0,
                pesoInicioFase: pesoAcumulado,
                pesoFinFase: pesoAcumulado,
                objetivoPrincipal: "Recuperación metabólica y descanso",
                observaciones: "Mantener calorías al nivel de GET. Reducir intensidad de entrenamiento. Priorizar recuperación y sueño.",
                semanasAsignadas: 1,
                semanasPausa: 0,
                semanaReevaluacion: semanaReevaluacion,
                mes: mesInicio,
                semanaEnMes: ((semanaGlobalInicio - 1) % 4) + 1
            });

            // ✅ Guardar datos de pausa en window.planConfig
            window.planConfig[nombrePausa] = {
                semanasPausa: 0,
                ratios: ratios,
                numeroFases: numeroFases,
                semanasTotales: semanasTotalesEstimadas
            };

            // Actualizar estado acumulado para la pausa (1 semana)
            semanasAsignadasAcumuladas += 1;
        } else {
            // Bloque de fase normal
            const nombreFase = fase.nombre;

            // --- Validar pesoAcumulado ---
            if (isNaN(pesoAcumulado) || pesoAcumulado === null || pesoAcumulado === undefined) {
                console.error("Peso acumulado inválido:", pesoAcumulado);
                pesoAcumulado = 0; // Valor por defecto
            }

            const pesoFase = pesoAcumulado;

            // --- 13. Macros y observaciones ---
            // ... (todo el código de macros y observaciones se mantiene igual) ...
					// --- 13. Macros y observaciones ---
								let caloriasAjustadas = caloriasAjustadasBase;
								let proteinasPct = 25;
								let proteinas_g_kg = 2.0;
								let carbohidratosPct = 40;
								let carbohidratos_g_kg = 4.0;
								let grasasPct = 35;
								let grasas_g_kg = 0.8;
								let observacionesNutricionales = fase.nombre;

								if (objetivoActual === 'mantenimiento1') {
									if (index === 0) {
										caloriasAjustadas = 0;
										proteinasPct = 20;
										proteinas_g_kg = 1.8;
										carbohidratosPct = 50;
										carbohidratos_g_kg = 5.0;
										grasasPct = 30;
										grasas_g_kg = 0.6;
										observacionesNutricionales += " Transición: estabilizar peso post-ciclo. Timing: 20-40g proteína post-entreno.";
									} else if (index === 1) {
										caloriasAjustadas = 0;
										proteinasPct = 25;
										proteinas_g_kg = 2.0;
										carbohidratosPct = 40;
										carbohidratos_g_kg = 3.5;
										grasasPct = 35;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Mantenimiento estable: mantener masa muscular.";
									} else if (index === 2) {
										caloriasAjustadas = 0;
										proteinasPct = 25;
										proteinas_g_kg = 2.0;
										carbohidratosPct = 40;
										carbohidratos_g_kg = 3.5;
										grasasPct = 35;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Reevaluación: preparar próximo ciclo.";
									}
								} else if (objetivoActual === 'ganancia1') {
									if (index === 0) {
										caloriasAjustadas = 0.15;
										proteinasPct = 25;
										proteinas_g_kg = 2.2;
										carbohidratosPct = 45;
										carbohidratos_g_kg = 4.0;
										grasasPct = 30;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Volumen: ganancia controlada.";
									} else if (index === 1) {
										caloriasAjustadas = 0.10;
										proteinasPct = 25;
										proteinas_g_kg = 2.4;
										carbohidratosPct = 40;
										carbohidratos_g_kg = 3.5;
										grasasPct = 35;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Hipertrofia avanzada.";
									} else if (index === 2) {
										caloriasAjustadas = 0.05;
										proteinasPct = 25;
										proteinas_g_kg = 2.4;
										carbohidratosPct = 40;
										carbohidratos_g_kg = 3.5;
										grasasPct = 35;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Consolidación de ganancias.";
									} else if (index === 3) {
										caloriasAjustadas = 0.05;
										proteinasPct = 25;
										proteinas_g_kg = 2.4;
										carbohidratosPct = 40;
										carbohidratos_g_kg = 3.5;
										grasasPct = 35;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Optimización avanzada.";
									}
								} else if (objetivoActual === 'perdida1') {
									if (index === 0) {
										caloriasAjustadas = -0.15;
										proteinasPct = 30;
										proteinas_g_kg = 2.6;
										carbohidratosPct = 30;
										carbohidratos_g_kg = 2.5;
										grasasPct = 40;
										grasas_g_kg = 1.0;
										observacionesNutricionales += " Reset metabólico.";
									} else if (index === 1) {
										caloriasAjustadas = -0.10;
										proteinasPct = 30;
										proteinas_g_kg = 2.6;
										carbohidratosPct = 35;
										carbohidratos_g_kg = 3.0;
										grasasPct = 35;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Continuar pérdida de grasa.";
									} else if (index === 2) {
										caloriasAjustadas = -0.05;
										proteinasPct = 25;
										proteinas_g_kg = 2.2;
										carbohidratosPct = 40;
										carbohidratos_g_kg = 3.5;
										grasasPct = 35;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Transición a mantenimiento.";
									}
								} else if (objetivoActual === 'mixto1') {
									if (index === 0) {
										caloriasAjustadas = 0.10;
										proteinasPct = 25;
										proteinas_g_kg = 2.6;
										carbohidratosPct = 40;
										carbohidratos_g_kg = 4.0;
										grasasPct = 35;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Ganancia muscular con mínimo aumento de grasa.";
									} else if (index === 1) {
										caloriasAjustadas = -0.05;
										proteinasPct = 25;
										proteinas_g_kg = 2.6;
										carbohidratosPct = 45;
										carbohidratos_g_kg = 4.0;
										grasasPct = 30;
										grasas_g_kg = 0.6;
										observacionesNutricionales += " Reducir grasa corporal con preservación muscular óptima.";
									} else if (index === 2) {
										caloriasAjustadas = 0;
										proteinasPct = 25;
										proteinas_g_kg = 2.4;
										carbohidratosPct = 40;
										carbohidratos_g_kg = 3.5;
										grasasPct = 35;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Estabilizar metabolismo.";
									} else if (index === 3) {
										caloriasAjustadas = 0.05;
										proteinasPct = 25;
										proteinas_g_kg = 2.4;
										carbohidratosPct = 40;
										carbohidratos_g_kg = 3.5;
										grasasPct = 35;
										grasas_g_kg = 0.8;
										observacionesNutricionales += " Recuperación adaptativa.";
									}
								}

								// --- 13. Calcular valores base ---
								let proteinas_g_dia = Math.round(proteinas_g_kg * pesoFase);
								let carbohidratos_g_dia = Math.round(carbohidratos_g_kg * pesoFase);
								let grasas_g_dia = Math.round(grasas_g_kg * pesoFase);

								// --- 14. Calcular g/kg ---
								let proteinas_g_kg_actual = Math.round(proteinas_g_dia / pesoFase * 10) / 10;
								let carbohidratos_g_kg_actual = Math.round(carbohidratos_g_dia / pesoFase * 10) / 10;
								let grasas_g_kg_actual = Math.round(grasas_g_dia / pesoFase * 10) / 10;

								// Ajustar valores extremos
								if (proteinas_g_kg < 1.5) proteinas_g_kg = 1.5;
								if (carbohidratos_g_kg < 2.0) carbohidratos_g_kg = 2.0;
								if (grasas_g_kg < 0.5) grasas_g_kg = 0.5;

								// Ajustar % para sumar 100
								const totalPct = proteinasPct + carbohidratosPct + grasasPct;
								if (totalPct !== 100) {
									const factor = 100 / totalPct;
									proteinasPct = parseFloat((proteinasPct * factor).toFixed(1));
									carbohidratosPct = parseFloat((carbohidratosPct * factor).toFixed(1));
									grasasPct = parseFloat((100 - proteinasPct - carbohidratosPct).toFixed(1));
								}

								// Observaciones personalizadas
								let observacionesPersonalizadas = "";
								if (objetivoActual === 'mantenimiento1') {
									observacionesPersonalizadas = "Calorías: 0% superávit (igual al GET). Flexibilidad selectiva (80/20).";
									if (index === 0) observacionesPersonalizadas += " Transición: estabilizar peso post-ciclo. Timing: 20-40g proteína post-entreno.";
									else if (index === 1) observacionesPersonalizadas += " Mantenimiento estable: mantener masa muscular.";
									else if (index === 2) observacionesPersonalizadas += " Reevaluación: preparar próximo ciclo.";
								} else if (objetivoActual === 'ganancia1') {
									observacionesPersonalizadas = "Calorías: +5-10% sobre GET. Volumen: ganancia controlada.";
									if (index === 0) observacionesPersonalizadas += " Estrategia: Volumen controlado.";
									else if (index === 1) observacionesPersonalizadas += " Estrategia: Hipertrofia avanzada.";
									else if (index === 2) observacionesPersonalizadas += " Estrategia: Consolidación.";
									else if (index === 3) observacionesPersonalizadas += " Estrategia: Optimización avanzada.";
								} else if (objetivoActual === 'perdida1') {
									observacionesPersonalizadas = "Calorías: 0-5% bajo GET. Definición: reducir grasa.";
									if (index === 0) observacionesPersonalizadas += " Estrategia: Reset metabólico.";
									else if (index === 1) observacionesPersonalizadas += " Estrategia: Ciclado metabólico.";
									else if (index === 2) observacionesPersonalizadas += " Estrategia: Transición a mantenimiento.";
								} else if (objetivoActual === 'mixto1') {
									observacionesPersonalizadas = "Calorías: ";
									if (index === 0) observacionesPersonalizadas += "+5-10% sobre GET. Volumen: ganancia controlada.";
									else if (index === 1) observacionesPersonalizadas += "0-5% bajo GET. Definición: reducir grasa.";
									else if (index === 2) observacionesPersonalizadas += "0% (GET). Mantenimiento: equilibrio metabólico.";
									else if (index === 3) observacionesPersonalizadas += "0-5% (GET). Ajuste: recuperación adaptativa.";
								}

								if (nivelEntrenamiento === 'principiante') {
									if (index === 0) {
										proteinasPct = Math.min(proteinasPct + 5, 35);
										carbohidratosPct = Math.max(carbohidratosPct - 5, 20);
										grasasPct = 100 - proteinasPct - carbohidratosPct;
									}
								}

								if (nivelActividad < 1.375) {
									grasasPct = Math.min(grasasPct + 10, 50);
									carbohidratosPct = Math.max(carbohidratosPct - 10, 10);
									proteinasPct = 100 - grasasPct - carbohidratosPct;
								}

								if (edad > 60) {
									proteinasPct = Math.min(proteinasPct + 5, 35);
									grasasPct = Math.max(grasasPct - 5, 10);
									carbohidratosPct = 100 - proteinasPct - grasasPct;
								}

								if (genero === 'female' && edad > 50) {
									proteinasPct = Math.min(proteinasPct + 5, 35);
									carbohidratosPct = Math.max(carbohidratosPct - 5, 10);
									grasasPct = 100 - proteinasPct - carbohidratosPct;
								}

								if (porcentajeGrasa > (genero === 'female' ? 30 : 25)) {
									carbohidratosPct = Math.max(carbohidratosPct - 10, 10);
									grasasPct = Math.min(grasasPct + 10, 50);
									proteinasPct = 100 - carbohidratosPct - grasasPct;
								}

								if (porcentajeGrasa < (genero === 'female' ? 18 : 10)) {
									carbohidratosPct = Math.min(carbohidratosPct + 10, 60);
									grasasPct = Math.max(grasasPct - 10, 10);
									proteinasPct = 100 - carbohidratosPct - grasasPct;
								}

								if (numeroPausas > 0) {
									observacionesPersonalizadas += ` Incluye ${numeroPausas} pausas metabólicas de 1 semana cada una para recuperación metabólica.`;
								}

								if (proposito === 'estetico') {
									observacionesPersonalizadas += " Enfoque en definición muscular.";
								} else if (proposito === 'rendimiento') {
									observacionesPersonalizadas += " Optimización de fuerza y rendimiento.";
								} else if (proposito === 'salud') {
									observacionesPersonalizadas += " Mejora de salud y funcionalidad.";
								}

								if (edad > 60) {
									observacionesPersonalizadas += " Proteínas altas para prevenir sarcopenia.";
								}

								if (genero === 'female' && edad > 50) {
									observacionesPersonalizadas += " Mayor énfasis en proteínas para posmenopáusicas.";
								}

								let observaciones = observacionesPersonalizadas + " " + observacionesNutricionales;
            // --- Finalizar fase ---
            const pesoInicioFaseCalculado = parseFloat(pesoAcumulado.toFixed(2));
            const pesoFinFaseCalculado = parseFloat((pesoAcumulado + cambioPesoEnEstaFase).toFixed(2));

            // Agregar a fasesCalculadas
            fasesCalculadas.push({
                id: fase.id,
                nombre: fase.nombre,
                duracionPredeterminadaSemanas: semanasParaEstaFase,
                mesesTexto: mesesTexto,
                macrosBase: {
                    proteinasPct: proteinasPct,
                    carbohidratosPct: carbohidratosPct,
                    grasasPct: grasasPct,
                    proteinas_g_dia: Math.round(proteinas_g_kg * pesoFase),
                    carbohidratos_g_dia: Math.round(carbohidratos_g_kg * pesoFase),
                    grasas_g_dia: Math.round(grasas_g_kg * pesoFase),
                    proteinas_g_kg: Math.round(proteinas_g_dia / pesoFase * 10) / 10,
                    carbohidratos_g_kg: Math.round(carbohidratos_g_dia / pesoFase * 10) / 10,
                    grasas_g_kg: Math.round(grasas_g_dia / pesoFase * 10) / 10
                },
                objetivoPrincipal: fase.objetivoPrincipal,
                observaciones: observacionesNutricionales,
                semanaReevaluacion: semanaReevaluacion
            });

            window.planConfig[fase.nombre] = {
                semanasPausa: 0,
                ratios: ratios,
                numeroFases: numeroFases,
                semanasTotales: semanasTotalesEstimadas
            };

            datosTabla.push({
                mesesTexto: mesesTexto,
                nombreFase: nombreFase,
                proteinasPct: proteinasPct,
                proteinas_g_dia: Math.round(proteinas_g_kg * pesoFase),
                proteinas_g_kg: Math.round(proteinas_g_dia / pesoFase * 10) / 10,
                carbohidratosPct: carbohidratosPct,
                carbohidratos_g_dia: Math.round(carbohidratos_g_kg * pesoFase),
                carbohidratos_g_kg: Math.round(carbohidratos_g_dia / pesoFase * 10) / 10,
                grasasPct: grasasPct,
                grasas_g_dia: Math.round(grasas_g_kg * pesoFase),
                grasas_g_kg: Math.round(grasas_g_dia / pesoFase * 10) / 10,
                pesoInicioFase: pesoInicioFaseCalculado,
                pesoFinFase: pesoFinFaseCalculado,
                objetivoPrincipal: fase.objetivoPrincipal,
                observaciones: observacionesNutricionales,
                semanasAsignadas: semanasEnEsteBloque,
                semanasPausa: 0,
                semanaReevaluacion: semanaReevaluacion
            });

            // Actualizar estado acumulado para el bloque de fase
            pesoAcumulado = parseFloat((pesoAcumulado + cambioPesoEnEstaFase).toFixed(2));
            semanasAsignadasAcumuladas += semanasEnEsteBloque;
        }
    });
}); // <- Cierre del forEach

// --- 16. Retornar resultados ---
return {
    fases: fasesCalculadas,
    datosTabla,
    semanasTotales: Math.min(semanasAsignadasAcumuladas, semanasTotalesEstimadas), // No exceder el límite
    pesoInicial: peso,
    objetivoActual,
    proposito,
    tipoObesidad,
    condicionSalud
};
}

	/**
	 * Se ejecuta cuando el usuario hace clic en "Ver Detalles Semanales" en la Tabla General.
	 * @param {HTMLElement} boton - El botón que fue clickeado.
	 */
	function verDetallesFase(boton) {
		// Obtener los datos de la fase del atributo data-fase-info
		const datosFaseEncoded = boton.getAttribute('data-fase-info');
		if (!datosFaseEncoded) {
			console.error("No se encontraron datos de fase en el botón.");
			return;
		}

		let datosFase;
		try {
			datosFase = JSON.parse(decodeURIComponent(datosFaseEncoded));
		} catch (e) {
			console.error("Error al parsear datos de fase:", e);
			return;
		}

		console.log("Fase seleccionada para detalles:", datosFase);

		// --- Llamar a la función que generará y mostrará la tabla detallada ---
		// Pasamos los datos de la fase y el ID del contenedor donde se mostrará
		generarYMostrarTablaDetallada(datosFase, 'tablaDetalladaFaseContainer');
	}

 /* Genera y muestra la Tabla Detallada por Semanas para una fase específica, con controles interactivos.
 * @param {Object} datosFase - Los datos de la fase seleccionada desde la Tabla General.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla detallada.
 */
 function crearSelectActividad(indiceFila, actividadSeleccionada) {
    // Mapa de valores de actividad a nombres legibles
    const opcionesActividad = {
        1.2: 'Sedentario',
        1.375: 'Ligero (1-3 días/semana)',
        1.55: 'Moderado (3-5 días/semana)',
        1.725: 'Activo (6-7 días/semana)',
        1.9: 'Muy Activo (Intenso/Diario)'
    };

    let opcionesHTML = '';
    for (const [valor, nombre] of Object.entries(opcionesActividad)) {
        const valorNumerico = parseFloat(valor);
        const seleccionado = valorNumerico === actividadSeleccionada ? 'selected' : '';
        // --- CORRECCIÓN: Envolver indiceFila entre comillas simples ---
        opcionesHTML += `<option value="${valorNumerico}" ${seleccionado}>${nombre}</option>`;
    }

    // --- CORRECCIÓN: Envolver indiceFila entre comillas simples ---
    return `
        <select id="select-actividad-${indiceFila}" class="form-select form-select-sm"
                onchange="actualizarFilaPorActividad('${indiceFila}', this.value)">
            ${opcionesHTML}
        </select>
    `;
}
/**
 * Genera y muestra la Tabla Detallada por Semanas para una fase específica, con controles interactivos.
 * @param {Object} datosFase - Los datos de la fase seleccionada desde la Tabla General.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertará la tabla detallada.
 */
function generarYMostrarTablaDetallada(datosFase, contenedorId = 'tablaDetalladaFaseContainer') {
    // --- 1. Validar argumentos ---
    if (!datosFase || typeof datosFase !== 'object') {
        console.error("Error: datosFase no es un objeto válido en generarYMostrarTablaDetallada.", datosFase);
        return;
    }
    if (!contenedorId || typeof contenedorId !== 'string') {
        console.error("Error: contenedorId no es una cadena válida en generarYMostrarTablaDetallada.", contenedorId);
        return;
    }
    
    // Obtener semanas totales del plan
    const semanasTotalesPlan = window.nonlinearProgressData_1?.tiempo?.semanasEstimadas || 30;

    // --- 2. Obtener el contenedor donde se mostrará la tabla ---
    const contenedor = document.getElementById(contenedorId);
    if (!contenedor) {
        console.error(`No se encontró el contenedor con ID '${contenedorId}' para la Tabla Detallada.`);
        const errorMsgElement = document.getElementById('errorMessage');
        if (errorMsgElement) {
            errorMsgElement.textContent = `Error: No se encontró el contenedor para mostrar los detalles de la fase.`;
            errorMsgElement.style.display = 'block';
        }
        return;
    }

    // --- 3. Mostrar un mensaje de carga mientras se generan los datos ---
    contenedor.innerHTML = '<p class="info-message">Generando detalles de la fase... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></p>';
    contenedor.style.display = 'block';

    try {
        // --- 4. Generar los datos para la tabla detallada ---
        const resultadoGeneracion = generarDatosTablaDetallada(datosFase);
        if (!resultadoGeneracion || typeof resultadoGeneracion !== 'object') {
            throw new Error("generarDatosTablaDetallada no devolvió un objeto válido.");
        }

        const datosPorMes = resultadoGeneracion.datosPorMes;
        const estrategiasDisponibles = resultadoGeneracion.estrategiasDisponibles || [];
        const semanasTotalesPlanCalculadas = resultadoGeneracion.semanasTotalesPlan || semanasTotalesPlan;

        if (!Array.isArray(datosPorMes) || datosPorMes.length === 0) {
            throw new Error("No se generaron datos de meses para la tabla detallada o el array está vacío.");
        }

        // --- 5. Determinar si es una pausa metabólica ---
        const esPausaFase = datosFase.nombreFase.includes('Pausa');

        // --- 6. Calcular el mes global inicial basado en la semana de reevaluación ---
        const semanaInicioFase = datosFase.semanaReevaluacion;
        const mesGlobalInicio = Math.ceil(semanaInicioFase / 4);

        // --- 7. Construir el HTML del accordion ---
        let htmlTablaDetallada = `
            <div class="card mb-1">
                <div class="card-header" style="background-color: #e8f5e9; border-bottom: 1px solid #c8e6c9;">
                    <h2 class="mb-0"><i class="fas fa-list"></i>  Detalles de la Fase: ${datosFase.nombreFase} (${datosFase.mesesTexto})</h2>
                    <p class="mb-0"><small>Peso estimado: ${datosFase.pesoInicioFase.toFixed(1)} kg → ${datosFase.pesoFinFase.toFixed(1)} kg | Objetivo: ${datosFase.objetivoPrincipal}</small></p>
                </div>
                <div class="card-body">
                    <div class="accordion" id="accordionMeses">
        `;

                datosPorMes.forEach((mesData, mesIndex) => {
            // Calcular posición global del mes
            const mesGlobal = mesGlobalInicio + mesIndex;

            // --- Estilo especial si es fase de pausa ---
            const estiloMesHeader = esPausaFase
                 ? 'style="color: rgb(243, 156, 18); font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Helvetica, Arial, sans-serif, \'Apple Color Emoji\', \'Segoe UI Emoji\', \'Segoe UI Symbol\'; font-size: 28.8px; font-weight: 600; font-style: normal; line-height: 34.56px; text-align: start; text-decoration: none; text-transform: none; white-space: normal;"'
				: '';

            htmlTablaDetallada += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingMes${mesData.mes}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseMes${mesData.mes}" aria-expanded="${mesIndex === 0 ? 'true' : 'false'}"
                                aria-controls="collapseMes${mesData.mes}" ${estiloMesHeader}>
                            Mes ${mesData.mes} - Posición Global: Mes ${mesGlobal}
                        </button>
                    </h2>
                    <div id="collapseMes${mesData.mes}" class="accordion-collapse collapse ${mesIndex === 0 ? 'show' : ''}"
                         aria-labelledby="headingMes${mesData.mes}" data-bs-parent="#accordionMeses">
                        <div class="accordion-body">
                            <div class="accordion" id="accordionSemanasMes${mesData.mes}">
            `;

            mesData.semanas.forEach((semanaData, semanaIndex) => {
                // --- Obtener estrategias globales ---
                let estrategiasGlobalesSeleccionadas = [];
                try {
                    if (typeof getSelectedStrategies === 'function') {
                        estrategiasGlobalesSeleccionadas = getSelectedStrategies();
                        if (estrategiasGlobalesSeleccionadas.length === 1 && estrategiasGlobalesSeleccionadas[0] === 'ninguna') {
                            estrategiasGlobalesSeleccionadas = [];
                        }
                    } else {
                        console.warn("Función getSelectedStrategies no encontrada al generar la tabla.");
                    }
                } catch (e) {
                    console.error("Error al obtener estrategias globales en generarYMostrarTablaDetallada:", e);
                    estrategiasGlobalesSeleccionadas = [];
                }

                const textoEstrategiasMostrar = estrategiasGlobalesSeleccionadas.length > 0
                    ? estrategiasGlobalesSeleccionadas.join(', ')
                    : 'ninguna';

                // --- Datos semana ---
                const semanaGlobal = semanaData.semana;
                const esPausa = semanaData.esPausaMetabolica;
                const pesoInicioSemana = semanaData.pesoInicioSemana;
                const pesoFinSemana = semanaData.pesoFinSemana;

                // --- Generar headerText ---
                const headerText = esPausa
                    ? `Semana ${semanaData.semanaEnMes} (Pausa Metabólica, Peso: ${pesoInicioSemana.toFixed(2)} kg)`
                    : `Semana ${semanaData.semanaEnMes} (Peso: ${pesoInicioSemana.toFixed(2)} → ${pesoFinSemana.toFixed(2)} kg)`;
                
                const headerTextCompleto = `${headerText} | Ubicación: Semana nº ${semanaGlobal} del Plan (Total: ${semanasTotalesPlanCalculadas} semanas)`;

                // --- Estilo especial si es semana de pausa metabólica ---
                const estiloHeaderSemana = esPausa
				
					 ? 'style="color: rgb(243, 156, 18) font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Helvetica, Arial, sans-serif, \'Apple Color Emoji\', \'Segoe UI Emoji\', \'Segoe UI Symbol\'; font-size: 24px; font-weight: 600; font-style: normal; line-height: 28.8px; text-align: start; text-decoration: none; text-transform: none; white-space: normal;"'
					: '';
                htmlTablaDetallada += `
                    <div class="accordion-item">
                        <h3 class="accordion-header" id="headingSemana${semanaData.semana}">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseSemana${semanaData.semana}" aria-expanded="${semanaIndex === 0 ? 'true' : 'false'}"
                                    aria-controls="collapseSemana${semanaData.semana}" ${estiloHeaderSemana}>
                                ${headerTextCompleto}
                            </button>
                        </h3>
                        <div id="collapseSemana${semanaData.semana}" class="accordion-collapse collapse ${semanaIndex === 0 ? 'show' : ''}"
                             aria-labelledby="headingSemana${semanaData.semana}" data-bs-parent="#accordionSemanasMes${mesData.mes}">
                            <div class="accordion-body">
                                <div class="table-responsive tabla-planificacion-wrapper">
                                    <table id="tablaDetalladaSemana${semanaData.semana}" class="table table-striped table-bordered align-middle tabla-planificacion">
                                        <thead>
                                            <tr>
                                                <th scope="col" style="text-align: start;">Día</th>
                                                <th scope="col" style="text-align: start;">Actividad</th>
                                                <th scope="col" style="text-align: start;">Kcal/dia</th>
                                                <th scope="col" style="text-align: center;">% Pt<br><small>(g/día)</small></th>
                                                <th scope="col" style="text-align: center;">% CH<br><small>(g/día)</small></th>
                                                <th scope="col" style="text-align: center;">% GR<br><small>(g/día)</small></th>
                                                <th scope="col" style="text-align: start;">Peso Estimado</th>
                                                <th scope="col" style="text-align: start;">Estrategias</th>
                                                <th scope="col" style="text-align: start;">Notas</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                `;

                semanaData.dias.forEach((item, diaIndex) => {
                    const indiceFila = `${mesData.mes}-${semanaData.semana}-${diaIndex}`;
                    const selectActividadHTML = crearSelectActividad(indiceFila, item.actividad);

                    // Aplicar estilos inline en celdas
                    htmlTablaDetallada += `
                        <tr id="fila-detalle-${indiceFila}" data-indice-fila="${indiceFila}">
                            <td style="text-align: start; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${item.dia}
                            </td>
                            <td style="text-align: start; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${selectActividadHTML}
                            </td> 
                            <td style="text-align: center; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${item.calorias}
                            </td>
                            <td  style="text-align: center; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                <strong>${item.proteinasPct}%</strong><br>
                                <small>${item.proteinas}g</small>
                            </td>
                            <td  style="text-align: center; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                <strong>${item.carbohidratosPct}%</strong><br>
                                <small>${item.carbohidratos}g</small>
                            </td>
                            <td  style="text-align: center; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                <strong>${item.grasasPct}%</strong><br>
                                <small>${item.grasas}g</small>
                            </td>
                            <td style="text-align: start; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${item.pesoEstimado.toFixed(1)}
                            </td>
                            <td id="celda-estrategias-${indiceFila}" class="small" style="text-align: start; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${textoEstrategiasMostrar}
                            </td>
                            <td id="notas-${indiceFila}" class="small" style="text-align: start; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${item.notas}
                            </td>
                        </tr>
                    `;
                });

                htmlTablaDetallada += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            htmlTablaDetallada += `
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        // --- 8. Insertar el HTML en el contenedor ---
        contenedor.innerHTML = htmlTablaDetallada;

        // --- 9. Adjuntar datos a las tablas para acceso futuro ---
        datosPorMes.forEach((mesData) => {
            mesData.semanas.forEach((semanaData) => {
                const tablaElement = document.getElementById(`tablaDetalladaSemana${semanaData.semana}`);
                if (tablaElement) {
                    tablaElement.datosFaseBase = datosFase;
                    tablaElement.datosFilasOriginales = semanaData.dias;
                    tablaElement.estrategiasDisponibles = estrategiasDisponibles;
                }
            });
        });

        console.log("Tabla detallada generada y mostrada con éxito para la fase:", datosFase.nombreFase);

    } catch (error) {
        console.error("Error al generar o mostrar la tabla detallada:", error);
        contenedor.innerHTML = `<p class="error-message">❌ Error al generar los detalles para la fase <strong>${datosFase?.nombreFase || 'desconocida'}</strong>: ${error.message}</p>`;
        const errorMsgElement = document.getElementById('errorMessage');
        if (errorMsgElement) {
            errorMsgElement.textContent = `Error al generar la tabla detallada: ${error.message}`;
            errorMsgElement.style.display = 'block';
        }
    }
}
		
		// --- Funciones auxiliares para crear controles interactivos ---



	/**
 * Actualiza una fila de la tabla detallada cuando cambia el nivel de actividad.
 * Recalcula TDEE, Kcal/día y macros.
 * @param {string|number} indiceFila - El índice de la fila (formato "mes-semana-dia" o un número).
 * @param {string} nuevoNivelActividadStr - El nuevo valor del multiplicador de actividad (como string).
 * @param {number|null} ajusteCaloriasDiarioManual - (Opcional) Un ajuste manual de calorías diarias que anula el global.
 */
function actualizarFilaPorActividad(indiceFila, nuevoNivelActividadStr, ajusteCaloriasDiarioManual = null) {
    console.log(`Actualizando fila ${indiceFila} por cambio de actividad a ${nuevoNivelActividadStr}. Ajuste manual: ${ajusteCaloriasDiarioManual}`);

    try {
        // --- 1. Validar y convertir la entrada ---
        const nuevoNivelActividad = parseFloat(nuevoNivelActividadStr);
        if (isNaN(nuevoNivelActividad)) {
            console.error("Nivel de actividad inválido recibido:", nuevoNivelActividadStr);
            return;
        }

        // --- 2. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`No se encontró la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`No se encontró la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 3. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;

        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
             console.error(`Índice de día inválido en 'data-indice-fila': ${indiceFila}`);
             return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
             console.error(`No se encontraron datos originales para el día ${indiceDiaArray} en la fila ${indiceFila}.`);
             return;
        }

        // --- 4. Recalcular TMB y TDEE para el peso estimado actual de la fila ---
        // Obtenemos el peso estimado actual directamente de los datos originales de la fila.
        const pesoEstimadoKg = datosFilaOriginal.pesoEstimado;

        // Recalcular TMB usando las variables globales userGender, userHeightCm, userAge
        let tmbActual = 0;
        if (typeof userGender === 'undefined' || typeof userHeightCm === 'undefined' || typeof userAge === 'undefined') {
             console.error("Variables de usuario (userGender, userHeightCm, userAge) no definidas. No se puede calcular TMB.");
             return;
        }
        if (userGender === 'male') {
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else { // Asumimos 'female' si no es 'male'
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        // Calcular TDEE usando el TMB recién calculado y la nueva actividad
        const nuevoTDEE = tmbActual * nuevoNivelActividad;

        console.log(`Fila ${indiceFila}: TMB calculado=${tmbActual.toFixed(2)}, Nuevo TDEE=${nuevoTDEE.toFixed(2)}, Nueva Actividad=${nuevoNivelActividad}`);

        // --- 5. Calcular nuevas calorías diarias objetivo ---
        let nuevasCaloriasDiarias = nuevoTDEE;
        if (ajusteCaloriasDiarioManual !== null) {
            nuevasCaloriasDiarias += ajusteCaloriasDiarioManual;
            console.log(`Usando ajuste de calorías manual: ${ajusteCaloriasDiarioManual} kcal/día`);
        } else {
            const ajusteCaloriasSemanal = weeklyCalorieDiffManualGlobal; // Puede ser null/number
            const ajusteCaloriasDiarioGlobal = ajusteCaloriasSemanal !== null ? ajusteCaloriasSemanal / 7 : 0;
            nuevasCaloriasDiarias += ajusteCaloriasDiarioGlobal;
            console.log(`Usando ajuste de calorías global: ${ajusteCaloriasDiarioGlobal} kcal/día`);
        }

        // --- 6. Obtener macros base promedio de la fase ---
        const parsearRangoPorcentaje = (rangoStr) => {
            if (!rangoStr || typeof rangoStr !== 'string') return [25, 25];
            const partes = rangoStr.replace('%', '').split('-').map(Number);
            return partes.length === 2 ? partes : [partes[0], partes[0]];
        };

        let rangoProteinasPct = [25, 25];
        let rangoCarbohidratosPct = [40, 40];
        let rangoGrasasPct = [35, 35];
        try {
            rangoProteinasPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.proteinasPct);
            rangoCarbohidratosPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.carbohidratosPct);
            rangoGrasasPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.grasasPct);
        } catch (e) {
            console.warn("Error al parsear rangos de macros de la fase, usando valores por defecto.", e);
        }

        let proteinasPctPromedio = Number(document.getElementById('protein-percentage')?.value) || Math.round((rangoProteinasPct[0] + rangoProteinasPct[1]) / 2);
        let carbohidratosPctPromedio = Number(document.getElementById('carb-percentage')?.value) || Math.round((rangoCarbohidratosPct[0] + rangoCarbohidratosPct[1]) / 2);
        let grasasPctPromedio = 100 - proteinasPctPromedio - carbohidratosPctPromedio;

        // --- 7. Inicializar macros del día con los promedios de la fase ---
        let nuevasProteinasPctDia = proteinasPctPromedio;
        let nuevasCarbohidratosPctDia = carbohidratosPctPromedio;
        let nuevasGrasasPctDia = grasasPctPromedio;

        // --- 8. Asegurar que los porcentajes sumen 100% ---
        const totalPct = nuevasProteinasPctDia + nuevasCarbohidratosPctDia + nuevasGrasasPctDia;
        if (Math.abs(totalPct - 100) > 0.1) {
            const diff = 100 - totalPct;
            nuevasGrasasPctDia += diff;
            console.warn(`Porcentajes ajustados en Fila ${indiceFila} para sumar 100%.`);
        }

        // --- 9. Calcular nuevos gramos de macros ---
        const nuevasProteinas_g = Math.round((nuevasCaloriasDiarias * nuevasProteinasPctDia / 100) / 4);
        const nuevasCarbohidratos_g = Math.round((nuevasCaloriasDiarias * nuevasCarbohidratosPctDia / 100) / 4);
        const nuevasGrasas_g = Math.round((nuevasCaloriasDiarias * nuevasGrasasPctDia / 100) / 9);

        // --- 10. Asegurar un mínimo de calorías por seguridad ---
        const limiteCaloriasMin = (typeof userGender !== 'undefined' && userGender === 'female') ? 1200 : 1500;
        if (nuevasCaloriasDiarias < limiteCaloriasMin) {
            console.warn(`Calorías ajustadas en Fila ${indiceFila} por debajo del límite (${limiteCaloriasMin}).`);
            nuevasCaloriasDiarias = limiteCaloriasMin;
        }

        // --- 11. Actualizar la UI ---
        // Actualizar celda de calorías
        const celdaCalorias = document.getElementById(`calorias-${indiceFila}`);
        if (celdaCalorias) {
            celdaCalorias.textContent = Math.round(nuevasCaloriasDiarias);
        }

        // Actualizar celdas de macros (% y g)
        const celdasPt = filaElement.querySelectorAll('td.text-center')[0];
        if (celdasPt) {
            celdasPt.innerHTML = `<strong>${Math.round(nuevasProteinasPctDia)}%</strong><br><small>${nuevasProteinas_g}g</small>`;
        }

        const celdasCH = filaElement.querySelectorAll('td.text-center')[1];
        if (celdasCH) {
            celdasCH.innerHTML = `<strong>${Math.round(nuevasCarbohidratosPctDia)}%</strong><br><small>${nuevasCarbohidratos_g}g</small>`;
        }

        const celdasGR = filaElement.querySelectorAll('td.text-center')[2];
        if (celdasGR) {
            celdasGR.innerHTML = `<strong>${Math.round(nuevasGrasasPctDia)}%</strong><br><small>${nuevasGrasas_g}g</small>`;
        }

        // --- 12. Actualizar celda de notas (manteniendo estrategias) ---
			const celdaNotas = document.getElementById(`notas-${indiceFila}`);
			if (celdaNotas) {
				// a. Obtener el texto actual completo de la celda de notas
				const textoNotasActual = celdaNotas.textContent || "";

				// b. Intentar extraer la parte de "Estrategias aplicadas" del texto actual
				// Creamos una expresión regular para encontrar el fragmento que empieza con ". Estrategias aplicadas: "
				// y capturar todo lo que le sigue hasta el final del string.
				// Ejemplo: Si textoNotasActual es "Basado en... Ajuste diario: -500 kcal.. Estrategias aplicadas: IF 16:8 aplicado."
				// matchEstrategiasCapturadas[1] será "IF 16:8 aplicado."
				const regexEstrategias = /\. Estrategias aplicadas: (.+)$/;
				const matchEstrategiasCapturadas = textoNotasActual.match(regexEstrategias);
				let parteEstrategiasExistente = "";
				if (matchEstrategiasCapturadas && matchEstrategiasCapturadas[1]) {
					// Si se encontró, reconstruimos la parte con el formato correcto
					parteEstrategiasExistente = `. Estrategias aplicadas: ${matchEstrategiasCapturadas[1]}`;
					console.log(`[Actualizar Actividad] Parte de estrategias extraída para ${indiceFila}:`, parteEstrategiasExistente);
				} else {
					// Si no se encontró (puede ser la primera vez o porque no hay estrategias), se deja vacío
					console.log(`[Actualizar Actividad] No se encontró parte de estrategias en notas-${indiceFila}.`);
				}

				// c. Generar la NUEVA parte base de la nota (TDEE, ajuste)
				let nuevaNotaBase = `Basado en TDEE estimado (${nuevoTDEE.toFixed(0)} kcal)`;
				if (ajusteCaloriasDiarioManual !== null) {
					nuevaNotaBase += ` y ajuste manual.`;
					nuevaNotaBase += ` Ajuste diario: ${ajusteCaloriasDiarioManual > 0 ? '+' : ''}${ajusteCaloriasDiarioManual.toFixed(0)} kcal.`;
				} else {
					nuevaNotaBase += ` y ajuste objetivo.`;
					const ajusteCaloriasSemanal = weeklyCalorieDiffManualGlobal;
					if (ajusteCaloriasSemanal !== null) {
						nuevaNotaBase += ` Ajuste diario: ${ajusteCaloriasSemanal > 0 ? '+' : ''}${(ajusteCaloriasSemanal / 7).toFixed(0)} kcal.`;
					}
					// Si no hay ajuste semanal global, no se añade nada más a la parte base.
				}

				// d. Combinar la nueva parte base con la parte de estrategias existente
				const notaCompletaActualizada = nuevaNotaBase + parteEstrategiasExistente;

				// e. Registrar el estado antes y después de la actualización
				console.log(`[Actualizar Actividad] ANTES de actualizar notas-${indiceFila}:`, textoNotasActual);
				celdaNotas.textContent = notaCompletaActualizada; // Actualizar la celda
				console.log(`[Actualizar Actividad] DESPUÉS de actualizar notas-${indiceFila}:`, celdaNotas.textContent);
			}
			// ... (resto del código de la función) ...
        console.log(`Fila ${indiceFila} actualizada con éxito por cambio de actividad.`);
        console.log({
            nuevasCaloriasDiarias,
            nuevasProteinasPctDia,
            nuevasCarbohidratosPctDia,
            nuevasGrasasPctDia,
            nuevasProteinas_g,
            nuevasCarbohidratos_g,
            nuevasGrasas_g
        });

    } catch (error) {
        console.error("Error al actualizar la fila por cambio de actividad:", error);
        // Opcional: Mostrar mensaje de error al usuario
        // alert("Hubo un error al actualizar los cálculos. Por favor, inténtalo de nuevo.");
    }
}

function crearControlEstrategias_eliminada(indiceFila, estrategiasAplicadas = [], estrategiasDisponibles = []) {
    // Asegurarse de que estrategiasAplicadas sea un array
    const estrategiasActuales = Array.isArray(estrategiasAplicadas) ? estrategiasAplicadas : [];

    // Crear las opciones del <select>
    let opcionesHtml = `<option value="">ninguna</option>`; // Opción por defecto
    estrategiasDisponibles.forEach(estrategia => {
        // Evitar agregar "ninguna" como opción seleccionable si ya está en la lista
        // Asumimos que "ninguna" es un valor especial que representa un array vacío o null
        if (estrategia.toLowerCase() === "ninguna") return; 

        // Comprobar si esta estrategia está en la lista de aplicadas
        // Usamos 'includes' para comparar el nombre de la estrategia
        const seleccionada = estrategiasActuales.includes(estrategia) ? 'selected' : '';
        opcionesHtml += `<option value="${estrategia}" ${seleccionada}>${estrategia}</option>`;
    });

    // Devolver el HTML del <select multiple> y el texto de ayuda
    return `
        <select id="select-estrategias-${indiceFila}" class="form-control form-control-sm" multiple
                onchange="actualizarFilaPorEstrategias('${indiceFila}', Array.from(this.selectedOptions).map(option => option.value))">
            ${opcionesHtml}
        </select>
        <small class="form-text text-muted">Mantén presionada Ctrl (Cmd en Mac) para seleccionar varias.</small>
    `;
}
			
    /*
    // Ejemplo de cómo podría ser con checkboxes (más complejo de implementar)
    // let checkboxesHTML = '';
    // estrategiasDisponibles.forEach(estrategia => {
    //     const checked = estrategiasAplicadas.includes(estrategia) ? 'checked' : '';
    //     checkboxesHTML += `
    //         <div class="form-check form-check-inline">
    //             <input class="form-check-input" type="checkbox" id="chk-${indiceFila}-${estrategia}" 
    //                    value="${estrategia}" ${checked} 
    //                    onchange="manejarCambioCheckboxEstrategia(${indiceFila}, '${estrategia}', this.checked)">
    //             <label class="form-check-label small" for="chk-${indiceFila}-${estrategia}">${estrategia}</label>
    //         </div>
    //     `;
    // });
    // return `<div>${checkboxesHTML}</div>`;
    */

/**
 * Actualiza una fila de la tabla detallada cuando cambian las estrategias seleccionadas.
 * Recalcula Kcal/día, % y gramos de macros, y notas.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 * @param {Array<string>|string} valorEstrategias - Array de estrategias seleccionadas o string separado por comas.
 */
/**
 * Actualiza una fila de la tabla detallada cuando cambian las estrategias seleccionadas.
 * Recalcula Kcal/día, % y gramos de macros, y notas.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 * @param {Array<string>} arrayEstrategias - Array de nombres de estrategias seleccionadas.
 * @param {number|null} [ajusteCaloriasDiarioManual=null] - (Opcional) Un ajuste manual de calorías diarias que puede haberse aplicado.
 */
function actualizarFilaPorEstrategias(indiceFila, arrayEstrategias, ajusteCaloriasDiarioManual = null) {
    console.log(`[Modal Avanzado] Actualizando fila ${indiceFila} por cambio de estrategias a:`, arrayEstrategias, `. Ajuste manual: ${ajusteCaloriasDiarioManual}`);

    try {
        // --- 1. Procesar el valor de entrada ---
        let estrategiasAplicadasArray = [];

        if (Array.isArray(arrayEstrategias)) {
            // Caso 1: Recibimos directamente el array del select multiple (viejo) o checkboxes (modal)
            estrategiasAplicadasArray = arrayEstrategias.filter(item => item && item.trim() !== "");
        } else if (typeof arrayEstrategias === 'string') {
            // Caso 2: Recibimos una cadena (del viejo input)
            // Separar por coma y limpiar
            estrategiasAplicadasArray = arrayEstrategias.split(',')
                                                         .map(item => item.trim())
                                                         .filter(item => item && item.toLowerCase() !== "ninguna");
        }

        // --- 2. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`[Modal Avanzado] No se encontró la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`[Modal Avanzado] No se encontró la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 3. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;
        const estrategiasDisponibles = tablaElement.estrategiasDisponibles || [];

        // Encontrar los datos originales específicos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
             console.error(`[Modal Avanzado] Índice de día inválido en 'data-indice-fila': ${indiceFila}`);
             return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
             console.error(`[Modal Avanzado] No se encontraron datos originales para el día ${indiceDiaArray} en la fila ${indiceFila}.`);
             return;
        }

        // --- 4. Obtener el nivel de actividad actual de la fila ---
        // Este paso es crucial para recalcular el TDEE
        const selectActividadElement = document.getElementById(`select-actividad-${indiceFila}`);
        let actividadActual = datosFilaOriginal.actividad; // Valor por defecto del dato original
        if (selectActividadElement) {
            actividadActual = parseFloat(selectActividadElement.value);
            if (isNaN(actividadActual)) {
                console.warn(`[Modal Avanzado] Nivel de actividad inválido en select para fila ${indiceFila}. Usando original.`);
                actividadActual = datosFilaOriginal.actividad;
            }
        }

        // --- 5. Recalcular TMB y TDEE usando el peso estimado actual de la fila ---
        // Recalcular TMB usando las variables globales userGender, userHeightCm, userAge
        // y el peso estimado de la fila (que ya refleja la estimación para el inicio de la semana)
        const pesoEstimadoKg = datosFilaOriginal.pesoEstimado;
        if (pesoEstimadoKg === undefined) {
             console.error(`[Modal Avanzado] Peso estimado no encontrado para la fila ${indiceFila}.`);
             return; // No se puede recalcular sin peso
        }

        let tmbActual = 0;
        if (typeof userGender === 'undefined' || typeof userHeightCm === 'undefined' || typeof userAge === 'undefined') {
             console.error("[Modal Avanzado] Variables de usuario (userGender, userHeightCm, userAge) no definidas. No se puede calcular TMB.");
             return;
        }
        if (userGender === 'male') {
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else { // Asumimos 'female' si no es 'male'
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        const tdeeActual = tmbActual * actividadActual;

        // --- 6. Calcular nuevas calorías diarias objetivo ---
        let nuevasCaloriasDiarias = tdeeActual;
        // Priorizar el ajuste manual si se proporciona
        if (ajusteCaloriasDiarioManual !== null) {
            nuevasCaloriasDiarias += ajusteCaloriasDiarioManual;
            console.log(`[Modal Avanzado] Usando ajuste de calorías manual en estrategias: ${ajusteCaloriasDiarioManual} kcal/día`);
        } else {
            // Si no hay ajuste manual, usar el ajuste semanal global
            const ajusteCaloriasSemanal = weeklyCalorieDiffManualGlobal; // Puede ser null/number
            const ajusteCaloriasDiarioGlobal = ajusteCaloriasSemanal !== null ? ajusteCaloriasSemanal / 7 : 0;
            nuevasCaloriasDiarias += ajusteCaloriasDiarioGlobal;
            console.log(`[Modal Avanzado] Usando ajuste de calorías global en estrategias: ${ajusteCaloriasDiarioGlobal} kcal/día`);
        }

        // --- 7. Obtener macros base promedio de la fase ---
        const parsearRangoPorcentaje = (rangoStr) => {
            if (!rangoStr || typeof rangoStr !== 'string') return [25, 25];
            const partes = rangoStr.replace('%', '').split('-').map(Number);
            return partes.length === 2 ? partes : [partes[0], partes[0]];
        };

        let rangoProteinasPct = [25, 25];
        let rangoCarbohidratosPct = [40, 40];
        let rangoGrasasPct = [35, 35];
        try {
            rangoProteinasPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.proteinasPct);
            rangoCarbohidratosPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.carbohidratosPct);
            rangoGrasasPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.grasasPct);
        } catch (e) {
            console.warn("[Modal Avanzado] Error al parsear rangos de macros de la fase, usando valores por defecto.", e);
        }

        // Usar los valores del input range si existen, sino calcular promedio
        let proteinasPctPromedio = Number(document.getElementById('protein-percentage')?.value) || Math.round((rangoProteinasPct[0] + rangoProteinasPct[1]) / 2);
        let carbohidratosPctPromedio = Number(document.getElementById('carb-percentage')?.value) || Math.round((rangoCarbohidratosPct[0] + rangoCarbohidratosPct[1]) / 2);
        let grasasPctPromedio = 100 - proteinasPctPromedio - carbohidratosPctPromedio;

        // --- 8. Inicializar macros del día con los promedios de la fase ---
        let nuevasProteinasPctDia = proteinasPctPromedio;
        let nuevasCarbohidratosPctDia = carbohidratosPctPromedio;
        let nuevasGrasasPctDia = grasasPctPromedio;
        let nuevasNotasEstrategias = [];

        // --- 9. Aplicar modificaciones por las NUEVAS estrategias seleccionadas ---
        const diaNombre = datosFilaOriginal.dia;
        const diaNumero = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'].indexOf(diaNombre) + 1;

        // NOTA: Esta parte requiere que las estrategiasDisponibles tengan nombres consistentes
        // con los usados en los checkboxes del modal y en los if's siguientes.
        // Asumimos que los nombres son 'refeed', 'carb_cycling', 'protein_cycling', etc.

        if (estrategiasAplicadasArray.includes('refeed') && diaNombre === 'Domingo') {
            nuevasCarbohidratosPctDia = Math.min(95, nuevasCarbohidratosPctDia + 20);
            nuevasGrasasPctDia = Math.max(5, 100 - nuevasProteinasPctDia - nuevasCarbohidratosPctDia);
            nuevasCaloriasDiarias = Math.round(nuevasCaloriasDiarias * 1.05);
            nuevasNotasEstrategias.push('Día de Refeed');
        }

        if (estrategiasAplicadasArray.includes('carb_cycling') && (diaNumero % 2 === 0)) {
            nuevasCarbohidratosPctDia = Math.min(90, nuevasCarbohidratosPctDia + 15);
            nuevasGrasasPctDia = Math.max(5, 100 - nuevasProteinasPctDia - nuevasCarbohidratosPctDia);
            nuevasNotasEstrategias.push('Día alto en HC (Carb Cycling)');
        }

        if (estrategiasAplicadasArray.includes('protein_cycling') && diaNombre === 'Domingo') {
            nuevasProteinasPctDia = Math.max(15, nuevasProteinasPctDia - 10);
            nuevasGrasasPctDia = 100 - nuevasProteinasPctDia - nuevasCarbohidratosPctDia;
            nuevasNotasEstrategias.push('Día bajo en proteína (Protein Cycling)');
        }

        if (estrategiasAplicadasArray.includes('ckd') && (diaNombre === 'Sábado' || diaNombre === 'Domingo')) {
            nuevasCarbohidratosPctDia = Math.min(95, nuevasCarbohidratosPctDia + 30);
            nuevasGrasasPctDia = Math.max(2, 100 - nuevasProteinasPctDia - nuevasCarbohidratosPctDia);
            nuevasCaloriasDiarias = Math.round(nuevasCaloriasDiarias * 1.1);
            nuevasNotasEstrategias.push('Día de Carb-Loading (CKD)');
        }

        const diasEntrenoTKD = ['Lunes', 'Miércoles', 'Viernes'];
        if (estrategiasAplicadasArray.includes('tkd') && diasEntrenoTKD.includes(diaNombre)) {
            nuevasCarbohidratosPctDia = Math.min(85, nuevasCarbohidratosPctDia + 10);
            nuevasGrasasPctDia = Math.max(5, 100 - nuevasProteinasPctDia - nuevasCarbohidratosPctDia);
            nuevasNotasEstrategias.push('Targeted Keto (TKD)');
        }

        if (estrategiasAplicadasArray.includes('if_16_8')) {
            nuevasNotasEstrategias.push('IF 16:8 aplicado');
        }
        if (estrategiasAplicadasArray.includes('timing')) {
            nuevasNotasEstrategias.push('Timing Nutricional considerado');
        }
        if (estrategiasAplicadasArray.includes('flexible_dieting')) {
            nuevasNotasEstrategias.push('Flexible Dieting (80/20)');
        }
        if (estrategiasAplicadasArray.includes('Cetosis estricta')) {
            nuevasNotasEstrategias.push('Cetosis estricta (<50g HC/día)');
        }
        if (estrategiasAplicadasArray.includes('Hiperproteica')) {
            nuevasNotasEstrategias.push('Dieta Hiperproteica (1.8-2.5g/kg proteína)');
        }

        // --- 10. Asegurar que los porcentajes sumen 100% ---
        const totalPct = nuevasProteinasPctDia + nuevasCarbohidratosPctDia + nuevasGrasasPctDia;
        if (Math.abs(totalPct - 100) > 0.1) {
            const diff = 100 - totalPct;
            nuevasGrasasPctDia += diff;
            console.warn(`[Modal Avanzado] Porcentajes ajustados en Fila ${indiceFila} para sumar 100%.`);
        }

        // --- 11. Calcular nuevos gramos de macros ---
        const nuevasProteinas_g = Math.round((nuevasCaloriasDiarias * nuevasProteinasPctDia / 100) / 4);
        const nuevasCarbohidratos_g = Math.round((nuevasCaloriasDiarias * nuevasCarbohidratosPctDia / 100) / 4);
        const nuevasGrasas_g = Math.round((nuevasCaloriasDiarias * nuevasGrasasPctDia / 100) / 9);

        // --- 12. Asegurar un mínimo de calorías por seguridad ---
        const limiteCaloriasMin = (typeof userGender !== 'undefined' && userGender === 'female') ? 1200 : 1500;
        if (nuevasCaloriasDiarias < limiteCaloriasMin) {
            console.warn(`[Modal Avanzado] Calorías ajustadas en Fila ${indiceFila} por debajo del límite (${limiteCaloriasMin}).`);
            nuevasCaloriasDiarias = limiteCaloriasMin;
        }

        // --- 13. Actualizar la UI ---
        // a. Actualizar celda de calorías
        const celdaCalorias = document.getElementById(`calorias-${indiceFila}`);
        if (celdaCalorias) {
            celdaCalorias.textContent = Math.round(nuevasCaloriasDiarias);
        }

        // b. Actualizar celdas de macros (% y g)
        // Celda % Pt y g (primera .text-center)
        const celdasPt = filaElement.querySelectorAll('td.text-center')[0];
        if (celdasPt) {
            celdasPt.innerHTML = `<strong>${Math.round(nuevasProteinasPctDia)}%</strong><br><small>${nuevasProteinas_g}g</small>`;
        }

        // Celda % CH y g (segunda .text-center)
        const celdasCH = filaElement.querySelectorAll('td.text-center')[1];
        if (celdasCH) {
            celdasCH.innerHTML = `<strong>${Math.round(nuevasCarbohidratosPctDia)}%</strong><br><small>${nuevasCarbohidratos_g}g</small>`;
        }

        // Celda % GR y g (tercera .text-center)
        const celdasGR = filaElement.querySelectorAll('td.text-center')[2];
        if (celdasGR) {
            celdasGR.innerHTML = `<strong>${Math.round(nuevasGrasasPctDia)}%</strong><br><small>${nuevasGrasas_g}g</small>`;
        }

        // --- 14. Actualizar celda de notas ---
        const celdaNotas = document.getElementById(`notas-${indiceFila}`);
        if (celdaNotas) {
             // a. Generar la nota base (TDEE, ajuste)
             let notaBaseOriginal = `Basado en TDEE estimado (${tdeeActual.toFixed(0)} kcal)`;
             if (ajusteCaloriasDiarioManual !== null) {
                 notaBaseOriginal += ` y ajuste manual.`;
                 notaBaseOriginal += ` Ajuste diario: ${ajusteCaloriasDiarioManual > 0 ? '+' : ''}${ajusteCaloriasDiarioManual.toFixed(0)} kcal.`;
             } else {
                 notaBaseOriginal += ` y ajuste objetivo.`;
                 const ajusteCaloriasSemanal = weeklyCalorieDiffManualGlobal; // Puede ser null/number
                 if (ajusteCaloriasSemanal !== null) {
                     notaBaseOriginal += ` Ajuste diario: ${ajusteCaloriasSemanal > 0 ? '+' : ''}${(ajusteCaloriasSemanal / 7).toFixed(0)} kcal.`;
                 }
             }

             // b. Construir la parte de estrategias aplicadas
             let parteEstrategias = "";
             if (nuevasNotasEstrategias.length > 0) {
                 parteEstrategias = `. Estrategias aplicadas: ${nuevasNotasEstrategias.join(', ')}.`;
             }

             // c. Combinar y actualizar
             const nuevaNotaCompleta = notaBaseOriginal + parteEstrategias;
             celdaNotas.textContent = nuevaNotaCompleta;
        }

        console.log(`[Modal Avanzado] Fila ${indiceFila} actualizada con éxito por cambio de estrategias.`);
        console.log({
            nuevasCaloriasDiarias,
            nuevasProteinasPctDia,
            nuevasCarbohidratosPctDia,
            nuevasGrasasPctDia,
            nuevasProteinas_g,
            nuevasCarbohidratos_g,
            nuevasGrasas_g,
            nota: celdaNotas ? celdaNotas.textContent : 'Celda de notas no encontrada'
        });

    } catch (error) {
        console.error(`[Modal Avanzado] Error al actualizar la fila ${indiceFila} por cambio de estrategias:`, error);
        alert("Hubo un error al actualizar los cálculos por estrategias. Por favor, inténtalo de nuevo.");
    }
}

		/**
		 * Genera los datos para la Tabla Detallada por Semanas de una fase específica.
		 * @param {Object} datosFase - Los datos de la fase seleccionada.
		 * @returns {Array<Object>} Un array de objetos, cada uno representando un día de una semana.
		 */
		 
		function generarDatosTablaDetallada(datosFase) {
    console.log("1. generarDatosTablaDetallada recibió:", datosFase);
    
    // --- Determinar si es una pausa metabólica completa ---
    const esPausaMetabolicaFase = datosFase.nombreFase.includes('Pausa Metabólica');
    
    // --- Datos necesarios del contexto global ---
    const pesoInicialFase = datosFase.pesoInicioFase;
    const cambioPesoTotalFase = datosFase.pesoFinFase - datosFase.pesoInicioFase;
    const semanasEnFase = datosFase.semanasAsignadas;
    const nombreFase = datosFase.nombreFase;
    const mesesTexto = datosFase.mesesTexto;
    const objetivo = document.getElementById('objetivo').value;
    
    // --- Calcular semana global inicial ---
    let semanaGlobalInicial;

    // ✅ Solo para la primera fase (asumimos que semanaReevaluacion = 1)
    if (datosFase.semanaReevaluacion === 1) {
        semanaGlobalInicial = datosFase.semanaReevaluacion; // ✅ Empieza en 1
    } else {
        semanaGlobalInicial = datosFase.semanaReevaluacion - datosFase.semanasAsignadas + 1;
    }

    // --- Validar que sea positivo ---
    if (semanaGlobalInicial < 1) {
        console.warn("semanaGlobalInicial ajustada a 1 para evitar valores negativos.");
        semanaGlobalInicial = 1;
    }
    
    // --- Calcular meses anteriores ---
    const mesesAnteriores = Math.floor((semanaGlobalInicial - 1) / 4); // ✅ Usar floor, no ceil
    const mesInicioPlan = Math.max(1, mesesAnteriores + 1); 
    
    // --- Validación de semanasAsignadas ---
    if (semanasEnFase === undefined || semanasEnFase === null || semanasEnFase <= 0) {
        console.error("Duración de fase inválida (semanasAsignadas):", semanasEnFase);
        throw new Error(`Duración de fase inválida: semanasAsignadas=${semanasEnFase}`);
    }
    
    // --- 🔥 NUEVO: Preparar para modelo no lineal ---
    const useNonLinear = window.nonlinearProgressData_1?.evolucionSemanal?.length > 0;
    let acumuladoInicioFase = 0;

    if (useNonLinear) {
        // Calcular el peso acumulado AL FINAL de la semana anterior a la fase
        if (semanaGlobalInicial > 1) {
            const weekDataInicioFase = window.nonlinearProgressData_1.evolucionSemanal.find(
                w => w.Semana === semanaGlobalInicial - 1
            );
            if (weekDataInicioFase) {
                // Para pérdida, el acumulado debe ser negativo
                acumuladoInicioFase = objetivo === "perdida1" 
                    ? -Math.abs(weekDataInicioFase["Peso Acumulado (kg)"])
                    : weekDataInicioFase["Peso Acumulado (kg)"];
            } else {
                console.warn(`⚠️ Semana ${semanaGlobalInicial-1} no encontrada en datos no lineales. Usando 0.`);
                acumuladoInicioFase = 0;
            }
        }
        // Si es la primera semana del plan, acumuladoInicioFase = 0 (sin cambios previos)
    }

    // --- Calcular cambio de peso por semana (solo para fallback lineal) ---
    const cambioPesoPorSemana = cambioPesoTotalFase / semanasEnFase;
    
    // --- Obtener estrategias seleccionadas por el usuario ---
    const estrategiasSeleccionadas = getSelectedStrategies(); // Tu función existente
    const estrategiasDisponibles = [
        'ninguna', 'refeed', 'carb_cycling', 'protein_cycling', 'ckd', 'tkd',
        'if_16_8', 'timing', 'flexible_dieting', 'hiperproteica'
    ];
    
    // --- Calcular macros base de la fase ---
    const parsearRangoPorcentaje = (rangoStr) => {
        if (!rangoStr || typeof rangoStr !== 'string') return [25, 25];
        const partes = rangoStr.replace('%', '').split('-').map(Number);
        return partes.length === 2 ? partes : [partes[0], partes[0]];
    };

    let rangoProteinasPct = [25, 25];
    let rangoCarbohidratosPct = [40, 40];
    let rangoGrasasPct = [35, 35];
    try {
        rangoProteinasPct = parsearRangoPorcentaje(datosFase.macrosBase.proteinasPct);
        rangoCarbohidratosPct = parsearRangoPorcentaje(datosFase.macrosBase.carbohidratosPct);
        rangoGrasasPct = parsearRangoPorcentaje(datosFase.macrosBase.grasasPct);
    } catch (e) {
        console.warn("Error al parsear rangos de macros de la fase, usando valores por defecto.", e);
    }

    // --- Obtener configuración global desde window.planConfig ---
    if (!window.planConfig || !window.planConfig[nombreFase]) {
        console.error("Configuración del plan no disponible para la fase:", nombreFase);
        throw new Error("Debe ejecutar generarTablaGeneral primero para inicializar window.planConfig.");
    }
    const planConfig = window.planConfig[nombreFase];
    const semanasPausaEstaFase = planConfig.semanasPausa || 0;
    const ratios = planConfig.ratios || [1, 2];
    const numeroFases = planConfig.numeroFases || 2;
    const semanasTotalesPlan = planConfig.semanasTotales || window.estimatedWeeksManualGlobal || 30;

    // --- Calcular meses ---
    const mesInicio = mesInicioPlan;
    const mesFin = mesInicioPlan + Math.ceil((semanasEnFase + semanasPausaEstaFase) / 4) - 1;

    // --- Calcular semanas de pausa metabólica usando datos globales ---
    const semanasPausa = [];
    if (!esPausaMetabolicaFase && semanasPausaEstaFase > 0) {
        const intervaloPausa = Math.floor(semanasEnFase / (semanasPausaEstaFase + 1));
        
        for (let i = 0; i < semanasPausaEstaFase; i++) {
            const semanaLocalPausa = (i + 1) * intervaloPausa;
            const mesPausa = mesInicio + Math.floor((semanaLocalPausa - 1) / 4);
            semanasPausa.push({ mes: mesPausa, semanaLocal: (semanaLocalPausa - 1) % 4 + 1 });
        }
    }

    const datosPorMes = [];
    let semanasRestantes = semanasEnFase + semanasPausaEstaFase;

    // --- Iterar por meses ---
    for (let mes = mesInicio; mes <= mesFin && semanasRestantes > 0; mes++) {
        const semanasEnMes = Math.min(4, semanasRestantes);
        const datosSemanas = [];

        for (let semana = 1; semana <= semanasEnMes; semana++) {
            // --- Calcular semana global ---
            const semanaGlobalActual = semanaGlobalInicial + (mes - mesInicioPlan) * 4 + (semana - 1);
            window.semanaGlobalActual = semanaGlobalActual;
             
            // --- Determinar si esta semana es una pausa metabólica ---
            const esPausaMetabolicaSemana = semanasPausa.some(p => p.mes === mes && p.semanaLocal === semana);
            
            // --- Calcular mes y semana dentro del mes ---
            const mesActual = Math.floor((window.semanaGlobalActual - 1) / 4) + 1;
            const semanaEnMes = (window.semanaGlobalActual - 1) % 4 + 1;

            if (window.semanaGlobalActual < 1) continue;
        
            const estrategiasActivas = esPausaMetabolicaFase || esPausaMetabolicaSemana
                ? getSelectedStrategies().filter(estrategia => ['if_16_8', 'timing', 'flexible_dieting', 'hiperproteica'].includes(estrategia))
                : getSelectedStrategies();

            // --- Calcular macros para esta semana ---
            let proteinasPctPromedio = esPausaMetabolicaFase || esPausaMetabolicaSemana
                ? 25
                : (Number(document.getElementById('protein-percentage')?.value) || 25);
            let carbohidratosPctPromedio = esPausaMetabolicaFase || esPausaMetabolicaSemana
                ? 40
                : (Number(document.getElementById('carb-percentage')?.value) || 20);
            let grasasPctPromedio = esPausaMetabolicaFase || esPausaMetabolicaSemana
                ? 35
                : (100 - proteinasPctPromedio - carbohidratosPctPromedio);

            // --- Validar macros ---
            const totalPctBase = proteinasPctPromedio + carbohidratosPctPromedio + grasasPctPromedio;
            if (Math.abs(totalPctBase - 100) > 0.1) {
                const factor = 100 / totalPctBase;
                proteinasPctPromedio = Math.round(proteinasPctPromedio * factor);
                carbohidratosPctPromedio = Math.round(carbohidratosPctPromedio * factor);
                grasasPctPromedio = 100 - proteinasPctPromedio - carbohidratosPctPromedio;
                console.warn("Macros ajustados para sumar 100%:", { proteinasPctPromedio, carbohidratosPctPromedio, grasasPctPromedio });
            }

            // --- 🔥 Cálculo NO LINEAL (prioritario) ---
            let pesoEstimadoInicioSemana, pesoEstimadoFinSemana, tdeeDelDia;

            if (useNonLinear) {
                const weekData = window.nonlinearProgressData_1.evolucionSemanal.find(
                    w => w.Semana === semanaGlobalActual
                );

                if (weekData) {
                    // Ajustar los signos según el objetivo
                    let pesoAcumulado = weekData["Peso Acumulado (kg)"];
                    let tasaSemanal = weekData["Tasa Semanal (kg)"];
                    if (objetivo === "perdida1") {
                        pesoAcumulado = -Math.abs(pesoAcumulado);
                        tasaSemanal = -Math.abs(tasaSemanal);
                    }

                    // El peso acumulado es al FINAL de la semana, por lo que el inicio de la semana es pesoAcumulado - tasaSemanal
                    const pesoAcumuladoInicioSemana = pesoAcumulado - tasaSemanal;

                    // Ajustar al inicio de la FASE (no al inicio del plan)
                    pesoEstimadoInicioSemana = pesoInicialFase + (pesoAcumuladoInicioSemana - acumuladoInicioFase);
                    pesoEstimadoFinSemana = pesoInicialFase + (pesoAcumulado - acumuladoInicioFase);
                    
                    // Usar TDEE precalculado (ya incluye déficit/superávit)
                    tdeeDelDia = weekData["TDEE Estimado (kcal/día)"];
                } else {
                    // Fallback a lineal (semana fuera de rango)
                    const semanasActivas = window.semanaGlobalActual - semanaGlobalInicial - 
                        semanasPausa.filter(p => p.mes < mes || (p.mes === mes && p.semanaLocal < semana)).length;
                    
                    pesoEstimadoInicioSemana = pesoInicialFase + (cambioPesoPorSemana * semanasActivas);
                    pesoEstimadoFinSemana = pesoEstimadoInicioSemana + cambioPesoPorSemana;
                    
                    // Calcular TDEE lineal (Harris-Benedict)
                    let tmbAproximado = (window.userGender === 'male') 
                        ? (10 * pesoEstimadoInicioSemana) + (6.25 * (window.userHeightCm || 175)) - (5 * (window.userAge || 30)) + 5
                        : (10 * pesoEstimadoInicioSemana) + (6.25 * (window.userHeightCm || 165)) - (5 * (window.userAge || 30)) - 161;
                    
                    tdeeDelDia = tmbAproximado * (window.userActivityLevel || 1.375);
                }
            } else {
                // Fallback a lineal (datos no disponibles)
                const semanasActivas = window.semanaGlobalActual - semanaGlobalInicial - 
                    semanasPausa.filter(p => p.mes < mes || (p.mes === mes && p.semanaLocal < semana)).length;
                
                pesoEstimadoInicioSemana = pesoInicialFase + (cambioPesoPorSemana * semanasActivas);
                pesoEstimadoFinSemana = pesoEstimadoInicioSemana + cambioPesoPorSemana;
                
                // Calcular TDEE lineal
                let tmbAproximado = (window.userGender === 'male') 
                    ? (10 * pesoEstimadoInicioSemana) + (6.25 * (window.userHeightCm || 175)) - (5 * (window.userAge || 30)) + 5
                    : (10 * pesoEstimadoInicioSemana) + (6.25 * (window.userHeightCm || 165)) - (5 * (window.userAge || 30)) - 161;
                
                tdeeDelDia = tmbAproximado * (window.userActivityLevel || 1.375);
            }
				
				
				// --- 🔥 AJUSTE ESPECIAL PARA PAUSAS METABÓLICAS ---
            if (esPausaMetabolicaFase || esPausaMetabolicaSemana) {
                const nivelAFElement = document.getElementById('activity');
                let nivelAF = 1.375; // Valor por defecto
                
                if (nivelAFElement) {
                    nivelAF = parseFloat(nivelAFElement.value) || 1.375;
                } else {
                    console.warn("Elemento 'activity' no encontrado. Usando nivelAF por defecto (1.375)");
                }
                
                // Si el nivel de actividad es > 1.33, ajustamos el TDEE para pausa
                if (nivelAF > 1.33) {
                    // Primero calculamos el BMR (Metabolismo Basal)
                    const bmr = tdeeDelDia / nivelAF;
                    
                    // Luego calculamos el TDEE para pausa usando factor 1.33
                    tdeeDelDia = bmr * 1.33;
                    
                    console.log(`🔄 Ajuste de pausa metabólica: nivelAF=${nivelAF.toFixed(2)} → TDEE recalculado=${tdeeDelDia.toFixed(0)} kcal`);
                }
                // Si nivelAF <= 1.33, no se necesita ajuste (ya está en mantenimiento)
            }

            const datosDias = [];

            // --- Generar datos por día ---
            for (let diaIndex = 0; diaIndex < 7; diaIndex++) {
                const diaNombre = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'][diaIndex];
                const diaNumero = diaIndex + 1;

                // --- 🔥 Calorías diarias (crítico: NO sumar ajuste en no lineal) ---
                let caloriasDiarias = tdeeDelDia;

                // Solo en MODO LINEAL y NO en pausa, aplicar ajuste calórico
                if (!useNonLinear && !(esPausaMetabolicaFase || esPausaMetabolicaSemana) && 
                    window.weeklyCalorieDiffManualGlobal !== null) {
                    const ajusteDiarioKcal = Number(document.getElementById('weekly-calorie-diff')?.value || 0) / 7;
                    caloriasDiarias = tdeeDelDia + ajusteDiarioKcal;
                }
				
                let proteinasPctDia = proteinasPctPromedio;
                let carbohidratosPctDia = carbohidratosPctPromedio;
                let grasasPctDia = grasasPctPromedio;
                let notasEstrategias = [];

                if (!(esPausaMetabolicaFase || esPausaMetabolicaSemana)) {
                    if (estrategiasActivas.includes('refeed') && diaNombre === 'Domingo') {
                        carbohidratosPctDia = Math.min(95, carbohidratosPctDia + 20);
                        grasasPctDia = Math.max(5, 100 - proteinasPctDia - carbohidratosPctDia);
                        caloriasDiarias = Math.round(caloriasDiarias * 1.05);
                        notasEstrategias.push('Día de Refeed');
                    }
                    if (estrategiasActivas.includes('carb_cycling') && (diaNumero % 2 === 0)) {
                        carbohidratosPctDia = Math.min(90, carbohidratosPctDia + 15);
                        grasasPctDia = Math.max(5, 100 - proteinasPctDia - carbohidratosPctDia);
                        notasEstrategias.push('Día alto en HC (Carb Cycling)');
                    }
                    if (estrategiasActivas.includes('protein_cycling') && diaNombre === 'Domingo') {
                        proteinasPctDia = Math.max(15, proteinasPctDia - 10);
                        grasasPctDia = 100 - proteinasPctDia - carbohidratosPctDia;
                        notasEstrategias.push('Día bajo en proteína (Protein Cycling)');
                    }
                    if (estrategiasActivas.includes('ckd') && (diaNombre === 'Sábado' || diaNombre === 'Domingo')) {
                        carbohidratosPctDia = Math.min(95, carbohidratosPctDia + 30);
                        grasasPctDia = Math.max(2, 100 - proteinasPctDia - carbohidratosPctDia);
                        caloriasDiarias = Math.round(caloriasDiarias * 1.1);
                        notasEstrategias.push('Día de Carb-Loading (CKD)');
                    }
                    if (estrategiasActivas.includes('tkd') && ['Lunes', 'Miércoles', 'Viernes'].includes(diaNombre)) {
                        carbohidratosPctDia = Math.min(85, carbohidratosPctDia + 10);
                        grasasPctDia = Math.max(5, 100 - proteinasPctDia - carbohidratosPctDia);
                        notasEstrategias.push('Targeted Keto (TKD)');
                    }
                }

                if (estrategiasActivas.includes('if_16_8')) notasEstrategias.push('IF 16:8 aplicado');
                if (estrategiasActivas.includes('timing')) notasEstrategias.push('Timing Nutricional');
                if (estrategiasActivas.includes('flexible_dieting')) notasEstrategias.push('Flexible Dieting (80/20)');
                if (estrategiasActivas.includes('hiperproteica')) {
                    const proteinasMinimas = pesoEstimadoInicioSemana * 1.8;
                    if ((caloriasDiarias * proteinasPctDia / 100) / 4 < proteinasMinimas) {
                        proteinasPctDia = Math.round((proteinasMinimas * 4 / caloriasDiarias) * 100);
                        grasasPctDia = 100 - proteinasPctDia - carbohidratosPctDia;
                        notasEstrategias.push('Ajuste por Hiperproteica (1.8-2.5g/kg proteína)');
                    }
                    notasEstrategias.push('Dieta Hiperproteica');
                }

                const totalPct = proteinasPctDia + carbohidratosPctDia + grasasPctDia;
                if (Math.abs(totalPct - 100) > 0.1) {
                    const diff = 100 - totalPct;
                    grasasPctDia += diff;
                    console.warn(`Porcentajes ajustados en Semana ${semanaGlobalActual}, Día ${diaNombre} para sumar 100%.`);
                }

                const proteinas_g = Math.round((caloriasDiarias * proteinasPctDia / 100) / 4);
                const carbohidratos_g = Math.round((caloriasDiarias * carbohidratosPctDia / 100) / 4);
                const grasas_g = Math.round((caloriasDiarias * grasasPctDia / 100) / 9);

                const limiteCaloriasMin = window.userGender === 'female' ? 1200 : 1500;
                if (caloriasDiarias < limiteCaloriasMin) {
                    console.warn(`Calorías ajustadas en Semana ${semanaGlobalActual}, Día ${diaNombre} por debajo del límite (${limiteCaloriasMin}).`);
                    caloriasDiarias = limiteCaloriasMin;
                }

                let notasDia = esPausaMetabolicaFase || esPausaMetabolicaSemana
                    ? `Pausa metabólica: ${datosFase.observaciones || 'Mantener calorías al nivel de TDEE, reducir intensidad de entrenamiento.'}`
                    : `Basado en ${useNonLinear ? 'TDEE del modelo no lineal (ya ajustado)' : 'TDEE estimado'} (${tdeeDelDia.toFixed(0)} kcal)${useNonLinear ? '' : ' y ajuste objetivo'}.`;

                if (!useNonLinear && !(esPausaMetabolicaFase || esPausaMetabolicaSemana) && window.weeklyCalorieDiffManualGlobal !== null) {
                    notasDia += ` Ajuste diario: ${window.weeklyCalorieDiffManualGlobal > 0 ? '+' : ''}${(window.weeklyCalorieDiffManualGlobal / 7).toFixed(0)} kcal.`;
                }
                if (notasEstrategias.length > 0) {
                    notasDia += ` Estrategias aplicadas: ${notasEstrategias.join(', ')}.`;
                }

                // --- Añadir datos del día ---
                datosDias.push({
                    dia: diaNombre,
                    actividad: window.userActivityLevel || 1.375,
                    calorias: Math.round(caloriasDiarias),
                    proteinasPct: Math.round(proteinasPctDia),
                    carbohidratosPct: Math.round(carbohidratosPctDia),
                    grasasPct: Math.round(grasasPctDia),
                    proteinas: proteinas_g,
                    carbohidratos: carbohidratos_g,
                    grasas: grasas_g,
                    pesoEstimado: parseFloat(pesoEstimadoInicioSemana.toFixed(2)),
                    estrategias: notasEstrategias.join(', '),
                    notas: notasDia
                });
            }
             
            const esPausaMetabolica6Semana = (window.semanaGlobalActual % 6 === 0); // ✅ Cada 6 semanas
            datosSemanas.push({
                semana: window.semanaGlobalActual,
                semanaEnMes: semanaEnMes,
                esPausaMetabolica: esPausaMetabolicaFase || esPausaMetabolica6Semana || esPausaMetabolicaSemana,
                pesoInicioSemana: parseFloat(pesoEstimadoInicioSemana.toFixed(2)),
                pesoFinSemana: parseFloat(pesoEstimadoFinSemana.toFixed(2)),
                dias: datosDias
            });

            // ✅ Solo restar si no es pausa
            if (!esPausaMetabolicaSemana) {
                semanasRestantes--;
            }
        }

        datosPorMes.push({
            mes: mes,
            semanas: datosSemanas
        });
    }

    if (datosPorMes.length === 0) {
        console.error("No se generaron datos de meses:", { mesInicio, mesFin, semanasEnFase, semanasPausaEstaFase });
    }

    return {
        datosPorMes: datosPorMes,
        estrategiasDisponibles: estrategiasDisponibles,
        semanasTotalesPlan: semanasTotalesPlan
    };
}
	
///////!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!Ultima seccion Calculos segun Objetivo!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		let chartInstance = null;
    	let weeklyMacros = [];

    function toggleOpcionesObjetivo() {
		const objetivo = document.getElementById('objetivo').value;
		// IDs de las secciones a ocultar/mostrar
		const opciones = {
			'perdida1': 'opcionesPerdida1',
			'ganancia1': 'opcionesGanancia1',
			'mantenimiento1': 'opcionesMantenimiento1',
			'mixto1': 'opcionesMixto1'
		};

		// Ocultar todas las secciones primero
		Object.values(opciones).forEach(id => {
			const elemento = document.getElementById(id);
			if (elemento) {
				elemento.style.display = 'none';
			} else {
				console.warn(`Elemento con ID '${id}' no encontrado.`);
			}
		});

		
			Object.values(opciones).forEach(id => document.getElementById(id).style.display = 'none');
			if (opciones[objetivo]) document.getElementById(opciones[objetivo]).style.display = 'block';

			// Resetear checkboxes
			document.querySelectorAll('.strategy-checkboxes input[type="checkbox"]').forEach(checkbox => {
				checkbox.checked = checkbox.value === 'ninguna';
			});
   } 

    
		function validarEntradas() {
			let valido = true;

			// Verificar suma de macros = 100%
			const p = parseInt(document.getElementById("protein-percentage")?.value || 0);
			const c = parseInt(document.getElementById("carb-percentage")?.value || 0);
			const f = parseInt(document.getElementById("fat-percentage")?.value || 0);
			const total = p + c + f;

			const errorMacros = document.getElementById("errorMacros");
			if (total !== 100) {
				valido = false;
				if (errorMacros) {
					errorMacros.style.display = "block";
					errorMacros.innerText = "⚠️ La suma de macronutrientes debe ser 100% (actual: " + total + "%).";
				} else {
					console.warn("Falta el contenedor #errorMacros en el HTML");
				}
			} else if (errorMacros) {
				errorMacros.style.display = "none";
			}

			// Validar distribución de comidas = 100%
			const b = parseInt(document.getElementById("breakfast-perc")?.value || 0);
			const s1 = parseInt(document.getElementById("snack1-perc")?.value || 0);
			const l = parseInt(document.getElementById("lunch-perc")?.value || 0);
			const s2 = parseInt(document.getElementById("snack2-perc")?.value || 0);
			const d = parseInt(document.getElementById("dinner-perc")?.value || 0);
			const totalMeals = b + s1 + l + s2 + d;

			const errorMeals = document.getElementById("errorMeals");
			if (totalMeals !== 100) {
				valido = false;
				if (errorMeals) {
					errorMeals.style.display = "block";
					errorMeals.innerText = "⚠️ La distribución de comidas debe sumar 100% (actual: " + totalMeals + "%).";
				} else {
					console.warn("Falta el contenedor #errorMeals en el HTML");
				}
			} else if (errorMeals) {
				errorMeals.style.display = "none";
			}

			return valido;
		}

				

			function calcularTMB(peso, altura, edad, sexo) {
			return sexo === 'Masculino' ? 10 * peso + 6.25 * altura - 5 * edad + 5 : 10 * peso + 6.25 * altura - 5 * edad - 161;
		}

		//function getSelectedStrategies(prefix) {
			//return Array.from(document.querySelectorAll(`#${prefix} input[type="checkbox"]:checked`)).map(checkbox => checkbox.value).filter(val => val !== 'ninguna');
		//}
		
		// Corregido: Asegurarse de que el contenedor tiene un ID único y se usa correctamente
		//function getSelectedStrategies(containerId) {
	    // Selecciona checkboxes dentro del contenedor específico
	   // const container = document.getElementById(containerId);
	   // if (!container) {
	       // console.warn(`Contenedor ${containerId} no encontrado para estrategias.`);
	       // return ['ninguna']; // Valor por defecto si no se encuentra
	    //}
	   // const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
	    //const strategies = Array.from(checkedBoxes).map(checkbox => checkbox.value).filter(val => val !== 'ninguna');
	   // return strategies.length > 0 ? strategies : ['ninguna'];
	//}
		/**
	 * Obtiene las estrategias seleccionadas según el objetivo.
	 * @returns {Array<string>} Un array con los valores de las estrategias seleccionadas.
	 *                          Si no hay ninguna seleccionada (además de 'ninguna'), devuelve ['ninguna'].
	 */
			function getSelectedStrategies() {
			    const objetivo = document.getElementById('objetivo').value;
			    let containerId = '';
			
			    // Determinar el ID del contenedor de checkboxes basado en el objetivo
			    switch (objetivo) {
			        case 'perdida1':
			            containerId = 'opcionesPerdida1';
			            break;
			        case 'ganancia1':
			            containerId = 'opcionesGanancia1';
			            break;
			        case 'mantenimiento1':
			            containerId = 'opcionesMantenimiento1';
			            break;
			        case 'mixto1':
			            containerId = 'opcionesMixto1';
			            break;
			        default:
			            console.warn('Objetivo no reconocido para obtener estrategias:', objetivo);
			            return ['ninguna'];
			    }
			
			    // Seleccionar el contenedor
			    const container = document.getElementById(containerId);
			    if (!container) {
			        console.error(`Contenedor de estrategias '${containerId}' no encontrado.`);
			        return ['ninguna'];
			    }
			
			    // Obtener checkboxes marcados dentro del contenedor
			    const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
			    
			    // Extraer los valores, excluyendo 'ninguna'
			    const strategies = Array.from(checkedBoxes)
			        .map(checkbox => checkbox.value)
			        .filter(val => val !== 'ninguna');
			
			    // Si no hay estrategias seleccionadas (además de 'ninguna'), devolver ['ninguna']
			    return strategies.length > 0 ? strategies : ['ninguna'];
			}	

				/**
			 * Calcula los macronutrientes basados en objetivo, fase y estrategias.
			 * @param {number} peso - El peso del usuario en kg.
			 * @param {number} gastoEnergetico - El TDEE (Gasto Energético Total) calculado.
			 * @param {string} objetivo - El objetivo seleccionado ('perdida1', 'ganancia1', etc.).
			 * @returns {Object|null} Un objeto con los resultados del cálculo o null si hay error.
			 */
		function formatearNombreCodigo(codigo) {
			const mapaCodigos = {
				// Objetivos
				'perdida1': 'pérdida de peso',
				'ganancia1': 'ganancia de peso',
				'mantenimiento1': 'mantenimiento',
				'mixto1': 'plan mixto',
				'sel': 'no seleccionado',
				// Fases de Pérdida
				'induccion_cetogenica1': 'inducción cetogénica',
				'ciclado_metabolico1': 'ciclado metabólico',
				'transicion_mantenimiento1': 'transición a mantenimiento',
				'ketoadaptation': 'ketoadaptación',
				// Fases de Ganancia
				'volumen1': 'volumen muscular',
				'masa1': 'enfoque en masa muscular',
				// Enfoques de Mantenimiento
				'equilibrio1': 'equilibrio flexible',
				'social1': 'adherencia social',
				// Fases de Mixto (asumiendo que pueden reusar algunos nombres o tienen específicos)
				// Puedes añadir más mapeos aquí si es necesario
				// Por defecto, intentar formatear el código si no está en el mapa
			};

		if (mapaCodigos[codigo]) {
			return mapaCodigos[codigo];
		}

		// Formateo básico por si acaso: reemplazar guiones bajos por espacios y convertir a minúsculas
		// Esto ayuda si se añaden nuevas fases sin actualizar el mapa.
		return codigo ? codigo.replace(/_/g, ' ') : 'no especificado';
	}
					/**
					 * Calcula los macronutrientes basados en objetivo, fase y estrategias.
					 * @param {number} peso - El peso del usuario en kg.
					 * @param {number} gastoEnergetico - El TDEE (Gasto Energético Total) calculado.
					 * @param {string} objetivo - El objetivo seleccionado ('perdida1', 'ganancia1', etc.).
					 * @returns {Object|null} Un objeto con los resultados del cálculo o null si hay error.
					 */
 
				function calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase) {
					// Validar entrada
					if (isNaN(peso) || isNaN(gastoEnergetico) || !objetivo || peso <= 0 || gastoEnergetico <= 0) {
						console.error("Entrada inválida en calcularMacronutrientes", { peso, gastoEnergetico, objetivo, fase });
						return null;
					}

					// === 1. Definir rangos de macronutrientes por OBJETIVO y FASE ===
					const macroRanges = {
						// --- Pérdida de peso ---
						perdida1: { proteinas: [20, 25], carbohidratos: [5, 10], grasas: [70, 75] },
						induccion_cetogenica1: { proteinas: [20, 25], carbohidratos: [5, 10], grasas: [70, 75] },
						ciclado_metabolico1: { proteinas: [22, 28], carbohidratos: [8, 20], grasas: [60, 70] },
						transicion_mantenimiento1: { proteinas: [25, 30], carbohidratos: [20, 25], grasas: [40, 50] },

						// --- Ganancia de peso ---
						ganancia1: { proteinas: [25, 30], carbohidratos: [40, 50], grasas: [25, 35] },
						volumen1: { proteinas: [25, 30], carbohidratos: [40, 50], grasas: [25, 35] },
						masa1: { proteinas: [25, 30], carbohidratos: [35, 45], grasas: [30, 35] },

						// --- Mantenimiento ---
						mantenimiento1: { proteinas: [20, 25], carbohidratos: [35, 45], grasas: [30, 35] },
						equilibrio1: { proteinas: [20, 25], carbohidratos: [35, 45], grasas: [30, 35] },
						social1: { proteinas: [20, 25], carbohidratos: [30, 50], grasas: [25, 40] }, // más flexible

						// --- Mixto/Combinado ---
						mixto1: { proteinas: [20, 25], carbohidratos: [30, 40], grasas: [35, 50] },
						definicion1: { proteinas: [25, 35], carbohidratos: [10, 25], grasas: [40, 55] },
						// 'volumen1' ya está definido arriba
						// 'mantenimiento1' también
					};

					// === 2. Decidir qué código usar: fase > objetivo
					const codigo = fase && fase !== 'sel' && macroRanges[fase] ? fase : objetivo;

					// === 3. Obtener rangos
					const ranges = macroRanges[codigo] || macroRanges[objetivo] || {
						proteinas: [25, 30],
						carbohidratos: [40, 50],
						grasas: [25, 35]
					};

					// === 4. Calcular porcentajes promedio (usamos el valor ajustado ya en gastoEnergetico)
					const proteinasPct = Math.round((ranges.proteinas[0] + ranges.proteinas[1]) / 2);
					const carbohidratosPct = Math.round((ranges.carbohidratos[0] + ranges.carbohidratos[1]) / 2);
					const grasasPct = 100 - proteinasPct - carbohidratosPct;

					// Validar grasas
					if (grasasPct < 15) {
						const diff = 15 - grasasPct;
						carbohidratosPct = Math.max(0, carbohidratosPct - diff);
						grasasPct = 15;
					}

					// === 5. Calorías: usamos el gastoEnergetico (ya ajustado por fase/objetivo)
					const calorias = gastoEnergetico; // ✅ Este es el valor final ajustado

					// === 6. Calcular gramos
					const proteinas = Math.round((calorias * proteinasPct / 100) / 4);
					const carbohidratos = Math.round((calorias * carbohidratosPct / 100) / 4);
					const grasas = Math.round((calorias * grasasPct / 100) / 9);

					// === 7. Validación
					if (isNaN(proteinas) || isNaN(carbohidratos) || isNaN(grasas) || proteinas < 0 || carbohidratos < 0 || grasas < 0) {
						console.error("Errores en cálculo de macros", { calorias, proteinasPct, carbohidratosPct, grasasPct });
						return null;
					}
					const mapaCodigos1 = {
						// Objetivos
						'perdida1': 'pérdida de peso',
						'ganancia1': 'ganancia de peso',
						'mantenimiento1': 'mantenimiento',
						'mixto1': 'plan mixto',
						'sel': 'no seleccionado',
						// Fases de Pérdida
						'induccion_cetogenica1': 'inducción cetogénica',
						'ciclado_metabolico1': 'ciclado metabólico',
						'transicion_mantenimiento1': 'transición a mantenimiento',
						'ketoadaptation': 'ketoadaptación',
						// Fases de Ganancia
						'volumen1': 'volumen muscular',
						'masa1': 'enfoque en masa muscular',
						// Fases de Mantenimiento
						'equilibrio1': 'equilibrio flexible',
						'social1': 'adherencia social'
					};
					// === 8. Recomendaciones personalizadas
					const objetivoLegible = mapaCodigos1[objetivo] || objetivo;
					const faseLegible = mapaCodigos1[codigo] || codigo;

					let recomendaciones = `Basado en tu objetivo de <strong>${objetivoLegible}</strong> y fase <strong>${faseLegible}</strong>.<br><br>`;
					recomendaciones += `<strong>Distribución de macronutrientes:</strong><br>`;
					recomendaciones += `• <strong>Proteínas:</strong> ${proteinasPct}% (${proteinas} g, ${peso ? (proteinas / peso).toFixed(1) : '?'} g/kg)<br>`;
					recomendaciones += `• <strong>Carbohidratos:</strong> ${carbohidratosPct}% (${carbohidratos} g)<br>`;
					recomendaciones += `• <strong>Grasas:</strong> ${grasasPct}% (${grasas} g)<br><br>`;

					// Notas por objetivo
					if (objetivo === 'perdida1') {
						recomendaciones += `<em>Enfoque en preservar masa muscular con proteína adecuada y ajuste progresivo del déficit.</em>`;
					} else if (objetivo === 'ganancia1') {
						recomendaciones += `<em>Superávit controlado para maximizar la hipertrofia con mínimo almacenamiento graso.</em>`;
					} else if (objetivo === 'mantenimiento1') {
						recomendaciones += `<em>Equilibrio sostenible con flexibilidad para mantener adherencia a largo plazo.</em>`;
					} else if (objetivo === 'mixto1') {
						recomendaciones += `<em>Plan cíclico: alterna fases de volumen, definición y mantenimiento para optimizar progresión.</em>`;
					}

					// === 9. Devolver resultados
					return {
						calorias,
						proteinas,
						carbohidratos,
						grasas,
						proteinasPct,
						carbohidratosPct,
						grasasPct,
						recomendaciones,
						faseUsada: faseLegible,
						codigoUsado: codigo
					};
				}


// --- Asegúrate de que getCombinedRangesConModal esté definida en el mismo archivo o cargada antes ---
// Si no la tienes definida por separado, aquí la incluyo para que funcione:

/**
 * (Definición de getCombinedRangesConModal)
 * Esta función debe estar disponible globalmente o definida antes de ser usada por calcularMacronutrientes.
 * Combina los rangos de macronutrientes de múltiples estrategias y maneja incompatibilidades con un modal.
 * @param {Array<string>} strategies - Array de nombres de estrategias seleccionadas.
 * @param {Object} estrategiaMap - El mapa de estrategias con sus rangos.
 * @param {string} contexto - "macros" o "plan" para determinar dónde mostrar el error.
 * @returns {Object|null} Un objeto con los rangos combinados o null si son incompatibles.
 */
function getCombinedRangesConModal(strategies, estrategiaMap, contexto = "plan") {
    if (!strategies || strategies.length === 0 || (strategies.length === 1 && strategies.includes('ninguna'))) {
        return estrategiaMap.ninguna;
    }

    const activeStrats = strategies.filter(s => s !== 'ninguna');
    if (activeStrats.length === 0) return estrategiaMap.ninguna;

    try {
        const combinedRanges = {
            grasas: [
                Math.max(...activeStrats.map(s => estrategiaMap[s].grasas[0])),
                Math.min(...activeStrats.map(s => estrategiaMap[s].grasas[1]))
            ],
            proteinas: [
                Math.max(...activeStrats.map(s => estrategiaMap[s].proteinas[0])),
                Math.min(...activeStrats.map(s => estrategiaMap[s].proteinas[1]))
            ],
            carbohidratos: [
                Math.max(...activeStrats.map(s => estrategiaMap[s].carbohidratos[0])),
                Math.min(...activeStrats.map(s => estrategiaMap[s].carbohidratos[1]))
            ],
            deficit: [ // Para déficit/superávit
                Math.min(...activeStrats.map(s => estrategiaMap[s].deficit[0])),
                Math.max(...activeStrats.map(s => estrategiaMap[s].deficit[1]))
            ],
            notas: activeStrats.map(s => estrategiaMap[s].nota).join('; ')
        };

        // Validar que los rangos combinados sean válidos
        const rangosInvalidos = {};
        let hayIncompatibilidad = false;
        for (const [macro, rango] of Object.entries(combinedRanges)) {
             // 'notas' y 'deficit' no se validan como rangos de porcentajes
             if (macro !== 'notas' && macro !== 'deficit' && rango[0] > rango[1]) {
                 rangosInvalidos[macro] = rango;
                 hayIncompatibilidad = true;
             }
        }

        if (hayIncompatibilidad) {
            console.error('Rangos de macronutrientes incompatibles detectados:', rangosInvalidos);
            // Llamar al modal de incompatibilidad SOLO si es para macros
            if (contexto === "macros") {
                 mostrarModalIncompatibilidad(activeStrats, rangosInvalidos);
            }
            // Devolver null para indicar error al código que llamó a esta función
            return null;
        }

        return combinedRanges;
    } catch (error) {
        console.error('Error al combinar rangos de estrategias:', error, strategies);
        return null;
    }
}

// --- Asegúrate también de que formatearNombreCodigo esté definida ---
// Si no la tienes, aquí la incluyo:

/**
 * Formatea los códigos internos de objetivo y fase a nombres legibles.
 * @param {string} codigo - El código interno (e.g., 'perdida1', 'induccion_cetogenica1').
 * @returns {string} El nombre formateado (e.g., 'pérdida de peso', 'inducción cetogénica').
 */
 /**
 * Formatea un código interno en un nombre legible para el usuario.
 * @param {string} codigo - El código interno a formatear.
 * @returns {string} El nombre legible.
 */
function formatearNombreCodigo(codigo) {
    // --- Mejora: Asegurar que el código sea un string ---
    if (typeof codigo !== 'string') {
        console.warn(`[Formateador] Código no es string:`, codigo);
        return 'no especificado';
    }

    const mapaCodigos = {
        // Objetivos
        'perdida1': 'pérdida de peso',
        'ganancia1': 'ganancia de peso',
        'mantenimiento1': 'mantenimiento',
        'mixto1': 'plan mixto',
        'sel': 'no seleccionado',
        // Fases de Pérdida
        'induccion_cetogenica1': 'inducción cetogénica',
        'ciclado_metabolico1': 'ciclado metabólico',
        'transicion_mantenimiento1': 'transición a mantenimiento',
        'ketoadaptation': 'ketoadaptación',
        // Fases de Ganancia
        'volumen1': 'volumen muscular',
        'masa1': 'enfoque en masa muscular',
        // Enfoques de Mantenimiento
        'equilibrio1': 'equilibrio flexible',
        'social1': 'adherencia social',
        // Estrategias (si quieres que se formateen en las recomendaciones)
        'ninguna': 'Ninguna',
        'tkd': 'TKD',
        'ckd': 'CKD',
        'if_16_8': 'IF 16:8',
        'refeed': 'Refeed',
        'hiperproteica': 'Hiperproteica',
        'carb_cycling': 'Carb Cycling',
        'protein_cycling': 'Protein Cycling',
        'timing': 'Timing Nutricional',
        'flexible_dieting': 'Flexible Dieting',
        'induccion_cetogenica': 'Inducción Cetogénica', // Añadido
        'baja_en_hc': 'Baja en HC', // Añadido
        'hipercalorica': 'Hipercalórica', // Añadido
        'equilibrada_nutricional': 'Equilibrada Nutricional', // Añadido
        'calorie_cycling': 'Calorie Cycling', // Añadido
        'protein_cycling': 'Protein Cycling', // Añadido
        'carb_loading': 'Carb-loading', // Añadido
        'mft': 'MFT', // Añadido
        'reverse_dieting': 'Reverse Dieting', // Añadido
        'adaptive_periodization': 'Adaptive Periodization', // Añadido
        'metabolic_flexibility_training': 'Metabolic Flexibility Training', // Añadido
        // Por defecto, intentar formatear el código si no está en el mapa
    };

    // --- Mejora: Intentar formatear el código si no está en el mapa ---
    if (mapaCodigos[codigo]) {
        return mapaCodigos[codigo];
    }
    
    // Si no está en el mapa, intentar una formateo básico:
    // Reemplazar _ por espacio, capitalizar primera letra de cada palabra
    try {
        return codigo.replace(/_/g, ' ')
                     .replace(/\b\w/g, function(char) { return char.toUpperCase(); });
    } catch (e) {
        console.error(`[Formateador] Error al formatear código '${codigo}':`, e);
        return codigo ? codigo.replace(/_/g, ' ') : 'no especificado';
    }
}


    function crearGrafico(datos) {
        const ctx = document.getElementById('chartMacros').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Grasas', 'Proteínas', 'Carbohidratos'],
                datasets: [{
                    data: datos,
                    backgroundColor: ['#4CAF50', '#2196F3', '#FF9800'],
                    borderColor: ['#388E3C', '#1976D2', '#F57C00'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#333', font: { size: 12 } } },
                    tooltip: { callbacks: { label: function(context) { return `${context.label}: ${context.raw}%`; } } }
                }
            }
        });
    }

    function actualizarUI(resultados, gastoEnergetico) {
        if (!resultados) return;
        document.getElementById('gastoEnergetico').textContent = document.getElementById('get-calories').value//gastoEnergetico.toLocaleString('es-ES');
        document.getElementById('calorias').textContent = resultados.calorias.toLocaleString('es-ES');
        document.getElementById('proteinas').textContent = resultados.proteinas;
        document.getElementById('proteinasPct').textContent = resultados.proteinasPct;
        document.getElementById('carbohidratos').textContent = resultados.carbohidratos;
        document.getElementById('carbohidratosPct').textContent = resultados.carbohidratosPct;
        document.getElementById('grasas').textContent = resultados.grasas;
        document.getElementById('grasasPct').textContent = resultados.grasasPct;
        document.getElementById('recomendaciones').innerHTML = resultados.recomendaciones;
        document.getElementById('resultados').style.display = 'block';
        if (typeof Chart !== 'undefined') {
            crearGrafico([resultados.grasasPct, resultados.proteinasPct, resultados.carbohidratosPct]);
        } else {
            console.error('Chart.js no está disponible.');
            document.getElementById('errorMessage').textContent = 'No se pudo cargar el gráfico. Verifique su conexión a internet.';
            document.getElementById('errorMessage').style.display = 'block';
        }
        document.getElementById('planificacionTemporal').style.display = 'block';
        actualizarPlanificacion();
		// Mostrar/Ocultar sección de planificación
    document.getElementById('planificacionTemporal').style.display = 'block';

		// --- NUEVO: Mostrar la Tabla General del Proceso ---
		// Esta función creará/mostrará la tabla general SI los datos del Paso 6 están disponibles
		mostrarTablaGeneralProceso('tablaGeneralProcesoContainer');
		// -----------------------------------------------

		// Actualizar la tabla semanal detallada (la actual)
		actualizarPlanificacion();
    }

    function crearSemana(semanaNum, fase, dieta, estrategias, calorias, proteinasPct, carbohidratosPct, grasasPct, entrenoDias, notas) {
        if (!validarEntradas(parseFloat(document.getElementById('weight').value), parseFloat(document.getElementById('height').value), parseFloat(document.getElementById('age').value), calorias, proteinasPct, carbohidratosPct, grasasPct)) {
            return null;
        }
        const proteinas = Math.round((calorias * proteinasPct / 100) / 4);
        const carbohidratos = Math.round((calorias * carbohidratosPct / 100) / 4);
        const grasas = Math.round((calorias * grasasPct / 100) / 9);
        if (grasas < 0 || isNaN(grasas) || proteinas < 0 || isNaN(proteinas) || carbohidratos < 0 || isNaN(carbohidratos)) {
            document.getElementById('errorMessage').textContent = `Error en Semana ${semanaNum}: Error en el cálculo de macronutrientes. Verifique los valores.`;
            document.getElementById('errorMessage').style.display = 'block';
            return null;
        }
        return { semana: `Sem ${semanaNum}`, fase, dieta, estrategias, calorias, proteinasPct, carbohidratosPct, grasasPct, proteinas, carbohidratos, grasas, entrenoDias, notas };
    }

    // --- Reemplaza tu función generarPlanPerdida actual con esta ---
	function generarPlanPerdida(periodo, peso, gastoEnergetico) {
		const plan = [];
	   
		/// --- 1. Obtener selecciones del usuario ---
		const fasePerdida = document.getElementById('fasePerdida1')?.value || 'induccion_cetogenica1';
		const estrategiasPerdida = getSelectedStrategies(); // Asumiendo que esta función ya maneja el objetivo 'perdida1'
		
		// --- 2. Validación básica ---
		if (!gastoEnergetico || gastoEnergetico <= 0) {
			console.error("Gasto energético inválido para generar plan de pérdida.");
			return plan;
		}
		

    // --- 3. Definir constantes ---
    const semanas = periodo === 'mensual' ? 12 : 4;
    // Mapa de nombres formateados para las fases
    const nombresFase = {
        'induccion_cetogenica1': 'Inducción Cetogénica',
        'ciclado_metabolico1': 'Ciclado Metabólico',
        'transicion_mantenimiento1': 'Transición a Mantenimiento',
        'ketoadaptation': 'Ketoadaptation'
    };
    const nombreFaseLegible = nombresFase[fasePerdida] || 'Fase no especificada';

		// --- 4. Definir el mapa de estrategias (debe coincidir con el de calcularMacronutrientes) ---
    const estrategiaMap = {
        ninguna: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: 'Cetosis estricta <50g HC/día' },
        tkd: { grasas: [65, 70], proteinas: [20, 25], carbohidratos: [8, 12], deficit: [0.8, 0.85], nota: '25-50g HC pre/post entreno' },
        ckd: { grasas: [60, 70], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.85, 0.9], nota: '2 días carb-loading (150-200g HC)' },
        if_16_8: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 15], deficit: [0.75, 0.85], nota: 'Ventana de alimentación 8 horas' },
        refeed: { grasas: [60, 65], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.9, 0.95], nota: '1-2 días/semana HC alto' },
        hiperproteica: { grasas: [60, 65], proteinas: [28, 32], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: '2-2.5 g/kg peso proteína' },
        carb_cycling: { grasas: [60, 70], proteinas: [22, 28], carbohidratos: [8, 20], deficit: [0.8, 0.9], nota: 'Días altos (100-130g)/bajos HC (<50g)' },
        protein_cycling: { grasas: [60, 70], proteinas: [18, 30], carbohidratos: [5, 15], deficit: [0.8, 0.9], nota: '4 semanas altas + 1 baja proteína' },
        timing: { grasas: [50, 60], proteinas: [28, 35], carbohidratos: [10, 20], deficit: [0.85, 0.9], nota: 'HC post-entreno' },
        flexible_dieting: { grasas: [30, 40], proteinas: [25, 35], carbohidratos: [30, 45], deficit: [0.9, 1.0], nota: '80/20 regla: 80% saludable, 20% flexible' }
    };
	
	
    // --- 5. Definir dietas base ---
    const dietasBase = {
        cetogenica: { nombre: 'Cetogénica', proteinasPct: 20, carbohidratosPct: 5, grasasPct: 75 },
        hiperproteica_dieta: { nombre: 'Hiperproteica', proteinasPct: 30, carbohidratosPct: 5, grasasPct: 65 }, // Valores base
        // Las demás se derivarán de las estrategias o se usarán valores por defecto

		moderada_en_hc: {nombre:'Moderada en HC', proteinasPct: 25, carbohidratosPct: 40, grasasPct: 35 },
        carb_cycling: { nombre: 'Carb Cycling', proteinasPct: 25, carbohidratosPct: 20, grasasPct: 55 } // Valor base, se ajusta
         // Valor base, se ajusta
    };
	 // --- 5. Definir dietas base ---
    const nombresDietas = {
		cetogenica: 'Cetogénica',
		protein_cycling_dieta: 'Protein Cycling',
		carb_cycling_dieta: 'Carb Cycling',
		hiperproteica_dieta: 'Hiperproteica',
        moderada_en_hc: 'Moderada en HC'
        
		
    };
	// --- 6. Determinar la dieta base principal ---
    // Prioridad: Hiperproteica y Protein Cycling como dietas base, luego Carb Cycling, luego Cetogénica por defecto.
    let dietaBaseKey = 'cetogenica'; // Valor por defecto para pérdida de peso
    if (estrategiasPerdida.includes('hiperproteica')) {
        dietaBaseKey = 'hiperproteica_dieta';
        // Esta estrategia define directamente la dieta base como Hiperproteica (2.5-3.0 g/kg peso proteína)
    } else if (estrategiasPerdida.includes('protein_cycling')) {
        dietaBaseKey = 'hiperproteica_dieta'; // Protein Cycling se basa en una dieta hiperproteica
        // La variación de proteína se manejará semana a semana
    } else if (estrategiasPerdida.includes('carb_cycling')) {
			
        dietaBaseKey = 'carb_cycling_dieta';
    } else if (estrategiasPerdida.includes('flexible_dieting')) {
        dietaBaseKey = 'flexible_dieting_dieta';
        // Para Carb Cycling en fase de pérdida, la base puede seguir siendo cetogenica o moderada
        // pero la estrategia implica variar los carbohidratos.
        // Mantenemos cetogenica como base y ajustamos según la estrategia.
        // Si prefieres una base específica para carb cycling, defínela en dietasBase y úsala aquí.
    }
    // Para otras estrategias como 'ninguna', 'if_16_8', 'timing', 'flexible_dieting',
    // la base sigue siendo cetogenica en el contexto de una fase de pérdida de peso cetogénica o similar.
    // Las modificaciones específicas se aplican semana a semana más adelante.

        const nombreDietaBase = dietasBase[dietaBaseKey] ? dietasBase[dietaBaseKey].nombre : dietasBase['cetogenica'].nombre;

	// --- 7. Combinar rangos de estrategias para obtener parámetros base ---
    function getCombinedParams(strategies) {
        if (!strategies || strategies.length === 0 || (strategies.length === 1 && strategies.includes('ninguna'))) {
            return estrategiaMap.ninguna;
        }
        const activeStrats = strategies.filter(s => s !== 'ninguna');
        if (activeStrats.length === 0) return estrategiaMap.ninguna;

        try {
            const combinedRanges = {
                grasas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].grasas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].grasas[1]))
                ],
                proteinas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].proteinas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].proteinas[1]))
                ],
                carbohidratos: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].carbohidratos[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].carbohidratos[1]))
                ],
                deficit: [
                    Math.min(...activeStrats.map(s => estrategiaMap[s].deficit[0])),
                    Math.max(...activeStrats.map(s => estrategiaMap[s].deficit[1]))
                ],
                notas: activeStrats.map(s => estrategiaMap[s].nota).join('; ')
            };
			
			if (combinedRanges.grasas[0] > combinedRanges.grasas[1] ||
                combinedRanges.proteinas[0] > combinedRanges.proteinas[1] ||
                combinedRanges.carbohidratos[0] > combinedRanges.carbohidratos[1]) {
                console.error('Rangos de macronutrientes incompatibles al generar plan:', combinedRanges);
                return null; // Indicar error
            }
            return combinedRanges;
        } catch (error) {
             console.error('Error al combinar rangos para el plan:', error, strategies);
             return null;
        }
    }
	
	
		const paramsBase = getCombinedParams(estrategiasPerdida);
		if (!paramsBase) {
			// Manejar error
			return plan;
		}

		// --- 8. Generar semanas ---
    for (let i = 0; i < semanas; i++) {
        const semanaNum = i + 1;
        
        // --- Valores iniciales para la semana basados en estrategias combinadas ---
        let faseSemana = nombreFaseLegible;
        let dietaSemana = nombreDietaBase; // Empieza con la dieta base
        let proteinasPct = Math.round((paramsBase.proteinas[0] + paramsBase.proteinas[1]) / 2);
        let carbohidratosPct = Math.round((paramsBase.carbohidratos[0] + paramsBase.carbohidratos[1]) / 2);
        let grasasPct = 100 - proteinasPct - carbohidratosPct; // Asegurar 100%
        
        // Ajustar si grasas es negativo
        if (grasasPct < 0) {
            const diff = -grasasPct;
            carbohidratosPct = Math.max(0, carbohidratosPct - diff);
            grasasPct = 0;
        }

        let calMult = (paramsBase.deficit[0] + paramsBase.deficit[1]) / 2;
        let calorias = Math.round(gastoEnergetico * calMult);
        let entrenoDias = '4 días entreno, 3 días descanso'; // Valor por defecto
        let notasSemana = paramsBase.notas || 'Sin estrategias especiales';
   
		// --- 9. Aplicar modificaciones por estrategias específicas en semanas específicas ---
        
        // --- Refeed Semanal ---
        if (estrategiasPerdida.includes('refeed') && (semanaNum % 4 === 0 || semanaNum === semanas)) {
            // Aumentar carbohidratos, reducir grasas
            carbohidratosPct = Math.min(95, carbohidratosPct + 20); // Ejemplo de ajuste
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            calMult = Math.min(1.0, calMult * 1.05); // Pequeño aumento de calorías
            calorias = Math.round(gastoEnergetico * calMult);
            dietaSemana = nombresDietas['refeed_dieta']; // Cambiar dieta para la semana
            notasSemana = `Día de Refeed (${carbohidratosPct}% HC). ` + notasSemana;
            entrenoDias = 'Día de Refeed';
        }
        // --- Carb Cycling (ej: semanas pares) ---
        else if (estrategiasPerdida.includes('carb_cycling') && (semanaNum % 2 === 0)) {
            // Día alto en carbohidratos
            carbohidratosPct = Math.min(90, carbohidratosPct + 15); // Ejemplo de ajuste
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            notasSemana = `Día alto HC (${carbohidratosPct}%). ` + notasSemana;
            entrenoDias = 'Día alto HC';
		}
		// --- Protein Cycling (ej: cada 5 semanas) ---
        else if (estrategiasPerdida.includes('protein_cycling') && (semanaNum % 5 === 0)) {
             // Reducir proteína
             const proteinasPctBaja = Math.max(15, proteinasPct - 10); // Ejemplo de ajuste
             proteinasPct = proteinasPctBaja;
             grasasPct = 100 - proteinasPct - carbohidratosPct; // Recalcular grasas
             notasSemana = `Semana baja proteína (${proteinasPct}%). ` + notasSemana;
             entrenoDias = 'Entreno ligero esta semana';
        }
        // --- CKD (ej: semanas 4, 8, 12) ---
        else if (estrategiasPerdida.includes('ckd') && (semanaNum % 4 === 0)) {
            // Similar a refeed, pero más extremo y específico
            carbohidratosPct = Math.min(95, carbohidratosPct + 30); // Aumento muy alto
            grasasPct = Math.max(2, 100 - proteinasPct - carbohidratosPct);
            calMult = Math.min(1.0, calMult * 1.1); // Aumento de calorías
            calorias = Math.round(gastoEnergetico * calMult);
            dietaSemana = nombresDietas['refeed_dieta']; // Tambien alta en HC
            notasSemana = `CKD - 2 días carb-loading (150-200g HC). ` + notasSemana;
            entrenoDias = '2 días carb-loading';
        }
		
			// --- IF 16:8, TKD, Timing, Flexible Dieting ---
			// Estas estrategias afectan más el timing o la adherencia que los macros brutos semanales.
			// Sus notas ya están incluidas en paramsBase.notas. Podemos enfatizarlas:
			// else if (estrategiasPerdida.includes('if_16_8')) { ... }
			// else if (estrategiasPerdida.includes('tkd')) { ... }
			// else if (estrategiasPerdida.includes('timing')) { ... }
			// else if (estrategiasPerdida.includes('flexible_dieting')) { ... }
			
			// --- 10. Validación final de calorías ---
			// (Opcional, puedes reutilizar la lógica de límites mínimos si la tenías)

			// --- 11. Crear objeto de semana ---
			const semanaObj = crearSemana(
				semanaNum,
				faseSemana, // Fase legible como "Inducción Cetogénica"
				dietaSemana, // Dieta derivada de estrategias como "Hiperproteica"
				estrategiasPerdida.join(', '), // Todas las estrategias aplicables
				calorias,
				proteinasPct,
				carbohidratosPct,
				grasasPct,
				entrenoDias,
				notasSemana // Notas específicas de la semana + generales
			);

			if (semanaObj) {
				plan.push(semanaObj);
			}
		}

		return plan;
	}
		
    
   
function generarPlanGanancia(periodo, peso, gastoEnergetico) {
    const plan = [];
    
    // --- 1. Obtener selecciones del usuario ---
    const estrategiasGanancia = getSelectedStrategies(); // Usar tu función que ya funciona
    // Para ganancia, no hay una "fase" como tal en tu HTML, pero podemos definir un nombre genérico
    const faseGanancia = 'Volumen Muscular'; // O como se defina en tu contexto

    // --- 2. Validación básica ---
    if (!gastoEnergetico || gastoEnergetico <= 0) {
        console.error("Gasto energético inválido para generar plan de ganancia.");
        return plan;
    }

    // --- 3. Definir constantes ---
    const semanas = periodo === 'mensual' ? 12 : 4;

    // --- 4. Definir el mapa de estrategias (debe coincidir con el de calcularMacronutrientes) ---
    const estrategiaMap = {
       
		ninguna: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: 'Cetosis estricta <50g HC/día' },
        tkd: { grasas: [65, 70], proteinas: [20, 25], carbohidratos: [8, 12], deficit: [0.8, 0.85], nota: '25-50g HC pre/post entreno' },
        ckd: { grasas: [60, 65], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.85, 0.9], nota: '2 días carb-loading (150-200g HC)' },
        if_16_8: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 15], deficit: [0.75, 0.85], nota: 'Ventana de alimentación 8 horas' },
        refeed: { grasas: [60, 65], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.9, 0.95], nota: '1-2 días/semana HC alto' },
        hiperproteica: { grasas: [60, 65], proteinas: [28, 32], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: '1.8-2.5 g/kg peso proteína' },
        carb_cycling: { grasas: [60, 70], proteinas: [22, 28], carbohidratos: [8, 20], deficit: [0.8, 0.9], nota: 'Días altos (100-130g)/bajos HC (<50g)' },
        protein_cycling: { grasas: [60, 70], proteinas: [18, 30], carbohidratos: [5, 15], deficit: [0.8, 0.9], nota: '4 semanas altas + 1 baja proteína' },
        timing: { grasas: [50, 60], proteinas: [28, 35], carbohidratos: [10, 20], deficit: [0.85, 0.9], nota: 'HC post-entreno' },
        flexible_dieting: { grasas: [30, 40], proteinas: [25, 35], carbohidratos: [30, 45], deficit: [0.9, 1.0], nota: '80/20 regla: 80% saludable, 20% flexible' }
    
    };

    // --- 5. Definir dietas base ---
    const nombresDietas = {
		protein_cycling_dieta: 'Protein Cycling',
		carb_cycling_dieta: 'Carb Cycling',
		hiperproteica_dieta: 'Hiperproteica',
        moderada_en_hc: 'Moderada en HC',
        refeed_dieta: 'Refeed (Alta HC)',
        timing_dieta: 'Timing Nutricional',
        flexible_dieting_dieta: 'Flexible Dieting'
		//ckd: 'CDK 2 dias'
		
    };

    // --- 6. Determinar la dieta base principal ---
    let dietaBaseKey = ' protein_cycling_dieta'; // Valor por defecto para ganancia
    if (estrategiasGanancia.includes('carb_cycling')) {
        dietaBaseKey = 'carb_cycling_dieta';
    } else if (estrategiasGanancia.includes('refeed')) {
        dietaBaseKey = 'refeed_dieta';
    } else if (estrategiasGanancia.includes('timing')) {
        dietaBaseKey = 'timing_dieta';
    } else if (estrategiasGanancia.includes('flexible_dieting')) {
        dietaBaseKey = 'flexible_dieting_dieta';
    }else if (estrategiasGanancia.includes('protein_cycling')) {
        dietaBaseKey = 'moderada_en_hc';
    }
    const nombreDietaBase = nombresDietas[dietaBaseKey] || nombresDietas['protein_cycling_dieta'];

    // --- 7. Combinar rangos de estrategias para obtener parámetros base ---
    function getCombinedParams(strategies) {
        if (!strategies || strategies.length === 0 || (strategies.length === 1 && strategies.includes('ninguna'))) {
            return estrategiaMap.ninguna;
        }
        const activeStrats = strategies.filter(s => s !== 'ninguna');
        if (activeStrats.length === 0) return estrategiaMap.ninguna;

        try {
            const combinedRanges = {
                grasas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].grasas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].grasas[1]))
                ],
                proteinas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].proteinas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].proteinas[1]))
                ],
                carbohidratos: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].carbohidratos[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].carbohidratos[1]))
                ],
                deficit: [ // En este contexto, deficit es superávit
                    Math.min(...activeStrats.map(s => estrategiaMap[s].deficit[0])),
                    Math.max(...activeStrats.map(s => estrategiaMap[s].deficit[1]))
                ],
                notas: activeStrats.map(s => estrategiaMap[s].nota).join('; ')
            };

            if (combinedRanges.grasas[0] > combinedRanges.grasas[1] ||
                combinedRanges.proteinas[0] > combinedRanges.proteinas[1] ||
                combinedRanges.carbohidratos[0] > combinedRanges.carbohidratos[1]) {
                console.error('Rangos de macronutrientes incompatibles al generar plan de ganancia:', combinedRanges);
                return null;
            }
            return combinedRanges;
        } catch (error) {
            console.error('Error al combinar rangos para el plan de ganancia:', error, strategies);
            return null;
        }
    }

    const paramsBase = getCombinedParams(estrategiasGanancia);
    if (!paramsBase) {
        console.error("No se pudieron combinar los parámetros de las estrategias para el plan de ganancia.");
        return plan;
    }

    // --- 8. Generar semanas ---
    for (let i = 0; i < semanas; i++) {
        const semanaNum = i + 1;
        
        // --- Valores iniciales para la semana basados en estrategias combinadas ---
        let faseSemana = faseGanancia; // 'Volumen Muscular'
        let dietaSemana = nombreDietaBase;
        let proteinasPct = Math.round((paramsBase.proteinas[0] + paramsBase.proteinas[1]) / 2);
        let carbohidratosPct = Math.round((paramsBase.carbohidratos[0] + paramsBase.carbohidratos[1]) / 2);
        let grasasPct = 100 - proteinasPct - carbohidratosPct;
        
        if (grasasPct < 0) {
            const diff = -grasasPct;
            carbohidratosPct = Math.max(0, carbohidratosPct - diff);
            grasasPct = 0;
        }

        let calMult = (paramsBase.deficit[0] + paramsBase.deficit[1]) / 2;
        let calorias = Math.round(gastoEnergetico * calMult);
        let entrenoDias = '4 días entreno, 3 días descanso';
        let notasSemana = paramsBase.notas || 'Sin estrategias especiales';

        // --- 9. Aplicar modificaciones por estrategias específicas en semanas específicas ---
        
        // --- Refeed Semanal ---
        if (estrategiasGanancia.includes('refeed') && (semanaNum % 4 === 0 || semanaNum === semanas)) {
            carbohidratosPct = Math.min(95, carbohidratosPct + 15);
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            calMult = Math.min(1.25, calMult * 1.05);
            calorias = Math.round(gastoEnergetico * calMult);
            dietaSemana = nombresDietas['refeed_dieta'];
            notasSemana = `Día de Refeed (${carbohidratosPct}% HC). ` + notasSemana;
            entrenoDias = 'Día de Refeed';
        }
        // --- Carb Cycling (ej: semanas pares) ---
        else if (estrategiasGanancia.includes('carb_cycling') && (semanaNum % 2 === 0)) {
            carbohidratosPct = Math.min(90, carbohidratosPct + 10);
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            notasSemana = `Día alto HC (${carbohidratosPct}%). ` + notasSemana;
            entrenoDias = 'Día alto HC';
        }
        // --- Timing Nutricional ---
        // Se refleja en las notas generales y en la distribución de comidas
        // else if (estrategiasGanancia.includes('timing')) { ... }

        // --- 10. Crear objeto de semana ---
        const semanaObj = crearSemana(
            semanaNum,
            faseSemana,
            dietaSemana,
            estrategiasGanancia.join(', '),
            calorias,
            proteinasPct,
            carbohidratosPct,
            grasasPct,
            entrenoDias,
            notasSemana
        );

        if (semanaObj) {
            plan.push(semanaObj);
        }
    }

    return plan;
}

    function generarPlanMantenimiento(periodo, peso, gastoEnergetico) {
        const plan = [];
        const estrategiasMantenimiento = getSelectedStrategies('opcionesMantenimiento');
        const semanas = periodo === 'mensual' ? 12 : 4;

        const dietas = {
            flexible_dieting: { nombre: 'Flexible Dieting', proteinasPct: 30, carbohidratosPct: 35, grasasPct: 35 },
            if_16_8: { nombre: 'Intermittent Fasting (16:8)', proteinasPct: 25, carbohidratosPct: 30, grasasPct: 45 },
            refeed: { nombre: 'Refeed', proteinasPct: 24, carbohidratosPct: 40, grasasPct: 36 },
            carb_cycling: { nombre: 'Carb Cycling', proteinasPct: 25, carbohidratosPct: 35, grasasPct: 40 }
        };

        const estrategiaMap = {
            ninguna: { dieta: 'flexible_dieting', calMult: 1.0, notas: 'Equilibrio nutricional', entrenoDias: '4 días entreno, 3 días descanso' },
            flexible_dieting: { dieta: 'flexible_dieting', calMult: 1.0, notas: '80/20 regla: 80% saludable, 20% flexible', entrenoDias: '4 días entreno, 3 días descanso' },
            if_16_8: { dieta: 'if_16_8', calMult: 1.0, notas: 'Ventana de alimentación 8 horas', entrenoDias: '4 días entreno, 3 días descanso' },
            refeed: { dieta: 'refeed', calMult: 1.05, notas: 'Días altos HC (150-200g)', entrenoDias: '2 días refeed' },
            carb_cycling: { dieta: 'carb_cycling', calMult: 1.0, notas: 'Días altos/bajos HC', entrenoDias: '4 días entreno, 3 días descanso' }
        };

        for (let semana = 1; semana <= semanas; semana++) {
            let dieta = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].nombre;
            let estrategias = estrategiasMantenimiento;
            let proteinasPct = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].proteinasPct;
            let carbohidratosPct = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].carbohidratosPct;
            let grasasPct = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].grasasPct;
            let calMult = Math.max(...estrategiasMantenimiento.map(s => estrategiaMap[s].calMult));
            let entrenoDias = estrategiasMantenimiento.map(s => estrategiaMap[s].entrenoDias).join('; ');
            let notas = estrategiasMantenimiento.map(s => estrategiaMap[s].notas).join('; ');

            if (estrategias.includes('refeed') && (semana === 4 || semana === 8 || semana === 12)) {
                dieta = dietas.refeed.nombre;
                proteinasPct = dietas.refeed.proteinasPct;
                carbohidratosPct = dietas.refeed.carbohidratosPct;
                grasasPct = dietas.refeed.grasasPct;
                calMult = 1.05;
                notas = 'Días altos HC (150-200g)' + (notas ? '; ' + notas : '');
                entrenoDias = '2 días refeed';
            } else if (estrategias.includes('carb_cycling') && semana % 2 === 0) {
                dieta = dietas.carb_cycling.nombre;
                proteinasPct = dietas.carb_cycling.proteinasPct;
                carbohidratosPct = 45;
                grasasPct = 30;
                calMult = 1.05;
                notas = 'Días altos HC' + (notas ? '; ' + notas : '');
                entrenoDias = '4 días entreno';
            }

            const semanaObj = crearSemana(semana, 'Mantenimiento', dieta, estrategias.join(', '), Math.round(gastoEnergetico * calMult), proteinasPct, carbohidratosPct, grasasPct, entrenoDias, notas);
            if (semanaObj) plan.push(semanaObj);
        }

        return plan;
    }

    function generarPlanMixto(periodo, peso, gastoEnergetico) {
        const plan = [];
        const estrategiasMixto = getSelectedStrategies('opcionesMixto');
        const semanas = periodo === 'mensual' ? 12 : 4;

        const dietas = {
            moderada: { nombre: 'Moderada en HC', proteinasPct: 25, carbohidratosPct: 45, grasasPct: 30 },
            carb_cycling: { nombre: 'Carb Cycling', proteinasPct: 25, carbohidratosPct: 35, grasasPct: 40 },
            refeed: { nombre: 'Refeed', proteinasPct: 24, carbohidratosPct: 40, grasasPct: 36 },
            timing: { nombre: 'Timing Nutricional', proteinasPct: 28, carbohidratosPct: 35, grasasPct: 37 },
            flexible_dieting: { nombre: 'Flexible Dieting', proteinasPct: 30, carbohidratosPct: 35, grasasPct: 35 }
        };

        const estrategiaMap = {
            ninguna: { dieta: 'moderada', calMult: 1.0, notas: 'Balance nutricional', entrenoDias: '4 días entreno, 3 días descanso' },
            carb_cycling: { dieta: 'carb_cycling', calMult: 1.0, notas: 'Días altos/bajos HC', entrenoDias: '4 días entreno, 3 días descanso' },
            refeed: { dieta: 'refeed', calMult: 1.05, notas: 'Días altos HC (150-200g)', entrenoDias: '2 días refeed' },
            timing: { dieta: 'timing', calMult: 1.0, notas: 'HC post-entreno', entrenoDias: '4 días entreno, 3 días descanso' },
            flexible_dieting: { dieta: 'flexible_dieting', calMult: 1.0, notas: '80/20 regla: 80% saludable, 20% flexible', entrenoDias: '4 días entreno, 3 días descanso' }
        };

        const periodization = [
            { semana: 1, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 2, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 3, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 4, fase: 'Definición', dieta: estrategiasMixto.includes('carb_cycling') ? 'carb_cycling' : 'moderada', estrategias: estrategiasMixto, calMult: 0.85, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 5, fase: 'Definición', dieta: estrategiasMixto.includes('carb_cycling') ? 'carb_cycling' : 'moderada', estrategias: estrategiasMixto, calMult: 0.85, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 6, fase: 'Definición', dieta: estrategiasMixto.includes('carb_cycling') ? 'carb_cycling' : 'moderada', estrategias: estrategiasMixto, calMult: 0.85, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 7, fase: 'Mantenimiento', dieta: 'flexible_dieting', estrategias: estrategiasMixto, calMult: 1.0, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 8, fase: 'Mantenimiento', dieta: 'flexible_dieting', estrategias: estrategiasMixto, calMult: 1.0, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 9, fase: 'Mantenimiento', dieta: 'flexible_dieting', estrategias: estrategiasMixto, calMult: 1.0, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 10, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 11, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
            { semana: 12, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') }
        ];

        for (let semana = 1; semana <= semanas; semana++) {
            let semanaConfig = periodization[semana - 1] || periodization[periodization.length - 1];
            let dieta = dietas[semanaConfig.dieta].nombre;
            let estrategias = semanaConfig.estrategias;
            let proteinasPct = dietas[semanaConfig.dieta].proteinasPct;
            let carbohidratosPct = dietas[semanaConfig.dieta].carbohidratosPct;
            let grasasPct = dietas[semanaConfig.dieta].grasasPct;
            let calMult = semanaConfig.calMult;
            let entrenoDias = semanaConfig.entrenoDias;
            let notas = semanaConfig.notas;

            if (estrategias.includes('refeed') && (semana === 4 || semana === 8 || semana === 12)) {
                dieta = dietas.refeed.nombre;
                proteinasPct = dietas.refeed.proteinasPct;
                carbohidratosPct = dietas.refeed.carbohidratosPct;
                grasasPct = dietas.refeed.grasasPct;
                calMult = 1.05;
                notas = 'Días altos HC (150-200g)' + (notas ? '; ' + notas : '');
                entrenoDias = '2 días refeed';
            } else if (estrategias.includes('carb_cycling') && semana % 2 === 0) {
                dieta = dietas.carb_cycling.nombre;
                proteinasPct = dietas.carb_cycling.proteinasPct;
                carbohidratosPct = 45;
                grasasPct = 30;
                calMult = 1.05;
                notas = 'Días altos HC' + (notas ? '; ' + notas : '');
                entrenoDias = '4 días entreno';
            }

            const semanaObj = crearSemana(semana, semanaConfig.fase, dieta, estrategias.join(', '), Math.round(gastoEnergetico * calMult), proteinasPct, carbohidratosPct, grasasPct, entrenoDias, notas);
            if (semanaObj) plan.push(semanaObj);
        }

        return plan;
    }

  
   function ajustarEntrenoDias(semanaNum, valor) {
        const planificacion = JSON.parse(JSON.stringify(weeklyMacros));
        const semana = planificacion.find(item => item.semana === `Sem ${semanaNum}`);
        if (!semana) return;

        // Actualizar los días de entrenamiento
        semana.entrenoDias = valor;

        weeklyMacros = planificacion;
        actualizarPlanificacion();
    }

    function actualizarPlanificacion() {
        const tbody = document.getElementById('tablaPlanificacionBody');
        tbody.innerHTML = '';
        weeklyMacros.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.semana}</td>
                <td><span class="badge bg-${getBadgeClass(item.fase)}">${item.fase}</span><br><span class="badge bg-${getBadgeClass(item.dieta)}">${item.dieta}</span></td>
                <td><span class="badge bg-${getBadgeClass(item.estrategias)}">${item.estrategias || 'Ninguna'}</span></td>
                <td>${item.calorias.toLocaleString('es-ES')}</td>
                <td><input type="number" class="macro-input form-control" value="${item.proteinasPct}" min="0" max="100" oninput="ajustarMacros(${item.semana.replace('Sem ', '')}, 'proteinas', this.value)"></td>
                <td><input type="number" class="macro-input form-control" value="${item.carbohidratosPct}" min="0" max="100" oninput="ajustarMacros(${item.semana.replace('Sem ', '')}, 'carbohidratos', this.value)"></td>
                <td><input type="number" class="macro-input form-control" value="${item.grasasPct}" min="0" max="100" oninput="ajustarMacros(${item.semana.replace('Sem ', '')}, 'grasas', this.value)"></td>
                <td>${isNaN(item.proteinas) ? '-' : item.proteinas}</td>
                <td>${isNaN(item.carbohidratos) ? '-' : item.carbohidratos}</td>
                <td>${isNaN(item.grasas) ? '-' : item.grasas}</td>
                <td>
                    <select class="form-control" onchange="ajustarEntrenoDias(${item.semana.replace('Sem ', '')}, this.value)">
                        <option value="0 días entreno" ${item.entrenoDias === '0 días entreno' ? 'selected' : ''}>0 días</option>
                        <option value="1 día entreno, 6 días descanso" ${item.entrenoDias === '1 día entreno, 6 días descanso' ? 'selected' : ''}>1 día</option>
                        <option value="2 días entreno, 5 días descanso" ${item.entrenoDias === '2 días entreno, 5 días descanso' ? 'selected' : ''}>2 días</option>
                        <option value="3 días entreno, 4 días descanso" ${item.entrenoDias === '3 días entreno, 4 días descanso' ? 'selected' : ''}>3 días</option>
                        <option value="4 días entreno, 3 días descanso" ${item.entrenoDias === '4 días entreno, 3 días descanso' ? 'selected' : ''}>4 días</option>
                        <option value="5 días entreno, 2 días descanso" ${item.entrenoDias === '5 días entreno, 2 días descanso' ? 'selected' : ''}>5 días</option>
                        <option value="6 días entreno, 1 día descanso" ${item.entrenoDias === '6 días entreno, 1 día descanso' ? 'selected' : ''}>6 días</option>
                        <option value="7 días entreno" ${item.entrenoDias === '7 días entreno' ? 'selected' : ''}>7 días</option>
                    </select>
                </td>
                <td class="strategy-note">${item.notas}</td>
            `;
            tbody.appendChild(row);
            // Agregar div de error para cada fila
            const errorDiv = document.createElement('div');
            errorDiv.id = `errorMessageSem${item.semana.replace('Sem ', '')}`;
            errorDiv.className = 'alert alert-danger mt-2';
            errorDiv.style.display = 'none';
            row.appendChild(errorDiv);
        });
    }



    function ajustarMacros(semanaNum, macro, valor) {
        const planificacion = JSON.parse(JSON.stringify(weeklyMacros));
        const semana = planificacion.find(item => item.semana === `Sem ${semanaNum}`);
        if (!semana) return;

        // Actualizar el porcentaje según el macro ajustado
        if (macro === 'proteinas') semana.proteinasPct = parseInt(valor) || 0;
        if (macro === 'carbohidratos') semana.carbohidratosPct = parseInt(valor) || 0;
        if (macro === 'grasas') semana.grasasPct = parseInt(valor) || 0;

        // Calcular gramos de macronutrientes basados en los porcentajes actuales
        semana.proteinas = Math.round((semana.calorias * semana.proteinasPct / 100) / 4);
        semana.carbohidratos = Math.round((semana.calorias * semana.carbohidratosPct / 100) / 4);
        semana.grasas = Math.round((semana.calorias * semana.grasasPct / 100) / 9);

        const errorDiv = document.getElementById(`errorMessageSem${semanaNum}`);
        if (!errorDiv) {
            const newErrorDiv = document.createElement('div');
            newErrorDiv.id = `errorMessageSem${semanaNum}`;
            newErrorDiv.className = 'alert alert-danger mt-2';
            newErrorDiv.style.display = 'none';
            document.getElementById('tablaPlanificacionBody').querySelector(`tr:nth-child(${semanaNum})`).appendChild(newErrorDiv);
        }

        // Validar que los porcentajes sumen 100%
        const totalPct = semana.proteinasPct + semana.carbohidratosPct + semana.grasasPct;
        if (totalPct !== 100) {
            document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Los porcentajes deben sumar 100% (actual: ${totalPct}%).`;
            document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
            return;
        } else {
            document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'none';
        }

        const dietaRanges = {
            'Cetogénica': { carbohidratos: [5, 20], proteinas: [20, 35], grasas: [55, 75] },
            'Hiperproteica': { carbohidratos: [40, 50], proteinas: [25, 35], grasas: [30, 40] },
            'Carb Cycling': { carbohidratos: [20, 50], proteinas: [20, 35], grasas: [30, 60] },
            'Intermittent Fasting (16:8)': { carbohidratos: [5, 40], proteinas: [20, 35], grasas: [35, 75] },
            'Refeed': { carbohidratos: [20, 50], proteinas: [20, 32], grasas: [30, 60] },
            'Ketoadaptation': { carbohidratos: [5, 25], proteinas: [18, 30], grasas: [55, 75] },
            'Flexible Dieting': { carbohidratos: [25, 45], proteinas: [25, 40], grasas: [30, 50] },
            'Moderada en HC': { carbohidratos: [25, 45], proteinas: [20, 30], grasas: [30, 40] },
            'Timing Nutricional': { carbohidratos: [10, 20], proteinas: [28, 35], grasas: [50, 60] }
        };

        // Validar límite de proteínas (2.5 g/kg) para días altos de proteína
        const peso = parseFloat(document.getElementById('weight').value);
        const isHighProtein = semana.dieta === 'Hiperproteica' || semana.estrategias.includes('hiperproteica');
        if (isHighProtein && !isNaN(peso) && semana.proteinas > 2.5 * peso) {
            document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Error en Semana ${semanaNum}: Las proteínas no deben exceder 2.5 g/kg de peso corporal (${(2.5 * peso).toFixed(1)} g).`;
            document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
            return;
        }

        // Validar rangos de macronutrientes
        const combinedRanges = dietaRanges[semana.dieta];
        if (
            semana.carbohidratosPct < combinedRanges.carbohidratos[0] || semana.carbohidratosPct > combinedRanges.carbohidratos[1] ||
            semana.proteinasPct < combinedRanges.proteinas[0] || semana.proteinasPct > combinedRanges.proteinas[1] ||
            semana.grasasPct < combinedRanges.grasas[0] || semana.grasasPct > combinedRanges.grasas[1]
        ) {
            document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Error en Semana ${semanaNum}: Los porcentajes deben estar dentro de los rangos de ${semana.dieta} (Carbohidratos: ${combinedRanges.carbohidratos.join('-')}%, Proteínas: ${combinedRanges.proteinas.join('-')}%, Grasas: ${combinedRanges.grasas.join('-')}%).`;
            document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
            return;
        }

        if (semana.calorias < (document.getElementById('gender').value === 'Femenino' ? 1200 : 1500)) {
            document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Error en Semana ${semanaNum}: Las calorías no pueden ser inferiores a ${document.getElementById('gender').value === 'Femenino' ? 1200 : 1500} kcal sin supervisión médica.`;
            document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
            return;
        }

        weeklyMacros = planificacion;
        actualizarPlanificacion();
    }



    function getBadgeClass(faseOrDieta) {
        const badgeClasses = {
            'Inducción Cetogénica': 'danger',
            'Ciclado Metabólico': 'warning',
            'Transición a Mantenimiento': 'success',
            'Ketoadaptation': 'info',
            'Volumen': 'primary',
            'Definición': 'info',
            'Mantenimiento': 'secondary',
            'Cetogénica': 'danger',
            'Hiperproteica': 'primary',
            'Carb Cycling': 'warning',
            'Intermittent Fasting (16:8)': 'info',
            'Refeed': 'success',
            'Flexible Dieting': 'secondary',
            'Moderada en HC': 'success',
            'Timing Nutricional': 'primary',
            'ninguna': 'secondary',
            'tkd': 'danger',
            'ckd': 'warning',
            'if_16_8': 'info',
            'refeed': 'success',
            'hiperproteica': 'primary',
            'carb_cycling': 'warning',
            'protein_cycling': 'primary',
            'timing': 'info',
            'flexible_dieting': 'secondary',
            'ketoadaptation_tkd': 'danger',
            'ketoadaptation_if': 'info',
            'ketoadaptation_refeed': 'success',
            'ketoadaptation_protein_cycling': 'primary'
        };
        return badgeClasses[faseOrDieta] || 'secondary';
    }

		 function calcularTMB(peso, altura, edad, sexo) {
				// Calculates TMB using Mifflin-St Jeor equation
				// peso: kilograms, altura: centimeters, edad: years
				return sexo === 'Masculino' ? 10 * peso + 6.25 * altura - 5 * edad + 5 : 10 * peso + 6.25 * altura - 5 * edad - 161;
			}

       //// CALCULAR MACROS -1º MODAL SEGUNDO AUTOMATICA///////////////////////////////////////


			function calcularMacros(useManual = false) {
    // Debug: Log all required elements
    console.log('Checking DOM elements:');
    const ids = ['weight', 'height', 'age', 'gender', 'activity', 'objetivo', 'periodoPlanificacion'];
    ids.forEach(id => {
        console.log(`${id} element:`, document.getElementById(id));
    });

	if (typeof window.macrosConfiguracionManual === 'undefined') {
		window.macrosConfiguracionManual = {};
	}
    // Retry if activity-level is not found (dynamic content)
    const activitySelect = document.getElementById('activity');
    if (!activitySelect) {
        console.warn('activity-level not found. Retrying in 100ms...');
        return;
    }

    // Check all required DOM elements
    for (const id of ids) {
        const element = document.getElementById(id);
        if (!element) {
            console.error(`Element with ID "${id}" not found.`);
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.textContent = `Error: No se encontró el elemento con ID "${id}".`;
                errorMessage.style.display = 'block';
            }
            return;
        }
    }

    // Patch <select id="activity-level"> options
    activitySelect.innerHTML = `
        <option value="1.2">Sedentario (poco o nada)</option>
        <option value="1.375">Ligero (1-3 días/semana)</option>
        <option value="1.55" selected>Moderado (3-5 días/semana)</option>
        <option value="1.725">Activo (6-7 días/semana)</option>
        <option value="1.9">Muy activo (entrenamiento intenso)</option>
    `;

    // Get values from form
    const peso = parseFloat(document.getElementById('weight').value);
    const height = parseFloat(document.getElementById('height').value);
    const altura = height * 100; // Convert to centimeters
    const edad = parseInt(document.getElementById('age').value);
    const sexo = document.getElementById('gender').value;
    const actividad = parseFloat(document.getElementById('activity').value);
    const objetivo = document.getElementById('objetivo').value;

    // --- Validación de fase seleccionada ---
    let faseValida = true;
    let nombreSelectFase = '';

    switch (objetivo) {
        case 'perdida1':
            const fasePerdida = document.getElementById('fasePerdida1')?.value;
            if (!fasePerdida || fasePerdida.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Fase de Pérdida de Peso';
            }
            break;
        case 'ganancia1':
            const faseGanancia = document.getElementById('faseGanancia1')?.value;
            if (!faseGanancia || faseGanancia.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Fase de Ganancia de Peso';
            }
            break;
        case 'mantenimiento1':
            const enfoqueMantenimiento = document.getElementById('enfoqueMantenimiento1')?.value;
            if (!enfoqueMantenimiento || enfoqueMantenimiento.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Enfoque de Mantenimiento';
            }
            break;
        case 'mixto1':
            const faseMixto = document.getElementById('faseMixto1')?.value;
            if (!faseMixto || faseMixto.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Fase del Plan Mixto';
            }
            break;
        default:
            break;
    }

    if (!faseValida) {
        const errorMsg = `Por favor, selecciona una opción válida en "${nombreSelectFase}" antes de calcular.`;
        console.error(errorMsg);
        const errorMsgElement = document.getElementById('errorMessage');
        if (errorMsgElement) {
            errorMsgElement.textContent = errorMsg;
            errorMsgElement.style.display = 'block';
        }
        return;
    }

    // Validate inputs
    if (isNaN(peso) || isNaN(altura) || isNaN(edad) || !sexo || isNaN(actividad) || !objetivo) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Por favor, completa todos los campos obligatorios en el Paso 1.';
            errorMessage.style.display = 'block';
        }
        return;
    }

    // Validate activity level
    const validActivityLevels = [1.2, 1.375, 1.55, 1.725, 1.9];
    if (!validActivityLevels.includes(actividad)) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Nivel de actividad no válido.';
            errorMessage.style.display = 'block';
        }
        console.error("Invalid activity level:", actividad);
        return;
    }

    // === 1. Calcular TMB (Mifflin-St Jeor) ===
    function calcularTMB(peso, altura, edad, sexo) {
        if (isNaN(peso) || isNaN(altura) || isNaN(edad) || !peso || !altura || !edad) return NaN;
        return sexo === 'Masculino'
            ? 10 * peso + 6.25 * altura - 5 * edad + 5
            : 10 * peso + 6.25 * altura - 5 * edad - 161;
    }

    // === 2. Mapa de códigos a nombres legibles ===
    const mapaCodigos1 = {
        'perdida1': 'pérdida de peso',
        'ganancia1': 'ganancia de peso',
        'mantenimiento1': 'mantenimiento',
        'mixto1': 'plan mixto',
        'sel': 'no seleccionado',
        'induccion_cetogenica1': 'inducción cetogénica',
        'ciclado_metabolico1': 'ciclado metabólico',
        'transicion_mantenimiento1': 'transición a mantenimiento',
        'volumen1': 'volumen muscular',
        'masa1': 'enfoque en masa muscular',
        'equilibrio1': 'equilibrio flexible',
        'social1': 'adherencia social'
    };

    // === 3. Reglas de ajuste calórico por objetivo y fase ===
    const reglasTDEE = {
        perdida1: { factor: 0.85, nota: 'Déficit moderado' },
        induccion_cetogenica1: { factor: 0.80, nota: 'Déficit mayor' },
        ciclado_metabolico1: { factor: 0.85, nota: 'Déficit moderado' },
        transicion_mantenimiento1: { factor: 0.95, nota: 'Déficit ligero' },
        ganancia1: { factor: 1.05, nota: 'Superávit controlado' },
        volumen1: { factor: 1.10, nota: 'Superávit alto' },
        masa1: { factor: 1.07, nota: 'Superávit moderado' },
        mantenimiento1: { factor: 1.00, nota: 'Equilibrio' },
        equilibrio1: { factor: 1.00, nota: 'Equilibrio' },
        social1: { factor: 1.00, nota: 'Flexibilidad' },
        mixto1: { factor: 1.02, nota: 'Base para ciclado' }
    };

    // === 4. Función para obtener la fase ===
    function getSelectedPhase(objetivo) {
        switch (objetivo) {
            case 'perdida1': return document.getElementById('fasePerdida1')?.value || 'sel1';
            case 'ganancia1': return document.getElementById('faseGanancia1')?.value || 'sel2';
            case 'mantenimiento1': return document.getElementById('enfoqueMantenimiento1')?.value || 'sel3';
            case 'mixto1': return document.getElementById('faseMixto1')?.value || 'sel4';
            default: return 'sel';
        }
    }

    const faseRaw = getSelectedPhase(objetivo);
    const fase = faseRaw.startsWith('sel') ? 'sel' : faseRaw;

    // === 5. Calcular TMB y TDEE ===
    const tmb = calcularTMB(peso, altura, edad, sexo);
    if (isNaN(tmb) || tmb <= 0) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Error al calcular el TMB.';
            errorMessage.style.display = 'block';
        }
        return;
    }
	
    const tdeeBase = tmb * actividad;
    const codigo = fase !== 'sel' ? fase : objetivo;
    const regla = reglasTDEE[codigo] || { factor: 1.0 };
    const gastoEnergetico = document.getElementById('goal-calories').value  //Math.round(tdeeBase * regla.factor);

    if (isNaN(gastoEnergetico) || gastoEnergetico <= 0) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Error al calcular el gasto energético.';
            errorMessage.style.display = 'block';
        }
        return;
    }

    // Guardar en ventana global
    window.tmb = Math.round(tmb);
    window.tdeeBase = Math.round(tdeeBase);
    window.gastoEnergetico = gastoEnergetico;
    window.faseNombre = mapaCodigos1[codigo] || 'Sin fase';
    window.ajusteNota = regla.nota;

    // === 6. Calcular macros: Manual o Automático ===
    let resultados;
	
    if (useManual) {
    const config = window.macrosConfiguracionManual?.[objetivo]?.[fase];
    if (config) {
        console.log("✅ Cálculo MANUAL activado");
        console.log("Objetivo:", objetivo, "Fase:", fase);
        console.log("Config:", config);

        const proteinasPct = parseFloat(config.proteinas);
        const carbohidratosPct = parseFloat(config.carbohidratos);
        if (isNaN(proteinasPct) || isNaN(carbohidratosPct)) {
            console.error("Valores inválidos en config manual:", config);
            resultados = calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase);
        } else {
            const grasasPct = Math.max(10, 100 - proteinasPct - carbohidratosPct);
            const proteinas = Math.round((gastoEnergetico * proteinasPct / 100) / 4);
            const carbohidratos = Math.round((gastoEnergetico * carbohidratosPct / 100) / 4);
            const grasas = Math.round((gastoEnergetico * grasasPct / 100) / 9);

            // Actualizar inputs
            document.getElementById('protein-percentage').value = proteinasPct;
            document.getElementById('carb-percentage').value = carbohidratosPct;
            document.getElementById('fat-percentage').value = grasasPct;

            resultados = {
                calorias: gastoEnergetico,
                proteinas,
                carbohidratos,
                grasas,
                proteinasPct,
                carbohidratosPct,
                grasasPct,
                recomendaciones: `<strong>🎯 Usando tu configuración manual para ${mapaCodigos1[fase] || mapaCodigos1[objetivo]}.</strong>`
            };
        }
    } else {
        console.log("⚠️ No hay configuración manual para este objetivo/fase. Usando automático.");
        resultados = calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase);
    }
} else {
    console.log("📊 Cálculo AUTOMÁTICO activado");
    resultados = calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase);
}

    // === 7. Generar plan semanal ===
    weeklyMacros = [];
    const periodo = document.getElementById('periodoPlanificacion').value;
    switch (objetivo) {
        case 'perdida1':
            weeklyMacros = generarPlanPerdida(periodo, peso, gastoEnergetico);
            break;
        case 'ganancia1':
            weeklyMacros = generarPlanGanancia(periodo, peso, gastoEnergetico);
            break;
        case 'mantenimiento1':
            weeklyMacros = generarPlanMantenimiento(periodo, peso, gastoEnergetico);
            break;
        case 'mixto1':
            weeklyMacros = generarPlanMixto(periodo, peso, gastoEnergetico);
            break;
        default:
            console.log("Objetivo no requiere plan semanal automático.");
            break;
    }
		
    // === 8. Actualizar UI ===
    actualizarUI(resultados, gastoEnergetico);

    // === 9. Guardar resultados globales ===
    window.macrosResult = resultados;
    window.weeklyMacros = weeklyMacros;
}


		////////////////////////////////////////////////////////////////////////////////
		
			function mostrarFasePorObjetivo(objetivo) {
				// Ocultar todos los selects y labels de fase
				const elementosFase = [
					'fasePerdida1', 'labelFasePerdida1',
					'faseGanancia1', 'labelFaseGanancia1',
					'enfoqueMantenimiento1', 'labelEnfoqueMantenimiento1',
					'faseMixto1', 'labelFaseMixto1'
				];
				
				elementosFase.forEach(id => {
					const elemento = document.getElementById(id);
					if (elemento) {
						elemento.style.display = 'none';
					}
				});

				// Mostrar el select correspondiente al objetivo
				
				switch(objetivo) {
					case 'perdida1':
						if (document.getElementById('fasePerdida1')) {
							document.getElementById('fasePerdida1').style.display = 'block';
							// Asegúrate de que el label también exista
							const label = document.getElementById('labelFasePerdida1');
							if (label) label.style.display = 'block';
						}
						break;
					case 'ganancia1':
						if (document.getElementById('faseGanancia1')) {
							document.getElementById('faseGanancia1').style.display = 'block';
							const label = document.getElementById('labelFaseGanancia1');
							if (label) label.style.display = 'block';
						}
						break;
					case 'mantenimiento1':
						if (document.getElementById('enfoqueMantenimiento1')) {
							document.getElementById('enfoqueMantenimiento1').style.display = 'block';
							const label = document.getElementById('labelEnfoqueMantenimiento1');
							if (label) label.style.display = 'block';
						}
						break;
					case 'mixto1':
						if (document.getElementById('faseMixto1')) {
							document.getElementById('faseMixto1').style.display = 'block';
							const label = document.getElementById('labelFaseMixto1');
							if (label) label.style.display = 'block';
						}
						break;
					case 'sel':
					default:
						// Opcional: Mostrar un mensaje indicando que deben seleccionar un objetivo
						// No es necesario hacer nada aquí ya que todos los selects están ocultos
						break;
				}
			}


				// Función para actualizar los porcentajes de macros según la fase seleccionada
				
				function actualizarMacrosPorFase() {
					const objetivoSelect = document.getElementById('objetivo');
					if (!objetivoSelect) return;
					
					const objetivo = objetivoSelect.value;
					let faseSeleccionada = '';
					
					// Corregido: usar los nuevos valores de objetivo
					if (objetivo === 'perdida1' && document.getElementById('fasePerdida1')) {
						faseSeleccionada = document.getElementById('fasePerdida1').value;
					} else if (objetivo === 'ganancia1' && document.getElementById('faseGanancia1')) {
						faseSeleccionada = document.getElementById('faseGanancia1').value;
					} else if (objetivo === 'mantenimiento1' && document.getElementById('enfoqueMantenimiento1')) {
						faseSeleccionada = document.getElementById('enfoqueMantenimiento1').value;
					} else if (objetivo === 'mixto1' && document.getElementById('faseMixto1')) {
						faseSeleccionada = document.getElementById('faseMixto1').value;
					}
					
					// Definir las distribuciones de macros para cada fase
					
				   const distribuciones = {
						// Pérdida de peso
						'induccion_cetogenica1': { protein: 20, carb: 10, fat: 70 },
						'ciclado_metabolico1': { protein: 25, carb: 20, fat: 55 },
						'transicion_mantenimiento1': { protein: 25, carb: 35, fat: 40 },
						
						// Ganancia de peso
						'volumen1': { protein: 20, carb: 55, fat: 25 },
						'masa1': { protein: 25, carb: 50, fat: 25 },
						
						// Mantenimiento
						'equilibrio1': { protein: 25, carb: 40, fat: 35 },
						'social1': { protein: 25, carb: 45, fat: 30 },
						
						// Mixto
						'volumen1_mixto': { protein: 25, carb: 50, fat: 25 },
						'definicion1': { protein: 30, carb: 25, fat: 45 },
						'mantenimiento1_mixto': { protein: 25, carb: 45, fat: 30 } // Cambiado para evitar conflicto
					};
					
					// Actualizar los valores en los inputs
					
					if (distribuciones[faseSeleccionada]) {
						if (document.getElementById('protein-percentage')) {
							document.getElementById('protein-percentage').value = distribuciones[faseSeleccionada].protein;
						}
						if (document.getElementById('carb-percentage')) {
							document.getElementById('carb-percentage').value = distribuciones[faseSeleccionada].carb;
						}
						if (document.getElementById('fat-percentage')) {
							document.getElementById('fat-percentage').value = distribuciones[faseSeleccionada].fat;
						}
						
						// Opcional: Actualizar el total de porcentajes
						const proteinValue = parseFloat(document.getElementById('protein-percentage').value) || 0;
						const carbValue = parseFloat(document.getElementById('carb-percentage').value) || 0;
						const fatValue = parseFloat(document.getElementById('fat-percentage').value) || 0;
						const total = proteinValue + carbValue + fatValue;
						
						const macroPercentageTotalDiv = document.getElementById('macro-percentage-total');
						if (macroPercentageTotalDiv) {
							macroPercentageTotalDiv.textContent = `Total: ${total}%`;
							macroPercentageTotalDiv.className = total === 100 ? 'total-valid' : 'total-invalid';
						}
					}
				}





		
		document.getElementById('objetivo').addEventListener('change', toggleOpcionesObjetivo);
			
	   document.addEventListener('DOMContentLoaded', () => {
			toggleOpcionesObjetivo();
			if (typeof Chart === 'undefined') {
				console.error('Chart.js no está disponible.');
				document.getElementById('errorMessage').textContent = 'No se pudo cargar Chart.js. Algunas funcionalidades estarán limitadas.';
				document.getElementById('errorMessage').style.display = 'block';
			}
			// Agregar event listeners a los selects de fase
			const selectsFase = ['fasePerdida1', 'faseGanancia1', 'enfoqueMantenimiento1', 'faseMixto1'];
			selectsFase.forEach(selectId => {
				const elemento = document.getElementById(selectId);
				if (elemento) {
					elemento.addEventListener('change', actualizarMacrosPorFase);
				}
		   });
			// Agregar event listener para el cambio de objetivo
			 // Agregar event listener para el cambio de objetivo
			const objetivoSelect = document.getElementById('objetivo');
			if (objetivoSelect) {
				objetivoSelect.addEventListener('change', function() {
					const objetivo = this.value;
					mostrarFasePorObjetivo(objetivo); // ← Descomentado y corregido
					// Aquí también puedes llamar a actualizarMacrosPorFase() si la tienes
				});
			}
		   
		});
// --- Variables Globales para Configuración Manual ---
// Almacena los valores de macros introducidos manualmente por el usuario.
// Formato: { estrategia1: { proteinas: X, carbohidratos: Y, grasas: Z }, estrategia2: {...} }
let macrosConfiguracionManual = {};

/**
 * Muestra el modal de incompatibilidad de estrategias.
 * @param {Array<string>} estrategias - Las estrategias seleccionadas.
 * @param {Object} rangosConflicto - (Opcional) Información detallada de los rangos que causan conflicto.
 */
	function mostrarModalIncompatibilidad(estrategias, rangosConflicto = null) {
		const modal = document.getElementById('modalIncompatibilidad');
		const mensajeElement = document.getElementById('mensajeIncompatibilidad');
		const guiaElement = document.getElementById('guiaCompatibilidad');

		if (!modal || !mensajeElement || !guiaElement) {
			console.error("No se encontraron los elementos del modal de incompatibilidad.");
			// Fallback: mostrar mensaje de error básico
			const errorMsgElement = document.getElementById('errorMessage');
			if (errorMsgElement) {
				errorMsgElement.textContent = 'Las estrategias seleccionadas son incompatibles. Por favor, selecciona una combinación válida.';
				errorMsgElement.style.display = 'block';
			}
			return;
		}

		// 1. Construir mensaje principal
		let mensaje = `<p>Las estrategias que has seleccionado (<strong>${estrategias.join(', ')}</strong>) tienen requerimientos nutricionales contradictorios y no se pueden combinar automáticamente para calcular un rango válido de macronutrientes.</p>`;
		
		// 2. (Opcional) Añadir detalles técnicos si se proporcionan
		if (rangosConflicto) {
			mensaje += `<p><strong>Detalles del conflicto:</strong></p><ul>`;
			for (const [macro, rango] of Object.entries(rangosConflicto)) {
				if (Array.isArray(rango) && rango[0] > rango[1]) {
					 mensaje += `<li><strong>${macro.charAt(0).toUpperCase() + macro.slice(1)}:</strong> Rango resultante inválido [${rango[0]}, ${rango[1]}].</li>`;
				}
			}
			mensaje += `</ul>`;
		}
		mensajeElement.innerHTML = mensaje;

		// 3. Construir guía de compatibilidad
		// Esta es una guía básica. Puedes ampliarla o hacerla más dinámica.
		let guiaHTML = `
			<p><strong>Para el objetivo de Pérdida de Peso:</strong></p>
			<ul>
				<li><code>ninguna</code> + <code>hiperproteica</code></li>
				<li><code>carb_cycling</code> (evitar combinar con <code>refeed</code>)</li>
				<li><code>refeed</code> (evitar combinar con <code>carb_cycling</code>)</li>
				<li><code>flexible_dieting</code> (mejor sin otras estrategias de extremos)</li>
			</ul>
			<p><strong>Para el objetivo de Ganancia de Peso:</strong></p>
			<ul>
				<li><code>ninguna</code> + <code>hiperproteica</code></li>
				<li><code>carb_cycling</code> (evitar combinar con <code>refeed</code>)</li>
				<li><code>refeed</code> (evitar combinar con <code>carb_cycling</code>)</li>
			</ul>
			<p><strong>Para el objetivo de Mantenimiento:</strong></p>
			<ul>
				<li><code>ninguna</code> + <code>flexibilidad_selectiva</code></li>
				<li><code>ciclado_ch_suave</code> (evitar combinar con <code>refeed</code>)</li>
				<li><code>refeed</code> (evitar combinar con <code>ciclado_ch_suave</code>)</li>
			</ul>
			<p><i>Nota: Las estrategias como <code>timing</code>, <code>if_16_8</code>, etc., suelen ser compatibles con varias otras.</i></p>
		`;
		guiaElement.innerHTML = guiaHTML;

		// 4. Mostrar el modal
		modal.style.display = 'flex'; // Usamos flex para centrarlo como en el CSS
	}

/**
 * Cierra un modal específico.
 * @param {string} modalId - El ID del modal a cerrar.
 */
function cerrarModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

/**
 * Abre el modal de configuración manual de macronutrientes.
 */
	function abrirModalConfiguracionManual() {
		// Primero, cerrar el modal de incompatibilidad
		cerrarModal('modalIncompatibilidad');

		const modal = document.getElementById('modalConfiguracionManual');
		const contenedor = document.getElementById('contenedorEntradasManuales');
		const errorElement = document.getElementById('errorConfiguracionManual');

		if (!modal || !contenedor) {
			console.error("No se encontraron los elementos del modal de configuración manual.");
			return;
		}

		// Limpiar mensajes de error anteriores
		if (errorElement) {
			errorElement.style.display = 'none';
			errorElement.textContent = '';
		}

		// Obtener estrategias seleccionadas
		// Asumimos que getSelectedStrategies() ya sabe cómo obtenerlas basándose en el objetivo actual
		const estrategias = getSelectedStrategies();
		const estrategiasActivas = estrategias.filter(s => s !== 'ninguna');

		if (estrategiasActivas.length === 0) {
			if (errorElement) {
				errorElement.textContent = 'No hay estrategias seleccionadas para configurar.';
				errorElement.style.display = 'block';
			}
			modal.style.display = 'flex';
			return;
		}

		// 1. Generar bloques de entrada para cada estrategia
		contenedor.innerHTML = ''; // Limpiar contenido previo
		estrategiasActivas.forEach(estrategia => {
			const bloqueId = `bloque_${estrategia}`;
			const inputProteinaId = `manual_proteina_${estrategia}`;
			const inputCarbohidratosId = `manual_carbohidratos_${estrategia}`;
			const inputGrasasId = `manual_grasas_${estrategia}`;

			// Intentar obtener valores guardados previamente o usar valores por defecto razonables
			const configGuardada = macrosConfiguracionManual[estrategia];
			const valorProteina = configGuardada?.proteinas ?? 25;
			const valorCarbohidratos = configGuardada?.carbohidratos ?? 40;
			const valorGrasas = configGuardada?.grasas ?? 35;
			const totalInicial = valorProteina + valorCarbohidratos + valorGrasas;

			const bloqueHTML = `
				<div class="bloque-estrategia-manual mb-3 p-3 border rounded" id="${bloqueId}" data-estrategia="${estrategia}">
					<h6>Estrategia: <span class="nombre-estrategia fw-bold">${estrategia}</span></h6>
					<div class="row">
						<div class="col-md-4 mb-2">
							<label for="${inputProteinaId}" class="form-label">Proteína (%)</label>
							<input type="number" class="form-control input-macro-manual" id="${inputProteinaId}" name="${inputProteinaId}" 
								   data-estrategia="${estrategia}" data-macro="proteinas" 
								   min="0" max="100" value="${valorProteina}" required>
						</div>
						<div class="col-md-4 mb-2">
							<label for="${inputCarbohidratosId}" class="form-label">Carbohidratos (%)</label>
							<input type="number" class="form-control input-macro-manual" id="${inputCarbohidratosId}" name="${inputCarbohidratosId}" 
								   data-estrategia="${estrategia}" data-macro="carbohidratos" 
								   min="0" max="100" value="${valorCarbohidratos}" required>
						</div>
						<div class="col-md-4 mb-2">
							<label for="${inputGrasasId}" class="form-label">Grasas (%)</label>
							<input type="number" class="form-control input-macro-manual" id="${inputGrasasId}" name="${inputGrasasId}" 
								   data-estrategia="${estrategia}" data-macro="grasas" 
								   min="0" max="100" value="${valorGrasas}" required>
						</div>
					</div>
					<div class="total-macro-manual mt-2">
						<strong>Total: <span class="valor-total">${totalInicial}</span>%</strong>
						<span class="estado-total text-success" style="${totalInicial === 100 ? 'display:inline;' : 'display:none;'}">✓ Correcto</span>
						<span class="estado-total text-danger" style="${totalInicial !== 100 ? 'display:inline;' : 'display:none;'}">✗ Debe ser 100%</span>
					</div>
				</div>
			`;
			contenedor.insertAdjacentHTML('beforeend', bloqueHTML);
		});

		// 2. Añadir event listeners a los inputs recién creados para validación en tiempo real
		document.querySelectorAll('.input-macro-manual').forEach(input => {
			input.addEventListener('input', function() {
				// Encontrar el bloque padre de esta estrategia
				const bloque = this.closest('.bloque-estrategia-manual');
				if (!bloque) return;

				const estrategia = bloque.dataset.estrategia;
				const inputs = bloque.querySelectorAll('.input-macro-manual');
				let total = 0;
				inputs.forEach(inp => {
					const val = parseInt(inp.value) || 0; // Convertir a número, 0 si NaN
					// Asegurar que esté dentro del rango 0-100
					if (val < 0) inp.value = 0;
					if (val > 100) inp.value = 100;
					total += parseInt(inp.value) || 0;
				});

				const totalElement = bloque.querySelector('.valor-total');
				const estadoCorrecto = bloque.querySelector('.estado-total.text-success');
				const estadoError = bloque.querySelector('.estado-total.text-danger');

				if (totalElement) totalElement.textContent = total;
				if (estadoCorrecto) estadoCorrecto.style.display = total === 100 ? 'inline' : 'none';
				if (estadoError) estadoError.style.display = total !== 100 ? 'inline' : 'none';
			});
		});

		// 3. Mostrar el modal
		modal.style.display = 'flex';
	}

	/**
	 * Valida y aplica la configuración manual de macronutrientes.
	 * Almacena los valores en `macrosConfiguracionManual` y cierra el modal.
	 */
	function aplicarConfiguracionManual() {
		const contenedor = document.getElementById('contenedorEntradasManuales');
		const errorElement = document.getElementById('errorConfiguracionManual');
		const modal = document.getElementById('modalConfiguracionManual');

		if (!contenedor || !errorElement || !modal) {
			console.error("No se encontraron elementos necesarios para aplicar la configuración manual.");
			return;
		}

		// Limpiar mensajes de error
		errorElement.style.display = 'none';
		errorElement.textContent = '';

		// Obtener todos los bloques
		const bloques = contenedor.querySelectorAll('.bloque-estrategia-manual');
		const nuevaConfiguracion = {};

		let todoValido = true;

		bloques.forEach(bloque => {
			const estrategia = bloque.dataset.estrategia;
			const inputProteina = bloque.querySelector(`#manual_proteina_${estrategia}`);
			const inputCarbohidratos = bloque.querySelector(`#manual_carbohidratos_${estrategia}`);
			const inputGrasas = bloque.querySelector(`#manual_grasas_${estrategia}`);

			const p = parseInt(inputProteina.value) || 0;
			const c = parseInt(inputCarbohidratos.value) || 0;
			const g = parseInt(inputGrasas.value) || 0;
			const total = p + c + g;

			if (total !== 100) {
				todoValido = false;
				// Resaltar el bloque con error
				bloque.style.borderColor = '#dc3545'; // Rojo de Bootstrap
				bloque.style.backgroundColor = '#f8d7da'; // Fondo rojo claro
				// Asegurarse de que el mensaje de error del bloque sea visible
				const estadoError = bloque.querySelector('.estado-total.text-danger');
				if (estadoError) estadoError.style.display = 'inline';
			} else {
				// Restaurar estilo si es válido
				bloque.style.borderColor = '';
				bloque.style.backgroundColor = '';
				nuevaConfiguracion[estrategia] = {
					proteinas: p,
					carbohidratos: c,
					grasas: g
				};
			}
		});

		if (!todoValido) {
			errorElement.textContent = 'Por favor, corrige los errores. La suma de macros para cada estrategia debe ser 100%.';
			errorElement.style.display = 'block';
			return;
		}

		// Si todo es válido, almacenar la configuración
		macrosConfiguracionManual = nuevaConfiguracion;
		console.log("Configuración manual aplicada:", macrosConfiguracionManual);

		// Cerrar el modal
		modal.style.display = 'none';

		// Opcional: Mostrar un mensaje de confirmación o disparar el cálculo
		// Por ejemplo, podrías llamar a calcularMacros() aquí si quieres que se recalcule inmediatamente
		// calcularMacros(); 
		// O simplemente mostrar un mensaje
		const confirmMsg = document.getElementById('errorMessage'); // Reusamos el div de error para mensajes
		if (confirmMsg) {
			confirmMsg.textContent = 'Configuración manual de macronutrientes guardada. Puedes ahora calcular tus macros.';
			confirmMsg.className = 'alert alert-success'; // Cambiar clase para que parezca éxito
			confirmMsg.style.display = 'block';
			// Opcional: ocultar el mensaje después de unos segundos
			// setTimeout(() => { confirmMsg.style.display = 'none'; }, 5000);
		}
	}

	// /////////modal macros/////////////////////////////////


const mapaCodigos2= {
						// Objetivos
						'perdida1': 'pérdida de peso',
						'ganancia1': 'ganancia de peso',
						'mantenimiento1': 'mantenimiento',
						'mixto1': 'plan mixto',
						'sel': 'no seleccionado',
						// Fases de Pérdida
						'induccion_cetogenica1': 'inducción cetogénica',
						'ciclado_metabolico1': 'ciclado metabólico',
						'transicion_mantenimiento1': 'transición a mantenimiento',
						'ketoadaptation': 'ketoadaptación',
						// Fases de Ganancia
						'volumen1': 'volumen muscular',
						'masa1': 'enfoque en masa muscular',
						// Fases de Mantenimiento
						'equilibrio1': 'equilibrio flexible',
						'social1': 'adherencia social'
					};
					
					
			function getSelectedPhase2(objetivo) {
				switch (objetivo) {
					case 'perdida1':
						return document.getElementById('fasePerdida1')?.value || 'sel1';
					case 'ganancia1':
						return document.getElementById('faseGanancia1')?.value || 'sel2';
					case 'mantenimiento1':
						return document.getElementById('enfoqueMantenimiento1')?.value || 'sel3';
					case 'mixto1':
						return document.getElementById('faseMixto1')?.value || 'sel4';
					default:
						return 'sel';
				}
			}


		//////MODAL PASO 4 CALCULAR MACRONUTRIENTES ///////////////
		function abrirModalMacros() {
    const objetivo = document.getElementById('objetivo').value;
    const fase = getSelectedPhase2(objetivo);
    const faseLimpia = fase && fase.startsWith('sel') ? 'sel' : fase;

    const modal = new bootstrap.Modal(document.getElementById('modalMacros'));
    const modalWarning = document.getElementById('modal-warning');
    const modalContent = document.getElementById('modal-content');

    // Validar objetivo y fase
    if (objetivo === 'sel' || faseLimpia === 'sel') {
        modalWarning.style.display = 'block';
        modalContent.style.display = 'none';
        document.getElementById('modal-objetivo').textContent = 'No seleccionado';
        document.getElementById('modal-fase').textContent = 'No seleccionada';
        modal.show();
        return; // Salir temprano si no es válido
    }

    modalWarning.style.display = 'none';
    modalContent.style.display = 'block';
	const boton = document.getElementById('botonCalcular');
    if (boton) {
        boton.style.display = 'block';
    }
	
	
    // Mostrar objetivo y fase
    document.getElementById('modal-objetivo').textContent = mapaCodigos2[objetivo] || objetivo;
    document.getElementById('modal-fase').textContent = mapaCodigos2[faseLimpia] || faseLimpia;

    // === 1. Obtener valores de los inputs (si existen) ===
    let inputProteina = parseInt(document.getElementById('protein-percentage').value) || 30; // let en lugar de const
    let inputCarbo = parseInt(document.getElementById('carb-percentage').value) || 40;     // let en lugar de const
    let inputGrasa = parseInt(document.getElementById('fat-percentage').value) || 30;       // let en lugar de const

    // Validar que sumen 100%
    const total = inputProteina + inputCarbo + inputGrasa;
    if (Math.abs(total - 100) > 0.1) {
        console.warn("Los porcentajes no suman 100%. Ajustando grasas.");
        const diff = 100 - inputProteina - inputCarbo;
        const ajusteGrasa = Math.max(10, Math.min(80, diff)); // rango razonable
        document.getElementById('fat-percentage').value = ajusteGrasa;
        // Actualizamos inputGrasa para usarlo (ahora es let, por eso se puede reasignar)
        inputGrasa = ajusteGrasa;
    }

    // === 2. Mostrar rangos recomendados (igual que antes) ===
    const rangos = {
        // Pérdida
        perdida1: { p: [20, 30], c: [10, 25], g: [50, 70] },
        induccion_cetogenica1: { p: [20, 25], c: [5, 10], g: [70, 75] },
        ciclado_metabolico1: { p: [22, 28], c: [8, 20], g: [60, 70] },
        transicion_mantenimiento1: { p: [25, 30], c: [20, 25], g: [40, 50] },
        // Ganancia
        ganancia1: { p: [25, 30], c: [40, 50], g: [25, 35] },
        volumen1: { p: [25, 30], c: [40, 50], g: [25, 35] },
        masa1: { p: [25, 30], c: [35, 45], g: [30, 35] },
        // Mantenimiento
        mantenimiento1: { p: [20, 25], c: [35, 45], g: [30, 35] },
        equilibrio1: { p: [20, 25], c: [35, 45], g: [30, 35] },
        social1: { p: [20, 25], c: [30, 50], g: [25, 40] },
        // Mixto
        mixto1: { p: [20, 25], c: [30, 40], g: [35, 50] },
        definicion1: { p: [25, 35], c: [10, 25], g: [40, 55] }
    };

    const codigo = rangos[faseLimpia] ? faseLimpia : objetivo;
    const r = rangos[codigo] || { p: [25, 35], c: [30, 50], g: [25, 40] };

    // Mostrar rangos recomendados
    document.getElementById('proteinasRango').textContent = `${r.p[0]}-${r.p[1]}%`;
    document.getElementById('carbohidratosRango').textContent = `${r.c[0]}-${r.c[1]}%`;
    document.getElementById('grasasRango').textContent = `${r.g[0]}-${r.g[1]}%`;

    // === 3. Establecer valores iniciales desde los inputs ===
    document.getElementById('proteinasRange').value = inputProteina;
    document.getElementById('carbohidratosRange').value = inputCarbo;
    document.getElementById('grasasRange').value = inputGrasa;

    document.getElementById('proteinasValue').textContent = inputProteina;
    document.getElementById('carbohidratosValue').textContent = inputCarbo;
    document.getElementById('grasasValue').textContent = inputGrasa;

    // === 4. Consejo por objetivo ===
    const consejos = {
        perdida1: 'Prioriza proteína para preservar músculo.',
        ganancia1: 'Carbohidratos altos en días de entreno mejoran la hipertrofia.',
        mantenimiento1: 'Equilibrio flexible mejora la adherencia a largo plazo.',
        mixto1: 'Alterna días de HC alto y bajo para mantener metabolismo activo.'
    };
    document.getElementById('modal-consejo').textContent = consejos[objetivo] || 'Ajusta los macros según tu objetivo.';

    // === 5. Sincronizar sliders con inputs y total ===
    function actualizarSliders() {
        const p = +document.getElementById('proteinasRange').value;
        const c = +document.getElementById('carbohidratosRange').value;
        let g = 100 - p - c;

        if (g < 10) {
            g = 10;
            const diff = 10 - g;
            const restante = 100 - p - 10;
            if (c > restante) {
                document.getElementById('carbohidratosRange').value = restante;
                document.getElementById('carbohidratosValue').textContent = restante;
            }
        }

        document.getElementById('grasasRange').value = g;
        document.getElementById('proteinasValue').textContent = p;
        document.getElementById('carbohidratosValue').textContent = c;
        document.getElementById('grasasValue').textContent = g;

        // Actualizar input ocultos (opcional)
        document.getElementById('protein-percentage').value = p;
        document.getElementById('carb-percentage').value = c;
        document.getElementById('fat-percentage').value = g;

        // Actualizar total visual
        document.getElementById('macro-percentage-total').textContent = `Total: ${p + c + g}%`;
        if (p + c + g !== 100) {
            document.getElementById('macro-percentage-total').style.color = 'red';
        } else {
            document.getElementById('macro-percentage-total').style.color = 'green';
        }
    } // <--- CIERRA LA LLAVE DE actualizarSliders

    // Asignar eventos (ahora está claramente fuera de actualizarSliders)
    ['proteinas', 'carbohidratos', 'grasas'].forEach(nut => {
        document.getElementById(`${nut}Range`).oninput = actualizarSliders;
    });

    // Llamar una vez para inicializar
    actualizarSliders();

    modal.show();
} // <--- CIERRA LA LLAVE DE abrirModalMacros

	
	
				//////Guardar y llamar a calcularMacros()/////////////////
				document.getElementById('guardarMacros').addEventListener('click', function () {
				const objetivo = document.getElementById('objetivo').value;
				const fase = getSelectedPhase2(objetivo);
				const faseLimpia = fase && fase.startsWith('sel') ? 'sel' : fase;

				if (objetivo === 'sel' || faseLimpia === 'sel') {
					alert('Por favor, selecciona primero un objetivo y una fase.');
					return;
				}
				
				const proteinas = parseInt(document.getElementById('proteinasRange').value);
				const carbohidratos = parseInt(document.getElementById('carbohidratosRange').value);
				const grasas = parseInt(document.getElementById('grasasRange').value);

				// ✅ Actualizar inputs
				document.getElementById('protein-percentage').value = proteinas;
				document.getElementById('carb-percentage').value = carbohidratos;
				document.getElementById('fat-percentage').value = grasas;

				// ✅ Guardar en objeto global
				if (!window.macrosConfiguracionManual[objetivo]) {
					window.macrosConfiguracionManual[objetivo] = {};
				}
				window.macrosConfiguracionManual[objetivo][faseLimpia] = { proteinas, carbohidratos, grasas };

				// Cerrar modal
				bootstrap.Modal.getInstance(document.getElementById('modalMacros')).hide();

				// Llamar a calcularMacros con modo manual
				calcularMacros(true);
				// Mostrar el botón después de cerrar el modal
				const boton = document.getElementById('calcularPlanificacionBtn');
				if (boton) {
					boton.style.display = 'block';
					boton.style.opacity = '0';
					setTimeout(() => {
						boton.style.transition = 'opacity 0.4s ease';
						boton.style.opacity = '1';
					},50);
				}
				
			});
			  
       // === VARIABLES GLOBALES ===


// === FUNCIONES DE MODAL ===

// Función para poblar los inputs del modal
function poblarModal() {
    try {
        // Poblar campos del modal con valores del formulario principal
        document.getElementById('weightGoalModal').value = document.getElementById('weight-change-goal').value;
        document.getElementById('weeklyCalorieDiffModal').value = document.getElementById('weekly-calorie-diff').value;
        document.getElementById('currentWeightModal').value = document.getElementById('weight').value;
        
        document.getElementById('userGenderModal').value = document.getElementById('gender').value;
        document.getElementById('userAgeModal').value = document.getElementById('age').value;
        document.getElementById('currentFatPercModal').value = document.getElementById('current-fat-percentage').value;
        
		  // Sincronizar checkbox - del select 'yes'/'no' al checkbox
			const isAthleteSelect = document.getElementById('is-athlete');
			if (isAthleteSelect) {
				document.getElementById('isAthleteModal').checked = (isAthleteSelect.value === 'yes');
			}

				// Sincronizar selects - de un select a otro
				const activitySelect = document.getElementById('activity');
				if (activitySelect) {
					document.getElementById('activityLevelModal').value = activitySelect.value;
				}
        
        return true;
    } catch (error) {
        console.error('Error al poblar el modal:', error);
        return false;
    }
}

// Función para abrir el modal programáticamente
function abrirModalConfiguracion() {
    // Primero: poblar los campos del modal
    if (poblarModal()) {
        // Segundo: abrir el modal
        const modalElement = document.getElementById('modalCalculadoraNoLineal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
			aplicarEstilosModal();
		
        }
    } else {
        alert('Error al cargar la configuración en el modal.');
    }
	
}

	// Función para guardar y calcular (desde el modal)
	function guardarYCalcularModal() {
	 if (event) event.preventDefault(); // ← Esto evita el submit
			try {
				// Obtener valores del formulario modal
				const weightChangeGoal = parseFloat(document.getElementById('weightGoalModal').value);
				const weeklyCalorieDiff = parseFloat(document.getElementById('weeklyCalorieDiffModal').value);
				const currentWeightKg = parseFloat(document.getElementById('currentWeightModal').value);

				const userData = {
					userGender: document.getElementById('userGenderModal').value,
					userAge: parseInt(document.getElementById('userAgeModal').value),
					currentFatPerc: parseFloat(document.getElementById('currentFatPercModal').value),
					isAthlete: document.getElementById('isAthleteModal').checked,
					activityLevel: document.getElementById('activityLevelModal').value
				};

				// Validaciones básicas
				if ([weightChangeGoal, weeklyCalorieDiff, currentWeightKg].some(isNaN)) {
					alert('Por favor, complete todos los campos numéricos correctamente.');
					return;
				}

				if (userData.currentFatPerc < 5 || userData.currentFatPerc > 60) {
					alert('El porcentaje de grasa corporal debe estar entre 5% y 60%.');
					return;
				}

				// Calcular
				const resultado = calcularTiempoNoLineal(weightChangeGoal, weeklyCalorieDiff, currentWeightKg, userData);

				// Guardar datos globalmente
				/**
				 * Almacena el resultado completo del cálculo no lineal para reutilizarlo en otras funciones.
				 * Contiene:
				 *   - semanas: array con el detalle semanal { numero, pesoAcumulado, tasa, tdee }
				 *   - totalSemanas: número total de semanas hasta alcanzar la meta
				 *   - metaAlcanzada: booleano que indica si se alcanzó la meta de peso
				 *   - tasaInicial: tasa de cambio de peso inicial (kg/semana)
				 *   - finalTDEE: valor final del gasto energético total ajustado por adaptación metabólica
				 *   - esPerdida: indica si el objetivo fue pérdida (true) o ganancia (false) de peso
				 *   - metaAbs: cantidad absoluta de peso a cambiar (kg)
				 *   - tdeeInicial: gasto energético inicial antes de adaptaciones
				 *
				 * Ejemplo de uso:
				 *   window.resultadoTiempoNoLineal.semanas[0].pesoAcumulado → peso en la semana 1
				 *   window.resultadoTiempoNoLineal.totalSemanas → duración total del plan
				 *   window.resultadoTiempoNoLineal.finalTDEE → TDEE al final del proceso
				 */
				window.resultadoTiempoNoLineal = resultado;

				// Mostrar resumen (si aplica)
				//document.getElementById('resumen-plan-modal').style.display = 'block';
				document.getElementById('resumen-plan-modal').textContent = 
					`Meta: ${Math.abs(weightChangeGoal)} kg en ${resultado.totalSemanas} semanas`;
				document.getElementById('resumen-velocidad-modal').textContent = 
					`Tasa inicial: ${resultado.tasaInicial.toFixed(3)} kg/semana`;

				// Llenar la tabla en el nuevo modal
				if (typeof crearTablaProgresoModal === 'function') {
					crearTablaProgresoModal(resultado);
				} else {
					console.warn('Función crearTablaProgresoModal no encontrada');
				}

				// ✅ Mostrar mensaje de éxito
				alert('✅ Cálculo completado correctamente');

				// ✅ Abrir el nuevo modal con la tabla
				const modalTabla = new bootstrap.Modal(document.getElementById('modalTablaProgreso'));
				modalTabla.show();

			} catch (error) {
				console.error('Error en guardarYCalcularModal:', error);
				alert('Error al realizar el cálculo. Por favor, verifique los datos.');
			}
		}
	


function exportarTablaProgreso() {
    if (!window.resultadoTiempoNoLineal) {
        alert('No hay datos para exportar.');
        return;
    }

    const { semanas } = window.resultadoTiempoNoLineal;
    let csv = 'Semana,Peso Acumulado (kg),Tasa (kg),TDEE (kcal)\n';
    
    semanas.forEach(s => {
        csv += `${s.numero},${s.pesoAcumulado},${s.tasa},${s.tdee}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'progreso_semanal.csv';
    a.click();
    URL.revokeObjectURL(url);
}

// === CÁLCULO NO LINEAL (realista) - MEPNL v2.1 ===
function calcularTiempoNoLineal(weightChangeGoal, weeklyCalorieDiff, currentWeightKg, userData) {
    const { userGender, userAge, currentFatPerc, isAthlete, activityLevel } = userData;
    const esHombre = userGender === 'male';
    const esPerdida = weightChangeGoal < 0;
    const metaAbs = Math.abs(weightChangeGoal);
    const kcalPerKg = 7700;

    // --- 1. Estimar TDEE y NEAT (simplificado) ---
    const AF_FACTORS = {
        'sedentario': 1.2,
        'leve': 1.4,
        'moderate': 1.6,
        'active': 1.75,
        'very-active': 1.9
    };
    const afFactor = AF_FACTORS[activityLevel] || 1.4;

    // BMR (Mifflin-St Jeor - asumiendo altura promedio si no está disponible)
    const alturaEstimada = esHombre ? 175 : 162; // cm
    const bmr = esHombre 
        ? (10 * currentWeightKg) + (6.25 * alturaEstimada) - (5 * userAge) + 5
        : (10 * currentWeightKg) + (6.25 * alturaEstimada) - (5 * userAge) - 161;

    const neatExtra = isAthlete ? 500 : (afFactor >= 1.6 ? 300 : 150);
    const tdee = bmr * afFactor + neatExtra;

    // --- 2. Ajustes personalizados ---
    const esDeportista = isAthlete;
    const porcentajeGrasa = currentFatPerc;

    // Factor de adherencia
    const adherencia = 0.8;

    // Factor de corrección por tipo de tejido (simplificado)
    const goalTypeGlobal = 'ganancia1'; // Valor por defecto
    const fc = esPerdida 
        ? 1.0 
        : (goalTypeGlobal === 'ganancia1' ? 1.25 : 0.85);

    // Caloría efectiva semanal (ajustada por adherencia)
    const weeklyCalorieDiffEffective = adherencia * weeklyCalorieDiff;

    // Tasa inicial (kg/semana)
    const r0 = Math.abs(weeklyCalorieDiffEffective) / (kcalPerKg * fc);

    // --- 3. Parámetros personalizados por usuario ---
    let k, alpha, beta;

    if (esPerdida) {
        // Pérdida: adaptación metabólica
        alpha = Math.max(0.5, 0.4 * (1 - 0.01 * porcentajeGrasa));
        k = 0.02; // Ralentización más lenta
    } else {
        // Ganancia: progresión decreciente
        beta = Math.max(0.3, 0.4 * (1 - 0.004 * userAge + (esDeportista ? 0.1 : 0)));
        k = 0.06 * (1 + (false ? 0.4 : 0) - (esDeportista ? 0.2 : 0)); // isAdvanced hardcodeado a false
    }

    // --- 4. Simular semana a semana ---
    const semanas = [];
    let pesoAcumulado = 0;
    let semana = 0;
    let currentTDEE = tdee;

    while (pesoAcumulado < metaAbs && semana < 100) {
        semana++;

        // Ajuste del TDEE por pérdida de peso (adaptación metabólica)
        if (esPerdida && semana > 4) {
            const pesoPerdidoHastaAhora = (pesoAcumulado / metaAbs) * Math.abs(weightChangeGoal);
			const edad=  +document.getElementById('userAgeModal').value
            // Factor de adaptación más agresivo para personas mayores
			const factorAdaptacion = 0.25 + (edad > 50 ? 0.1 : 0); // 0.35 para 55 años
			currentTDEE = tdee * (1 - factorAdaptacion * (pesoPerdidoHastaAhora / currentWeightKg));
        }

        // Tasa semanal con decaimiento
        let factorProgresion;
        if (esPerdida) {
            factorProgresion = Math.max(alpha, 1 - k * (semana - 1));
        } else {
            factorProgresion = Math.max(beta || 0.4, 1 - k * (semana - 1));
        }

        let tasaSemanal = r0 * factorProgresion;

        // Ajuste adicional para deportistas en ganancia
        if (!esPerdida && esDeportista) {
            tasaSemanal *= 1.15;
        }

        pesoAcumulado += tasaSemanal;
        semanas.push({
            numero: semana,
            pesoAcumulado: parseFloat(pesoAcumulado.toFixed(2)),
            tasa: parseFloat(tasaSemanal.toFixed(2)),
            tdee: parseFloat(currentTDEE.toFixed(0))
        });
    }

    return {
        semanas,
        totalSemanas: semana,
        metaAlcanzada: pesoAcumulado >= metaAbs,
        tasaInicial: r0,
        finalTDEE: currentTDEE,
        esPerdida: esPerdida,
        metaAbs: metaAbs,
        tdeeInicial: tdee
    };
}

// === FUNCIONES DE VISUALIZACIÓN ===
// Función para calcular la velocidad a la mitad del proceso
function calcularVelocidadMitad(resultado) {
    if (!resultado.semanas || resultado.semanas.length === 0) return 0;
    
    // Buscar la semana donde se alcanza la mitad del peso objetivo
    const metaMitad = resultado.metaAbs / 2;
    let semanaMitad = 0;
    
    for (let i = 0; i < resultado.semanas.length; i++) {
        if (resultado.semanas[i].pesoAcumulado >= metaMitad) {
            semanaMitad = i;
            break;
        }
    }
    
    // Si no se encuentra, usar la semana del medio
    if (semanaMitad === 0) {
        semanaMitad = Math.floor(resultado.semanas.length / 2);
    }
    
    return resultado.semanas[semanaMitad].tasa;
}

// Función para calcular la reducción porcentual
function calcularReduccionVelocidad(resultado) {
    if (!resultado.semanas || resultado.semanas.length === 0 || resultado.tasaInicial === 0) return 0;
    
    const velocidadFinal = resultado.semanas[resultado.semanas.length-1].tasa;
    return ((resultado.tasaInicial - velocidadFinal) / resultado.tasaInicial * 100);
}

// Función para calcular la velocidad promedio
function calcularVelocidadPromedio(resultado) {
    if (!resultado.semanas || resultado.semanas.length === 0) return 0;
    
    const suma = resultado.semanas.reduce((total, semana) => total + semana.tasa, 0);
    return suma / resultado.semanas.length;
}

// Función para encontrar la semana donde se alcanza el 50%
	function encontrarSemana50PorCiento(resultado) {
		if (!resultado.semanas || resultado.semanas.length === 0) return null;
		
		const meta50PorCiento = resultado.metaAbs * 0.5;
		
		for (let i = 0; i < resultado.semanas.length; i++) {
			if (resultado.semanas[i].pesoAcumulado >= meta50PorCiento) {
				return {
					semana: i + 1, // +1 porque los arrays empiezan en 0
					pesoAcumulado: resultado.semanas[i].pesoAcumulado,
					tasa: resultado.semanas[i].tasa
				};
			}
		}
		
		// Si no se alcanza el 50% (no debería pasar normalmente)
		return {
			semana: resultado.semanas.length,
			pesoAcumulado: resultado.semanas[resultado.semanas.length-1].pesoAcumulado,
			tasa: resultado.semanas[resultado.semanas.length-1].tasa
		};
	}

// === FUNCIONES DE ANÁLISIS AVANZADO ===

/**
 * Encuentra el punto de inflexión donde la tasa de cambio deja de disminuir significativamente
 * @param {Object} resultado - Resultado del cálculo no lineal
 * @param {number} umbralDerivada - Umbral para considerar que la tasa se ha estabilizado (por defecto 0.001)
 * @returns {Object|null} Información sobre el punto de inflexión o null si no se encuentra
 */
function encontrarPuntoInflexion(resultado, umbralDerivada = 0.001) {
    if (!resultado.semanas || resultado.semanas.length < 3) return null;
    
    const semanas = resultado.semanas;
    
    // Calcular las derivadas segundas (curvatura) para encontrar puntos de inflexión
    for (let i = 1; i < semanas.length - 1; i++) {
        const tasaAnterior = semanas[i - 1].tasa;
        const tasaActual = semanas[i].tasa;
        const tasaSiguiente = semanas[i + 1].tasa;
        
        // Primera derivada (cambio en la tasa)
        const derivada1Anterior = tasaActual - tasaAnterior;
        const derivada1Siguiente = tasaSiguiente - tasaActual;
        
        // Segunda derivada (cambio en la pendiente)
        const derivada2 = derivada1Siguiente - derivada1Anterior;
        
        // Si la segunda derivada cambia de signo o se aproxima a cero,
        // estamos cerca de un punto de inflexión
        if (Math.abs(derivada2) < umbralDerivada) {
            return {
                semana: semanas[i].numero,
                tasa: semanas[i].tasa,
                tasaAnterior: tasaAnterior,
                tasaSiguiente: tasaSiguiente,
                derivadaSegunda: derivada2,
                pesoAcumulado: semanas[i].pesoAcumulado,
                porcentajeMeta: ((semanas[i].pesoAcumulado / resultado.metaAbs) * 100).toFixed(1)
            };
        }
    }
    
    return null;
}

/**
 * Encuentra el punto de estabilización donde la tasa de cambio se vuelve casi constante
 * @param {Object} resultado - Resultado del cálculo no lineal
 * @param {number} ventana - Ventana de semanas para calcular promedio móvil
 * @param {number} umbralVariacion - Umbral de variación para considerar estabilidad
 * @returns {Object|null} Información sobre el punto de estabilización
 */
function encontrarPuntoEstabilizacion(resultado, ventana = 5, umbralVariacion = 0.005) {
    if (!resultado.semanas || resultado.semanas.length < ventana * 2) return null;
    
    const semanas = resultado.semanas;
    
    // Buscar donde la variación en una ventana se vuelve mínima
    for (let i = ventana; i < semanas.length - ventana; i++) {
        // Calcular tasas en la ventana
        const tasasVentana = [];
        for (let j = i - Math.floor(ventana/2); j <= i + Math.floor(ventana/2); j++) {
            if (j >= 0 && j < semanas.length) {
                tasasVentana.push(semanas[j].tasa);
            }
        }
        
        if (tasasVentana.length === 0) continue;
        
        // Calcular promedio y desviación estándar
        const promedio = tasasVentana.reduce((sum, tasa) => sum + tasa, 0) / tasasVentana.length;
        const varianza = tasasVentana.reduce((sum, tasa) => sum + Math.pow(tasa - promedio, 2), 0) / tasasVentana.length;
        const desviacion = Math.sqrt(varianza);
        
        // Si la desviación es menor que el umbral, hemos encontrado estabilidad
        if (desviacion < umbralVariacion) {
            return {
                semana: semanas[i].numero,
                tasa: semanas[i].tasa,
                promedioVentana: promedio,
                desviacion: desviacion,
                pesoAcumulado: semanas[i].pesoAcumulado,
                porcentajeMeta: ((semanas[i].pesoAcumulado / resultado.metaAbs) * 100).toFixed(1)
            };
        }
    }
    
    return null;
}

/**
 * Encuentra el punto donde la tasa de cambio se reduce a un porcentaje específico de la inicial
 * @param {Object} resultado - Resultado del cálculo no lineal
 * @param {number} porcentajeReduccion - Porcentaje de la tasa inicial (ej: 50 para 50%)
 * @returns {Object|null} Información sobre el punto de reducción
 */
function encontrarPuntoReduccionTasa(resultado, porcentajeReduccion = 50) {
    if (!resultado.semanas || resultado.semanas.length === 0 || resultado.tasaInicial === 0) return null;
    
    const tasaObjetivo = resultado.tasaInicial * (porcentajeReduccion / 100);
    
    for (let i = 0; i < resultado.semanas.length; i++) {
        if (resultado.semanas[i].tasa <= tasaObjetivo) {
            return {
                semana: resultado.semanas[i].numero,
                tasa: resultado.semanas[i].tasa,
                tasaInicial: resultado.tasaInicial,
                porcentajeReduccion: porcentajeReduccion,
                pesoAcumulado: resultado.semanas[i].pesoAcumulado,
                porcentajeMeta: ((resultado.semanas[i].pesoAcumulado / resultado.metaAbs) * 100).toFixed(1)
            };
        }
    }
    
    return null;
}

/**
 * Análisis completo de puntos críticos en la curva
 * @param {Object} resultado - Resultado del cálculo no lineal
 * @returns {Object} Objeto con todos los puntos críticos encontrados
 */
function analizarPuntosCriticos(resultado) {
    return {
        puntoInflexion: encontrarPuntoInflexion(resultado),
        puntoEstabilizacion: encontrarPuntoEstabilizacion(resultado),
        puntoMitadTasa: encontrarPuntoReduccionTasa(resultado, 50),
        puntoCuartoTasa: encontrarPuntoReduccionTasa(resultado, 25),
        puntoOctavoTasa: encontrarPuntoReduccionTasa(resultado, 12.5)
    };
}

// === FUNCIONES DE VISUALIZACIÓN MEJORADAS ===

/**
 * Función para mostrar información de puntos críticos en el resumen del modal
 * @param {Object} resultado - Resultado del cálculo no lineal
 */
function mostrarPuntosCriticos(resultado) {
    const puntos = analizarPuntosCriticos(resultado);
    const contenedor = document.getElementById('resumen-puntos-criticos');
    
    if (!contenedor) return;
    
    let html = '<div class="puntos-criticos-resumen"><h6>Puntos Críticos del Progreso</h6>';
    
    if (puntos.puntoInflexion) {
        html += `
            <p><strong>Punto de Inflexión:</strong> Semana ${puntos.puntoInflexion.semana} 
            (${puntos.puntoInflexion.porcentajeMeta}% de la meta) - 
            Tasa: ${puntos.puntoInflexion.tasa.toFixed(3)} kg/semana</p>
        `;
    }
    
    if (puntos.puntoEstabilizacion) {
        html += `
            <p><strong>Estabilización:</strong> Semana ${puntos.puntoEstabilizacion.semana} 
            (${puntos.puntoEstabilizacion.porcentajeMeta}% de la meta) - 
            Tasa estable: ~${puntos.puntoEstabilizacion.tasa.toFixed(3)} kg/semana</p>
        `;
    }
    
    if (puntos.puntoMitadTasa) {
        html += `
            <p><strong>50% de Tasa Inicial:</strong> Semana ${puntos.puntoMitadTasa.semana} 
            (${puntos.puntoMitadTasa.porcentajeMeta}% de la meta)</p>
        `;
    }
    
    html += '</div>';
    
    contenedor.innerHTML = html;
}




// Función para crear la tabla de progreso en el modal
function crearTablaProgresoModal(resultado) {
    try {
        const contenedor = document.getElementById('tabla-progreso-container-modal');
		
        // Calcular meses a partir de semanas
        const totalMeses = (resultado.totalSemanas / 4.34524).toFixed(1);
        
        let html = `
            <h5 class="mb-3">📅 Progreso Semanal Estimado - ${resultado.semanas.length} semanas</h5>
            <p class="text-muted"><small>Desliza hacia abajo para ver todas las semanas. El encabezado permanece fijo.</small></p>
            
            <div class="tabla-contenedor" style="height: 400px; overflow-y: auto; position: relative; border: 1px solid #dee2e6; border-radius: 8px; background: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                <table class="table" style="width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 0;">
                    <thead style="position: sticky; top: 0; z-index: 1000;">
                        <tr style="position: sticky; top: 0; z-index: 1000;">
                            <th style="background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%) !important; color: white !important; padding: 12px 8px; font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.3); position: sticky; top: 0; font-size: 0.85rem; white-space: nowrap; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px 8px 0 0;">
                                Semana
                            </th>
                            <th style="background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%) !important; color: white !important; padding: 12px 8px; font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.3); position: sticky; top: 0; font-size: 0.85rem; white-space: nowrap; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px 8px 0 0;">
                                ${resultado.esPerdida ? 'Pérdida' : 'Ganancia'} Acumulada
                            </th>
                            <th style="background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%) !important; color: white !important; padding: 12px 8px; font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.3); position: sticky; top: 0; font-size: 0.85rem; white-space: nowrap; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px 8px 0 0;">
                                ${resultado.esPerdida ? 'Pérdida' : 'Ganancia'} Semanal
                            </th>
                            <th style="background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%) !important; color: white !important; padding: 12px 8px; font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.3); position: sticky; top: 0; font-size: 0.85rem; white-space: nowrap; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px 8px 0 0;">
                                TDEE Ajustado
                            </th>
                            <th style="background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%) !important; color: white !important; padding: 12px 8px; font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.3); position: sticky; top: 0; font-size: 0.85rem; white-space: nowrap; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px 8px 0 0;">
                                Cambio TDEE
                            </th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Mostrar TODAS las semanas
        resultado.semanas.forEach(semana => {
            const signo = resultado.esPerdida ? "-" : "+";
            const clase = resultado.esPerdida ? "negative-change" : "positive-change";
            const cambioTDEE = resultado.tdeeInicial - semana.tdee;
            const cambioTDEEText = cambioTDEE > 0 ? `-${cambioTDEE}` : `+${Math.abs(cambioTDEE)}`;
            
            html += `
                <tr style="transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;" 
                    onmouseover="this.style.background='linear-gradient(90deg, #e8f5e9 0%, #d4edda 100%)'; this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 15px rgba(60, 145, 65, 0.2)'; this.style.zIndex='10'; this.style.position='relative'; this.style.borderLeft='3px solid #3c9141'; this.style.borderRight='3px solid #3c9141';"
                    onmouseout="this.style.background=''; this.style.transform='scale(1)'; this.style.boxShadow=''; this.style.zIndex=''; this.style.position=''; this.style.borderLeft=''; this.style.borderRight='';">
                    <td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; vertical-align: middle; text-align: center; font-size: 0.85rem; transition: all 0.2s ease;"><strong>${semana.numero}</strong></td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; vertical-align: middle; text-align: center; font-size: 0.85rem; transition: all 0.2s ease;" class="${clase}">${signo}${semana.pesoAcumulado.toFixed(2)} kg</td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; vertical-align: middle; text-align: center; font-size: 0.85rem; transition: all 0.2s ease;" class="${clase}">${signo}${semana.tasa.toFixed(2)} kg</td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; vertical-align: middle; text-align: center; font-size: 0.85rem; transition: all 0.2s ease;">${semana.tdee} kcal</td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; vertical-align: middle; text-align: center; font-size: 0.85rem; transition: all 0.2s ease;">${cambioTDEE !== 0 ? cambioTDEEText : '0'} kcal</td>
                </tr>
            `;
        });
        
        html += `</tbody></table></div>`;
		
        // Actualizar resúmenes
        const semana50 = encontrarSemana50PorCiento(resultado);
        
        document.getElementById('resumen-plan-modal').innerHTML = `
            <strong>${resultado.totalSemanas} semanas (${totalMeses} meses)</strong> para
            ${resultado.esPerdida ? 'perder' : 'ganar'} 
            <strong>${resultado.metaAbs.toFixed(1)} kg</strong><br>
            TDEE inicial: <strong>${resultado.tdeeInicial.toFixed(0)} kcal</strong><br>
            TDEE final: <strong>${resultado.finalTDEE.toFixed(0)} kcal</strong><br>
            ${resultado.esPerdida ? 'Pérdida' : 'Ganancia'} al 50%: <strong>Semana nº${semana50 ? semana50.semana : 'N/A'}</strong> (${semana50 ? semana50.pesoAcumulado.toFixed(1) : 'N/A'} kg)<br>
        `;
        
        // Análisis de puntos críticos
        const puntosCriticos = analizarPuntosCriticos(resultado);
        
        // Añadir información de puntos críticos y estrategias dietéticas
        let estrategiasHtml = '<div class="mt-3 estrategias-info">';
        
        if (resultado.esPerdida) {
            // ESTRATEGIAS PARA PÉRDIDA DE PESO
            if (puntosCriticos.puntoEstabilizacion) {
                estrategiasHtml += `
                    <div class="alert alert-warning">
                        <h6><strong>⚠️ Punto de Estabilización Detectado</strong></h6>
                        <p><strong>Semana ${puntosCriticos.puntoEstabilizacion.semana}</strong> 
                        (${puntosCriticos.puntoEstabilizacion.porcentajeMeta}% de tu objetivo) - 
                        Velocidad estable: <strong>${puntosCriticos.puntoEstabilizacion.tasa.toFixed(3)} kg/semana</strong></p>
                    </div>
                    
                    <div class="card" style="border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);">
                        <div class="card-header" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-bottom: 1px solid #ffc107; padding: 12px 15px;">
                            <h6 style="margin: 0; color: #856404; font-weight: 600;">
                                <i class="bi bi-lightbulb-fill"></i> Estrategias Dietéticas para Superar la Meseta (Pérdida de Peso)
                            </h6>
                        </div>
                        <div class="card-body" style="padding: 15px;">
                            
                            <div class="alert alert-warning" style="font-size: 0.85rem; margin-bottom: 20px; border-radius: 6px;">
                                <strong>⚠️ Estrategias Proactivas desde el Inicio:</strong> Implementar estas tácticas desde el principio puede prevenir adaptaciones metabólicas excesivas y mantener una velocidad de pérdida más constante (~0.2-0.3 kg/semana).
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>1. 🎯 Déficit Calórico Moderado y Dinámico</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Inicio:</strong> Déficit moderado (~500 kcal/día) para preservar metabolismo</li>
                                    <li><strong>Beneficio:</strong> Evita adaptación metabólica rápida y fatiga dietética</li>
                                    <li><strong>Prevención:</strong> Mantiene velocidad ~0.2-0.3 kg/semana, evita caídas a 0.18 kg/semana</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>2. 🥩 Alta Ingesta de Proteína desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Dosis:</strong> 1.8-2.2 g/kg de peso corporal (190-230g para 105kg)</li>
                                    <li><strong>Beneficio:</strong> Preserva masa muscular y metabolismo basal</li>
                                    <li><strong>Efecto térmico:</strong> 20-30% de calorías se gastan en digestión</li>
                                    <li><strong>Avanzado:</strong> Implementar Protein Cycling tras 12-16 semanas</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>3. 💪 Entrenamiento de Fuerza desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Frecuencia:</strong> 2-3 sesiones semanales</li>
                                    <li><strong>Beneficio:</strong> Preserva masa muscular, aumenta TDEE, mejora sensibilidad insulínica</li>
                                    <li><strong>Importante:</strong> Contrarresta sarcopenia a los 55 años</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>4. 🚶 Incorporar NEAT desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Objetivo:</strong> 10,000-12,000 pasos/día</li>
                                    <li><strong>Beneficio:</strong> Aumenta déficit sin reducir ingesta</li>
                                    <li><strong>Prevención:</strong> Compensa reducción natural del TDEE</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>5. 🔁 Ciclado Calórico desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Estrategia:</strong> Alternar días de déficit con días de mantenimiento/refeed</li>
                                    <li><strong>Beneficio:</strong> Previene adaptación metabólica y mejora leptina</li>
                                    <li><strong>Psicológico:</strong> Reduce fatiga dietética y mejora adherencia</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>6. 🍞 Carb Cycling desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Patrón:</strong> Días altos (300g) con entrenamiento, bajos (100-150g) en descanso</li>
                                    <li><strong>Beneficio:</strong> Optimiza glucógeno y rendimiento</li>
                                    <li><strong>Metabólico:</strong> Fomenta oxidación de grasas</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>7. 🔄 Fases de Mantenimiento Planificadas</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Timing:</strong> 1-2 semanas cada 8-12 semanas</li>
                                    <li><strong>Hormonal:</strong> Restablece leptina, tiroides y gasto energético</li>
                                    <li><strong>Prevención:</strong> Reduce termogénesis adaptativa</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>8. 📋 Flexible Dieting (Regla 80/20) desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Principio:</strong> 80% alimentos saludables, 20% flexibilidad</li>
                                    <li><strong>Beneficio:</strong> Mejora adherencia y evita abandono</li>
                                    <li><strong>Social:</strong> Facilita participación en eventos</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>9. 🛌 Optimización del Estilo de Vida desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Sueño:</strong> 7-9 horas de calidad (regula cortisol y leptina)</li>
                                    <li><strong>Hidratación:</strong> 2-3 L/día (apoya metabolismo)</li>
                                    <li><strong>Estrés:</strong> Técnicas de manejo (reduce cortisol)</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #e8f4f8; border-radius: 6px; border-left: 3px solid #17a2b8;">
                                <h6 style="color: #0c5460; margin-top: 0; margin-bottom: 10px;">
                                    <strong>10. 📊 Monitoreo Proactivo desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Peso:</strong> Semanalmente (lunes, ayunas, mismas condiciones)</li>
                                    <li><strong>Grasa:</strong> Cada 6 semanas (calibradores/bioimpedancia)</li>
                                    <li><strong>Ajuste:</strong> Si < 0.2 kg/semana → aumentar déficit o refeed adicional</li>
                                    <li><strong>Beneficio:</strong> Reacción rápida evita mesetas prolongadas</li>
                                </ul>
                            </div>
                            
                            <div class="alert alert-success" style="margin-top: 15px; margin-bottom: 0; font-size: 0.8rem; border-radius: 6px;">
                                <strong>🌟 Resultado Esperado:</strong> Con estas estrategias proactivas, la velocidad de pérdida puede mantenerse cerca de 0.2-0.3 kg/semana, retrasando significativamente la estabilización más allá de la semana 27. La clave es la implementación temprana y consistente.
                            </div>
                            
                            <div class="alert alert-info" style="margin-top: 10px; margin-bottom: 0; font-size: 0.8rem; border-radius: 6px;">
                                <strong>💡 Consejo Clave:</strong> Las mesetas son normales, pero con planificación proactiva pueden ser más cortas y menos pronunciadas. Combina estrategias preventivas con tácticas correctivas para mantener el progreso de forma sostenible.
                            </div>
                        </div>
						<div class="alert alert-success" style="margin-top: 15px; margin-bottom: 0; font-size: 0.8rem; border-radius: 6px;">
							<strong>📋 Cronograma a Largo Plazo (Pérdida de Peso):</strong><br>
							
							<strong>Semanas 1-${Math.min(12, resultado.totalSemanas)}:</strong> Déficit moderado (~500 kcal/día) con estrategias proactivas<br>
							<em>• Semanas 1-${Math.min(4, resultado.totalSemanas)}:</em> Ciclado calórico, alta proteína, NEAT<br>
							<em>• Semanas ${Math.min(5, resultado.totalSemanas)}-${Math.min(8, resultado.totalSemanas)}:</em> Carb cycling, entrenamiento fuerza<br>
							<em>• Semanas ${Math.min(9, resultado.totalSemanas)}-${Math.min(12, resultado.totalSemanas)}:</em> Flexible dieting, optimización sueño<br>
							
							${resultado.totalSemanas >= 13 ? 
							`<strong>Semanas ${Math.min(13, resultado.totalSemanas)}-${Math.min(14, resultado.totalSemanas)}:</strong> Fase de mantenimiento planificada<br>
							<em>• Semanas ${Math.min(13, resultado.totalSemanas)}-${Math.min(14, resultado.totalSemanas)}:</em> TDEE completo, refeed estratégico<br>` : ''}
							
							${resultado.totalSemanas >= 15 ? 
							`<strong>Semanas ${Math.min(15, resultado.totalSemanas)}-${Math.min(26, resultado.totalSemanas)}:</strong> Ajuste dinámico según progreso<br>
							<em>• Semanas ${Math.min(15, resultado.totalSemanas)}-${Math.min(18, resultado.totalSemanas)}:</em> Aumentar déficit si < 0.2 kg/semana<br>
							<em>• Semanas ${Math.min(19, resultado.totalSemanas)}-${Math.min(22, resultado.totalSemanas)}:</em> Protein cycling, refeeds semanales<br>
							<em>• Semanas ${Math.min(23, resultado.totalSemanas)}-${Math.min(26, resultado.totalSemanas)}:</em> Evaluación completa<br>` : ''}
							
							${resultado.totalSemanas >= 27 ? 
							`<strong>Semanas ${Math.min(27, resultado.totalSemanas)}-${resultado.totalSemanas}:</strong> Continuación con monitoreo proactivo<br>
							<em>• Semanas ${Math.min(27, resultado.totalSemanas)}-${Math.min(36, resultado.totalSemanas)}:</em> Ciclos 4 semanas + 1 mantenimiento<br>
							<em>• Semanas ${Math.min(37, resultado.totalSemanas)}-${Math.min(48, resultado.totalSemanas)}:</em> Ajustes mensuales TDEE<br>
							<em>• Semanas ${Math.min(49, resultado.totalSemanas)}-${resultado.totalSemanas}:</em> Enfoque sostenibilidad<br>` : ''}
						</div>
                    </div>
                `;
            }
        } else {
            // ESTRATEGIAS PARA GANANCIA DE MASA MUSCULAR
            if (puntosCriticos.puntoEstabilizacion) {
                estrategiasHtml += `
                    <div class="alert alert-warning">
                        <h6><strong>⚠️ Punto de Estabilización Detectado</strong></h6>
                        <p><strong>Semana ${puntosCriticos.puntoEstabilizacion.semana}</strong> 
                        (${puntosCriticos.puntoEstabilizacion.porcentajeMeta}% de tu objetivo) - 
                        Velocidad estable: <strong>${puntosCriticos.puntoEstabilizacion.tasa.toFixed(3)} kg/semana</strong></p>
                    </div>
                    
                    <div class="card" style="border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);">
                        <div class="card-header" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-bottom: 1px solid #ffc107; padding: 12px 15px;">
                            <h6 style="margin: 0; color: #856404; font-weight: 600;">
                                <i class="bi bi-lightbulb-fill"></i> Estrategias para la Ganancia de Masa Muscular
                            </h6>
                        </div>
                        <div class="card-body" style="padding: 15px;">
                            
                            <div class="alert alert-warning" style="font-size: 0.85rem; margin-bottom: 20px; border-radius: 6px;">
                                <strong>⚠️ Estrategias Proactivas desde el Inicio:</strong> Implementar estas tácticas desde el principio puede optimizar la ganancia muscular (~0.1-0.2 kg/semana) y minimizar la acumulación de grasa.
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>1. 🎯 Superávit Calórico Controlado</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Inicio:</strong> Superávit moderado (~300-500 kcal/día)</li>
                                    <li><strong>Progresión:</strong> Aumentar a 500 kcal si ganancia < 0.05 kg/semana</li>
                                    <li><strong>Beneficio:</strong> Energía para síntesis muscular sin exceso de grasa</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>2. 💪 Entrenamiento de Fuerza Progresivo</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Principio:</strong> Sobrecarga progresiva como estímulo principal</li>
                                    <li><strong>Frecuencia:</strong> 3-5 sesiones semanales</li>
                                    <li><strong>Variación:</strong> Cambiar rutina cada 4-6 semanas</li>
                                    <li><strong>Beneficio:</strong> Estimula hipertrofia y aumenta TDEE</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>3. 🥩 Alta Ingesta de Proteína</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Dosis:</strong> 1.8-2.2 g/kg de peso corporal</li>
                                    <li><strong>Beneficio:</strong> Optimiza hipertrofia y preserva masa magra</li>
                                    <li><strong>Edad:</strong> Especialmente importante a los 55 años</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>4. 🔁 Ciclado Calórico y Carbohidratos</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Días altos:</strong> 3-4 días entrenamiento (~3500 kcal, 450-500g carbohidratos)</li>
                                    <li><strong>Días bajos:</strong> 3-4 días descanso (~3000 kcal, 300-350g carbohidratos)</li>
                                    <li><strong>Beneficio:</strong> Optimiza glucógeno y minimiza grasa</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>5. 🔄 Fases de Mantenimiento Periódicas</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Timing:</strong> 1-2 semanas cada 8-12 semanas</li>
                                    <li><strong>Objetivo:</strong> Controlar grasa y mejorar sensibilidad insulínica</li>
                                    <li><strong>Beneficio:</strong> Reduce acumulación de grasa y permite recuperación</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>6. 📋 Flexible Dieting (Regla 80/20)</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Principio:</strong> 80% alimentos nutritivos, 20% para caprichos</li>
                                    <li><strong>Beneficio:</strong> Mejora adherencia psicológica</li>
                                    <li><strong>Social:</strong> 1-2 comidas semanales de flexibilidad</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>7. 🛌 Optimización del Estilo de Vida</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Sueño:</strong> 7-9 horas de calidad (recuperación muscular)</li>
                                    <li><strong>Hidratación:</strong> 3-4 L diarios (más durante entrenamientos)</li>
                                    <li><strong>Estrés:</strong> 10-15 min meditación/yoga diarios</li>
                                    <li><strong>Micronutrientes:</strong> Magnesio, zinc, vitamina D</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #e8f4f8; border-radius: 6px; border-left: 3px solid #17a2b8;">
                                <h6 style="color: #0c5460; margin-top: 0; margin-bottom: 10px;">
                                    <strong>8. 📊 Monitoreo Proactivo</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Peso y grasa:</strong> Cada 4-6 semanas (calibradores/bioimpedancia)</li>
                                    <li><strong>Fuerza:</strong> Evaluar aumentos en pesos levantados</li>
                                    <li><strong>Medidas:</strong> Bíceps, cuádriceps, cintura</li>
                                    <li><strong>Ajuste:</strong> Si < 0.05 kg/semana → aumentar superávit</li>
                                </ul>
                            </div>
                            
                            <div class="alert alert-info" style="margin-top: 20px; margin-bottom: 15px; font-size: 0.85rem; border-radius: 6px;">
                                <h6><strong>⚠️ ¿Por qué ocurren mesetas?</strong></h6>
                                <ul style="margin-bottom: 0; padding-left: 20px;">
                                    <li><strong>Adaptación muscular:</strong> Músculos se adaptan al estímulo (~0.05 kg/semana en semana 20-26)</li>
                                    <li><strong>Límite genético:</strong> Potencial menor a los 55 años por edad y hormonas</li>
                                    <li><strong>Superávit insuficiente:</strong> Errores en seguimiento calórico</li>
                                    <li><strong>Recuperación:</strong> Sueño deficiente o sobreentrenamiento</li>
                                    <li><strong>Acumulación de grasa:</strong> Superávit excesivo reduce eficiencia anabólica</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #d4edda; border-radius: 6px; border-left: 3px solid #28a745;">
                                <h6 style="color: #155724; margin-top: 0; margin-bottom: 10px;">
                                    <<strong>🔧 Estrategias para Superar Mesetas (alrededor de la Semana ${puntosCriticos.puntoEstabilizacion.semana})</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Aumentar superávit:</strong> 500-700 kcal/día (~3273-3473 kcal) durante 4-6 semanas</li>
                                    <li><strong>Modificar entrenamiento:</strong> Técnicas avanzadas (drop sets, superseries) o aumentar volumen</li>
                                    <li><strong>Protein cycling:</strong> 4 semanas altas, 1 semana moderada</li>
                                    <li><strong>Deload:</strong> 1 semana cada 8-12 semanas con menor volumen/intensidad</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 0; padding: 10px; background-color: #f8d7da; border-radius: 6px; border-left: 3px solid #dc3545;">
                                <h6 style="color: #721c24; margin-top: 0; margin-bottom: 10px;">
                                    <strong>🚨 Fase de Corte Temporal</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Indicación:</strong> Si grasa corporal > 35%</li>
                                    <li><strong>Duración:</strong> 4-6 semanas de déficit (~500 kcal/día)</li>
                                    <li><strong>Retorno:</strong> Regresar al superávit después</li>
                                </ul>
                            </div>
                            
                           <div class="alert alert-success" style="margin-top: 15px; margin-bottom: 0; font-size: 0.8rem; border-radius: 6px;">
								<strong>📋 Cronograma a Largo Plazo (Ganancia de Masa Muscular):</strong><br>
								
								<strong>Semanas 1-${Math.min(10, resultado.totalSemanas)}:</strong> Superávit con ciclado calórico<br>
								<em>• Semanas 1-${Math.min(4, resultado.totalSemanas)}:</em> Superávit moderado (300-500 kcal), alta proteína<br>
								<em>• Semanas ${Math.min(5, resultado.totalSemanas)}-${Math.min(8, resultado.totalSemanas)}:</em> Carb cycling, entrenamiento progresivo<br>
								<em>• Semanas ${Math.min(9, resultado.totalSemanas)}-${Math.min(10, resultado.totalSemanas)}:</em> Evaluación inicial, ajuste superávit<br>
								
								${resultado.totalSemanas >= 11 ? 
								`<strong>Semanas ${Math.min(11, resultado.totalSemanas)}-${Math.min(12, resultado.totalSemanas)}:</strong> Fase de mantenimiento<br>
								<em>• Semanas ${Math.min(11, resultado.totalSemanas)}-${Math.min(12, resultado.totalSemanas)}:</em> Control grasa, recuperación hormonal<br>` : ''}
								
								${resultado.totalSemanas >= 13 ? 
								`<strong>Semanas ${Math.min(13, resultado.totalSemanas)}-${Math.min(20, resultado.totalSemanas)}:</strong> Ajuste superávit según progreso<br>
								<em>• Semanas ${Math.min(13, resultado.totalSemanas)}-${Math.min(16, resultado.totalSemanas)}:</em> Aumentar a 500-700 kcal si < 0.05 kg/semana<br>
								<em>• Semanas ${Math.min(17, resultado.totalSemanas)}-${Math.min(20, resultado.totalSemanas)}:</em> Evaluación composición corporal<br>` : ''}
								
								${resultado.totalSemanas >= 21 ? 
								`<strong>Semanas ${Math.min(21, resultado.totalSemanas)}-${Math.min(22, resultado.totalSemanas)}:</strong> Deload (reducción volumen)<br>
								<em>• Semanas ${Math.min(21, resultado.totalSemanas)}-${Math.min(22, resultado.totalSemanas)}:</em> 50% volumen, enfoque recuperación<br>` : ''}
								
								${resultado.totalSemanas >= 23 ? 
								`<strong>Semanas ${Math.min(23, resultado.totalSemanas)}-${Math.min(26, resultado.totalSemanas)}:</strong> Protein cycling<br>
								<em>• Semanas ${Math.min(23, resultado.totalSemanas)}-${Math.min(25, resultado.totalSemanas)}:</em> Proteína alta (1.8-2.2 g/kg)<br>
								<em>• Semanas ${Math.min(26, resultado.totalSemanas)}:</em> Proteína moderada (1.4-1.6 g/kg)<br>` : ''}
								
								${resultado.totalSemanas >= 27 ? 
								`<strong>Semanas ${Math.min(27, resultado.totalSemanas)}-${resultado.totalSemanas}:</strong> Repetir ciclos adaptativos<br>
								<em>• Semanas ${Math.min(27, resultado.totalSemanas)}-${Math.min(36, resultado.totalSemanas)}:</em> Ciclos 8 semanas superávit + 2 mantenimiento<br>
								<em>• Semanas ${Math.min(37, resultado.totalSemanas)}-${Math.min(48, resultado.totalSemanas)}:</em> Ajustes según acumulación grasa<br>
								<em>• Semanas ${Math.min(49, resultado.totalSemanas)}-${resultado.totalSemanas}:</em> Optimización largo plazo<br>` : ''}
							</div>
                        </div>
                    </div>
                `;
            }
        }
        
        estrategiasHtml += '</div>';
        
        // Añadir estrategias al final del contenido HTML
        html += estrategiasHtml;
        
        document.getElementById('resumen-velocidad-modal').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Vel. Inicio:</strong> ${resultado.tasaInicial.toFixed(2)} kg/sem
                </div>
                <div class="col-md-6">
                    <strong>Vel Mitad:</strong> ${calcularVelocidadMitad(resultado).toFixed(2)} kg/sem
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>Vel Final:</strong> ${resultado.semanas[resultado.semanas.length-1].tasa.toFixed(2)} kg/sem
                </div>
                <div class="col-md-6">
                    <strong>Vel Media:</strong> ${calcularVelocidadPromedio(resultado).toFixed(2)} kg/sem
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <strong>Reducción Vel:</strong> ${calcularReduccionVelocidad(resultado).toFixed(1)}%
                </div>
            </div>
        `;

        contenedor.innerHTML = html;
       // document.getElementById('result-container-modal').style.display = 'flex';
        
        
        
    } catch (error) {
        console.error('Error en crearTablaProgresoModal:', error);
        alert('Error al mostrar los resultados.');
    }
}

// Función auxiliar para encontrar semana al 50%
function encontrarSemana50PorCiento(resultado) {
    if (!resultado.semanas || resultado.semanas.length === 0) return null;
    
    const meta50PorCiento = resultado.metaAbs * 0.5;
    
    for (let i = 0; i < resultado.semanas.length; i++) {
        if (resultado.semanas[i].pesoAcumulado >= meta50PorCiento) {
            return {
                semana: i + 1,
                pesoAcumulado: resultado.semanas[i].pesoAcumulado,
                tasa: resultado.semanas[i].tasa
            };
        }
    }
    
    return null;
}

// === INICIALIZACIÓN ===

// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    // Event listener para cuando el modal principal se abre
    const modalCalculadora = document.getElementById('modalCalculadoraNoLineal');
    if (modalCalculadora) {
        modalCalculadora.addEventListener('show.bs.modal', function () {
            // ✅ Poblar automáticamente los campos del formulario
            poblarModal();

            // ✅ Resetear solo los resultados visuales del modal principal
            // (resumen, no la tabla)
            //document.getElementById('result-container-modal').style.display = 'none';
            //document.getElementById('resumen-plan-modal').textContent = '';
            //document.getElementById('resumen-velocidad-modal').textContent = '';
        });
    }

    // ✅ Event listener para el nuevo modal de tabla (opcional)
    const modalTabla = document.getElementById('modalTablaProgreso');
    if (modalTabla) {
        modalTabla.addEventListener('show.bs.modal', function () {
            // ✅ Opcional: Actualizar la tabla cada vez que se abre
            // (por si los datos cambiaron)
            if (window.resultadoTiempoNoLineal && typeof crearTablaProgresoModal === 'function') {
                crearTablaProgresoModal(window.resultadoTiempoNoLineal);
            } else {
                // Mostrar mensaje si no hay datos
                document.getElementById('tabla-progreso-container-modal').innerHTML = `
                    <div class="alert alert-warning text-center">
                        <p>No hay datos de progreso. Por favor, realiza un cálculo primero.</p>
                    </div>
                `;
            }
        });

        // ✅ Opcional: Al cerrar, no limpiar (los datos persisten)
        // Si quieres limpiar al cerrar, descomenta:
        /*
        modalTabla.addEventListener('hidden.bs.modal', function () {
            // Limpiar tabla al cerrar (opcional)
            document.getElementById('tabla-progreso-container-modal').innerHTML = `
                <div class="alert alert-info text-center">
                    <p>Los resultados se mostrarán aquí después de calcular.</p>
                </div>
            `;
        });
        */
    }
});

// === FUNCIÓN PARA CERRAR EL MODAL ===
function cerrarModalCalculadora() {
    const modalElement = document.getElementById('modalCalculadoraNoLineal');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    }
}

// --- Definición de Macros Predeterminados por Estrategia ---
// Clave: nombre de la estrategia (tal como aparece en el value del checkbox)
// Valor: objeto con claves 'proteinas', 'carbohidratos', 'grasas' y valores numéricos (%)
const MACROS_POR_ESTRATEGIA = {
    'ninguna': { proteinas: 25, carbohidratos: 40, grasas: 35 }, // Valores base de la fase
    'refeed': { proteinas: 20, carbohidratos: 60, grasas: 20 }, // Alta en CH, baja en GR
    'carb_cycling': { proteinas: 25, carbohidratos: 50, grasas: 25 }, // Balance medio-alto CH
    'protein_cycling': { proteinas: 35, carbohidratos: 35, grasas: 30 }, // Alta en Pt
    'ckd': { proteinas: 30, carbohidratos: 50, grasas: 20 }, // CKD: Días de carga alta en CH
    'tkd': { proteinas: 30, carbohidratos: 40, grasas: 30 }, // TKD: CH alrededor del entreno
    'if_16_8': { proteinas: 25, carbohidratos: 40, grasas: 35 }, // IF: Igual que base
    'timing': { proteinas: 25, carbohidratos: 40, grasas: 35 }, // Timing: Igual que base
    'flexible_dieting': { proteinas: 25, carbohidratos: 40, grasas: 35 }, // 80/20: Igual que base
    'hiperproteica': { proteinas: 35, carbohidratos: 35, grasas: 30 }, // Alta Pt
    // Puedes añadir más estrategias y sus macros predeterminados aquí
};


///////////////////MODAL PARA FILA DATOS TABLA DETALLADA//////////////////////
// --- Mapeo de objetivo descriptivo a clave simple ---
const MAPEO_OBJETIVO_A_SIMPLE = {
    // Pérdida de Peso
    'perdida1': [
        'Reset metabólico', 'inicio de pérdida de grasa', 'reducción de insulina',
        'Continuar pérdida de peso', 'mantener rendimiento físico', 'evitar estancamiento',
        'Mantener peso perdido', 'favorecer adherencia social', 'equilibrio nutricional',
        'Ajuste dinámico según progreso', 'Afinar hipertrofia en atletas intermedios/avanzados'
    ],
    // Ganancia de Masa Muscular
    'ganancia1': [
        'Evaluar estado inicial', 'establecer hábitos', 'preparar el cuerpo',
        'Maximizar hipertrofia con superávit controlado',
        'Consolidar ganancias', 'prevenir exceso de grasa',
        'Afinar hipertrofia en atletas intermedios/avanzados'
    ],
    // Mantenimiento de Peso
    'mantenimiento1': [
        'Estabilizar peso corporal', 'tras volumen o definición',
        'Preservar masa muscular y optimizar rendimiento',
        'Evaluar progreso y preparar próximo ciclo'
    ],
    // Mixto
    'mixto1': [
        'Pérdida de grasa con preservación muscular',
        'Ganancia de masa muscular con mínimo de grasa',
        'Fase de mantenimiento planificada'
    ]
};


// --- Definición de Estrategias por Objetivo ---
// Clave: objetivoUsuario (perdida1, ganancia1, mantenimiento1, mixto1)
// Valor: objeto con claves 'base', 'recomendadas' y 'fases'
const ESTRATEGIAS_POR_OBJETIVO = {
    perdida1: {
        base: ['Hiperproteica', 'Cetogenica', 'Baja en HC'],
        recomendadas: [
            'Carb Cycling',
            'Refeed Strategy',
            'Intermittent Fasting + Cycling',
            'Cyclic Ketogenic Diet (CKD)',
            'Targeted Ketogenic Diet (TKD)',
            'Protein Cycling',
            'Flexible Dieting Integration'
        ],
        fases: [
            {
                nombre: 'Fase 1: Inducción Cetogénica',
                semanas: '1–8',
                objetivoPrincipal: 'Reset metabólico, inicio de pérdida de grasa, reducción de insulina',
                duracionSemanas:'4',
                macrosBase: { proteinasPct: '20-25%', carbohidratosPct: '5-10%', grasasPct: '65-75%' },
                observaciones: 'Déficit: 15-20% bajo GET (300-500 kcal/día). VLCKD: ↓50g HC/día. 80/20 Rule: 80% alimentos integrales, 20% flexibles. Timing: 20-40g proteína post-entreno. Intuitivo: Ajustar por hambre. Suplementos: Electrolitos, fibra. Monitorizar lípidos, glucosa, cetonas (0.5-3 mmol/L).'
            },
            {
                nombre: 'Fase 2: Ciclado Metabólico',
                semanas: '8–16',
                objetivoPrincipal: 'Continuar pérdida de peso, mantener rendimiento físico, evitar estancamiento',
                duracionSemanas:'4', 
                
                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '10-25%', grasasPct: '50-65%' },
                observaciones: 'Déficit: 10-15% bajo GET (300-400 kcal/día). TKD: 20-50g HC pre/post entreno. Carb Cycling: 80-120g HC días entreno, 30-50g descanso. Periodización: Ajustar HC según intensidad entreno. 80/20 Rule. Intuitivo: Ajustar por hambre/saciedad. Fraccionamiento: 4-5 comidas/día.'
            },
            {
                nombre: 'Fase 3: Transición a Mantenimiento',
                semanas: '16–24',
                objetivoPrincipal: 'Mantener peso perdido, favorecer adherencia social y equilibrio nutricional',
                duracionSemanas:'2',
                
                macrosBase: { proteinasPct: '22-25%', carbohidratosPct: '33-40%', grasasPct: '40-45%' },
                observaciones: 'Déficit: 0-5% bajo GET (0-100 kcal/día). Moderate-carb: 100-150g HC/día. Intuitivo: Ajustar por necesidades sociales. 80/20 Rule. Timing: 20-40g proteína post-entreno. Evaluar composición corporal (bioimpedancia, plicometría). Suplementos: Creatina (3-5g/día), omega-3 (1-2g/día).'
            }
        ]
    },
    ganancia1: {
        base: ['Hiperproteica', 'Hipercalorica'],
        recomendadas: [
            'High Protein + Metabolic Cycling',
            'Refeed Strategy',
            'Meal Timing Optimization',
            'Carb-loading',
            'CKD: 5+2',
            'Performance Enhancement',
            'Protein Cycling'
        ],
        fases: [
            {
                nombre: 'Fase 1: Evaluación y Base',
                semanas: '1–4',
                objetivoPrincipal: 'Evaluar estado inicial, establecer hábitos, preparar el cuerpo',
                duracionSemanas:'2',
               
                macrosBase: { proteinasPct: '16-22%', carbohidratosPct: '40-50%', grasasPct: '25-35%' },
                observaciones: 'Superávit moderado: +10-15% sobre GET (300-500 kcal/día). Iniciar entrenamiento de fuerza progresivo, priorizar alimentos integrales, sueño 7-9 h.'
            },
            {
                nombre: 'Fase 2: Volumen Progresivo',
                semanas: '8–16',
                objetivoPrincipal: 'Maximizar hipertrofia con superávit controlado',
                duracionSemanas:'4',
                
                macrosBase: { proteinasPct: '16-22%', carbohidratosPct: '50-60%', grasasPct: '20-30%' },
                observaciones: 'Superávit: +10-20% sobre GET. Ajustar según ganancia (0.5-1 kg/mes). Aumentar intensidad del entrenamiento. Composición corporal cada 4-6 semanas.'
            },
            {
                nombre: 'Fase 3: Mantenimiento y Reajuste',
                semanas: '4–8',
                objetivoPrincipal: 'Consolidar ganancias, prevenir exceso de grasa',
                duracionSemanas:'2',
                
                macrosBase: { proteinasPct: '18-22%', carbohidratosPct: '40-50%', grasasPct: '25-35%' },
                observaciones: 'Superávit leve: +5-10% o mantenimiento si %grasa >15-20%. Evaluar fuerza, composición corporal, rendimiento. Considerar ciclado calórico.'
            },
            {
                nombre: 'Fase 4: Optimización y Volumen Avanzado',
                semanas: '8–24',
                objetivoPrincipal: 'Afinar hipertrofia en atletas intermedios/avanzados',
                duracionSemanas:'4', 
                
                macrosBase: { proteinasPct: '18-22%', carbohidratosPct: '50-65%', grasasPct: 'Variable (6-8g entreno, 3-4g descanso)g' },
                observaciones: 'Superávit moderado: +10-15% o cíclico. Progreso cada 6-8 semanas. Periodización avanzada, suplementos (beta-alanina, citrulina), gestionar estrés.'
            }
        ]
    },
    mantenimiento1: {
        base: ['Equilibrada Nutricional', 'Calorie Cycling'],
        recomendadas: [
            'Flexible Dieting (80/20)',
            'Meal Timing Optimization',
            'Metabolic Flexibility Training',
            'Intermittent Fasting + Cycling',
            'Reverse Dieting',
            'Adaptive Periodization'
        ],
        fases: [
            {
                nombre: 'Subfase 1: Transición al Mantenimiento',
                semanas: '1–8',
                objetivoPrincipal: 'Estabilizar peso corporal tras volumen o definición',
                duracionSemanas:'2',
                
               
                macrosBase: { proteinasPct: '18-22%', carbohidratosPct: '30-40%', grasasPct: '30-40%' },
                observaciones: 'Calorías: 0% superávit (igual al GET). Flexibilidad selectiva (80/20): 80% alimentos integrales, 20% flexibles. Timing: 20-40g proteína post-entreno. Intuitivo: Ajustar por hambre/saciedad. Fraccionamiento: 4-5 comidas/día.'
            },
            {
                nombre: 'Subfase 2: Mantenimiento Estable',
                semanas: '8–12',
                objetivoPrincipal: 'Preservar masa muscular y optimizar rendimiento',
                duracionSemanas: '3',
                
                macrosBase: { proteinasPct: '18-22%', carbohidratosPct: '40-50%', grasasPct: '25-35%' },
                observaciones: 'Calorías: 0% superávit, ajustar ±100-200 kcal si peso varía ↑ 1 kg. CKD (5+2): 5 días 3-4g/kg HC, 2 días 6-8g/kg. TKD: 20-50g HC pre-entreno para atletas de fuerza. Ciclado CH suave: ±10% kcal según entreno. Periodización: Ajustar HC a intensidad. 80/20 Rule. Intuitivo. Timing: 20-40g proteína + 30-60g HC post-entreno.'
            },
            {
                nombre: 'Subfase 3: Reevaluación y Preparación',
                semanas: '8–12',
                objetivoPrincipal: 'Evaluar progreso y preparar próximo ciclo (volumen o definición)',
                duracionSemanas: '2',
                
                macrosBase: { proteinasPct: '18-22%', carbohidratosPct: '30-40%', grasasPct: '30-40%' },
                observaciones: 'Calorías: 0% superávit, ajustar según próximo objetivo. Flexibilidad selectiva (80/20). Intuitivo: Ajustar por señales corporales. Periodización: Ajustar HC según próximo ciclo. Suplementos: Creatina (3-5g/día), omega-3 (1-2g/día).'
            }
        ]
    },
    mixto1: {
        base: ['Flexible Dieting (80/20)', 'Hiperproteica', 'Baja en HC', 'Ciclado metabólico'],
        recomendadas: [
            'Carb Cycling',
            'Cyclic Ketogenic Diet (CKD)',
            'Refeed Strategy',
            'Intermittent Fasting + Cycling',
            'MFT (Keto → moderate carb → high carb)',
            'Adaptive Periodization'
        ],
        fases: [
            {
                nombre: 'Fase 1: Pérdida de Peso',
                semanas: '4–12',
                objetivoPrincipal: 'Pérdida de grasa con preservación muscular',
                duracionSemanas:'4',
                
                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '10-20%', grasasPct: '55-65%' },
                observaciones: 'Déficit: 10-15% bajo GET (300-400 kcal/día). Carb Cycling: 30-80g HC días entreno, 10-30g descanso. Protein Cycling: 1.8-2.2g/kg proteína. Timing: 20-40g proteína post-entreno.'
            },
            {
                nombre: 'Fase 2: Ganancia Muscular',
                semanas: '12–24',
                objetivoPrincipal: 'Ganancia de masa muscular con mínimo de grasa',
                duracionSemanas:'4',
                
                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '50-60%', grasasPct: '20-25%' },
                observaciones: 'Superávit: +5-10% sobre GET (200-300 kcal/día). Carb Cycling: 100-150g HC días fuerza, 60-80g días cardio. Protein Cycling: 2.0-2.5g/kg proteína. Timing: 20-40g proteína post-entreno.'
            },
            {
                nombre: 'Fase 3: Mantenimiento y Transición',
                semanas: '4-12',
                objetivoPrincipal: 'Fase de mantenimiento planificada',
                duracionSemanas:'1',
                
                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '45-55%', grasasPct: '25-30%' },
                observaciones: 'TDEE completo. Refeed estratégico: 1 día/semana HC alto. Evaluación fuerza, composición corporal. Ajuste fino: ±100-200 kcal según tendencia.'
            },
            {
                nombre: 'Fase 4: Ajuste Dinámico',
                semanas: '4-12',
                objetivoPrincipal: 'Ajuste dinámico según progreso',
                duracionSemanas:'3',
                
                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '45-55%', grasasPct: '25-30%' },
                observaciones: 'Ajuste semanal: ±200-300 kcal según velocidad cambio. MFT: Rotar entre cetosis, moderate carb y high carb. Evaluación completa: Semanas 35-38.'
            },
            {
                nombre: 'Fase 5: Continuación Sostenible',
                semanas: '4-12',
                objetivoPrincipal: 'Continuación con monitoreo proactivo',
                duracionSemanas: '5',
                
                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '45-55%', grasasPct: '25-30%' },
                observaciones: 'Ciclos 4 semanas + 1 mantenimiento. Ajustes mensuales TDEE. Enfoque sostenibilidad. Monitorización trimestral parámetros fisiológicos.'
            }
        ]
    }
};
const MACROS_POR_ESTRATEGIA_AJUSTADO = {
    // --- Pérdida de Peso ---
    'Carb Cycling': { proteinas: 30, carbohidratos: 40, grasas: 30 }, 
    // Preserva músculo (30% proteínas), controla calorías (40% CH), saciedad/hormonas (30% grasas).

    'Refeed Strategy': { proteinas: 25, carbohidratos: 55, grasas: 20 }, 
    // Proteínas moderadas (25%) para días de recarga, alta en CH (55%) para glucógeno, baja en grasas (20%).

    'Intermittent Fasting + Cycling': { proteinas: 30, carbohidratos: 35, grasas: 35 }, 
    // Proteínas altas (30%) para recuperación en ayuno, CH moderados (35%) para flexibilidad, grasas (35%) para energía.

    'Cyclic Ketogenic Diet (CKD)': { proteinas: 30, carbohidratos: 15, grasas: 55 }, 
    // Cetosis: baja CH (15%), alta grasas (55%), proteínas (30%) para músculo.

    'Targeted Ketogenic Diet (TKD)': { proteinas: 30, carbohidratos: 25, grasas: 45 }, 
    // CH peri-entreno (25%), grasas altas (45%) para cetosis, proteínas (30%) para músculo.

    'Protein Cycling': { proteinas: 40, carbohidratos: 30, grasas: 30 }, 
    // Alta proteína (40%) para síntesis muscular, CH y grasas balanceados (30%) para déficit.

    'Flexible Dieting Integration': { proteinas: 30, carbohidratos: 40, grasas: 30 }, 
    // Balanceado: proteínas (30%) para músculo, CH (40%) y grasas (30%) para adherencia.

    // --- Ganancia de Masa Muscular ---
    'High Protein + Metabolic Cycling': { proteinas: 35, carbohidratos: 45, grasas: 20 }, 
    // Alta proteína (35%) y CH (45%) para anabolismo, grasas bajas (20%) para priorizar CH.

    'Meal Timing Optimization': { proteinas: 30, carbohidratos: 45, grasas: 25 }, 
    // Proteínas (30%) y CH (45%) para recuperación/glucógeno, grasas moderadas (25%).

    'Carb-loading': { proteinas: 25, carbohidratos: 60, grasas: 15 }, 
    // Alta CH (60%) para glucógeno, proteínas moderadas (25%), grasas bajas (15%).

    'CKD: 5+2': { proteinas: 30, carbohidratos: 15, grasas: 55 }, 
    // Cetosis en días bajos: CH (15%), grasas altas (55%), proteínas (30%) para músculo.

    'Performance Enhancement': { proteinas: 30, carbohidratos: 50, grasas: 20 }, 
    // CH altos (50%) para rendimiento, proteínas (30%) para recuperación, grasas bajas (20%).

    // --- Mantenimiento de Peso ---
    'Flexible Dieting (80/20)': { proteinas: 30, carbohidratos: 40, grasas: 30 }, 
    // Balanceado: proteínas (30%) para músculo, CH (40%) y grasas (30%) para flexibilidad.

    'Metabolic Flexibility Training': { proteinas: 30, carbohidratos: 45, grasas: 25 }, 
    // Proteínas (30%) para músculo, CH (45%) para flexibilidad metabólica, grasas (25%).

    'Reverse Dieting': { proteinas: 30, carbohidratos: 45, grasas: 25 }, 
    // Proteínas (30%) y CH (45%) para metabolismo, grasas (25%) para balance.

    // --- Estrategias Faltantes Agregadas ---
    'Adaptive Periodization': { proteinas: 30, carbohidratos: 40, grasas: 30 }, 
    // Balanceado para mantenimiento: proteínas (30%) para músculo, CH (40%) y grasas (30%) para ajustes dinámicos.

    'MFT (Keto → moderate carb → high carb)': { proteinas: 30, carbohidratos: 35, grasas: 35 } 
    // Promedio para transición metabólica: proteínas (30%) para músculo, CH (35%) y grasas (35%) para flexibilidad.
};
const MACROS_POR_ESTRATEGIAS_BASE = {
    // Estrategias base para todos los objetivos
    'Hiperproteica': { proteinas: 40, carbohidratos: 30, grasas: 30 },
    // Alta proteína (40%) para preservar/construir músculo, CH y grasas balanceados (30%) para flexibilidad.

    'Cetogenica': { proteinas: 25, carbohidratos: 5, grasas: 70 },
    // Muy baja en CH (5%) para cetosis, alta en grasas (70%) para energía, proteínas moderadas (25%) para músculo.

    'Baja en HC': { proteinas: 35, carbohidratos: 25, grasas: 40 },
    // Proteínas altas (35%) para músculo, CH bajos (25%) para control calórico, grasas moderadas (40%) para energía.

    'Hipercalorica': { proteinas: 25, carbohidratos: 55, grasas: 20 },
    // Alta en CH (55%) para anabolismo y energía, proteínas moderadas (25%) para hipertrofia, grasas bajas (20%).

    'Equilibrada Nutricional': { proteinas: 30, carbohidratos: 40, grasas: 30 },
    // Balanceada para mantenimiento: proteínas (30%) para músculo, CH (40%) y grasas (30%) para sostenibilidad.

    'Calorie Cycling': { proteinas: 30, carbohidratos: 45, grasas: 25 },
    // Similar a equilibrada, con CH elevados (45%) para flexibilidad metabólica, proteínas (30%), grasas moderadas (25%).

    'Flexible Dieting (80/20)': { proteinas: 30, carbohidratos: 40, grasas: 30 },
    // Equilibrada para adherencia: proteínas (30%) para músculo, CH (40%) y grasas (30%) para flexibilidad.

    'Ciclado metabólico': { proteinas: 30, carbohidratos: 35, grasas: 35 }
    // Promedio para transiciones metabólicas: proteínas (30%) para músculo, CH (35%) y grasas (35%) para flexibilidad.
};
// --- Definición del Mapeo de Estrategias Base por Objetivo ---


const MAPEO_ESTRATEGIAS_BASE = {
    perdida1: {
        base: [
            { nombre: 'Hiperproteica', mapeo: 'hiperproteica' },
            { nombre: 'Cetogenica', mapeo: 'induccion_cetogenica' },
            { nombre: 'Baja en HC', mapeo: 'baja_en_hc' } // Asumiendo que existe 'baja_en_hc' en estrategiasDisponibles
        ]
    },
    ganancia1: {
        base: [
            { nombre: 'Hiperproteica', mapeo: 'hiperproteica' },
            { nombre: 'High Protein + Metabolic Cycling', mapeo: 'protein_cycling' }, // Asumiendo que 'protein_cycling' es el equivalente
            { nombre: 'Protein Cycling', mapeo: 'protein_cycling' }, // Duplicado, pero lo dejo por tu descripción
            { nombre: 'Hipercalorica', mapeo: 'hipercalorica' }
        ]
    },
    mantenimiento1: {
        base: [
            { nombre: 'Equilibrada Nutricional', mapeo: 'equilibrada_nutricional' }, // Asumiendo que existe
            { nombre: 'Ninguna (Equilibrio nutricional)', mapeo: 'ninguna' },
            { nombre: 'Calorie Cycling', mapeo: 'calorie_cycling' } // Asumiendo que existe
        ]
    },
    mixto1: {
        base: [
            { nombre: 'Hiperproteica', mapeo: 'hiperproteica' },
            { nombre: 'protein cycling', mapeo: 'protein_cycling' }, // Minúscula como en estrategiasDisponibles
            { nombre: 'Ciclado metabólico', mapeo: ['carb_cycling', 'ckd', 'tkd', 'mft', 'refeed', 'if_16_8'] }, // Múltiples mapeos
            { nombre: 'Baja en HC', mapeo: 'baja_en_hc' } // Asumiendo que existe
        ]
    }
};

// --- Mapeo de Estrategias para Checkboxes del Modal ---
// Clave: valor del checkbox (como aparece en estrategiasDisponibles o en ESTRATEGIAS_POR_OBJETIVO.base/recomendadas)
// Valor: nombre legible para mostrar al usuario
const MAPEO_ESTRATEGIAS_CHECKBOX = {
    // --- Estrategias Base y Recomendadas de ESTRATEGIAS_POR_OBJETIVO ---
    // Pérdida de Peso (perdida1)
    'Hiperproteica': 'Hiperproteica',
    'Cetogenica': 'Cetogénica',
    'Baja en HC': 'Baja en Hidratos de Carbono',
    'Carb Cycling': 'Carb Cycling',
    'Refeed Strategy': 'Refeed Strategy',
    'Intermittent Fasting + Cycling': 'Intermittent Fasting + Cycling',
    'Cyclic Ketogenic Diet (CKD)': 'Cyclic Ketogenic Diet (CKD)',
    'Targeted Ketogenic Diet (TKD)': 'Targeted Ketogenic Diet (TKD)',
    'Protein Cycling': 'Protein Cycling',
    'Flexible Dieting Integration': 'Flexible Dieting Integration',

    // Ganancia de Masa Muscular (ganancia1)
    'Hipercalorica': 'Hipercalórica',
    'High Protein + Metabolic Cycling': 'High Protein + Metabolic Cycling',
    'Meal Timing Optimization': 'Meal Timing Optimization',
    'Carb-loading': 'Carb-loading',
    'CKD: 5+2': 'CKD: 5+2',
    'Performance Enhancement': 'Performance Enhancement',

    // Mantenimiento de Peso (mantenimiento1)
    'Equilibrada Nutricional': 'Equilibrada Nutricional',
    'Calorie Cycling': 'Calorie Cycling',
    'Flexible Dieting (80/20)': 'Flexible Dieting (80/20)',
    'Metabolic Flexibility Training': 'Metabolic Flexibility Training',
    'Reverse Dieting': 'Reverse Dieting',
    'Adaptive Periodization': 'Adaptive Periodization',

    // Mixto (mixto1)
    'Ciclado metabólico': 'Ciclado Metabólico',
    'MFT (Keto → moderate carb → high carb)': 'MFT (Keto → moderate carb → high carb)',

    // --- Estrategias Disponibles Originales (de los checkboxes actuales) ---
    'ninguna': 'Ninguna',
    'refeed': 'Refeed',
    'carb_cycling': 'Carb Cycling',
    'protein_cycling': 'Protein Cycling',
    'ckd': 'Cyclic Ketogenic Diet (CKD)',
    'tkd': 'Targeted Ketogenic Diet (TKD)',
    'if_16_8': 'Intermittent Fasting 16:8 (IF 16:8)',
    'timing': 'Timing Nutricional',
    'flexible_dieting': 'Flexible Dieting (80/20)',
    'hiperproteica': 'Dieta Hiperproteica',

    // --- Estrategias Adicionales Potenciales (para futuras expansiones) ---
    // Tipos de dieta
    'keto': 'Dieta Cetogénica',
    'low_carb': 'Baja en Carbohidratos',
    'high_protein': 'Alta en Proteínas',
    'high_fat': 'Alta en Grasas',
    'paleo': 'Dieta Paleo',
    'mediterranean': 'Dieta Mediterránea',
    'vegan': 'Dieta Vegana',
    'vegetarian': 'Dieta Vegetariana',

    // Estrategias de ayuno
    'if_14_10': 'Intermittent Fasting 14:10',
    'if_18_6': 'Intermittent Fasting 18:6',
    'if_20_4': 'Intermittent Fasting 20:4 (OMAD)',
    'alternate_day_fasting': 'Ayuno Intermitente Alterno',
    'extended_fasting': 'Ayuno Extendido',

    // Estrategias de entrenamiento nutricional
    'pre_workout_nutrition': 'Nutrición Pre-Entreno',
    'post_workout_nutrition': 'Nutrición Post-Entreno',
    'intra_workout_nutrition': 'Nutrición Intra-Entreno',
    'fasted_training': 'Entrenamiento en Ayunas',

    // Estrategias de macronutrientes específicos
    'high_protein_low_carb': 'Alta Proteína, Bajo Carbo',
    'high_carb_low_fat': 'Alto Carbo, Baja Grasa',
    'zone_diet': 'Dieta Zona (40-30-30)',
    'ketogenic_ratio': 'Ratio Cetogénico (3:1, 4:1)',

    // Estrategias de timing
    'meal_timing': 'Timing de Comidas',
    'nutrient_timing': 'Timing de Nutrientes',
    'caloric_timing': 'Timing Calórico',

    // Estrategias de flexibilidad
    'cheat_meals': 'Comidas de Engaño',
    'refeeds': 'Refeeds Calóricos',
    'carb_backloading': 'Carb Backloading',
    'fat_backloading': 'Fat Backloading',

    // Estrategias para condiciones específicas
    'diabetes_management': 'Manejo de Diabetes',
    'pcos_friendly': 'Amigable con SOP',
    'heart_health': 'Salud Cardíaca',
    'gut_health': 'Salud Intestinal',
    'immune_support': 'Soporte Inmunológico',

    // Estrategias avanzadas
    'precision_nutrition': 'Nutrición de Precisión',
    'metabolic_confusion': 'Confusión Metabólica',
    'calorie_shifting': 'Shifting Calórico',
    'nutrient_density': 'Densidad Nutricional',
    'micronutrient_optimization': 'Optimización de Micronutrientes',

    // Estrategias de ciclo
    'macro_cycling': 'Ciclado de Macronutrientes',
    'micro_cycling': 'Ciclado de Micronutrientes',
    'periodized_nutrition': 'Nutrición Periodizada',
    'reverse_cycling': 'Ciclado Inverso',

    // Estrategias de control
    'portion_control': 'Control de Porciones',
    'mindful_eating': 'Alimentación Consciente',
    'behavioral_nutrition': 'Nutrición Conductual',
};

//// FUNCIONES DEPENDIENTES  /////

/**
 * Genera el HTML y el contenido para el gráfico de progreso estimado en el modal.
 * @param {Object} datosFaseBase - Los datos base de la fase.
 * @param {number} semanaActual - El número de semana actual dentro del plan.
 * @param {number} pesoEstimadoActual - El peso estimado para la semana actual.
 * @returns {string} El HTML del gráfico de progreso (placeholder o vacío, ya que el canvas se dibuja por JS).
 */
function generarGraficoProgresoHTML(datosFaseBase, semanaActual, pesoEstimadoActual) {
    console.log(`[Modal Avanzado] Generando gráfico de progreso para fase '${datosFaseBase.nombreFase}', semana ${semanaActual}, peso ${pesoEstimadoActual}kg.`);

    try {
        // --- 1. Validar argumentos ---
        if (!datosFaseBase || typeof datosFaseBase !== 'object') {
            throw new Error("datosFaseBase no es un objeto válido.");
        }
        if (isNaN(semanaActual) || semanaActual < 1) {
            throw new Error("semanaActual no es un número válido.");
        }
        if (isNaN(pesoEstimadoActual) || pesoEstimadoActual <= 0) {
            throw new Error("pesoEstimadoActual no es un número válido.");
        }

        // --- 2. Obtener datos base de la fase ---
        const pesoInicioFase = datosFaseBase.pesoInicioFase;
        const pesoFinFase = datosFaseBase.pesoFinFase;
        const totalSemanasFase = datosFaseBase.semanasAsignadas || 12;
        const objetivoUsuario = datosFaseBase.objetivoPrincipal;

        // --- 3. Popular elementos existentes ---
        const elementoPesoInicio = document.getElementById('modalPesoInicioGrafico');
        const elementoPesoActual = document.getElementById('modalPesoActualGrafico');
        const elementoPesoMeta = document.getElementById('modalPesoMetaGrafico');
        const barraProgresoGeneral = document.getElementById('modalBarraProgresoGeneral');

        if (elementoPesoInicio) elementoPesoInicio.textContent = pesoInicioFase.toFixed(1);
        if (elementoPesoActual) elementoPesoActual.textContent = pesoEstimadoActual.toFixed(1);
        if (elementoPesoMeta) elementoPesoMeta.textContent = pesoFinFase.toFixed(1);

        if (barraProgresoGeneral) {
            const progresoPorcentaje = ((pesoInicioFase - pesoEstimadoActual) / (pesoInicioFase - pesoFinFase)) * 100;
            const progresoAjustado = Math.max(0, Math.min(100, progresoPorcentaje)); // Asegurar entre 0 y 100
            barraProgresoGeneral.style.width = `${progresoAjustado.toFixed(2)}%`;
            barraProgresoGeneral.setAttribute('aria-valuenow', progresoAjustado.toFixed(2));
            barraProgresoGeneral.textContent = `Progreso: ${progresoAjustado.toFixed(0)}%`;
        }

        // --- 4. Generar gráfico detallado en canvas ---
        // Esta parte se hará con una función auxiliar que trabaje directamente con el canvas
        // Llamar a la función que dibuja el gráfico en el canvas
        setTimeout(() => {
            dibujarGraficoDetalladoEnCanvas(datosFaseBase, semanaActual, pesoEstimadoActual);
        }, 100); // Pequeño retraso para asegurar que el canvas esté en el DOM

        // --- 5. Devolver HTML placeholder ---
        // Como el gráfico se dibuja en el canvas, no necesitamos devolver HTML complejo aquí.
        // El contenedor y el canvas ya están en el HTML del modal.
        return ''; // O '<p class="text-muted small">Gráfico de evolución cargado.</p>';

    } catch (error) {
        console.error(`[Modal Avanzado] Error al generar el gráfico de progreso para fase '${datosFaseBase?.nombreFase || 'desconocida'}':`, error);
        return '<p class="text-danger small">❌ Error al cargar el gráfico de progreso.</p>';
    }
}

/**
 * Dibuja el gráfico detallado de evolución de peso en el canvas del modal.
 * @param {Object} datosFaseBase - Los datos base de la fase.
 * @param {number} semanaActual - El número de semana actual dentro del plan.
 * @param {number} pesoEstimadoActual - El peso estimado para la semana actual.
 */
function dibujarGraficoDetalladoEnCanvas(datosFaseBase, semanaActual, pesoEstimadoActual) {
    console.log(`[Modal Avanzado] Dibujando gráfico detallado en canvas para fase '${datosFaseBase.nombreFase}', semana ${semanaActual}.`);

    try {
        // --- 1. Obtener el elemento canvas ---
        const canvas = document.getElementById('modalCanvasGraficoDetallado');
        if (!canvas) {
            console.warn("[Modal Avanzado] Canvas para gráfico detallado no encontrado.");
            return;
        }

        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error("[Modal Avanzado] No se pudo obtener el contexto 2D del canvas.");
            return;
        }

        // --- 2. Obtener datos base de la fase ---
        const pesoInicioFase = datosFaseBase.pesoInicioFase;
        const pesoFinFase = datosFaseBase.pesoFinFase;
        const totalSemanasFase = datosFaseBase.semanasAsignadas || 12;
        const objetivoUsuario = datosFaseBase.objetivoPrincipal;

        // --- 3. Generar datos de ejemplo para el gráfico ---
        // En una implementación completa, estos datos vendrían de `calcularTiempoNoLineal`
        // Por ahora, generamos una curva de ejemplo
        const datosGrafico = [];
        for (let s = 1; s <= totalSemanasFase; s++) {
            // Simular una curva no lineal (ej: pérdida que se desacelera)
            const progreso = (s - 1) / (totalSemanasFase - 1);
            // Curva suave (ej: easeOutQuad)
            const progresoSuavizado = 1 - Math.pow(1 - progreso, 2);
            const pesoEnSemana = pesoInicioFase - (pesoInicioFase - pesoFinFase) * progresoSuavizado;
            datosGrafico.push({ semana: s, peso: pesoEnSemana });
        }

        // --- 4. Definir fases para el gráfico (ejemplo) ---
        // En una implementación completa, estas vendrían de `generarFasesEscaladas`
        const fasesParaGrafico = [
            { nombre: 'Fase 1: Inducción', inicio: 1, fin: 4, color: '#28a745' }, // Verde
            { nombre: 'Fase 2: Ciclado', inicio: 5, fin: 8, color: '#17a2b8' }, // Celeste
            { nombre: 'Fase 3: Transición', inicio: 9, fin: 12, color: '#ffc107' } // Amarillo
        ];

        // --- 5. Dibujar el gráfico en el canvas ---
        const ancho = canvas.width;
        const alto = canvas.height;
        const margen = 20;
        const anchoGrafico = ancho - 2 * margen;
        const altoGrafico = alto - 2 * margen;

        // a. Limpiar canvas
        ctx.clearRect(0, 0, ancho, alto);

        // b. Dibujar fondo
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, ancho, alto);

        // c. Encontrar mínimos y máximos para escalar
        const pesos = datosGrafico.map(d => d.peso);
        const pesoMin = Math.min(...pesos);
        const pesoMax = Math.max(...pesos);
        const rangoPeso = pesoMax - pesoMin;
        const semanas = datosGrafico.map(d => d.semana);
        const semanaMin = Math.min(...semanas);
        const semanaMax = Math.max(...semanas);
        const rangoSemana = semanaMax - semanaMin;

        // d. Dibujar ejes
        ctx.strokeStyle = '#6c757d';
        ctx.lineWidth = 1;
        // Eje X (Semanas)
        ctx.beginPath();
        ctx.moveTo(margen, alto - margen);
        ctx.lineTo(ancho - margen, alto - margen);
        ctx.stroke();
        // Eje Y (Peso)
        ctx.beginPath();
        ctx.moveTo(margen, margen);
        ctx.lineTo(margen, alto - margen);
        ctx.stroke();

        // e. Dibujar etiquetas de ejes
        ctx.fillStyle = '#495057';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        // Etiquetas X
        ctx.fillText(`Sem ${semanaMin}`, margen, alto - 5);
        ctx.fillText(`Sem ${semanaMax}`, ancho - margen, alto - 5);
        // Etiquetas Y
        ctx.textAlign = 'right';
        ctx.fillText(`${pesoMax.toFixed(1)}kg`, margen - 5, margen + 5);
        ctx.fillText(`${pesoMin.toFixed(1)}kg`, margen - 5, alto - margen - 5);

        // f. Dibujar áreas de fases
        fasesParaGrafico.forEach(fase => {
            const xInicio = margen + ((fase.inicio - semanaMin) / rangoSemana) * anchoGrafico;
            const xFin = margen + ((fase.fin - semanaMin) / rangoSemana) * anchoGrafico;
            const anchoFase = xFin - xInicio;

            ctx.fillStyle = fase.color + '40'; // Añadir transparencia (40 = 25%)
            ctx.fillRect(xInicio, margen, anchoFase, altoGrafico);

            // Etiqueta de fase (opcional)
            ctx.fillStyle = fase.color;
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(fase.nombre, xInicio + anchoFase / 2, margen + 15);
        });

        // g. Dibujar línea de evolución
        ctx.beginPath();
        ctx.strokeStyle = '#007bff'; // Azul Bootstrap
        ctx.lineWidth = 2;
        datosGrafico.forEach((dato, index) => {
            const x = margen + ((dato.semana - semanaMin) / rangoSemana) * anchoGrafico;
            const y = margen + (1 - (dato.peso - pesoMin) / rangoPeso) * altoGrafico; // Invertir Y

            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        ctx.stroke();

        // h. Dibujar punto actual
        const xActual = margen + ((semanaActual - semanaMin) / rangoSemana) * anchoGrafico;
        const yActual = margen + (1 - (pesoEstimadoActual - pesoMin) / rangoPeso) * altoGrafico; // Invertir Y
        ctx.beginPath();
        ctx.arc(xActual, yActual, 5, 0, Math.PI * 2);
        ctx.fillStyle = '#dc3545'; // Rojo Bootstrap
        ctx.fill();
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // i. Dibujar línea vertical en semana actual
        ctx.beginPath();
        ctx.strokeStyle = '#6c757d';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 3]); // Línea punteada
        ctx.moveTo(xActual, margen);
        ctx.lineTo(xActual, alto - margen);
        ctx.stroke();
        ctx.setLineDash([]); // Resetear estilo de línea

        // j. Popular leyenda (opcional)
        const leyendaElement = document.getElementById('modalLeyendaGraficoDetallado');
        if (leyendaElement) {
            let htmlLeyenda = '<div class="d-flex flex-wrap">';
            fasesParaGrafico.forEach(fase => {
                htmlLeyenda += `
                    <div class="me-3 mb-1">
                        <span class="badge" style="background-color: ${fase.color};">${fase.nombre}</span>
                    </div>
                `;
            });
            htmlLeyenda += `
                <div class="me-3 mb-1">
                    <span class="badge bg-primary">Evolución de Peso</span>
                </div>
                <div class="me-3 mb-1">
                    <span class="badge bg-danger">Día Actual (Sem ${semanaActual})</span>
                </div>
            `;
            htmlLeyenda += '</div>';
            leyendaElement.innerHTML = htmlLeyenda;
        }

        console.log(`[Modal Avanzado] Gráfico detallado dibujado con éxito en canvas para fase '${datosFaseBase.nombreFase}'.`);

    } catch (error) {
        console.error(`[Modal Avanzado] Error al dibujar el gráfico detallado en canvas para fase '${datosFaseBase?.nombreFase || 'desconocida'}':`, error);
        // Opcional: Mostrar mensaje de error en el canvas o en la leyenda
        const canvas = document.getElementById('modalCanvasGraficoDetallado');
        const ctx = canvas?.getContext('2d');
        if (ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#dc3545';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Error al dibujar el gráfico', canvas.width / 2, canvas.height / 2);
        }
    }
}
/**
 * Genera un array de fases escaladas basado en el objetivo y la duración total.
 * @param {string} objetivoUsuario - La clave del objetivo (perdida1, ganancia1, mantenimiento1, mixto1).
 * @param {number} totalSemanasFase - El número total de semanas asignadas a esta fase/objetivo.
 * @returns {Array<Object>} Un array de objetos de fase con duraciones escaladas.
 */
/**
 * Genera un array de fases escaladas basado en el objetivo y la duración total.
 * @param {string} objetivoUsuario - La clave del objetivo (perdida1, ganancia1, mantenimiento1, mixto1).
 * @param {number} totalSemanasFase - El número total de semanas asignadas a esta fase/objetivo.
 * @returns {Array<Object>} Un array de objetos de fase con duraciones y pesos escalados.
 */
/**
 * Genera un array de fases escaladas basado en los datos del progreso no lineal almacenados globalmente.
 * Lee directamente de window.nonlinearProgressData_1.
 * @returns {Array<Object>} Un array de objetos de fase con duraciones y pesos escalados.
 */
function generarFasesEscaladas() {
    console.log(`[Cronograma] Generando fases escaladas usando datos globales de window.nonlinearProgressData_1.`);

    try {
        // --- 1. Validar datos globales ---
        if (!window.nonlinearProgressData_1 || typeof window.nonlinearProgressData_1 !== 'object') {
            console.error("[Cronograma] window.nonlinearProgressData_1 no está definido o no es un objeto válido.");
            return [];
        }

        // --- 2. Obtener datos base del objeto global ---
        const datosGlobales = window.nonlinearProgressData_1;
        const objetivoTipo = datosGlobales.objetivo?.tipo; // "Ganancia" o "Pérdida"
        const totalSemanasFase = datosGlobales.tiempo?.semanasEstimadas; // Número total de semanas
        const pesoInicialFase = datosGlobales.objetivo?.pesoInicial; // Peso inicial del plan
        const pesoFinalFase = datosGlobales.objetivo?.pesoFinal; // Peso final estimado del plan

        if (isNaN(totalSemanasFase) || totalSemanasFase <= 0) {
            console.error("[Cronograma] Total de semanas inválido en window.nonlinearProgressData_1:", totalSemanasFase);
            return [];
        }

        if (pesoInicialFase === undefined || pesoFinalFase === undefined) {
            console.error("[Cronograma] Peso inicial o final no encontrado en window.nonlinearProgressData_1.");
            return [];
        }

        // --- 3. Mapear objetivo a clave de ESTRATEGIAS_POR_OBJETIVO ---
        let claveObjetivoSimple = 'perdida1'; // Valor por defecto
        if (objetivoTipo) {
            if (objetivoTipo.toLowerCase().includes('pérdida')) {
                claveObjetivoSimple = 'perdida1';
            } else if (objetivoTipo.toLowerCase().includes('ganancia')) {
                claveObjetivoSimple = 'ganancia1';
            } else if (objetivoTipo.toLowerCase().includes('mantenimiento')) {
                claveObjetivoSimple = 'mantenimiento1';
            } else {
                console.warn(`[Cronograma] Tipo de objetivo desconocido '${objetivoTipo}'. Usando 'perdida1' por defecto.`);
                claveObjetivoSimple = 'perdida1';
            }
        } else {
            console.warn("[Cronograma] Tipo de objetivo no encontrado en window.nonlinearProgressData_1. Usando 'perdida1' por defecto.");
        }

        console.log(`[Cronograma] Objetivo '${objetivoTipo}' mapeado a clave simple '${claveObjetivoSimple}'. Total semanas: ${totalSemanasFase}`);

        // --- 4. Obtener fases base del catálogo ---
        const estrategiasObjetivo = ESTRATEGIAS_POR_OBJETIVO[claveObjetivoSimple];
        if (!estrategiasObjetivo || !Array.isArray(estrategiasObjetivo.fases) || estrategiasObjetivo.fases.length === 0) {
            console.error(`[Cronograma] No se encontraron fases para el objetivo '${claveObjetivoSimple}' en ESTRATEGIAS_POR_OBJETIVO.`);
            return [];
        }

        let fasesBase = [...estrategiasObjetivo.fases]; // Copia para no mutar el original

        // --- 5. Aplicar ajustes dinámicos basados en la duración total ---
        if (claveObjetivoSimple === 'perdida1' && totalSemanasFase < 12) {
            // Para pérdida, si es muy corto, quitar Fase 3 (Transición a Mantenimiento)
            console.log("[Cronograma] Duración corta para 'perdida1'. Eliminando Fase 3 (Transición a Mantenimiento).");
            fasesBase = fasesBase.filter(fase => fase.nombre !== 'Fase 3: Transición a Mantenimiento');
        } else if (claveObjetivoSimple === 'ganancia1' && totalSemanasFase < 8) {
            // Para ganancia, si es muy corto, quitar Fase 1 (Evaluación y Base)
            console.log("[Cronograma] Duración corta para 'ganancia1'. Eliminando Fase 1 (Evaluación y Base).");
            fasesBase = fasesBase.filter(fase => fase.nombre !== 'Fase 1: Evaluación y Base');
        } else if (claveObjetivoSimple === 'mantenimiento1' && totalSemanasFase < 8) {
            // Para mantenimiento, si es muy corto, quitar Subfase 1 (Transición al Mantenimiento)
            console.log("[Cronograma] Duración corta para 'mantenimiento1'. Eliminando Subfase 1 (Transición al Mantenimiento).");
            fasesBase = fasesBase.filter(fase => fase.nombre !== 'Subfase 1: Transición al Mantenimiento');
        } else if (claveObjetivoSimple === 'mixto1' && totalSemanasFase < 20) {
            // Para mixto, si es muy corto, quitar Fase 4 y 5 (Ajuste Dinámico y Continuación Sostenible)
            console.log("[Cronograma] Duración corta para 'mixto1'. Eliminando Fase 4 (Ajuste Dinámico) y Fase 5 (Continuación Sostenible).");
            fasesBase = fasesBase.filter(fase => 
                fase.nombre !== 'Fase 4: Ajuste Dinámico' && 
                fase.nombre !== 'Fase 5: Continuación Sostenible'
            );
        }

        if (fasesBase.length === 0) {
            console.error(`[Cronograma] Después de aplicar ajustes dinámicos, no quedan fases para el objetivo '${claveObjetivoSimple}'.`);
            return [];
        }

        // --- 6. Calcular duración escalada para las fases restantes ---
                // --- 4. Calcular duración escalada para las fases restantes ---
        // a. Obtener ratios de duración REAL de las fases base y validarlos
        const ratios = fasesBase.map(fase => {
            // Asegurarse de que fase.duracionSemanas sea un número válido
            const ratio = parseFloat(fase.duracionSemanas);
            if (isNaN(ratio) || ratio <= 0) {
                console.warn(`[Cronograma] Ratio inválido encontrado para fase '${fase.nombre}':`, fase.duracionSemanas, ". Usando 1 como fallback.");
                return 1; // Fallback
            }
            return ratio;
        });
        console.log(`[Cronograma] Ratios de duración para ${claveObjetivoSimple}:`, ratios);

        // b. Calcular suma total de ratios
        const sumaRatios = ratios.reduce((acc, ratio) => acc + ratio, 0);
        console.log(`[Cronograma] Suma total de ratios: ${sumaRatios}`);

        // c. Distribuir semanas totales y pesos proporcionalmente
        let semanasAcumuladas = 0;
        let pesoAcumulado = 0; // Variable para llevar la cuenta del cambio de peso
        // Obtener peso inicial y final del PLAN COMPLETO
        let pesoInicialPlan = 0;
        let pesoFinalPlan = 0;
        try {
            if (window.nonlinearProgressData_1 && window.nonlinearProgressData_1.objetivo) {
                pesoInicialPlan = window.nonlinearProgressData_1.objetivo.pesoInicial;
                pesoFinalPlan = window.nonlinearProgressData_1.objetivo.pesoFinal;
                console.log(`[Cronograma] Pesos del PLAN COMPLETO obtenidos de nonlinearProgressData_1: Inicio=${pesoInicialPlan}kg, Fin=${pesoFinalPlan}kg`);
            } else {
                // Fallback: Usar de datosFaseBase o de la fila original
                pesoInicialPlan = datosFaseBase.pesoInicioFase;
                pesoFinalPlan = datosFaseBase.pesoFinFase;
                console.warn(`[Cronograma] nonlinearProgressData_1 no disponible. Usando pesos de datosFaseBase: Inicio=${pesoInicialPlan}kg, Fin=${pesoFinalPlan}kg`);
            }
        } catch (e) {
            console.error(`[Cronograma] Error al obtener pesos del plan:`, e);
            // Valores por defecto
            pesoInicialPlan = datosFilaOriginal.pesoEstimado; // Peso actual de la fila
            pesoFinalPlan = pesoInicialPlan - 10; // Ejemplo de pérdida
        }
        const diferenciaPesoTotal = pesoFinalPlan - pesoInicialPlan;

        const fasesEscaladas = fasesBase.map((fase, index) => {
            // --- Calcular semanas asignadas a esta fase basadas en el ratio REAL ---
            const semanasParaEstaFase = Math.round((ratios[index] / sumaRatios) * totalSemanasFase);
            
            // --- Asegurar un mínimo de 1 semana por fase, si es posible ---
            const semanasAsignadas = Math.max(1, semanasParaEstaFase);

            // --- Calcular rango de semanas para esta fase ---
            const semanaInicio = semanasAcumuladas + 1;
            const semanaFin = semanasAcumuladas + semanasAsignadas;
            const semanasTexto = `${semanaInicio}–${semanaFin}`;

            // --- Calcular pesos estimados para esta fase ---
            // Distribuir el cambio de peso total proporcionalmente al número de semanas asignadas
            const cambioPesoParaEstaFase = (semanasAsignadas / totalSemanasFase) * diferenciaPesoTotal;
            const pesoInicioFaseItem = pesoInicialPlan + pesoAcumulado;
            const pesoFinFaseItem = pesoInicioFaseItem + cambioPesoParaEstaFase;
            pesoAcumulado += cambioPesoParaEstaFase;

            semanasAcumuladas += semanasAsignadas;

            // --- Devolver una copia del objeto fase con la duración escalada, el rango de semanas y los pesos ---
            return {
                ...fase,
                duracionSemanas: semanasAsignadas,
                semanasTexto: semanasTexto,
                pesoInicioFase: parseFloat(pesoInicioFaseItem.toFixed(2)),
                pesoFinFase: parseFloat(pesoFinFaseItem.toFixed(2))
            };
        });

        // d. Ajustar posibles errores de redondeo para que la suma sea exactamente totalSemanasFase
        const semanasTotalesAsignadas = fasesEscaladas.reduce((acc, fase) => acc + fase.duracionSemanas, 0);
        const diferencia = totalSemanasFase - semanasTotalesAsignadas;
        if (Math.abs(diferencia) > 0.1 && fasesEscaladas.length > 0) {
            // Añadir o restar la diferencia a la última fase
            const ultimaFase = fasesEscaladas[fasesEscaladas.length - 1];
            ultimaFase.duracionSemanas += diferencia;
            // Recalcular semanasTexto para la última fase
            const semanaInicioUltima = semanasTotalesAsignadas - (fasesEscaladas[fasesEscaladas.length - 2]?.duracionSemanas || 0) + 1;
            const semanaFinUltima = semanaInicioUltima + ultimaFase.duracionSemanas - 1;
            ultimaFase.semanasTexto = `${semanaInicioUltima}–${semanaFinUltima}`;
            console.log(`[Cronograma] Ajustando última fase por diferencia de redondeo: ${diferencia} semanas.`);
        }	
        console.log(`[Cronograma] Fases escaladas generadas con éxito usando datos globales para objetivo '${claveObjetivoSimple}':`, fasesEscaladas);
        return fasesEscaladas;

    } catch (error) {
        console.error(`[Cronograma] Error al generar fases escaladas usando datos globales:`, error);
        return [];
    }
}
/**
 * Popula la sección "📊 Recordatorio de la Evolución" del modal con datos dinámicos.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 */
/**
 * Popula la sección "📊 Recordatorio de la Evolución" del modal con datos dinámicos.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 */
 
function popularSeccionRecordatorioEvolucion(indiceFila) {
    console.log(`[Modal Avanzado] Popular sección de Recordatorio de Evolución para fila: ${indiceFila}`);

    try {
        // --- 1. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`[Modal Avanzado] No se encontró la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`[Modal Avanzado] No se encontró la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 2. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;

        // Encontrar los datos originales específicos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
             console.error(`[Modal Avanzado] Índice de día inválido en 'data-indice-fila': ${indiceFila}`);
             return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
             console.error(`[Modal Avanzado] No se encontraron datos originales para el día ${indiceDiaArray} en la fila ${indiceFila}.`);
             return;
        }

        // --- 3. Calcular información dinámica ---
        // a. Fase Actual (ya la tenemos de datosFaseBase)
        const faseActual = datosFaseBase.nombreFase;

        // b. Semana/Día Actual (desde el índice de la fila)
        const mes = parseInt(partesIndice[0], 10);
        const semana = parseInt(partesIndice[1], 10);
        const dia = parseInt(partesIndice[2], 10);
        const diaActual = datosFilaOriginal.dia; // Nombre del día (Lunes, Martes, etc.)
        const diaNumero = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'].indexOf(diaActual) + 1;
		const semanaActual = semana;
		
        // c. Total de Semanas en el PLAN COMPLETO (NO solo en la fase actual)
        // Cambio crucial: Usar el totalSemanasFase del plan completo, no de la fase mes 1-2
        let totalSemanasFase = 0;
        try {
            // ACCESO CORRECTO: Usar nonlinearProgressData_1.tiempo.semanasEstimadas
            if (window.nonlinearProgressData_1 && window.nonlinearProgressData_1.tiempo && window.nonlinearProgressData_1.tiempo.semanasEstimadas) {
                totalSemanasFase = window.nonlinearProgressData_1.tiempo.semanasEstimadas;
                console.log(`[Modal Avanzado] Total de semanas del PLAN COMPLETO obtenido de nonlinearProgressData_1: ${totalSemanasFase}`);
            } else {
                // Fallback: Intentar calcular desde datosFaseBase.mesesTexto si nonlinearProgressData_1 no está disponible
                const meses = datosFaseBase.mesesTexto.split('–').map(m => parseInt(m.trim()));
                const mesInicio = meses[0];
                const mesFin = meses.length > 1 ? meses[1] : mesInicio;
                totalSemanasFase = Math.round((mesFin - mesInicio + 1) * 4.34524);
                if (totalSemanasFase <= 0) {
                    throw new Error("Número de semanas inválido calculado desde mesesTexto.");
                }
                console.warn(`[Modal Avanzado] nonlinearProgressData_1 no disponible. Usando cálculo desde mesesTexto: ${totalSemanasFase} semanas.`);
            }
        } catch (e) {
            console.error(`[Modal Avanzado] Error al calcular totalSemanasFase:`, e);
            // Valor por defecto seguro
            totalSemanasFase = datosFaseBase.semanasAsignadas || 12;
        }

        // d. Días Restantes en la Fase
        // Calcular día global (1-97) dentro de la fase
        const semanasPorMes = 4.34524;
        const semanaGlobal = Math.floor((mes - 1) * semanasPorMes) + semana;
        const diaGlobal = ((semanaGlobal - 1) * 7) + diaNumero;
        const totalDiasFase = totalSemanasFase * 7;
        const diasRestantesFase = totalDiasFase - diaGlobal;

        // e. Peso Estimado Actual (desde datosFilaOriginal)
        const pesoEstimadoActual = datosFilaOriginal.pesoEstimado;

        // f. Peso Inicial y Final de la Fase (desde datosFaseBase)
        const pesoInicialFase = datosFaseBase.pesoInicioFase;
        const pesoFinalFase = datosFaseBase.pesoFinFase;
        const cambioPesoAcumulado = pesoInicialFase - pesoEstimadoActual; // Para pérdida, será positivo

        // g. Velocidad de Cambio (semanal, respecto al inicio de la fase)
        // Asumimos una duración promedio de semana para calcular una velocidad instantánea
        const velocidadCambioSemanal = (cambioPesoAcumulado / (semanaGlobal - 1 + (diaNumero / 7))) || 0; // kg/semana

        // h. Próximo Cambio de Fase (estimado)
        // Asumimos que el cambio de fase ocurre al finalizar las semanas de la fase actual
        const semanasRestantesFase = totalSemanasFase - semanaActual;
        const proximoCambioFase = `En ${semanasRestantesFase} semanas (Semana ${totalSemanasFase + 1})`;

        // i. Próxima Reevaluación
        // Asumimos reevaluación cada 12 semanas, o 8 si es más corto
        const intervaloReevaluacion = 12; // semanas
        const proximaReevaluacionSemanas = Math.ceil(semanaActual / intervaloReevaluacion) * intervaloReevaluacion;
        const proximaReevaluacion = `Semana ${proximaReevaluacionSemanas} - Parámetros fisiológicos`;

                // --- 4. Generar HTML del Cronograma Dinámico ---
        console.log(`[Modal Avanzado] Generando cronograma para fila ${indiceFila}. Datos:`, { datosFaseBase, semanaActual });
        let htmlCronograma = '<p class="text-muted">Cargando cronograma...</p>';
        
        if (typeof generarCronogramaHTML === 'function') {
            try {
                htmlCronograma = generarCronogramaHTML(datosFaseBase, semanaActual);
                console.log(`[Modal Avanzado] HTML del cronograma generado con éxito para fila ${indiceFila}:`, htmlCronograma.substring(0, 200) + '...'); // Mostrar solo los primeros 200 caracteres
            } catch (e) {
                console.error(`[Modal Avanzado] Error al ejecutar generarCronogramaHTML para fila ${indiceFila}:`, e);
                // --- MOVIDO AQUÍ: Contenido estático como fallback en caso de error ---
                htmlCronograma = `<ul class="mb-0 ps-3 small">
                    <li><strong>Semanas 1-12:</strong> Déficit moderado (~500 kcal/día) con estrategias proactivas
                        <ul class="ps-3">
                            <li>Semanas 1-4: Ciclado calórico, alta proteína, NEAT</li>
                            <li>Semanas 5-8: Carb cycling, entrenamiento fuerza</li>
                            <li>Semanas 9-12: Flexible dieting, optimización sueño</li>
                        </ul>
                    </li>
                    <li><strong>Semanas 13-14:</strong> Fase de mantenimiento planificada
                        <ul class="ps-3">
                            <li>Semanas 13-14: TDEE completo, refeed estratégico</li>
                        </ul>
                    </li>
                    <li><strong>Semanas 15-26:</strong> Ajuste dinámico según progreso
                        <ul class="ps-3">
                            <li>Semanas 15-18: Aumentar déficit si < 0.2 kg/semana</li>
                            <li>Semanas 19-22: Protein cycling, refeeds semanales</li>
                            <li>Semanas 23-26: Evaluación completa</li>
                        </ul>
                    </li>
                    <li><strong>Semanas 27-97:</strong> Continuación con monitoreo proactivo
                        <ul class="ps-3">
                            <li>Semanas 27-36: Ciclos 4 semanas + 1 mantenimiento</li>
                            <li>Semanas 37-48: Ajustes mensuales TDEE</li>
                            <li>Semanas 49-97: Enfoque sostenibilidad</li>
                        </ul>
                    </li>
                </ul>`;
                // --- FIN DE MOVIDO AQUÍ ---
            }
        } else {
            console.warn("[Modal Avanzado] Función 'generarCronogramaHTML' no encontrada. Se usará contenido estático.");
            // --- MOVIDO AQUÍ: Contenido estático como fallback cuando la función no existe ---
            htmlCronograma = `<ul class="mb-0 ps-3 small">
                <li><strong>Semanas 1-12:</strong> Déficit moderado (~500 kcal/día) con estrategias proactivas
                    <ul class="ps-3">
                        <li>Semanas 1-4: Ciclado calórico, alta proteína, NEAT</li>
                        <li>Semanas 5-8: Carb cycling, entrenamiento fuerza</li>
                        <li>Semanas 9-12: Flexible dieting, optimización sueño</li>
                    </ul>
                </li>
                <li><strong>Semanas 13-14:</strong> Fase de mantenimiento planificada
                    <ul class="ps-3">
                        <li>Semanas 13-14: TDEE completo, refeed estratégico</li>
                    </ul>
                </li>
                <li><strong>Semanas 15-26:</strong> Ajuste dinámico según progreso
                    <ul class="ps-3">
                        <li>Semanas 15-18: Aumentar déficit si < 0.2 kg/semana</li>
                        <li>Semanas 19-22: Protein cycling, refeeds semanales</li>
                        <li>Semanas 23-26: Evaluación completa</li>
                    </ul>
                </li>
                <li><strong>Semanas 27-97:</strong> Continuación con monitoreo proactivo
                    <ul class="ps-3">
                        <li>Semanas 27-36: Ciclos 4 semanas + 1 mantenimiento</li>
                        <li>Semanas 37-48: Ajustes mensuales TDEE</li>
                        <li>Semanas 49-97: Enfoque sostenibilidad</li>
                    </ul>
                </li>
            </ul>`;
            // --- FIN DE MOVIDO AQUÍ ---
        }
        

        // --- 5. Generar HTML del Gráfico de Progreso (Placeholder) ---
        let htmlGrafico = '<p class="mb-0 text-muted"><i class="fas fa-chart-line me-1"></i> Gráfico de progreso estimado</p>';
        if (typeof generarGraficoProgresoHTML === 'function') {
            htmlGrafico = generarGraficoProgresoHTML(datosFaseBase, semanaActual, pesoEstimadoActual);
        } else {
            console.warn("[Modal Avanzado] Función 'generarGraficoProgresoHTML' no encontrada. Se usará placeholder.");
            // Placeholder: Gráfico de línea simple con CSS o canvas
            htmlGrafico = `<div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" role="progressbar"
                     style="width: ${(semanaActual / totalSemanasFase * 100).toFixed(2)}%"
                     aria-valuenow="${semanaActual}" aria-valuemin="0" aria-valuemax="${totalSemanasFase}">
                    ${semanaActual}/${totalSemanasFase} semanas
                </div>
            </div>
            <div class="d-flex justify-content-between small mt-1">
                <span>${pesoInicialFase.toFixed(1)} kg</span>
                <span>${pesoEstimadoActual.toFixed(1)} kg</span>
                <span>${pesoFinalFase.toFixed(1)} kg</span>
            </div>`;
			
			// b. Cronograma Dinámico
			const contenedorCronograma = document.getElementById('modalCronogramaDinamico');
			if (contenedorCronograma) {
				console.log(`[Modal Avanzado] Insertando HTML del cronograma en el contenedor para fila ${indiceFila}.`);
				contenedorCronograma.innerHTML = htmlCronograma;
			} else {
				console.error("[Modal Avanzado] Contenedor '#modalCronogramaDinamico' no encontrado en el modal.");
			}
        }
		
			
			
        // --- 6. Popular elementos del DOM ---
        // a. Información de Progreso
        document.getElementById('modalFaseActual').textContent = faseActual;
        document.getElementById('modalSemanaActual').textContent = semanaActual;
        document.getElementById('modalTotalSemanas').textContent = totalSemanasFase;
        document.getElementById('modalDiaActual').textContent = diaActual;
        document.getElementById('modalDiasRestantesFase').textContent = diasRestantesFase > 0 ? diasRestantesFase : 0;

        // b. Cronograma Dinámico
        const contenedorCronograma = document.getElementById('modalCronogramaDinamico');
        if (contenedorCronograma) {
            contenedorCronograma.innerHTML = htmlCronograma;
        console.log(`[Modal Avanzado] Cronograma insertado en el DOM para fila ${indiceFila}.`);
		} else {
			console.error("[Modal Avanzado] Contenedor '#modalCronogramaDinamico' no encontrado en el modal.");
		}

        // c. Gráfico de Progreso
        const contenedorGrafico = document.getElementById('modalGraficoProgreso');
        if (contenedorGrafico) {
            contenedorGrafico.innerHTML = htmlGrafico;
        }

        // d. Información de Cambio de Fase
        document.getElementById('modalInfoCambioFase').textContent = proximoCambioFase;

        
		// e. Reevaluación
		const elementoProximaReevaluacion = document.getElementById('modalProximaReevaluacion'); // <-- ID CORRECTO del span
		if (elementoProximaReevaluacion) {
			elementoProximaReevaluacion.textContent = `Semana ${proximaReevaluacionSemanas} - Parámetros fisiológicos`;
		} else {
			console.warn("[Modal Avanzado] Elemento con id 'modalProximaReevaluacion' no encontrado en el modal.");
		}
		
// --- Fin de líneas corregidas ---
        console.log(`[Modal Avanzado] Sección de Recordatorio de Evolución popularizada con éxito para fila ${indiceFila}.`);
        console.log({
            faseActual,
            semanaActual,
            totalSemanasFase,
            diaActual,
            diasRestantesFase,
            pesoEstimadoActual,
            pesoInicialFase,
            pesoFinalFase,
            cambioPesoAcumulado,
            velocidadCambioSemanal,
            proximoCambioFase,
            proximaReevaluacion
        });

    } catch (error) {
        console.error(`[Modal Avanzado] Error al popular la sección de Recordatorio de Evolución para fila ${indiceFila}:`, error);
        // Opcional: Mostrar mensaje de error al usuario
        // alert("Hubo un error al cargar la información de evolución. Por favor, inténtalo de nuevo.");
    }
}

// --- Funciones auxiliares para generar contenido dinámico (placeholders) ---

/**
 * Genera el HTML para el cronograma dinámico basado en la fase y la semana actual.
 * @param {Object} datosFaseBase - Los datos base de la fase.
 * @param {number} semanaActual - El número de semana actual dentro del plan.
 * @returns {string} El HTML del cronograma.
 */
/**
 * Genera el HTML para el cronograma dinámico basado en la fase y la semana actual.
 * @param {Object} datosFaseBase - Los datos base de la fase.
 * @param {number} semanaActual - El número de semana actual dentro del plan.
 * @returns {string} El HTML del cronograma.
 */
function generarCronogramaHTML(datosFaseBase, semanaActual) {
    console.log(`[Modal Avanzado] Generando cronograma HTML para fase '${datosFaseBase.nombreFase}' y semana ${semanaActual}.`);

    try {
        // --- 1. Validar argumentos ---
        if (!datosFaseBase || typeof datosFaseBase !== 'object') {
            console.error("[Modal Avanzado] datosFaseBase no es un objeto válido en generarCronogramaHTML.", datosFaseBase);
            return '<p class="text-danger">❌ Error: Datos de fase inválidos para generar el cronograma.</p>';
        }
        if (isNaN(semanaActual) || semanaActual < 1) {
            console.error("[Modal Avanzado] semanaActual no es un número válido en generarCronogramaHTML.", semanaActual);
            return '<p class="text-danger">❌ Error: Semana actual inválida para generar el cronograma.</p>';
        }

                // --- 2. Obtener información de contexto y mapear objetivo ---
				// a. Obtener el objetivo principal descriptivo de la FASE BASE
				const objetivoFaseBaseDescriptivo = datosFaseBase.objetivoPrincipal; // Ej: "Reset metabólico, inicio de pérdida de grasa, reducción de insulina"
				
				// b. Mapear objetivo descriptivo a la clave del catálogo ESTRATEGIAS_POR_OBJETIVO
				let claveObjetivoSimple = 'perdida1'; // Valor por defecto
				let objetivoEncontrado = false;
				for (const [claveSimple, palabrasClave] of Object.entries(MAPEO_OBJETIVO_A_SIMPLE)) {
					if (palabrasClave.some(palabra => objetivoFaseBaseDescriptivo.toLowerCase().includes(palabra.toLowerCase()))) {
						claveObjetivoSimple = claveSimple;
						objetivoEncontrado = true;
						break;
					}
				}
				
				if (!objetivoEncontrado) {
					console.warn(`[Modal Avanzado] Objetivo descriptivo '${objetivoFaseBaseDescriptivo}' no mapeado. Usando 'perdida1' por defecto.`);
					claveObjetivoSimple = 'perdida1'; // Fallback
				}
				
				const objetivoUsuario = claveObjetivoSimple; // <-- Esta es la clave correcta para ESTRATEGIAS_POR_OBJETIVO
				console.log(`[Modal Avanzado] Generando cronograma HTML para fase '${datosFaseBase.nombreFase}' y semana ${semanaActual}.`);
				// console.log(`[Modal Avanzado] IndiceFila (si existiera): ${indiceFila}`); // <-- Comentado o eliminado

				const nombreFase = datosFaseBase.nombreFase; // "Fase 1: Inducción Cetogénica"
				const mesesTexto = datosFaseBase.mesesTexto; // "1–2"
				const totalSemanasFase = datosFaseBase.semanasAsignadas || 12; // Número total de semanas asignadas a esta fase

					// --- 3. Generar fases escaladas ---
				const fasesEscaladas = generarFasesEscaladas(); // <-- Sin argumentos
				if (!fasesEscaladas || fasesEscaladas.length === 0) {
					console.warn(`[Modal Avanzado] No se generaron fases escaladas usando datos globales.`);
					return '<p class="text-muted">No hay fases definidas o datos insuficientes.</p>';
				}

        // --- 4. Generar HTML del cronograma ---
        let htmlCronograma = '<div class="cronograma-dinamico-wrapper">'; // Contenedor para el cronograma

        fasesEscaladas.forEach((fase, index) => {
            // --- a. Extraer información de la fase ---
            const nombreFaseItem = fase.nombre || `Fase ${index + 1}`;
            const objetivoFaseItem = fase.objetivoPrincipal || 'Objetivo no especificado';
            const duracionSemanasItem = fase.duracionSemanas || 0;
            const semanasTextoItem = fase.semanasTexto || 'Semanas no especificadas';
            // --- CORRECCIÓN: Asegurar que pesoInicioFase y pesoFinFase estén definidos ---
            const pesoInicioFaseItem = fase.pesoInicioFase !== undefined ? fase.pesoInicioFase.toFixed(1) : 'N/A';
            const pesoFinFaseItem = fase.pesoFinFase !== undefined ? fase.pesoFinFase.toFixed(1) : 'N/A';
            // --- FIN DE CORRECCIÓN ---
            const observacionesItem = fase.observaciones || 'Sin observaciones.';
            
            // --- b. Parsear macros base promedio de la fase ---
            const parsearRangoPorcentaje = (rangoStr) => {
                if (!rangoStr || typeof rangoStr !== 'string') return [25, 25];
                const partes = rangoStr.replace('%', '').split('-').map(Number);
                return partes.length === 2 ? partes : [partes[0], partes[0]];
            };

            let rangoProteinasPct = [25, 25];
            let rangoCarbohidratosPct = [40, 40];
            let rangoGrasasPct = [35, 35];
            try {
                rangoProteinasPct = parsearRangoPorcentaje(fase.macrosBase.proteinasPct);
                rangoCarbohidratosPct = parsearRangoPorcentaje(fase.macrosBase.carbohidratosPct);
                rangoGrasasPct = parsearRangoPorcentaje(fase.macrosBase.grasasPct);
            } catch (e) {
                console.warn("Error al parsear rangos de macros de la fase, usando valores por defecto.", e);
            }

            const proteinasPctPromedio = Math.round((rangoProteinasPct[0] + rangoProteinasPct[1]) / 2);
            const carbohidratosPctPromedio = Math.round((rangoCarbohidratosPct[0] + rangoCarbohidratosPct[1]) / 2);
            const grasasPctPromedio = 100 - proteinasPctPromedio - carbohidratosPctPromedio;

            // --- c. Calcular progreso dentro de esta fase ---
            // Parsear semanasTextoItem para obtener semanaInicio y semanaFin
            let semanaInicioFase = 1;
            let semanaFinFase = duracionSemanasItem;
            try {
                const partesSemanas = semanasTextoItem.split('–').map(Number);
                if (partesSemanas.length === 2) {
                    semanaInicioFase = partesSemanas[0];
                    semanaFinFase = partesSemanas[1];
                }
            } catch (e) {
                console.warn(`[Modal Avanzado] Error al parsear semanasTextoItem '${semanasTextoItem}' para fase '${nombreFaseItem}'. Usando valores por defecto.`, e);
            }

            const totalSemanasFaseItem = semanaFinFase - semanaInicioFase + 1;
            
            // Determinar si la semanaActual está dentro del rango de esta fase
            const esFaseActual = semanaActual >= semanaInicioFase && semanaActual <= semanaFinFase;
            
            // Calcular porcentaje de progreso dentro de esta fase
            let progresoFaseItem = 0;
            if (esFaseActual) {
                // Si es la fase actual, calcular progreso basado en la semana actual
                progresoFaseItem = ((semanaActual - semanaInicioFase + 1) / totalSemanasFaseItem) * 100;
            } else if (semanaActual > semanaFinFase) {
                // Si la semana actual es posterior, la fase está completada
                progresoFaseItem = 100;
            } else {
                // Si la semana actual es anterior, la fase aún no ha comenzado
                progresoFaseItem = 0;
            }
            
            // Asegurar que el porcentaje esté entre 0 y 100
            progresoFaseItem = Math.max(0, Math.min(100, progresoFaseItem));

            // --- d. Construir HTML para esta fase ---
            // Clase CSS para resaltar la fase actual
            const claseFaseActual = esFaseActual ? 'fase-actual' : '';
            
            htmlCronograma += `
                <div class="mb-3 p-2 border rounded ${claseFaseActual}" style="background-color: ${esFaseActual ? '#e8f5e9' : '#f8f9fa'};">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-primary ${esFaseActual ? 'fw-bold' : ''}">${nombreFaseItem}</h6>
                        <span class="badge bg-secondary">${semanasTextoItem}</span>
                    </div>
                    <p class="mb-1 small text-muted"><strong>Objetivo:</strong> ${objetivoFaseItem}</p>
                    <p class="mb-1 small"><strong>Duración:</strong> ${duracionSemanasItem} semanas</p>
                    <p class="mb-1 small"><strong>Peso:</strong> ${pesoInicioFaseItem} kg → ${pesoFinFaseItem} kg</p>
                    <p class="mb-2 small"><strong>Macros Base:</strong> Pt: ${proteinasPctPromedio}%, CH: ${carbohidratosPctPromedio}%, GR: ${grasasPctPromedio}%</p>
                    
                    <div class="progress mb-1" style="height: 15px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: ${progresoFaseItem.toFixed(2)}%" 
                             aria-valuenow="${progresoFaseItem.toFixed(2)}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${progresoFaseItem > 0 ? `${progresoFaseItem.toFixed(0)}%` : ''}
                        </div>
                    </div>
                </div>
            `;
        });

        htmlCronograma += '</div>'; // Cerrar contenedor

        console.log(`[Modal Avanzado] Cronograma HTML generado con éxito para fase '${nombreFase}' y semana ${semanaActual}.`);
        return htmlCronograma;

    } catch (error) {
        console.error(`[Modal Avanzado] Error al generar el cronograma HTML para fase '${datosFaseBase?.nombreFase || 'desconocida'}' y semana ${semanaActual}:`, error);
        return '<p class="text-danger">❌ Error al generar el cronograma. Por favor, inténtalo de nuevo.</p>';
    }
}

/**
 * Genera el HTML para el gráfico de progreso estimado.
 * @param {Object} datosFaseBase - Los datos base de la fase.
 * @param {number} semanaActual - El número de semana actual.
 * @param {number} pesoEstimadoActual - El peso estimado actual.
 * @returns {string} El HTML del gráfico.
 */
function generarGraficoProgresoHTML(datosFaseBase, semanaActual, pesoEstimadoActual) {
    // Placeholder: Usar una barra de progreso simple de Bootstrap
    const pesoInicial = datosFaseBase.pesoInicioFase;
    const pesoFinal = datosFaseBase.pesoFinFase;
    const totalSemanas = datosFaseBase.semanasAsignadas || 12; // Asumir 12 si no está

    // Calcular porcentaje completado
    const pctCompletado = (semanaActual / totalSemanas) * 100;
    const pctCompletadoLimitado = Math.min(100, Math.max(0, pctCompletado)); // Limitar entre 0 y 100

    return `
        <div class="progress" style="height: 20px;">
          <div class="progress-bar bg-success" role="progressbar" 
               style="width: ${pctCompletadoLimitado.toFixed(2)}%" 
               aria-valuenow="${semanaActual}" aria-valuemin="0" aria-valuemax="${totalSemanas}">
            ${semanaActual}/${totalSemanas} semanas
          </div>
        </div>
        <div class="d-flex justify-content-between small mt-1">
          <span>${pesoInicial.toFixed(1)} kg (Inicio)</span>
          <span>${pesoEstimadoActual.toFixed(1)} kg (Actual)</span>
          <span>${pesoFinal.toFixed(1)} kg (Objetivo)</span>
        </div>
    `;
}
/**
 * Crea el HTML para la fila de configuración de macros de una estrategia específica.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 * @returns {HTMLElement|null} El elemento div que representa la fila de configuración, o null si hay error.
 */
function crearFilaConfiguracionEstrategia(indiceFila, nombreEstrategia) {
    if (!indiceFila || !nombreEstrategia) {
        console.error("Error: Faltan parámetros para crear la fila de configuración de estrategia.");
        return null;
    }

    const idBase = `${indiceFila}_${nombreEstrategia.replace(/\s+/g, '_')}`;
    const filaConfigId = `fila-config-${idBase}`;

    // Crear el contenedor de la fila
    const divFila = document.createElement('div');
    divFila.className = 'border rounded p-3 mb-3 bg-white shadow-sm fila-configuracion-estrategia'; // Clase CSS del CSS proporcionado
    divFila.setAttribute('data-estrategia-id', nombreEstrategia); // Para identificar la estrategia
    divFila.id = filaConfigId;

    // Crear el encabezado de la fila (nombre + botón cerrar)
    const divHeader = document.createElement('div');
    divHeader.className = 'd-flex justify-content-between align-items-center mb-2';

    const h6Nombre = document.createElement('h6');
    h6Nombre.className = 'mb-0 text-primary nombre-estrategia'; // Clase CSS del CSS proporcionado
    h6Nombre.textContent = nombreEstrategia;

    const botonCerrar = document.createElement('button');
    botonCerrar.type = 'button';
    botonCerrar.className = 'btn-close boton-cerrar-fila-estrategia'; // Clase CSS del CSS proporcionado
    botonCerrar.setAttribute('aria-label', 'Eliminar');
    botonCerrar.title = 'Eliminar estrategia';
    // Añadir evento para eliminar esta fila específica y desmarcar el checkbox
    botonCerrar.addEventListener('click', function() {
        const filaAEliminar = document.getElementById(filaConfigId);
        if (filaAEliminar) {
            filaAEliminar.remove();
            // Desmarcar el checkbox correspondiente
            const checkboxId = `modalCheckbox_${nombreEstrategia.replace(/\s+/g, '_')}`;
            const checkboxCorrespondiente = document.getElementById(checkboxId);
            if (checkboxCorrespondiente) {
                checkboxCorrespondiente.checked = false;
            }
            // Mostrar/Ocultar mensaje de "sin estrategias" si no quedan más
            const contenedorConfig = document.getElementById('modalConfiguracionMacrosPorEstrategia');
            const mensajeSinEstrategias = document.getElementById('modalMensajeSinEstrategias');
            if (mensajeSinEstrategias && contenedorConfig && contenedorConfig.children.length === 0) {
                mensajeSinEstrategias.style.display = 'block';
            }
        }
    });

    divHeader.appendChild(h6Nombre);
    divHeader.appendChild(botonCerrar);
    divFila.appendChild(divHeader);

    // Crear el grupo de inputs de macros
    const divGrupoMacros = document.createElement('div');
    divGrupoMacros.className = 'row g-2 align-items-end grupo-macros-estrategia'; // Clase CSS del CSS proporcionado

    // Input Proteínas
    const divColPt = document.createElement('div');
    divColPt.className = 'col-md-3';
    const labelPt = document.createElement('label');
    labelPt.className = 'form-label small mb-1'; // Clase CSS del CSS proporcionado
    labelPt.htmlFor = `modalMacroPt_${idBase}`;
    labelPt.textContent = '% Proteínas';
    const inputPt = document.createElement('input');
    inputPt.type = 'number';
    inputPt.className = 'form-control form-control-sm'; // Clase CSS del CSS proporcionado
    inputPt.id = `modalMacroPt_${idBase}`;
    inputPt.name = `modalMacroPt_${idBase}`; // Añadir name para facilidad de acceso
    inputPt.min = '0';
    inputPt.max = '100';
    inputPt.step = '1';
    inputPt.value = '25'; // Valor por defecto o extraído si se tuviera

    divColPt.appendChild(labelPt);
    divColPt.appendChild(inputPt);
    divGrupoMacros.appendChild(divColPt);

    // Input Carbohidratos
    const divColCh = document.createElement('div');
    divColCh.className = 'col-md-3';
    const labelCh = document.createElement('label');
    labelCh.className = 'form-label small mb-1';
    labelCh.htmlFor = `modalMacroCh_${idBase}`;
    labelCh.textContent = '% Carbohidratos';
    const inputCh = document.createElement('input');
    inputCh.type = 'number';
    inputCh.className = 'form-control form-control-sm';
    inputCh.id = `modalMacroCh_${idBase}`;
    inputCh.name = `modalMacroCh_${idBase}`;
    inputCh.min = '0';
    inputCh.max = '100';
    inputCh.step = '1';
    inputCh.value = '50'; // Valor por defecto o extraído si se tuviera

    divColCh.appendChild(labelCh);
    divColCh.appendChild(inputCh);
    divGrupoMacros.appendChild(divColCh);

    // Input Grasas
    const divColGr = document.createElement('div');
    divColGr.className = 'col-md-3';
    const labelGr = document.createElement('label');
    labelGr.className = 'form-label small mb-1';
    labelGr.htmlFor = `modalMacroGr_${idBase}`;
    labelGr.textContent = '% Grasas';
    const inputGr = document.createElement('input');
    inputGr.type = 'number';
    inputGr.className = 'form-control form-control-sm';
    inputGr.id = `modalMacroGr_${idBase}`;
    inputGr.name = `modalMacroGr_${idBase}`;
    inputGr.min = '0';
    inputGr.max = '100';
    inputGr.step = '1';
    inputGr.value = '25'; // Valor por defecto o extraído si se tuviera

    divColGr.appendChild(labelGr);
    divColGr.appendChild(inputGr);
    divGrupoMacros.appendChild(divColGr);

    // Texto de suma de macros
    const divColSuma = document.createElement('div');
    divColSuma.className = 'col-md-3';
    const divTextoSuma = document.createElement('div');
    divTextoSuma.className = 'form-text text-muted small texto-suma-macros-estrategia'; // Clase CSS del CSS proporcionado
    divTextoSuma.id = `modalSumaMacros_${idBase}`;
    divTextoSuma.textContent = 'Suma: 100%'; // Valor inicial

    // Añadir listener para actualizar la suma en tiempo real
    const actualizarSuma = () => {
        const pt_val = parseInt(inputPt.value) || 0;
        const ch_val = parseInt(inputCh.value) || 0;
        const gr_val = parseInt(inputGr.value) || 0;
        const suma_val = pt_val + ch_val + gr_val;
        divTextoSuma.textContent = `Suma: ${suma_val}%`;
        // Opcional: Añadir clases para feedback visual (ok/error)
        divTextoSuma.classList.remove('text-success', 'text-danger');
        if (suma_val === 100) {
            divTextoSuma.classList.add('text-success');
        } else {
            divTextoSuma.classList.add('text-danger');
        }
    };
    inputPt.addEventListener('input', actualizarSuma);
    inputCh.addEventListener('input', actualizarSuma);
    inputGr.addEventListener('input', actualizarSuma);
    // Llamar una vez para inicializar
    actualizarSuma();

    divColSuma.appendChild(divTextoSuma);
    divGrupoMacros.appendChild(divColSuma);

    divFila.appendChild(divGrupoMacros);

    // Crear la sección de "Aplicar también a:" (días de la semana)
    const divAplicarA = document.createElement('div');
    divAplicarA.className = 'mt-2 seccion-aplicar-a-estrategia'; // Clase CSS del CSS proporcionado

    const labelAplicarA = document.createElement('label');
    labelAplicarA.className = 'form-label small mb-1'; // Clase CSS del CSS proporcionado
    labelAplicarA.textContent = 'Aplicar también a:'; // Texto de la etiqueta

    const divCheckboxesDias = document.createElement('div');
    // Ejemplo de días (debería ser dinámico según los días de la semana de la fila)
    // Para simplificar, usamos una lista fija. En una implementación completa,
    // esto podría obtenerse del contexto de la fila o de la semana.
    const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
    diasSemana.forEach(dia => {
        // Excluir el día actual de la fila
        if (dia !== datosFilaOriginal.dia) {
            const divCheckInline = document.createElement('div');
            divCheckInline.className = 'form-check form-check-inline'; // Clase CSS del CSS proporcionado

            const inputCheckDia = document.createElement('input');
            inputCheckDia.className = 'form-check-input'; // Clase CSS del CSS proporcionado
            inputCheckDia.type = 'checkbox';
            inputCheckDia.id = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
            inputCheckDia.name = `modalAplicarA_${idBase}`; // Mismo name para agrupar si es necesario
            inputCheckDia.value = dia;

            const labelCheckDia = document.createElement('label');
            labelCheckDia.className = 'form-check-label small'; // Clase CSS del CSS proporcionado
            labelCheckDia.htmlFor = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
            labelCheckDia.textContent = dia;

            divCheckInline.appendChild(inputCheckDia);
            divCheckInline.appendChild(labelCheckDia);
            divCheckboxesDias.appendChild(divCheckInline);
        }
    });

    divAplicarA.appendChild(labelAplicarA);
    divAplicarA.appendChild(divCheckboxesDias);
    divFila.appendChild(divAplicarA);

    return divFila;
}



/**
 * Obtiene la estrategia base según el objetivo del usuario cuando se selecciona "ninguna".
 * @param {string} objetivoUsuario - El objetivo principal del usuario.
 * @returns {string} El nombre de la estrategia base correspondiente.
 */
function obtenerEstrategiaBasePorObjetivo(objetivoUsuario) {
    const mapeoObjetivoAEstrategiaBase = {
        'perdida1': 'Induccion Cetogenica',
        'ganancia1': 'Hiperproteica',
        'mantenimiento1': 'Equilibrada HC',
        'mixto1': 'Balance nutricional'
    };
    
    return mapeoObjetivoAEstrategiaBase[objetivoUsuario] || 'Estrategia base por defecto';
}
/**
 * Popula el modal de edición avanzado con los datos de la fila y la fase.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 */
function popularModalEdicionAvanzado(indiceFila) {
    console.log(`[Modal Avanzado] Popular modal para fila: ${indiceFila}`);

    try {
        // --- 1. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`[Modal Avanzado] No se encontró la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`[Modal Avanzado] No se encontró la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 2. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;
        const estrategiasDisponibles = tablaElement.estrategiasDisponibles || [];

        // Encontrar los datos originales específicos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
             console.error(`[Modal Avanzado] Índice de día inválido en 'data-indice-fila': ${indiceFila}`);
             return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
             console.error(`[Modal Avanzado] No se encontraron datos originales para el día ${indiceDiaArray} en la fila ${indiceFila}.`);
             return;
        }
		const pesoEstimadoActual = datosFilaOriginal.pesoEstimado;
		const semanaActual = datosFilaOriginal.semana;
		
        // --- 3. Popular sección de Contexto del Plan ---
                // --- 5. Popular sección de Contexto del Plan ---
        try {
            const datosProgresoNoLineal = window.nonlinearProgressData_1;
            const fechaInicioPlan = new Date(); // Asumiendo que el plan empieza hoy
            const fechaActual = new Date();

            // Obtener datos de la fase actual
            const faseActual = datosFaseBase.nombreFase;
            const objetivoPrincipal = datosFaseBase.objetivoPrincipal;
            const totalSemanasFase = datosFaseBase.semanasAsignadas || 12; // Número de semanas de la fase actual
            const diasTranscurridos = parseInt(partesIndice[2], 10); // Día dentro de la semana

            // Obtener datos globales del plan no lineal
            let pesoInicialGlobal = 0;
            let pesoFinalGlobal = 0;
            let totalSemanasGlobal = 0;
            let tasaInicialGlobal = 0;

            if (datosProgresoNoLineal && typeof datosProgresoNoLineal === 'object') {
                pesoInicialGlobal = datosProgresoNoLineal.objetivo?.pesoInicial || datosFilaOriginal.pesoEstimado;
                pesoFinalGlobal = datosProgresoNoLineal.objetivo?.pesoFinal || datosFilaOriginal.pesoEstimado;
                totalSemanasGlobal = datosProgresoNoLineal.tiempo?.semanasEstimadas || totalSemanasFase;
                tasaInicialGlobal = datosProgresoNoLineal.parametros?.tasaInicialKgPorSemana || 0.25; // kg/semana
            } else {
                // Fallback si nonlinearProgressData_1 no está disponible
                pesoInicialGlobal = datosFilaOriginal.pesoEstimado;
                pesoFinalGlobal = pesoInicialGlobal - 10; // Ejemplo de pérdida
                totalSemanasGlobal = totalSemanasFase;
                tasaInicialGlobal = 0.25;
            }

            // Calcular datos específicos de la fase actual
            const pesoInicialFase = datosFaseBase.pesoInicioFase;
            const pesoFinalFase = datosFaseBase.pesoFinFase;
            const pesoActualEstimado = pesoEstimadoActual;

            // Calcular peso perdido hasta ahora
            const pesoPerdido = pesoInicialGlobal - pesoActualEstimado;

            // Calcular velocidad de pérdida promedio
            const diasTranscurridosDesdeInicio = (totalSemanasGlobal * 7) - (totalSemanasGlobal - semanaActual) * 7 + diaNumero; // Simplificado
            const velocidadPerdidaPromedio = pesoPerdido / (diasTranscurridosDesdeInicio / 7); // kg/semana

            // Popular elementos del DOM
            const elementoInfoFase = document.getElementById('modalInfoFase');
            const elementoInfoObjetivo = document.getElementById('modalInfoObjetivo');
            const elementoInfoDuracion = document.getElementById('modalInfoDuracion');
            const elementoInfoSemanasFase = document.getElementById('modalInfoSemanasFase');
            const elementoInfoDiasTranscurridos = document.getElementById('modalInfoDiasTranscurridos');
            const elementoInfoPesoPerdido = document.getElementById('modalInfoPesoPerdido');
            const elementoInfoVelocidadPerdida = document.getElementById('modalInfoVelocidadPerdida');
            const elementoInfoPesoInicialFase = document.getElementById('modalInfoPesoInicialFase');
            const elementoInfoPesoActualEstimado = document.getElementById('modalInfoPesoActualEstimado');
            const elementoInfoPesoFinalEstimado = document.getElementById('modalInfoPesoFinalEstimado');

            if (elementoInfoFase) elementoInfoFase.textContent = faseActual;
            if (elementoInfoObjetivo) elementoInfoObjetivo.textContent = objetivoPrincipal;
            if (elementoInfoDuracion) elementoInfoDuracion.textContent = `${Math.floor(totalSemanasFase / 4)}-${Math.ceil(totalSemanasFase / 4)} meses`;
            if (elementoInfoSemanasFase) elementoInfoSemanasFase.textContent = totalSemanasFase.toString();
            if (elementoInfoDiasTranscurridos) elementoInfoDiasTranscurridos.textContent = diasTranscurridos.toString();
            if (elementoInfoPesoPerdido) elementoInfoPesoPerdido.textContent = `${pesoPerdido.toFixed(1)} kg`;
            if (elementoInfoVelocidadPerdida) elementoInfoVelocidadPerdida.textContent = `${velocidadPerdidaPromedio.toFixed(2)} kg/semana`;
            if (elementoInfoPesoInicialFase) elementoInfoPesoInicialFase.textContent = `${pesoInicialFase.toFixed(1)} kg`;
            if (elementoInfoPesoActualEstimado) elementoInfoPesoActualEstimado.textContent = `${pesoActualEstimado.toFixed(1)} kg`;
            if (elementoInfoPesoFinalEstimado) elementoInfoPesoFinalEstimado.textContent = `${pesoFinalFase.toFixed(1)} kg`;

            console.log(`[Modal Avanzado] Sección de Contexto del Plan populada con éxito para fila ${indiceFila}.`);
        } catch (e) {
            console.error(`[Modal Avanzado] Error al popular la sección de Contexto del Plan para fila ${indiceFila}:`, e);
            // Aquí puedes añadir un fallback con valores por defecto o mostrar un mensaje de error.
        }

        
                        // --- 4. Popular sección de Posibles Estrategias ---
					// a. Obtener el objetivo principal del USUARIO (no de la fase)
					// Opción 1: Desde el select global
					
					let objetivoUsuario = document.getElementById('objetivo')?.value;
					if (!objetivoUsuario) {
						 console.warn(`[Modal Avanzado] No se pudo obtener el objetivo principal del usuario. Usando 'perdida1' por defecto.`);
						 objetivoUsuario = 'perdida1'; // Valor por defecto o manejo de error
					}
					console.log(`[Modal Avanzado] Objetivo principal del usuario detectado: ${objetivoUsuario}`);


					// b. Mapear objetivoUsuario a la clave del catálogo ESTRATEGIAS_POR_OBJETIVO
					// Asumimos que el objetivoUsuario ya está en el formato correcto (perdida1, ganancia1, etc.)
					// Si no, necesitarías un mapeo adicional aquí.
					
					const claveObjetivo = objetivoUsuario; // Ajusta si es necesario

					let estrategiasBaseParaMostrar = [];
					let estrategiasRecomendadasParaMostrar = [];

						if (ESTRATEGIAS_POR_OBJETIVO && ESTRATEGIAS_POR_OBJETIVO[claveObjetivo]) {
							estrategiasBaseParaMostrar = ESTRATEGIAS_POR_OBJETIVO[claveObjetivo].base || [];
							estrategiasRecomendadasParaMostrar = ESTRATEGIAS_POR_OBJETIVO[claveObjetivo].recomendadas || [];
							console.log(`[Modal Avanzado] Estrategias encontradas para clave '${claveObjetivo}':`, { base: estrategiasBaseParaMostrar, recomendadas: estrategiasRecomendadasParaMostrar });
						} else {
							console.warn(`[Modal Avanzado] No se encontraron estrategias para el objetivo '${claveObjetivo}' en ESTRATEGIAS_POR_OBJETIVO.`);
							// Valores por defecto o vacíos
							estrategiasBaseParaMostrar = ['Estrategias generales'];
							estrategiasRecomendadasParaMostrar = ['Consulta personalizada'];
						}


								// Mostrar las estrategias en el modal
								document.getElementById('modalEstrategiasBase').textContent = estrategiasBaseParaMostrar.join(', ');
								document.getElementById('modalEstrategiasRecomendadas').textContent = estrategiasRecomendadasParaMostrar.join(', ');
								// NOTA: modalEstrategiaBaseActual se poblará más abajo con las estrategias aplicadas específicas

								
								// --- 5. Popular checkboxes de Estrategias Específicas ---
								
								console.log(`[Modal Avanzado] Estrategias disponibles para fila ${indiceFila}:`, estrategiasDisponibles);

								const contenedorCheckboxes = document.getElementById('modalCheckboxesEstrategias');
								let estrategiasAplicadasArray = []; // Declarar aquí para que esté disponible

						if (contenedorCheckboxes) {
									contenedorCheckboxes.innerHTML = ''; // Limpiar antes de llenar

									// Excluir "ninguna" de la lista de checkboxes
									const estrategiasParaCheckboxes = estrategiasDisponibles.filter(e => e.toLowerCase() !== "ninguna");

									// --- Obtener estrategias aplicadas a esta fila ---
									// a. Intentar obtener desde el modal (por si ya se han hecho cambios)
									
									const contenedorConfiguracionMacros = document.getElementById('modalConfiguracionMacrosPorEstrategia');
						
						
						
						
						
						
								// --- NUEVO BLOQUE PARA OBTENER ESTRATEGIAS APLICADAS ---
										// Obtener estrategias ya aplicadas a esta fila específica
										let estrategiasAplicadasArray = [];
										if (datosFilaOriginal.estrategias && typeof datosFilaOriginal.estrategias === 'string') {
											const estrategiasStr = datosFilaOriginal.estrategias;
											if (estrategiasStr.toLowerCase().includes('ninguna')) {
												// Caso 1: La fila tiene explícitamente "ninguna"
												console.log(`[Modal Avanzado] Fila ${indiceFila} tiene estrategia 'ninguna'.`);
												// estrategiasAplicadasArray ya es [] por la inicialización anterior
											} else {
												// Caso 2: La fila tiene estrategias específicas aplicadas
												estrategiasAplicadasArray = estrategiasStr.split(',')
																					.map(s => s.trim())
																					.filter(s => s && s.toLowerCase() !== "ninguna");
												console.log(`[Modal Avanzado] Estrategias aplicadas encontradas para fila ${indiceFila}:`, estrategiasAplicadasArray);
											}
										} else {
											// Caso 3: datosFilaOriginal.estrategias es null, undefined o no es string
											console.log(`[Modal Avanzado] No se encontró información de estrategias para fila ${indiceFila} o el formato es inválido.`);
											// estrategiasAplicadasArray sigue siendo []
										}
										// --- FIN NUEVO BLOQUE ---

										// --- Generar checkboxes ---
						            estrategiasParaCheckboxes.forEach(estrategia => {
									const checkboxId = `modalCheckbox_${estrategia.replace(/\s+/g, '_')}`;
									const isChecked = estrategiasAplicadasArray.includes(estrategia);

									const divCheckbox = document.createElement('div');
									divCheckbox.classList.add('form-check', 'form-check-inline');

									const inputCheckbox = document.createElement('input'); // <-- DECLARACIÓN
									inputCheckbox.classList.add('form-check-input');
									inputCheckbox.type = 'checkbox';
									inputCheckbox.id = checkboxId;
									inputCheckbox.value = estrategia;
									if (isChecked) inputCheckbox.checked = true;

									const labelCheckbox = document.createElement('label');
									labelCheckbox.classList.add('form-check-label');
									labelCheckbox.htmlFor = checkboxId;
									// Usar mapeo para nombres legibles si existe
									const nombreLegibleEstrategia = MAPEO_ESTRATEGIAS_CHECKBOX ? MAPEO_ESTRATEGIAS_CHECKBOX[estrategia] || estrategia : estrategia;
									labelCheckbox.textContent = nombreLegibleEstrategia;

									divCheckbox.appendChild(inputCheckbox);
									divCheckbox.appendChild(labelCheckbox);
									contenedorCheckboxes.appendChild(divCheckbox);

				
           
								// --- 6. Añadir evento para crear/eliminar filas de configuración ---
								// Este evento se añade aquí porque necesitamos acceso a `indiceFila` y otras variables del scope.
								// CORRECCIÓN: El event listener debe estar DENTRO del forEach, justo después de crear inputCheckbox
								inputCheckbox.addEventListener('change', function() { // <-- AHORA ESTÁ BIEN UBICADO
									const estrategiaValor = this.value;
									if (this.checked) {
										// Crear la fila de configuración si se marca el checkbox
										crearFilaConfiguracionEstrategiaEnModal(indiceFila, estrategiaValor);
									} else {
										// Eliminar la fila de configuración si se desmarca el checkbox
										eliminarFilaConfiguracionEstrategiaEnModal(indiceFila, estrategiaValor);
									}
								});
								// --- FIN DEL EVENT LISTENER ---
							});

						// --- Popular modalEstrategiaBaseActual con las estrategias aplicadas ---
							// --- Popular modalEstrategiaBaseActual con las estrategias aplicadas ---
								let estrategiasBaseActualesMostrar = '';
								if (estrategiasAplicadasArray.length > 0) {
									// Si hay estrategias aplicadas, mostrarlas mapeadas
									estrategiasBaseActualesMostrar = estrategiasAplicadasArray
										.map(e => MAPEO_ESTRATEGIAS_CHECKBOX ? MAPEO_ESTRATEGIAS_CHECKBOX[e] || e : e)
										.join(', ');
								} else {
									// Si no hay estrategias aplicadas (array vacío), mostrar solo la estrategia base por objetivo
									// Sin el prefijo "ninguna (" ni el sufijo ")"
									const objetivoUsuario = document.getElementById('objetivo')?.value || 'perdida1'; // Obtener objetivo global
									const estrategiaBasePorObjetivo = obtenerEstrategiaBasePorObjetivo(objetivoUsuario);
									estrategiasBaseActualesMostrar = estrategiaBasePorObjetivo; // Mostrar solo el nombre de la estrategia base
								}
								const elementoEstrategiaBaseActual = document.getElementById('modalEstrategiaBaseActual');
								if (elementoEstrategiaBaseActual) {
									elementoEstrategiaBaseActual.textContent = estrategiasBaseActualesMostrar;
								} else {
									console.warn("[Modal Avanzado] Elemento con id 'modalEstrategiaBaseActual' no encontrado.");
								}
							
						
						} else {
							console.warn("[Modal Avanzado] Contenedor de checkboxes no encontrado.");
						}
						
					
			

							


        // --- 7. Popular sección de Configurar Macros por Estrategia ---
        const contenedorConfiguracionMacros = document.getElementById('modalConfiguracionMacrosPorEstrategia');
        const mensajeSinEstrategias = document.getElementById('modalMensajeSinEstrategias');
        if (contenedorConfiguracionMacros) {
            contenedorConfiguracionMacros.innerHTML = ''; // Limpiar configuraciones anteriores
        }
        if (mensajeSinEstrategias) {
            mensajeSinEstrategias.style.display = 'block'; // Mostrar mensaje inicial
        }

        // Precargar filas de configuración para estrategias ya aplicadas
        if (contenedorConfiguracionMacros && estrategiasAplicadasArray.length > 0) {
            estrategiasAplicadasArray.forEach(estrategia => {
                // Solo crear la fila si la estrategia es válida y está en las disponibles
                if (estrategiasDisponibles.includes(estrategia)) {
                    // Pasar ajusteCaloriasDiarioManual como parámetro adicional
                    const inputAjusteCalorias = document.getElementById('modalInputAjusteCalorias');
                    let ajusteCaloriasDiarioManual = null;
                    if (inputAjusteCalorias && inputAjusteCalorias.value !== "") {
                        const valorIngresado = parseFloat(inputAjusteCalorias.value);
                        if (!isNaN(valorIngresado)) {
                            ajusteCaloriasDiarioManual = valorIngresado;
                            console.log(`[Modal Avanzado] Ajuste de calorías manual detectado al precargar fila: ${ajusteCaloriasDiarioManual} kcal/día`);
                        } else {
                            console.warn("[Modal Avanzado] Valor inválido en el input de ajuste de calorías al precargar fila. Se ignorará.");
                        }
                    }
                    crearFilaConfiguracionEstrategiaEnModal(indiceFila, estrategia, ajusteCaloriasDiarioManual);
                }
            });
            // Ocultar mensaje de "sin estrategias" si se crearon filas
            if (mensajeSinEstrategias && contenedorConfiguracionMacros.children.length > 0) {
                mensajeSinEstrategias.style.display = 'none';
            }
        }

        // --- 8. Popular sección de Recordatorio de Evolución ---
        // (Esto ya está contenido en el HTML del modal como texto estático)

        // --- 9. Popular Select de Actividad ---
        const selectActividadElement = document.getElementById('modalSelectActividad');
        if (selectActividadElement) {
            // Asegurarse de que el valor exista en las opciones del select antes de asignarlo
            if (selectActividadElement.querySelector(`option[value="${datosFilaOriginal.actividad}"]`)) {
                selectActividadElement.value = datosFilaOriginal.actividad;
            } else {
                console.warn(`El valor de actividad ${datosFilaOriginal.actividad} no se encontró en las opciones del modal. Se deja el valor predeterminado del select.`);
            }
        } else {
            console.error("Elemento con id 'modalSelectActividad' no encontrado en el modal.");
        }
        
        // --- 10. Popular Input de Ajuste de Calorías ---
        const inputAjusteCalorias = document.getElementById('modalInputAjusteCalorias');
        if (inputAjusteCalorias) {
            // Aquí puedes poner el valor actual si lo tienes almacenado
            // Por ahora lo dejamos vacío o con un valor por defecto
            inputAjusteCalorias.value = ''; // O algún valor almacenado
        }
		
		// --- 11. Popular sección de Recordatorio de Evolución ---
		popularSeccionRecordatorioEvolucion(indiceFila);
		// --- Fin de Popular sección de Recordatorio de Evolución ---
        console.log(`[Modal Avanzado] Modal popularizado con éxito para fila ${indiceFila}.`);
		
		// --- 6. Popular sección de Progreso Estimado ---
	// Esta sección se actualiza dinámicamente cada vez que se abre el modal
	// Pasamos datosFaseBase, semanaActual y pesoEstimadoActual
	//const semanaActual = datosFilaOriginal.semana; // Asumiendo que datosFilaOriginal tiene una propiedad 'semana'
	//const pesoEstimadoActual = datosFilaOriginal.pesoEstimado;

	if (typeof generarGraficoProgresoHTML === 'function') {
		const htmlGraficoProgreso = generarGraficoProgresoHTML(datosFaseBase, semanaActual, pesoEstimadoActual);
		// El HTML generado puede ser un placeholder o vacío, ya que el canvas se dibuja por JS
		// La función se encarga de popular los elementos del DOM directamente
		console.log(`[Modal Avanzado] Gráfico de progreso generado para fila ${indiceFila}.`);
	} else {
		console.warn("[Modal Avanzado] Función 'generarGraficoProgresoHTML' no encontrada. Se usará placeholder.");
		// Opcional: Mostrar un mensaje de error o placeholder en el contenedor
		const contenedorGrafico = document.getElementById('modalGraficoProgreso');
		if (contenedorGrafico) {
			contenedorGrafico.innerHTML = '<p class="text-muted small">Gráfico de progreso no disponible.</p>';
		}
	}
	
	
	        // --- 14. --- NUEVO --- Popular sección de Progreso Estimado de la Fase ---
        // Usar datos del cálculo no lineal global (window.nonlinearProgressData_1) para mayor precisión
        try {
            const datosProgresoNoLineal = window.nonlinearProgressData_1;
            if (datosProgresoNoLineal && typeof datosProgresoNoLineal === 'object') {
                console.log(`[Modal Avanzado] Datos de progreso no lineal disponibles para fila ${indiceFila}:`, datosProgresoNoLineal);

                // a. Obtener pesos iniciales y finales del cálculo no lineal
                const pesoInicialNoLineal = datosProgresoNoLineal.objetivo?.pesoInicial;
                const pesoFinalNoLineal = datosProgresoNoLineal.objetivo?.pesoFinal;
                const objetivoTipoNoLineal = datosProgresoNoLineal.objetivo?.tipo;

                if (pesoInicialNoLineal !== undefined && pesoFinalNoLineal !== undefined) {
                    // b. Popular elementos de peso
                    const elementoPesoInicio = document.getElementById('modalPesoInicioGrafico');
                    const elementoPesoActual = document.getElementById('modalPesoActualGrafico');
                    const elementoPesoMeta = document.getElementById('modalPesoMetaGrafico');

                    if (elementoPesoInicio) elementoPesoInicio.textContent = pesoInicialNoLineal.toFixed(1);
                    if (elementoPesoActual) elementoPesoActual.textContent = pesoEstimadoActual.toFixed(1); // Seguimos usando pesoEstimadoActual de la fila
                    if (elementoPesoMeta) elementoPesoMeta.textContent = pesoFinalNoLineal.toFixed(1);

                    console.log(`[Modal Avanzado] Pesos populados desde datos no lineales para fila ${indiceFila}: Inicio=${pesoInicialNoLineal.toFixed(1)}kg, Actual=${pesoEstimadoActual.toFixed(1)}kg, Meta=${pesoFinalNoLineal.toFixed(1)}kg`);

                    // c. Popular barra de progreso general
                    const barraProgresoGeneral = document.getElementById('modalBarraProgresoGeneral');
                    if (barraProgresoGeneral) {
                        // Calcular progreso basado en el cálculo no lineal
                        const cambioPesoTotalNoLineal = Math.abs(pesoInicialNoLineal - pesoFinalNoLineal);
                        const cambioPesoAcumuladoNoLineal = Math.abs(pesoInicialNoLineal - pesoEstimadoActual);
                        
                        // Asegurar que el progreso esté entre 0 y 100
                        let progresoPorcentajeNoLineal = (cambioPesoAcumuladoNoLineal / cambioPesoTotalNoLineal) * 100;
                        if (isNaN(progresoPorcentajeNoLineal) || !isFinite(progresoPorcentajeNoLineal)) {
                            progresoPorcentajeNoLineal = 0;
                        }
                        const progresoAjustadoNoLineal = Math.max(0, Math.min(100, progresoPorcentajeNoLineal));
                        
                        barraProgresoGeneral.style.width = `${progresoAjustadoNoLineal.toFixed(2)}%`;
                        barraProgresoGeneral.setAttribute('aria-valuenow', progresoAjustadoNoLineal.toFixed(2));
                        barraProgresoGeneral.textContent = `Progreso: ${progresoAjustadoNoLineal.toFixed(0)}%`;
                        
                        console.log(`[Modal Avanzado] Barra de progreso general actualizada para fila ${indiceFila}: ${progresoAjustadoNoLineal.toFixed(2)}%`);
                    } else {
                        console.warn("[Modal Avanzado] Elemento '#modalBarraProgresoGeneral' no encontrado en el modal.");
                    }

                    // d. (Opcional) Popular gráfico detallado en canvas
                    // Llamar a la función que dibuja el gráfico en el canvas
                    setTimeout(() => {
                        dibujarGraficoDetalladoEnCanvas(datosFaseBase, semanaActual, pesoEstimadoActual);
                    }, 150); // Pequeño retraso para asegurar que el canvas esté en el DOM

                } else {
                    console.warn(`[Modal Avanzado] Pesos iniciales o finales no encontrados en datosProgresoNoLineal para fila ${indiceFila}.`);
                    // Fallback: Usar datos de la fila original
                    const elementoPesoInicio = document.getElementById('modalPesoInicioGrafico');
                    const elementoPesoActual = document.getElementById('modalPesoActualGrafico');
                    const elementoPesoMeta = document.getElementById('modalPesoMetaGrafico');
                    const barraProgresoGeneral = document.getElementById('modalBarraProgresoGeneral');

                    if (elementoPesoInicio) elementoPesoInicio.textContent = datosFilaOriginal.pesoEstimado.toFixed(1);
                    if (elementoPesoActual) elementoPesoActual.textContent = pesoEstimadoActual.toFixed(1);
                    if (elementoPesoMeta) elementoPesoMeta.textContent = datosFilaOriginal.pesoEstimado.toFixed(1); // Meta = Actual como fallback

                    if (barraProgresoGeneral) {
                        barraProgresoGeneral.style.width = '0%';
                        barraProgresoGeneral.setAttribute('aria-valuenow', '0');
                        barraProgresoGeneral.textContent = 'Progreso: 0%';
                    }
                }
            } else {
                console.warn(`[Modal Avanzado] window.nonlinearProgressData_1 no disponible o inválido para fila ${indiceFila}. Usando datos de la fila.`);
                // Fallback: Usar datos de la fila original
                const elementoPesoInicio = document.getElementById('modalPesoInicioGrafico');
                const elementoPesoActual = document.getElementById('modalPesoActualGrafico');
                const elementoPesoMeta = document.getElementById('modalPesoMetaGrafico');
                const barraProgresoGeneral = document.getElementById('modalBarraProgresoGeneral');

                if (elementoPesoInicio) elementoPesoInicio.textContent = datosFilaOriginal.pesoEstimado.toFixed(1);
                if (elementoPesoActual) elementoPesoActual.textContent = pesoEstimadoActual.toFixed(1);
                if (elementoPesoMeta) elementoPesoMeta.textContent = datosFilaOriginal.pesoEstimado.toFixed(1); // Meta = Actual como fallback

                if (barraProgresoGeneral) {
                    barraProgresoGeneral.style.width = '0%';
                    barraProgresoGeneral.setAttribute('aria-valuenow', '0');
                    barraProgresoGeneral.textContent = 'Progreso: 0%';
                }
            }
        } catch (e) {
            console.error(`[Modal Avanzado] Error al popular la sección de Progreso Estimado de la Fase para fila ${indiceFila}:`, e);
            // Fallback en caso de error
            const elementoPesoInicio = document.getElementById('modalPesoInicioGrafico');
            const elementoPesoActual = document.getElementById('modalPesoActualGrafico');
            const elementoPesoMeta = document.getElementById('modalPesoMetaGrafico');
            const barraProgresoGeneral = document.getElementById('modalBarraProgresoGeneral');

            if (elementoPesoInicio) elementoPesoInicio.textContent = datosFilaOriginal.pesoEstimado.toFixed(1);
            if (elementoPesoActual) elementoPesoActual.textContent = pesoEstimadoActual.toFixed(1);
            if (elementoPesoMeta) elementoPesoMeta.textContent = datosFilaOriginal.pesoEstimado.toFixed(1);

            if (barraProgresoGeneral) {
                barraProgresoGeneral.style.width = '0%';
                barraProgresoGeneral.setAttribute('aria-valuenow', '0');
                barraProgresoGeneral.textContent = 'Progreso: 0% (Error)';
            }
        }
        // --- FIN NUEVO BLOQUE ---
    } catch (error) {
        console.error(`[Modal Avanzado] Error al popular el modal para fila ${indiceFila}:`, error);
        alert("Hubo un error al cargar los datos en el editor. Por favor, inténtalo de nuevo.");
    }
}

/**
 * Crea una fila de configuración de macros para una estrategia específica en el modal.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 */
function crearFilaConfiguracionEstrategiaEnModal(indiceFila, nombreEstrategia) {
    console.log(`[Modal Avanzado] Creando fila de configuración para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);

    const contenedorConfiguracionMacros = document.getElementById('modalConfiguracionMacrosPorEstrategia');
    const mensajeSinEstrategias = document.getElementById('modalMensajeSinEstrategias');
    if (!contenedorConfiguracionMacros) {
        console.error("[Modal Avanzado] Contenedor de configuración de macros no encontrado.");
        return;
    }

    // Crear un ID único para la fila
    const idFilaConfig = `fila-config-${indiceFila}-${nombreEstrategia.replace(/\s+/g, '_')}`;

    // Evitar crear duplicados
    if (document.getElementById(idFilaConfig)) {
        console.warn(`[Modal Avanzado] La fila de configuración para '${nombreEstrategia}' en fila ${indiceFila} ya existe.`);
        return;
    }

    // Obtener macros predeterminados para esta estrategia
    // Asumimos que MACROS_POR_ESTRATEGIA_AJUSTADO y MACROS_POR_ESTRATEGIAS_BASE están definidos globalmente
    const macrosPredeterminados = MACROS_POR_ESTRATEGIA_AJUSTADO[nombreEstrategia] ||
                                  MACROS_POR_ESTRATEGIAS_BASE[nombreEstrategia] ||
                                  { proteinas: 25, carbohidratos: 40, grasas: 35 }; // Fallback

    // Crear la fila de configuración
    const divFilaConfig = document.createElement('div');
    divFilaConfig.className = 'border rounded p-3 mb-3 bg-white shadow-sm fila-configuracion-estrategia';
    divFilaConfig.id = idFilaConfig;
    divFilaConfig.setAttribute('data-estrategia-id', nombreEstrategia);

    // Cabecera de la fila
    const divCabecera = document.createElement('div');
    divCabecera.className = 'd-flex justify-content-between align-items-center mb-2 cabecera-fila-estrategia';

    const h6NombreEstrategia = document.createElement('h6');
    h6NombreEstrategia.className = 'mb-0 text-primary nombre-estrategia';
    h6NombreEstrategia.textContent = nombreEstrategia;

    const botonCerrar = document.createElement('button');
    botonCerrar.type = 'button';
    botonCerrar.className = 'btn-close boton-cerrar-fila-estrategia';
    botonCerrar.setAttribute('aria-label', 'Eliminar');
    botonCerrar.title = 'Eliminar estrategia';
    botonCerrar.addEventListener('click', function() {
        eliminarFilaConfiguracionEstrategiaEnModal(indiceFila, nombreEstrategia);
        // Desmarcar el checkbox correspondiente
        const checkboxId = `modalCheckbox_${nombreEstrategia.replace(/\s+/g, '_')}`;
        const checkboxCorrespondiente = document.getElementById(checkboxId);
        if (checkboxCorrespondiente) {
            checkboxCorrespondiente.checked = false;
        }
    });

    divCabecera.appendChild(h6NombreEstrategia);
    divCabecera.appendChild(botonCerrar);
    divFilaConfig.appendChild(divCabecera);

    // Grupo de macros
    const divGrupoMacros = document.createElement('div');
    divGrupoMacros.className = 'row g-2 align-items-end grupo-macros-estrategia';

    // Inputs de macros con IDs únicos
    const idBase = `${indiceFila}_${nombreEstrategia.replace(/\s+/g, '_')}`;

    // Proteínas
    const divColPt = document.createElement('div');
    divColPt.className = 'col-md-3';
    const labelPt = document.createElement('label');
    labelPt.className = 'form-label small mb-1';
    labelPt.htmlFor = `modalMacroPt_${idBase}`;
    labelPt.textContent = '% Proteínas';
    const inputPt = document.createElement('input');
    inputPt.type = 'number';
    inputPt.className = 'form-control form-control-sm';
    inputPt.id = `modalMacroPt_${idBase}`;
    inputPt.name = `modalMacroPt_${idBase}`;
    inputPt.min = '0';
    inputPt.max = '100';
    inputPt.step = '1';
    inputPt.value = macrosPredeterminados.proteinas;

    divColPt.appendChild(labelPt);
    divColPt.appendChild(inputPt);
    divGrupoMacros.appendChild(divColPt);

    // Carbohidratos
    const divColCh = document.createElement('div');
    divColCh.className = 'col-md-3';
    const labelCh = document.createElement('label');
    labelCh.className = 'form-label small mb-1';
    labelCh.htmlFor = `modalMacroCh_${idBase}`;
    labelCh.textContent = '% Carbohidratos';
    const inputCh = document.createElement('input');
    inputCh.type = 'number';
    inputCh.className = 'form-control form-control-sm';
    inputCh.id = `modalMacroCh_${idBase}`;
    inputCh.name = `modalMacroCh_${idBase}`;
    inputCh.min = '0';
    inputCh.max = '100';
    inputCh.step = '1';
    inputCh.value = macrosPredeterminados.carbohidratos;

    divColCh.appendChild(labelCh);
    divColCh.appendChild(inputCh);
    divGrupoMacros.appendChild(divColCh);

    // Grasas
    const divColGr = document.createElement('div');
    divColGr.className = 'col-md-3';
    const labelGr = document.createElement('label');
    labelGr.className = 'form-label small mb-1';
    labelGr.htmlFor = `modalMacroGr_${idBase}`;
    labelGr.textContent = '% Grasas';
    const inputGr = document.createElement('input');
    inputGr.type = 'number';
    inputGr.className = 'form-control form-control-sm';
    inputGr.id = `modalMacroGr_${idBase}`;
    inputGr.name = `modalMacroGr_${idBase}`;
    inputGr.min = '0';
    inputGr.max = '100';
    inputGr.step = '1';
    inputGr.value = macrosPredeterminados.grasas;

    divColGr.appendChild(labelGr);
    divColGr.appendChild(inputGr);
    divGrupoMacros.appendChild(divColGr);

    // Texto de suma
    const divColSuma = document.createElement('div');
    divColSuma.className = 'col-md-3';
    const divTextoSuma = document.createElement('div');
    divTextoSuma.className = 'form-text text-muted small texto-suma-macros-estrategia';
    divTextoSuma.id = `modalSumaMacros_${idBase}`;
    divTextoSuma.textContent = `Suma: ${(macrosPredeterminados.proteinas + macrosPredeterminados.carbohidratos + macrosPredeterminados.grasas)}%`;
    // Añadir clases de estado
    const suma = macrosPredeterminados.proteinas + macrosPredeterminados.carbohidratos + macrosPredeterminados.grasas;
    divTextoSuma.classList.remove('text-success', 'text-danger');
    if (suma === 100) {
        divTextoSuma.classList.add('text-success');
    } else {
        divTextoSuma.classList.add('text-danger');
    }

    divColSuma.appendChild(divTextoSuma);
    divGrupoMacros.appendChild(divColSuma);

    divFilaConfig.appendChild(divGrupoMacros);

    // Sección de "Aplicar también a:" (solo si es relevante, por ejemplo, para días de entreno)
    // Esta sección puede requerir lógica adicional para determinar qué días son relevantes.
    // Por ahora, la omitimos o la dejamos como placeholder.
    /*
    const divAplicarA = document.createElement('div');
    divAplicarA.className = 'mt-2 seccion-aplicar-a-estrategia';

    const labelAplicarA = document.createElement('label');
    labelAplicarA.className = 'form-label small mb-1';
    labelAplicarA.textContent = 'Aplicar también a:';
    divAplicarA.appendChild(labelAplicarA);

     const divCheckboxesDias = document.createElement('div');
        
            // El formato de indiceFila es "mes-semana-dia" (ej: "1-1-0")
            const partesIndice = indiceFila.toString().split('-');
            const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10); // Último elemento: indice del dia (0-6)

            // Mapear índice de día a nombre de día
            const nombresDiasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            const nombreDiaActual = nombresDiasSemana[indiceDiaArray] || 'Día desconocido';
            
   
			const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            diasSemana.forEach(dia => {
                
                if (dia !== nombreDiaActual) {// datosFilaOriginal debe estar disponible en este scope
            
			const divCheckInline = document.createElement('div');
            divCheckInline.className = 'form-check form-check-inline';

            const inputCheckDia = document.createElement('input');
            inputCheckDia.className = 'form-check-input';
            inputCheckDia.type = 'checkbox';
			
             // --- MODIFICACIÓN: ID único basado en indiceFila y nombre del día ---
              inputCheckDia.id = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
              // --- FIN MODIFICACIÓN ---
            inputCheckDia.name = `modalAplicarA_${idBase}`;
            inputCheckDia.value = dia;

            const labelCheckDia = document.createElement('label');
            labelCheckDia.className = 'form-check-label small';
			
			
             // --- MODIFICACIÓN: htmlFor único basado en indiceFila y nombre del día ---
              labelCheckDia.htmlFor = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
              // --- FIN MODIFICACIÓN ---
            labelCheckDia.textContent = dia;

            divCheckInline.appendChild(inputCheckDia);
            divCheckInline.appendChild(labelCheckDia);
            divCheckboxesDias.appendChild(divCheckInline);
        // }
    });

    divAplicarA.appendChild(divCheckboxesDias);
    divFilaConfig.appendChild(divAplicarA);
    */

    // Añadir la fila al contenedor
    contenedorConfiguracionMacros.appendChild(divFilaConfig);

    // Mostrar/Ocultar mensaje de "sin estrategias"
    if (mensajeSinEstrategias) {
        mensajeSinEstrategias.style.display = 'none';
    }

    // Añadir listeners para actualizar la suma en tiempo real
    const inputsMacros = [inputPt, inputCh, inputGr];
    inputsMacros.forEach(input => {
        input.addEventListener('input', function() {
            actualizarSumaMacrosEnModal(idBase);
        });
    });

    console.log(`[Modal Avanzado] Fila de configuración creada para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);
}
/**
 * Crea una fila de configuración de macros para una estrategia específica en el modal.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 */
/**
 * Crea una fila de configuración de macros para una estrategia específica en el modal.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 */
function crearFilaConfiguracionEstrategiaEnModal(indiceFila, nombreEstrategia) {
    console.log(`[Modal Avanzado] Creando fila de configuración para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);

    const contenedorConfiguracionMacros = document.getElementById('modalConfiguracionMacrosPorEstrategia');
    const mensajeSinEstrategias = document.getElementById('modalMensajeSinEstrategias');
    if (!contenedorConfiguracionMacros) {
        console.error("[Modal Avanzado] Contenedor de configuración de macros no encontrado.");
        return;
    }

    // Crear un ID único para la fila
    const idFilaConfig = `fila-config-${indiceFila}-${nombreEstrategia.replace(/\s+/g, '_')}`;

    // Evitar crear duplicados
    if (document.getElementById(idFilaConfig)) {
        console.warn(`[Modal Avanzado] La fila de configuración para '${nombreEstrategia}' en fila ${indiceFila} ya existe.`);
        return;
    }

    // Obtener macros predeterminados para esta estrategia
    const macrosPredeterminados = MACROS_POR_ESTRATEGIA_AJUSTADO[nombreEstrategia] ||
                                  MACROS_POR_ESTRATEGIAS_BASE[nombreEstrategia] ||
                                  { proteinas: 25, carbohidratos: 40, grasas: 35 }; // Fallback

    // Crear la fila de configuración
    const divFilaConfig = document.createElement('div');
    divFilaConfig.className = 'border rounded p-3 mb-3 bg-white shadow-sm fila-configuracion-estrategia';
    divFilaConfig.id = idFilaConfig;
    divFilaConfig.setAttribute('data-estrategia-id', nombreEstrategia);

    // Cabecera de la fila
    const divCabecera = document.createElement('div');
    divCabecera.className = 'd-flex justify-content-between align-items-center mb-2 cabecera-fila-estrategia';

    const h6NombreEstrategia = document.createElement('h6');
    h6NombreEstrategia.className = 'mb-0 text-primary nombre-estrategia';
    h6NombreEstrategia.textContent = nombreEstrategia;

    const botonCerrar = document.createElement('button');
    botonCerrar.type = 'button';
    botonCerrar.className = 'btn-close boton-cerrar-fila-estrategia';
    botonCerrar.setAttribute('aria-label', 'Eliminar');
    botonCerrar.title = 'Eliminar estrategia';
    botonCerrar.addEventListener('click', function() {
        eliminarFilaConfiguracionEstrategiaEnModal(indiceFila, nombreEstrategia);
        // Desmarcar el checkbox correspondiente
        const checkboxId = `modalCheckbox_${nombreEstrategia.replace(/\s+/g, '_')}`;
        const checkboxCorrespondiente = document.getElementById(checkboxId);
        if (checkboxCorrespondiente) {
            checkboxCorrespondiente.checked = false;
        }
    });

    divCabecera.appendChild(h6NombreEstrategia);
    divCabecera.appendChild(botonCerrar);
    divFilaConfig.appendChild(divCabecera);

    // Grupo de macros
    const divGrupoMacros = document.createElement('div');
    divGrupoMacros.className = 'row g-2 align-items-end grupo-macros-estrategia';

    // Inputs de macros con IDs únicos
    const idBase = `${indiceFila}_${nombreEstrategia.replace(/\s+/g, '_')}`;

    // Proteínas
    const divColPt = document.createElement('div');
    divColPt.className = 'col-md-3';
    const labelPt = document.createElement('label');
    labelPt.className = 'form-label small mb-1';
    labelPt.htmlFor = `modalMacroPt_${idBase}`;
    labelPt.textContent = '% Proteínas';
    const inputPt = document.createElement('input');
    inputPt.type = 'number';
    inputPt.className = 'form-control form-control-sm';
    inputPt.id = `modalMacroPt_${idBase}`;
    inputPt.name = `modalMacroPt_${idBase}`;
    inputPt.min = '0';
    inputPt.max = '100';
    inputPt.step = '1';
    inputPt.value = macrosPredeterminados.proteinas;

    divColPt.appendChild(labelPt);
    divColPt.appendChild(inputPt);
    divGrupoMacros.appendChild(divColPt);

    // Carbohidratos
    const divColCh = document.createElement('div');
    divColCh.className = 'col-md-3';
    const labelCh = document.createElement('label');
    labelCh.className = 'form-label small mb-1';
    labelCh.htmlFor = `modalMacroCh_${idBase}`;
    labelCh.textContent = '% Carbohidratos';
    const inputCh = document.createElement('input');
    inputCh.type = 'number';
    inputCh.className = 'form-control form-control-sm';
    inputCh.id = `modalMacroCh_${idBase}`;
    inputCh.name = `modalMacroCh_${idBase}`;
    inputCh.min = '0';
    inputCh.max = '100';
    inputCh.step = '1';
    inputCh.value = macrosPredeterminados.carbohidratos;

    divColCh.appendChild(labelCh);
    divColCh.appendChild(inputCh);
    divGrupoMacros.appendChild(divColCh);

    // Grasas
    const divColGr = document.createElement('div');
    divColGr.className = 'col-md-3';
    const labelGr = document.createElement('label');
    labelGr.className = 'form-label small mb-1';
    labelGr.htmlFor = `modalMacroGr_${idBase}`;
    labelGr.textContent = '% Grasas';
    const inputGr = document.createElement('input');
    inputGr.type = 'number';
    inputGr.className = 'form-control form-control-sm';
    inputGr.id = `modalMacroGr_${idBase}`;
    inputGr.name = `modalMacroGr_${idBase}`;
    inputGr.min = '0';
    inputGr.max = '100';
    inputGr.step = '1';
    inputGr.value = macrosPredeterminados.grasas;

    divColGr.appendChild(labelGr);
    divColGr.appendChild(inputGr);
    divGrupoMacros.appendChild(divColGr);

    // Texto de suma
    const divColSuma = document.createElement('div');
    divColSuma.className = 'col-md-3';
    const divTextoSuma = document.createElement('div');
    divTextoSuma.className = 'form-text text-muted small texto-suma-macros-estrategia';
    divTextoSuma.id = `modalSumaMacros_${idBase}`;
    divTextoSuma.textContent = `Suma: ${(macrosPredeterminados.proteinas + macrosPredeterminados.carbohidratos + macrosPredeterminados.grasas)}%`;
    // Añadir clases de estado
    const suma = macrosPredeterminados.proteinas + macrosPredeterminados.carbohidratos + macrosPredeterminados.grasas;
    divTextoSuma.classList.remove('text-success', 'text-danger');
    if (suma === 100) {
        divTextoSuma.classList.add('text-success');
    } else {
        divTextoSuma.classList.add('text-danger');
    }

    divColSuma.appendChild(divTextoSuma);
    divGrupoMacros.appendChild(divColSuma);

    divFilaConfig.appendChild(divGrupoMacros);

    // Sección de "Aplicar también a:"
                // Sección de "Aplicar también a:" (días de la semana)
            const divAplicarA = document.createElement('div');
            divAplicarA.className = 'mt-2 seccion-aplicar-a-estrategia';

            const labelAplicarA = document.createElement('label');
            labelAplicarA.className = 'form-label small mb-1';
            labelAplicarA.textContent = 'Aplicar también a:';
            divAplicarA.appendChild(labelAplicarA);

            const divCheckboxesDias = document.createElement('div');
            // --- MODIFICACIÓN: Obtener el día actual de la fila desde indiceFila ---
            // El formato de indiceFila es "mes-semana-dia" (ej: "1-1-0")
            const partesIndice = indiceFila.toString().split('-');
            const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10); // Último elemento: indice del dia (0-6)

            // Mapear índice de día a nombre de día
            const nombresDiasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            const nombreDiaActual = nombresDiasSemana[indiceDiaArray] || 'Día desconocido';
            // --- FIN MODIFICACIÓN ---

            // Ejemplo de días (dinámico según los días de la semana)
            const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            diasSemana.forEach(dia => {
                // --- MODIFICACIÓN: Excluir el día actual de la fila ---
                if (dia !== nombreDiaActual) {
                // --- FIN MODIFICACIÓN ---
                    const divCheckInline = document.createElement('div');
                    divCheckInline.className = 'form-check form-check-inline';

                    const inputCheckDia = document.createElement('input');
                    inputCheckDia.className = 'form-check-input';
                    inputCheckDia.type = 'checkbox';
                    // --- MODIFICACIÓN: ID único basado en indiceFila y nombre del día ---
                    inputCheckDia.id = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
                    // --- FIN MODIFICACIÓN ---
                    inputCheckDia.name = `modalAplicarA_${idBase}`;
                    inputCheckDia.value = dia;

                    const labelCheckDia = document.createElement('label');
                    labelCheckDia.className = 'form-check-label small';
                    // --- MODIFICACIÓN: htmlFor único basado en indiceFila y nombre del día ---
                    labelCheckDia.htmlFor = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
                    // --- FIN MODIFICACIÓN ---
                    labelCheckDia.textContent = dia;

                    divCheckInline.appendChild(inputCheckDia);
                    divCheckInline.appendChild(labelCheckDia);
                    divCheckboxesDias.appendChild(divCheckInline);
                }
            });

            divAplicarA.appendChild(divCheckboxesDias);
            divFilaConfig.appendChild(divAplicarA);

    // Añadir la fila al contenedor
    contenedorConfiguracionMacros.appendChild(divFilaConfig);

    // Mostrar/Ocultar mensaje de "sin estrategias"
    if (mensajeSinEstrategias) {
        mensajeSinEstrategias.style.display = 'none';
    }

    // Añadir listeners para actualizar la suma en tiempo real
    const inputsMacros = [inputPt, inputCh, inputGr];
    inputsMacros.forEach(input => {
        input.addEventListener('input', function() {
            actualizarSumaMacrosEnModal(idBase);
        });
    });

    console.log(`[Modal Avanzado] Fila de configuración creada para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);
}


/**
 * Elimina una fila de configuración de macros para una estrategia específica en el modal.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 */
function eliminarFilaConfiguracionEstrategiaEnModal(indiceFila, nombreEstrategia) {
    console.log(`[Modal Avanzado] Eliminando fila de configuración para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);

    const idFilaConfig = `fila-config-${indiceFila}-${nombreEstrategia.replace(/\s+/g, '_')}`;
    const filaAEliminar = document.getElementById(idFilaConfig);
    const contenedorConfiguracionMacros = document.getElementById('modalConfiguracionMacrosPorEstrategia');
    const mensajeSinEstrategias = document.getElementById('modalMensajeSinEstrategias');

    if (filaAEliminar) {
        filaAEliminar.remove();
        console.log(`[Modal Avanzado] Fila de configuración eliminada para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);
    } else {
        console.warn(`[Modal Avanzado] No se encontró la fila de configuración para '${nombreEstrategia}' en fila ${indiceFila}.`);
    }

    // Mostrar/Ocultar mensaje de "sin estrategias" si no quedan más
    if (contenedorConfiguracionMacros && mensajeSinEstrategias) {
        if (contenedorConfiguracionMacros.children.length === 0) {
            mensajeSinEstrategias.style.display = 'block';
        }
    }
}

/**
 * Actualiza el mensaje de suma de macros en una fila de configuración del modal.
 * @param {string} idBase - El ID base para los elementos de macros (sin prefijo modalMacro).
 */
function actualizarSumaMacrosEnModal(idBase) {
    // console.log(`[Modal Avanzado] Actualizando suma de macros para idBase: ${idBase}`);

    const inputPt = document.getElementById(`modalMacroPt_${idBase}`);
    const inputCh = document.getElementById(`modalMacroCh_${idBase}`);
    const inputGr = document.getElementById(`modalMacroGr_${idBase}`);
    const mensajeElement = document.getElementById(`modalSumaMacros_${idBase}`);

    if (!inputPt || !inputCh || !inputGr || !mensajeElement) {
        // console.warn(`[Modal Avanzado] No se encontraron elementos para actualizar suma de macros con idBase: ${idBase}`);
        return; // Silencioso si no se encuentran los elementos (puede pasar durante la creación/eliminación)
    }

    const pt = parseInt(inputPt.value) || 0;
    const ch = parseInt(inputCh.value) || 0;
    const gr = parseInt(inputGr.value) || 0;
    const suma = pt + ch + gr;

    mensajeElement.textContent = `Suma: ${suma}%`;
    mensajeElement.classList.remove('text-success', 'text-danger');
    if (suma === 100) {
        mensajeElement.classList.add('text-success');
        // console.log(`[Modal Avanzado] Suma de macros para ${idBase} es válida: 100%`);
    } else {
        mensajeElement.classList.add('text-danger');
        // console.log(`[Modal Avanzado] Suma de macros para ${idBase} es inválida: ${suma}%`);
    }
}

/**
 * Aplica los cambios realizados en el modal de edición avanzado a la fila correspondiente.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 */
function aplicarCambiosDesdeModalAvanzado(indiceFila) {
    console.log(`[Modal Avanzado] Aplicando cambios desde el modal para la fila: ${indiceFila}`);

    try {
        // --- 1. Recoger valores del modal ---
        
        // a. Nivel de Actividad
        const modalSelectActividad = document.getElementById('modalSelectActividad');
        const nuevaActividadStr = modalSelectActividad ? modalSelectActividad.value : null;
        const nuevaActividad = nuevaActividadStr ? parseFloat(nuevaActividadStr) : null;
        if (nuevaActividad === null || isNaN(nuevaActividad)) {
            alert("Error: Nivel de actividad inválido.");
            return;
        }

        // b. Estrategias seleccionadas
        const checkboxesEstrategias = document.querySelectorAll('#modalCheckboxesEstrategias input[type="checkbox"]:checked');
        const nuevasEstrategias = Array.from(checkboxesEstrategias).map(cb => cb.value);
        console.log("[Modal Avanzado] Estrategias seleccionadas:", nuevasEstrategias);

        // c. Ajuste de Calorías Diario Manual
        let ajusteCaloriasDiarioManual = null; // null indica que no se cambia
        const inputAjusteCalorias = document.getElementById('modalInputAjusteCalorias');
        if (inputAjusteCalorias && inputAjusteCalorias.value !== "") {
            const valorIngresado = parseFloat(inputAjusteCalorias.value);
            if (!isNaN(valorIngresado)) {
                ajusteCaloriasDiarioManual = valorIngresado;
                console.log(`[Modal Avanzado] Ajuste de calorías manual solicitado: ${ajusteCaloriasDiarioManual} kcal/día`);
            } else {
                console.warn("[Modal Avanzado] Valor inválido en el input de ajuste de calorías. Se ignorará.");
                // Opcional: alert("Advertencia: El valor ingresado para el ajuste de calorías no es un número válido. Se ignorará.");
            }
        }

        // d. Macros por estrategia (si se configuraron)
        const filasConfiguracion = document.querySelectorAll('.fila-configuracion-estrategia');
        const macrosPorEstrategia = {};
        filasConfiguracion.forEach(fila => {
            const nombreEstrategia = fila.getAttribute('data-estrategia-id');
            if (nombreEstrategia) {
                const idBase = `${indiceFila}_${nombreEstrategia.replace(/\s+/g, '_')}`;
                const inputPt = document.getElementById(`modalMacroPt_${idBase}`);
                const inputCh = document.getElementById(`modalMacroCh_${idBase}`);
                const inputGr = document.getElementById(`modalMacroGr_${idBase}`);
                
                if (inputPt && inputCh && inputGr) {
                    const pt = parseInt(inputPt.value) || 0;
                    const ch = parseInt(inputCh.value) || 0;
                    const gr = parseInt(inputGr.value) || 0;
                    const suma = pt + ch + gr;
                    
                    if (suma === 100) {
                        macrosPorEstrategia[nombreEstrategia] = { proteinas: pt, carbohidratos: ch, grasas: gr };
                        console.log(`[Modal Avanzado] Macros configurados para ${nombreEstrategia}: Pt=${pt}%, CH=${ch}%, GR=${gr}%`);
                    } else {
                         alert(`Error: La suma de macros para la estrategia '${nombreEstrategia}' debe ser 100%. Actual: ${suma}%.`);
                         console.error(`[Modal Avanzado] Suma de macros inválida para ${nombreEstrategia}: ${suma}%`);
                         // Resaltar el mensaje de error
                         actualizarSumaMacrosEnModal(idBase);
                         const mensajeElement = document.getElementById(`modalSumaMacros_${idBase}`);
                         if (mensajeElement) mensajeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                         return; // Detener la aplicación de cambios
                    }
                }
            }
        });

        // --- 2. Aplicar cambios ---
        
        // a. Cambiar actividad (esto recalcula TDEE y calorías base)
        // Pasamos el ajuste manual como parámetro adicional
        if (typeof actualizarFilaPorActividad === 'function') {
            actualizarFilaPorActividad(indiceFila, nuevaActividad.toString(), ajusteCaloriasDiarioManual);
        } else {
            console.error("[Modal Avanzado] La función 'actualizarFilaPorActividad' no está definida.");
        }

        // b. Cambiar estrategias (esto recalcula lo necesario basado en las nuevas estrategias)
        // Pasamos un array de strings directamente Y el ajuste manual para que actualice la nota correctamente
        if (typeof actualizarFilaPorEstrategias === 'function') {
            actualizarFilaPorEstrategias(indiceFila, nuevasEstrategias, ajusteCaloriasDiarioManual);
        } else {
            console.error("[Modal Avanzado] La función 'actualizarFilaPorEstrategias' no está definida.");
        }

        // c. Cambiar macros manualmente por estrategia (si se configuraron)
        // Esta parte requiere una nueva función o modificar la existente para manejar macros por estrategia
        // Por ahora, solo registramos los valores recogidos.
        if (Object.keys(macrosPorEstrategia).length > 0) {
            console.log("[Modal Avanzado] Macros por estrategia configurados:", macrosPorEstrategia);
            // Aquí iría la lógica para aplicar estos macros específicos por estrategia
            // Por ejemplo, podrías llamar a una nueva función:
            // if (typeof aplicarMacrosPorEstrategia === 'function') {
            //     aplicarMacrosPorEstrategia(indiceFila, macrosPorEstrategia);
            // }
        } else {
            console.log("[Modal Avanzado] No se configuraron macros específicos por estrategia.");
        }

        console.log(`[Modal Avanzado] Cambios aplicados con éxito desde el modal para la fila ${indiceFila}.`);
        
        // Cerrar el modal
        const modalElement = document.getElementById('editarFilaModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide();
        }

    } catch (error) {
        console.error(`[Modal Avanzado] Error al aplicar cambios desde el modal para la fila ${indiceFila}:`, error);
        alert("Hubo un error al aplicar los cambios. Por favor, inténtalo de nuevo.");
    }
 }
// --- MODAL DOBLECK CLICK MODIFICAR DATOS FILA tABLA DETALLADA ---

/**
 * Abre el modal de edición para una fila específica.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 */

/**
 * Abre el modal de edición mejorado para una fila específica.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 */
/**
 * Abre el modal de edición avanzado para una fila específica.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 */
function abrirModalEdicion(indiceFila) {
    console.log(`[Modal Edición] Intentando abrir modal para fila: ${indiceFila}`);

    try {
        // --- 1. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`[Modal Edición] No se encontró la fila con ID 'fila-detalle-${indiceFila}'.`);
            alert("Error: No se pudo encontrar la fila para editar.");
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`[Modal Edición] No se encontró la tabla contenedora para la fila ${indiceFila}.`);
            alert("Error: No se pudo encontrar la tabla asociada.");
            return;
        }

        // --- 2. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;
        const estrategiasDisponibles = tablaElement.estrategiasDisponibles || [];

        // Encontrar los datos originales específicos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
             console.error(`[Modal Edición] Índice de día inválido en 'data-indice-fila': ${indiceFila}`);
             alert("Error: Índice de fila inválido.");
             return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
             console.error(`[Modal Edición] No se encontraron datos originales para el día ${indiceDiaArray} en la fila ${indiceFila}.`);
             alert("Error: No se encontraron datos base para esta fila.");
             return;
        }

        // --- 3. --- NUEVO --- Popular el modal con los nuevos datos ---
        // Esta es la función central que hace todo el trabajo de llenar el modal
        popularModalEdicionAvanzado(indiceFila);

        // --- 4. --- NUEVO --- Asociar el índice de fila al botón de aplicar ---
        // Esto es crucial para que aplicarCambiosDesdeModalAvanzado sepa qué fila actualizar
        const botonAplicar = document.getElementById('modalBotonAplicar');
        if (botonAplicar) {
            botonAplicar.setAttribute('data-indice-fila', indiceFila);
            console.log(`[Modal Edición] Índice de fila ${indiceFila} asociado al botón 'Aplicar Cambios'.`);
        } else {
            console.error("[Modal Edición] Botón 'Aplicar Cambios' no encontrado en el modal.");
        }

        // --- 5. Mostrar el modal ---
        const modalElement = document.getElementById('editarFilaModal');
        if (modalElement) {
            const modalInstance = new bootstrap.Modal(modalElement);
            modalInstance.show();
            console.log(`[Modal Edición] Modal mostrado para fila ${indiceFila}.`);
        } else {
            console.error("[Modal Edición] Elemento del modal principal '#editarFilaModal' no encontrado.");
            alert("Error: No se pudo abrir el editor. El modal no se encontró.");
        }

    } catch (error) {
        console.error(`[Modal Edición] Error al abrir el modal para la fila ${indiceFila}:`, error);
        alert("Hubo un error al abrir el editor. Por favor, inténtalo de nuevo.");
    }
}

// --- Función auxiliar para crear la fila de configuración de una estrategia ---
// Esta función se llamará desde el event listener del checkbox.
/**
 * Crea el HTML para la fila de configuración de macros de una estrategia específica.
 * @param {string} indiceFila - El índice de la fila.
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 * @returns {HTMLElement|null} El elemento div que representa la fila de configuración, o null si hay error.
 */
function crearFilaConfiguracionEstrategia(indiceFila, nombreEstrategia) {
    if (!indiceFila || !nombreEstrategia) {
        console.error("Error: Faltan parámetros para crear la fila de configuración.");
        return null;
    }

    const filaConfigId = `fila-config-${indiceFila}-${nombreEstrategia.replace(/\s+/g, '_')}`;
    const idBase = `${indiceFila}_${nombreEstrategia.replace(/\s+/g, '_')}`;

    // Crear el contenedor de la fila
    const divFila = document.createElement('div');
    divFila.className = 'border rounded p-3 mb-3 bg-white shadow-sm fila-configuracion-estrategia'; // Clase CSS del CSS proporcionado
    divFila.setAttribute('data-estrategia-id', nombreEstrategia); // Para identificar la estrategia
    divFila.id = filaConfigId;

    // Crear el encabezado de la fila (nombre + botón cerrar)
    const divHeader = document.createElement('div');
    divHeader.className = 'd-flex justify-content-between align-items-center mb-2';

    const h6Nombre = document.createElement('h6');
    h6Nombre.className = 'mb-0 text-primary nombre-estrategia'; // Clase CSS del CSS proporcionado
    h6Nombre.textContent = nombreEstrategia;

    const botonCerrar = document.createElement('button');
    botonCerrar.type = 'button';
    botonCerrar.className = 'btn-close boton-cerrar-fila-estrategia'; // Clase CSS del CSS proporcionado
    botonCerrar.setAttribute('aria-label', 'Eliminar');
    botonCerrar.title = 'Eliminar estrategia';
    // Añadir evento para eliminar esta fila específica
    botonCerrar.addEventListener('click', function() {
        const filaAEliminar = document.getElementById(filaConfigId);
        if (filaAEliminar) {
            filaAEliminar.remove();
            // Desmarcar el checkbox correspondiente
            const checkboxId = `modalCheckbox_${nombreEstrategia.replace(/\s+/g, '_')}`;
            const checkboxCorrespondiente = document.getElementById(checkboxId);
            if (checkboxCorrespondiente) {
                checkboxCorrespondiente.checked = false;
            }
            // Mostrar/Ocultar mensaje de "sin estrategias" si no quedan más
            const contenedorConfig = document.getElementById('modalConfiguracionMacrosPorEstrategia');
            if (contenedorConfig && contenedorConfig.children.length === 0) {
                document.getElementById('modalMensajeSinEstrategias').style.display = 'block';
            }
        }
    });

    divHeader.appendChild(h6Nombre);
    divHeader.appendChild(botonCerrar);
    divFila.appendChild(divHeader);

    // Crear el grupo de inputs de macros
    const divGrupoMacros = document.createElement('div');
    divGrupoMacros.className = 'row g-2 align-items-end grupo-macros-estrategia'; // Clase CSS del CSS proporcionado

    // Input Proteínas
    const divColPt = document.createElement('div');
    divColPt.className = 'col-md-3';
    const labelPt = document.createElement('label');
    labelPt.className = 'form-label small mb-1'; // Clase CSS del CSS proporcionado
    labelPt.htmlFor = `modalMacroPt_${idBase}`;
    labelPt.textContent = '% Proteínas';
    const inputPt = document.createElement('input');
    inputPt.type = 'number';
    inputPt.className = 'form-control form-control-sm'; // Clase CSS del CSS proporcionado
    inputPt.id = `modalMacroPt_${idBase}`;
    inputPt.name = `modalMacroPt_${idBase}`; // Añadir name para facilidad de acceso
    inputPt.min = '0';
    inputPt.max = '100';
    inputPt.value = '20'; // Valor por defecto o extraído si se tuviera

    divColPt.appendChild(labelPt);
    divColPt.appendChild(inputPt);
    divGrupoMacros.appendChild(divColPt);

    // Input Carbohidratos
    const divColCh = document.createElement('div');
    divColCh.className = 'col-md-3';
    const labelCh = document.createElement('label');
    labelCh.className = 'form-label small mb-1';
    labelCh.htmlFor = `modalMacroCh_${idBase}`;
    labelCh.textContent = '% Carbohidratos';
    const inputCh = document.createElement('input');
    inputCh.type = 'number';
    inputCh.className = 'form-control form-control-sm';
    inputCh.id = `modalMacroCh_${idBase}`;
    inputCh.name = `modalMacroCh_${idBase}`;
    inputCh.min = '0';
    inputCh.max = '100';
    inputCh.value = '40';

    divColCh.appendChild(labelCh);
    divColCh.appendChild(inputCh);
    divGrupoMacros.appendChild(divColCh);

    // Input Grasas
    const divColGr = document.createElement('div');
    divColGr.className = 'col-md-3';
    const labelGr = document.createElement('label');
    labelGr.className = 'form-label small mb-1';
    labelGr.htmlFor = `modalMacroGr_${idBase}`;
    labelGr.textContent = '% Grasas';
    const inputGr = document.createElement('input');
    inputGr.type = 'number';
    inputGr.className = 'form-control form-control-sm';
    inputGr.id = `modalMacroGr_${idBase}`;
    inputGr.name = `modalMacroGr_${idBase}`;
    inputGr.min = '0';
    inputGr.max = '100';
    inputGr.value = '40';

    divColGr.appendChild(labelGr);
    divColGr.appendChild(inputGr);
    divGrupoMacros.appendChild(divColGr);

    // Texto de suma de macros
    const divColSuma = document.createElement('div');
    divColSuma.className = 'col-md-3';
    const divTextoSuma = document.createElement('div');
    divTextoSuma.className = 'form-text text-muted small texto-suma-macros-estrategia'; // Clase CSS del CSS proporcionado
    divTextoSuma.id = `modalSumaMacros_${idBase}`;
    divTextoSuma.textContent = 'Suma: 100%'; // Valor inicial

    // Añadir listener para actualizar la suma en tiempo real
    const actualizarSuma = () => {
        const pt_val = parseInt(inputPt.value) || 0;
        const ch_val = parseInt(inputCh.value) || 0;
        const gr_val = parseInt(inputGr.value) || 0;
        const suma_val = pt_val + ch_val + gr_val;
        divTextoSuma.textContent = `Suma: ${suma_val}%`;
        // Opcional: Añadir clases para feedback visual (ok/error)
        divTextoSuma.classList.remove('text-success', 'text-danger');
        if (suma_val === 100) {
            divTextoSuma.classList.add('text-success');
        } else {
            divTextoSuma.classList.add('text-danger');
        }
    };
    inputPt.addEventListener('input', actualizarSuma);
    inputCh.addEventListener('input', actualizarSuma);
    inputGr.addEventListener('input', actualizarSuma);
    // Llamar una vez para inicializar
    actualizarSuma();

    divColSuma.appendChild(divTextoSuma);
    divGrupoMacros.appendChild(divColSuma);

    divFila.appendChild(divGrupoMacros);

    // Crear la sección de "Aplicar también a:"
    const divAplicarA = document.createElement('div');
    divAplicarA.className = 'mt-2 seccion-aplicar-a-estrategia'; // Clase CSS del CSS proporcionado

    const labelAplicarA = document.createElement('label');
    labelAplicarA.className = 'form-label small mb-1'; // Clase CSS del CSS proporcionado
    labelAplicarA.textContent = 'Aplicar también a:'; // Texto de la etiqueta

    const divCheckboxesDias = document.createElement('div');
    // Ejemplo de días (debería ser dinámico según los días de la semana)
    const diasSemana = ['Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado']; // Excluyendo Lunes y Domingo como ejemplo
    diasSemana.forEach(dia => {
        const divCheckInline = document.createElement('div');
        divCheckInline.className = 'form-check form-check-inline'; // Clase CSS del CSS proporcionado

        const inputCheckDia = document.createElement('input');
        inputCheckDia.className = 'form-check-input'; // Clase CSS del CSS proporcionado
        inputCheckDia.type = 'checkbox';
        inputCheckDia.id = `modalAplicarA${dia}_${idBase}`;
        inputCheckDia.name = `modalAplicarA_${idBase}`; // Mismo name para agrupar si es necesario
        inputCheckDia.value = dia;

        const labelCheckDia = document.createElement('label');
        labelCheckDia.className = 'form-check-label small'; // Clase CSS del CSS proporcionado
        labelCheckDia.htmlFor = `modalAplicarA${dia}_${idBase}`;
        labelCheckDia.textContent = dia;

        divCheckInline.appendChild(inputCheckDia);
        divCheckInline.appendChild(labelCheckDia);
        divCheckboxesDias.appendChild(divCheckInline);
    });

    divAplicarA.appendChild(labelAplicarA);
    divAplicarA.appendChild(divCheckboxesDias);
    divFila.appendChild(divAplicarA);

    return divFila;
}


// --- Funciones auxiliares para el modal (ya existentes, posiblemente modificadas) ---

/**
 * Actualiza el mensaje de suma de macros en el modal.
 * (Esta función puede ser redundante con la lógica de suma por fila, pero la mantengo por si acaso)
 */
function actualizarMensajeSumaMacros() {
    // Esta función podría quedar obsoleta o modificada para funcionar
    // con los nuevos inputs si se decide mantener los inputs generales.
    // Por ahora, la dejo como está, pero probablemente no se use.
    const inputPt = document.getElementById('modalInputProteinasPct');
    const inputCh = document.getElementById('modalInputCarbohidratosPct');
    const inputGr = document.getElementById('modalInputGrasasPct');
    const mensajeElement = document.getElementById('modalMensajeSumaMacros');

    if (!inputPt || !inputCh || !inputGr || !mensajeElement) return;

    const pt = parseInt(inputPt.value) || 0;
    const ch = parseInt(inputCh.value) || 0;
    const gr = parseInt(inputGr.value) || 0;
    const suma = pt + ch + gr;

    mensajeElement.textContent = `Suma actual: ${suma}%`;
    mensajeElement.classList.remove('error', 'ok');
    if (suma === 100) {
        mensajeElement.classList.add('ok');
    } else {
        mensajeElement.classList.add('error');
    }
}

/**
 * Aplica los porcentajes de macros configurados para una estrategia específica a una fila de la tabla.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 * @param {string} estrategiaId - El ID único de la estrategia (ej: 'carb_cycling').
 * @param {Object} porcentajes - Un objeto con las claves 'proteinas', 'carbohidratos', 'grasas' y valores numéricos (%).
 */
function aplicarMacrosPorEstrategia(indiceFila, estrategiaId, porcentajes) {
    console.log(`[Modal Avanzado] Aplicando macros por estrategia '${estrategiaId}' para la fila ${indiceFila}:`, porcentajes);

    try {
        // --- 1. Validar argumentos ---
        if (!indiceFila || !estrategiaId || !porcentajes) {
            console.error("[Modal Avanzado] Faltan argumentos para aplicar macros por estrategia:", { indiceFila, estrategiaId, porcentajes });
            return;
        }

        if (typeof porcentajes !== 'object' || porcentajes === null) {
            console.error("[Modal Avanzado] 'porcentajes' debe ser un objeto válido.", porcentajes);
            return;
        }

        const pt_pct = parseFloat(porcentajes.proteinas);
        const ch_pct = parseFloat(porcentajes.carbohidratos);
        const gr_pct = parseFloat(porcentajes.grasas);

        if (isNaN(pt_pct) || isNaN(ch_pct) || isNaN(gr_pct)) {
            console.error("[Modal Avanzado] Todos los porcentajes deben ser números válidos.", porcentajes);
            return;
        }

        const suma = pt_pct + ch_pct + gr_pct;
        if (Math.abs(suma - 100) > 0.1) { // Tolerancia para errores de punto flotante
            console.warn(`[Modal Avanzado] Advertencia: La suma de porcentajes (${suma}%) para la estrategia '${estrategiaId}' no es 100%. Se procederá con el cálculo.`);
            // O decidir si quieres detener la ejecución aquí.
            // alert(`Advertencia: La suma de porcentajes (${suma}%) para la estrategia '${estrategiaId}' no es 100%.`);
        }

        // --- 2. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`[Modal Avanzado] No se encontró la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`[Modal Avanzado] No se encontró la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 3. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;
        const estrategiasDisponibles = tablaElement.estrategiasDisponibles || [];

        // Encontrar los datos originales específicos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
             console.error(`[Modal Avanzado] Índice de día inválido en 'data-indice-fila': ${indiceFila}`);
             return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
             console.error(`[Modal Avanzado] No se encontraron datos originales para el día ${indiceDiaArray} en la fila ${indiceFila}.`);
             return;
        }

        // --- 4. Obtener el nivel de actividad actual de la fila ---
        const selectActividadElement = document.getElementById(`select-actividad-${indiceFila}`);
        let actividadActual = datosFilaOriginal.actividad; // Valor por defecto
        if (selectActividadElement) {
            actividadActual = parseFloat(selectActividadElement.value);
            if (isNaN(actividadActual)) {
                console.warn(`[Modal Avanzado] Nivel de actividad inválido en select para fila ${indiceFila}. Usando original.`);
                actividadActual = datosFilaOriginal.actividad;
            }
        }

        // --- 5. Recalcular TMB y TDEE usando el peso estimado actual de la fila ---
        const pesoEstimadoKg = datosFilaOriginal.pesoEstimado;

        // Recalcular TMB usando las variables globales userGender, userHeightCm, userAge
        let tmbActual = 0;
        if (typeof userGender === 'undefined' || typeof userHeightCm === 'undefined' || typeof userAge === 'undefined') {
             console.error("[Modal Avanzado] Variables de usuario (userGender, userHeightCm, userAge) no definidas. No se puede calcular TMB.");
             return;
        }
        if (userGender === 'male') {
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else { // Asumimos 'female' si no es 'male'
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        // Calcular TDEE usando el TMB recién calculado y la actividad actual
        const tdeeActual = tmbActual * actividadActual;

        // --- 6. Calcular nuevas calorías diarias objetivo ---
        let nuevasCaloriasDiarias = tdeeActual;
        // Aquí no aplicamos ajusteCaloriasDiarioManual porque esta función se llama desde el modal
        // y el ajuste ya se aplicó en actualizarFilaPorActividad o actualizarFilaPorEstrategias.
        // Si se necesita aplicar un ajuste específico de esta estrategia, se haría aquí.
        // Por ahora, asumimos que las calorías ya están ajustadas por otras funciones.

        // --- 7. Usar los nuevos porcentajes proporcionados ---
        let nuevasProteinasPctDia = pt_pct;
        let nuevasCarbohidratosPctDia = ch_pct;
        let nuevasGrasasPctDia = gr_pct;

        // --- 8. Asegurar que los porcentajes sumen 100% ---
        // Ya se validó la suma, pero si se quiere forzar ajuste:
        /*
        const totalPct = nuevasProteinasPctDia + nuevasCarbohidratosPctDia + nuevasGrasasPctDia;
        if (Math.abs(totalPct - 100) > 0.1) {
            const diff = 100 - totalPct;
            nuevasGrasasPctDia += diff;
            console.warn(`[Modal Avanzado] Porcentajes ajustados en Fila ${indiceFila} para sumar 100%.`);
        }
        */

        // --- 9. Calcular nuevos gramos de macros ---
        const nuevasProteinas_g = Math.round((nuevasCaloriasDiarias * nuevasProteinasPctDia / 100) / 4);
        const nuevasCarbohidratos_g = Math.round((nuevasCaloriasDiarias * nuevasCarbohidratosPctDia / 100) / 4);
        const nuevasGrasas_g = Math.round((nuevasCaloriasDiarias * nuevasGrasasPctDia / 100) / 9);

        // --- 10. Asegurar un mínimo de calorías por seguridad ---
        const limiteCaloriasMin = (typeof userGender !== 'undefined' && userGender === 'female') ? 1200 : 1500;
        if (nuevasCaloriasDiarias < limiteCaloriasMin) {
            console.warn(`[Modal Avanzado] Calorías ajustadas en Fila ${indiceFila} por debajo del límite (${limiteCaloriasMin}).`);
            nuevasCaloriasDiarias = limiteCaloriasMin;
        }

        // --- 11. Actualizar la UI ---
        // a. Actualizar celda de calorías
        const celdaCalorias = document.getElementById(`calorias-${indiceFila}`);
        if (celdaCalorias) {
            celdaCalorias.textContent = Math.round(nuevasCaloriasDiarias);
        }

        // b. Actualizar celdas de macros (% y g)
        // Celda % Pt y g (primera .text-center)
        const celdasPt = filaElement.querySelectorAll('td.text-center')[0];
        if (celdasPt) {
            celdasPt.innerHTML = `<strong>${Math.round(nuevasProteinasPctDia)}%</strong><br><small>${nuevasProteinas_g}g</small>`;
        }

        // Celda % CH y g (segunda .text-center)
        const celdasCH = filaElement.querySelectorAll('td.text-center')[1];
        if (celdasCH) {
            celdasCH.innerHTML = `<strong>${Math.round(nuevasCarbohidratosPctDia)}%</strong><br><small>${nuevasCarbohidratos_g}g</small>`;
        }

        // Celda % GR y g (tercera .text-center)
        const celdasGR = filaElement.querySelectorAll('td.text-center')[2];
        if (celdasGR) {
            celdasGR.innerHTML = `<strong>${Math.round(nuevasGrasasPctDia)}%</strong><br><small>${nuevasGrasas_g}g</small>`;
        }

        // c. (Opcional) Actualizar celda de notas para indicar el cambio de macros por estrategia
        // Esta parte es más compleja porque implica parsear y reconstruir la nota.
        // Se puede hacer, pero requiere más lógica para identificar y reemplazar la parte de macros.
        // Por ahora, se omite o se deja para una actualización posterior de la nota completa.
        
        console.log(`[Modal Avanzado] Macros aplicados con éxito por estrategia '${estrategiaId}' en fila ${indiceFila}.`);
        console.log({
            nuevasCaloriasDiarias,
            nuevasProteinasPctDia,
            nuevasCarbohidratosPctDia,
            nuevasGrasasPctDia,
            nuevasProteinas_g,
            nuevasCarbohidratos_g,
            nuevasGrasas_g
        });

    } catch (error) {
        console.error(`[Modal Avanzado] Error al aplicar macros por estrategia '${estrategiaId}' en fila ${indiceFila}:`, error);
        // Opcional: Mostrar mensaje de error al usuario
        // alert(`Hubo un error al aplicar los macros para la estrategia '${estrategiaId}'. Por favor, inténtalo de nuevo.`);
    }
}
// --- Event Listeners (ya existentes, posiblemente modificadas) ---

// Añadir listeners para actualizar el mensaje de suma en tiempo real (inputs generales)
// (Este listener podría eliminarse si los inputs generales se eliminan por completo)
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editarFilaModal');
    if (modal) {
        modal.addEventListener('shown.bs.modal', function () {
            const inputsMacros = modal.querySelectorAll('#modalInputProteinasPct, #modalInputCarbohidratosPct, #modalInputGrasasPct');
            inputsMacros.forEach(input => {
                input.addEventListener('input', actualizarMensajeSumaMacros);
            });
            // Inicializar mensaje
            actualizarMensajeSumaMacros();
        });
    }
});

// Manejador del botón "Aplicar Cambios" del modal
document.addEventListener('click', function(event) {
    if (event.target && event.target.id === 'modalBotonAplicar') {
        event.preventDefault();
        const indiceFila = event.target.getAttribute('data-indice-fila');
        if (indiceFila) {
            aplicarCambiosDesdeModal(indiceFila);
        } else {
            console.error("No se encontró el índice de fila en el botón Aplicar.");
            alert("Error al aplicar cambios: Índice de fila no encontrado.");
        }
    }
});

/**
 * Recoge los valores del modal y aplica los cambios a la fila correspondiente.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 */
function aplicarCambiosDesdeModal(indiceFila) {
    console.log(`Aplicando cambios desde el modal para la fila: ${indiceFila}`);

    // --- 1. Recoger valores del modal ---
    const nuevaActividad = parseFloat(document.getElementById('modalSelectActividad').value);
    if (isNaN(nuevaActividad)) {
        alert("Error: Nivel de actividad inválido.");
        return;
    }

    // Recoger estrategias seleccionadas
    const checkboxesEstrategias = document.querySelectorAll('#modalCheckboxesEstrategias input[type="checkbox"]:checked');
    const nuevasEstrategias = Array.from(checkboxesEstrategias).map(cb => cb.value);
    console.log("Estrategias seleccionadas en el modal:", nuevasEstrategias);

    // Recoger macros
    const inputPt = document.getElementById('modalInputProteinasPct');
    const inputCh = document.getElementById('modalInputCarbohidratosPct');
    const inputGr = document.getElementById('modalInputGrasasPct');

    let nuevosPorcentajes = null;
    if (inputPt && inputCh && inputGr) {
        const pt = parseInt(inputPt.value);
        const ch = parseInt(inputCh.value);
        const gr = parseInt(inputGr.value);
        const suma = pt + ch + gr;
        
        if (!isNaN(pt) && !isNaN(ch) && !isNaN(gr)) {
            if (suma === 100) {
                nuevosPorcentajes = { proteinas: pt, carbohidratos: ch, grasas: gr };
            } else {
                 alert(`Error: La suma de los porcentajes de macros debe ser 100%. Actual: ${suma}%.`);
                 // Resaltar el mensaje de error
                 actualizarMensajeSumaMacros();
                 const mensajeElement = document.getElementById('modalMensajeSumaMacros');
                 if (mensajeElement) mensajeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                 return; // Detener la aplicación de cambios
            }
        } else {
            // Si los inputs están vacíos o no son números válidos, no se aplican cambios de macros
            console.log("Valores de macros inválidos o vacíos, no se aplicarán cambios de macros.");
        }
    }

    // (Nuevo) Recoger Ajuste de Calorías
    let ajusteCaloriasDiarioManual = null; // null indica que no se cambia
    const inputAjusteCalorias = document.getElementById('modalInputAjusteCalorias');
    if (inputAjusteCalorias && inputAjusteCalorias.value !== "") {
        const valorIngresado = parseFloat(inputAjusteCalorias.value);
        if (!isNaN(valorIngresado)) {
            ajusteCaloriasDiarioManual = valorIngresado;
            console.log(`Ajuste de calorías manual solicitado: ${ajusteCaloriasDiarioManual} kcal/día`);
        } else {
            console.warn("Valor inválido en el input de ajuste de calorías. Se ignorará.");
        }
    }

    // --- 2. Aplicar cambios ---
    try {
        // a. Cambiar actividad (esto recalculará calorías y macros base)
        // Pasamos el ajuste manual como parámetro adicional
		
        actualizarFilaPorActividad(indiceFila, nuevaActividad.toString(), ajusteCaloriasDiarioManual);

        // b. Cambiar estrategias (esto recalcula lo necesario basado en las nuevas estrategias y puede ajustar calorías/macros)
        // Pasamos un array de strings directamente Y el ajuste manual para que actualice la nota correctamente
        actualizarFilaPorEstrategias(indiceFila, nuevasEstrategias);

        // c. Cambiar macros manualmente (si se proporcionaron)
        // Esto se hace al final para que sobrescriba cualquier cálculo previo de macros
        if (nuevosPorcentajes) {
             if (typeof actualizarFilaPorMacros === 'function') {
                 // Pasamos el ajuste manual a esta función también
                 actualizarFilaPorMacros(indiceFila, nuevosPorcentajes, ajusteCaloriasDiarioManual);
             } else {
                 console.warn("La función 'actualizarFilaPorMacros' no está definida. Los cambios de macros manuales no se aplicarán.");
                 // Opcional: alert("Nota: Los ajustes manuales de macros no se pudieron aplicar...");
             }
        }

        console.log("Cambios aplicados con éxito desde el modal.");
        // Cerrar el modal
        const modalElement = document.getElementById('editarFilaModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide();
        }

    } catch (error) {
        console.error("Error al aplicar cambios desde el modal:", error);
        alert("Hubo un error al aplicar los cambios. Por favor, inténtalo de nuevo.");
    }
}

// --- Añadir doble clic a las celdas de Día ---
// Usando delegación de eventos en el documento (se ejecuta una vez cargado el DOM)
document.addEventListener('dblclick', function(event) {
    // Verificar si el elemento clickeado (o un ancestro) es una celda <td> de la primera columna (Día)
    const celdaDia = event.target.closest('tbody td:first-child');
    
    if (celdaDia) {
        // Encontrar la fila <tr> contenedora
        const fila = celdaDia.closest('tr');
        if (fila && fila.id && fila.id.startsWith('fila-detalle-')) {
            // Extraer el indiceFila del ID de la fila
            const indiceFila = fila.id.replace('fila-detalle-', '');
            if (indiceFila) {
                console.log(`Doble clic detectado en la fila: ${indiceFila}`);
                abrirModalEdicion(indiceFila);
            }
        }
    }
});

/**
 * Actualiza una fila de la tabla detallada cuando se cambian los porcentajes de macros manualmente.
 * Recalcula gramos de macros y calorías basados en los nuevos porcentajes y el TDEE actual.
 * @param {string} indiceFila - El índice de la fila (formato "mes-semana-dia").
 * @param {Object} nuevosPorcentajes - Un objeto con las nuevas claves `proteinas`, `carbohidratos`, `grasas` (valores enteros o float).
 */
	// Modifica la firma de la función
	function actualizarFilaPorMacros(indiceFila, nuevosPorcentajes, ajusteCaloriasDiarioManual = null) {
		console.log(`Actualizando fila ${indiceFila} por cambio manual de macros a:`, nuevosPorcentajes, `. Ajuste manual: ${ajusteCaloriasDiarioManual}`);
		// ... resto de la función ...

    // --- Validación de entrada ---
    if (!nuevosPorcentajes || typeof nuevosPorcentajes !== 'object') {
        console.error("Error: nuevosPorcentajes debe ser un objeto con claves 'proteinas', 'carbohidratos', 'grasas'.");
        // Opcional: alert("Error: Formato de porcentajes inválido.");
        return;
    }

    const pt_pct = parseFloat(nuevosPorcentajes.proteinas);
    const ch_pct = parseFloat(nuevosPorcentajes.carbohidratos);
    const gr_pct = parseFloat(nuevosPorcentajes.grasas);

    if (isNaN(pt_pct) || isNaN(ch_pct) || isNaN(gr_pct)) {
        console.error("Error: Todos los porcentajes deben ser números válidos.", nuevosPorcentajes);
        // Opcional: alert("Error: Porcentajes de macros inválidos.");
        return;
    }

    const suma = pt_pct + ch_pct + gr_pct;
    if (Math.abs(suma - 100) > 0.1) { // Tolerancia para errores de punto flotante
        console.warn(`Advertencia: La suma de porcentajes (${suma}%) no es exactamente 100%. Se procederá con el cálculo.`);
        // O decidir si quieres detener la ejecución aquí.
        // alert(`Advertencia: La suma de porcentajes (${suma}%) no es 100%.`);
    }

    try {
        // --- 1. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`No se encontró la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`No se encontró la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 2. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;
       
        // Encontrar los datos originales específicos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
             console.error(`Índice de día inválido en 'data-indice-fila': ${indiceFila}`);
             return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
             console.error(`No se encontraron datos originales para el día ${indiceDiaArray} en la fila ${indiceFila}.`);
             return;
        }

                // --- 3. Recalcular TMB y TDEE para el peso estimado actual de la fila ---
        // Obtenemos el peso estimado actual directamente de los datos originales de la fila.
        // Este peso ya refleja la estimación para el inicio de la semana a la que pertenece el día.
        const pesoEstimadoKg = datosFilaOriginal.pesoEstimado;

        // Obtenemos la actividad actual del select de la fila.
        const selectActividadElement = document.getElementById(`select-actividad-${indiceFila}`);
        let actividadActual = datosFilaOriginal.actividad; // Valor por defecto
        if (selectActividadElement) {
            actividadActual = parseFloat(selectActividadElement.value);
            if (isNaN(actividadActual)) {
                console.warn(`Nivel de actividad inválido en select para fila ${indiceFila}. Usando original.`);
                actividadActual = datosFilaOriginal.actividad;
            }
        }

        // Recalcular TMB usando las variables globales userGender, userHeightCm, userAge
        // que se asume están disponibles (igual que en generarDatosTablaDetallada).
        let tmbActual = 0;
        if (typeof userGender === 'undefined' || typeof userHeightCm === 'undefined' || typeof userAge === 'undefined') {
             console.error("Variables de usuario (userGender, userHeightCm, userAge) no definidas. No se puede calcular TMB.");
             return;
        }
        if (userGender === 'male') {
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else { // Asumimos 'female' si no es 'male'
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        // Calcular TDEE usando el TMB recién calculado y la actividad actual
        const tdeeActual = tmbActual * actividadActual;

        console.log(`Fila ${indiceFila}: TMB calculado=${tmbActual.toFixed(2)}, TDEE calculado=${tdeeActual.toFixed(2)}, Actividad=${actividadActual}`);

        // --- 4. Calcular nuevas calorías diarias objetivo ---
        // Aplicar el ajuste calórico semanal existente
        let nuevasCaloriasDiarias = tdeeActual;
		// Priorizar el ajuste manual si se proporciona
		if (ajusteCaloriasDiarioManual !== null) {
			nuevasCaloriasDiarias += ajusteCaloriasDiarioManual;
			console.log(`Usando ajuste de calorías manual: ${ajusteCaloriasDiarioManual} kcal/día`);
		} else {
			// Si no hay ajuste manual, usar el ajuste semanal global
			const ajusteCaloriasSemanal = weeklyCalorieDiffManualGlobal; // Puede ser null/number
			const ajusteCaloriasDiarioGlobal = ajusteCaloriasSemanal !== null ? ajusteCaloriasSemanal / 7 : 0;
			nuevasCaloriasDiarias += ajusteCaloriasDiarioGlobal;
			console.log(`Usando ajuste de calorías global: ${ajusteCaloriasDiarioGlobal} kcal/día`);
		}

        // --- 5. Usar los nuevos porcentajes proporcionados ---
        let nuevasProteinasPctDia = pt_pct;
        let nuevasCarbohidratosPctDia = ch_pct;
        let nuevasGrasasPctDia = gr_pct;

        // --- 6. Calcular nuevos gramos de macros ---
        // Nota: Si decides que los porcentajes deben redistribuirse para sumar 100%,
        // puedes hacerlo aquí. Pero por ahora, asumimos que el usuario sabe lo que hace
        // o que la validación en el modal lo forzó a 100%.
        const nuevasProteinas_g = Math.round((nuevasCaloriasDiarias * nuevasProteinasPctDia / 100) / 4);
        const nuevasCarbohidratos_g = Math.round((nuevasCaloriasDiarias * nuevasCarbohidratosPctDia / 100) / 4);
        const nuevasGrasas_g = Math.round((nuevasCaloriasDiarias * nuevasGrasasPctDia / 100) / 9);

        // --- 7. Asegurar un mínimo de calorías por seguridad ---
        const limiteCaloriasMin = (typeof userGender !== 'undefined' && userGender === 'female') ? 1200 : 1500;
        if (nuevasCaloriasDiarias < limiteCaloriasMin) {
            console.warn(`Calorías ajustadas en Fila ${indiceFila} por debajo del límite (${limiteCaloriasMin}).`);
            nuevasCaloriasDiarias = limiteCaloriasMin;
        }

        // --- 8. Actualizar la UI ---
        // Actualizar celda de calorías
        const celdaCalorias = document.getElementById(`calorias-${indiceFila}`);
        if (celdaCalorias) {
            celdaCalorias.textContent = Math.round(nuevasCaloriasDiarias);
        }

        // Actualizar celdas de macros (% y g)
        // Celda % Pt y g (primera .text-center)
        const celdasPt = filaElement.querySelectorAll('td.text-center')[0];
        if (celdasPt) {
            celdasPt.innerHTML = `<strong>${Math.round(nuevasProteinasPctDia)}%</strong><br><small>${nuevasProteinas_g}g</small>`;
        }

        // Celda % CH y g (segunda .text-center)
        const celdasCH = filaElement.querySelectorAll('td.text-center')[1];
        if (celdasCH) {
            celdasCH.innerHTML = `<strong>${Math.round(nuevasCarbohidratosPctDia)}%</strong><br><small>${nuevasCarbohidratos_g}g</small>`;
        }

        // Celda % GR y g (tercera .text-center)
        const celdasGR = filaElement.querySelectorAll('td.text-center')[2];
        if (celdasGR) {
            celdasGR.innerHTML = `<strong>${Math.round(nuevasGrasasPctDia)}%</strong><br><small>${nuevasGrasas_g}g</small>`;
        }

        // Opcional: Actualizar celda de notas para indicar el cambio manual
       // Actualizar celda de notas para reflejar los cambios
		const celdaNotas = document.getElementById(`notas-${indiceFila}`);
		if (celdaNotas) {
			// Intentar reconstruir la nota base con el nuevo ajuste
			let notaActual = celdaNotas.textContent || "";
			// Extraer TDEE de la nota actual o usar tdeeActual calculado
			let tdeeMostrado = tdeeActual; // Por defecto, el calculado
			const matchTDEE = notaActual.match(/TDEE estimado \((\d+) kcal\)/);
			if (matchTDEE) {
				tdeeMostrado = parseFloat(matchTDEE[1]) || tdeeMostrado;
			}
			
			let nuevaNotaBase = `Basado en TDEE estimado (${tdeeMostrado.toFixed(0)} kcal)`;
			if (ajusteCaloriasDiarioManual !== null) {
				nuevaNotaBase += ` y ajuste manual.`;
				nuevaNotaBase += ` Ajuste diario: ${ajusteCaloriasDiarioManual > 0 ? '+' : ''}${ajusteCaloriasDiarioManual.toFixed(0)} kcal.`;
			} else {
				// Si no se aplicó un ajuste manual nuevo, intentar conservar el ajuste anterior de la nota
				const matchAjusteAnterior = notaActual.match(/Ajuste diario: ([+-]?\d+) kcal/);
				if (matchAjusteAnterior) {
					nuevaNotaBase += ` y ajuste objetivo.`;
					nuevaNotaBase += ` Ajuste diario: ${matchAjusteAnterior[1]} kcal.`;
				} else {
					nuevaNotaBase += `.`; // Punto final si no hay ajuste
				}
			}
			// Extraer estrategias aplicadas de la nota actual
				let parteEstrategias = "";
				const matchEstrategias = notaActual.match(/Estrategias aplicadas: (.+)/);
				if (matchEstrategias) {
					parteEstrategias = `. Estrategias aplicadas: ${matchEstrategias[1]}`;
				}

				// Combinar todo
				const notaCompletaActualizada = nuevaNotaBase + parteEstrategias;
				celdaNotas.textContent = notaCompletaActualizada;
			}

        console.log(`Fila ${indiceFila} actualizada con éxito por macros manuales.`);
        console.log({
            nuevasCaloriasDiarias,
            nuevasProteinasPctDia,
            nuevasCarbohidratosPctDia,
            nuevasGrasasPctDia,
            nuevasProteinas_g,
            nuevasCarbohidratos_g,
            nuevasGrasas_g
        });

    } catch (error) {
        console.error("Error al actualizar la fila por cambio de macros:", error);
        // Opcional: Mostrar mensaje de error al usuario
        // alert("Hubo un error al actualizar los macros. Por favor, inténtalo de nuevo.");
    }
}




// --- Event Listener para el botón "Aplicar Cambios" del modal ---
document.addEventListener('click', function(event) {
    if (event.target && event.target.id === 'modalBotonAplicar') {
        event.preventDefault();
        console.log("[Modal Edición] Botón 'Aplicar Cambios' clickeado.");
        
        // Obtener el índice de fila asociado al botón
        const indiceFila = event.target.getAttribute('data-indice-fila');
        if (indiceFila) {
            // Llamar a la nueva función que recoge datos del modal y aplica cambios
            aplicarCambiosDesdeModalAvanzado(indiceFila);
        } else {
            console.error("[Modal Edición] No se encontró el índice de fila en el botón Aplicar.");
            alert("Error al aplicar cambios: Índice de fila no encontrado.");
        }
    }
});


		function inicializarBotonColapsarTodo() {
			const btn = document.getElementById('btnColapsarTodo');
			const planificacionTemporal = document.getElementById('planificacionTemporal');
			const tablaDetalladaFase = document.getElementById('tablaDetalladaFaseContainer');

			if (!btn) {
				console.warn("Botón 'btnColapsarTodo' no encontrado.");
				return;
			}

			btn.addEventListener('click', function () {
				// Verificar si al menos uno de los dos contenedores está visible (display !== 'none')
				const estaVisible = 
					planificacionTemporal.style.display !== 'none' || 
					(tablaDetalladaFase && tablaDetalladaFase.style.display !== 'none');

				// Decidimos la acción: si alguno está visible → colapsar, si ambos están ocultos → expandir
				if (estaVisible) {
					// COLAPSAR: ocultar ambos
					if (planificacionTemporal) planificacionTemporal.style.display = 'none';
					if (tablaDetalladaFase) tablaDetalladaFase.style.display = 'none';
					btn.innerHTML = '<i class="fas fa-expand"></i> Expandir Todo';
				} else {
					// EXPANDIR: mostrar ambos solo si tienen contenido
					// Nota: no cambiamos a 'block' si nunca fueron mostrados antes, pero aquí forzamos si tienen innerHTML
					if (planificacionTemporal && planificacionTemporal.innerHTML.trim() !== '') {
						planificacionTemporal.style.display = 'block';
					}
					if (tablaDetalladaFase && tablaDetalladaFase.innerHTML.trim() !== '' && !tablaDetalladaFase.querySelector('.info-message')) {
						tablaDetalladaFase.style.display = 'block';
					}

					btn.innerHTML = '<i class="fas fa-compress"></i> Colapsar Todo';
				}
			});
		}
		

			// Llama a la función cuando el DOM esté listo
			document.addEventListener('DOMContentLoaded', function () {
				inicializarBotonColapsarTodo();
			});
			
			
			
		//////////////////////////////////////////////////////////
// Función para depurar faseData
function debugFaseData() {
    const modal = document.getElementById('editModal');
    if (!modal) {
        console.log("⚠️ Modal no encontrado en el DOM");
        return;
    }
    
    console.log("🔍 Iniciando depuración de faseData...");
    
    // 1. Mostrar todos los atributos data del modal
    console.log("📌 Atributos data del modal:");
    const dataAttributes = {};
    for (let i = 0; i < modal.attributes.length; i++) {
        const attr = modal.attributes[i];
        if (attr.name.startsWith('data-')) {
            dataAttributes[attr.name] = attr.value;
        }
    }
    console.log(dataAttributes);
    
    // 2. Obtener y mostrar faseDataStr
    const faseDataStr = modal.getAttribute('data-fase-data');
    console.log("\n📝 Contenido crudo de data-fase-data:");
    console.log(faseDataStr || "(vacío)");
    
    // 3. Intentar parsear faseDataStr
    try {
        if (faseDataStr) {
            const faseData = JSON.parse(faseDataStr);
            console.log("\n✅ faseData parseado correctamente:");
            console.dir(faseData);
            
            // 4. Mostrar estructura detallada
            console.log("\n🔍 Estructura detallada de faseData:");
            if (faseData.pesoInicial) console.log(`- pesoInicial: ${faseData.pesoInicial} kg`);
            if (faseData.objetivo) console.log(`- objetivo: ${faseData.objetivo}`);
            if (faseData.fase) console.log(`- fase: ${faseData.fase}`);
            if (faseData.strategyId) console.log(`- strategyId: ${faseData.strategyId}`);
            if (faseData.kcalObjetivo) console.log(`- kcalObjetivo: ${faseData.kcalObjetivo} kcal`);
            if (faseData.porcentajeGrasaInicial !== undefined) {
                console.log(`- porcentajeGrasaInicial: ${faseData.porcentajeGrasaInicial}%`);
            }
            if (faseData.estrategiaBase) {
                console.log("- estrategiaBase:", {
                    id: faseData.estrategiaBase.id,
                    title: faseData.estrategiaBase.title,
                    aplicable: faseData.estrategiaBase.aplicable
                });
            }
        } else {
            console.warn("⚠️ data-fase-data está vacío. El modal no tiene datos de fase almacenados.");
            
            // 5. Mostrar dónde debería estar almacenado
            console.log("\n💡 Posibles causas:");
            console.log("- No se llamó a openEditModal correctamente");
            console.log("- No se estableció data-fase-data al abrir el modal");
            console.log("- Se está intentando acceder a faseData antes de que se inicialice");
        }
    } catch (error) {
        console.error("\n❌ Error al parsear data-fase-data:", error);
        console.log("Contenido que causó el error:", faseDataStr);
        console.log("\n💡 Posibles causas del error de parseo:");
        console.log("- El JSON está mal formateado");
        console.log("- Hay caracteres no válidos en el string JSON");
        console.log("- El objeto fue serializado incorrectamente");
    }
    
    // 6. Mostrar dónde se debería estar llamando esta función
    console.log("\n📌 Para que esto funcione correctamente:");
    console.log("- Llama a debugFaseData() después de que el modal se haya abierto");
    console.log("- La mejor ubicación es en el evento 'shown.bs.modal'");
    console.log("Ejemplo: editModal.addEventListener('shown.bs.modal', debugFaseData);");
}

// Configurar para que se ejecute cuando el modal se muestra
document.addEventListener('DOMContentLoaded', function() {
    const editModal = document.getElementById('editModal');
    if (editModal) {
        editModal.addEventListener('shown.bs.modal', function() {
            setTimeout(debugFaseData, 100); // Pequeño retraso para asegurar que los datos estén listos
        });
    }
});
	//////////////////////FUNCIONES PARA NUTRIPLAN WEB////////////////////
// FUNCIONALIDAD PDF
document.getElementById("save-pdf-button").addEventListener("click", async function () {
    // Convertir gráficos a imágenes
    const charts = document.querySelectorAll('canvas');
    const promises = Array.from(charts).map(chart => {
        return new Promise(resolve => {
            const image = new Image();
            image.src = chart.toDataURL();
            image.onload = () => {
                const img = document.createElement('img');
                img.src = image.src;
                img.style.maxWidth = '90%';
                chart.parentNode.replaceChild(img, chart);
                resolve();
            };
        });
    });

    await Promise.all(promises);

    const opt = {
        margin: [5, 5, 5, 5],
        filename: 'Plan_Nutricional.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { 
            scale: 2,
            scrollY: 0,
            useCORS: true,
            allowTaint: true,
            logging: true
        },
        jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait' 
        },
        pagebreak: { mode: 'avoid-all' }
    };

    const element = document.documentElement;
    html2pdf().set(opt).from(element).save().then(() => {
        // Restaurar los canvas después de la exportación
        charts.forEach((chart, index) => {
            const img = chart.parentNode.querySelector('img');
            if(img) img.replaceWith(chart);
        });
    });
});

 // --- PDF Generation ---
            function guardarComoPDF2() {
                if (!calculatedTDEE) {
                    alert("Por favor, completa al menos el Paso 1 (Cálculo de Necesidades) antes de generar el PDF.");
                    return;
                }

                const mainElement = document.querySelector('main');
                const headerElement = document.querySelector('header');
                const footerElement = document.querySelector('footer');
                const allButtons = document.querySelectorAll('button'); // Select all buttons

                // Hide elements not needed in PDF
                if (headerElement) headerElement.style.display = 'none';
                if (footerElement) footerElement.style.display = 'none';
                allButtons.forEach(btn => btn.style.display = 'none');

                // Temporarily make chart containers visible if they have content
                const chartContainers = document.querySelectorAll('#chart-container, #weight-chart-container, #time-estimation-chart-container');
                const originalDisplayStyles = [];
                chartContainers.forEach(container => {
                    originalDisplayStyles.push(container.style.display);
                    if (container.querySelector('canvas') && container.style.display === 'none') {
                        container.style.display = 'block';
                    }
                });

                const opt = {
                    margin: [15, 10, 15, 10],
                    filename: 'NutriPlan_Plan_Dietetico_Personalizado.pdf',
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { scale: 2, useCORS: true, logging: false, windowWidth: mainElement.scrollWidth, windowHeight: mainElement.scrollHeight },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.plan-step' }
                };

                console.log("Generating PDF...");
                html2pdf().from(mainElement).set(opt).save().then(() => {
                    console.log("PDF generated successfully.");
                    // Restore visibility
                    if (headerElement) headerElement.style.display = 'flex';
                    if (footerElement) footerElement.style.display = 'block';
                    allButtons.forEach(btn => btn.style.display = 'block');
                    chartContainers.forEach((container, index) => { container.style.display = originalDisplayStyles[index]; });
                }).catch(err => {
                    console.error("Error generating PDF:", err);
                    alert("Hubo un error al generar el PDF. Revisa la consola del navegador (F12) para más detalles.");
                    // Restore visibility even on error
                    if (headerElement) headerElement.style.display = 'flex';
                    if (footerElement) footerElement.style.display = 'block';
                    allButtons.forEach(btn => btn.style.display = 'block');
                    chartContainers.forEach((container, index) => { container.style.display = originalDisplayStyles[index]; });
                });
            }

	
   // Ensure Firebase is loaded
    if (typeof firebase === 'undefined') {
        console.error('Firebase SDK not loaded. Ensure firebase-app.js and firebase-auth.js are included in the <head>.');
        var errorDiv = document.createElement('div');
        errorDiv.style.color = 'red';
        errorDiv.style.marginBottom = '10px';
        errorDiv.style.fontSize = '14px';
        errorDiv.style.textAlign = 'center';
        errorDiv.textContent = 'Error: No se pudo cargar Firebase. Contacta al administrador.';
        document.querySelector('main').insertBefore(errorDiv, document.querySelector('main').firstChild);
    } else {
        // Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyChC7s5NN-z-dSjqeXDaks7gaNaVCJAu7Q",
            authDomain: "nutriplanv2.firebaseapp.com",
            projectId: "nutriplanv2",
            storageBucket: "nutriplanv2.firebasestorage.app",
            messagingSenderId: "653707489758",
            appId: "1:653707489758:web:9133d1d1620825c385ed4f",
            measurementId: "G-NWER69E8B6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var auth = firebase.auth();

        // Logout
        function logout() {
            auth.signOut().then(function() {
                console.log('Sesión cerrada');
                window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
            }).catch(function(error) {
                console.error('Error al cerrar sesión:', error.code, error.message);
                var main = document.querySelector('main');
                var errorDiv = document.createElement('div');
                errorDiv.style.color = 'red';
                errorDiv.style.marginBottom = '10px';
                errorDiv.style.fontSize = '14px';
                errorDiv.textContent = 'Error al cerrar sesión: ' + error.message;
                main.insertBefore(errorDiv, main.firstChild);
                setTimeout(function() { errorDiv.remove(); }, 5000);
            });
        }

        // Initialize UI
        function initializeUI() {
            document.getElementById('logo').addEventListener('click', function(event) {
                event.preventDefault();
                var dropdown = document.getElementById('dropdown');
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            });

            document.addEventListener('click', function(event) {
                var dropdown = document.getElementById('dropdown');
                var logo = document.getElementById('logo');
                if (!logo.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            });

            window.logout = logout;
        }

        // Handle auth state
        auth.onAuthStateChanged(function(user) {
            var dropdown = document.getElementById('dropdown');
            if (user) {
                console.log('Auth state: User signed in', user.displayName, user.email);
                if (dropdown) dropdown.style.display = 'none'; // Initially hidden, shown on logo click
            } else {
                console.log('Auth state: No user signed in');
                window.location.href = 'https://fermagil.github.io/Nutri_Plan_v2/index.html';
            }
        });

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeUI);
    }	
    </script>

<!-- Modal para Editar Fila -->
<!-- Modal para Editar Fila -->
<div class="modal fade" id="editarFilaModal" tabindex="-1" aria-labelledby="editarFilaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
    <div class="modal-content">
      <!-- Cabecera del Modal -->
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="editarFilaModalLabel">
          <!-- Cabecera dinámica: "Fase X: Nombre de la Fase, Día de la Semana" -->
          <span id="modalTituloDia">Editar Día</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <!-- Cuerpo del Modal -->
      <div class="modal-body">
        
        <!-- Sección 1: Contexto del Plan -->
       <!-- Sección 1: Contexto del Plan -->
		<div class="mb-4 p-3 bg-light rounded">
		  <h6 class="text-success">📋 Contexto del Plan</h6>
		  <div class="row small g-2">
			<div class="col-md-6">
			  <ul class="mb-0" id="modalListaContextoIzquierda">
				<!-- Elementos de lista dinámicos -->
				<li><strong>Fase:</strong> <span id="modalInfoFase">...</span></li>
				<li><strong>Objetivo:</strong> <span id="modalInfoObjetivo">...</span></li>
				<li><strong>Duración Estimada:</strong> <span id="modalInfoDuracion">...</span></li>
				<li><strong>Nº Semanas Fase:</strong> <span id="modalInfoSemanasFase">...</span></li>
				<li><strong>Nº Días Transcurridos:</strong> <span id="modalInfoDiasTranscurridos">...</span></li>
			  </ul>
			</div>
			<div class="col-md-6">
			  <ul class="mb-0" id="modalListaContextoDerecha">
				<!-- Elementos de lista dinámicos -->
				<li><strong>Peso Perdido:</strong> <span id="modalInfoPesoPerdido">...</span></li>
				<li><strong>Velocidad de Pérdida:</strong> <span id="modalInfoVelocidadPerdida">...</span></li>
				<li><strong>Peso Inicial Fase:</strong> <span id="modalInfoPesoInicialFase">...</span></li>
				<li><strong>Peso Actual Estimado:</strong> <span id="modalInfoPesoActualEstimado">...</span></li>
				<li><strong>Peso Final Estimado:</strong> <span id="modalInfoPesoFinalEstimado">...</span></li>
			  </ul>
			</div>
		  </div>
		</div>

        <!-- Sección 2: Posibles Estrategias por Objetivo -->
        <div class="mb-4">
          <h6 class="text-success">🧠 Posibles Estrategias por Objetivo</h6>
          <div class="small mb-3">
            <p class="mb-1"><strong>Estrategia Base Actual:</strong> <span id="modalEstrategiaBaseActual">...</span></p>
            <p class="mb-1"><strong>Estrategias Base:</strong> <span id="modalEstrategiasBase">...</span></p>
            <p class="mb-1"><strong>Recomendadas:</strong> <span id="modalEstrategiasRecomendadas">...</span></p>
            <p class="mb-0 text-muted"><em>Límite: 3 estrategias específicas por día.</em></p>
          </div>

          <!-- Sección: Seleccionar Estrategias Específicas -->
          <div class="mb-3">
            <h6 class="text-success">✅ Seleccionar Estrategias Específicas</h6>
            <!-- Contenedor para los checkboxes generados dinámicamente -->
            <div id="modalCheckboxesEstrategias" class="mb-2">
              <p class="text-muted small">Estrategias disponibles se cargarán aquí.</p>
            </div>
            <div class="alert alert-info small py-2" role="alert">
              <i class="fas fa-info-circle"></i> Marca las estrategias que deseas aplicar para este día.
            </div>
          </div>
        </div>

        <!-- Sección 3: Nivel de Actividad -->
        <div class="mb-4">
          <h6 class="text-success">🏃‍♂️ Nivel de Actividad</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="modalSelectActividad" class="form-label small">Selecciona tu nivel de actividad física diaria</label>
              <select class="form-select form-select-sm" id="modalSelectActividad" aria-label="Seleccionar actividad">
                <option value="1.2">Sedentario</option>
                <option value="1.375">Ligero (1-3 días/semana)</option>
                <option value="1.55">Moderado (3-5 días/semana)</option>
                <option value="1.725">Activo (6-7 días/semana)</option>
                <option value="1.9">Muy Activo (Intenso/Diario)</option>
              </select>
              <div class="form-text small text-muted">Este valor se usará para recalcular las calorías diarias estimadas (TDEE).</div>
            </div>
            <div class="col-md-3">
              <label for="modalInputVelocidadPerdida" class="form-label small">Velocidad de Pérdida (kg/semana)</label>
              <input type="number" class="form-control form-control-sm" id="modalInputVelocidadPerdida" step="0.01" min="0.01" max="1.0" placeholder="Ej: 0.28">
              <div class="form-text small text-muted">Ajusta la velocidad de cambio de peso semanal.</div>
            </div>
            <div class="col-md-3">
              <label for="modalInputMacrosGenerales" class="form-label small">% Macros Generales (Pt, CH, GR)</label>
              <input type="text" class="form-control form-control-sm" id="modalInputMacrosGenerales" placeholder="Ej: 25, 5, 70">
              <div class="form-text small text-muted">Distribución base de macros para la fase.</div>
            </div>
          </div>
        </div>

        <!-- Sección 4: Configurar Macros por Estrategia -->
        <div class="mb-4">
          <h6 class="text-success">⚙️ Configurar Macros por Estrategia</h6>
          <p class="small text-muted mb-2">Selecciona los porcentajes de macros para cada estrategia aplicada.</p>
          
          <!-- Contenedor para las filas de configuración de macros generadas dinámicamente -->
          <div id="modalConfiguracionMacrosPorEstrategia">
            <!-- Las filas se generarán aquí dinámicamente cuando se marquen checkboxes -->
          </div>
          
          <!-- Mensaje cuando no hay estrategias seleccionadas -->
          <div id="modalMensajeSinEstrategias" class="text-center text-muted fst-italic small" style="display: block;">
            Selecciona una estrategia para configurar sus macros.
          </div>
        </div>

        <!-- Sección 5: Recordatorio de la Evolución -->
        <div class="mb-3">
          <h6 class="text-success">📊 Recordatorio de la Evolución</h6>
          
          <!-- Información de Fase, Semana y Día -->
          <div class="row mb-3 small g-2">
            <div class="col-md-4">
              <div class="bg-primary text-white p-2 rounded text-center">
                <strong>Fase Actual:</strong><br>
                <span id="modalFaseActual">...</span>
              </div>
            </div>
            <div class="col-md-4">
              <div class="bg-warning text-dark p-2 rounded text-center">
                <strong>Semana:</strong> <span id="modalSemanaActual">...</span> de <span id="modalTotalSemanas">...</span>
              </div>
            </div>
            <div class="col-md-4">
              <div class="bg-success text-white p-2 rounded text-center">
                <strong>Día:</strong> <span id="modalDiaActual">...</span> (<span id="modalDiasRestantesFase">...</span> días restantes)
              </div>
            </div>
          </div>
			
          <!-- Cronograma Dinámico de Fases -->
          <div class="mb-3">
            <h6 class="text-success small">📅 Cronograma Dinámico de Fases</h6>
            <div id="modalCronogramaDinamico">
              <!-- Aquí se generarán las barras de progreso dinámicamente -->
              <div class="progress mb-1">
                <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                  Cargando cronograma...
                </div>
              </div>
            </div>
          </div>

          <!-- Progreso Estimado de la Fase -->
			<div class="mb-3">
			  <h6 class="text-success small">📈 Progreso Estimado de la Fase</h6>
			  <div id="modalGraficoProgreso" class="mb-2">
				<!-- Aquí se generará el gráfico de progreso dinámicamente -->
				
				<!-- Información de Peso Inicial, Actual y Meta -->
				<div class="row g-1 mb-1">
				  <div class="col-4 text-center">
					<div class="bg-info text-white p-1 rounded small">Inicio: <span id="modalPesoInicioGrafico">...</span>kg</div>
				  </div>
				  <div class="col-4 text-center">
					<div class="bg-success text-white p-1 rounded small">Actual: <span id="modalPesoActualGrafico">...</span>kg</div>
				  </div>
				  <div class="col-4 text-center">
					<div class="bg-warning text-dark p-1 rounded small">Meta: <span id="modalPesoMetaGrafico">...</span>kg</div>
				  </div>
				</div>

				<!-- Barra de Progreso General -->
				<div class="progress mb-2">
				  <div class="progress-bar bg-info" role="progressbar" id="modalBarraProgresoGeneral" 
					   style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
					Progreso general hacia el objetivo
				  </div>
				</div>

				<!-- (Nuevo) Contenedor para el Gráfico Detallado de Línea de Tiempo -->
				<div id="modalContenedorGraficoDetallado" class="mt-2 p-2 border rounded bg-light">
				  <canvas id="modalCanvasGraficoDetallado" width="400" height="150"></canvas>
				  <div id="modalLeyendaGraficoDetallado" class="small mt-1"></div>
				</div>
				<!-- (Fin de Nuevo) -->

			  </div>
			</div>

          <!-- Próxima Reevaluación -->
          <div class="alert alert-warning small py-2" id="modalAlertaProximaReevaluacion">
            <strong>Próxima Reevaluación:</strong> <span id="modalProximaReevaluacion">Cargando...</span>
		</div>
			<div class="alert alert-warning small py-2" id="modalAlertaProximaReevaluacion">
            <strong>Próximo Cambio de Fase:</strong> <span id="modalInfoCambioFase">Cargando...</span>
		
		
			
			
			
			
          </div>
        </div>
      </div> <!-- Fin modal-body -->

      <!-- Pie del Modal -->
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Cancelar
        </button>
        <button type="button" class="btn btn-sm btn-outline-primary">
          <i class="fas fa-print me-1"></i> Imprimir Plan
        </button>
        <button type="button" class="btn btn-sm btn-primary" id="modalBotonAplicar">
          <i class="fas fa-save me-1"></i> Aplicar Cambios
        </button>
      </div>
    </div> <!-- Fin modal-content -->
  </div> <!-- Fin modal-dialog -->
</div> <!-- Fin modal -->



		<!-- Modal de edición de estrategias -->
<!-- Modal de edición de estrategias -->
		<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
		  <div class="modal-dialog modal-xl">
			<div class="modal-content">
			  <div class="modal-header">
				<h5 class="modal-title">
				  <i class="fas fa-edit"></i> 
				  <span id="modal-phase-title">Configuración de Estrategias</span>
				</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
			  </div>
			  <div class="modal-body p-4">
				<div class="row">
				  <!-- COLUMNA IZQUIERDA -->
				  <!-- COLUMNA IZQUIERDA -->
		<div class="col-md-6 border-end">
		  <!-- Sección de estrategia base -->
		  <div class="phase-config-section mb-4">
			<h5><i class="fas fa-home me-2" style="color: #5e9a4f;"></i> Estrategia Base Fase nº </h5>
			<p>Selecciona una estrategia base para esta fase:</p>
			<div class="radio-group" id="base-strategies">
			  <!-- Las opciones se generarán dinámicamente -->
			</div>
		  </div>
		  
		  <!-- Estrategias específicas con acordeones -->
		  <div class="phase-config-section">
			<h5><i class="fas fa-star me-2" style="color: #5e9a4f;"></i> Estrategias Específicas</h5>
			<p class="text-muted">Selecciona las estrategias avanzadas que deseas aplicar:</p>
			
			<!-- Acordeón para Estrategias Cetogénicas Avanzadas -->
			<div class="accordion mb-3" id="accordionCetogenicas">
			  <div class="accordion-item">
				<h2 class="accordion-header">
				  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCetogenicas" aria-expanded="false" aria-controls="collapseCetogenicas">
					<i class="fas fa-bacon me-2" style="color: #5e9a4f;"></i> Estrategias Cetogénicas
				  </button>
				</h2>
				<div id="collapseCetogenicas" class="accordion-collapse collapse" data-bs-parent="#accordionCetogenicas">
				  <div class="accordion-body" id="cetogenicas-strategies">
					<!-- Aquí se renderizarán las estrategias cetogénicas -->
				  </div>
				</div>
			  </div>
			</div>
			
			<!-- Acordeón para Estrategias de Ciclado -->
			<div class="accordion mb-3" id="accordionCiclado">
			  <div class="accordion-item">
				<h2 class="accordion-header">
				  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCiclado" aria-expanded="false" aria-controls="collapseCiclado">
					<i class="fas fa-sync-alt me-2" style="color: #5e9a4f;"></i> Estrategias de Ciclado
				  </button>
				</h2>
				<div id="collapseCiclado" class="accordion-collapse collapse" data-bs-parent="#accordionCiclado">
				  <div class="accordion-body" id="ciclado-strategies">
					<!-- Aquí se renderizarán las estrategias de ciclado -->
				  </div>
				</div>
			  </div>
			</div>
			
			<!-- Acordeón para Estrategias de Timing -->
			<div class="accordion mb-3" id="accordionTiming">
			  <div class="accordion-item">
				<h2 class="accordion-header">
				  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTiming" aria-expanded="false" aria-controls="collapseTiming">
					<i class="fas fa-clock me-2" style="color: #5e9a4f;"></i> Estrategias de Timing
				  </button>
				</h2>
				<div id="collapseTiming" class="accordion-collapse collapse" data-bs-parent="#accordionTiming">
				  <div class="accordion-body" id="timing-strategies">
					<!-- Aquí se renderizarán las estrategias de timing -->
				  </div>
				</div>
			  </div>
			</div>
		  </div>
		  
		  <!-- Recomendaciones Clave -->
		  <div class="phase-config-section">
			<h4><i class="fas fa-key me-2" style="color: #5e9a4f;"></i> Recomendaciones Clave</h4>
			<div id="recommendations-container">
			  <!-- Aquí se renderizarán las recomendaciones clave -->
			</div>
		  </div>
		  
		  <!-- NUEVO: Estrategia Óptima - CORRECTAMENTE IMPLEMENTADO -->
		  <div class="phase-config-section">
			<h4><i class="fas fa-chart-line me-2" style="color: #5e9a4f;"></i> Estrategia Óptima</h4>
			<div id="optimal-strategy-content">
			  <!-- Aquí se cargará dinámicamente la estrategia óptima -->
			</div>
		  </div>
		</div>
		  

          <!-- COLUMNA DERECHA -->
          <div class="col-md-6">
            <!-- Configuración de macros -->
            <div class="phase-config-section mb-4" id="macro-config-section">
              <h5 class="mb-3"><i class="fas fa-sliders-h"></i> Configuración de Macros</h5>
              <div class="text-muted mb-3">Los valores se actualizarán automáticamente al seleccionar una estrategia base</div>
              
              <!-- Formulario de peso y macros -->
              <div class="form-group mb-3">
                <label for="user-weight" class="form-label">Peso del usuario Inicio Fase nº </label>
                <input type="number" id="user-weight" class="form-control" min="40" max="200" step="0.5">
              </div>
              
              <div class="macro-config">
                <div class="macro-input">
                  <label>% Proteínas</label>
                  <input type="number" id="proteinas-pct" value="30" step="1" min="15" max="35">
                  <div class="macro-values" id="proteinas-gr">2.35 g/kg (185g)</div>
                </div>
                <div class="macro-input">
                  <label>% Grasas</label>
                  <input type="number" id="grasa-pct" value="40" step="1" min="15" max="75">
                  <div class="macro-values" id="grasa-gr">3.13 g/kg (247g)</div>
                </div>
                <div class="macro-input">
                  <label>% HC</label>
                  <input type="number" id="hc-pct" value="30" step="1" min="5" max="70">
                  <div class="macro-values" id="hc-gr">3.13 g/kg (247g)</div>
                </div>
              </div>
              <div class="form-group mb-3">
                <label>Suma de porcentajes</label>
                <div class="d-flex align-items-center">
                  <span id="macros-total" class="badge bg-success">100</span>
                  <small class="ms-2 text-muted">Debe sumar 100% para ser válido</small>
                </div>
                <div id="macro-warnings" class="text-warning mt-2" style="display: none;"></div>
              </div>
              
              <!-- ✅ Nuevo: Contenedor propio para los detalles -->
              <div class="strategy-details-card mt-4">
                <h6>
                  <i class="fas fa-info-circle me-2" style="color: #5e9a4f;"></i>
                  Detalles de la Estrategia Seleccionada
                </h6>
                <p id="macro-details-text" class="mb-0 text-muted" style="font-size: 0.95rem; line-height: 1.5;">
                  Selecciona una estrategia base para ver los detalles.
                </p>
              </div>
            </div>
            
            <!-- Configuración de entrenamiento -->
            <div class="training-config mb-4">
              <h5 class="mb-3"><i class="fas fa-dumbbell"></i> Configuración de Entrenamiento</h5>
              
              <div class="mb-3">
                <label class="form-label">Días de entrenamiento habituales</label>
                <div class="days-selector" id="training-days">
                  <div class="day-option" data-day="mon">Lun</div>
                  <div class="day-option" data-day="tue">Mar</div>
                  <div class="day-option" data-day="wed">Mié</div>
                  <div class="day-option" data-day="thu">Jue</div>
                  <div class="day-option" data-day="fri">Vie</div>
                  <div class="day-option" data-day="sat">Sáb</div>
                  <div class="day-option" data-day="sun">Dom</div>
                </div>
              </div>
              
              <div class="mb-4">
                <label class="form-label">Intensidad en días de descanso</label>
                <div class="intensity-selector">
                  <div class="intensity-option" data-intensity="rest">Reposo</div>
                  <div class="intensity-option" data-intensity="leve">Leve</div>
                  <div class="intensity-option" data-intensity="moderada">Moderada</div>
                   <!--<div class="intensity-option" data-intensity="intensa">Intensa</div> -->
                </div>
              </div>
              
              <div class="schedule-preview">
                <h6><i class="fas fa-calendar-check"></i> Vista Previa de la Semana</h6>
                <div class="schedule-days" id="schedule-preview">
                  <div class="schedule-day training">Lun<br><small>Entreno</small></div>
                  <div class="schedule-day training">Mar<br><small>Entreno</small></div>
                  <div class="schedule-day rest">Mié<br><small>Descanso</small></div>
                  <div class="schedule-day training">Jue<br><small>Entreno</small></div>
                  <div class="schedule-day training">Vie<br><small>Entreno</small></div>
                  <div class="schedule-day rest">Sáb<br><small>Descanso</small></div>
                  <div class="schedule-day rest">Dom<br><small>Descanso</small></div>
                </div>
              </div>
            </div>
            
            <!-- Configuración de pausas y reevaluaciones -->
            <div class="phase-config-section">
              <h5><i class="fas fa-pause-circle"></i> Configuración Avanzada Pausas</h5>
              
              <div class="mb-3">
                <label class="form-label">Frecuencia de Pausas Metabólicas</label>
                <select class="form-select" id="pause-frequency">
                  <option value="0">No programar pausas metabólicas</option>
                  <option value="6" selected>Cada 6 semanas</option>
                  <option value="8">Cada 8 semanas(Recomendada)</option>
                  <option value="10">Cada 10 semanas</option>
                  <option value="12">Cada 12 semanas</option>
                </select>
                <div class="form-text text-muted">Las pausas metabólicas ayudan a recuperar el metabolismo durante planes prolongados</div>
              </div>
             
              <!-- Configuración de macros para pausas -->
              <div class="macro-config">
                <div class="macro-input">
                  <label>% Proteínas</label>
                  <input type="number" id="proteinas-pausa-pct" value="20" step="1" min="15" max="25">
                  <div class="macro-values" id="proteinas-pausa-gr">2.35 g/kg (185g)</div>
                </div>
                <div class="macro-input">
                  <label>% Grasas</label>
                  <input type="number" id="grasas-pausa-pct" value="35" step="1" min="20" max="35">
                  <div class="macro-values" id="grasas-pausa-gr">3.13 g/kg (247g)</div>
                </div>
                <div class="macro-input">
                  <label>% HC</label>
                  <input type="number" id="hc-pausa-pct" value="45" step="1" min="25" max="45">
                  <div class="macro-values" id="hc-pausa-gr">3.13 g/kg (247g)</div>
                </div>
              </div>
              
              <div class="form-group mb-3">
                <label>Suma de porcentajes en pausa</label>
                <div class="d-flex align-items-center">
                  <span id="macros-pausa-total" class="badge bg-success">100</span>
                  <small class="ms-2 text-muted">Debe sumar 100% para ser válido</small>
                </div>
                <div id="macro-pausa-warnings" class="text-warning mt-2" style="display: none;"></div>
              </div>
             
              <div class="mb-3">
                <h5> <i class="fas fa-tasks"></i>Frecuencia de Reevaluaciones</h5>
                <select class="form-select" id="reeval-frequency">
                  <option value="0">No programar reevaluaciones</option>
                  <option value="4">Cada 6 semanas </option>
                  <option value="8">Cada 8 semanas (Recomendada)</option>
                  <option value="12" selected>Cada 12 semanas</option>
                </select>
                <div class="form-text text-muted">Las reevaluaciones permiten ajustar el plan según los resultados</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="save-config-btn" id="save-config-btn">
          <i class="fas fa-save"></i> Guardar Configuración
        </button>
      </div>
    </div>
  </div>
</div>

</body>
</html>





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































