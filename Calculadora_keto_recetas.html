<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Calculadora Keto ‚Ä¢ Recetas</title>
  <style>
0
  </style>
  <style>
    /* ====== Base style (provided) ====== */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        margin: 0;
        padding: 0;
        background-color: #f8f9fa;
        color: #212529;
        line-height: 1.6;
        font-size: 16px;
        padding-bottom: 80px;
    }
    header {
        background-color: #ffffff;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border-bottom: 1px solid #dee2e6;
        position: sticky;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        box-sizing: border-box;
    }
    .logo a {
        color: #4CAF50;
        text-decoration: none;
        font-size: 1.75em;
        font-weight: 600;
    }
    nav ul { list-style: none; padding: 0; margin: 0; display: flex; align-items: center; }
    nav ul li { margin-left: 25px; }
    nav ul li a {
        text-decoration: none;
        color: #495057;
        font-weight: 500;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
    }
    nav ul li a:hover, nav ul li a.active {
        background-color: #e9f5e9;
        color: #388e3c;
    }
    nav ul li a.active {
        background-color: #c8e6c9;
        color: #2e7d32;
        font-weight: 600;
    }
    main {
        padding: 30px 15px;
        max-width: 1100px;
        margin: 20px auto;
        padding-top: 40px;
        padding-bottom: 40px;
        box-sizing: border-box;
    }
    h1, h2, h3 {
        color: #388E3C;
        margin-bottom: 20px;
        font-weight: 600;
    }
    h1 { font-size: 2.2em; text-align: center; margin-bottom: 30px;}
    h2 { font-size: 1.4em; border-bottom: 2px solid #a5d6a7; padding-bottom: 8px; margin-top: 0;}
    h3 { font-size: 1.2em; margin-top: 25px; }
	
	/* Estilos para la secci√≥n del Plan Semanal con encabezado fijo y scroll */
    .weekly-plan-container {
      max-height: 700px; /* Altura m√°xima para mostrar aproximadamente 15 filas */
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 8px;
      position: relative;
    }
    
    #weeklyPlanTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 0;
    }
    
    #weeklyPlanTable thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    #weeklyPlanTable th {
      background-color: #f2f2f2;
      font-weight: 600;
      position: sticky;
      top: 0;
      padding: 12px 8px;
      border-bottom: 2px solid #ddd;
    }
    
    #weeklyPlanTable td {
      padding: 8px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    
    #weeklyPlanTable tbody tr:hover td {
      background-color: #f8faf8 !important;
    }
    
    /* Estilos para los d√≠as de la semana (colores) */
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Lunes"]) {
      background-color: #FFE5E5;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Martes"]) {
      background-color: #E5F0FF;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Mi√©rcoles"]) {
      background-color: #E5FFE5;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Jueves"]) {
      background-color: #FFF5E5;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Viernes"]) {
      background-color: #F0E5FF;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="S√°bado"]) {
      background-color: #E5FFFF;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Domingo"]) {
      background-color: #FFF0E5;
    }
    
    .total-kcal {
      text-align: right;
      font-weight: bold;
    }
    
    .data-section {
      background-color: #ffffff;
      padding: 20px;
      margin-bottom: 24px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
      border: 1px solid #e0e0e0;
      box-sizing: border-box;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid #c0e0c2;
      background: #e9f5e9;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s ease-in-out;
    }
    
    .btn:hover {
      background: #dff0df;
    }
    
    .btn.secondary {
      background-color: #5a6268;
      color: white;
    }
    
    .button-group {
      margin: 1rem 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
	#recipesTable {
	  display: none; /* Hide original table if present */
	}
	#recipesAccordion {
	  width: 100%;
	  margin-top: 1rem;
	}
	.accordion-tab {
	  margin-bottom: 5px;
	}
.accordion-header {
  padding: 10px;
  cursor: pointer;
  background-color: #f2f2f2;
  border: 1px solid #ddd;
  border-radius: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: bold;
}
.accordion-header:hover {
  background-color: #e0e0e0;
}
.accordion-header::after {
  content: '‚ñº';
  font-size: 0.8rem;
}
.accordion-header.active::after {
  content: '‚ñ≤';
}
.accordion-content {
  display: none;
  border: 1px solid #ddd;
  border-top: none;
  padding: 10px;
}
.accordion-content.active {
  display: block;
}
.accordion-content table {
  width: 100%;
  border-collapse: collapse;
}
.accordion-content th,
.accordion-content td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
.accordion-content th:first-child,
.accordion-content td:first-child {
  display: none; /* Hide first column (mealType) */
}
#recipesAccordion .accordion-content table tbody td:nth-child(2) {
  font-weight: 700 !important; /* Bold the Nombre column */
}
.accordion-content th {
  background-color: #f2f2f2;
}
.accordion-header[data-meal-type="Desayuno"],
.accordion-content[data-meal-type="Desayuno"] {
  background-color: #FFF2CC;
}
.accordion-header[data-meal-type="Almuerzo"],
.accordion-content[data-meal-type="Almuerzo"] {
  background-color: #E2EFDA;
}
.accordion-header[data-meal-type="Cena"],
.accordion-content[data-meal-type="Cena"] {
  background-color: #DDEBF7;
}
.accordion-header[data-meal-type="Snack"],
.accordion-content[data-meal-type="Snack"] {
  background-color: #C6E0B4;
}
.accordion-header[data-meal-type="Snack Post-Entrenamiento"],
.accordion-content[data-meal-type="Snack Post-Entrenamiento"] {
  background-color: #F8CBAD;
}
.accordion-header[data-meal-type="Snack (Barritas)"],
.accordion-content[data-meal-type="Snack (Barritas)"] {
  background-color: #C6E0B4;
}
.accordion-header[data-meal-type="Snack (Sanak 1)"],
.accordion-content[data-meal-type="Snack (Sanak 1)"] {
  background-color: #C6E0B4;
}
.accordion-header[data-meal-type="Limpieza"],
.accordion-content[data-meal-type="Limpieza"] {
  background-color: #B8C3D2;
}
.accordion-header[data-meal-type="Recetas"],
.accordion-content[data-meal-type="Recetas"] {
  background-color: #F0D6FE;
}
 
#shoppingListTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}
#shoppingListTable th,
#shoppingListTable td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
#shoppingListTable th {
  background-color: #f2f2f2; /* Light gray header like other tables */
}
#shoppingListTable td.right {
  text-align: right; /* Right-align numeric columns (e.g., Cantidad) */
}
    section.data-section {
        background-color: #ffffff;
        padding: 20px 20px;
        margin-bottom: 24px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
        border: 1px solid #e0e0e0;
        box-sizing: border-box;
    }
    .grid { display: grid; gap: 14px; }
    .grid.cols-2 { grid-template-columns: 1fr 1fr; }
    .grid.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
    .muted { color: #6c757d; }
    .btn {
        display:inline-flex; align-items:center; gap:8px;
        border:1px solid #c0e0c2; background:#e9f5e9; padding:8px 12px; border-radius:8px;
        cursor:pointer; font-weight:600;transition: background-color 0.2s ease-in-out;
    }
    .btn:hover { background:#dff0df; }
    .btn.secondary { background-color: #5a6268; color: white; }
    .btn.danger { background:#fdecea; border-color:#f5c2c7; }
    .chip { padding:4px 8px; border-radius:999px; border:1px solid #e0e0e0; background:#fff; }
    input, select { width:100%; padding:8px 10px; border:1px solid #ced4da; border-radius:8px; box-sizing:border-box; }
    table { width:100%; border-collapse: collapse; font-size: 0.95em; }
    th, td { border-bottom:1px solid #eee; padding:10px; text-align:left; }
    tr:hover td { background:#fafdf9; }
    tfoot td { font-weight:700; }
    .right { text-align:right; }
    .highlight { background:#f7fff2; }
    .ratio-badge { display:inline-block; padding:6px 10px; border-radius:8px; font-weight:700; }
    .ratio-high { background:#e3f2fd; border:1px solid #90caf9; }
    .ratio-ok { background:#e8f5e9; border:1px solid #a5d6a7; }
    .ratio-low { background:#fff3cd; border:1px solid #ffecb5; }
	 #weeklyPlanTable td, #shoppingListTable td {
            vertical-align: center;
        }
        #weeklyPlanTable ul, #shoppingListTable ul {
            margin: 0;
            padding: 0 0 0 20px;
        }
		#weeklyPlanTable {
  width: 100%;
  border-collapse: separate; /* Cambiado de collapse a separate para permitir border-radius */
  border-spacing: 0; /* Eliminar espacio entre celdas */
  margin-top: 1rem;
  border-radius: 8px; /* Border radius para la tabla */
  overflow: hidden; /* Importante para que el border-radius funcione */
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); /* Sutil sombra para profundidad */
}

#weeklyPlanTable th,
#weeklyPlanTable td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
  vertical-align: center;
}

/* Border radius para las esquinas superiores */
#weeklyPlanTable thead tr:first-child th:first-child {
  border-top-left-radius: 8px;
}

#weeklyPlanTable thead tr:first-child th:last-child {
  border-top-right-radius: 8px;
}

/* Border radius para las esquinas inferiores */
#weeklyPlanTable tbody tr:last-child td:first-child {
  border-bottom-left-radius: 8px;
}

#weeklyPlanTable tbody tr:last-child td:last-child {
  border-bottom-right-radius: 8px;
}

#weeklyPlanTable th {
  background-color: #f2f2f2;
  font-weight: 600;
}

#weeklyPlanTable td.right {
  text-align: right;
}

#weeklyPlanTable td.total-kcal {
  text-align: right;
  font-weight: bold;
}

#weeklyPlanTable td[data-day] {
  font-weight: bold;
}

/* Mejorar los colores de los d√≠as con bordes redondeados internos */
#weeklyPlanTable tbody tr:has(td:first-child[data-day="Lunes"]) td:first-child {
  border-top-left-radius: 6px;
  border-bottom-left-radius: 6px;
}

#weeklyPlanTable tbody tr:has(td:first-child[data-day="Domingo"]) td:first-child {
  border-top-left-radius: 6px;
  border-bottom-left-radius: 6px;
}

#weeklyPlanTable tbody tr:has(td:first-child[data-day="Lunes"]) {
  background-color: #FFE5E5; /* Light red */
}

#weeklyPlanTable tbody tr:has(td:first-child[data-day="Martes"]) {
  background-color: #E5F0FF; /* Light blue */
}

#weeklyPlanTable tbody tr:has(td:first-child[data-day="Mi√©rcoles"]) {
  background-color: #E5FFE5; /* Light green */
}

#weeklyPlanTable tbody tr:has(td:first-child[data-day="Jueves"]) {
  background-color: #FFF5E5; /* Light orange */
}

#weeklyPlanTable tbody tr:has(td:first-child[data-day="Viernes"]) {
  background-color: #F0E5FF; /* Light purple */
}

#weeklyPlanTable tbody tr:has(td:first-child[data-day="S√°bado"]) {
  background-color: #E5FFFF; /* Light cyan */
}

#weeklyPlanTable tbody tr:has(td:first-child[data-day="Domingo"]) {
  background-color: #FFF0E5; /* Light peach */
}

/* Mejorar el hover effect */
#weeklyPlanTable tbody tr:hover td {
  background-color: #f8faf8 !important;
  transition: background-color 0.2s ease;
}

	.footer { position:fixed; bottom:0; left:0; right:0; background:#fff; border-top:1px solid #e0e0e0; padding:10px 16px; display:flex; justify-content:space-between; align-items:center; }
    .small { font-size: 0.85em; }
    .kpi { display:flex; gap:14px; flex-wrap:wrap; }
    .kpi .card { padding:10px 12px; background:#fff; border:1px solid #e0e0e0; border-radius:10px; min-width:170px; }
	.edit-grams {
  width: 70px;
  text-align: right;
}
.button-group { margin: 1rem 0; }
.btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
.primary { background-color: #007bff; color: white; }
#shoppingListTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
  font-size: 0.9em;
}

/* Contenedor para la tabla con scroll */
#shoppingListContainer {
  max-height: 415px; /* Altura para aproximadamente 10 filas + header */
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 6px;
  margin-top: 8px;
}

/* Asegurar que el thead sea sticky */
#shoppingListTable thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

#shoppingListTable th,
#shoppingListTable td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
  vertical-align: top;
}

#shoppingListTable th {
  background-color: #f2f2f2;
  font-weight: 600;
}

#shoppingListTable td.right {
  text-align: right;
}

#shoppingListTable tr:hover td {
  background: #fafdf9;
}

/* Estilo para las filas - altura fija para calcular mejor el scroll */
#shoppingListTable tbody tr {
  height: 36px; /* Altura aproximada por fila */
}

section.data-section:has(#shoppingListTable) {
  background-color: #ffffff;
  padding: 20px;
  margin-bottom: 24px;
  border-radius: 8px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
  border: 1px solid #e0e0e0;
  box-sizing: border-box;
}

section.data-section:has(#shoppingListTable) h2 {
  color: #388E3C;
  font-size: 1.4em;
  font-weight: 600;
  border-bottom: 2px solid #a5d6a7;
  padding-bottom: 8px;
  margin-top: 0;
  margin-bottom: 20px;
}

section.data-section:has(#shoppingListTable) .grid.cols-2 {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items: center;
  margin-bottom: 16px;
}

section.data-section:has(#shoppingListTable) label[for="shoppingListDate"] {
  font-size: 0.9em;
  color: #495057;
  font-weight: 500;
  margin-bottom: 6px;
  display: block;
}

section.data-section:has(#shoppingListTable) #shoppingListDate {
  width: 180px;
  padding: 6px 8px;
  font-size: 0.85em;
  border: 1px solid #ced4da;
  border-radius: 6px;
  background-color: #f8f9fa;
  color: #212529;
  transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

section.data-section:has(#shoppingListTable) #shoppingListDate:focus {
  outline: none;
  border-color: #4CAF50;
  box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}

section.data-section:has(#shoppingListTable) #exportShoppingListBtn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 1px solid #c0e0c2;
  background: #e9f5e9;
  padding: 6px 12px;
  font-size: 0.85em;
  font-weight: 600;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
  white-space: nowrap;
}

section.data-section:has(#shoppingListTable) #exportShoppingListBtn:hover {
  background: #dff0df;
  transform: translateY(-1px);
}
#foodDatabaseTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
  table-layout: fixed; /* Ensure column alignment */
}
#foodDatabaseTable th,
#foodDatabaseTable td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
#foodDatabaseTable th {
  background-color: #f2f2f2;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10; /* Ensure header stays above content */
}
#foodDatabaseTable td.right {
  text-align: right;
}
/* Fallback for table in Base de Datos de Alimentos section if ID differs */
section.data-section h2:where(:text("Base de Datos de Alimentos")) ~ table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
  table-layout: fixed;
}
section.data-section h2:where(:text("Base de Datos de Alimentos")) ~ table th,
section.data-section h2:where(:text("Base de Datos de Alimentos")) ~ table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
section.data-section h2:where(:text("Base de Datos de Alimentos")) ~ table th {
  background-color: #f2f2f2;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10;
}
section.data-section h2:where(:text("Base de Datos de Alimentos")) ~ table td.right {
  text-align: right;
}
section.data-section:has(h2:where(:text("Base de Datos de Alimentos"))) {
  max-height: 400px; /* Adjustable height */
  overflow-y: auto; /* Enable vertical scrolling */
  position: relative; /* Contain sticky headers */
}
@media print {
    section.data-section:has(#shoppingListTable) .grid.cols-2,
    section.data-section:has(#shoppingListTable) button,
    section.data-section:has(#shoppingListTable) input {
        display: none;
    }
    section.data-section:has(#shoppingListTable) {
        box-shadow: none;
        border: none;
    }
    section.data-section:has(#shoppingListTable) #shoppingListTable {
        page-break-inside: auto;
    }
}
#dbTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
  table-layout: fixed; /* Ensure column alignment */
}
#dbTable th,
#dbTable td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
#dbTable th {
  background-color: #f2f2f2;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10; /* Ensure header stays above content */
}
#dbTable td.right {
  text-align: right;
}
section.data-section:has(#dbTable) {
  background-color: #ffffff;
  padding: 20px;
  margin-bottom: 24px;
  border-radius: 8px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
  border: 1px solid #e0e0e0;
  box-sizing: border-box;
}
section.data-section:has(#dbTable) h2 {
  color: #388E3C;
  font-size: 1.4em;
  font-weight: 600;
  border-bottom: 2px solid #a5d6a7;
  padding-bottom: 8px;
  margin-top: 0;
  margin-bottom: 20px;
}
section.data-section:has(#dbTable) .grid.cols-2 {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items: center;
  margin-bottom: 16px;
}
section.data-section:has(#dbTable) label[for="importFoodDatabase"] {
  font-size: 0.9em;
  color: #495057;
  font-weight: 500;
  margin-bottom: 6px;
  display: block;
}
section.data-section:has(#dbTable) #importFoodDatabase {
  width: 180px;
  padding: 6px 8px;
  font-size: 0.85em;
  border: 1px solid #ced4da;
  border-radius: 6px;
  background-color: #f8f9fa;
  color: #212529;
  transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
section.data-section:has(#dbTable) #importFoodDatabase:focus {
  outline: none;
  border-color: #4CAF50;
  box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}
section.data-section:has(#dbTable) #exportFoodDatabaseBtn,
section.data-section:has(#dbTable) #addFoodBtn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  border: 1px solid #c0e0c2;
  background: #e9f5e9;
  padding: 6px 12px;
  font-size: 0.85em;
  font-weight: 600;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
  white-space: nowrap;
}
section.data-section:has(#dbTable) #exportFoodDatabaseBtn:hover,
section.data-section:has(#dbTable) #addFoodBtn:hover {
  background: #dff0df;
  transform: translateY(-1px);
}
/* Modal styles */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background-color: #ffffff;
  padding: 20px;
  border-radius: 8px;
  width: 100%;
  max-width: 400px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
}
.modal-content h3 {
  margin-top: 0;
  color: #388E3C;
  font-size: 1.2em;
  font-weight: 600;
}
.form-group {
  margin-bottom: 12px;
}
.form-group label {
  display: block;
  font-size: 0.9em;
  color: #495057;
  font-weight: 500;
  margin-bottom: 6px;
}
.form-group input {
  width: 100%;
  padding: 6px 8px;
  font-size: 0.85em;
  border: 1px solid #ced4da;
  border-radius: 6px;
  background-color: #f8f9fa;
  color: #212529;
  box-sizing: border-box;
}
.form-group input:focus {
  outline: none;
  border-color: #4CAF50;
  box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}
.modal .button-group {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

@media print {
            nav, button, input, select {
                display: none;
            }
            #weeklyPlanTable, #shoppingListTable {
                page-break-inside: auto;
            }
            .footer {
                display: none;
            }
            section.data-section {
                box-shadow: none;
                border: none;
            }
        }
	section.data-section:has(#recipesTable) {
    background-color: #ffffff;
    padding: 20px;
    margin-bottom: 24px;
    border-radius: 8px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
    border: 1px solid #e0e0e0;
    box-sizing: border-box;
}

section.data-section:has(#recipesTable) h2 {
    color: #388E3C;
    font-size: 1.4em;
    font-weight: 600;
    border-bottom: 2px solid #a5d6a7;
    padding-bottom: 8px;
    margin-top: 0;
    margin-bottom: 20px;
}

section.data-section:has(#recipesTable) .muted {
    color: #6c757d;
    font-size: 0.9em;
    margin-bottom: 16px;
}

section.data-section:has(#recipesTable) #recipesTable {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
    margin-bottom: 20px;
}

section.data-section:has(#recipesTable) #recipesTable th,
section.data-section:has(#recipesTable) #recipesTable td {
    border: 1px solid #eee;
    padding: 8px;
    text-align: left;
    vertical-align: top;
}

section.data-section:has(#recipesTable) #recipesTable th {
    background-color: #f2f2f2;
    font-weight: 600;
    color: #388E3C;
}

section.data-section:has(#recipesTable) #recipesTable tr:hover td {
    background: #fafdf9;
}

section.data-section:has(#recipesTable) #recipesTable td:nth-child(3),
section.data-section:has(#recipesTable) #recipesTable td:nth-child(4),
section.data-section:has(#recipesTable) #recipesTable td:nth-child(5),
section.data-section:has(#recipesTable) #recipesTable td:nth-child(6) {
    text-align: right;
}
/* Existing styles for the Recetas section */
.data-section { margin-bottom: 2rem; }
table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background-color: #f2f2f2; }
.right { text-align: right; }
.button-group { margin: 1rem 0; }
.btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
.secondary { background-color: #5a6268; color: white; }
.primary { background-color: #28a745; color: white; } /* Changed to green */
form { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; } 
input, select { padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
@media print {
    section.data-section:has(#recipesTable) {
        box-shadow: none;
        border: none;
    }
    section.data-section:has(#recipesTable) #recipesTable {
        page-break-inside: auto;
    }
}
#recipesTable tbody tr td:first-child {
    text-align: left;
    font-weight: bold;
}
#recipesTable tbody tr:has(td:first-child[data-meal-type="Desayuno"]) {
    background-color: #FFF2CC;
}
#recipesTable tbody tr:has(td:first-child[data-meal-type="Almuerzo"]) {
    background-color: #E2EFDA;
}
#recipesTable tbody tr:has(td:first-child[data-meal-type="Cena"]) {
    background-color: #DDEBF7;
}
#recipesTable tbody tr:has(td:first-child[data-meal-type="Snack"]) {
    background-color: #C6E0B4;
}
#recipesTable tbody tr:has(td:first-child[data-meal-type="Snack Post-Entrenamiento"]) {
    background-color: #F8CBAD;
}
#recipesTable tbody tr:has(td:first-child[data-meal-type="Snack (Barritas)"]) {
    background-color: #C6E0B4;
}
#recipesTable tbody tr:has(td:first-child[data-meal-type="Snack (Sanak 1)"]) {
    background-color: #C6E0B4;
}
#recipesTable tbody tr:has(td:first-child[data-meal-type="Limpieza"]) {
    background-color: #B8C3D2;
}
#recipesTable tbody tr:has(td:first-child[data-meal-type="Recetas"]) {
    background-color: #F0D6FE;
}

/* Estilos para el modal de nutrici√≥n */
#nutritionChartContainer {
  display: flex;
  justify-content: center;
  margin: 20px 0;
}

#dailyNutritionModal .modal-content {
  max-height: 90vh;
  overflow-y: auto;
}

/* Responsive para el gr√°fico */
@media (max-width: 600px) {
  #nutritionChart {
    max-width: 300px;
    max-height: 300px;
  }
}
/* Estilos para la secci√≥n de consejos */
#nutritionAdvice {
  font-size: 0.95em;
  line-height: 1.5;
}

#nutritionAdvice h4 {
  font-size: 1.1em;
  margin-bottom: 10px;
}

#nutritionAdvice ul {
  margin: 10px 0;
}

#nutritionAdvice li {
  margin-bottom: 8px;
}

#adviceContent strong {
  color: #2e7d32;
}
/* Contenedor para la tabla de ingredientes con scroll */
#recipeTableContainer {
  max-height: 415px; /* Altura para aproximadamente 10 filas + header + footer */
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 6px;
  margin-top: 18px;
}

/* Asegurar que el thead sea sticky */
#recipeTable thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

/* Asegurar que el tfoot sea sticky */
#recipeTable tfoot {
  position: sticky;
  bottom: 0;
  z-index: 10;
  background-color: #f7fff2; /* Mantener el color de highlight */
}

#recipeTable {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.95em;
}

#recipeTable th, 
#recipeTable td {
  border-bottom: 1px solid #eee;
  padding: 10px;
  text-align: left;
}

#recipeTable tr:hover td {
  background: #fafdf9;
}

#recipeTable tfoot td {
  font-weight: 700;
}

#recipeTable .right {
  text-align: right;
}

#recipeTable .highlight {
  background: #f7fff2;
}

#recipeTable .edit-grams {
  width: 70px;
  text-align: right;
}
/* Estilos para los botones de exportar/importar en la secci√≥n */
.data-section h2 {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.data-section .btn {
  white-space: nowrap;
}

/* Ajuste responsive para pantallas peque√±as */
@media (max-width: 768px) {
  .data-section > div:first-child {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  .data-section > div:first-child > div {
    width: 100%;
  }
  
  /* Estilos mejorados para el formulario de recetas */
#addRecipeForm {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#addRecipeForm input,
#addRecipeForm select {
  padding: 10px 12px;
  border: 1px solid #ced4da;
  border-radius: 6px;
  font-size: 0.95em;
  box-sizing: border-box;
  transition: all 0.2s ease;
}

#addRecipeForm input:focus,
#addRecipeForm select:focus {
  outline: none;
  border-color: #4CAF50;
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
}

/* Placeholder m√°s visible */
#addRecipeForm input::placeholder {
  color: #6c757d;
  opacity: 0.8;
}

/* Estilos espec√≠ficos para campos largos */
#recipeName,
#ingredientsInput {
  font-size: 1em;
  padding: 12px;
}

/* Responsive para pantallas medianas */
@media (max-width: 1024px) {
  #addRecipeForm > div:first-child {
    grid-template-columns: 1.5fr 1fr !important;
  }
}

/* Responsive para pantallas peque√±as */
@media (max-width: 768px) {
  #addRecipeForm > div:first-child,
  #addRecipeForm > div:nth-child(2) {
    grid-template-columns: 1fr !important;
  }
  
  #recipeName,
  #ingredientsInput {
    font-size: 0.95em;
    padding: 10px;
  }
}

@media (max-width: 480px) {
  #addRecipeForm {
    gap: 10px;
  }
  
  #addRecipeForm input,
  #addRecipeForm select {
    padding: 8px 10px;
    font-size: 0.9em;
  }
}
/* Nuevos estilos para el contenedor del formulario de recetas */
    .recipe-form-container {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #e0e0e0;
    }
    
    .recipe-form-container h3 {
      color: #388E3C;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.2em;
      border-bottom: 2px solid #a5d6a7;
      padding-bottom: 8px;
    }
	/* Contenedor principal: alinea el grupo de inputs a la izquierda y los botones a la derecha */
.shopping-list-actions {
  display: flex;
  justify-content: space-between; /* Empuja los elementos hijos a los extremos */
  align-items: flex-end; /* Alinea los elementos al final (parte inferior) en el eje transversal */
  flex-wrap: wrap; /* Permite que los elementos se envuelvan si el espacio es insuficiente */
  gap: 10px; /* Espacio m√≠nimo entre los elementos hijos */
  width: 100%; /* Opcional: asegura que ocupe el ancho completo de su contenedor padre */
  /* padding: 5px 0; */ /* Opcional: un poco de espacio interno vertical */
}

/* Grupo de botones de la derecha: los pone uno al lado del otro */
.button-group-right {
  display: flex;
  gap: 10px; /* Espacio entre los botones */
}

/* Opcional: Asegurar que los botones tengan un ancho m√≠nimo razonable */
.shopping-list-actions .btn,
.shopping-list-actions .btn.secondary {
  white-space: nowrap; /* Evita que el texto se corte en varias l√≠neas dentro del bot√≥n */
}
  </style>
</head>
<body>
  <header>
    <div class="logo"><a href="#">KetoCalc</a></div>
    <nav>
      <ul>
        
		<li><a href="https://fermagil.github.io/Nutri_Plan_v2/Inicio_NutriPlan_v2.html">Inicio</a></li>
		<li><a href="https://fermagil.github.io/Nutri_Plan_v2/Valoracion_Antropometrica_1.html">Valoraci√≥n Antropometrica</a></li>
        <li><a href="https://fermagil.github.io/Nutri_Plan_v2/Nutri_Plan_Advanced_v2.html">Planificaci√≥n Avanzada</a></li>
		<li><a class="active" href="#">Calculadora</a></li>
		 
      </ul>
    </nav>
  </header>

  <main>
    <h1>Calculadora de Recetas Keto</h1>
	
   <section class="data-section">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">Ingredientes</h2>
      <div style="display: flex; gap: 10px;">
        <button id="exportBtn" class="btn">Exportar receta</button>
        <label class="btn secondary" for="importFile">Importar receta</label>
        <input id="importFile" type="file" accept=".json" style="display:none" />
      </div>
    </div>
  
  <div class="grid cols-3" style="align-items:end">
    <div>
      <label>Buscar alimento</label>
      <input id="foodSearch" placeholder="Escribe para filtrar..." />
    </div>
    <div>
      <label>Alimento</label>
      <select id="foodSelect"></select>
    </div>
    <div>
      <label>Cantidad (g)</label>
      <input id="gramsInput" type="number" min="0" step="1" value="100" />
    </div>
  </div>
  <div style="margin-top:12px; display:flex; gap:10px;">
    <button id="addBtn" class="btn">+ A√±adir a la receta</button>
    <button id="clearBtn" class="btn danger">Vaciar</button>
  </div>

  <!-- Contenedor a√±adido para el scroll -->
  <div id="recipeTableContainer">
    <table id="recipeTable">
      <thead>
        <tr>
          <th>Alimento</th>
          <th class="right">N¬∫ (g)</th>
          <th class="right">Grasa (g)</th>
          <th class="right">Prote√≠na (g)</th>
          <th class="right">Net Carbs (g)</th>
          <th class="right">Kcal</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr class="highlight">
          <td>Total</td>
          <td class="right" id="tot_g">0</td>
          <td class="right" id="tot_f">0</td>
          <td class="right" id="tot_p">0</td>
          <td class="right" id="tot_c">0</td>
          <td class="right" id="tot_kcal">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
</section>

    <section class="data-section">
      <h2>Ratio Cetog√©nico & Distribuci√≥n</h2>
      <div class="kpi">
        <div class="card">
          <div class="small muted">Ratio cetog√©nico</div>
          <div style="display:flex; align-items:center; gap:10px;">
            <span id="ratioBadge" class="ratio-badge ratio-low">0.00</span>
            <span id="ratioText" class="small muted">Objetivo 1.0‚Äì2.0</span>
          </div>
        </div>
        <div class="card">
          <div class="small muted">% Calor√≠as</div>
          <div class="small">Grasa: <b id="pctF">0%</b> ¬∑ Prot: <b id="pctP">0%</b> ¬∑ Carbs: <b id="pctC">0%</b></div>
        </div>
        <div class="card">
          <div class="small muted">Kcal totales</div>
          <div><b id="kcalBox">0</b> kcal</div>
        </div>
      </div>
      <div style="margin-top:10px;" class="small muted">
        Ratio = gramos de grasa √∑ (gramos prote√≠na + gramos carbos netos).<br/>
        Umbrales orientativos: <span class="chip">Alto ‚â• 2.0</span> ¬∑ <span class="chip">Moderado 1.0‚Äì1.9</span> ¬∑ <span class="chip">Bajo &lt; 1.0</span>
      </div>
    </section>

    <section class="data-section">
  <h2>Base de Datos de Alimentos</h2>
  <div class="small muted">Valores por 100 g. Puedes exportar/importar tu propia base en JSON.</div>
  <div class="grid cols-2">
    <div>
      <label for="importFoodDatabase">Importar BD JONSON</label>
      <input type="file" id="importFoodDatabase" accept=".json" />
    </div>
    <div class="button-group">
      <button id="exportFoodDatabaseBtn" class="btn">Exportar Base de Datos</button>
      <button id="addFoodBtn" class="btn">A√±adir Alimento</button>
	  <button id="printFoodBtn" class="btn secondary">üñ® Imprimir BD Alimentos</button>
    </div>
  </div>
  <div style="max-height:260px; overflow:auto; margin-top:8px;">
    <table id="dbTable">
      <thead>
        <tr>
          <th>Alimento</th>
          <th class="right">Grasa</th>
          <th class="right">Prote√≠na</th>
          <th class="right">Net Carbs</th>
          <th class="right">Kcal</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="addFoodModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>A√±adir Nuevo Alimento</h3>
      <form id="addFoodForm">
        <div class="form-group">
          <label for="foodName">Alimento</label>
          <input type="text" id="foodName" name="name" required />
        </div>
        <div class="form-group">
          <label for="foodFat">Grasa (g por 100g)</label>
          <input type="number" id="foodFat" name="fat_per_100g" step="0.1" min="0" required />
        </div>
        <div class="form-group">
          <label for="foodProtein">Prote√≠na (g por 100g)</label>
          <input type="number" id="foodProtein" name="protein_per_100g" step="0.1" min="0" required />
        </div>
        <div class="form-group">
          <label for="foodCarbs">Net Carbs (g por 100g)</label>
          <input type="number" id="foodCarbs" name="netcarbs_per_100g" step="0.1" min="0" required />
        </div>
        <div class="form-group">
          <label for="foodKcal">Kcal (por 100g)</label>
          <input type="number" id="foodKcal" name="kcal_per_100g" step="0.1" min="0" required />
        </div>
        <div class="button-group">
          <button type="submit" class="btn primary">A√±adir</button>
          <button type="button" id="cancelAddFoodBtn" class="btn secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</section>

	<section class="data-section">
      <h2>Plan Semanal</h2>
      <div class="button-group">
        <button id="addToWeeklyPlanBtn" class="btn">A√±adir receta al plan</button>
        <button id="importtWeeklyPlanBtn" class="btn">Importar plan</button>
        <button id="exportWeeklyPlanBtn" class="btn">Exportar plan</button>
		<button id="vaciarWeeklyPlanBtn" class="btn">Limiar Plan Semanal</button>
		<button id="printWeeklyPlanBtn" class="btn secondary">üñ® Imprimir Plan</button>
        <button onclick="window.print()" class="btn secondary">üñ® Imprimir todo</button>
      </div>
      
      <!-- Contenedor con scroll y encabezado fijo -->
      <div class="weekly-plan-container">
        <table id="weeklyPlanTable">
          <thead>
            <tr>
              <th>D√≠a</th>
              <th>Desayuno</th>
              <th>Almuerzo</th>
              <th>Cena</th>
              <th>Snack</th>
              <th>Kcal Totales</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td data-day="Lunes">Lunes</td>
              <td id="Lunes-Desayuno"></td>
              <td id="Lunes-Almuerzo"></td>
              <td id="Lunes-Cena"></td>
              <td id="Lunes-Snack"></td>
              <td class="total-kcal" id="Lunes-Kcal"></td>
            </tr>
            <tr>
              <td data-day="Martes">Martes</td>
              <td id="Martes-Desayuno"></td>
              <td id="Martes-Almuerzo"></td>
              <td id="Martes-Cena"></td>
              <td id="Martes-Snack"></td>
              <td class="total-kcal" id="Martes-Kcal"></td>
            </tr>
            <tr>
              <td data-day="Mi√©rcoles">Mi√©rcoles</td>
              <td id="Mi√©rcoles-Desayuno"></td>
              <td id="Mi√©rcoles-Almuerzo"></td>
              <td id="Mi√©rcoles-Cena"></td>
              <td id="Mi√©rcoles-Snack"></td>
              <td class="total-kcal" id="Mi√©rcoles-Kcal"></td>
            </tr>
            <tr>
              <td data-day="Jueves">Jueves</td>
              <td id="Jueves-Desayuno"></td>
              <td id="Jueves-Almuerzo"></td>
              <td id="Jueves-Cena"></td>
              <td id="Jueves-Snack"></td>
              <td class="total-kcal" id="Jueves-Kcal"></td>
            </tr>
            <tr>
              <td data-day="Viernes">Viernes</td>
              <td id="Viernes-Desayuno"></td>
              <td id="Viernes-Almuerzo"></td>
              <td id="Viernes-Cena"></td>
              <td id="Viernes-Snack"></td>
              <td class="total-kcal" id="Viernes-Kcal"></td>
            </tr>
            <tr>
              <td data-day="S√°bado">S√°bado</td>
              <td id="S√°bado-Desayuno"></td>
              <td id="S√°bado-Almuerzo"></td>
              <td id="S√°bado-Cena"></td>
              <td id="S√°bado-Snack"></td>
              <td class="total-kcal" id="S√°bado-Kcal"></td>
            </tr>
            <tr>
              <td data-day="Domingo">Domingo</td>
              <td id="Domingo-Desayuno"></td>
              <td id="Domingo-Almuerzo"></td>
              <td id="Domingo-Cena"></td>
              <td id="Domingo-Snack"></td>
              <td class="total-kcal" id="Domingo-Kcal"></td>
            </tr>
            
          </tbody>
        </table>
      </div>
  
</section>

    <section class="data-section">
    <h2>Lista de la Compra</h2>
    <div class="shopping-list-actions">
		  <div>
			<label for="shoppingListDate">Seleccionar fecha para exportar:</label>
			<input type="date" id="shoppingListDate">
		  </div>
		  
		  <div class="button-group-right">
			<button id="printtShoppingListBtn" class="btn secondary">Imprimir lista</button>
			<button id="exportShoppingListBtn" class="btn">Exportar lista</button>
		  </div>
		</div>
	
    <div id="shoppingListContainer"> <!-- Contenedor a√±adido aqu√≠ -->
        <table id="shoppingListTable">
            <thead>
                <tr>
                    <th>Alimento</th>
                    <th>Cantidad Total (g)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</section>
		
		<section class="data-section">
    <h2>Recetas</h2>
    <p class="muted">Plan de comidas cetog√©nicas adaptado: desayunos, almuerzos y cenas de 700-800 kcal; snacks de 300-400 kcal. Ratio keto ~1.7 (75% grasa, 20% prote√≠na, 5% carbohidratos netos). Valores por porci√≥n.</p>
    
    <!-- Contenedor a√±adido para el formulario -->
    <div class="recipe-form-container">
      <h3>A√±adir Nueva Receta</h3>
      <form id="addRecipeForm">
        <!-- Fila 1: Nombre + Tipo de comida -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
                <input type="text" id="recipeName" placeholder="Nombre de la receta" required style="width: 100%;">
            </div>
            <div>
                <select id="mealType" required style="width: 100%;">
                    <option value="" disabled selected>Tipo de comida</option>
                    <option value="Desayuno">Desayuno</option>
                    <option value="Almuerzo">Almuerzo</option>
                    <option value="Cena">Cena</option>
                    <option value="Snack">Snack</option>
                    <option value="Snack Post-Entrenamiento">Snack Post-Entrenamiento</option>
                    <option value="Snack (Barritas)">Snack (Barritas)</option>
                    <option value="Snack (Sanak 1)">Snack (Sanak 1)</option>
                    <option value="Limpieza">Limpieza</option>
                    <option value="Recetas">Recetas</option>
                </select>
            </div>
        </div>
        
        <!-- Fila 2: Ingredientes - ancho completo -->
        <div style="margin-bottom: 12px;">
            <input type="text" id="ingredientsInput" placeholder="Ingredientes (e.g., Huevo (100g), Aceite (30g))" required style="width: 100%;">
        </div>
        
        <!-- Fila 3: Macronutrientes en 4 columnas -->
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
                <input type="number" id="fatInput" placeholder="Grasas (g)" min="0" step="0.1" required style="width: 100%;">
            </div>
            <div>
                <input type="number" id="proteinInput" placeholder="Prote√≠nas (g)" min="0" step="0.1" required style="width: 100%;">
            </div>
            <div>
                <input type="number" id="carbsInput" placeholder="Carbohidratos (g)" min="0" step="0.1" required style="width: 100%;">
            </div>
            <div>
                <input type="number" id="kcalInput" placeholder="Calor√≠as (kcal)" min="0" step="1" required style="width: 100%;">
            </div>
        </div>
        
        <!-- Fila 4: Botones -->
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn primary">A√±adir</button>
            <button type="button" id="clearRecipeForm" class="btn secondary">Vaciar</button>
        </div>
      </form>
    </div>
    
    <div class="button-group">
        <button id="exportRecipesBtn" class="btn primary">Exportar Recetas</button>
        <label for="importRecipesFile" class="btn primary">Importar Recetas</label>
        <input type="file" id="importRecipesFile" accept=".json" style="display: none;">
		<button id="printRecipesBtn" class="btn primary">Imprimir Recetas</button>
    </div>
	
   
	<div id="recipesAccordion">
    <!-- Accordion tabs will be dynamically populated by renderRecipes -->
  </div>
    <table id="recipesTable" style="display: none;">
        <thead>
            <tr>
                <th>Tipo de Comida</th>
                <th>Nombre de la Receta</th>
                <th>GrS (g)</th>
                <th>PrT (g)</th>
                <th>Net HC (g)</th>
                <th>Kcal Total</th>
                <th>Ingredientes (gramos)</th>
            </tr>
        </thead>
        <tbody>
            <!-- Pre-populated recipes can remain as-is -->
            <tr>
                <td>Desayuno</td>
                <td>Keto Batido Verde</td>
                <td>48</td>
                <td>22</td>
                <td>8</td>
                <td>554</td>
                <td>Whey protein (20g), Almond milk (150ml), Spinach (50g), Chia seeds (10g), Avocado (50g), Butter (30g), Heavy cream (70g), Cinnamon (1g), Te Matcha (2g) with lemon (200ml)</td>
            </tr>
            <tr>
                <td>Desayuno</td>
                <td>Keto Jugo Verde</td>
                <td>65</td>
                <td>34</td>
                <td>9</td>
                <td>758</td>
                <td>Whey protein (40g), Spinach (50g), Cucumber (50g), Celery (50g), Ginger (2g), Lemon juice (20ml), Olive oil (20g), Heavy cream (70g), Cinnamon (1g), Green tea with lemon (200ml)</td>
            </tr>
            <tr>
                <td>Desayuno</td>
                <td>Keto Batido Br√≥coli</td>
                <td>45</td>
                <td>32</td>
                <td>12</td>
                <td>586</td>
                <td>Whey protein (30g), Broccoli (30g), Spinach (50g), Cucumber (50g), Mustard seeds (5g), Chia seeds (20g), Avocado (100g), Almond milk (150ml), Lemon juice (20ml), Heavy cream (80g), T√© Matcha Verde (2g)</td>
            </tr>
            <tr>
                <td>Desayuno</td>
                <td>Keto Tostadas</td>
                <td>64</td>
                <td>38</td>
                <td>8</td>
                <td>759</td>
                <td>Almond flour (30g), Psyllium husk (5g), Eggs (100g, 2 units), Avocado (50g), Tomato (30g), Sunflower seeds (15g), Olive oil (15g), Whey protein (20g), Almond milk (100ml)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Salm√≥n al Horno</td>
                <td>66.9</td>
                <td>33.2</td>
                <td>5.2</td>
                <td>753.9</td>
                <td>Salmon (150g), Broccoli (100g), Spinach (50g), Olive oil (30g), Butter (20g)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Salm√≥n al Vapor</td>
                <td>84.9</td>
                <td>33.9</td>
                <td>6.4</td>
                <td>720.2</td>
                <td>Salmon (150g), Broccoli (100g), Heavy cream (30g), Olive oil (20g), Butter (20g), Coconut oil (10g)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Salm√≥n Ajo y Lim√≥n</td>
                <td>68.7</td>
                <td>34.3</td>
                <td>7.2</td>
                <td>780.5</td>
                <td>Salmon (150g), Garlic (3g), Lemon juice (20ml), Olive oil (30g), Broccoli (100g), Heavy cream (50g), Dill (2g)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Salm√≥n con Espinacas</td>
                <td>67.5</td>
                <td>33.7</td>
                <td>3.4</td>
                <td>751.9</td>
                <td>Salmon (150g), Olive oil (30g), Rosemary (2g), Garlic (6g), Spinach (200g), Lemon juice (20ml), Butter (20g), Cauliflower (50g)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Caballa Papillote</td>
                <td>81.3</td>
                <td>31.2</td>
                <td>3.4</td>
                <td>762.4</td>
                <td>Mackerel (150g), Asparagus (100g), Spinach (50g), Olive oil (20g), Butter (20g), Heavy cream (30g), Lemon juice (20ml)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Sardinas y Pollo Ensalada</td>
                <td>66.8</td>
                <td>40.6</td>
                <td>4.4</td>
                <td>791.6</td>
                <td>Sardines (80g), Tomato (30g), Cucumber (30g), Celery (50g), Chicken breast (60g), Olive oil (30g), Heavy cream (70g)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Revuelto de Verduras</td>
                <td>74.6</td>
                <td>41.1</td>
                <td>5.4</td>
                <td>756.4</td>
                <td>Eggs (100g, 2 units), Zucchini (100g), Mushrooms (80g), Chicken breast (80g), Olive oil (30g), Butter (20g), Coconut oil (15g)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Tortilla de Esp√°rragos</td>
                <td>64.2</td>
                <td>39.9</td>
                <td>4</td>
                <td>761.4</td>
                <td>Eggs (100g, 2 units), Asparagus (100g), Cucumber (30g), Chicken breast (80g), Olive oil (30g), Butter (20g), Lemon juice (20ml), Coconut oil (5g)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Sopa de Calabaza Keto</td>
                <td>63.1</td>
                <td>37.6</td>
                <td>5.9</td>
                <td>757</td>
                <td>Cauliflower (100g), Chicken breast (100g), Olive oil (30g), Almonds (15g), Turmeric (2g), Heavy cream (60g)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Ensalada Templada Keto</td>
                <td>64.7</td>
                <td>31.9</td>
                <td>6.6</td>
                <td>748.9</td>
                <td>Cauliflower rice (100g), Spinach (100g), Avocado (70g), Walnuts (15g), Olive oil (30g), Lemon juice (20ml), Chicken breast (80g), Heavy cream (30g)</td>
            </tr>
            <tr>
                <td>Almuerzo</td>
                <td>Quinoa Keto con Br√≥coli</td>
                <td>59.1</td>
                <td>33.5</td>
                <td>10.6</td>
                <td>733.4</td>
                <td>Cauliflower rice (100g), Broccoli (100g), Avocado (70g), Flax seeds (10g), Olive oil (30g), Lemon juice (20ml), Chicken breast (80g), Heavy cream (30g)</td>
            </tr>
            <tr>
                <td>Cena</td>
                <td>Merluza al Vapor</td>
                <td>60</td>
                <td>34</td>
                <td>5</td>
                <td>720</td>
                <td>Hake (180g), Asparagus (150g), Cucumber (50g), Olive oil (40g), Almonds (15g), Lemon juice (20ml)</td>
            </tr>
            <tr>
                <td>Cena</td>
                <td>Sardinas Ensalada Keto</td>
                <td>61</td>
                <td>34</td>
                <td>5</td>
                <td>730</td>
                <td>Sardines (100g), Tomato (50g), Cucumber (50g), Celery (50g), Olive oil (40g), Butter (20g)</td>
            </tr>
            <tr>
                <td>Cena</td>
                <td>Sopa de Calabaza Keto</td>
                <td>60</td>
                <td>35</td>
                <td>5</td>
                <td>720</td>
                <td>Cauliflower (150g, sub for pumpkin), Chicken breast (150g), Olive oil (40g), Almonds (15g), Turmeric (2g), Heavy cream (50g)</td>
            </tr>
            <tr>
                <td>Cena</td>
                <td>Tortilla y Pollo Keto</td>
                <td>61</td>
                <td>34</td>
                <td>5</td>
                <td>730</td>
                <td>Eggs (150g, 3 units), Zucchini (150g), Mushrooms (100g), Chicken breast (100g), Olive oil (40g), Butter (20g)</td>
            </tr>
            <tr>
                <td>Cena</td>
                <td>Merluza con Br√≥coli</td>
                <td>60</td>
                <td>34</td>
                <td>5</td>
                <td>720</td>
                <td>Hake (180g), Broccoli (150g), Spinach (50g), Olive oil (40g), Almonds (15g), Butter (20g)</td>
            </tr>
            <tr>
                <td>Cena</td>
                <td>Salm√≥n Papillote</td>
                <td>62</td>
                <td>36</td>
                <td>5</td>
                <td>740</td>
                <td>Salmon (180g), Asparagus (150g), Spinach (50g), Olive oil (40g), Butter (20g), Lemon juice (20ml)</td>
            </tr>
            <tr>
                <td>Cena</td>
                <td>Crema de Br√≥coli Keto</td>
                <td>61</td>
                <td>34</td>
                <td>5</td>
                <td>730</td>
                <td>Broccoli (200g), Cauliflower (100g, sub for potato), Olive oil (40g), Turmeric (2g), Ginger (2g), Heavy cream (50g), Chicken breast (100g)</td>
            </tr>
            <tr>
                <td>Cena</td>
                <td>Ensalada de Repollo Keto</td>
                <td>60</td>
                <td>34</td>
                <td>5</td>
                <td>720</td>
                <td>Purple cabbage (150g), Avocado (70g), Walnuts (15g), Sunflower seeds (15g), Olive oil (40g), Apple cider vinegar (5ml), Ginger (2g), Chicken breast (150g)</td>
            </tr>
            <tr>
                <td>Cena</td>
                <td>Ensalada C√©sar Keto</td>
                <td>61</td>
                <td>34</td>
                <td>5</td>
                <td>730</td>
                <td>Purple cabbage (100g), Kale (100g), Walnuts (15g), Sesame seeds (10g), Olive oil (40g), Lemon juice (10ml), Mustard (5g), Chicken breast (150g)</td>
            </tr>
            <tr>
                <td>Snack</td>
                <td>Yogur Keto con Frutos</td>
                <td>28</td>
                <td>14</td>
                <td>3</td>
                <td>350</td>
                <td>Coconut yogurt (150g), Blackberries (50g, reduced), Almonds (15g), Flax seeds (10g)</td>
            </tr>
            <tr>
                <td>Snack</td>
                <td>Batido Keto</td>
                <td>28</td>
                <td>15</td>
                <td>3</td>
                <td>350</td>
                <td>Whey protein (20g), Almond milk (250ml), Avocado (50g), Almonds (10g), Coconut oil (15g)</td>
            </tr>
            <tr>
                <td>Snack</td>
                <td>K√©fir Keto</td>
                <td>29</td>
                <td>14</td>
                <td>3</td>
                <td>360</td>
                <td>Coconut kefir (150g), Avocado (50g), Whey protein (20g), Almonds (10g), Coconut oil (10g)</td>
            </tr>
            <tr>
                <td>Snack</td>
                <td>Huevos y Nueces</td>
                <td>28</td>
                <td>15</td>
                <td>2</td>
                <td>350</td>
                <td>Hard-boiled eggs (100g, 2 units), Walnuts (15g), Olive oil (15g)</td>
            </tr>
            <tr>
                <td>Snack</td>
                <td>Semillas y Frutos</td>
                <td>29</td>
                <td>14</td>
                <td>3</td>
                <td>360</td>
                <td>Pumpkin seeds (20g), Blackberries (50g, reduced), Whey protein (20g), Olive oil (15g)</td>
            </tr>
            <tr>
                <td>Snack</td>
                <td>Claras y Almendras</td>
                <td>28</td>
                <td>15</td>
                <td>2</td>
                <td>350</td>
                <td>Egg whites (100g, 3 units), Almonds (15g), Whey protein (20g), Coconut oil (15g)</td>
            </tr>
            <tr>
                <td>Snack</td>
                <td>Batido Verde Keto</td>
                <td>29</td>
                <td>14</td>
                <td>3</td>
                <td>360</td>
                <td>Spinach (80g), Cucumber (100g), Lemon juice (10ml), Ginger (2g), Whey protein (20g), Olive oil (15g), Avocado (50g)</td>
            </tr>
			<tr>
				<td>Snack</td>
				<td>Huevos Rellenos Keto</td>
				<td>32.2</td>
				<td>16.8</td>
				<td>2.1</td>
				<td>363</td>
				<td>2 eggs (100g), keto mayonnaise (20g), mustard (5g), cream cheese (20g), paprika (1g). Hard-boil eggs, halve, mix yolks with mayo, mustard, cream cheese, coconut oil (5g); fill egg whites, sprinkle with paprika.</td>
			</tr>
			<tr>
				<td>Snack</td>
				<td>Rollitos de Jam√≥n y Queso</td>
				<td>30.9</td>
				<td>21.8</td>
				<td>1.8</td>
				<td>377.3</td>
				<td>Jam√≥n serrano (60g), cream cheese (40g), keto mayonnaise (10g), coconut oil (5g). Spread cream cheese and mayo on jam√≥n, roll up, drizzle with melted coconut oil.</td>
			</tr>
			<tr>
				<td>Snack</td>
				<td>Nueces y Almendras Tostadas</td>
				<td>38.1</td>
				<td>15.5</td>
				<td>2.4</td>
				<td>297.4</td>
				<td>Almonds (20g), walnuts (20g), cheddar cheese (25g), salt (1g). Toast nuts with salt, serve with shredded cheese.</td>
			</tr>
			<tr>
				<td>Snack</td>
				<td>Chips de Queso</td>
				<td>31.6</td>
				<td>13.9</td>
				<td>0.9</td>
				<td>343.4</td>
				<td>Cheddar cheese (50g), keto mayonnaise (10g), coconut oil (5g). Bake cheese at 200¬∞C for 5‚Äì7 min until crispy, serve with mayo and melted coconut oil dip.</td>
			</tr>
			<tr>
				<td>Snack</td>
				<td>Palitos de Apio con Dip</td>
				<td>34.2</td>
				<td>9.6</td>
				<td>2.8</td>
				<td>366.2</td>
				<td>Celery (100g), keto mayonnaise (30g), cream cheese (10g), cheddar cheese (20g). Mix mayo and cream cheese as dip, serve with celery and shredded cheese.</td>
			</tr>
			<tr>
				<td>Snack</td>
				<td>Bocaditos de Aguacate y Salm√≥n</td>
				<td>29.6</td>
				<td>13.1</td>
				<td>2.7</td>
				<td>337.7</td>
				<td>Avocado (70g), smoked salmon (50g), cream cheese (20g), lemon juice (10ml), keto mayonnaise (10g), coconut oil (5g). Cube avocado, top with salmon, cream cheese, mayo, lemon juice; drizzle with coconut oil.</td>
			</tr>
			<tr>
				<td>Snack</td>
				<td>Pepitas de Calabaza Tostadas</td>
				<td>32.2</td>
				<td>14.3</td>
				<td>1.7</td>
				<td>354.2</td>
				<td>Pumpkin seeds (25g), olive oil (10g), cheddar cheese (30g), salt (1g). Toast seeds in olive oil with salt, serve with shredded cheese.</td>
			</tr>
			<tr>
				<td>Snack</td>
				<td>Fat Bombs de Chocolate Keto</td>
				<td>30.7</td>
				<td>16.7</td>
				<td>3</td>
				<td>359.5</td>
				<td>Cocoa butter (25g), unsweetened cocoa powder (5g), erythritol (5g), whey protein (20g), almond butter (10g). Melt cocoa butter, mix with cocoa powder, erythritol, whey protein, almond butter; chill in molds.</td>
			</tr>
			<tr>
				<td>Snack</td>
				<td>Mini Tortillas de Huevo</td>
				<td>30.1</td>
				<td>21.6</td>
				<td>1.3</td>
				<td>314.8</td>
				<td>Eggs (100g, 2 units), cheddar cheese (30g), spinach (20g), keto mayonnaise (10g), coconut oil (5g). Mix eggs, cheese, spinach, mayo; bake in mini muffin tins at 180¬∞C for 10‚Äì12 min, drizzle with coconut oil.</td>
			</tr>
            <tr>
                <td>Snack Post-Entrenamiento</td>
                <td>Batido Post-Keto</td>
                <td>28</td>
                <td>15</td>
                <td>3</td>
                <td>350</td>
                <td>Whey protein (20g), Almond milk (250ml), Avocado (50g), Almonds (10g), Coconut oil (15g)</td>
            </tr>
            <tr>
                <td>Snack Post-Entrenamiento</td>
                <td>Batido Post-Keto Plus</td>
                <td>30</td>
                <td>16</td>
                <td>3</td>
                <td>370</td>
                <td>Whey protein (25g), Almond milk (300ml), Avocado (50g), Almonds (15g), Coconut oil (15g)</td>
            </tr>
            <tr>
                <td>Snack (Barritas)</td>
                <td>Barritas Keto</td>
                <td>29</td>
                <td>14</td>
                <td>3</td>
                <td>360</td>
                <td>Hemp protein (40g), Almonds (20g), Chia seeds (10g), Egg whites (60g), Coconut oil (15g), Green banana flour (10g)</td>
            </tr>
            <tr>
                <td>Snack (Sanak 1)</td>
                <td>Manzana Keto</td>
                <td>28</td>
                <td>14</td>
                <td>3</td>
                <td>350</td>
                <td>Avocado (70g, sub for apple), Walnuts (10g), Almonds (10g), Whey protein (20g), Water (200ml)</td>
            </tr>
            <tr>
                <td>Limpieza</td>
                <td>Batido Verde Reprobi√≥tico</td>
                <td>29</td>
                <td>14</td>
                <td>3</td>
                <td>360</td>
                <td>Hemp protein (30g), Coconut water kefir (200ml), Spinach (50g), Avocado (50g, sub for kiwi), Chia seeds (10g), Almond butter (10g), Green banana flour (10g), Cinnamon (1g), Turmeric (1g)</td>
            </tr>
            <tr>
                <td>Limpieza</td>
                <td>Jugo Verde y Ch√≠a Keto</td>
                <td>29</td>
                <td>14</td>
                <td>3</td>
                <td>360</td>
                <td>Spinach (80g), Cucumber (50g), Celery (50g), Ginger (2g), Lemon juice (10ml), Chia seeds (20g), Coconut milk (100ml), Inulin (5g), Collagen protein (30g), Walnuts (10g)</td>
            </tr>
            <tr>
                <td>Limpieza</td>
                <td>Batido Ultrafermentado</td>
                <td>30</td>
                <td>14</td>
                <td>3</td>
                <td>370</td>
                <td>Broccoli (50g), Spinach (100g), Cucumber (75g), Fermented mustard seeds (5g), Chia seeds (10g), Avocado (50g, sub for apple), Kombucha (250ml), Hemp protein (40g)</td>
            </tr>
            <tr>
                <td>Limpieza</td>
                <td>Tostadas Sin Granos</td>
                <td>29</td>
                <td>15</td>
                <td>3</td>
                <td>360</td>
                <td>Almond flour (30g), Psyllium husk (5g), Eggs (100g, 2 units), Avocado (70g), Tomato (50g), Sunflower seeds (15g), Coconut oil (15g), Ginger-lemon infusion (200ml)</td>
            </tr>
            <tr>
                <td>Limpieza</td>
                <td>Yogur Probi√≥tico Keto</td>
                <td>28</td>
                <td>14</td>
                <td>3</td>
                <td>350</td>
                <td>Coconut yogurt (150g), Blackberries (50g), Almonds (10g), Flax seeds (10g)</td>
            </tr>
            <tr>
                <td>Limpieza</td>
                <td>Barritas Sin Granos</td>
                <td>29</td>
                <td>14</td>
                <td>3</td>
                <td>360</td>
                <td>Hemp protein (40g), Almonds (20g), Green banana flour (20g), Chia seeds (10g), Egg whites (60g), Coconut oil (15g)</td>
            </tr>
            <tr>
                <td>Recetas</td>
                <td>Pan Suizo Keto</td>
                <td>16</td>
                <td>6</td>
                <td>3</td>
                <td>180</td>
                <td>Almond flour (150g), Coconut flour (50g), Baking powder (4g), Salt (3g), Eggs (250g, 5 units, separated yolks and whites), Olive oil or melted butter (74g), Unsweetened almond milk (80g), Apple cider vinegar (5g), Sesame or flax seeds (10g)</td>
            </tr>
			
			<!-- Modal para gr√°fico nutricional diario -->
				<!-- Modal para gr√°fico nutricional diario -->
					<div id="dailyNutritionModal" class="modal" style="display: none;">
                 
					  <div class="modal-content" style="max-width: 650px;">
         
						<h3 id="modalNutritionTitle">Informaci√≥n Nutricional del D√≠a</h3>
						<div id="nutritionChartContainer">
						  <canvas id="nutritionChart" width="400" height="400"></canvas>
						</div>
						
						<div id="ratioInfo" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
						  <p><strong>Ratio cetog√©nico total del d√≠a:</strong> <span id="dailyKetoRatio">0.00</span></p>
						  <p class="small muted">Ratio = gramos de grasa √∑ (gramos prote√≠na + gramos carbos netos)</p>
						  <div class="kpi" style="margin-top: 10px;">
							<span class="chip">Alto ‚â• 2.0</span>
							<span class="chip">Moderado 1.0‚Äì1.9</span>
							<span class="chip">Bajo &lt; 1.0</span>
						  </div>
						</div>
						
						<!-- Nueva secci√≥n de consejos nutricionales -->
						<div id="nutritionAdvice" style="margin-top: 20px; padding: 15px; background-color: #e9f5e9; border-radius: 8px; border-left: 4px solid #4CAF50;">
						  <h4 style="margin-top: 0; color: #2e7d32;">üîç An√°lisis Nutricional del D√≠a</h4>
						  <div id="adviceContent"></div>
						</div>
						
						<div style="margin-top: 20px; text-align: right;">
						  <button id="closeNutritionModal" class="btn secondary">Cerrar</button>
						</div>
					  </div>
					</div>
        </tbody>
    </table>
</section>
  </main>


  <div class="footer small">
    <div>üíæ Guardado autom√°tico en tu navegador (localStorage)</div>
    <div id="status" class="muted">Listo</div>
  </div>

  <script>
    // === Embedded food database (per 100 g) ===
    const FOOD_DB = [
  
  
  {
    "name": "Aceite de Coco",
    "fat_per_100g": 100,
    "protein_per_100g": 0,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 900
  },
  {
    "name": "Aceite de oliva",
    "fat_per_100g": 100,
    "protein_per_100g": 0,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 884
  },
  {
    "name": "Ajo",
    "fat_per_100g": 0.2,
    "protein_per_100g": 4.3,
    "netcarbs_per_100g": 23,
    "kcal_per_100g": 119
  },
  {
    "name": "Ajos fermentados",
    "fat_per_100g": 0.5,
    "protein_per_100g": 6.4,
    "netcarbs_per_100g": 14,
    "kcal_per_100g": 80
  },
  {
    "name": "Almendras",
    "fat_per_100g": 53,
    "protein_per_100g": 24,
    "netcarbs_per_100g": 9,
    "kcal_per_100g": 633
  },
  {
    "name": "Alitas de Pollo",
    "fat_per_100g": 5.4,
    "protein_per_100g": 21,
    "netcarbs_per_100g": 0.3,
    "kcal_per_100g": 133
  },
  {
    "name": "Apio",
    "fat_per_100g": 0.2,
    "protein_per_100g": 0.8,
    "netcarbs_per_100g": 1.4,
    "kcal_per_100g": 16
  },
  {
    "name": "Ar√°ndanos",
    "fat_per_100g": 0.3,
    "protein_per_100g": 0.8,
    "netcarbs_per_100g": 10,
    "kcal_per_100g": 57.7
  },
  {
    "name": "Arroz integral",
    "fat_per_100g": 0.9,
    "protein_per_100g": 2.6,
    "netcarbs_per_100g": 21.2,
    "kcal_per_100g": 123
  },
   {
    "name": "Arroz de coliflor",
    "fat_per_100g": 0.3,
    "protein_per_100g": 1.9,
    "netcarbs_per_100g": 3,
    "kcal_per_100g": 25
  },
  {
    "name": "Atun en la lata",
    "fat_per_100g": 1,
    "protein_per_100g": 25.5,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 116
  },
  {
    "name": "Copos de Avena",
    "fat_per_100g": 6.9,
    "protein_per_100g": 13.2,
    "netcarbs_per_100g": 58.2,
    "kcal_per_100g": 379
  },
  {
    "name": "Aguacate",
    "fat_per_100g": 14.7,
    "protein_per_100g": 2,
    "netcarbs_per_100g": 1.8,
    "kcal_per_100g": 160
  },
  {
    "name": "Bacon Ahumado",
    "fat_per_100g": 32,
    "protein_per_100g": 15,
    "netcarbs_per_100g": 1,
    "kcal_per_100g": 353
  },
  {
    "name": "Bacalao",
    "fat_per_100g": 1,
    "protein_per_100g": 17.7,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 80
  },
  {
    "name": "Berenjena",
    "fat_per_100g": 0.2,
    "protein_per_100g": 1,
    "netcarbs_per_100g": 2.9,
    "kcal_per_100g": 25
  },
  {
    "name": "Boniato",
    "fat_per_100g": 0.1,
    "protein_per_100g": 1.6,
    "netcarbs_per_100g": 17.1,
    "kcal_per_100g": 86
  },
  {
    "name": "Br√≥coli",
    "fat_per_100g": 0.4,
    "protein_per_100g": 2.8,
    "netcarbs_per_100g": 4,
    "kcal_per_100g": 35
  },
  {
    "name": "Burrata",
    "fat_per_100g": 16,
    "protein_per_100g": 11,
    "netcarbs_per_100g": 1.7,
    "kcal_per_100g": 195
  },
  {
    "name": "Caballa en lata",
    "fat_per_100g": 18,
    "protein_per_100g": 24,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 262
  },
  {
    "name": "Caballa",
    "fat_per_100g": 18,
    "protein_per_100g": 24,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 262
  },
  {
    "name": "Calabac√≠n",
    "fat_per_100g": 0.3,
    "protein_per_100g": 1.2,
    "netcarbs_per_100g": 2.1,
    "kcal_per_100g": 17
  },
  {
    "name": "Calabaza",
    "fat_per_100g": 0.1,
    "protein_per_100g": 1,
    "netcarbs_per_100g": 6.5,
    "kcal_per_100g": 26
  },
  {
    "name": "Caldo de Verduras Casero",
    "fat_per_100g": 0.1,
    "protein_per_100g": 0.5,
    "netcarbs_per_100g": 2,
    "kcal_per_100g": 12
  },
  {
    "name": "Canela en polvo",
    "fat_per_100g": 1.2,
    "protein_per_100g": 4,
    "netcarbs_per_100g": 27.5,
    "kcal_per_100g": 247
  },
  {
    "name": "Canonigos",
    "fat_per_100g": 0.4,
    "protein_per_100g": 2,
    "netcarbs_per_100g": 1.3,
    "kcal_per_100g": 21
  },
  {
    "name": "Entrecot",
    "fat_per_100g": 21.8,
    "protein_per_100g": 24,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 291
  },
  {
    "name": "Carne Picadade de Res",
    "fat_per_100g": 14,
    "protein_per_100g": 19,
    "netcarbs_per_100g": 0.5,
    "kcal_per_100g": 204
  },
  {
    "name": "Chuleta Aguja de Cerdo",
    "fat_per_100g": 12.5,
    "protein_per_100g": 18,
    "netcarbs_per_100g": 1,
    "kcal_per_100g": 189
  },
  {
    "name": "Chuleta de Cerdo",
    "fat_per_100g": 7.2,
    "protein_per_100g": 18,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 154
  },
  {
    "name": "Coliflor",
    "fat_per_100g": 0.3,
    "protein_per_100g": 1.9,
    "netcarbs_per_100g": 3,
    "kcal_per_100g": 25
  },
  {
    "name": "Champi√±ones",
    "fat_per_100g": 0.3,
    "protein_per_100g": 3.1,
    "netcarbs_per_100g": 3.3,
    "kcal_per_100g": 22
  },
  {
    "name": "Chia Seeds (Dry)",
    "fat_per_100g": 30.7,
    "protein_per_100g": 16.5,
    "netcarbs_per_100g": 7.7,
    "kcal_per_100g": 486
  },
  {
    "name": "Pechuga de Pollo",
    "fat_per_100g": 3.6,
    "protein_per_100g": 31,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 165
  },
  {
    "name": "Chistorra",
    "fat_per_100g": 35,
    "protein_per_100g": 14,
    "netcarbs_per_100g": 1,
    "kcal_per_100g": 400
  },
  {
    "name": "Chucrut",
    "fat_per_100g": 0.1,
    "protein_per_100g": 0.9,
    "netcarbs_per_100g": 1.8,
    "kcal_per_100g": 19
  },
  {
    "name": "Claras de Huevo Pasteurizadas",
    "fat_per_100g": 0.2,
    "protein_per_100g": 10.9,
    "netcarbs_per_100g": 0.7,
    "kcal_per_100g": 52
  },
  {
    "name": "Col lombarda",
    "fat_per_100g": 0.2,
    "protein_per_100g": 1.4,
    "netcarbs_per_100g": 5.3,
    "kcal_per_100g": 31
  },
  {
    "name": "Coliflor",
    "fat_per_100g": 0.3,
    "protein_per_100g": 1.9,
    "netcarbs_per_100g": 3,
    "kcal_per_100g": 25
  },
  {
    "name": "Conejo",
    "fat_per_100g": 3.5,
    "protein_per_100g": 33,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 173
  },
  {
    "name": "Crema de Almendras",
    "fat_per_100g": 13.2,
    "protein_per_100g": 4.6,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 341
  },
  {
    "name": "Crema de Cacauhete",
    "fat_per_100g": 49.2,
    "protein_per_100g": 22.2,
    "netcarbs_per_100g": 8.5,
    "kcal_per_100g": 588
  },
  {
    "name": "Crema de Coco",
    "fat_per_100g": 21,
    "protein_per_100g": 1.6,
    "netcarbs_per_100g": 4.8,
    "kcal_per_100g": 215
  },
  {
    "name": "Crema de leche (nata l√≠quida)",
    "fat_per_100g": 36,
    "protein_per_100g": 2.1,
    "netcarbs_per_100g": 2.8,
    "kcal_per_100g": 345
  },
  {
    "name": "Crema de queso",
    "fat_per_100g": 34.2,
    "protein_per_100g": 6.2,
    "netcarbs_per_100g": 4.1,
    "kcal_per_100g": 342
  },
  {
    "name": "C√∫rcuma",
    "fat_per_100g": 3.3,
    "protein_per_100g": 9.7,
    "netcarbs_per_100g": 44.4,
    "kcal_per_100g": 312
  },
  {
    "name": "Eneldo",
    "fat_per_100g": 1.1,
    "protein_per_100g": 3.5,
    "netcarbs_per_100g": 4,
    "kcal_per_100g": 43
  },
  {
    "name": "Esp√°rragos",
    "fat_per_100g": 0.1,
    "protein_per_100g": 2.2,
    "netcarbs_per_100g": 1.8,
    "kcal_per_100g": 20
  },
  {
    "name": "Espinacas frescas",
    "fat_per_100g": 0.4,
    "protein_per_100g": 2.9,
    "netcarbs_per_100g": 1.4,
    "kcal_per_100g": 23
  },
  {
    "name": "Frambuesas",
    "fat_per_100g": 0.7,
    "protein_per_100g": 1.2,
    "netcarbs_per_100g": 5.4,
    "kcal_per_100g": 52
  },
  {
    "name": "Fresas",
    "fat_per_100g": 0.3,
    "protein_per_100g": 0.7,
    "netcarbs_per_100g": 5.7,
    "kcal_per_100g": 32
  },
  {
    "name": "Gouda A√±ejo",
    "fat_per_100g": 27,
    "protein_per_100g": 24.9,
    "netcarbs_per_100g": 2.2,
    "kcal_per_100g": 356
  },
  {
    "name": "Harina de Almendras",
    "fat_per_100g": 52.5,
    "protein_per_100g": 21.4,
    "netcarbs_per_100g": 8.7,
    "kcal_per_100g": 571
  },
  {
    "name": "Harina de Coco",
    "fat_per_100g": 14,
    "protein_per_100g": 16,
    "netcarbs_per_100g": 24,
    "kcal_per_100g": 400
  },
  {
    "name": "Harina de Yuca",
    "fat_per_100g": 0.3,
    "protein_per_100g": 1.4,
    "netcarbs_per_100g": 80,
    "kcal_per_100g": 330
  },
 
  {
    "name": "Huevo",
    "fat_per_100g": 10.6,
    "protein_per_100g": 12.6,
    "netcarbs_per_100g": 0.6,
    "kcal_per_100g": 155
  },
  {
    "name": "Huevos camperos",
    "fat_per_100g": 9.7,
    "protein_per_100g": 13,
    "netcarbs_per_100g": 0.68,
    "kcal_per_100g": 155
  },
  
  {
    "name": "Hummus de Coliflor Casero",
    "fat_per_100g": 11.3,
    "protein_per_100g": 2.6,
    "netcarbs_per_100g": 3,
    "kcal_per_100g": 129
  },
  {
    "name": "Jengibre",
    "fat_per_100g": 0.8,
    "protein_per_100g": 1.8,
    "netcarbs_per_100g": 15.8,
    "kcal_per_100g": 80
  },
  {
    "name": "Judias Verde Fermentadas",
    "fat_per_100g": 0.2,
    "protein_per_100g": 1.8,
    "netcarbs_per_100g": 3.5,
    "kcal_per_100g": 25
  },
  {
    "name": "Jud√≠as verdes",
    "fat_per_100g": 0.2,
    "protein_per_100g": 1.8,
    "netcarbs_per_100g": 4.3,
    "kcal_per_100g": 31
  },
  {
    "name": "K√©fir de coco",
    "fat_per_100g": 27,
    "protein_per_100g": 3,
    "netcarbs_per_100g": 3.5,
    "kcal_per_100g": 280
  },
  {
    "name": "K√©fir natural",
    "fat_per_100g": 3.5,
    "protein_per_100g": 3.8,
    "netcarbs_per_100g": 4.5,
    "kcal_per_100g": 65
  },
  {
    "name": "Kiwis",
    "fat_per_100g": 0.5,
    "protein_per_100g": 1.1,
    "netcarbs_per_100g": 11.7,
    "kcal_per_100g": 61
  },
  {
    "name": "Leche de almendra",
    "fat_per_100g": 1,
    "protein_per_100g": 0.4,
    "netcarbs_per_100g": 0.4,
    "kcal_per_100g": 15
  },
  {
    "name": "Leche de Coco",
    "fat_per_100g": 17,
    "protein_per_100g": 0.5,
    "netcarbs_per_100g": 2.5,
    "kcal_per_100g": 165
  },
  {
    "name": "Lechuga",
    "fat_per_100g": 0.3,
    "protein_per_100g": 1.2,
    "netcarbs_per_100g": 1.2,
    "kcal_per_100g": 17
  },
  {
    "name": "Lentejas rojas",
    "fat_per_100g": 1.4,
    "protein_per_100g": 24,
    "netcarbs_per_100g": 8,
    "kcal_per_100g": 325
  },
  {
    "name": "Limon",
    "fat_per_100g": 0.3,
    "protein_per_100g": 1.1,
    "netcarbs_per_100g": 6.5,
    "kcal_per_100g": 29
  },
  {
    "name": "Mantequilla",
    "fat_per_100g": 81.1,
    "protein_per_100g": 0.9,
    "netcarbs_per_100g": 0.1,
    "kcal_per_100g": 717
  },
  {
    "name": "Mantequilla de Almendras",
    "fat_per_100g": 50,
    "protein_per_100g": 21,
    "netcarbs_per_100g": 9,
    "kcal_per_100g": 579
  },
  {
    "name": "Manzanas",
    "fat_per_100g": 0.2,
    "protein_per_100g": 0.3,
    "netcarbs_per_100g": 11.4,
    "kcal_per_100g": 52
  },
  {
    "name": "Manzanilla",
    "fat_per_100g": 0.2,
    "protein_per_100g": 0,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 0
  },
  {
    "name": "Mayonesa Casera",
    "fat_per_100g": 68.3,
    "protein_per_100g": 3.4,
    "netcarbs_per_100g": 0.5,
    "kcal_per_100g": 621
  },
  {
    "name": "Mayonesa Keto",
    "fat_per_100g": 68.3,
    "protein_per_100g": 3.4,
    "netcarbs_per_100g": 0.5,
    "kcal_per_100g": 621
  },
  {
    "name": "Melon Cantalupo",
    "fat_per_100g": 0.2,
    "protein_per_100g": 0.8,
    "netcarbs_per_100g": 7.9,
    "kcal_per_100g": 34
  },
  {
    "name": "Menta",
    "fat_per_100g": 0.9,
    "protein_per_100g": 3.8,
    "netcarbs_per_100g": 8,
    "kcal_per_100g": 70
  },
  {
    "name": "Merluza",
    "fat_per_100g": 1.8,
    "protein_per_100g": 24,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 112
  },
  {
    "name": "Moras",
    "fat_per_100g": 0.5,
    "protein_per_100g": 1.4,
    "netcarbs_per_100g": 4.3,
    "kcal_per_100g": 43
  },
  {
    "name": "Mostaza Dijon",
    "fat_per_100g": 11,
    "protein_per_100g": 7.2,
    "netcarbs_per_100g": 1.8,
    "kcal_per_100g": 149
  },
 
  {
    "name": "Mozzarella fresca",
    "fat_per_100g": 14,
    "protein_per_100g": 17,
    "netcarbs_per_100g": 2,
    "kcal_per_100g": 202
  },
  {
    "name": "Nata de Montar",
    "fat_per_100g": 35.1,
    "protein_per_100g": 2,
    "netcarbs_per_100g": 3.1,
    "kcal_per_100g": 336
  },
  {
    "name": "Nata Fresca",
    "fat_per_100g": 30,
    "protein_per_100g": 2.4,
    "netcarbs_per_100g": 1.9,
    "kcal_per_100g": 284
  },
  {
    "name": "Nueces",
    "fat_per_100g": 65,
    "protein_per_100g": 15,
    "netcarbs_per_100g": 7,
    "kcal_per_100g": 654
  },
  {
    "name": "Pan integral",
    "fat_per_100g": 2.5,
    "protein_per_100g": 6,
    "netcarbs_per_100g": 35,
    "kcal_per_100g": 200
  },
  {
    "name": "Pan Keto Suizo",
    "fat_per_100g": 29.1,
    "protein_per_100g": 12.1,
    "netcarbs_per_100g": 4.6,
    "kcal_per_100g": 333.4
  },
  {
    "name": "Panceta de Cerdo",
    "fat_per_100g": 26.5,
    "protein_per_100g": 16.7,
    "netcarbs_per_100g": 0.4,
    "kcal_per_100g": 400
  },
  {
    "name": "Queso Parmesano",
    "fat_per_100g": 28.6,
    "protein_per_100g": 35.8,
    "netcarbs_per_100g": 3.2,
    "kcal_per_100g": 392
  },
  {
    "name": "Pechuga Pavo",
    "fat_per_100g": 1,
    "protein_per_100g": 24,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 103
  },
  {
    "name": "Pechuga de pollo",
    "fat_per_100g": 3.6,
    "protein_per_100g": 31,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 165
  },
  {
    "name": "Pepino",
    "fat_per_100g": 0.1,
    "protein_per_100g": 0.7,
    "netcarbs_per_100g": 2.2,
    "kcal_per_100g": 15
  },
  {
    "name": "Pepinos fermentados",
    "fat_per_100g": 0.2,
    "protein_per_100g": 0.5,
    "netcarbs_per_100g": 1.2,
    "kcal_per_100g": 12
  },
  {
    "name": "Perejil",
    "fat_per_100g": 0.8,
    "protein_per_100g": 3,
    "netcarbs_per_100g": 3,
    "kcal_per_100g": 36
  },
  {
    "name": "Pimienta negra",
    "fat_per_100g": 3.3,
    "protein_per_100g": 10.4,
    "netcarbs_per_100g": 38.7,
    "kcal_per_100g": 251
  },
  {
    "name": "Pimientos Rojos",
    "fat_per_100g": 0.2,
    "protein_per_100g": 1,
    "netcarbs_per_100g": 4.6,
    "kcal_per_100g": 26
  },
  {
    "name": "Pimientos Amarillos fermentados",
    "fat_per_100g": 0.2,
    "protein_per_100g": 1,
    "netcarbs_per_100g": 4,
    "kcal_per_100g": 27
  },
  {
    "name": "Pl√°tano Verde",
    "fat_per_100g": 0.3,
    "protein_per_100g": 1.1,
    "netcarbs_per_100g": 20,
    "kcal_per_100g": 89
  },
  {
    "name": "Puerro",
    "fat_per_100g": 0.3,
    "protein_per_100g": 1.5,
    "netcarbs_per_100g": 12.4,
    "kcal_per_100g": 61
  },
  {
    "name": "Queso Azul",
    "fat_per_100g": 22,
    "protein_per_100g": 22,
    "netcarbs_per_100g": 2.5,
    "kcal_per_100g": 300
  },
  {
    "name": "Queso Brie",
    "fat_per_100g": 31,
    "protein_per_100g": 17,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 347
  },
  {
    "name": "Queso Camembert",
    "fat_per_100g": 24.3,
    "protein_per_100g": 19.8,
    "netcarbs_per_100g": 0.5,
    "kcal_per_100g": 300
  },
  {
    "name": "Queso Cheddar",
    "fat_per_100g": 33.3,
    "protein_per_100g": 22.9,
    "netcarbs_per_100g": 3.1,
    "kcal_per_100g": 403
  },
  {
    "name": "Queso Roquefort",
    "fat_per_100g": 32,
    "protein_per_100g": 19,
    "netcarbs_per_100g": 0.5,
    "kcal_per_100g": 364
  },
  {
    "name": "Queso Edam semicurado",
    "fat_per_100g": 27,
    "protein_per_100g": 29,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 357
  },
  {
    "name": "Quinoa",
    "fat_per_100g": 1.9,
    "protein_per_100g": 4.4,
    "netcarbs_per_100g": 18.5,
    "kcal_per_100g": 120
  },
  {
    "name": "Rabano",
    "fat_per_100g": 0.1,
    "protein_per_100g": 0.7,
    "netcarbs_per_100g": 1.8,
    "kcal_per_100g": 16
  },
  {
    "name": "Repollo hoja verde",
    "fat_per_100g": 0.1,
    "protein_per_100g": 1.3,
    "netcarbs_per_100g": 3.2,
    "kcal_per_100g": 25
  },
  {
    "name": "Romero",
    "fat_per_100g": 5.9,
    "protein_per_100g": 3.3,
    "netcarbs_per_100g": 14.1,
    "kcal_per_100g": 131
  },
  {
    "name": "R√∫cula",
    "fat_per_100g": 0.7,
    "protein_per_100g": 2.6,
    "netcarbs_per_100g": 2.1,
    "kcal_per_100g": 25
  },
  {
    "name": "Queso de cabra",
    "fat_per_100g": 29.2,
    "protein_per_100g": 17,
    "netcarbs_per_100g": 1.1,
    "kcal_per_100g": 335
  },
  {
    "name": "Salmon Ahumado",
    "fat_per_100g": 7,
    "protein_per_100g": 20,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 145
  },
  {
    "name": "Salmon fresco",
    "fat_per_100g": 13,
    "protein_per_100g": 25,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 206
  },
  {
    "name": "Salmon Salvaje",
    "fat_per_100g": 6.3,
    "protein_per_100g": 25.4,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 182
  },
  {
    "name": "Salsa Cesar",
    "fat_per_100g": 70.3,
    "protein_per_100g": 4.4,
    "netcarbs_per_100g": 1.9,
    "kcal_per_100g": 647.6
  },
  {
    "name": "Salsa Pesto",
    "fat_per_100g": 57,
    "protein_per_100g": 4.9,
    "netcarbs_per_100g": 6.2,
    "kcal_per_100g": 560
  },
  {
    "name": "Sardina Marinada",
    "fat_per_100g": 30.4,
    "protein_per_100g": 17.7,
    "netcarbs_per_100g": 0.1,
    "kcal_per_100g": 245
  },
  {
    "name": "Sardinas en lata con aceite de oliva",
    "fat_per_100g": 11,
    "protein_per_100g": 25,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 208
  },
  {
    "name": "Semillas de calabaza",
    "fat_per_100g": 49,
    "protein_per_100g": 29.8,
    "netcarbs_per_100g": 4.7,
    "kcal_per_100g": 574
  },
  {
    "name": "Semillas de ch√≠a",
    "fat_per_100g": 30.7,
    "protein_per_100g": 16.5,
    "netcarbs_per_100g": 7.7,
    "kcal_per_100g": 486
  },
   {
    "name": "Semillas de hinojo",
    "fat_per_100g": 14.9,
    "protein_per_100g": 15.8,
    "netcarbs_per_100g": 36.3,
    "kcal_per_100g": 345
  },
  {
    "name": "Semillas de lino",
    "fat_per_100g": 42.2,
    "protein_per_100g": 18.3,
    "netcarbs_per_100g": 1.6,
    "kcal_per_100g": 534
  },
  {
    "name": "Semillas de Mostaza",
    "fat_per_100g": 36.2,
    "protein_per_100g": 26.1,
    "netcarbs_per_100g": 15.9,
    "kcal_per_100g": 508
  },
  {
    "name": "Semillas de s√©samo",
    "fat_per_100g": 49.6,
    "protein_per_100g": 17.7,
    "netcarbs_per_100g": 11.7,
    "kcal_per_100g": 573
  },
  {
    "name": "Semillas Girasol",
    "fat_per_100g": 56.8,
    "protein_per_100g": 17.3,
    "netcarbs_per_100g": 12.2,
    "kcal_per_100g": 652
  },
  {
    "name": "Spirulina",
    "fat_per_100g": 7.7,
    "protein_per_100g": 57.5,
    "netcarbs_per_100g": 20.3,
    "kcal_per_100g": 290
  },
  {
    "name": "Tah√≠ni Casero",
    "fat_per_100g": 58,
    "protein_per_100g": 14.6,
    "netcarbs_per_100g": 9.6,
    "kcal_per_100g": 625
  },
  {
    "name": "T√© Matcha Verde",
    "fat_per_100g": 5.3,
    "protein_per_100g": 30.6,
    "netcarbs_per_100g": 34.7,
    "kcal_per_100g": 324
  },
  {
    "name": "T√© verde",
    "fat_per_100g": 0,
    "protein_per_100g": 0,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 0
  },
  {
    "name": "Tomates cherry",
    "fat_per_100g": 0.2,
    "protein_per_100g": 0.9,
    "netcarbs_per_100g": 2.7,
    "kcal_per_100g": 18
  },
  {
    "name": "Tomates Cherry Fermentados",
    "fat_per_100g": 0.2,
    "protein_per_100g": 0.9,
    "netcarbs_per_100g": 2,
    "kcal_per_100g": 16
  },
  {
    "name": "Tomillo",
    "fat_per_100g": 1.7,
    "protein_per_100g": 9.1,
    "netcarbs_per_100g": 26.1,
    "kcal_per_100g": 276
  },
  {
    "name": "Agua",
    "fat_per_100g": 0,
    "protein_per_100g": 0,
    "netcarbs_per_100g": 0,
    "kcal_per_100g": 0
  },
  {
    "name": "Whey Proteina",
    "fat_per_100g": 5.8,
    "protein_per_100g": 73.3,
    "netcarbs_per_100g": 5.4,
    "kcal_per_100g": 371
  },
  {
    "name": "Yogout de Leche Coco fermentado",
    "fat_per_100g": 20,
    "protein_per_100g": 2.5,
    "netcarbs_per_100g": 3,
    "kcal_per_100g": 200
  },
  {
    "name": "Yogur natural con probi√≥ticos",
    "fat_per_100g": 3.3,
    "protein_per_100g": 3.5,
    "netcarbs_per_100g": 4.7,
    "kcal_per_100g": 61
  },
  {
    "name": "Zanahorias fermentadas",
    "fat_per_100g": 0.2,
    "protein_per_100g": 0.9,
    "netcarbs_per_100g": 4,
    "kcal_per_100g": 25
  },
  {
    "name": "Zanahorias",
    "fat_per_100g": 0.2,
    "protein_per_100g": 0.9,
    "netcarbs_per_100g": 6.8,
    "kcal_per_100g": 41
  },
  {
    "name": "Zumo de Limon",
    "fat_per_100g": 0.2,
    "protein_per_100g": 0.4,
    "netcarbs_per_100g": 6.5,
    "kcal_per_100g": 24
  }

];

// Render database table and food select
function renderDB() {
  const tbody = document.querySelector("#dbTable tbody");
  tbody.innerHTML = "";
  FOOD_DB.forEach(f => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${f.name}</td>
      <td class="right">${f.fat_per_100g.toFixed(1)}</td>
      <td class="right">${f.protein_per_100g.toFixed(1)}</td>
      <td class="right">${f.netcarbs_per_100g.toFixed(1)}</td>
      <td class="right">${f.kcal_per_100g.toFixed(1)}</td>
    `;
    tbody.appendChild(tr);
  });

  const sel = document.getElementById("foodSelect");
  sel.innerHTML = "";
  FOOD_DB.forEach((f, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = f.name;
    sel.appendChild(opt);
  });
}

// Abrir modal
document.getElementById("addFoodBtn").addEventListener("click", () => {
  document.getElementById("addFoodModal").style.display = "flex";
  document.getElementById("foodName").focus();
});

// Cerrar modal
document.getElementById("cancelAddFoodBtn").addEventListener("click", () => {
  document.getElementById("addFoodModal").style.display = "none";
  document.getElementById("addFoodForm").reset();
});

// Enviar formulario
document.getElementById("addFoodForm").addEventListener("submit", (event) => {
  event.preventDefault();
  try {
    const form = event.target;
    const newFood = {
      name: form.name.value.trim(),
      fat_per_100g: parseFloat(form.fat_per_100g.value),
      protein_per_100g: parseFloat(form.protein_per_100g.value),
      netcarbs_per_100g: parseFloat(form.netcarbs_per_100g.value),
      kcal_per_100g: parseFloat(form.kcal_per_100g.value)
    };

    // Validaciones
    if (!newFood.name) throw new Error("El nombre es obligatorio.");
    if (isNaN(newFood.fat_per_100g) || newFood.fat_per_100g < 0) throw new Error("Grasa inv√°lida.");
    if (isNaN(newFood.protein_per_100g) || newFood.protein_per_100g < 0) throw new Error("Prote√≠na inv√°lida.");
    if (isNaN(newFood.netcarbs_per_100g) || newFood.netcarbs_per_100g < 0) throw new Error("Carbohidratos inv√°lidos.");
    if (isNaN(newFood.kcal_per_100g) || newFood.kcal_per_100g < 0) throw new Error("Calor√≠as inv√°lidas.");

    // Evitar duplicados
    if (FOOD_DB.some(f => f.name.toLowerCase() === newFood.name.toLowerCase())) {
      throw new Error("Ya existe un alimento con ese nombre.");
    }

    // A√±adir alimento
    FOOD_DB.push(newFood);
    renderDB();
    form.reset();
    document.getElementById("addFoodModal").style.display = "none";
    alert("Alimento a√±adido con √©xito.");
  } catch (err) {
    alert(err.message);
  }
});



// Importar Plan Semanal desde JSON (con botones eliminar)
// === State ===
let recipe = JSON.parse(localStorage.getItem('keto_recipe') || '[]');
let weeklyPlan = JSON.parse(localStorage.getItem('keto_weekly_plan') || '{}');
const DAYS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
const TIMES = ['Desayuno', 'Almuerzo', 'Cena', 'Snack'];

// Initialize weeklyPlan if empty or invalid
if (!weeklyPlan || Object.keys(weeklyPlan).length === 0) {
  weeklyPlan = {
    "Lunes": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
    "Martes": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
    "Mi√©rcoles": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
    "Jueves": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
    "Viernes": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
    "S√°bado": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
    "Domingo": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] }
  };
  localStorage.setItem('keto_weekly_plan', JSON.stringify(weeklyPlan));
}
// Funci√≥n para calcular totales desde ingredientes (√Åmbito de DOMContentLoaded)
  // Importar Plan Semanal desde JSON (con botones eliminar)
document.getElementById("importtWeeklyPlanBtn").addEventListener("click", () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".json";

  input.onchange = (event) => {
    const file = event.target.files[0];
    if (!file) {
      alert("Por favor, selecciona un archivo JSON.");
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedPlan = JSON.parse(e.target.result);
        if (!importedPlan || typeof importedPlan !== "object") {
          throw new Error("El archivo JSON no tiene el formato esperado.");
        }

        // Preguntar al usuario antes de resetear el Plan Semanal
        const userConfirmed = confirm(
          "‚ö†Ô∏è ADVERTENCIA IMPORTANTE ‚ö†Ô∏è\n\n" +
          "¬øEst√°s seguro de que deseas importar un nuevo Plan Semanal?\n\n" +
          "ESTA ACCI√ìN BORRAR√Å COMPLETAMENTE el Plan Semanal actual y TODAS sus recetas.\n" +
          "Los datos se perder√°n permanentemente si no los has guardado/exportado.\n\n" +
          "Haz clic en 'Aceptar' para continuar con la importaci√≥n\n" +
          "Haz clic en 'Cancelar' para conservar los datos actuales"
        );

        if (!userConfirmed) {
          alert("Importaci√≥n cancelada. Los datos actuales se conservan.");
          return; // Salir de la funci√≥n sin hacer nada
        }

        // Reset weeklyPlan
        weeklyPlan = {
          "Lunes": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
          "Martes": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
          "Mi√©rcoles": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
          "Jueves": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
          "Viernes": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
          "S√°bado": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
          "Domingo": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] }
        };

        // Funci√≥n para normalizar claves de comidas
        const normalizeMealKey = (meal) => {
          const mealLower = meal.toLowerCase();
          if (mealLower.includes('desayuno')) return 'Desayuno';
          if (mealLower.includes('almuerzo')) return 'Almuerzo';
          if (mealLower.includes('cena')) return 'Cena';
          if (mealLower.includes('snack') || mealLower.includes('sanak')) return 'Snack';
          return meal; // Default to original if no match
        };

        // Funci√≥n para buscar una receta en la tabla de recetas
        const findRecipeInTable = (recipeName, mealType) => {
          const normalizedRecipeName = recipeName.trim().toLowerCase();
          const accordionTabs = document.querySelectorAll('#recipesAccordion .accordion-content');

          for (const tab of accordionTabs) {
            const tabMealType = tab.getAttribute('data-meal-type');
            if (tabMealType === mealType) {
              const rows = tab.querySelectorAll('tbody tr');
              for (const row of rows) {
                const nameCell = row.cells[1];
                if (nameCell && nameCell.textContent.trim().toLowerCase() === normalizedRecipeName) {
                  return {
                    fat: parseFloat(row.cells[2].textContent.replace(/[^\d.-]/g, '')) || 0,
                    protein: parseFloat(row.cells[3].textContent.replace(/[^\d.-]/g, '')) || 0,
                    carbs: parseFloat(row.cells[4].textContent.replace(/[^\d.-]/g, '')) || 0,
                    kcal: parseFloat(row.cells[5].textContent.replace(/[^\d.-]/g, '')) || 0,
                    ingredients: row.cells[6].textContent.trim()
                  };
                }
              }
            }
          }

          const allRows = document.querySelectorAll('#recipesAccordion .accordion-content tbody tr');
          for (const row of allRows) {
            const nameCell = row.cells[1];
            if (nameCell && nameCell.textContent.trim().toLowerCase() === normalizedRecipeName) {
              return {
                fat: parseFloat(row.cells[2].textContent.replace(/[^\d.-]/g, '')) || 0,
                protein: parseFloat(row.cells[3].textContent.replace(/[^\d.-]/g, '')) || 0,
                carbs: parseFloat(row.cells[4].textContent.replace(/[^\d.-]/g, '')) || 0,
                kcal: parseFloat(row.cells[5].textContent.replace(/[^\d.-]/g, '')) || 0,
                ingredients: row.cells[6].textContent.trim()
              };
            }
          }

          return null;
        };

        // Funci√≥n para calcular totales desde ingredientes
        const calculateTotalsFromIngredients = (ingredients) => {
          if (!ingredients || !Array.isArray(ingredients)) {
            return { fat: 0, protein: 0, carbs: 0, kcal: 0 };
          }
          return ingredients.reduce((acc, ing) => {
            acc.fat += Number(ing.fat) || 0;
            acc.protein += Number(ing.protein) || 0;
            acc.carbs += Number(ing.carbs) || 0;
            acc.kcal += Number(ing.kcal) || 0;
            return acc;
          }, { fat: 0, protein: 0, carbs: 0, kcal: 0 });
        };

        // Funci√≥n para extraer datos nutricionales de displayName
        const parseDisplayName = (displayName) => {
          const match = displayName.match(/\((\d+)Kcal : (\d+)%G:(\d+)%PT:(\d+)%HC: Ratio:([\d.]+)\)/);
          if (match) {
            const kcal = parseFloat(match[1]);
            const fatPct = parseFloat(match[2]);
            const proteinPct = parseFloat(match[3]);
            const carbsPct = parseFloat(match[4]);
            // Calcular gramos a partir de porcentajes y kcal
            const fat = (fatPct / 100) * kcal / 9;
            const protein = (proteinPct / 100) * kcal / 4;
            const carbs = (carbsPct / 100) * kcal / 4;
            return { fat, protein, carbs, kcal };
          }
          return null;
        };

        // Funci√≥n para generar displayName
        const generateDisplayName = (recipe, mealType) => {
          let totals = { fat: 0, protein: 0, carbs: 0, kcal: 0 };
          const recipeData = findRecipeInTable(recipe.name, mealType);

          if (recipeData) {
            totals = {
              fat: recipeData.fat,
              protein: recipeData.protein,
              carbs: recipeData.carbs,
              kcal: recipeData.kcal
            };
          } else if (recipe.displayName) {
            const parsed = parseDisplayName(recipe.displayName);
            if (parsed) {
              totals = parsed;
            } else if (recipe.recipe) {
              totals = calculateTotalsFromIngredients(recipe.recipe);
            }
          } else if (recipe.totals) {
            totals = recipe.totals;
          } else if (recipe.recipe) {
            totals = calculateTotalsFromIngredients(recipe.recipe);
          }

          if (totals.kcal === 0) {
            console.warn(`No se encontraron datos nutricionales v√°lidos para ${recipe.name}`);
            return `<strong>${recipe.name} (Sin datos nutricionales)</strong>`;
          }

          const fatPercentage = totals.kcal > 0 ? Math.round((totals.fat * 9 / totals.kcal) * 100) : 0;
          const proteinPercentage = totals.kcal > 0 ? Math.round((totals.protein * 4 / totals.kcal) * 100) : 0;
          const carbsPercentage = totals.kcal > 0 ? Math.round((totals.carbs * 4 / totals.kcal) * 100) : 0;
          const ketoRatio = (totals.protein + totals.carbs) > 0 
            ? (totals.fat / (totals.protein + totals.carbs)).toFixed(1)
            : 0;

          const nutritionInfo = `<strong>${recipe.name} (${Math.round(totals.kcal)}Kcal : ${fatPercentage}%G:${proteinPercentage}%PT:${carbsPercentage}%HC: Ratio:${ketoRatio})</strong>`;
          let ingredientsStr = '';
          if (recipeData && recipeData.ingredients) {
            ingredientsStr = ` (${recipeData.ingredients})`;
          } else if (recipe.recipe && recipe.recipe.length > 0) {
            ingredientsStr = ` (${recipe.recipe.map(ing => `${ing.name} ${formatNumber(ing.grams)}gr`).join(', ')})`;
          } else if (recipe.displayName) {
            const match = recipe.displayName.match(/\(([^)]+)\)$/);
            if (match) ingredientsStr = ` (${match[1]})`;
          }

          return `${nutritionInfo}${ingredientsStr}`;
        };

        const formatNumber = (x) => {
          return (Math.round((x + Number.EPSILON) * 100) / 100).toFixed(1);
        };

        // Actualizar weeklyPlan y UI
        DAYS.forEach(day => {
          let dayTotalKcal = 0;

          const dayPlan = importedPlan[day] || {};
          TIMES.forEach(meal => {
            const normalizedMeal = Object.keys(dayPlan).find(key => normalizeMealKey(key) === meal) || meal;
            const cell = document.getElementById(`${day}-${meal}`);
            if (cell) cell.innerHTML = "";

            if (dayPlan[normalizedMeal]) {
              weeklyPlan[day][meal] = [];
              dayPlan[normalizedMeal].forEach((r, index) => {
                const recipeData = findRecipeInTable(r.name, meal);
                let totals = { fat: 0, protein: 0, carbs: 0, kcal: 0 };
                if (recipeData) {
                  totals = {
                    fat: recipeData.fat,
                    protein: recipeData.protein,
                    carbs: recipeData.carbs,
                    kcal: recipeData.kcal
                  };
                } else if (r.displayName) {
                  const parsed = parseDisplayName(r.displayName);
                  if (parsed) {
                    totals = parsed;
                  } else if (r.recipe) {
                    totals = calculateTotalsFromIngredients(r.recipe);
                  }
                } else if (r.totals) {
                  totals = r.totals;
                } else if (r.recipe) {
                  totals = calculateTotalsFromIngredients(r.recipe);
                }

                if (totals.kcal > 0) {
                  // --- MODIFICACI√ìN: Crear objeto con todas las propiedades del JSON ---
                  // Creamos el objeto base con name y recipe
                  const recipeEntryForWeeklyPlan = {
                    name: r.name,
                    recipe: r.recipe || [{
                      fat: totals.fat,
                      protein: totals.protein,
                      carbs: totals.carbs,
                      kcal: totals.kcal,
                      name: r.name,
                      grams: 100
                    }]
                  };

                  // Si el JSON original ten√≠a displayName, lo copiamos
                  if (r.displayName !== undefined) {
                    recipeEntryForWeeklyPlan.displayName = r.displayName;
                  }
                  // Si el JSON original ten√≠a totals, lo copiamos
                  if (r.totals !== undefined) {
                    recipeEntryForWeeklyPlan.totals = r.totals;
                  }
                  // --- FIN MODIFICACI√ìN ---

                  // A√±adir el objeto completo al weeklyPlan
                  weeklyPlan[day][meal].push(recipeEntryForWeeklyPlan);

                  // generateDisplayName ahora deber√≠a usar el objeto completo
                  const displayName = generateDisplayName(recipeEntryForWeeklyPlan, meal);
                  const div = document.createElement("div");
                  div.style.display = "flex";
                  div.style.justifyContent = "space-between";
                  div.style.alignItems = "center";
                  div.style.marginBottom = "4px";

                  const span = document.createElement("span");
                  span.innerHTML = displayName;

                  const btn = document.createElement("button");
                  btn.textContent = "‚ùå";
                  btn.style.marginLeft = "8px";
                  btn.className = "btn danger";
                  btn.style.padding = "2px 6px";
                  btn.style.fontSize = "0.8em";

                  btn.addEventListener("click", () => {
                    weeklyPlan[day][meal].splice(index, 1);
                    renderImportedMeal(day, meal, weeklyPlan);
                    recalcDayKcal(day, weeklyPlan);
                    localStorage.setItem('keto_weekly_plan', JSON.stringify(weeklyPlan));
                  });

                  div.appendChild(span);
                  div.appendChild(btn);
                  if (cell) cell.appendChild(div);

                  dayTotalKcal += totals.kcal;
                } else {
                  console.warn(`Receta inv√°lida en ${day} - ${meal}: ${r.name || 'sin nombre'} (kcal: ${totals.kcal})`);
                }
              });
            }
          });

          const kcalCell = document.getElementById(`${day}-Kcal`);
          if (kcalCell) {
            kcalCell.textContent = dayTotalKcal > 0 ? Math.round(dayTotalKcal) : "";
          }
        });

        // Guardar en localStorage
        localStorage.setItem('keto_weekly_plan', JSON.stringify(weeklyPlan));
        alert("‚úÖ Plan semanal importado con √©xito.");
      } catch (err) {
        console.error("Error al importar plan:", err);
        alert("‚ùå Error al importar el plan: " + err.message);
      }
    };
    reader.readAsText(file);
  };

  input.click();
});

//Funcion Normalizadora de de datos Tabla Plan Semanal
function normalizeRecipe(recipe) {
  return recipe.map(item => {
    // Buscar ingrediente en la base de datos
    const base = keto_recipe.find(i => 
      i.name.toLowerCase() === item.name.toLowerCase()
    );

    if (!base) {
      // Si no est√° en la DB, devolvemos tal cual
      return item;
    }

    // Factor de gramos
    const factor = item.grams / 100;

    return {
      name: base.name,
      grams: item.grams,
      fat: +(base.fat * factor).toFixed(2),
      protein: +(base.protein * factor).toFixed(2),
      carbs: +(base.carbs * factor).toFixed(2),
      kcal: +(base.kcal * factor).toFixed(2),
    };
  });
}


// Funci√≥n auxiliar para re-renderizar una comida despu√©s de eliminar
// Re-renderizar una celda de comida
function renderImportedMeal(day, meal, plan) {
  const cell = document.getElementById(`${day}-${meal}`);
  if (cell) cell.innerHTML = "";
  if (plan[day] && plan[day][meal]) {
    plan[day][meal].forEach((r, index) => {
      const displayName = generateDisplayName(r, meal);
      const div = document.createElement("div");
      div.style.display = "flex";
      div.style.justifyContent = "space-between";
      div.style.alignItems = "center";
      div.style.marginBottom = "4px";

      const span = document.createElement("span");
      span.innerHTML = displayName;

      const btn = document.createElement("button");
      btn.textContent = "‚ùå";
      btn.style.marginLeft = "8px";
      btn.className = "btn danger";
      btn.style.padding = "2px 6px";
      btn.style.fontSize = "0.8em";

      btn.addEventListener("click", () => {
        weeklyPlan[day][meal].splice(index, 1);
        renderImportedMeal(day, meal, weeklyPlan);
        recalcDayKcal(day, weeklyPlan);
        localStorage.setItem('keto_weekly_plan', JSON.stringify(weeklyPlan));
      });

      div.appendChild(span);
      div.appendChild(btn);
      if (cell) cell.appendChild(div);
    });
  }
}

// Funci√≥n para generar displayName con formato correcto (tambi√©n necesaria para renderImportedMeal)
function generateDisplayName(recipe) {
  if (recipe.displayName && recipe.displayName.includes('<strong>')) {
    return recipe.displayName; // Ya tiene el formato correcto
  }
  
  // Calcular totales nutricionales
  const totals = recipe.recipe.reduce((acc, r) => ({
    fat: acc.fat + (r.fat || 0),
    protein: acc.protein + (r.protein || 0),
    carbs: acc.carbs + (r.carbs || 0),
    kcal: acc.kcal + (r.kcal || 0)
  }), { fat: 0, protein: 0, carbs: 0, kcal: 0 });

  // Calcular porcentajes
  const fatPercentage = totals.kcal > 0 ? Math.round((totals.fat * 9 / totals.kcal) * 100) : 0;
  const proteinPercentage = totals.kcal > 0 ? Math.round((totals.protein * 4 / totals.kcal) * 100) : 0;
  const carbsPercentage = totals.kcal > 0 ? Math.round((totals.carbs * 4 / totals.kcal) * 100) : 0;
  
  // Calcular ratio cetog√©nico
  const ketoRatio = (totals.protein + totals.carbs) > 0 
    ? (totals.fat / (totals.protein + totals.carbs)).toFixed(1)
    : 0;

  // Crear string de informaci√≥n nutricional en negrita
  const nutritionInfo = `<strong>${recipe.name} (${Math.round(totals.kcal)}Kcal : ${fatPercentage}%G:${proteinPercentage}%PT:${carbsPercentage}%HC: Ratio:${ketoRatio})</strong>`;
  
  // Crear string de ingredientes
  const ingredientsStr = recipe.recipe && recipe.recipe.length > 0 
    ? ` (${recipe.recipe.map(ing => `${ing.name} ${fmt(ing.grams)}gr`).join(', ')})`
    : '';

  return `${nutritionInfo}${ingredientsStr}`;
}



// --- Funci√≥n auxiliar para recalcular kcal de un d√≠a ---
// Recalcular kcal totales de un d√≠a
function recalcDayKcal(day, plan) {
  let dayTotalKcal = 0;
  const meals = ["Desayuno", "Almuerzo", "Cena", "Snack"];
  meals.forEach(meal => {
    if (plan[day] && plan[day][meal]) {
      plan[day][meal].forEach(r => {
        const recipeData = findRecipeInTable(r.name, meal);
        let totals = { fat: 0, protein: 0, carbs: 0, kcal: 0 };
        if (recipeData) {
          totals = {
            fat: recipeData.fat,
            protein: recipeData.protein,
            carbs: recipeData.carbs,
            kcal: recipeData.kcal
          };
        } else if (r.displayName) {
          const parsed = parseDisplayName(r.displayName);
          if (parsed) {
            totals = parsed;
          } else if (r.recipe) {
            totals = calculateTotalsFromIngredients(r.recipe);
          }
        } else if (r.totals) {
          totals = r.totals;
        } else if (r.recipe) {
          totals = calculateTotalsFromIngredients(r.recipe);
        }
        dayTotalKcal += totals.kcal || 0;
      });
    }
  });
  const kcalCell = document.getElementById(`${day}-Kcal`);
  if (kcalCell) {
    kcalCell.textContent = dayTotalKcal > 0 ? Math.round(dayTotalKcal) : "";
  }
}

// Funci√≥n para calcular la informaci√≥n nutricional de un d√≠a
function calculateDailyNutrition(day) {
  let totalFat = 0;
  let totalProtein = 0;
  let totalCarbs = 0;
  let totalKcal = 0;

  const meals = ["Desayuno", "Almuerzo", "Cena", "Snack"];
  meals.forEach(meal => {
    if (weeklyPlan[day] && weeklyPlan[day][meal]) {
      weeklyPlan[day][meal].forEach(recipe => {
        if (recipe.recipe) {
          recipe.recipe.forEach(ingredient => {
            totalFat += Number(ingredient.fat) || 0;
            totalProtein += Number(ingredient.protein) || 0;
            totalCarbs += Number(ingredient.carbs) || 0;
            totalKcal += Number(ingredient.kcal) || 0;
          });
        }
      });
    }
  });

  const ketoRatio = (totalProtein + totalCarbs) > 0 
    ? totalFat / (totalProtein + totalCarbs) 
    : 0;

  return {
    fat: totalFat,
    protein: totalProtein,
    carbs: totalCarbs,
    kcal: totalKcal,
    ketoRatio: ketoRatio
  };
}


// Doble click en filas de Recetas ‚Üí preguntar d√≠a y a√±adir al Plan Semanal.
// Reemplazar el event listener de doble clic en el acorde√≥n
// Reemplazar el event listener de doble clic en el acorde√≥n
document.addEventListener('DOMContentLoaded', () => {
  const container = document.querySelector('#recipesAccordion');
  if (!container) {
    console.error('No se encontr√≥ #recipesAccordion');
    return;
  }

  container.addEventListener('dblclick', (ev) => {
    const row = ev.target.closest('tbody tr');
    if (!row || !container.contains(row)) return;

    // Obtener TODOS los datos directamente de las celdas de la tabla
    const cells = row.querySelectorAll('td');
    if (cells.length < 7) {
      alert('No se pudieron leer todos los datos de la receta.');
      return;
    }

    // CORREGIR √çNDICES: La columna "Nombre" es la segunda (√≠ndice 1)
    const mealType = (cells[0]?.textContent || '').trim();  // √çndice 0: Tipo de comida
    const name = (cells[1]?.textContent || '').trim();      // √çndice 1: Nombre (segunda columna)
    const fat = parseFloat((cells[2]?.textContent || '0').replace(',', '.'));      // √çndice 2: Grasas
    const protein = parseFloat((cells[3]?.textContent || '0').replace(',', '.'));  // √çndice 3: Prote√≠nas
    const carbs = parseFloat((cells[4]?.textContent || '0').replace(',', '.'));    // √çndice 4: Carbohidratos
    const kcal = parseFloat((cells[5]?.textContent || '0').replace(',', '.'));     // √çndice 5: Kcal
    const ingredientsStr = (cells[6]?.textContent || '').trim();                   // √çndice 6: Ingredientes

    

    // Validar que los valores num√©ricos sean correctos
    if (isNaN(fat) || isNaN(protein) || isNaN(carbs) || isNaN(kcal)) {
      alert('Error: Los valores nutricionales no son v√°lidos.');
      return;
    }

	// --- MODIFICACI√ìN: Solicitar d√≠a y verificar recetas existentes ---
  const day = prompt('¬øEn qu√© d√≠a de la semana quieres colocarla?\nLunes, Martes, Mi√©rcoles, Jueves, Viernes, S√°bado, Domingo:');
  if (!day || !DAYS.includes(day)) {
    alert('D√≠a no v√°lido.');
    return;
  }

  // Verificar y manejar recetas existentes
  const checkResult = checkAndHandleExistingRecipes(day, mealType);
  if (!checkResult.proceedToAdd) {
    return; // Salir si el usuario cancel√≥
  }
  // Si checkResult.shouldReplace es true, weeklyPlan[day][mealType] ya est√° vac√≠o
  // Si es false, se a√±adir√° al final del array existente
  // --- FIN MODIFICACI√ìN ---


    // Calcular porcentajes y ratio (desde los valores de la tabla)
    const fatPercentage = kcal > 0 ? Math.round((fat * 9 / kcal) * 100) : 0;
    const proteinPercentage = kcal > 0 ? Math.round((protein * 4 / kcal) * 100) : 0;
    const carbsPercentage = kcal > 0 ? Math.round((carbs * 4 / kcal) * 100) : 0;
    const ketoRatio = (protein + carbs) > 0 ? (fat / (protein + carbs)).toFixed(1) : 0;

    // Crear el objeto de receta con el formato correcto
   const recipeData = {
    name: name,
    displayName: `<strong>${name} (${Math.round(kcal)}Kcal : ${fatPercentage}%G:${proteinPercentage}%PT:${carbsPercentage}%HC: Ratio:${ketoRatio})</strong> (${ingredientsStr})`,
    recipe: [
      {
        name: name,
        grams: 100, // valor de referencia
        fat: fat,
        protein: protein,
        carbs: carbs,
        kcal: kcal
      }
    ],
    totals: { fat, protein, carbs, kcal }
  };

    
    try {
      // A√±adir directamente al plan semanal
      /// --- MODIFICACI√ìN: A√±adir al plan semanal (la verificaci√≥n ya se hizo) ---
    // Las l√≠neas siguientes ya no son necesarias porque checkAndHandleExistingRecipes las maneja
    // if (!weeklyPlan[day]) weeklyPlan[day] = {};
    // if (!weeklyPlan[day][timeOfDay]) weeklyPlan[day][timeOfDay] = [];
    // Se a√±ade directamente al array, que ya est√° correctamente inicializado
    weeklyPlan[day][mealType].push(recipeData);
    // --- FIN MODIFICACI√ìN ---
      
      saveWeeklyPlan();
      renderWeeklyPlan();
      
      // RECALCULAR LAS CALOR√çAS DEL D√çA - ¬°ESTO ES LO QUE FALTABA!
      recalcDayKcal(day, weeklyPlan);
      
      renderShoppingList();
      
      // --- MODIFICACI√ìN: Usar mealType en el mensaje ---
		alert(`‚úÖ Receta "${name}" a√±adida al ${day} - ${mealType}`); // Usar mealType
		// --- FIN MODIFICACI√ìN ---
	  } catch (err) {
		console.error('Error al a√±adir al plan:', err);
		alert('Error al a√±adir la receta al plan semanal.');
	}
});
});

// --- Funci√≥n auxiliar para recalcular kcal de un d√≠a ---
function recalcDayKcal(day, planData) {
  let total = 0;
  const meals = ["Desayuno","Almuerzo","Cena","Snack"];

  meals.forEach(meal => {
    if (planData[day] && planData[day][meal]) {
      planData[day][meal].forEach(r => {
        // Usar los totals si est√°n disponibles, de lo contrario calcular desde recipe
        if (r.totals && r.totals.kcal) {
          total += r.totals.kcal;
        } else if (r.recipe) {
          r.recipe.forEach(ing => {
            total += ing.kcal || 0;
          });
        }
      });
    }
  });

  const kcalCell = document.getElementById(`${day}-Kcal`);
  if (kcalCell) {
    kcalCell.textContent = total > 0 ? Math.round(total) : "";
  }
}

// Inicializar
document.addEventListener("DOMContentLoaded", renderDB);

    

// === DOM helpers ===
const $ = (sel) => document.querySelector(sel);
const el = (tag, attrs = {}, ...children) => {
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k, v]) => {
    if (k === 'class') {
      n.className = v;
    } else if (k.startsWith('on') && typeof v === 'function') {
      n.addEventListener(k.slice(2), v);
    } else {
      n.setAttribute(k, v);
    }
  });
  children.forEach(c => {
    if (c instanceof Node) n.appendChild(c);
    else n.appendChild(document.createTextNode(String(c)));
  });
  return n;
};

const fmt = (x) => (Math.round((x + Number.EPSILON) * 100) / 100).toFixed(1);
const safeParse = (key, fallback) => { 
  try { 
    const v = JSON.parse(localStorage.getItem(key)); 
    return (v ?? fallback); 
  } catch { 
    return fallback; 
  } 
};

// Funci√≥n auxiliar para verificar y manejar recetas existentes en una celda
function checkAndHandleExistingRecipes(day, timeOfDay) {
  // Asegurar que la estructura exista
  if (!weeklyPlan[day]) {
    weeklyPlan[day] = {};
  }
  if (!weeklyPlan[day][timeOfDay]) {
    weeklyPlan[day][timeOfDay] = [];
  } else if (!Array.isArray(weeklyPlan[day][timeOfDay])) {
    // si lo importado no es array (ej. un solo objeto), lo convertimos
    weeklyPlan[day][timeOfDay] = [weeklyPlan[day][timeOfDay]];
  }

  const existingRecipes = weeklyPlan[day][timeOfDay];
  let proceedToAdd = true; // Por defecto, proceder
  let shouldReplace = false; // Por defecto, no reemplazar

  if (existingRecipes && existingRecipes.length > 0) {
    // Si hay recetas, preguntar al usuario
    let recipeNames = existingRecipes.map((r, index) => `${index + 1}. ${r.name}`).join('\n');
    const userChoice = prompt(
      `‚ö†Ô∏è Ya existe(n) ${existingRecipes.length} receta(s) en ${day} - ${timeOfDay}:\n${recipeNames}\n\n` +
      `¬øQu√© deseas hacer?\n` +
      `1. A√±adir la nueva receta (manteniendo las existentes)\n` +
      `2. Reemplazar (eliminar las existentes y a√±adir la nueva)\n` +
      `3. Cancelar\n\n` +
      `Introduce 1, 2 o 3:`
    );

    if (userChoice === "2") {
      // Reemplazar: Limpiar el array
      weeklyPlan[day][timeOfDay] = [];
      shouldReplace = true;
      console.log(`Recetas anteriores en ${day} - ${timeOfDay} eliminadas.`);
    } else if (userChoice === "3" || userChoice === null) {
      // Cancelar o cerrar el prompt
      alert("Operaci√≥n cancelada. No se a√±adi√≥ la receta.");
      proceedToAdd = false;
    }
    // Si es "1" o cualquier otra cosa, se a√±ade la nueva receta al final (comportamiento por defecto)
  }
  
  return { proceedToAdd, shouldReplace };
}
// === Populate DB table and select ===
function renderDB() {
  const tbody = $("#dbTable tbody");
  tbody.innerHTML = "";
  FOOD_DB.forEach(f => {
    const tr = el("tr", {}, 
      el("td", {}, f.name), 
      el("td", {class: "right"}, fmt(f.fat_per_100g)), 
      el("td", {class: "right"}, fmt(f.protein_per_100g)), 
      el("td", {class: "right"}, fmt(f.netcarbs_per_100g)), 
      el("td", {class: "right"}, fmt(f.kcal_per_100g))
    );
    tbody.appendChild(tr);
  });
  const sel = $("#foodSelect");
  sel.innerHTML = "";
  FOOD_DB.forEach((f, i) => {
    const o = el("option", { value: i }, f.name);
    sel.appendChild(o);
  });
}

// Export FOOD_DB as JSON with date
document.getElementById('exportFoodDatabaseBtn').addEventListener('click', async () => {
  try {
    // Generar nombre del archivo con fecha (YYYY_MM_DD)
    const today = new Date();
    const fileName = `${today.getFullYear()}_${String(today.getMonth() + 1).padStart(2, '0')}_${String(today.getDate()).padStart(2, '0')}_food_database.json`;
    const jsonData = JSON.stringify(FOOD_DB, null, 2);

    // 1. Intentar con la API moderna (permite elegir carpeta)
    if ('showSaveFilePicker' in window) {
      try {
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: fileName,
          types: [{
            description: 'JSON Files',
            accept: { 'application/json': ['.json'] }
          }]
        });
        
        const writableStream = await fileHandle.createWritable();
        await writableStream.write(jsonData);
        await writableStream.close();
        return; // Terminar si tuvo √©xito
      } catch (pickerError) {
        if (pickerError.name === 'AbortError') return; // Usuario cancel√≥
        console.warn('Error con File System API:', pickerError);
        // Continuar con fallback si hay error
      }
    }

    // 2. Fallback tradicional (descarga directa)
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);

  } catch (error) {
    console.error('Error en exportaci√≥n:', error);
    alert('Error al exportar. ' + (
      'showSaveFilePicker' in window 
        ? 'Aseg√∫rate de aceptar los permisos.' 
        : 'Tu navegador no soporta selecci√≥n de carpeta.'
    ));
  }
});

// Import JSON to update FOOD_DB
document.getElementById('importFoodDatabase').addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const importedData = JSON.parse(e.target.result);
      // Validate imported data
      if (!Array.isArray(importedData)) {
        throw new Error('El archivo JSON debe ser un array de alimentos.');
      }
      const requiredFields = ['name', 'fat_per_100g', 'protein_per_100g', 'netcarbs_per_100g', 'kcal_per_100g'];
      const isValid = importedData.every(food => 
        requiredFields.every(field => field in food && typeof food[field] === (field === 'name' ? 'string' : 'number'))
      );
      if (!isValid) {
        throw new Error('El archivo JSON tiene un formato inv√°lido. Cada alimento debe tener: name (string), fat_per_100g, protein_per_100g, netcarbs_per_100g, kcal_per_100g (n√∫meros).');
      }
      // Update FOOD_DB (replace existing data)
      FOOD_DB.length = 0; // Clear current FOOD_DB
      FOOD_DB.push(...importedData);
      renderDB(); // Re-render table and select
      event.target.value = ''; // Reset file input
      alert('Base de datos importada con √©xito.');
    } catch (error) {
      console.error('Error importing FOOD_DB:', error);
      alert(`Error al importar: ${error.message}`);
    }
  };
  reader.onerror = () => {
    console.error('Error reading file:', reader.error);
    alert('Error al leer el archivo. Por favor, intenta de nuevo.');
  };
  reader.readAsText(file);
});

// Initialize table and select on page load
document.addEventListener('DOMContentLoaded', () => {
  renderDB();
});

function updateAddBtnState() {
  const addBtn = $("#addBtn");
  const sel = $("#foodSelect");
  if (addBtn && sel) addBtn.disabled = sel.options.length === 0;
}

// === Search filter ===
$("#foodSearch").addEventListener('input', (e) => {
  const q = e.target.value.toLowerCase();
  const sel = $("#foodSelect");
  const tbody = $("#dbTable tbody");
  sel.innerHTML = "";
  tbody.innerHTML = "";
  FOOD_DB.forEach((f, i) => {
    if (f.name.toLowerCase().includes(q)) {
      sel.appendChild(el("option", { value: i }, f.name));
      const tr = el("tr", {},
        el("td", {}, f.name),
        el("td", { class: "right" }, fmt(f.fat_per_100g)),
        el("td", { class: "right" }, fmt(f.protein_per_100g)),
        el("td", { class: "right" }, fmt(f.netcarbs_per_100g)),
        el("td", { class: "right" }, fmt(f.kcal_per_100g))
      );
      tbody.appendChild(tr);
    }
  });
  if (!sel.value && sel.options.length > 0) sel.selectedIndex = 0;
});

// === A√±adir / vaciar receta ===
const addBtn = $("#addBtn");
if (addBtn) {
  addBtn.addEventListener('click', () => {
    const sel = $("#foodSelect");
    if (!sel || sel.options.length === 0) return;
    const idx = parseInt(sel.value, 10);
    if (Number.isNaN(idx) || !FOOD_DB[idx]) return;
    const grams = parseFloat($("#gramsInput")?.value || "0");
    if (!(grams > 0)) return;
    const f = FOOD_DB[idx];
    recipe.push({
      name: f.name,
      grams,
      fat: f.fat_per_100g * grams / 100,
      protein: f.protein_per_100g * grams / 100,
      carbs: f.netcarbs_per_100g * grams / 100,
      kcal: f.kcal_per_100g * grams / 100
    });
    save();
    renderRecipe();
  });
}

const clearBtn = $("#clearBtn");
if (clearBtn) {
  clearBtn.addEventListener('click', () => {
    if (!recipe.length || !confirm('¬øVaciar la receta actual?')) return;
    recipe = [];
    save();
    renderRecipe();
  });
}

// Funci√≥n para calcular totales desde ingredientes
const calculateTotalsFromIngredients2 = (ingredients) => {
  if (!ingredients || !Array.isArray(ingredients)) {
    return { fat: 0, protein: 0, carbs: 0, kcal: 0 };
  }
  return ingredients.reduce((acc, ing) => {
    acc.fat += Number(ing.fat) || 0;
    acc.protein += Number(ing.protein) || 0;
    acc.carbs += Number(ing.carbs) || 0;
    acc.kcal += Number(ing.kcal) || 0;
    return acc;
  }, { fat: 0, protein: 0, carbs: 0, kcal: 0 });
};


/// === Exportar receta (mejorado y corregido para File System API) ===
// === Exportar receta (mejorado y corregido para File System API) ===
const exportBtn = $("#exportBtn");
if (exportBtn) {
  exportBtn.addEventListener('click', () => {
    // Esta funci√≥n se ejecuta sincr√≥nicamente en respuesta al click
    handleExportRecipe();
  });
}

// Funci√≥n auxiliar async para manejar toda la l√≥gica de exportaci√≥n
async function handleExportRecipe() {
  try {
    // Validaciones iniciales
    if (recipe.length === 0) {
        alert('A√±ade ingredientes antes de exportar.');
        return;
    }
    
    const recipeName = prompt('Introduce el nombre de la receta (ser√° el nombre del archivo):');
    if (!recipeName) {
        alert('El nombre es requerido.');
        return;
    }

    const timeOfDay = prompt('Introduce el momento del d√≠a (Desayuno, Almuerzo, Cena o Snack):');
    if (!TIMES.includes(timeOfDay)) {
        alert('Momento del d√≠a no v√°lido. Usa: Desayuno, Almuerzo, Cena o Snack.');
        return;
    }

    // --- Calcular totales y displayName ---
    // Aseg√∫rate de que calculateTotalsFromIngredients est√© definida y accesible
    const totals = calculateTotalsFromIngredients2(recipe);

    const fatPercentage = totals.kcal > 0 ? Math.round((totals.fat * 9 / totals.kcal) * 100) : 0;
    const proteinPercentage = totals.kcal > 0 ? Math.round((totals.protein * 4 / totals.kcal) * 100) : 0;
    const carbsPercentage = totals.kcal > 0 ? Math.round((totals.carbs * 4 / totals.kcal) * 100) : 0;
    const ketoRatio = (totals.protein + totals.carbs) > 0 
      ? (totals.fat / (totals.protein + totals.carbs)).toFixed(1)
      : 0;

    const nutritionInfo = `<strong>${recipeName} (${Math.round(totals.kcal)}Kcal : ${fatPercentage}%G:${proteinPercentage}%PT:${carbsPercentage}%HC: Ratio:${ketoRatio})</strong>`;
    
    const ingredientsStr = recipe.length > 0 
      ? ` (${recipe.map(ing => `${ing.name} ${fmt(ing.grams)}gr`).join(', ')})`
      : '';

    const displayName = `${nutritionInfo}${ingredientsStr}`;
    // --- FIN Calcular totales y displayName ---

    // Preparar datos (incluyendo totals y displayName)
    const fileName = `${recipeName}.json`;
    const jsonData = JSON.stringify({ 
      name: recipeName, 
      timeOfDay, 
      recipe, 
      totals: totals,
      displayName: displayName,
      version: 1,
      createdAt: new Date().toISOString()
    }, null, 2);

    // 1. Intento con API moderna (selector de carpeta)
    if ('showSaveFilePicker' in window) {
      try {
        // Esta llamada est√° ahora dentro de una funci√≥n async que fue iniciada por el click
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: fileName,
          types: [{
            description: 'Receta Keto',
            accept: { 'application/json': ['.json'] }
          }]
        });
        
        const writableStream = await fileHandle.createWritable();
        await writableStream.write(jsonData);
        await writableStream.close();
        alert(`‚úÖ Receta "${recipeName}" exportada con √©xito.`);
        return;
      } catch (pickerError) {
        if (pickerError.name === 'AbortError') {
             // Usuario cancel√≥, no mostrar alert
             console.log("Usuario cancel√≥ la selecci√≥n de archivo.");
             return;
        }
        console.warn('Error con API File System (continuando con fallback):', pickerError);
        // Si hay otro error, continuamos con el fallback
      }
    }

    // 2. Fallback tradicional
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
    alert(`‚úÖ Receta "${recipeName}" exportada con √©xito.`);

  } catch (error) {
    console.error('Error en exportaci√≥n:', error);
    alert(`Error al exportar: ${error.message || 'Error desconocido'}`);
  }
}
// === Importar receta (mejorado, opcional a√±adir al plan) ===
const importFile = $("#importFile");
if (importFile) {
  importFile.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const obj = JSON.parse(reader.result);
        
        // --- MODIFICACI√ìN: Manejo de recipe, totals y displayName ---
        // Asegurar que 'recipe' sea un array
        recipe = Array.isArray(obj.recipe) ? obj.recipe : [];
        
        // Opcional: Podr√≠as querer almacenar totals y displayName importados
        // en variables temporales o en el estado de la aplicaci√≥n si se van a usar
        // directamente, por ejemplo, para mostrarlos en la UI antes de a√±adir al plan.
        // Por ahora, solo los dejamos disponibles en 'obj' si existen.
        // --- FIN MODIFICACI√ìN ---
        
        save(); // Guardar en localStorage
        renderRecipe(); // Renderizar la tabla de ingredientes
        
        if (obj.name && obj.timeOfDay) {
          const addNow = confirm(`¬øA√±adir la receta "${obj.name}" (momento: ${obj.timeOfDay}) al plan semanal?`);
          if (addNow) {
            const day = prompt('D√≠a de la semana (Lunes, Martes, Mi√©rcoles, Jueves, Viernes, S√°bado, Domingo):');
            if (DAYS.includes(day)) {
              // --- MODIFICACI√ìN: Pasar datos adicionales a addToWeeklyPlan ---
              // Pasar el objeto completo 'obj' puede ser √∫til si addToWeeklyPlan
              // se modifica para usar obj.totals o obj.displayName si existen.
              // Por ahora, pasamos los datos esenciales como antes, pero el objeto
              // importado completo est√° disponible.
              addToWeeklyPlan({ 
                name: obj.name, 
                timeOfDay: obj.timeOfDay, 
                recipe: recipe.slice() // Pasar una copia de los ingredientes
                // Opcional: podr√≠as pasar obj.totals y obj.displayName aqu√≠ si
                // addToWeeklyPlan se modifica para aceptarlos y usarlos.
              });
              // --- FIN MODIFICACI√ìN ---
            } else {
              alert('D√≠a no v√°lido. A√±ade al plan m√°s tarde desde el bot√≥n correspondiente.');
            }
          }
        } else {
             // Si el JSON no tiene name o timeOfDay, notificar
             alert(`Receta importada. ${obj.name ? '' : 'Nombre no encontrado en el archivo. '}${obj.timeOfDay ? '' : 'Momento del d√≠a no encontrado en el archivo.'}\nA√±ade al plan manualmente si es necesario.`);
        }
      } catch (err) {
        console.error(err);
        alert("Archivo inv√°lido: " + err.message);
      } finally {
        e.target.value = ""; // reset input
      }
    };
    reader.readAsText(file);
  });
}
// ... aqu√≠ tienes todas tus funciones previas ...

// === Importar Plan Semanal desde JSON ===
document.getElementById("importtWeeklyPlanBtn").addEventListener("click", () => {
   // c√≥digo de importar plan
});

// === Doble click en filas de Recetas dentro de acordeones ===
document.addEventListener('DOMContentLoaded', () => {
  const container = document.querySelector('#recipesAccordion');
  if (!container) {
    console.error('No se encontr√≥ #recipesAccordion');
    return;
  }

  // ... el c√≥digo que te pas√© ...
});

// === Inicializaci√≥n de la app ===
document.addEventListener("DOMContentLoaded", () => {
  renderDB();
  renderWeeklyPlan();
});

// === Plan semanal (a√±adir / exportar / render) ===
const addToPlanBtn = $("#addToWeeklyPlanBtn");
if (addToPlanBtn) {
  addToPlanBtn.addEventListener('click', () => {
    if (recipe.length === 0) return alert('A√±ade ingredientes antes de a√±adir al plan semanal.');
    const name = prompt('Introduce el nombre de la receta:');
    if (!name) return alert('El nombre es requerido.');

    const timeOfDay = prompt('Introduce el momento del d√≠a (Desayuno, Almuerzo, Cena o Snack):');
    if (!TIMES.includes(timeOfDay)) return alert('Momento del d√≠a no v√°lido. Usa: Desayuno, Almuerzo, Cena o Snack.');

    addToWeeklyPlan({ name, timeOfDay, recipe: recipe.slice() });
  });
}

// === Imprimir Plan Semanal (SIN botones de eliminar) ===
const printWeeklyPlanBtn = document.getElementById("printWeeklyPlanBtn");
if (printWeeklyPlanBtn) {
  printWeeklyPlanBtn.addEventListener("click", () => {
    // 1. Obtener el elemento de la tabla del Plan Semanal usando el ID correcto
    const weeklyPlanTable = document.getElementById("weeklyPlanTable");
    if (!weeklyPlanTable) {
      console.error("No se encontr√≥ la tabla del Plan Semanal (#weeklyPlanTable)");
      alert("Error: No se puede encontrar la tabla para imprimir.");
      return;
    }

    // 2. Calcular las fechas de inicio y fin de la semana (lunes a domingo)
    const now = new Date();
    const dayOfWeek = now.getDay(); // 0 (Domingo) a 6 (S√°bado)
    // Calcular diferencia para obtener el lunes (d√≠a 1)
    // Si hoy es domingo (0), restamos 6 d√≠as para llegar al lunes pasado
    const diffToMonday = dayOfWeek === 0 ? -6 : (1 - dayOfWeek);
    const monday = new Date(now);
    monday.setDate(now.getDate() + diffToMonday);
    
    // Calcular el domingo (6 d√≠as despu√©s del lunes)
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate() + 6);

    // 3. Formatear las fechas
    const options = { day: 'numeric', month: 'long' };
    const mondayStr = monday.toLocaleDateString('es-ES', options);
    const sundayStr = sunday.toLocaleDateString('es-ES', options);
    
    // Crear el t√≠tulo con el rango de fechas
    const title = `Plan Semanal Keto - Semana del ${mondayStr} al ${sundayStr}`;

    // --- MODIFICACI√ìN: Clonar y limpiar la tabla ---
    // Clonar la tabla para no modificar el DOM original
    const tableToPrint = weeklyPlanTable.cloneNode(true);
    
    // Encontrar y eliminar todos los botones de eliminar dentro del clon
    // Los botones tienen la clase 'btn danger' y texto '‚ùå'
    const deleteButtons = tableToPrint.querySelectorAll('button.btn.danger');
    deleteButtons.forEach(button => {
        if (button.textContent.includes('‚ùå')) {
            button.remove();
        }
    });
    // Tambi√©n se pueden eliminar todos los botones con clase 'btn danger' directamente
    // si esa clase es exclusiva de los botones de eliminar en esta tabla.
    // const deleteButtons = tableToPrint.querySelectorAll('button.btn.danger');
    // deleteButtons.forEach(button => button.remove());
    // --- FIN MODIFICACI√ìN ---

    // 4. Crear una nueva ventana/pesta√±a para la impresi√≥n
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      alert("No se pudo abrir la ventana de impresi√≥n. Por favor, aseg√∫rate de que los pop-ups est√©n permitidos.");
      return;
    }

    // 5. Escribir el contenido HTML en la nueva ventana
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>${title}</title>
        <meta charset="UTF-8">
        <style>
          /* Estilos b√°sicos para la impresi√≥n */
          body { font-family: Arial, sans-serif; margin: 20px; }
          h1 { text-align: center; color: #333; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; font-weight: bold; }
          /* Opcional: Ajustar estilos espec√≠ficos de tus celdas si es necesario */
          /* Por ejemplo, para las celdas que contienen <ul> */
          td ul { margin: 0; padding-left: 20px; }
          td li { margin-bottom: 4px; }
		  
          /* Ocultar los botones de eliminar espec√≠ficamente en la impresi√≥n (medida extra de seguridad) */
          @media print {
            button.btn.danger {
              display: none !important;
            }
          }
			/* Estilos para la secci√≥n del Plan Semanal con encabezado fijo y scroll */
    .weekly-plan-container {
      max-height: 700px; /* Altura m√°xima para mostrar aproximadamente 15 filas */
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 8px;
      position: relative;
    }
    
    #weeklyPlanTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 0;
    }
    
    #weeklyPlanTable thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    #weeklyPlanTable th {
      background-color: #f2f2f2;
      font-weight: 600;
      position: sticky;
      top: 0;
      padding: 12px 8px;
      border-bottom: 2px solid #ddd;
    }
    
    #weeklyPlanTable td {
      padding: 8px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    
    #weeklyPlanTable tbody tr:hover td {
      background-color: #f8faf8 !important;
    }
    
    /* Estilos para los d√≠as de la semana (colores) */
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Lunes"]) {
      background-color: #FFE5E5;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Martes"]) {
      background-color: #E5F0FF;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Mi√©rcoles"]) {
      background-color: #E5FFE5;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Jueves"]) {
      background-color: #FFF5E5;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Viernes"]) {
      background-color: #F0E5FF;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="S√°bado"]) {
      background-color: #E5FFFF;
    }
    #weeklyPlanTable tbody tr:has(td:first-child[data-day="Domingo"]) {
      background-color: #FFF0E5;
    }
    
    .total-kcal {
      text-align: right;
      font-weight: bold;
    }
        </style>
      </head>
      <body>
        <h1>${title}</h1>
        <!-- Inyectar el HTML de la tabla CLONADA y LIMPIA -->
        ${tableToPrint.outerHTML}
      </body>
      </html>
    `);

    // 6. Cerrar el documento e invocar la impresi√≥n
    printWindow.document.close();
    printWindow.focus(); // Enfocar la nueva ventana

    // Peque√±o retraso para asegurar que el contenido se cargue antes de imprimir
    printWindow.onload = function() {
      printWindow.print();
      // Opcional: Cerrar la ventana despu√©s de imprimir
      // printWindow.close();
    };
  });
}

// === Imprimir Secci√≥n de Recetas (con selecci√≥n de tipos) ===
const printRecipesBtn = document.getElementById("printRecipesBtn");
if (printRecipesBtn) {
  printRecipesBtn.addEventListener("click", () => {
    // 1. Preguntar al usuario qu√© tipos de recetas quiere imprimir
    const selectedTypes = promptUserForMealTypes();
    if (!selectedTypes) {
      // El usuario cancel√≥ o no seleccion√≥ ning√∫n tipo
      alert("Impresi√≥n cancelada o no se seleccionaron tipos de receta.");
      return;
    }

    // 2. Obtener el contenedor principal de las recetas
    const recipesContainer = document.querySelector("#recipesAccordion");
    if (!recipesContainer) {
        console.error("No se encontr√≥ el contenedor de recetas (#recipesAccordion)");
        alert("Error: No se puede encontrar la secci√≥n de recetas para imprimir.");
        return;
    }

    // 3. Clonar el contenedor y filtrar seg√∫n la selecci√≥n del usuario
    const containerToPrint = filterRecipesContainer(recipesContainer, selectedTypes);
    if (!containerToPrint || containerToPrint.querySelectorAll('.accordion-tab').length === 0) {
        alert("No hay recetas disponibles para los tipos seleccionados.");
        return;
    }

    // 4. Crear una nueva ventana/pesta√±a para la impresi√≥n
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
        alert("No se pudo abrir la ventana de impresi√≥n. Por favor, aseg√∫rate de que los pop-ups est√©n permitidos.");
        return;
    }

    // 5. Determinar el t√≠tulo basado en la selecci√≥n
    let titleText = "Recetas Keto";
    if (selectedTypes.length === 1) {
        titleText = `Recetas Keto - ${selectedTypes[0]}`;
    } else if (selectedTypes.length < 4) { // Asumiendo que hay 4 tipos principales
        titleText = `Recetas Keto - ${selectedTypes.join(', ')}`;
    }
    // Si selectedTypes incluye 'all' o todos los tipos, se mantiene "Recetas Keto"

    // 6. Escribir el contenido HTML en la nueva ventana
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>${titleText}</title>
        <meta charset="UTF-8">
        <style>
          /* Estilos b√°sicos para la impresi√≥n */
          body { font-family: Arial, sans-serif; margin: 20px; }
          h1 { text-align: center; color: #333; }
          
          /* Estilos para el acorde√≥n */
          .accordion-tab { margin-bottom: 15px; border: 1px solid #ccc; }
          .accordion-header {
            padding: 10px 15px;
            background-color: #f7f7f7;
            font-weight: bold;
            /* cursor: pointer; */ /* No es necesario en impresi√≥n */
            border-bottom: 1px solid #ccc;
          }
          .accordion-content {
            display: block; /* Mostrar siempre en impresi√≥n */
            padding: 15px;
          }
          
          /* Estilos para las tablas dentro del acorde√≥n */
          table { width: 100%; border-collapse: collapse; margin-top: 10px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; font-weight: bold; }
          /* Alinear n√∫meros a la derecha */
          td.right, th.right { text-align: right; }
          
          /* Ocultar elementos no deseados en la impresi√≥n */
          .btn, button { display: none !important; } /* Ocultar todos los botones */
          #recipesAccordion {
			  width: 100%;
			  margin-top: 1rem;
			}
			.accordion-tab {
			  margin-bottom: 5px;
			}
		.accordion-header {
		  padding: 10px;
		  cursor: pointer;
		  background-color: #f2f2f2;
		  border: 1px solid #ddd;
		  border-radius: 4px;
		  display: flex;
		  justify-content: space-between;
		  align-items: center;
		  font-weight: bold;
		}
		
		.accordion-content {
		  
		  border: 1px solid #ddd;
		  border-top: none;
		  padding: 10px;
		}
		
		.accordion-content table {
		  width: 100%;
		  border-collapse: collapse;
		}
		.accordion-content th,
		.accordion-content td {
		  border: 1px solid #ddd;
		  padding: 8px;
		  text-align: left;
		}
		.accordion-content th:first-child,
		.accordion-content td:first-child {
		  display: none; /* Hide first column (mealType) */
		}
		#recipesAccordion .accordion-content table tbody td:nth-child(2) {
		  font-weight: 700 !important; /* Bold the Nombre column */
		}
		.accordion-content th {
		  background-color: #f2f2f2;
		}
		.accordion-header[data-meal-type="Desayuno"],
		.accordion-content[data-meal-type="Desayuno"] {
		  background-color: #FFF2CC;
		}
		.accordion-header[data-meal-type="Almuerzo"],
		.accordion-content[data-meal-type="Almuerzo"] {
		  background-color: #E2EFDA;
		}
		.accordion-header[data-meal-type="Cena"],
		.accordion-content[data-meal-type="Cena"] {
		  background-color: #DDEBF7;
		}
		.accordion-header[data-meal-type="Snack"],
		.accordion-content[data-meal-type="Snack"] {
		  background-color: #C6E0B4;
		}
		.accordion-header[data-meal-type="Snack Post-Entrenamiento"],
		.accordion-content[data-meal-type="Snack Post-Entrenamiento"] {
		  background-color: #F8CBAD;
		}
		.accordion-header[data-meal-type="Snack (Barritas)"],
		.accordion-content[data-meal-type="Snack (Barritas)"] {
		  background-color: #C6E0B4;
		}
		.accordion-header[data-meal-type="Snack (Sanak 1)"],
		.accordion-content[data-meal-type="Snack (Sanak 1)"] {
		  background-color: #C6E0B4;
		}
		.accordion-header[data-meal-type="Limpieza"],
		.accordion-content[data-meal-type="Limpieza"] {
		  background-color: #B8C3D2;
		}
		.accordion-header[data-meal-type="Recetas"],
		.accordion-content[data-meal-type="Recetas"] {
		  background-color: #F0D6FE;
		}
        </style>
      </head>
      <body>
        <h1>${titleText}</h1>
        <!-- Inyectar el HTML del contenedor filtrado -->
        ${containerToPrint.outerHTML}
        <script>
          // Script simple para asegurar que los acordeones est√©n desplegados en la impresi√≥n
          window.onload = function() {
              const contents = document.querySelectorAll('.accordion-content');
              contents.forEach(content => {
                  content.style.display = 'block';
              });
          };
        <\/script>
      </body>
      </html>
    `); // Nota: Se escapa la barra en <\/script>

    // 7. Cerrar el documento e invocar la impresi√≥n
    printWindow.document.close();
    printWindow.focus();

    // Peque√±o retraso para asegurar que el contenido se cargue antes de imprimir
    printWindow.onload = function() {
        printWindow.print();
        // Opcional: Cerrar la ventana despu√©s de imprimir
        // printWindow.close();
    };
  });
}

// --- Funciones auxiliares ---

// Funci√≥n para preguntar al usuario qu√© tipos de comidas quiere
function promptUserForMealTypes() {
    // Asumimos estos son los tipos principales. Ajusta seg√∫n tu aplicaci√≥n.
    const allTypes = ['Desayuno', 'Almuerzo', 'Cena', 'Snack'];
    
    // Crear el mensaje para el prompt
    let message = "Selecciona los tipos de recetas a imprimir:\n";
    allTypes.forEach((type, index) => {
        message += `${index + 1}. ${type}\n`;
    });
    message += `${allTypes.length + 1}. Todos los tipos\n\n`;
    message += "Introduce los n√∫meros separados por comas (ej: 1,3,4) o 'todos':";
    
    const userInput = prompt(message);
    
    if (!userInput) {
        return null; // Usuario cancel√≥
    }
    
    const input = userInput.toLowerCase().trim();
    if (input === 'todos' || input === 'todo' || input === `${allTypes.length + 1}`) {
        return ['all']; // Indicador especial para seleccionar todo
    }
    
    // Procesar la entrada de n√∫meros separados por comas
    try {
        const selectedIndexes = input.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        const selectedTypes = selectedIndexes
            .map(index => {
                if (index >= 1 && index <= allTypes.length) {
                    return allTypes[index - 1];
                }
                return null;
            })
            .filter(type => type !== null);
            
        if (selectedTypes.length === 0) {
            alert("No se seleccionaron tipos v√°lidos.");
            return null;
        }
        
        return selectedTypes;
    } catch (e) {
        console.error("Error al procesar la selecci√≥n del usuario:", e);
        alert("Entrada no v√°lida.");
        return null;
    }
}

// Funci√≥n para clonar y filtrar el contenedor de recetas
function filterRecipesContainer(originalContainer, selectedTypes) {
    // Clonar el contenedor original para no modificar el DOM
    const clonedContainer = originalContainer.cloneNode(true);
    
    // Si se seleccion√≥ 'all', no es necesario filtrar
    if (selectedTypes.includes('all')) {
        return clonedContainer;
    }
    
    // Obtener todos los tabs del acorde√≥n clonado
    const tabs = clonedContainer.querySelectorAll('.accordion-tab');
    
    tabs.forEach(tab => {
        const header = tab.querySelector('.accordion-header');
        if (header) {
            const headerText = header.textContent.trim();
            // Verificar si el texto del encabezado incluye alguno de los tipos seleccionados
            const shouldKeep = selectedTypes.some(type => 
                headerText.toLowerCase().includes(type.toLowerCase())
            );
            
            if (!shouldKeep) {
                tab.remove(); // Eliminar el tab si no coincide con la selecci√≥n
            }
        }
    });
    
    return clonedContainer;
}


const exportWeeklyPlanBtn = $("#exportWeeklyPlanBtn");
if (exportWeeklyPlanBtn) {
  exportWeeklyPlanBtn.addEventListener('click', async () => {
    try {
      // --- MODIFICACI√ìN 1: Validaci√≥n estricta antes de procesar ---
      let hasErrors = false;
      let errorMessages = [];

      // Iterar por el weeklyPlan original para validar antes de copiar
      for (const day in weeklyPlan) {
        for (const mealType in weeklyPlan[day]) {
          const recipesInMeal = weeklyPlan[day][mealType];
          for (let i = 0; i < recipesInMeal.length; i++) {
            const recipeEntry = recipesInMeal[i];
            const recipeIdentifier = `${recipeEntry.name || 'Receta sin nombre'} (${day}-${mealType})`;

            // 1. Validar Macros (kcal y que al menos uno no sea cero)
            let totalsValid = true;
            let totalsSource = "desconocida";

            if (recipeEntry.totals && typeof recipeEntry.totals === 'object' && recipeEntry.totals.kcal > 0) {
                // Totals existen y kcal > 0
                const t = recipeEntry.totals;
                if (t.fat === 0 && t.protein === 0 && t.carbs === 0) {
                    totalsValid = false; // Todos los macros son 0
                    totalsSource = "totals";
                }
            } else if (Array.isArray(recipeEntry.recipe) && recipeEntry.recipe.length > 0) {
                // Intentar calcular desde recipe[]
                const calculatedTotals = calculateTotalsFromIngredients2(recipeEntry.recipe);
                if (calculatedTotals.kcal <= 0 || (calculatedTotals.fat === 0 && calculatedTotals.protein === 0 && calculatedTotals.carbs === 0)) {
                     totalsValid = false; // Calculados o todos 0 o kcal 0
                     totalsSource = "recipe[]";
                }
            } else {
                // Ni totals ni recipe[] v√°lidos
                totalsValid = false;
                totalsSource = "ninguna";
            }

            if (!totalsValid) {
                hasErrors = true;
                errorMessages.push(`- ${recipeIdentifier}: Macros inv√°lidos o todos a cero (fuente: ${totalsSource}).`);
            }

            // 2. Validar displayName (debe existir y contener '<strong>')
            if (!recipeEntry.displayName || !recipeEntry.displayName.includes('<strong>')) {
                hasErrors = true;
                errorMessages.push(`- ${recipeIdentifier}: Falta displayName o no tiene el formato correcto.`);
            }
          }
        }
      }

      if (hasErrors) {
           const fullMessage = "Se encontraron problemas en las siguientes recetas:\n" + errorMessages.join('\n') +
                               "\n\n¬øDeseas intentar corregir estos problemas manualmente antes de exportar?";
           const userWantsToFix = confirm(fullMessage);
           if (!userWantsToFix) {
               alert("Exportaci√≥n cancelada. Por favor, revisa las recetas en el Plan Semanal.");
               return; // Salir de la funci√≥n
           }
           // Si el usuario quiere continuar, se procede con la copia y correcci√≥n
           // (Aunque lo ideal ser√≠a un proceso de correcci√≥n interactivo aqu√≠)
      }
      // --- FIN MODIFICACI√ìN 1 ---


      // --- MODIFICACI√ìN 2: Procesar la copia y solicitar datos si es necesario ---
      // Crear una copia profunda de weeklyPlan
      let planToExport = JSON.parse(JSON.stringify(weeklyPlan));

      // Iterar por el plan a exportar y asegurar displayName y totals
      for (const day in planToExport) {
        for (const mealType in planToExport[day]) {
          const recipesInMeal = planToExport[day][mealType];
          for (let i = 0; i < recipesInMeal.length; i++) {
            const recipeEntry = recipesInMeal[i];
            const recipeIdentifier = `${recipeEntry.name || 'Receta sin nombre'} (${day}-${mealType})`;

            // 1. Asegurar que tiene `totals` v√°lidos
            let needsManualInputForTotals = false;
            if (recipeEntry.totals && typeof recipeEntry.totals === 'object' && recipeEntry.totals.kcal > 0) {
                const t = recipeEntry.totals;
                if (t.fat === 0 && t.protein === 0 && t.carbs === 0) {
                    needsManualInputForTotals = true;
                }
            } else {
                // Si no hay totals v√°lidos, intentar calcularlos o marcar para entrada manual
                if (Array.isArray(recipeEntry.recipe) && recipeEntry.recipe.length > 0) {
                    const calculatedTotals = calculateTotalsFromIngredients(recipeEntry.recipe);
                    if (calculatedTotals.kcal > 0 && (calculatedTotals.fat > 0 || calculatedTotals.protein > 0 || calculatedTotals.carbs > 0)) {
                        recipeEntry.totals = calculatedTotals; // Usar calculados
                    } else {
                        needsManualInputForTotals = true; // No se pudieron calcular correctamente
                    }
                } else {
                     needsManualInputForTotals = true; // Ni recipe[] para calcular
                }
            }

            if (needsManualInputForTotals) {
                 const userConfirmed = confirm(`La receta "${recipeIdentifier}" tiene macros inv√°lidos o todos a cero.\n¬øDeseas introducirlos manualmente ahora? (Cancelar omitir√° esta receta)`);
                 if (userConfirmed) {
                     const fatInput = prompt(`Introduce las grasas (g) para ${recipeIdentifier}:`, "0");
                     const proteinInput = prompt(`Introduce las prote√≠nas (g) para ${recipeIdentifier}:`, "0");
                     const carbsInput = prompt(`Introduce los carbohidratos (g) para ${recipeIdentifier}:`, "0");
                     const kcalInput = prompt(`Introduce las calor√≠as (kcal) para ${recipeIdentifier}:`, "0");

                     const fat = parseFloat(fatInput);
                     const protein = parseFloat(proteinInput);
                     const carbs = parseFloat(carbsInput);
                     const kcal = parseFloat(kcalInput);

                     if (!isNaN(fat) && !isNaN(protein) && !isNaN(carbs) && !isNaN(kcal) && kcal > 0) {
                         recipeEntry.totals = { fat, protein, carbs, kcal };
                         // Tambi√©n actualizar el recipe[] con valores dummy si es necesario para mantener consistencia?
                         // O simplemente usar los totals para el displayName
                     } else {
                         alert(`Entrada inv√°lida para ${recipeIdentifier}. Se omitir√° en la exportaci√≥n o se usar√°n valores por defecto.`);
                         // Opcional: eliminar la receta problem√°tica
                         // recipesInMeal.splice(i, 1); i--; // Ajustar √≠ndice
                         // O dejar valores a 0
                         recipeEntry.totals = { fat: fat||0, protein: protein||0, carbs: carbs||0, kcal: kcal||0 };
                     }
                 } else {
                     // Usuario cancel√≥, dejar valores actuales o establecer a 0
                     console.log(`Usuario omiti√≥ la entrada de macros para ${recipeIdentifier}`);
                     if (!recipeEntry.totals) recipeEntry.totals = { fat: 0, protein: 0, carbs: 0, kcal: 0 };
                 }
            }


            // 2. Asegurar que tiene `displayName`
            if (!recipeEntry.displayName || !recipeEntry.displayName.includes('<strong>')) {
                 const userConfirmed = confirm(`La receta "${recipeIdentifier}" no tiene un displayName v√°lido.\n¬øDeseas introducirlo manualmente ahora? (Cancelar crear√° uno b√°sico)`);
                 if (userConfirmed) {
                     // Intentar generar uno b√°sico si el usuario no lo introduce
                     let generatedDisplayName = "";
                     try {
                         generatedDisplayName = generateDisplayName(recipeEntry); // Intenta generar
                     } catch (e) {
                         console.warn(`No se pudo generar displayName autom√°ticamente para ${recipeIdentifier}`, e);
                         const totals = recipeEntry.totals || { fat: 0, protein: 0, carbs: 0, kcal: 0 };
                         const fatPercentage = totals.kcal ? Math.round((totals.fat * 9 / totals.kcal) * 100) : 0;
                         const proteinPercentage = totals.kcal ? Math.round((totals.protein * 4 / totals.kcal) * 100) : 0;
                         const carbsPercentage = totals.kcal ? Math.round((totals.carbs * 4 / totals.kcal) * 100) : 0;
                         const ketoRatio = (totals.protein + totals.carbs) ? (totals.fat / (totals.protein + totals.carbs)).toFixed(1) : '0.0';
                         generatedDisplayName = `<strong>${recipeEntry.name || 'Receta sin nombre'} (${Math.round(totals.kcal||0)}Kcal : ${fatPercentage}%G:${proteinPercentage}%PT:${carbsPercentage}%HC: Ratio:${ketoRatio})</strong>`;
                     }

                     const displayNameInput = prompt(`Introduce el displayName para ${recipeIdentifier} (formato HTML, debe incluir <strong>):`, generatedDisplayName);
                     if (displayNameInput && displayNameInput.includes('<strong>')) {
                         recipeEntry.displayName = displayNameInput;
                     } else if (displayNameInput) {
                         alert("El displayName debe incluir las etiquetas <strong>. Se usar√° uno generado autom√°ticamente.");
                         recipeEntry.displayName = generatedDisplayName; // Usar el generado o el fallback
                     } else {
                         // Usuario cancel√≥ el prompt
                         alert("No se introdujo displayName. Se usar√° uno generado autom√°ticamente.");
                         recipeEntry.displayName = generatedDisplayName;
                     }
                 } else {
                     // Usuario no quiere introducirlo, generar uno b√°sico
                     console.log(`Generando displayName b√°sico para ${recipeIdentifier}`);
                     let generatedDisplayName = "";
                     try {
                         generatedDisplayName = generateDisplayName(recipeEntry);
                     } catch (e) {
                         console.warn(`No se pudo generar displayName autom√°ticamente para ${recipeIdentifier}`, e);
                         const totals = recipeEntry.totals || { fat: 0, protein: 0, carbs: 0, kcal: 0 };
                         // ... (mismo c√°lculo de porcentajes y ratio que arriba) ...
                         generatedDisplayName = `<strong>${recipeEntry.name || 'Receta sin nombre'} (${Math.round(totals.kcal||0)}Kcal : ${fatPercentage}%G:${proteinPercentage}%PT:${carbsPercentage}%HC: Ratio:${ketoRatio})</strong>`;
                     }
                     recipeEntry.displayName = generatedDisplayName;
                 }
            }
          }
        }
      }
      // --- FIN MODIFICACI√ìN 2 ---

      // Generar nombre del archivo con fecha (YYYY_MM_DD)
      const today = new Date();
      const fileName = `${today.getFullYear()}_${String(today.getMonth() + 1).padStart(2, '0')}_${String(today.getDate()).padStart(2, '0')}_plan_semanal_keto.json`;
      
      // Serializar la copia modificada
      const jsonData = JSON.stringify(planToExport, null, 2); 

      // --- C√≥digo de descarga (sin cambios) ---
      // 1. Intentar con la API moderna (permite elegir carpeta)
      if ('showSaveFilePicker' in window) {
        try {
          const fileHandle = await window.showSaveFilePicker({
            suggestedName: fileName,
            types: [{
              description: 'JSON Files',
              accept: { 'application/json': ['.json'] }
            }]
          });
          
          const writableStream = await fileHandle.createWritable();
          await writableStream.write(jsonData);
          await writableStream.close();
          alert("‚úÖ Plan semanal exportado con √©xito.");
          return; // Terminar si tuvo √©xito
        } catch (pickerError) {
          if (pickerError.name === 'AbortError') return; // Usuario cancel√≥
          console.warn('Error con File System API:', pickerError);
          // Continuar con fallback si hay error
        }
      }

      // 2. Fallback tradicional (descarga directa)
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      alert("‚úÖ Plan semanal exportado con √©xito.");

    } catch (error) {
      console.error('Error en exportaci√≥n:', error);
      alert('Error al exportar el plan semanal. ' + (
        'showSaveFilePicker' in window 
          ? 'Aseg√∫rate de aceptar los permisos.' 
          : 'Tu navegador no soporta selecci√≥n de carpeta.'
      ));
    }
  });
}

// === Imprimir Lista de la Compra ===
const printtShoppingListBtn = document.getElementById("printtShoppingListBtn"); // Aseg√∫rate del ID correcto
if (printtShoppingListBtn) {
  printtShoppingListBtn.addEventListener("click", () => {
    // 1. Obtener el elemento de la tabla de la Lista de la Compra
    // Asumiendo que tu tabla tiene un ID como 'shoppingListTable'
    const shoppingListTable = document.getElementById("shoppingListTable");
    if (!shoppingListTable) {
        console.error("No se encontr√≥ la tabla de la Lista de la Compra (#shoppingListTable)");
        alert("Error: No se puede encontrar la lista de la compra para imprimir.");
        return;
    }

    // 2. Crear una nueva ventana/pesta√±a para la impresi√≥n
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
        alert("No se pudo abrir la ventana de impresi√≥n. Por favor, aseg√∫rate de que los pop-ups est√©n permitidos.");
        return;
    }

    // 3. Escribir el contenido HTML en la nueva ventana
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Lista de la Compra Keto</title>
        <style>
          /* Estilos b√°sicos para la impresi√≥n */
          body { font-family: Arial, sans-serif; margin: 20px; }
          h1 { text-align: center; color: #333; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; font-weight: bold; }
          /* Alinear n√∫meros a la derecha si es necesario */
          td.right, th.right { text-align: right; }
          /* Puedes copiar aqu√≠ los estilos CSS espec√≠ficos de tu tabla si es necesario */
        </style>
      </head>
      <body>
        <h1>Lista de la Compra Keto</h1>
        <!-- Inyectar el HTML de la tabla -->
        ${shoppingListTable.outerHTML}
      </body>
      </html>
    `);

    // 4. Cerrar el documento e invocar la impresi√≥n
    printWindow.document.close();
    printWindow.focus(); // Enfocar la nueva ventana

    // Peque√±o retraso para asegurar que el contenido se cargue antes de imprimir
    printWindow.onload = function() {
        printWindow.print();
        // Opcional: Cerrar la ventana despu√©s de imprimir
        // printWindow.close();
    };
  });
}
// === Imprimir Base de Datos de Alimentos ===
const printFoodBtn = document.getElementById("printFoodBtn");
if (printFoodBtn) {
  printFoodBtn.addEventListener("click", () => {
    // 1. Obtener el elemento de la tabla de la Base de Datos
    // Asumiendo que la tabla tiene un ID como 'dbTable'
    const dbTable = document.getElementById("dbTable");
    if (!dbTable) {
        console.error("No se encontr√≥ la tabla de la Base de Datos (#dbTable)");
        alert("Error: No se puede encontrar la tabla de la base de datos para imprimir.");
        return;
    }

    // 2. Crear una nueva ventana/pesta√±a para la impresi√≥n
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
        alert("No se pudo abrir la ventana de impresi√≥n. Por favor, aseg√∫rate de que los pop-ups est√©n permitidos.");
        return;
    }

    // 3. Escribir el contenido HTML en la nueva ventana
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Base de Datos de Alimentos Keto</title>
        <meta charset="UTF-8">
        <style>
          /* Estilos b√°sicos para la impresi√≥n */
          body { font-family: Arial, sans-serif; margin: 20px; }
          h1 { text-align: center; color: #333; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; font-weight: bold; }
          /* Alinear n√∫meros a la derecha */
          td.right, th.right { text-align: right; }
          /* Opcional: Ajustar tama√±o de fuente si la tabla es muy larga */
          /* body { font-size: 0.9em; } */
        </style>
      </head>
      <body>
        <h1>Base de Datos de Alimentos Keto</h1>
        <!-- Inyectar el HTML de la tabla -->
        ${dbTable.outerHTML}
      </body>
      </html>
    `);

    // 4. Cerrar el documento e invocar la impresi√≥n
    printWindow.document.close();
    printWindow.focus(); // Enfocar la nueva ventana

    // Peque√±o retraso para asegurar que el contenido se cargue antes de imprimir
    printWindow.onload = function() {
        printWindow.print();
        // Opcional: Cerrar la ventana despu√©s de imprimir
        // printWindow.close();
    };
  });
}
$("#exportShoppingListBtn").addEventListener('click', async () => {
  try {
    const shoppingList = generateShoppingList();
    if (shoppingList.length === 0) {
      alert("La lista de la compra est√° vac√≠a.");
      return;
    }

    const dateInput = $("#shoppingListDate");
    if (!dateInput.value) {
      alert("Debes seleccionar una fecha.");
      return;
    }

    // Formatear fecha (cambiado a formato YYYY_MM_DD para consistencia)
    const [year, month, day] = dateInput.value.split("-");
    const fileName = `${year}_${month}_${day}_lista_compra.json`;
    const jsonData = JSON.stringify(shoppingList, null, 2);

    // 1. Intentar con API moderna (selector de carpeta)
    if ('showSaveFilePicker' in window) {
      try {
        const fileHandle = await window.showSaveFilePicker({
          suggestedName: fileName,
          types: [{
            description: 'JSON Files',
            accept: { 'application/json': ['.json'] }
          }]
        });
        
        const writableStream = await fileHandle.createWritable();
        await writableStream.write(jsonData);
        await writableStream.close();
        dateInput.value = ""; // Reset fecha despu√©s de exportar
        return;
      } catch (pickerError) {
        if (pickerError.name === 'AbortError') return; // Usuario cancel√≥
        console.warn('Error con File System API:', pickerError);
        // Continuar con fallback
      }
    }

    // 2. Fallback tradicional
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      dateInput.value = ""; // Reset fecha despu√©s de exportar
    }, 100);

  } catch (error) {
    console.error('Error al exportar lista:', error);
    alert(`Error al exportar: ${
      'showSaveFilePicker' in window 
        ? 'Aseg√∫rate de aceptar los permisos.' 
        : 'Tu navegador no soporta selecci√≥n de carpeta.'
    }`);
  }
});

function addToWeeklyPlan({ name, timeOfDay, recipe }) {
  const day = prompt('Introduce el d√≠a de la semana (Lunes, Martes, Mi√©rcoles, Jueves, Viernes, S√°bado, Domingo):');
  if (!['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'].includes(day)) {
    alert('D√≠a no v√°lido. Usa: Lunes, Martes, Mi√©rcoles, Jueves, Viernes, S√°bado, Domingo.');
    return;
  }

  // --- MODIFICACI√ìN: Usar la funci√≥n auxiliar ---
  const checkResult = checkAndHandleExistingRecipes(day, timeOfDay);
  if (!checkResult.proceedToAdd) {
    return; // Salir si el usuario cancel√≥
  }
  // Si checkResult.shouldReplace es true, weeklyPlan[day][timeOfDay] ya est√° vac√≠o
  // Si es false, se a√±adir√° al final del array existente
  // --- FIN MODIFICACI√ìN ---

  // Calcular totales nutricionales
  const totals = recipe.reduce((acc, r) => ({
    fat: acc.fat + r.fat,
    protein: acc.protein + r.protein,
    carbs: acc.carbs + r.carbs,
    kcal: acc.kcal + r.kcal
  }), { fat: 0, protein: 0, carbs: 0, kcal: 0 });

  // Calcular porcentajes
  const fatPercentage = totals.kcal > 0 ? Math.round((totals.fat * 9 / totals.kcal) * 100) : 0;
  const proteinPercentage = totals.kcal > 0 ? Math.round((totals.protein * 4 / totals.kcal) * 100) : 0;
  const carbsPercentage = totals.kcal > 0 ? Math.round((totals.carbs * 4 / totals.kcal) * 100) : 0;
  
  // Calcular ratio cetog√©nico: Grasa(g) / (Prote√≠na(g) + Carbohidratos(g))
  const ketoRatio = (totals.protein + totals.carbs) > 0 
    ? (totals.fat / (totals.protein + totals.carbs)).toFixed(1)
    : 0;

  // Crear el string de informaci√≥n nutricional COMPLETA en negrita
  const nutritionInfo = `<strong>${name} (${Math.round(totals.kcal)}Kcal : ${fatPercentage}%G:${proteinPercentage}%PT:${carbsPercentage}%HC: Ratio:${ketoRatio})</strong>`;
  
  // Crear el string de ingredientes
  const ingredientsStr = recipe.length > 0 
    ? ` (${recipe.map(ing => `${ing.name} ${fmt(ing.grams)}gr`).join(', ')})`
    : '';

  // Combinar todo en el displayName (con HTML)
  const displayName = `${nutritionInfo}${ingredientsStr}`;

  // A√±adir la receta al plan (el array ya est√° inicializado y gestionado por checkAndHandleExistingRecipes)
  weeklyPlan[day][timeOfDay].push({ name, displayName, recipe, totals }); // Incluir totals
  
  saveWeeklyPlan();
  renderWeeklyPlan();
  renderShoppingList(); // Asegurarse de que la lista de la compra tambi√©n se actualice

  // Notificaci√≥n final
  alert(`‚úÖ Receta "${name}" a√±adida al ${day} - ${timeOfDay}`);

  // Opci√≥n de a√±adir a la tabla de recetas (como estaba antes)
  const addToRecipes = confirm('Receta a√±adida al plan semanal. ¬øDeseas a√±adirla directamente a la tabla de Recetas o editarla manualmente en el formulario? (OK = A√±adir directamente, Cancelar = Editar manualmente)');
  if (addToRecipes) {
    recipes.push({
      mealType: timeOfDay,
      name,
      fat: totals.fat,
      protein: totals.protein,
      carbs: totals.carbs,
      kcal: totals.kcal,
      ingredients: recipe.map(ing => `${ing.name} (${fmt(ing.grams)}g)`).join(', ')
    });
    saveRecipes();
    renderRecipes();
  } else {
    const addRecipeForm = document.querySelector("#addRecipeForm");
    if (!addRecipeForm) {
      console.error("Error: #addRecipeForm not found in the DOM");
      alert("Error: No se encontr√≥ el formulario de recetas. A√±ade la receta manualmente desde la secci√≥n de Recetas.");
      return;
    }
    document.querySelector("#recipeName").value = name;
    document.querySelector("#mealType").value = timeOfDay;
    document.querySelector("#fatInput").value = fmt(totals.fat);
    document.querySelector("#proteinInput").value = fmt(totals.protein);
    document.querySelector("#carbsInput").value = fmt(totals.carbs);
    document.querySelector("#kcalInput").value = fmt(totals.kcal);
    document.querySelector("#ingredientsInput").value = recipe.map(ing => `${ing.name} (${fmt(ing.grams)}g)`).join(', ');
  }
}

function calculateDailyKcal(day) {
  const times = ['Desayuno', 'Almuerzo', 'Cena', 'Snack'];
  let totalKcal = 0;
  times.forEach(time => {
    if (weeklyPlan[day] && weeklyPlan[day][time]) {
      weeklyPlan[day][time].forEach(entry => {
        totalKcal += entry.recipe.reduce((sum, ing) => sum + Number(ing.kcal) || 0, 0);
      });
    }
  });
  return fmt(totalKcal);
}

function renderWeeklyPlan() {
  const days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
  const times = ['Desayuno', 'Almuerzo', 'Cena', 'Snack'];
  days.forEach(day => {
    times.forEach(time => {
      const cell = document.querySelector(`#${day}-${time}`);
      if (!cell) {
        console.error(`Error: Cell #${day}-${time} not found`);
        return;
      }
      cell.innerHTML = '';
      if (weeklyPlan[day] && weeklyPlan[day][time]) {
        const ul = el('ul', {});
        weeklyPlan[day][time].forEach((entry, i) => {
          // --- MODIFICACI√ìN CORRECTA ---
          let displayText = entry.displayName;
          // Verificar si displayName es una cadena no vac√≠a
          if (typeof displayText !== 'string' || displayText.trim() === '') {
            // Fallback: usar el nombre de la receta o un mensaje
            displayText = entry.name ? `<strong>${entry.name}</strong>` : "[Receta sin nombre]";
            // Opcional: Registrar una advertencia para depuraci√≥n
            console.warn(`Receta sin displayName v√°lido encontrada en ${day}-${time}[${i}]:`, entry);
          }
          // --- FIN MODIFICACI√ìN ---

          // Crear un span y asignarle innerHTML directamente
          const contentSpan = document.createElement('span');
          // --- CORRECCI√ìN: Usar displayText en lugar de entry.displayName ---
          contentSpan.innerHTML = displayText;
          // --- FIN CORRECCI√ìN ---

          // Crear bot√≥n de eliminar con el mismo estilo que en importaci√≥n
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '‚ùå';
          deleteBtn.style.marginLeft = '8px';
          deleteBtn.className = 'btn danger';
          deleteBtn.style.padding = '2px 6px';
          deleteBtn.style.fontSize = '0.8em';
          deleteBtn.addEventListener('click', () => removeFromWeeklyPlan(day, time, i));

          const li = el('li', {},
            contentSpan,
            deleteBtn
          );
          ul.appendChild(li);
        });
        cell.appendChild(ul);
      }
    });
    const kcalCell = document.querySelector(`#${day}-Kcal`);
    if (!kcalCell) {
      console.error(`Error: Kcal cell #${day}-Kcal not found`);
      return;
    }
    kcalCell.textContent = calculateDailyKcal(day);
  });
}

// === Limpiar/Vaciar Plan Semanal ===
const vaciarWeeklyPlanBtn = document.getElementById("vaciarWeeklyPlanBtn");
if (vaciarWeeklyPlanBtn) {
  vaciarWeeklyPlanBtn.addEventListener("click", () => {
    // Preguntar al usuario para confirmar
    const userConfirmed = confirm(
      "‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\n" +
      "¬øEst√°s seguro de que deseas LIMPIAR el Plan Semanal?\n\n" +
      "ESTA ACCI√ìN BORRAR√Å COMPLETAMENTE todas las recetas del plan semanal.\n" +
      "Los datos se perder√°n permanentemente si no los has guardado/exportado.\n\n" +
      "Haz clic en 'Aceptar' para continuar y limpiar el plan.\n" +
      "Haz clic en 'Cancelar' para conservar los datos actuales."
    );

    if (!userConfirmed) {
      alert("Limpieza cancelada. Los datos actuales se conservan.");
      return; // Salir de la funci√≥n sin hacer nada
    }

    // Reset weeklyPlan a su estado inicial vac√≠o
    weeklyPlan = {
      "Lunes": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
      "Martes": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
      "Mi√©rcoles": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
      "Jueves": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
      "Viernes": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
      "S√°bado": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] },
      "Domingo": { "Desayuno": [], "Almuerzo": [], "Cena": [], "Snack": [] }
    };

    // Guardar el plan vac√≠o en localStorage
    saveWeeklyPlan();

    // Re-renderizar la tabla del plan semanal
    renderWeeklyPlan();

    // Re-renderizar la lista de la compra (deber√≠a quedar vac√≠a)
    renderShoppingList();

    // Mostrar mensaje de √©xito
    alert("‚úÖ Plan Semanal limpiado con √©xito.");
  });
}

function removeFromWeeklyPlan(day, time, index) {
  if (!weeklyPlan[day]?.[time]) return;
  weeklyPlan[day][time].splice(index, 1);
  if (weeklyPlan[day][time].length === 0) delete weeklyPlan[day][time];
  if (Object.keys(weeklyPlan[day]).length === 0) delete weeklyPlan[day];
  saveWeeklyPlan();
  renderWeeklyPlan();
  renderShoppingList();
}

function saveWeeklyPlan() {
  localStorage.setItem('keto_weekly_plan', JSON.stringify(weeklyPlan));
  setStatus('Plan guardado');
}
function fixCorruptedWeeklyPlan() {
  let changed = false;

  Object.keys(weeklyPlan).forEach(day => {
    Object.keys(weeklyPlan[day]).forEach(meal => {
      weeklyPlan[day][meal] = weeklyPlan[day][meal].map(r => {
        // Si falta recipe[] o est√° vac√≠o ‚Üí creamos uno a partir de totals
        if (!r.recipe || !Array.isArray(r.recipe) || r.recipe.length === 0) {
          if (r.totals) {
            changed = true;
            return {
              ...r,
              recipe: [
                {
                  name: r.name,
                  grams: 100,
                  fat: r.totals.fat || 0,
                  protein: r.totals.protein || 0,
                  carbs: r.totals.carbs || 0,
                  kcal: r.totals.kcal || 0
                }
              ]
            };
          }
        }

        // Si recipe[] existe pero todos los macros est√°n en 0 ‚Üí igual lo reconstruimos
        const hasOnlyZeros = r.recipe?.every(ing => 
          (ing.fat || 0) === 0 &&
          (ing.protein || 0) === 0 &&
          (ing.carbs || 0) === 0 &&
          (ing.kcal || 0) === 0
        );
        if (hasOnlyZeros && r.totals) {
          changed = true;
          return {
            ...r,
            recipe: [
              {
                name: r.name,
                grams: 100,
                fat: r.totals.fat || 0,
                protein: r.totals.protein || 0,
                carbs: r.totals.carbs || 0,
                kcal: r.totals.kcal || 0
              }
            ]
          };
        }

        return r; // receta v√°lida ‚Üí se queda igual
      });
    });
  });

  if (changed) {
    saveWeeklyPlan();
    renderWeeklyPlan();
    renderShoppingList();
    console.log("üõ†Ô∏è Se corrigieron recetas corruptas en weeklyPlan");
  }
}

// ‚ö° Llamar tras cargar el plan desde localStorage
document.addEventListener("DOMContentLoaded", () => {
  fixCorruptedWeeklyPlan();
});
function generateShoppingList() {
  const map = {};
  Object.keys(weeklyPlan).forEach(day => {
    Object.keys(weeklyPlan[day]).forEach(time => {
      weeklyPlan[day][time].forEach(rec => {
        (rec.recipe || []).forEach(ing => {
          map[ing.name] = (map[ing.name] || 0) + Number(ing.grams || 0);
        });
      });
    });
  });
  return Object.entries(map)
    .map(([name, grams]) => ({ name, grams }))
    .sort((a, b) => a.name.localeCompare(b.name, 'es'));
}

function renderShoppingList() {
  const tbody = $("#shoppingListTable tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  const shoppingList = generateShoppingList();
  shoppingList.forEach(item => {
    const tr = el("tr", {},
      el("td", {}, item.name),
      el("td", { class: "right" }, fmt(item.grams))
    );
    tbody.appendChild(tr);
  });
}

function renderRecipe() {
  const tbody = $("#recipeTable tbody");
  tbody.innerHTML = "";
  recipe.forEach((row, i) => {
    const tr = el("tr", {}, 
      el("td", {}, row.name),
      el("td", {class: "right"}, 
        el("input", {type: "number", class: "edit-grams", value: fmt(row.grams), min: "0", onchange: (e) => updateGrams(i, e.target.value)})
      ),
      el("td", {class: "right"}, fmt(row.fat)),
      el("td", {class: "right"}, fmt(row.protein)),
      el("td", {class: "right"}, fmt(row.carbs)),
      el("td", {class: "right"}, fmt(row.kcal)),
      el("td", {}, 
        el("button", {class: "btn secondary", onclick: () => removeRow(i)}, "Eliminar")
      )
    );
    tbody.appendChild(tr);
  });
  computeTotals();
}

function updateGrams(index, newGrams) {
  newGrams = parseFloat(newGrams);
  if (newGrams <= 0) {
    removeRow(index);
    return;
  }
  const row = recipe[index];
  const f = FOOD_DB.find(food => food.name === row.name);
  if (f) {
    recipe[index] = {
      name: row.name,
      grams: newGrams,
      fat: f.fat_per_100g * newGrams / 100,
      protein: f.protein_per_100g * newGrams / 100,
      carbs: f.netcarbs_per_100g * newGrams / 100,
      kcal: f.kcal_per_100g * newGrams / 100
    };
    save();
    renderRecipe();
  }
}

function removeRow(i) {
  recipe.splice(i, 1);
  save();
  renderRecipe();
}

function computeTotals() {
  const tot = recipe.reduce((acc, r) => {
    acc.g += Number(r.grams || 0);
    acc.f += Number(r.fat || 0);
    acc.p += Number(r.protein || 0);
    acc.c += Number(r.carbs || 0);
    acc.k += Number(r.kcal || 0);
    return acc;
  }, {g: 0, f: 0, p: 0, c: 0, k: 0});

  if ($("#tot_g")) $("#tot_g").textContent = fmt(tot.g);
  if ($("#tot_f")) $("#tot_f").textContent = fmt(tot.f);
  if ($("#tot_p")) $("#tot_p").textContent = fmt(tot.p);
  if ($("#tot_c")) $("#tot_c").textContent = fmt(tot.c);
  if ($("#tot_kcal")) $("#tot_kcal").textContent = fmt(tot.k);
  if ($("#kcalBox")) $("#kcalBox").textContent = fmt(tot.k);

  const denom = (tot.p + tot.c);
  const ratio = denom > 0 ? (tot.f / denom) : 0;
  const badge = $("#ratioBadge");
  if (badge) {
    badge.textContent = fmt(ratio);
    badge.classList.remove("ratio-high", "ratio-ok", "ratio-low");
    let txt = "Objetivo 1.0‚Äì2.0";
    if (ratio >= 2.0) { badge.classList.add("ratio-high"); txt = "Alto (‚â• 2.0)"; }
    else if (ratio >= 1.0) { badge.classList.add("ratio-ok"); txt = "Moderado (1.0‚Äì1.9)"; }
    else { badge.classList.add("ratio-low"); txt = "Bajo (< 1.0)"; }
    if ($("#ratioText")) $("#ratioText").textContent = txt;
  }

  const kcalF = tot.f * 9, kcalP = tot.p * 4, kcalC = tot.c * 4;
  const kcalTotal = kcalF + kcalP + kcalC;
  const pct = (k) => kcalTotal > 0 ? Math.round((k / kcalTotal) * 100) : 0;
  if ($("#pctF")) $("#pctF").textContent = pct(kcalF) + "%";
  if ($("#pctP")) $("#pctP").textContent = pct(kcalP) + "%";
  if ($("#pctC")) $("#pctC").textContent = pct(kcalC) + "%";
}

function setStatus(text) {
  const s = $("#status");
  if (!s) return;
  s.textContent = text;
  setTimeout(() => { s.textContent = "Listo"; }, 1200);
}
/// Exportar Recetas con fecha en el nombre
$("#exportRecipesBtn").addEventListener('click', async () => {
    try {
        // Validaci√≥n de recetas vac√≠as
        if (recipes.length === 0) {
            alert("No hay recetas para exportar.");
            return;
        }

        // Generar nombre del archivo con fecha (YYYY_MM_DD)
        const today = new Date();
        const fileName = `${today.getFullYear()}_${String(today.getMonth() + 1).padStart(2, '0')}_${String(today.getDate()).padStart(2, '0')}_recetas_keto.json`;
        const jsonData = JSON.stringify(recipes, null, 2);

        // 1. Intento con API moderna (permite elegir carpeta)
        if ('showSaveFilePicker' in window) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'Recetas Keto',
                        accept: { 'application/json': ['.json'] }
                    }]
                });
                
                const writableStream = await fileHandle.createWritable();
                await writableStream.write(jsonData);
                await writableStream.close();
                return; // Finalizar si fue exitoso
            } catch (pickerError) {
                if (pickerError.name === 'AbortError') return; // Ignorar si usuario cancela
                console.warn('Error con API File System:', pickerError);
                // Continuar con fallback
            }
        }

        // 2. Fallback tradicional (descarga autom√°tica)
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        
        // Limpieza con retraso para evitar problemas en algunos navegadores
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);

    } catch (error) {
        console.error('Error en exportaci√≥n:', error);
        alert(`Error al exportar recetas. ${
            'showSaveFilePicker' in window ?
            'Aseg√∫rate de aceptar los permisos.' :
            'Tu navegador no soporta selecci√≥n de carpeta.'
        }`);
    }
});

// Importar Recetas
$("#importRecipesFile").addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
        try {
            const importedRecipes = JSON.parse(reader.result);
            if (!Array.isArray(importedRecipes)) {
                throw new Error("El archivo debe contener un array de recetas.");
            }
            // Validate each recipe
            const validRecipes = importedRecipes.every(r =>
                r.mealType && r.name && typeof r.fat === 'number' && typeof r.protein === 'number' &&
                typeof r.carbs === 'number' && typeof r.kcal === 'number' && r.ingredients
            );
            if (!validRecipes) {
                throw new Error("Una o m√°s recetas tienen un formato inv√°lido.");
            }
            recipes = importedRecipes;
            saveRecipes();
            renderRecipes();
            setStatus('Recetas importadas');
        } catch (err) {
            console.error("Error al importar recetas:", err);
            alert("Archivo inv√°lido: " + err.message);
        } finally {
            e.target.value = ""; // Reset file input
        }
    };
    reader.readAsText(file);
});

function save() {
  localStorage.setItem('keto_recipe', JSON.stringify(recipe));
  setStatus('Receta guardada');
}

// === Recipes Section ===
let recipes = JSON.parse(localStorage.getItem('keto_recipes') || JSON.stringify([

  // ==== DESAYUNO ====
  { mealType: "Desayuno", name: "Bacon con huevos al estilo keto", fat: 42.6, protein: 22.4, carbs: 1.7, kcal: 489, ingredients: "Huevos (100g), Bacon (65g)" },
  { mealType: "Desayuno", name: "Batido de ar√°ndanos", fat: 30.8, protein: 3.9, carbs: 9.1, kcal: 329.3, ingredients: "Leche de coco (162.5g), Ar√°ndanos (42.5g), Jugo de lim√≥n (7.5g), Extracto de vainilla (1g)" },
  { mealType: "Desayuno", name: "Batido Prote√≠na", fat: 22.5, protein: 22, carbs: 4.5, kcal: 315, ingredients: "Aceite de oliva (5g), Prote√≠na de suero (20g), Leche de coco (50g), Semillas de calabaza tostadas (15g), Semillas de calabaza tostadas (15g), Almendras tostadas (10g)" },
  { mealType: "Desayuno", name: "Batido Whey+Huevo+Aguacate y lino", fat: 34.3, protein: 25.5, carbs: 3.1, kcal: 440, ingredients: "Aguacate (100g), Huevo (100g), Clara de huevo pasteurizada (100g), Semillas de lino (50g)" },
  { mealType: "Desayuno", name: "Huevos fritos y yogur de coco", fat: 62.8, protein: 22.6, carbs: 19.5, kcal: 744, ingredients: "Huevos (100g), Mantequilla (14g), Aguacate (50g), Tomate (110g), Yogur de coco (180g), Espinacas (14g), Ar√°ndanos (85g), Nueces (28g), Caf√© (240ml), Nata para montar [o Crema de leche] (15g)" },
  { mealType: "Desayuno", name: "Huevos fritos, tomate y queso", fat: 33.8, protein: 25.6, carbs: 3.0, kcal: 418, ingredients: "Huevos (100g), Mantequilla (7g), Queso cheddar (55g), Tomate (55g)" },
  { mealType: "Desayuno", name: "Huevos revueltos con espinacas y salm√≥n ahumado", fat: 34.6, protein: 24.1, carbs: 2.0, kcal: 409, ingredients: "Mantequilla (14g), Nata para montar [o Crema de leche] (30g), Huevos (100g), Espinacas (28g), Salm√≥n ahumado (55g)" },
  { mealType: "Desayuno", name: "Smoothie de espinacas y aguacate", fat: 65.2, protein: 11.4, carbs: 13.4, kcal: 698.9, ingredients: "Aguacate (100g), Espinacas (42.5g), Lima (33.5g), Jengibre (14g), Semillas de ch√≠a (14g), Crema de coco (237.5g)" },

  { mealType: "Desayuno", name: "Keto Batido Br√≥coli", fat: 45, protein: 32, carbs: 12, kcal: 586, ingredients: "Prote√≠na de suero (30g), Br√≥coli (30g), Espinacas (50g), Pepino (50g), Semillas de mostaza (5g), Semillas de ch√≠a (20g), Aguacate (100g), Leche de almendras (150ml), Jugo de lim√≥n (20ml), Nata para montar [o Crema de leche] (80g), T√© Matcha Verde (2g)" },
  { mealType: "Desayuno", name: "Keto Batido Verde", fat: 48, protein: 22, carbs: 8, kcal: 554, ingredients: "Prote√≠na de suero (20g), Leche de almendras (150ml), Espinacas (50g), Semillas de ch√≠a (10g), Aguacate (50g), Mantequilla (30g), Nata para montar [o Crema de leche] (70g), Canela (1g), T√© Matcha (2g) con lim√≥n (200ml)" },
  { mealType: "Desayuno", name: "Keto Jugo Verde", fat: 65, protein: 34, carbs: 9, kcal: 758, ingredients: "Prote√≠na de suero (40g), Espinacas (50g), Pepino (50g), Apio (50g), Jengibre (2g), Jugo de lim√≥n (20ml), Aceite de oliva (20g), Nata para montar [o Crema de leche] (70g), Canela (1g), T√© verde con lim√≥n (200ml)" },
  { mealType: "Desayuno", name: "Keto Tostadas", fat: 64, protein: 38, carbs: 8, kcal: 759, ingredients: "Harina de almendras (30g), C√°scara de psyllium (5g), Huevos (100g, 2 unidades), Aguacate (50g), Tomate (30g), Semillas de girasol (15g), Aceite de oliva (15g), Prote√≠na de suero (20g), Leche de almendras (100ml)" },
  { mealType: "Desayuno", name: "Tortilla de Aguacate", fat: 23.5, protein: 2, carbs: 1.8, kcal: 233, ingredients: "Aguacate (100g)" },

  // ==== ALMUERZO ====
 { mealType: "Almuerzo", name: "Caballa Papillote", fat: 81.3, protein: 31.2, carbs: 3.4, kcal: 762.4, ingredients: "Caballa (150g), Esp√°rragos (100g), Espinacas (50g), Aceite de oliva (20g), Mantequilla (20g), Nata para montar [o Crema de leche] (30g), Jugo de lim√≥n (20ml)" },
  { mealType: "Almuerzo", name: "Chuletas keto de cerdo con jud√≠as verdes y mantequilla de ajo", fat: 53.8, protein: 26.8, carbs: 6.1, kcal: 622.9, ingredients: "Mantequilla (48.8g), Ajo en polvo (1.2g), Perejil seco (0.8g), Jugo de lim√≥n (3.8g), Chuleta de cerdo (150g), Jud√≠as verdes [o Ejotes / Vainitas] (112.5g), Sal, Pimienta" },
  { mealType: "Almuerzo", name: "Ensalada Templada Keto", fat: 64.7, protein: 31.9, carbs: 6.6, kcal: 748.9, ingredients: "Arroz de coliflor (100g), Espinacas (100g), Aguacate (70g), Nueces (15g), Aceite de oliva (30g), Jugo de lim√≥n (20ml), Pechuga de pollo (80g), Nata para montar [o Crema de leche] (30g)" },
  { mealType: "Almuerzo", name: "Hamburguesas con Salsa de Queso Azul", fat: 22.8, protein: 6.8, carbs: 0.8, kcal: 233.4, ingredients: "Carne molida de res (100g), Mantequilla (20g), Queso azul (30g), Crema (30g), Aceite de oliva (15g)" },
  { mealType: "Almuerzo", name: "Huevos Estrellados con Chistorra", fat: 44.5, protein: 21.8, carbs: 2.1, kcal: 506.9, ingredients: "Huevos (100g), Chistorra (50g), Calabac√≠n [o Zapallo italiano] (50g), Mantequilla (20g), Queso crema (20g)" },
  { mealType: "Almuerzo", name: "KetoMusaca", fat: 69.1, protein: 47.8, carbs: 12.6, kcal: 873.4, ingredients: "Berenjena (75g), Aceite de oliva (15g), Cebolla amarilla (27.5g), Ajo (4.5g), Canela (0.7g), Piment√≥n [o Paprika] (1.7g), Or√©gano (0.8g), Pollo molido (150g), Salsa de tomate (60g), Queso crema (25g), Nata para montar [o Crema de leche] (60g), Queso gouda (50g), Nuez moscada (0.2g), Espinacas (21.3g)" },
  { mealType: "Almuerzo", name: "Panceta con Chistorra y Huevo Frito", fat: 54, protein: 40, carbs: 3, kcal: 720, ingredients: "Chistorra (50g), Panceta de cerdo (125g), Huevo (100g), Lechuga (60g), Tomates cherry (30g), Chucrut fermentado (30g), Pimientos amarillos fermentados (15g)" },
  { mealType: "Almuerzo", name: "Pechuga de pollo rellena de queso con guacamole", fat: 61.5, protein: 63.7, carbs: 10.6, kcal: 827.1, ingredients: "Pechuga de pollo (162.5g), Aceite de oliva (14.3g), Pimiento rojo (35g), Ajo (6g), Jalape√±os (6.8g), Comino (0.3g), Queso crema (21.3g), Queso mozzarella (27.5g), Aguacate (100g), Jugo de lima (2.8g), Cilantro (3.8g), Tomate (27.5g), Crema agria (60g), Espinacas (57.5g)" },
  { mealType: "Almuerzo", name: "Pollo frito con mantequilla y br√≥coli", fat: 156.9, protein: 145.3, carbs: 22.2, kcal: 2111.3, ingredients: "Mantequilla (140g), Muslos de pollo (650g), Br√≥coli (450g), Puerro (45g), Ajo en polvo (2.5g)" },
  { mealType: "Almuerzo", name: "Quinoa Keto con Br√≥coli", fat: 59.1, protein: 33.5, carbs: 10.6, kcal: 733.4, ingredients: "Arroz de coliflor (100g), Br√≥coli (100g), Aguacate (70g), Semillas de lino (10g), Aceite de oliva (30g), Jugo de lim√≥n (20ml), Pechuga de pollo (80g), Nata para montar [o Crema de leche] (30g)" },
  { mealType: "Almuerzo", name: "Revuelto de Verduras", fat: 74.6, protein: 41.1, carbs: 5.4, kcal: 756.4, ingredients: "Huevos (100g, 2 unidades), Calabac√≠n [o Zapallo italiano] (100g), Champi√±ones (80g), Pechuga de pollo (80g), Aceite de oliva (30g), Mantequilla (20g), Aceite de coco (15g)" },
  { mealType: "Almuerzo", name: "Salm√≥n Ajo y Lim√≥n", fat: 68.7, protein: 34.3, carbs: 7.2, kcal: 780.5, ingredients: "Salm√≥n (150g), Ajo (3g), Jugo de lim√≥n (20ml), Aceite de oliva (30g), Br√≥coli (100g), Nata para montar [o Crema de leche] (50g), Eneldo (2g)" },
  { mealType: "Almuerzo", name: "Salm√≥n al Horno", fat: 66.9, protein: 33.2, carbs: 5.2, kcal: 753.9, ingredients: "Salm√≥n (150g), Br√≥coli (100g), Espinacas (50g), Aceite de oliva (30g), Mantequilla (20g)" },
  { mealType: "Almuerzo", name: "Salm√≥n al Vapor", fat: 84.9, protein: 33.9, carbs: 6.4, kcal: 720.2, ingredients: "Salm√≥n (150g), Br√≥coli (100g), Nata para montar [o Crema de leche] (30g), Aceite de oliva (20g), Mantequilla (20g), Aceite de coco (10g)" },
  { mealType: "Almuerzo", name: "Salm√≥n con Espinacas", fat: 67.5, protein: 33.7, carbs: 3.4, kcal: 751.9, ingredients: "Salm√≥n (150g), Aceite de oliva (30g), Romero (2g), Ajo (6g), Espinacas (200g), Jugo de lim√≥n (20ml), Mantequilla (20g), Coliflor (50g)" },
  { mealType: "Almuerzo", name: "Sardinas y Pollo Ensalada", fat: 66.8, protein: 40.6, carbs: 4.4, kcal: 791.6, ingredients: "Sardinas (80g), Tomate (30g), Pepino (30g), Apio (50g), Pechuga de pollo (60g), Aceite de oliva (30g), Nata para montar [o Crema de leche] (70g)" },
  { mealType: "Almuerzo", name: "Sopa de Calabaza Keto", fat: 63.1, protein: 37.6, carbs: 5.9, kcal: 757, ingredients: "Coliflor (100g), Pechuga de pollo (100g), Aceite de oliva (30g), Almendras (15g), C√∫rcuma (2g), Nata para montar [o Crema de leche] (60g)" },
  { mealType: "Almuerzo", name: "Sopa keto de mariscos", fat: 68.8, protein: 44.7, carbs: 12.6, kcal: 842.6, ingredients: "Mantequilla (15g), Ajo (3g), Apio (81.3g), Jugo de almeja (60g), Nata para montar [o Crema de leche] (87.5g), Salvia/Tomillo (0.7g), Jugo de lim√≥n (2.8g), Queso crema (27.5g), Salm√≥n (112.5g), Espinacas (13.8g), Camarones (57.5g), Hojuelas de chile rojo (0.7g)" },
  { mealType: "Almuerzo", name: "Tortilla de Esp√°rragos", fat: 64.2, protein: 39.9, carbs: 4, kcal: 761.4, ingredients: "Huevos (100g, 2 unidades), Esp√°rragos (100g), Pepino (30g), Pechuga de pollo (80g), Aceite de oliva (30g), Mantequilla (20g), Jugo de lim√≥n (20ml), Aceite de coco (5g)" },
  
  // ==== CENA ====
  { "mealType": "Cena", "name": "Alitas de Pollo Especiadas", "fat": 38, "protein": 25, "carbs": 1, "kcal": 410, "ingredients": "Alitas de pollo (150g), Mantequilla (20g), Aceite de oliva (15g), Especias (3g), Crema agria (30g)" },
{ "mealType": "Cena", "name": "Crema de Br√≥coli Keto", "fat": 61, "protein": 34, "carbs": 5, "kcal": 730, "ingredients": "Br√≥coli (200g), Coliflor (100g, para sustituir a la patata), Aceite de oliva (40g), C√∫rcuma (2g), Jengibre (2g), Nata para cocinar (50g), Pechuga de pollo (100g)" },
{ "mealType": "Cena", "name": "Ensalada C√©sar Keto", "fat": 61, "protein": 34, "carbs": 5, "kcal": 730, "ingredients": "Repollo morado (100g), Kale (100g), Nueces (15g), Semillas de s√©samo (10g), Aceite de oliva (40g), Zumo de lim√≥n (10ml), Mostaza (5g), Pechuga de pollo (150g)" },
{ "mealType": "Cena", "name": "Ensalada de Burrata Keto", "fat": 36, "protein": 10, "carbs": 4, "kcal": 390, "ingredients": "Burrata (50g), Aceitunas negras (30g), Nueces (15g), Aceite de oliva (30g), Vinagre bals√°mico (5g)" },
{ "mealType": "Cena", "name": "Ensalada de Repollo Keto", "fat": 60, "protein": 34, "carbs": 5, "kcal": 720, "ingredients": "Repollo morado (150g), Aguacate (70g), Nueces (15g), Semillas de girasol (15g), Aceite de oliva (40g), Vinagre de manzana (5ml), Jengibre (2g), Pechuga de pollo (150g)" },
{ "mealType": "Cena", "name": "Ensalada Mediterr√°nea Keto", "fat": 46, "protein": 14, "carbs": 4, "kcal": 480, "ingredients": "Aguacate (70g), Aceitunas negras (30g), Queso mozzarella (50g), Aceite de oliva (30g), Vinagre de vino (5g), Semillas de calabaza (10g)" },
{ "mealType": "Cena", "name": "Hamburguesa con Salsa Roquefort", "fat": 48, "protein": 42, "carbs": 6, "kcal": 650, "ingredients": "Carne molida de res (170g), Queso azul (50g), Nata para cocinar (50g), Pepinillos en vinagre (20g), Pimientos amarillos fermentados (20g), Tomates cherry (20g), Repollo morado (50g), Aguacate (50g)" },
{ "mealType": "Cena", "name": "Huevos Rellenos Keto (At√∫n)", "fat": 32, "protein": 24, "carbs": 2, "kcal": 370, "ingredients": "Huevos (100g, 2 unidades), At√∫n en aceite (50g), Queso crema (30g), Aceitunas negras (20g), Mayonesa (15g)" },
{ "mealType": "Cena", "name": "Merluza al Vapor", "fat": 60, "protein": 34, "carbs": 5, "kcal": 720, "ingredients": "Merluza (180g), Esp√°rragos (150g), Pepino (50g), Aceite de oliva (40g), Almendras (15g), Zumo de lim√≥n (20ml)" },
{ "mealType": "Cena", "name": "Merluza con Br√≥coli", "fat": 60, "protein": 34, "carbs": 5, "kcal": 720, "ingredients": "Merluza (180g), Br√≥coli (150g), Espinacas (50g), Aceite de oliva (40g), Almendras (15g), Mantequilla (20g)" },
{ "mealType": "Cena", "name": "Salm√≥n Papillote", "fat": 62, "protein": 36, "carbs": 5, "kcal": 740, "ingredients": "Salm√≥n (180g), Esp√°rragos (150g), Espinacas (50g), Aceite de oliva (40g), Mantequilla (20g), Zumo de lim√≥n (20ml)" },
{ "mealType": "Cena", "name": "Sardinas Ensalada Keto", "fat": 61, "protein": 34, "carbs": 5, "kcal": 730, "ingredients": "Sardinas (100g), Tomate (50g), Pepino (50g), Apio (50g), Aceite de oliva (40g), Mantequilla (20g)" },
{ "mealType": "Cena", "name": "Sopa de Calabaza Keto", "fat": 60, "protein": 35, "carbs": 5, "kcal": 720, "ingredients": "Coliflor (150g, para sustituir a la calabaza), Pechuga de pollo (150g), Aceite de oliva (40g), Almendras (15g), C√∫rcuma (2g), Nata para cocinar (50g)" },
{ "mealType": "Cena", "name": "Tortilla y Pollo Keto", "fat": 61, "protein": 34, "carbs": 5, "kcal": 730, "ingredients": "Huevos (150g, 3 unidades), Calabac√≠n (150g), Champi√±ones (100g), Pechuga de pollo (100g), Aceite de oliva (40g), Mantequilla (20g)" },
  // ==== SNACK ====
  { mealType: "Snack", name: "Batido Keto", fat: 28, protein: 15, carbs: 3, kcal: 350, ingredients: "Whey protein (20g), Almond milk (250ml), Avocado (50g), Almonds (10g), Coconut oil (15g)" },
  { mealType: "Snack", name: "Batido Verde Keto", fat: 29, protein: 14, carbs: 3, kcal: 360, ingredients: "Spinach (80g), Cucumber (100g), Lemon juice (10ml), Ginger (2g), Whey protein (20g), Olive oil (15g), Avocado (50g)" },
  { mealType: "Snack", name: "Bocaditos de Aguacate y Salm√≥n", fat: 29.6, protein: 13.1, carbs: 2.7, kcal: 337.7, ingredients: "Avocado (70g), smoked salmon (50g), cream cheese (20g), lemon juice (10ml), keto mayonnaise (10g), coconut oil (5g)" },
  { mealType: "Snack", name: "Chips de Queso", fat: 31.6, protein: 13.9, carbs: 0.9, kcal: 343.4, ingredients: "Cheddar cheese (50g), keto mayonnaise (10g), coconut oil (5g). Bake cheese at 200¬∞C for 5‚Äì7 min until crispy, serve with mayo and melted coconut oil dip." },
  { mealType: "Snack", name: "Claras y Almendras", fat: 28, protein: 15, carbs: 2, kcal: 350, ingredients: "Egg whites (100g, 3 units), Almonds (15g), Whey protein (20g), Coconut oil (15g)" },
  { mealType: "Snack", name: "Fat Bombs de Chocolate Keto", fat: 30.7, protein: 16.7, carbs: 3, kcal: 359.5, ingredients: "Cocoa butter (25g), unsweetened cocoa powder (5g), erythritol (5g), whey protein (20g), almond butter (10g). Melt cocoa butter, mix with cocoa powder, erythritol, whey protein, almond butter; chill in molds." },
  { mealType: "Snack", name: "Huevos Rellenos Keto", fat: 32.2, protein: 16.8, carbs: 2.1, kcal: 363, ingredients: "2 eggs (100g), keto mayonnaise (20g), mustard (5g), cream cheese (20g), paprika (1g). Hard-boil eggs, halve, mix yolks with mayo, mustard, cream cheese, coconut oil (5g); fill egg whites, sprinkle with paprika." },
  { mealType: "Snack", name: "Huevos y Nueces", fat: 28, protein: 15, carbs: 2, kcal: 350, ingredients: "Hard-boiled eggs (100g, 2 units), Walnuts (15g), Olive oil (15g)" },
  { mealType: "Snack", name: "K√©fir Keto", fat: 29, protein: 14, carbs: 3, kcal: 360, ingredients: "Coconut kefir (150g), Avocado (50g), Whey protein (20g), Almonds (10g), Coconut oil (10g)" },
  { mealType: "Snack", name: "Mini Tortillas de Huevo", fat: 30.1, protein: 21.6, carbs: 1.3, kcal: 314.8, ingredients: "Eggs (100g, 2 units), cheddar cheese (30g), spinach (20g), keto mayonnaise (10g), coconut oil (5g). Mix eggs, cheese, spinach, mayo; bake in mini muffin tins at 180¬∞C for 10‚Äì12 min, drizzle with coconut oil." },
  { mealType: "Snack", name: "Nueces y Almendras Tostadas", fat: 38.1, protein: 15.5, carbs: 2.4, kcal: 297.4, ingredients: "Almonds (20g), walnuts (20g), cheddar cheese (25g), salt (1g). Toast nuts with salt, serve with shredded cheese." },
  { mealType: "Snack", name: "Palitos de Apio con Dip", fat: 34.2, protein: 9.6, carbs: 2.8, kcal: 366.2, ingredients: "Celery (100g), keto mayonnaise (30g), cream cheese (10g), cheddar cheese (20g). Mix mayo and cream cheese as dip, serve with celery and shredded cheese." },
  { mealType: "Snack", name: "Pepitas de Calabaza Tostadas", fat: 32.2, protein: 14.3, carbs: 1.7, kcal: 354.2, ingredients: "Pumpkin seeds (25g), olive oil (10g), cheddar cheese (30g), salt (1g). Toast seeds in olive oil with salt, serve with shredded cheese." },
  { mealType: "Snack", name: "Rollitos de Jam√≥n y Queso", fat: 30.9, protein: 21.8, carbs: 1.8, kcal: 377.3, ingredients: "Jam√≥n serrano (60g), cream cheese (40g), keto mayonnaise (10g), coconut oil (5g). Spread cream cheese and mayo on jam√≥n, roll up, drizzle with melted coconut oil." },
  { mealType: "Snack", name: "Semillas y Frutos", fat: 29, protein: 14, carbs: 3, kcal: 360, ingredients: "Pumpkin seeds (20g), Blackberries (50g, reduced), Whey protein (20g), Olive oil (15g)" },
  { mealType: "Snack", name: "Snack Quesos", fat: 22, protein: 13, carbs: 2, kcal: 280, ingredients: "Goat cheese roll (20g), Edam cheese (40g), Cherry tomatoes (30g), Arugula (15g)" },
  { mealType: "Snack", name: "Yogur Keto con Frutos", fat: 28, protein: 14, carbs: 3, kcal: 350, ingredients: "Coconut yogurt (150g), Blackberries (50g, reduced), Almonds (15g), Flax seeds (10g)" },

  // ==== SNACK POST-ENTRENAMIENTO ====
  { mealType: "Snack", name: "Batido Post-Keto", fat: 28, protein: 15, carbs: 3, kcal: 350, ingredients: "Whey protein (20g), Almond milk (250ml), Avocado (50g), Almonds (10g), Coconut oil (15g)" },
  { mealType: "Snack", name: "Batido Post-Keto Plus", fat: 30, protein: 16, carbs: 3, kcal: 370, ingredients: "Whey protein (25g), Almond milk (300ml), Avocado (50g), Almonds (15g), Coconut oil (15g)" },

  // ==== SNACK (Barritas) ====
  { mealType: "Snack", name: "Barritas Keto", fat: 29, protein: 14, carbs: 3, kcal: 360, ingredients: "Hemp protein (40g), Almonds (20g), Chia seeds (10g), Egg whites (60g), Coconut oil (15g), Green banana flour (10g)" },

  // ==== SNACK (Sanak 1) ====
  { mealType: "Snack", name: "Manzana Keto", fat: 28, protein: 14, carbs: 3, kcal: 350, ingredients: "Avocado (70g, sub for apple), Walnuts (10g), Almonds (10g), Whey protein (20g), Water (200ml)" },

  // ==== LIMPIEZA ====
  { mealType: "Snack", name: "Barritas Sin Granos", fat: 29, protein: 14, carbs: 3, kcal: 360, ingredients: "Hemp protein (40g), Almonds (20g), Green banana flour (20g), Chia seeds (10g), Egg whites (60g), Coconut oil (15g)" },
  { mealType: "Snack", name: "Batido Ultrafermentado", fat: 30, protein: 14, carbs: 3, kcal: 370, ingredients: "Broccoli (50g), Spinach (100g), Cucumber (75g), Fermented mustard seeds (5g), Chia seeds (10g), Avocado (50g, sub for apple), Kombucha (250ml), Hemp protein (40g)" },
  { mealType: "Snack", name: "Batido Verde Reprobi√≥tico", fat: 29, protein: 14, carbs: 3, kcal: 360, ingredients: "Hemp protein (30g), Coconut water kefir (200ml), Spinach (50g), Avocado (50g, sub for kiwi), Chia seeds (10g), Almond butter (10g), Green banana flour (10g), Cinnamon (1g), Turmeric (1g)" },
  { mealType: "Snack", name: "Jugo Verde y Ch√≠a Keto", fat: 29, protein: 14, carbs: 3, kcal: 360, ingredients: "Spinach (80g), Cucumber (50g), Celery (50g), Ginger (2g), Lemon juice (10ml), Chia seeds (20g), Coconut milk (100ml), Inulin (5g), Collagen protein (30g), Walnuts (10g)" },
  { mealType: "Snack", name: "Tostadas Sin Granos", fat: 29, protein: 15, carbs: 3, kcal: 360, ingredients: "Almond flour (30g), Psyllium husk (5g), Eggs (100g, 2 units), Avocado (70g), Tomato (50g), Sunflower seeds (15g), Coconut oil (15g), Ginger-lemon infusion (200ml)" },
  { mealType: "Snack", name: "Yogur Probi√≥tico Keto", fat: 28, protein: 14, carbs: 3, kcal: 350, ingredients: "Coconut yogurt (150g), Blackberries (50g), Almonds (10g), Flax seeds (10g)" },

  // ==== RECETAS ====
  { mealType: "Recetas", name: "Burger pizza", fat: 59.3, protein: 50.4, carbs: 5.0, kcal: 773, ingredients: "Carne molida de res (200g), Tomate (50g), Lechuga (50g), Cebolla fermentada (20g), Chucrut (25g), Queso cheddar (50g), Huevo (25g), Sal (3.75ml), Pimienta (1.25ml)" },
  { mealType: "Recetas", name: "Coca de recapte o con escalibada", fat: 41.0, protein: 53.4, carbs: 14.2, kcal: 612.5, ingredients: "Pimiento rojo (70g), Berenjena (100g), Cebolla blanca (55g), Ajo (6g), Aceite de oliva (13.5g), At√∫n (92.5g), Queso parmesano (50g), C√°scara de psyllium (4.5g), Huevo (50g), Sal (pizca), Or√©gano (2.5ml), Ajo en polvo (2.5ml), Anchoas (25g)" },
  { mealType: "Recetas", name: "Meatza con doble de queso y champi√±ones", fat: 41.9, protein: 66.2, carbs: 5.6, kcal: 681.5, ingredients: "Pavo molido (225g), Queso parmesano (22.5g), Huevo (25g), Sal (2.5ml), Cebolla en polvo (2.5ml), Pimienta (1.25ml), Salsa de tomate (30g), Ajo en polvo (1.25ml), Champi√±ones (42.5g), Queso mozzarella (70g), Or√©gano (0.75g)" },
  { mealType: "Recetas", name: "Pan Suizo Keto", fat: 16, protein: 6, carbs: 3, kcal: 180, ingredients: "Harina de almendras (150g), Harina de coco (50g), Polvo de hornear (4g), Sal (3g), Huevos (250g, 5 unidades, yemas y claras separadas), Aceite de oliva o mantequilla derretida (74g), Leche de almendras sin az√∫car (80g), Vinagre de sidra de manzana (5g), Semillas de s√©samo o lino (10g)" },
  { mealType: "Recetas", name: "Pizza low-carb de calabac√≠n con pepperoni", fat: 184.8, protein: 165.2, carbs: 40.9, kcal: 2577.5, ingredients: "Calabac√≠n [o Zapallo italiano] (650g), Huevos (100g), Queso mozzarella (110g), Polvo de hornear (4g), Pimienta (5ml), Or√©gano (5ml), Salsa de tomate (120g), Queso mozzarella (475g), Pepperoni (85g), Pimientos verdes (110g), Aceitunas (70g), Or√©gano (15ml)" },
  { mealType: "Recetas", name: "Pan de taza keto (1 porci√≥n)", fat: 24.8, protein: 6.4, carbs: 2.1, kcal: 269.2, ingredients: "Mantequilla (14g), Harina de almendras (7g), Harina de coco (7g), Polvo de hornear (3.75g), Semillas de amapola (1.5g), Sal (pizca), Huevo (50g), Nata para montar [o Crema de leche] (15g)" },
  { mealType: "Recetas", name: "Pan focaccia (1 porci√≥n)", fat: 23.6, protein: 10.2, carbs: 2.3, kcal: 268, ingredients: "Queso mozzarella (21.3g), Queso crema (3.5g), Vinagre de vino blanco (0.6g), Huevo (6.3g), Harina de almendras (22.5g), Sal (0.6g), Ajo en polvo (0.2g), Mantequilla (6.9g), Ajo (1.1g), Romero (0.1g)" },
  { mealType: "Recetas", name: "Pan keto (1 porci√≥n)", fat: 17.3, protein: 8.8, carbs: 2.0, kcal: 211.8, ingredients: "Harina de almendras (23.3g), Semillas de lino (8.3g), Polvo de hornear (1.3g), Sal marina (1g), Vinagre de sidra de manzana (1.7g), Clara de huevo (16.7g), Semillas de s√©samo (3g)" },
  { mealType: "Recetas", name: "Pan keto sin frutos secos (1 porci√≥n)", fat: 6.9, protein: 6.2, carbs: 0.8, kcal: 98.7, ingredients: "Huevos (30g), Queso mozzarella (16.3g), Queso crema (1.5g), Semillas de lino (1.5g), Polvo de hornear (0.5g), Fibra de avena (2.8g), Sal (0.3g), Mantequilla (0.5g), Semillas de s√©samo (1.4g), Semillas de amapola (0.9g)" }


]));



function saveRecipes() {
  localStorage.setItem('keto_recipes', JSON.stringify(recipes));
  $("#status").textContent = "Guardado";
  setTimeout(() => $("#status").textContent = "Listo", 1200);
}

function renderRecipes() {
  const accordion = document.querySelector("#recipesAccordion");
  if (!accordion) {
    console.error("Error: #recipesAccordion not found in the DOM");
    return;
  }
  accordion.innerHTML = '';

  const mealTypes = [
    'Desayuno', 'Almuerzo', 'Cena', 'Snack', 'Snack Post-Entrenamiento',
    'Snack (Barritas)', 'Snack (Sanak 1)', 'Limpieza', 'Recetas'
  ];
  mealTypes.forEach(mealType => {
    const recipesForType = recipes.filter(r => r.mealType === mealType);
    if (recipesForType.length === 0) return;

    const tab = document.createElement('div');
    tab.className = 'accordion-tab';

    const header = document.createElement('div');
    header.className = 'accordion-header';
    header.setAttribute('data-meal-type', mealType);
    header.textContent = mealType;
    tab.appendChild(header);

    const content = document.createElement('div');
    content.className = 'accordion-content';
    content.setAttribute('data-meal-type', mealType);

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th>Tipo de Comida</th>
        <th>Nombre</th>
        <th>Grasas (g)</th>
        <th>Prote√≠nas (g)</th>
        <th>Carbohidratos (g)</th>
        <th>Kcal</th>
        <th>Ingredientes</th>
      </tr>
    `;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    recipesForType.forEach(recipe => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${recipe.mealType}</td>
        <td>${recipe.name}</td>
        <td class="right">${fmt(recipe.fat)}</td>
        <td class="right">${fmt(recipe.protein)}</td>
        <td class="right">${fmt(recipe.carbs)}</td>
        <td class="right">${fmt(recipe.kcal)}</td>
        <td>${recipe.ingredients}</td>
      `;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    content.appendChild(table);
    tab.appendChild(content);
    accordion.appendChild(tab);
  });

  // Initialize accordion listeners
  initializeAccordion();
}
function initializeAccordion() {
  const headers = document.querySelectorAll('.accordion-header');
  headers.forEach(header => {
    header.addEventListener('click', () => {
      const content = header.nextElementSibling;
      const isActive = content.classList.contains('active');

      // Close all tabs
      document.querySelectorAll('.accordion-content').forEach(c => {
        c.classList.remove('active');
      });
      document.querySelectorAll('.accordion-header').forEach(h => {
        h.classList.remove('active');
      });

      // Toggle clicked tab
      if (!isActive) {
        content.classList.add('active');
        header.classList.add('active');
      }
    });
  });
}
function addRecipeTableListeners() {
  const tables = document.querySelectorAll("#recipesAccordion .accordion-content table");
  if (tables.length === 0) {
    console.warn("Warning: No tables found in #recipesAccordion");
    return;
  }
  tables.forEach(table => {
    const rows = table.querySelectorAll("tbody tr");
    rows.forEach((row, index) => {
      row.addEventListener('click', () => {
        console.log(`Row ${index} clicked:`, row.cells[1].textContent);
        const mealType = row.cells[0].textContent;
        const recipeName = row.cells[1].textContent;
        const ingredientsStr = row.cells[6].textContent;

        let ingredients;
        try {
          ingredients = ingredientsStr.split(', ').map(ing => {
            const match = ing.match(/^(.+?)\s*\((\d+\.?\d*g|ml)\)$/i);
            if (!match) {
              console.warn(`Invalid ingredient format: ${ing}`);
              return null;
            }
            const name = match[1].trim();
            const grams = parseFloat(match[2]);
            const food = FOOD_DB.find(f => f.name.toLowerCase() === name.toLowerCase()) || {
              fat_per_100g: 0, protein_per_100g: 0, netcarbs_per_100g: 0, kcal_per_100g: 0
            };
            return {
              name,
              grams,
              fat: food.fat_per_100g * grams / 100,
              protein: food.protein_per_100g * grams / 100,
              carbs: food.netcarbs_per_100g * grams / 100,
              kcal: food.kcal_per_100g * grams / 100
            };
          }).filter(ing => ing !== null);
        } catch (err) {
          console.error("Error parsing ingredients:", err);
          alert("Error al procesar los ingredientes de la receta.");
          return;
        }

        if (ingredients.length === 0) {
          console.error("No valid ingredients parsed from:", ingredientsStr);
          alert("No se pudieron parsear los ingredientes de la receta.");
          return;
        }

        let timeOfDay = prompt('Introduce el momento del d√≠a (Desayuno, Almuerzo, Cena, Snack):');
        if (!['Desayuno', 'Almuerzo', 'Cena', 'Snack'].includes(timeOfDay)) {
          console.warn("Invalid timeOfDay entered:", timeOfDay);
          alert('Momento del d√≠a no v√°lido. Usa: Desayuno, Almuerzo, Cena, Snack.');
          return;
        }
        let day = prompt('Introduce el d√≠a de la semana (Lunes, Martes, Mi√©rcoles, Jueves, Viernes, S√°bado, Domingo):');
        if (!['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'].includes(day)) {
          console.warn("Invalid day entered:", day);
          alert('D√≠a no v√°lido. Usa: Lunes, Martes, Mi√©rcoles, Jueves, Viernes, S√°bado, Domingo.');
          return;
        }

        try {
          addToWeeklyPlan({ name: recipeName, timeOfDay, recipe: ingredients });
          console.log(`Recipe ${recipeName} added to ${day} - ${timeOfDay}`);
        } catch (err) {
          console.error("Error adding to weekly plan:", err);
          alert("Error al a√±adir la receta al plan semanal.");
        }
      });
    });
  });
}

document.addEventListener('DOMContentLoaded', () => {
    const addRecipeForm = document.querySelector("#addRecipeForm");
    if (!addRecipeForm) {
        console.error("Error: #addRecipeForm not found in the DOM");
        return;
    }
    addRecipeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const recipeName = document.querySelector("#recipeName").value.trim();
        const mealType = document.querySelector("#mealType").value;
        const fat = parseFloat(document.querySelector("#fatInput").value);
        const protein = parseFloat(document.querySelector("#proteinInput").value);
        const carbs = parseFloat(document.querySelector("#carbsInput").value);
        const kcal = parseFloat(document.querySelector("#kcalInput").value);
        let ingredients = document.querySelector("#ingredientsInput").value.trim();

        // Validate inputs
        if (!recipeName || isNaN(fat) || isNaN(protein) || isNaN(carbs) || isNaN(kcal) || !ingredients) {
            alert("Por favor, completa todos los campos correctamente.");
            return;
        }

        // Log ingredients for debugging
        console.log("Raw ingredients input:", ingredients);

        // Normalize commas to periods for consistent validation
        ingredients = ingredients.replace(/,/g, '.');

        // Log normalized ingredients for debugging
        console.log("Normalized ingredients input:", ingredients);

        // Validate ingredients format
        const validIngredients = ingredients.split(', ').every(ing => {
            return ing.match(/^(.*?)\s*\(?(\d+\.?\d{0,2})\s*(g|ml)\)?$/i);
        });
        if (!validIngredients) {
            alert("Formato de ingredientes inv√°lido. Usa: Ingrediente (Xg) o Ingrediente (Xml), separados por comas.");
            return;
        }

        // Add recipe
        recipes.push({ mealType, name: recipeName, fat, protein, carbs, kcal, ingredients });
        saveRecipes();
        renderRecipes();

        // Reset form
        addRecipeForm.reset();
    });
});

document.querySelector("#clearRecipeForm").addEventListener('click', () => {
  document.querySelector("#addRecipeForm").reset();
});

// Initial render
renderDB();
renderRecipe();
renderWeeklyPlan();
renderShoppingList();
renderRecipes();

// === Funcionalidad para mostrar gr√°fico nutricional diario ===
// A√±adir event listeners para doble click en celdas de d√≠a
document.querySelectorAll('#weeklyPlanTable td[data-day]').forEach(cell => {
  cell.addEventListener('dblclick', showDailyNutrition);
});

// Funci√≥n para mostrar el modal con la informaci√≥n nutricional
function showDailyNutrition(event) {
  const dayCell = event.target.closest('td[data-day]');
  if (!dayCell) {
    console.error('No se encontr√≥ el elemento td con atributo data-day');
    return;
  }

  let day = dayCell.getAttribute('data-day');
  if (!day) {
    console.warn('data-day no definido, intentando obtener desde modalNutritionTitle');
    const title = document.getElementById('modalNutritionTitle').textContent;
    const match = title.match(/Informaci√≥n Nutricional del (\w+)/);
    day = match ? match[1] : null;
  }

  if (!day || !DAYS.includes(day)) {
    console.error('D√≠a no v√°lido:', day);
    alert('Error: No se pudo determinar el d√≠a para mostrar la informaci√≥n nutricional.');
    return;
  }

  const nutritionData = calculateDailyNutrition(day);

  if (nutritionData.kcal === 0) {
    alert(`No hay datos nutricionales para el ${day}`);
    return;
  }

  document.getElementById('modalNutritionTitle').textContent = `Informaci√≥n Nutricional del ${day}`;
  document.getElementById('dailyKetoRatio').textContent = nutritionData.ketoRatio.toFixed(2);

  const totalGrams = nutritionData.fat + nutritionData.protein + nutritionData.carbs;
  const fatPercentage = totalGrams > 0 ? Math.round((nutritionData.fat * 9 / nutritionData.kcal) * 100) : 0;
  const proteinPercentage = totalGrams > 0 ? Math.round((nutritionData.protein * 4 / nutritionData.kcal) * 100) : 0;
  const carbsPercentage = totalGrams > 0 ? Math.round((nutritionData.carbs * 4 / nutritionData.kcal) * 100) : 0;

  generateNutritionAdvice(fatPercentage, proteinPercentage, carbsPercentage, nutritionData.ketoRatio, nutritionData, day);

  const modal = document.getElementById('dailyNutritionModal');
  modal.style.display = 'flex';

  setTimeout(() => {
    renderNutritionChart(nutritionData);
  }, 100);
}

// === Funcionalidad para mostrar gr√°fico nutricional diario ===
// A√±adir event listeners para doble click en celdas de d√≠a
document.querySelectorAll('#weeklyPlanTable td[data-day]').forEach(cell => {
  cell.addEventListener('dblclick', showDailyNutrition);
});

// Funci√≥n para mostrar el modal con la informaci√≥n nutricional
function showDailyNutrition(event) {
  const dayCell = event.target.closest('td[data-day]');
  if (!dayCell) {
    console.error('No se encontr√≥ el elemento td con atributo data-day');
    return;
  }

  let day = dayCell.getAttribute('data-day');
  if (!day) {
    console.warn('data-day no definido, intentando obtener desde modalNutritionTitle');
    const title = document.getElementById('modalNutritionTitle').textContent;
    const match = title.match(/Informaci√≥n Nutricional del (\w+)/);
    day = match ? match[1] : null;
  }

  if (!day || !DAYS.includes(day)) {
    console.error('D√≠a no v√°lido:', day);
    alert('Error: No se pudo determinar el d√≠a para mostrar la informaci√≥n nutricional.');
    return;
  }

  const nutritionData = calculateDailyNutrition(day);

  if (nutritionData.kcal === 0) {
    alert(`No hay datos nutricionales para el ${day}`);
    return;
  }

  document.getElementById('modalNutritionTitle').textContent = `Informaci√≥n Nutricional del ${day}`;
  document.getElementById('dailyKetoRatio').textContent = nutritionData.ketoRatio.toFixed(2);

  const totalGrams = nutritionData.fat + nutritionData.protein + nutritionData.carbs;
  const fatPercentage = totalGrams > 0 ? Math.round((nutritionData.fat * 9 / nutritionData.kcal) * 100) : 0;
  const proteinPercentage = totalGrams > 0 ? Math.round((nutritionData.protein * 4 / nutritionData.kcal) * 100) : 0;
  const carbsPercentage = totalGrams > 0 ? Math.round((nutritionData.carbs * 4 / nutritionData.kcal) * 100) : 0;

  generateNutritionAdvice(fatPercentage, proteinPercentage, carbsPercentage, nutritionData.ketoRatio, nutritionData, day);

  const modal = document.getElementById('dailyNutritionModal');
  modal.style.display = 'flex';

  setTimeout(() => {
    renderNutritionChart(nutritionData);
  }, 100);
}

// Funci√≥n para generar consejos nutricionales personalizados
// Funci√≥n para generar consejos nutricionales personalizados
function generateNutritionAdvice(fatPct, proteinPct, carbsPct, ketoRatio, nutritionData, day) {
  const adviceContainer = document.getElementById('adviceContent');
  adviceContainer.innerHTML = '';

  const dailyKcal = (nutritionData.fat * 9) + (nutritionData.protein * 4) + (nutritionData.carbs * 4);

  const idealFat = 70;
  const idealProtein = 25;
  const idealCarbs = 4;

  const currentDistrib = document.createElement('p');
  currentDistrib.innerHTML = `<strong>Distribuci√≥n actual:</strong> ${fatPct}% Grasas, ${proteinPct}% Prote√≠nas, ${carbsPct}% HC netos`;
  adviceContainer.appendChild(currentDistrib);

  const idealDistrib = document.createElement('p');
  idealDistrib.innerHTML = `<strong>Objetivo cetog√©nico:</strong> ${idealFat}% Grasas, ${idealProtein}% Prote√≠nas, ${idealCarbs}% HC netos`;
  idealDistrib.style.marginBottom = '15px';
  adviceContainer.appendChild(idealDistrib);

  const adviceList = document.createElement('ul');
  adviceList.style.paddingLeft = '20px';

  // Consejo sobre grasas
  if (fatPct < idealFat - 5) {
    const advice = document.createElement('li');
    advice.innerHTML = `<strong>Grasas:</strong> Aumenta fuentes saludables como aguacate, aceite de oliva, frutos secos y pescados grasos. Las grasas son tu principal fuente de energ√≠a en cetosis.`;
    adviceList.appendChild(advice);
  } else if (fatPct > idealFat + 5) {
    const advice = document.createElement('li');
    advice.innerHTML = `<strong>Grasas:</strong> Considera moderar el exceso de grasas si buscas p√©rdida de peso. La cetosis se mantiene con grasas moderadas, no necesariamente alt√≠simas.`;
    adviceList.appendChild(advice);
  }

  // Consejo sobre prote√≠nas
  let maxProteinPct;
  if (carbsPct >= 4) maxProteinPct = 30;
  else if (carbsPct >= 3) maxProteinPct = 32;
  else if (carbsPct >= 2) maxProteinPct = 34;
  else if (carbsPct >= 1) maxProteinPct = 36;
  else maxProteinPct = 38;

  if (proteinPct < idealProtein - 5) {
    const advice = document.createElement('li');
    advice.innerHTML = `<strong>Prote√≠nas:</strong> Aumenta prote√≠nas magras como pollo, pescado, huevos y tofu (1.6-2.2 g/kg de peso corporal). La prote√≠na preserva masa muscular durante la cetosis (Pasiakos et al., 2013). M√°ximo permitido: ${maxProteinPct}% para ${carbsPct.toFixed(1)}% HC.`;
    adviceList.appendChild(advice);
  } else if (proteinPct > maxProteinPct) {
    const advice = document.createElement('li');
    advice.innerHTML = `<strong>Prote√≠nas:</strong> Excedes el m√°ximo de ${maxProteinPct}% para ${carbsPct.toFixed(1)}% HC. El exceso puede convertirse en glucosa (gluconeog√©nesis), afectando la cetosis. Reduce las porciones.`;
    adviceList.appendChild(advice);
  } else if (proteinPct > idealProtein + 5) {
    const advice = document.createElement('li');
    advice.innerHTML = `<strong>Prote√≠nas:</strong> Est√°s cerca del l√≠mite de ${maxProteinPct}% para ${carbsPct.toFixed(1)}% HC. Modera las porciones para optimizar cetosis.`;
    adviceList.appendChild(advice);
  }

  // Consejo sobre carbohidratos
  let carbAdviceText = '';
  if (carbsPct <= 4) {
    carbAdviceText = `<strong>Carbohidratos:</strong> Tu ingesta (${carbsPct.toFixed(1)}%) est√° en el rango cetog√©nico estricto (<20 g/d√≠a, <4% energ√≠a), ideal para cetosis profunda (Volek et al., 2008). Mant√©n este nivel para maximizar la quema de grasa.`;
  } else if (carbsPct <= 10) {
    carbAdviceText = `<strong>Carbohidratos:</strong> Tu ingesta (${carbsPct.toFixed(1)}%) est√° en el rango moderado (20-50 g/d√≠a, 4-10% energ√≠a). Ajusta a <20 g/d√≠a si buscas cetosis estricta, revisando vegetales ricos en almid√≥n (Volek et al., 2008).`;
  } else if (carbsPct <= 20) {
    carbAdviceText = `<strong>Carbohidratos:</strong> Tu ingesta (${carbsPct.toFixed(1)}%) est√° en el rango liberal (50-100 g/d√≠a, 10-20% energ√≠a). Reduce a <20-50 g/d√≠a para cetosis efectiva, evitando frutas y carbohidratos refinados.`;
  } else {
    carbAdviceText = `<strong>Carbohidratos:</strong> Tu ingesta (${carbsPct.toFixed(1)}%) excede el rango cetog√©nico (>20%). Reduce a <20 g/d√≠a (<4% energ√≠a) para inducir cetosis, eliminando vegetales ricos en almid√≥n y frutas (Volek et al., 2008).`;
  }
  const carbAdvice = document.createElement('li');
  carbAdvice.innerHTML = carbAdviceText;
  adviceList.appendChild(carbAdvice);

  // Informaci√≥n sobre tipos de dietas bajas en carbohidratos
  const dietTypesInfo = document.createElement('li');
  dietTypesInfo.innerHTML = `<strong>Tipos de dietas bajas en carbohidratos:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Moderada en carbohidratos:</strong> 100‚Äì150 g/d√≠a (26‚Äì45% kcal) - Para p√©rdida gradual o control de glucosa flexible.</li>
      <li><strong>Baja en carbohidratos (LCD):</strong> 50‚Äì100 g/d√≠a (10‚Äì25% kcal) - Para sobrepeso, resistencia a insulina, s√≠ndrome metab√≥lico.</li>
      <li><strong>Muy baja en carbohidratos/Cetog√©nica (VLCKD):</strong> <50 g/d√≠a (5‚Äì10% kcal) - Para obesidad con s√≠ndrome metab√≥lico, diabetes tipo 2, epilepsia.</li>
    </ul>`;
  adviceList.appendChild(dietTypesInfo);

  // Consejo sobre ratio cetog√©nico
  const ratioAdvice = document.createElement('li');
  if (ketoRatio < 1.0) {
    ratioAdvice.innerHTML = `<strong>Ratio cetog√©nico (${ketoRatio.toFixed(1)}):</strong> Demasiado bajo. Necesitas aumentar grasas y/o reducir prote√≠nas+HC para alcanzar cetosis nutricional.`;
  } else if (ketoRatio >= 1.0 && ketoRatio < 2.0) {
    ratioAdvice.innerHTML = `<strong>Ratio cetog√©nico (${ketoRatio.toFixed(1)}):</strong> Nivel moderado. Est√°s en cetosis pero podr√≠as optimizarla aumentando ligeramente las grasas.`;
  } else {
    ratioAdvice.innerHTML = `<strong>Ratio cetog√©nico (${ketoRatio.toFixed(1)}):</strong> Excelente! Mantienes un ratio √≥ptimo para cetosis terap√©utica seg√∫n estudios cl√≠nicos.`;
  }
  adviceList.appendChild(ratioAdvice);

  // Consejo sobre d√©ficit cal√≥rico
  const calorieAdvice = document.createElement('li');
  calorieAdvice.innerHTML = `<strong>D√©ficit cal√≥rico:</strong> Tu ingesta total el ${day} es de <strong>${Math.round(dailyKcal)} kcal</strong>. Para p√©rdida de grasa, mant√©n un d√©ficit moderado (10-20% de tu gasto energ√©tico diario, ~300-500 kcal). Esto maximiza la oxidaci√≥n de grasas sin p√©rdida muscular (Bueno et al., 2013). A continuaci√≥n, estimaciones para tres perfiles que buscan perder peso (suponiendo sedentarismo, edad 35 a√±os, altura 170 cm):<br>
    <ul style="padding-left: 20px;">
      <li><strong>Sobrepeso (BMI 25‚Äì29.9, ~75 kg, 25% grasa corporal):</strong> Gasto estimado ~1,900 kcal/d√≠a. Para perder ~0.5 kg/semana (bajo), apunta a ~1,400 kcal; ~0.75 kg/semana (medio), ~1,150 kcal; ~1 kg/semana (alto), ~900 kcal.</li>
      <li><strong>Obeso Tipo 1 (BMI 30‚Äì34.9, ~95 kg, 30% grasa corporal):</strong> Gasto estimado ~2,200 kcal/d√≠a. Para ~0.5 kg/semana, apunta a ~1,700 kcal; ~0.75 kg/semana, ~1,450 kcal; ~1 kg/semana, ~1,200 kcal.</li>
      <li><strong>Obeso Tipo 2 (BMI 35‚Äì39.9, ~115 kg, 35% grasa corporal):</strong> Gasto estimado ~2,400 kcal/d√≠a. Para ~0.5 kg/semana, apunta a ~1,900 kcal; ~0.75 kg/semana, ~1,650 kcal; ~1 kg/semana, ~1,400 kcal.</li>
    </ul>
    <em>Nota:</em> No consumas menos de 1,200 kcal (mujeres) o 1,500 kcal (hombres) sin supervisi√≥n m√©dica. Ajusta seg√∫n tu peso, actividad y objetivos.`;
  adviceList.appendChild(calorieAdvice);

  // Beneficios y riesgos de la dieta cetog√©nica
  const benefitsRisksAdvice = document.createElement('li');
  benefitsRisksAdvice.innerHTML = `<strong>Beneficios y riesgos de la cetosis:</strong>
    <strong>Beneficios conocidos (corto-mediano plazo):</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li>P√©rdida de peso y grasa corporal, especialmente visceral y hep√°tica</li>
      <li>Mejora de la sensibilidad a la insulina y niveles de glucosa</li>
      <li>Reducci√≥n de triglic√©ridos y aumento del colesterol HDL</li>
      <li>Disminuci√≥n del apetito y control espont√°neo de la ingesta cal√≥rica</li>
    </ul>
    <strong>Possibles riesgos a largo plazo:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Deficiencias nutricionales:</strong> D√©ficit de fibra, vitaminas (C, B9), minerales (magnesio, potasio)</li>
      <li><strong>Problemas digestivos:</strong> Estre√±imiento frecuente por bajo consumo de fibra</li>
      <li><strong>Alteraciones en el colesterol LDL:</strong> Aumento en 10-30% de personas</li>
      <li><strong>Estr√©s hep√°tico o renal:</strong> En personas susceptibles puede empeorar condiciones preexistentes</li>
    </ul>`;
  adviceList.appendChild(benefitsRisksAdvice);

  // Prolongaci√≥n de la fase de inducci√≥n cetog√©nica
  const extendedInductionAdvice = document.createElement('li');
  extendedInductionAdvice.innerHTML = `<strong>Prolongaci√≥n de la fase de inducci√≥n cetog√©nica (12‚Äì18 semanas):</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>En obesidad, s√≠ndrome metab√≥lico y diabetes tipo 2:</strong> Ensayos de 12‚Äì24 semanas con cetog√©nica muy baja en carbohidratos muestran reducciones significativas de peso, triglic√©ridos, glucosa e insulina m√°s all√° de las 6 semanas iniciales.</li>
      <li><strong>Evidencia a largo plazo:</strong> En varios estudios con seguimiento hasta 6‚Äì12 meses, los beneficios metab√≥licos se mantienen, aunque la adherencia disminuye en algunos pacientes.</li>
      <li><strong>Riesgo principal:</strong> En una parte de los sujetos aumenta el LDL-C/ApoB, por lo que se recomienda monitorizar l√≠pidos y ajustar el tipo de grasas (m√°s monoinsaturadas y omega-3, menos saturadas).</li>
      <li><strong>Conclusi√≥n:</strong> S√≠ se puede prolongar a 12‚Äì18 semanas siempre que haya supervisi√≥n cl√≠nica y nutricional, y se controlen biomarcadores.</li>
    </ul>`;
  adviceList.appendChild(extendedInductionAdvice);

  // Ciclado metab√≥lico a largo plazo
  const metabolicCyclingAdvice = document.createElement('li');
  metabolicCyclingAdvice.innerHTML = `<strong>Ciclado metab√≥lico a largo plazo:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Carb cycling / targeted keto:</strong> Baja en carbohidratos la mayor parte del tiempo + aporte de carbohidratos en entrenos. Tiene l√≥gica fisiol√≥gica s√≥lida: se aprovechan los beneficios de la cetosis en descanso (oxidaci√≥n de grasa, control gluc√©mico) y se protege el rendimiento f√≠sico con carbohidratos estrat√©gicos en entreno.</li>
      <li><strong>Evidencia:</strong> En estudios cortos (6‚Äì12 semanas) ha mostrado mantener masa muscular y fuerza, con mejoras en composici√≥n corporal. A largo plazo (meses-a√±os) la evidencia a√∫n es limitada, pero es razonable pensar que mejora la adherencia frente a una cetosis cr√≥nica estricta, y que reduce riesgos de d√©ficits nutricionales.</li>
      <li><strong>En deporte:</strong> La cetosis cr√≥nica penaliza esfuerzos de alta intensidad. El ciclado permite combinar lo mejor de ambos mundos: flexibilidad metab√≥lica (usar grasas en reposo y carbohidratos en entreno).</li>
    </ul>
    <strong>Recomendaci√≥n pr√°ctica:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Reset metab√≥lico:</strong> Puede extenderse a 12‚Äì18 semanas si se tolera bien, con monitorizaci√≥n (peso, HbA1c, TG, HDL, LDL/ApoB, enzimas hep√°ticas).</li>
      <li><strong>Ciclado a largo plazo:</strong> Probablemente sea la estrategia m√°s sostenible, sobre todo si se busca mantener salud metab√≥lica + rendimiento f√≠sico + adherencia social.</li>
    </ul>`;
  adviceList.appendChild(metabolicCyclingAdvice);

  // NUEVO: Ciclos hiperproteicos combinados con ciclado de HC y cetosis
  const highProteinCyclingAdvice = document.createElement('li');
  highProteinCyclingAdvice.innerHTML = `<strong>Combinaci√≥n de ciclos hiperproteicos con ciclado de HC y cetosis:</strong>
    <p><strong>Objetivo:</strong> Maximizar la p√©rdida de grasa mientras se preserva (o incluso se aumenta) la masa muscular magra, especialmente en d√©ficit cal√≥rico.</p>
    
    <strong>¬øQu√© es un ciclo hiperproteico?</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Ingesta de prote√≠na:</strong> 1.8‚Äì2.6 g/kg de peso corporal/d√≠a (vs. 1.2‚Äì2.0 g/kg en est√°ndar).</li>
      <li><strong>Duraci√≥n:</strong> 4‚Äì8 semanas, intercaladas con fases de cetosis o ciclado de HC.</li>
      <li><strong>Contexto:</strong> Usado en d√©ficit cal√≥rico, entrenamiento de fuerza y en transiciones metab√≥licas.</li>
    </ul>

    <strong>Beneficios respaldados por evidencia:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Preservaci√≥n de masa muscular:</strong> Estudios muestran que dietas hiperproteicas durante d√©ficit cal√≥rico reducen la p√©rdida de masa magra en hasta un 50% vs. dietas normoproteicas (Pasiakos et al., <em>AJCN</em>, 2013).</li>
      <li><strong>Saciedad mejorada:</strong> Mayor ingesta proteica aumenta la liberaci√≥n de p√©ptidos anorex√≠genos (GLP-1, PYY), reduciendo el apetito (Leidy et al., <em>Obesity</em>, 2015).</li>
      <li><strong>Termog√©nesis diet√©tica elevada:</strong> La digesti√≥n de prote√≠nas quema ~20‚Äì30% de sus kcal, frente al 5‚Äì10% de HC y grasas (Halton & Hu, <em>AJCN</em>, 2004).</li>
      <li><strong>Mantenimiento del metabolismo basal:</strong> Reduce el "ramping down" metab√≥lico en d√©ficit prolongado (M√ºller et al., <em>Obesity Reviews</em>, 2015).</li>
    </ul>

    <strong>¬øC√≥mo combinarlo con cetosis y ciclado de HC?</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Fase hiperproteica + cetosis ligera:</strong> 1.8‚Äì2.2 g/kg prote√≠na, 30‚Äì50 g HC/d√≠a, resto en grasas. Ideal para <strong>inicio de p√©rdida de grasa con protecci√≥n muscular</strong>.</li>
      <li><strong>Fase hiperproteica + ciclado de HC:</strong> D√≠as de entreno: 1.8‚Äì2.6 g/kg + 1.5‚Äì2 g/kg HC; d√≠as de descanso: 2.2 g/kg + <50 g HC. Potencia <strong>recuperaci√≥n y anabolismo</strong>.</li>
      <li><strong>Evitar en cetosis estricta:</strong> M√°s de 2.2‚Äì2.5 g/kg puede elevar insulina y reducir cetosis por gluconeog√©nesis (Cahill, <em>NEJM</em>, 2006).</li>
    </ul>

    <strong>Ejemplo de integraci√≥n en el plan anual:</strong>
    <div style="margin-top: 10px; overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
        <thead>
          <tr style="background-color: #f5f5f5;">
            <th style="border: 1px solid #ddd; padding: 8px;">Mes</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Fase</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Prote√≠na</th>
            <th style="border: 1px solid #ddd; padding: 8px;">HC</th>
            <th style="border: 1px solid #ddd; padding: 8px;">Objetivo</th>
          </tr>
        </thead>
        <tbody>
          <tr><td style="border: 1px solid #ddd; padding: 8px;">1‚Äì3</td><td style="border: 1px solid #ddd; padding: 8px;">Cetosis + Hiperproteica</td><td style="border: 1px solid #ddd; padding: 8px;">1.8‚Äì2.2 g/kg</td><td style="border: 1px solid #ddd; padding: 8px;">30‚Äì50 g/d√≠a</td><td style="border: 1px solid #ddd; padding: 8px;">Reset + protecci√≥n muscular</td></tr>
          <tr><td style="border: 1px solid #ddd; padding: 8px;">4‚Äì5</td><td style="border: 1px solid #ddd; padding: 8px;">Hiperproteica + Ciclado HC</td><td style="border: 1px solid #ddd; padding: 8px;">2.0‚Äì2.6 g/kg</td><td style="border: 1px solid #ddd; padding: 8px;">D√≠as entreno: 100‚Äì150 g</td><td style="border: 1px solid #ddd; padding: 8px;">Fuerza y recuperaci√≥n</td></tr>
          <tr><td style="border: 1px solid #ddd; padding: 8px;">6‚Äì9</td><td style="border: 1px solid #ddd; padding: 8px;">Ciclado metab√≥lico</td><td style="border: 1px solid #ddd; padding: 8px;">1.8‚Äì2.2 g/kg</td><td style="border: 1px solid #ddd; padding: 8px;">50‚Äì120 g/d√≠a</td><td style="border: 1px solid #ddd; padding: 8px;">Mantenimiento din√°mico</td></tr>
          <tr><td style="border: 1px solid #ddd; padding: 8px;">10‚Äì12</td><td style="border: 1px solid #ddd; padding: 8px;">Transici√≥n + prote√≠na moderada</td><td style="border: 1px solid #ddd; padding: 8px;">1.6‚Äì2.0 g/kg</td><td style="border: 1px solid #ddd; padding: 8px;">150‚Äì200 g/d√≠a</td><td style="border: 1px solid #ddd; padding: 8px;">Mantenimiento sostenible</td></tr>
        </tbody>
      </table>
    </div>

    <strong>Precauciones clave:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li>No prolongar ciclos hiperproteicos > 8 semanas sin descanso, especialmente en personas con riesgo renal.</li>
      <li>Evitar prote√≠na > 2.5 g/kg en fases cetog√©nicas estrictas para no interferir con la cetosis.</li>
      <li>Combinar siempre con entrenamiento de fuerza para aprovechar el anabolismo.</li>
      <li>Supervisar funci√≥n renal y √°cido √∫rico en personas susceptibles.</li>
    </ul>`;
  adviceList.appendChild(highProteinCyclingAdvice);

  // NUEVO: Estrategia avanzada de ciclos hiperproteicos (an√°lisis de la tabla proporcionada)
  const advancedProteinCyclingAdvice = document.createElement('li');
  advancedProteinCyclingAdvice.innerHTML = `<strong>Estrategia avanzada de ciclos hiperproteicos (basada en an√°lisis cient√≠fico):</strong>
    <p><strong>Caracter√≠sticas de la estrategia analizada:</strong> Ciclos de 5 semanas (4 semanas hiperproteicas + 1 semana break) con prote√≠na 2.1-2.5 g/kg (35% kcal) vs breaks 1.2-2.5 g/kg (20% kcal)</p>
    
    <strong>Aspectos positivos respaldados por evidencia:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Prote√≠na hiperproteica (2.1-2.5 g/kg):</strong> Respaldada por Pasiakos et al. (2013) y Helms et al. (2014) para preservaci√≥n muscular en d√©ficit cal√≥rico</li>
      <li><strong>Breaks estrat√©gicos (1.2-2.5 g/kg):</strong> Similar a estrategias de "refeed" que previenen adaptaci√≥n metab√≥lica (Stellingwerff, 2019)</li>
      <li><strong>D√©ficit c√≠clico (-529 vs -264 kcal):</strong> Alineado con recomendaciones de d√©ficit moderado (M√ºller et al., 2015)</li>
      <li><strong>Ajuste cal√≥rico progresivo:</strong> Adaptaci√≥n seg√∫n p√©rdida de peso previene estancamiento metab√≥lico</li>
    </ul>

    <strong>Consideraciones importantes basadas en evidencia:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>L√≠mite de 4 semanas hiperproteica:</strong> M√°ximo seguro seg√∫n literatura actual. Monitoreo de funci√≥n renal y √°cido √∫rico es esencial</li>
      <li><strong>Distribuci√≥n proteica √≥ptima:</strong> 20-30g cada 3-4 horas para maximizar s√≠ntesis proteica (Moore et al., 2019)</li>
      <li><strong>Hidrataci√≥n y electrolitos:</strong> Especialmente importante en fases hiperproteicas intensas</li>
      <li><strong>Perfil indicado:</strong> Personas con experiencia en nutrici√≥n, buena funci√≥n renal, y objetivos de p√©rdida de grasa agresiva</li>
    </ul>

    <strong>Comparativa con estrategias est√°ndar:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Superior en prote√≠na:</strong> 2.1-2.5 g/kg vs 1.6-2.2 g/kg est√°ndar</li>
      <li><strong>M√°s estructurado:</strong> Ciclado sistem√°tico vs ocasional</li>
      <li><strong>Prevenci√≥n de adaptaci√≥n:</strong> D√©ficit c√≠clico vs continuo</li>
      <li><strong>Requiere seguimiento:</strong> Monitoreo avanzado necesario</li>
    </ul>`;
  adviceList.appendChild(advancedProteinCyclingAdvice);

  // Periodizaci√≥n nutricional anual
  const annualPeriodizationAdvice = document.createElement('li');
  annualPeriodizationAdvice.innerHTML = `<strong>Periodizaci√≥n nutricional anual (12 meses):</strong>
    <div style="margin-top: 10px; overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
        <thead>
          <tr style="background-color: #f5f5f5;">
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Meses</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Fase</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">% Carbohidratos</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">% Grasas</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">% Prote√≠nas</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Objetivo principal</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Observaciones</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>1‚Äì3</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px;">Fase de Inducci√≥n Cetog√©nica prolongada</td>
            <td style="border: 1px solid #ddd; padding: 8px;">5‚Äì10% (30‚Äì60 g/d√≠a)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">65‚Äì70%</td>
            <td style="border: 1px solid #ddd; padding: 8px;">20‚Äì25%<br>(1.8‚Äì2.2 g/kg peso)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Reset metab√≥lico, p√©rdida r√°pida de grasa, mejora de glucosa/insulina y triglic√©ridos.</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Ciclo hiperproteico inicial. Monitorizar l√≠pidos, electrolitos, presi√≥n arterial. Priorizar grasas insaturadas.</td>
          </tr>
          <tr style="background-color: #f9f9f9;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>4‚Äì6</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px;">Fase de Ciclado Metab√≥lico inicial</td>
            <td style="border: 1px solid #ddd; padding: 8px;">D√≠as descanso: 5‚Äì8% CHO <br> D√≠as entreno: 15‚Äì20% CHO</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Ajuste grasas 50‚Äì65%</td>
            <td style="border: 1px solid #ddd; padding: 8px;">25‚Äì30%<br>(2.0‚Äì2.6 g/kg peso entreno,<br>1.8‚Äì2.2 g/kg descanso)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Mantener quema de grasa en descanso + soportar entreno.</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Ciclo proteico avanzado: alta prote√≠na en entreno, moderada en descanso. Carbohidratos estrat√©gicos antes/despu√©s del ejercicio.</td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>7‚Äì9</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px;">Fase de Ciclado avanzado / Flexibilidad</td>
            <td style="border: 1px solid #ddd; padding: 8px;">10‚Äì25% promedio semanal (‚âà80‚Äì120 g/d√≠a)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">40‚Äì50%</td>
            <td style="border: 1px solid #ddd; padding: 8px;">25‚Äì30%<br>(1.8‚Äì2.4 g/kg peso)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Consolidar p√©rdida de peso, mejorar fuerza y rendimiento.</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Ciclo proteico moderado. Introducir frutas, tub√©rculos y legumbres en d√≠as de entreno. Ajustar seg√∫n respuesta metab√≥lica.</td>
          </tr>
          <tr style="background-color: #f9f9f9;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>10‚Äì12</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px;">Transici√≥n y mantenimiento</td>
            <td style="border: 1px solid #ddd; padding: 8px;">26‚Äì40% (150‚Äì200 g/d√≠a)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">30‚Äì35%</td>
            <td style="border: 1px solid #ddd; padding: 8px;">20‚Äì25%<br>(1.6‚Äì2.0 g/kg peso)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Mantener peso perdido, equilibrio nutricional y adherencia social.</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Ciclo proteico de mantenimiento. Seguir entrenando, ajustar seg√∫n objetivos. Revaluar anal√≠ticas y composici√≥n corporal.</td>
          </tr>
        </tbody>
      </table>
    </div>
    <strong>L√≥gica de ciclo de prote√≠nas anual:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Fase 1-3 (Cetosis hiperproteica):</strong> 1.8‚Äì2.2 g/kg peso corporal - M√°xima preservaci√≥n muscular durante cetosis estricta.</li>
      <li><strong>Fase 4-6 (Ciclado proteico avanzado):</strong> 2.0‚Äì2.6 g/kg en entreno, 1.8‚Äì2.2 g/kg en descanso - Optimizaci√≥n anab√≥lica durante esfuerzo.</li>
      <li><strong>Fase 7-9 (Ciclado proteico moderado):</strong> 1.8‚Äì2.4 g/kg - Mantenimiento de masa muscular con flexibilidad metab√≥lica.</li>
      <li><strong>Fase 10-12 (Prote√≠na de mantenimiento):</strong> 1.6‚Äì2.0 g/kg - Equilibrio sostenible a largo plazo.</li>
    </ul>
    <strong>Estrategia dentro del a√±o:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Cetosis larga (3 meses)</strong> ‚Üí reset metab√≥lico + ciclo hiperproteico.</li>
      <li><strong>Ciclado (6 meses)</strong> ‚Üí base a medio plazo, combinando entreno + descanso con ciclado proteico.</li>
      <li><strong>Moderada (3 meses)</strong> ‚Üí mantenimiento flexible con prote√≠na moderada.</li>
      <li>Al acabar los 12 meses ‚Üí reevaluar: si hay rebote o estancamiento, se puede volver a una <strong>mini-fase cetog√©nica de 4‚Äì6 semanas</strong> con ciclo hiperproteico.</li>
    </ul>
    <strong>Checklist de seguimiento cada 3‚Äì4 meses:</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li>Peso y % grasa</li>
      <li>Circunferencia de cintura</li>
      <li>Anal√≠tica: glucosa, HbA1c, TG, HDL, LDL/ApoB</li>
      <li>Rendimiento en entrenos (energ√≠a, fuerza, recuperaci√≥n)</li>
      <li>Adherencia y bienestar subjetivo</li>
      <li><strong>Composici√≥n proteica:</strong> Ajustar seg√∫n tolerancia renal y marcadores de recuperaci√≥n</li>
    </ul>`;
  adviceList.appendChild(annualPeriodizationAdvice);

  // Evoluci√≥n metab√≥lica (para personas con alto % de grasa)
  const metabolicEvolutionAdvice = document.createElement('li');
  metabolicEvolutionAdvice.innerHTML = `<strong>Evoluci√≥n metab√≥lica (personas con alto % de grasa):</strong>
    <ul style="padding-left: 20px; margin-top: 5px;">
      <li><strong>Fase 1 (Reset cetog√©nico):</strong> 12-18 semanas, 5-10% HC, 65-70% grasas, 20-25% prote√≠nas (1.8-2.2 g/kg) - P√©rdida r√°pida de grasa visceral, mejora de insulina/glucosa</li>
      <li><strong>Fase 2 (Ciclado metab√≥lico):</strong> 4-6 meses, 10-25% HC, 40-60% grasas, 25-30% prote√≠nas (2.0-2.6 g/kg entreno, 1.8-2.2 g/kg descanso) - Mantener cetosis en descanso, carbohidratos estrat√©gicos en entreno</li>
      <li><strong>Fase 3 (Transici√≥n sostenible):</strong> Largo plazo, 26-40% HC, 30-35% grasas, 20-25% prote√≠nas (1.6-2.0 g/kg) - Mantenimiento del peso, adherencia social</li>
    </ul>
    <strong>Estrategia combinada:</strong> Cetosis en descanso + carbohidratos estrat√©gicos en entreno + prote√≠nas distribuidas (20-30g cada 3-4h).`;
  adviceList.appendChild(metabolicEvolutionAdvice);

  // Estrategia de periodizaci√≥n nutricional (rendimiento/composici√≥n atl√©tica)
  const athleticPeriodizationAdvice = document.createElement('li');
  athleticPeriodizationAdvice.innerHTML = `<strong>Periodizaci√≥n anual (rendimiento/composici√≥n atl√©tica):</strong>
    <div style="margin-top: 10px; overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
        <thead>
          <tr style="background-color: #f5f5f5;">
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Meses</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Fase</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">% Carbohidratos</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">% Grasas</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">% Prote√≠nas</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Objetivo principal</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>1‚Äì3</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px;">Volumen (super√°vit)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">40‚Äì50% (200‚Äì300 g/d√≠a)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">25‚Äì35%</td>
            <td style="border: 1px solid #ddd; padding: 8px;">25‚Äì30%<br>(1.6‚Äì2.2 g/kg peso)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Ganancia muscular controlada</td>
          </tr>
          <tr style="background-color: #f9f9f9;">
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>4‚Äì9</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px;">Definici√≥n (d√©ficit)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">20‚Äì40% (100‚Äì200 g/d√≠a)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">30‚Äì40%</td>
            <td style="border: 1px solid #ddd; padding: 8px;">30‚Äì35%<br>(2.2‚Äì2.6 g/kg peso)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">P√©rdida de grasa + preservaci√≥n muscular</td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px;"><strong>10‚Äì12</strong></td>
            <td style="border: 1px solid #ddd; padding: 8px;">Mantenimiento</td>
            <td style="border: 1px solid #ddd; padding: 8px;">35‚Äì45% (150‚Äì250 g/d√≠a)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">25‚Äì35%</td>
            <td style="border: 1px solid #ddd; padding: 8px;">25‚Äì30%<br>(1.8‚Äì2.2 g/kg peso)</td>
            <td style="border: 1px solid #ddd; padding: 8px;">Equilibrio energ√≠a + composici√≥n</td>
          </tr>
        </tbody>
      </table>
    </div>`;
  adviceList.appendChild(athleticPeriodizationAdvice);

  // Consejo sobre electrolitos
  const electrolyteAdvice = document.createElement('li');
  electrolyteAdvice.innerHTML = `<strong>Electrolitos:</strong> Asegura 3-5 g de sodio, 3-4 g de potasio y 300-400 mg de magnesio diarios (caldos, aguacate, suplementos) para prevenir fatiga y apoyar la adherencia (Phinney et al., 1983). En fases hiperproteicas, aumenta ligeramente el sodio y magnesio para compensar la carga renal.`;
  adviceList.appendChild(electrolyteAdvice);

  // Consejo sobre ejercicio
  const exerciseAdvice = document.createElement('li');
  exerciseAdvice.innerHTML = `<strong>Ejercicio:</strong> Combina entrenamiento de fuerza (3-4 veces/semana) y cardio moderado (20-30 min, 2-3 veces/semana) para preservar m√∫sculo y aumentar quema de grasa (Vargas-Molina et al., 2020). Considera carb cycling metab√≥lico: cetosis en descanso, carbohidratos en entrenamiento. <strong>Timing proteico:</strong> 25-30g de prote√≠na de alto valor biol√≥gico (leche, huevo, carne) tras el entrenamiento para maximizar s√≠ntesis proteica.`;
  adviceList.appendChild(exerciseAdvice);

  // Consejo sobre personalizaci√≥n
  const personalAdvice = document.createElement('li');
  personalAdvice.innerHTML = `<strong>Personalizaci√≥n:</strong> Ajusta carbohidratos (20-50 g netos para moderada, <20 g para estricta), prote√≠nas (1.6-2.6 g/kg seg√∫n fase y actividad) y calor√≠as seg√∫n tu actividad y metabolismo. Monitorea cetonas y composici√≥n corporal (Gardner et al., 2018). Considera distribuci√≥n proteica equitativa: 20-30g cada 3-4 horas para optimizar s√≠ntesis proteica (Moore et al., 2019).`;
  adviceList.appendChild(personalAdvice);

  // Consejo sobre ayuno intermitente
  const fastingAdvice = document.createElement('li');
  fastingAdvice.innerHTML = `<strong>Ayuno intermitente (opcional):</strong> Considera protocolos como 16:8 (16 h ayuno, 8 h alimentaci√≥n) para potenciar la lip√≥lisis y mejorar sensibilidad a la insulina (Anton et al., 2018). <strong>En ciclos hiperproteicos:</strong> Rompe el ayuno con 25-30g de prote√≠na para evitar catabolismo muscular. Evita ayunos prolongados (>18h) en fases de alta prote√≠na.`;
  adviceList.appendChild(fastingAdvice);

  // Consejo general sobre evidencia cient√≠fica
  const generalAdvice = document.createElement('li');
  generalAdvice.innerHTML = `<strong>Evidencia cient√≠fica:</strong> La dieta cetog√©nica est√°ndar (70-75% grasas, 20-25% prote√≠nas, 5-10% HC) ha demostrado eficacia en epilepsia, diabetes tipo 2 y p√©rdida de peso (Paoli et al., 2013). Estudios muestran que incluso sin restricci√≥n cal√≥rica estricta, las dietas bajas en carbohidratos inducen menor ingesta espont√°nea y mejoran marcadores metab√≥licos. <strong>S√≠ntesis proteica √≥ptima:</strong> 20-30g de prote√≠na por comida maximizan la MPS (Moore et al., 2019).`;
  adviceList.appendChild(generalAdvice);

  // Recomendaciones de seguridad a largo plazo
  const safetyAdvice = document.createElement('li');
  safetyAdvice.innerHTML = `<strong>Seguridad a largo plazo:</strong> Realiza chequeos anuales con an√°lisis de sangre (perfil lip√≠dico, funci√≥n hep√°tica/renal, electrolitos, vitaminas). Considera transitar a dieta baja en carbohidratos (50-100 g/d√≠a) si presentas: LDL-P elevado, esteatosis hep√°tica progresiva, p√©rdida excesiva de peso, trastornos menstruales persistentes, fatiga cr√≥nica o √°cido √∫rico > 7 mg/dL. <strong>En ciclos hiperproteicos:</strong> Monitoriza funci√≥n renal y √°cido √∫rico cada 2-3 meses.`;
  adviceList.appendChild(safetyAdvice);

  adviceContainer.appendChild(adviceList);

  const finalNote = document.createElement('p');
  finalNote.className = 'small muted';
  finalNote.style.marginTop = '15px';
  finalNote.innerHTML = 'üí° <em>Estos consejos son generales. Consulta con un profesional de salud para recomendaciones personalizadas. La cetosis espont√°nea puede inducir d√©ficit cal√≥rico natural y mejoras metab√≥licas incluso sin restricci√≥n cal√≥rica estricta. La distribuci√≥n proteica √≥ptima (20-30g cada 3-4h) maximiza s√≠ntesis proteica y previene catabolismo (Moore et al., 2019).</em>';
  adviceContainer.appendChild(finalNote);
}	

function calculateDailyNutrition(day) {
  let totalFat = 0;
  let totalProtein = 0;
  let totalCarbs = 0;
  let totalKcal = 0;
  
  // Recorrer todas las comidas del d√≠a
  const meals = ['Desayuno', 'Almuerzo', 'Cena', 'Snack'];
  meals.forEach(meal => {
    if (weeklyPlan[day] && weeklyPlan[day][meal]) {
      weeklyPlan[day][meal].forEach(recipe => {
        if (recipe.recipe) {
          recipe.recipe.forEach(ingredient => {
            totalFat += ingredient.fat || 0;
            totalProtein += ingredient.protein || 0;
            totalCarbs += ingredient.carbs || 0;
            totalKcal += ingredient.kcal || 0;
          });
        }
      });
    }
  });
  
  // Calcular ratio cetog√©nico
  const ketoRatio = (totalProtein + totalCarbs) > 0 
    ? totalFat / (totalProtein + totalCarbs) 
    : 0;
  
  return {
    fat: totalFat,
    protein: totalProtein,
    carbs: totalCarbs,
    kcal: totalKcal,
    ketoRatio: ketoRatio
  };
}

function renderNutritionChart(nutritionData) {
  const canvas = document.getElementById('nutritionChart');
  if (!canvas) {
    console.error('Canvas element with id "nutritionChart" not found.');
    const adviceContainer = document.getElementById('adviceContent');
    const errorMessage = document.createElement('p');
    errorMessage.innerHTML = '<strong>Error:</strong> No se pudo cargar el gr√°fico nutricional. Verifica que el elemento canvas est√© presente en el modal.';
    adviceContainer.appendChild(errorMessage);
    return;
  }

  const ctx = canvas.getContext('2d');
  if (!ctx) {
    console.error('Failed to get 2D context for canvas.');
    const adviceContainer = document.getElementById('adviceContent');
    const errorMessage = document.createElement('p');
    errorMessage.innerHTML = '<strong>Error:</strong> No se pudo inicializar el contexto del gr√°fico.';
    adviceContainer.appendChild(errorMessage);
    return;
  }

  // Verificar datos v√°lidos
  const total = nutritionData.fat + nutritionData.protein + nutritionData.carbs;
  if (total === 0) {
    console.error('No valid nutrition data to display in chart.');
    const adviceContainer = document.getElementById('adviceContent');
    const errorMessage = document.createElement('p');
    errorMessage.innerHTML = '<strong>Error:</strong> No hay datos nutricionales v√°lidos para mostrar en el gr√°fico.';
    adviceContainer.appendChild(errorMessage);
    return;
  }

  // Destruir gr√°fico anterior si existe
  if (window.nutritionChartInstance) {
    window.nutritionChartInstance.destroy();
  }
  
 // Crear nuevo gr√°fico
window.nutritionChartInstance = new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['Grasas', 'Prote√≠nas', 'Carbohidratos'],
    datasets: [{
      data: [nutritionData.fat, nutritionData.protein, nutritionData.carbs],
      backgroundColor: [
        '#4CAF50', // Verde para grasas
        '#2196F3', // Azul para prote√≠nas
        '#FF9800'  // Naranja para carbohidratos
      ],
      borderColor: [
        '#388E3C',
        '#1976D2',
        '#F57C00'
      ],
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          color: '#333',
          font: {
            size: 12
          }
        }
      },
      tooltip: {
        callbacks: {
          label: function(context) {
            const label = context.label || '';
            const value = context.raw || 0;
            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
            
            // Calcular kcal por macronutriente
            // Grasas: 9 kcal/g, Prote√≠nas: 4 kcal/g, Carbohidratos: 4 kcal/g
            let kcal = 0;
            if (context.label === 'Grasas') {
              kcal = value * 9;
            } else if (context.label === 'Prote√≠nas' || context.label === 'Carbohidratos') {
              kcal = value * 4;
            }
            
            // Calcular % de kcal totales
            const totalKcal = (nutritionData.fat * 9) + (nutritionData.protein * 4) + (nutritionData.carbs * 4);
            const kcalPercentage = totalKcal > 0 ? Math.round((kcal / totalKcal) * 100) : 0;
            
            return `${label}: ${value.toFixed(1)}g (${percentage}%) - ${kcal.toFixed(0)} kcal (${kcalPercentage}% Kcal)`;
          }
        }
      }
    }
  }
});

  // Forzar actualizaci√≥n del gr√°fico
  setTimeout(() => {
    if (window.nutritionChartInstance) {
      window.nutritionChartInstance.update();
    }
  }, 100);
}

// Cerrar el modal
document.getElementById('closeNutritionModal').addEventListener('click', function() {
  document.getElementById('dailyNutritionModal').style.display = 'none';
});

// Cerrar modal al hacer clic fuera del contenido
document.getElementById('dailyNutritionModal').addEventListener('click', function(e) {
  if (e.target === this) {
    this.style.display = 'none';
  }
});

// === Funci√≥n para ordenar recetas por mealType y name ===
function sortRecipes() {
  let recipes = JSON.parse(localStorage.getItem('keto_recipes') || "[]");

  recipes.sort((a, b) => {
    // Primero ordenar por mealType
    if (a.mealType < b.mealType) return -1;
    if (a.mealType > b.mealType) return 1;
    // Si el mealType es igual, ordenar por name
    if (a.name < b.name) return -1;
    if (a.name > b.name) return 1;
    return 0;
  });

  localStorage.setItem('keto_recipes', JSON.stringify(recipes));
  return recipes;
}

// === Funci√≥n para a√±adir recetas evitando duplicados ===
function addRecipe(newRecipe) {
  let recipes = JSON.parse(localStorage.getItem('keto_recipes') || "[]");

  // Verificar duplicados (por mealType + name)
  let exists = recipes.some(r => 
    r.mealType.toLowerCase() === newRecipe.mealType.toLowerCase() &&
    r.name.toLowerCase() === newRecipe.name.toLowerCase()
  );

  if (exists) {
    console.warn(`‚ö†Ô∏è La receta "${newRecipe.name}" en "${newRecipe.mealType}" ya existe. No se a√±adir√°.`);
    return recipes; // no a√±adimos duplicados
  }

  // A√±adir receta nueva
  recipes.push(newRecipe);
  localStorage.setItem('keto_recipes', JSON.stringify(recipes));

  // Ordenar inmediatamente despu√©s de a√±adir
  return sortRecipes();
}

// === Ejecutar autom√°ticamente al cargar la p√°gina ===
document.addEventListener("DOMContentLoaded", () => {
  window.recipes = sortRecipes();
});



  </script>
</body>
</html>
